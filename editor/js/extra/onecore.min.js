(function(ba){function Z(){this.code="function update(dt) {\n\n}";this.exported_callbacks=[];this.extracode="";this.extra_methods=null}function Oa(a){return Oa.get(a)}function ub(a){this.dependency_blocks=[];this.flag_id=-1;this.flag_mask=0;this.events=null;if(!a)throw"ShaderBlock must have a name";if(-1!=a.indexOf(" "))throw"ShaderBlock name cannot have spaces: "+a;this.name=a;this.code_map=new Map;this.context_macros=null}function ia(a){this.code=a;this.blocks=[];this.pragmas={};this.uniforms={};
this.attributes={};this.includes={};this.snippets={};this.shader_blocks={};this.is_dynamic=!1;a&&this.parse()}function B(a){this.uid=d.generateUId("MAT-");this._must_update=!0;this._index=-1;this._local_id=B.last_index++;this._last_frame_update=-1;this._color=new Float32Array([1,1,1,1]);this._queue=d.RenderQueue.AUTO;this._render_state=new d.RenderState;this._light_mode=d.Material.NO_LIGHTS;this.uvs_matrix=new Float32Array([1,0,0,0,1,0,0,0,1]);this.textures={};this.flags={cast_shadows:!0,receive_shadows:!0,
ignore_frustum:!1};Object.defineProperty(this,"color",{get:function(){return this._color.subarray(0,3)},set:function(a){vec3.copy(this._color,a)},enumerable:!0});Object.defineProperty(this,"opacity",{get:function(){return this._color[3]},set:function(a){this._color[3]=a},enumerable:!0});Object.defineProperty(this,"queue",{get:function(){return this._queue},set:function(a){!isNaN(a)&&isNumber(a)&&(this._queue=a)},enumerable:!0});Object.defineProperty(this,"render_state",{get:function(){return this._render_state},
set:function(a){if(a)for(var c in a)this._render_state[c]=a[c]},enumerable:!0});Object.defineProperty(this,"light_mode",{get:function(){return this._light_mode},set:function(a){this._light_mode=a},enumerable:!0});a&&this.configure(a)}function M(a){B.call(this,null);this._shader="";this._shader_version=-1;this._shader_flags=0;this._shader_code=null;this._uniforms={};this._samplers=[];this._properties=[];this._properties_by_name={};this._passes={};this._light_mode=0;this._primitive=-1;this._allows_instancing=
!1;this._version=-1;this._last_valid_properties=null;a&&this.configure(a)}function I(a){M.call(this,null);this.blend_mode=d.Blend.NORMAL;this.createProperty("diffuse",new Float32Array([1,1,1]),"color");this.createProperty("ambient",new Float32Array([1,1,1]),"color");this.createProperty("emissive",new Float32Array([0,0,0,0]),"color");this._specular_data=vec4.fromValues(0.1,10,0,0);this.specular_on_alpha=this.specular_on_top=!1;this.reflection_factor=this.translucency=this.backlight_factor=0;this.reflection_fresnel=
1;this.reflection_specular=!1;this.createProperty("velvet",new Float32Array([0.5,0.5,0.5]),"color");this.velvet_exp=0;this.velvet_additive=!1;this._velvet_info=vec4.create();this._detail=new Float32Array([0,10,10]);this.normalmap_factor=1;this.normalmap_tangent=!0;this.bumpmap_factor=1;this.displacementmap_factor=0.1;this._texture_settings=new Uint8Array(11);this.use_scene_ambient=!0;this.point_size=1;this.createProperty("extra",new Float32Array([0,0,0,1]),"color");this.flags={alpha_test:!1,alpha_test_shadows:!1,
two_sided:!1,flip_normals:!1,depth_test:!0,depth_write:!0,ignore_lights:!1,cast_shadows:!0,receive_shadows:!0,ignore_frustum:!1};this._uniforms={u_material_color:this._color,u_ambient_color:this._ambient,u_emissive_color:this._emissive,u_specular:this._specular_data,u_reflection_info:vec2.create(),u_velvet_info:vec4.create(),u_normal_info:vec2.create(),u_detail_info:this._detail,u_texture_matrix:this.uvs_matrix,u_extra_color:this._extra,u_texture_settings:this._texture_settings};this._samplers=[];
this.needsUpdate=this._allows_instancing=!0;a&&this.configure(a)}function ua(a){B.call(this,null);this.shader_name="surface";this.blend_mode=d.Blend.NORMAL;this._light_mode=1;this.flags={alpha_test:!1,alpha_test_shadows:!1,two_sided:!1,flip_normals:!1,depth_test:!0,depth_write:!0,ignore_lights:!1,cast_shadows:!0,receive_shadows:!0,ignore_frustum:!1};this._code="void surf(in Input IN, inout SurfaceOutput o) {\n\to.Albedo = vec3(1.0) * IN.color.xyz;\n\to.Normal = IN.worldNormal;\n\to.Emission = vec3(0.0);\n\to.Specular = 1.0;\n\to.Gloss = 40.0;\n\to.Reflectivity = max(0.0, 0.5 - dot(IN.viewDir,o.Normal));\n\to.Alpha = IN.color.a;\n}\n";
this._uniforms={};this._samplers=[];this._mustUpdate=!1;this.properties=[];a&&this.configure(a);this.computeCode()}function $(a){M.call(this,null);this.blend_mode=d.Blend.NORMAL;this._shader=this._filename="";this._shader_version=-1;this._shader_flags=0;this._graphcode=null;this._uniforms={};this._samplers=[];this._properties=[];this._properties_by_name={};this._passes={};this._light_mode=d.Material.ONE_LIGHT;this._primitive=-1;this._allows_instancing=!1;this._shader_version=this._version=-1;this._context=
null;this._loading=!1;a&&this.configure(a)}function Ca(){this._components=[]}function qa(){}function Pa(a){a&&this.configure(a)}function gc(){this._last_serialization=null;this._comp_class=""}function y(){this.uid=d.generateUId("TREE-");this._state=d.STOPPED;this._root=new d.SceneNode("root");this._root.removeAllComponents();this._root._is_root=!0;this._root._in_tree=this;this._nodes=[this._root];this._nodes_by_name={root:this._root};this._nodes_by_uid={};this._nodes_by_uid[this._root.uid]=this._root;
this._components_by_uid={};this._uniforms={};this._instances=[];this._lights=[];this._cameras=[];this._colliders=[];this._reflection_probes=[];this.external_repository=null;this._spatial_container=new d.SpatialContainer;this.external_scripts=[];this.global_scripts=[];this.preloaded_resources={};this.animation=null;this._local_resources={};this.texture_atlas=null;this.layer_names=["main","secondary"];LEvent.bind(this,"treeItemAdded",this.onNodeAdded,this);LEvent.bind(this,"treeItemRemoved",this.onNodeRemoved,
this);this._shaderblock_info=null;this.init()}function N(a){a&&a.constructor!==String&&(a=null,console.warn("SceneNode constructor first parameter must be a String with the name"));this._name=a||"node_"+(1E4*Math.random()).toFixed(0);this._uid=d.generateUId("NODE-");this._classList={};this.layers=3;this._material=this._prefab=this.node_type=null;this._components=[];this._in_tree=this._children=this._parentNode=null;this._instances=[];this.flags={visible:!0,is_static:!1,selectable:!0,locked:!1};this.init(!1,
!0)}function Ja(){this._data=this.remotepath=this.fullpath=this.filename=null}function V(a){this.name="";this.takes={};a&&this.configure(a)}function Da(a){this.name=null;this.tracks=[];this.duration=d.Animation.DEFAULT_DURATION;a&&this.configure(a)}function R(a){this.enabled=!0;this.name="";this._type_index=this._type=null;this.interpolation=d.NONE;this.packed_data=this.looped=!1;this.value_size=0;this.data_table=this.data=null;Object.defineProperty(this,"_property",{value:"",enumerable:!1,writable:!0});
Object.defineProperty(this,"_property_path",{value:[],enumerable:!1,writable:!0});a&&this.configure(a)}function wc(a,b,c){return a*(1-c)+b*c}function oa(){this.bones=[];this.global_bone_matrices=[];this.bones_by_name=new Map}function Fb(){this.name="";this.model=mat4.create();this.parent=-1;this.num_children=this.layer=0;this.children=new Int8Array(16)}function vb(){this.skeleton=new oa;this.num_keyframes=this.num_animated_bones=this.samples_per_second=this.duration=0;this.bones_map=new Uint8Array(64);
this.keyframes=null}function ja(a){this.resource_names=[];this.metadata=null;this._data={};this._resources_data={};a&&this.configure(a)}function la(a,b){this.filename=b||null;this.fullpath=b||null;this.resource_names=[];this.prefab_data=this.prefab_json=null;this._resources_data={};a&&this.configure(a)}function P(a){this._code=null;this._functions={};this._global_uniforms={};this._code_parts={};this._subfiles={};this._compiled_shaders={};this._shaderblock_flags_num=0;this._shaderblock_flags={};this._version=
0;a&&(this.code=a)}function Ka(a){this._data={object_class:"GraphCode"};this._modified=!1;this._graph=new LiteGraph.LGraph;this._graph._graphcode=this;this.type=d.GraphCode.LOGIC_GRAPH;this.properties=[];this.extra={};this._version=0;a&&this.setData(a,!0)}function ya(){this.points=[];this.closed=!1;this.type=d.LINEAR}function W(a){this.apply_fxaa=!1;this.filter=!0;this.fx=[];this._uniforms={u_aspect:1,u_viewport:vec2.create(),u_iviewport:vec2.create(),u_texture:0,u_depth_texture:1,u_random:vec2.create()};
this._passes=null;this._must_update_passes=!0;a&&this.configure(a)}function Pb(){this.active_entries=[]}function Gb(){this.time=0;this.weight=1;this._take_name=this._animation_name=this._animation_take=null;this._last_time=0;this._must_update=!1}function wb(){this.size=1E5;this.root=[];this.objects_cell_by_id=new WeakMap}function Ua(a){this.renderer_name=null;this.default_shadowmap_resolution=d.RenderSettings.default_shadowmap_resolution;this.keep_viewport=this.ignore_clear=this.ignore_viewports=
!1;this.update_shadowmaps=this.shadows_enabled=!0;this.lights_disabled=this.force_wireframe=this.update_all_shadowmaps=!1;this.quality=Ua.AUTO_QUALITY;this.render_helpers=this.render_gui=this.render_fx=this.render_all_cameras=!0;this.layers=65535;this.z_pass=!1;this.in_player=this.frustum_culling=!0;a&&this.configure(a)}function A(a){this._data=new Uint32Array(25);this.init();a&&this.configure(a)}function ka(a,b){this.uid=d.generateUId("RINS");this.layers=3;this.version=this.index=-1;this.vertex_buffers=
{};this.wireframe_index_buffer=this.index_buffer=null;this.range=new Int32Array([0,-1]);this.primitive=GL.TRIANGLES;this.collision_mesh=this.mesh=this.transform=null;this.node=a;this.component=b;this.priority=10;this.sort_mode=ka.NO_SORT;this.matrix=mat4.create();this.normal_matrix=mat4.create();this.position=vec3.create();this.oobb=BBox.create();this.aabb=BBox.create();this.center=BBox.getCenter(this.aabb);this.material=null;this.use_bounding=!0;this.uniforms={};this.samplers=[];this.instanced_models=
null;this.shader_block_flags=0;this.shader_blocks=[];this.picking_node=null;this._camera_visibility=0;this._is_visible=!1;this._dist=0;this._nearest_reflection_probe=null}function Q(a){this.height=this.width=0;this.precision=Q.DEFAULT_PRECISION;this.filter_texture=!0;this.format=GL.RGB;this.use_depth_texture=!0;this.use_stencil_buffer=!1;this.num_extra_textures=0;this.name=null;this.clone_after_unbind=this.adjust_aspect=this.generate_mipmaps=!1;this._depth_texture=this._color_texture=this._fbo=null;
this._textures=[];this._cloned_depth_texture=this._cloned_textures=null;this._version=1;this._minFilter=gl.NEAREST;a&&this.configure(a)}function pa(a,b,c){this.enabled=!0;this.instances=[];this.value=a||0;this.sort_mode=b||d.RenderQueue.NO_SORT;this.must_clone_buffers=!1;this.onFinish=this.onStart=null;if(c)for(var e in c)this[e]=c[e]}function $a(){this.debug_points=[];this._points=[];this._points_color=[];this._points_nodepth=[];this._points_color_nodepth=[];this._lines=[];this._lines_color=[];this._names=
[];this.grid_texture_url="imgs/grid.png";this.camera2D=new d.Camera({eye:[0,0,0],center:[0,0,-1]});this.createMeshes();this.colors={selected:vec4.fromValues(1,1,1,1),node:vec4.fromValues(1,0.5,0,1),bone:vec4.fromValues(1,0,0.5,1)};this.settings={render_grid:!0,grid_scale:1,grid_alpha:0.5,grid_plane:"xz",render_names:!1,render_skeletons:!0,render_tree:!1,render_components:!0,render_null_nodes:!0,render_axis:!1,render_colliders:!0,render_paths:!0,render_origin:!0,render_colliders_aabb:!1};this._in_scene=
!1}function ma(a){this.bias=this.resolution=0;this.format=GL.DEPTH_COMPONENT;this.layers=255;this.reverse_faces=!0;this.shadow_mode=1;this.linear_filter=!0;this._texture=null;this._light=a;this._fbo=null;this._shadow_params=vec4.create();this._shadow_extra_params=vec4.create()}function hc(a,b,c,e,g,d){this.position=vec3.create();c&&this.position.set(c);this.node=a||null;this.instance=b||null;this.distance=e||0;this.normal=g;this.hit=d}function Va(a,b){this.uid=d.generateUId("PHSX");this.layers=3;
this.type=Va.BOX;this.mesh=null;this.node=a;this.component=b;this.matrix=mat4.create();this.center=vec3.create();this.oobb=BBox.create();this.aabb=BBox.create()}function z(a){this._data=new Float32Array(10);this._position=this._data.subarray(0,3);this._rotation=this._data.subarray(3,7);quat.identity(this._rotation);this._scaling=this._data.subarray(7,10);this._scaling[0]=this._scaling[1]=this._scaling[2]=1;this._local_matrix=mat4.create();this._global_matrix=mat4.create();this._parent=this._root=
this._uid=null;this._must_update=!1;this._version=0;a&&this.configure(a)}function w(a){this.enabled=!0;this.layers=3;this.clear_depth=this.clear_color=!0;this._type=w.PERSPECTIVE;this._eye=vec3.clone(w.DEFAULT_EYE);this._center=vec3.clone(w.DEFAULT_CENTER);this._up=vec3.clone(w.DEFAULT_UP);this._global_eye=vec3.clone(this._eye);this._global_center=vec3.clone(this._center);this._global_up=vec3.clone(this._up);this._global_front=vec3.create();vec3.sub(this._global_front,this._global_center,this._global_eye);
vec3.normalize(this._global_front,this._global_front);this._near=0.1;this._far=1E3;this._ortho=new Float32Array([-1,1,-1,1]);this._aspect=1;this._fov=45;this._frustum_size=50;this._final_aspect=1;this._viewport=new Float32Array([0,0,1,1]);this._viewport_in_pixels=vec4.create();this._last_viewport_in_pixels=vec4.create();this._background_color=vec4.fromValues(0,0,0,1);this._use_custom_projection_matrix=!1;this.overwrite_material=null;this._view_matrix=mat4.create();this._projection_matrix=mat4.create();
this._viewprojection_matrix=mat4.create();this._model_matrix=mat4.create();this._previous_viewprojection_matrix=mat4.create();this._must_update_projection_matrix=this._must_update_view_matrix=!0;this._rendering_index=-1;this._frame=null;this.show_frame=!0;a&&this.configure(a);this._uniforms={u_view:this._view_matrix,u_viewprojection:this._viewprojection_matrix,u_camera_eye:this._global_eye,u_camera_front:this._global_front,u_camera_planes:vec2.fromValues(this.near,this.far),u_camera_perspective:vec3.create(),
u_background_color:this._background_color,u_previous_viewprojection:this._previous_viewprojection_matrix};this._frustum_planes=this.updateFrustumPlanes();this.updateMatrices()}function za(a){this.enabled=!0;this.fx=new d.FXStack(a?a.fx:null);this.frame=new d.RenderFrameContext;this.frame.use_depth_texture=!0;this.use_antialiasing=!1;this.shader_material=null;a&&this.configure(a)}function La(a){this.enabled=!0;this.fx=new d.FXStack(a?a.fx:null);this.frame=new d.RenderFrameContext;this.frame.use_depth_texture=
!0;this.use_antialiasing=!1;this.shader_material=null;a&&this.configure(a)}function v(a){this._position=vec3.create();this._target=vec3.fromValues(0,0,1);this._up=vec3.fromValues(0,1,0);this.enabled=!0;this.illuminated_layers=255;this.near=1;this.far=500;this.angle=45;this.angle_end=60;this.constant_diffuse=!1;this.use_specular=!0;this.att_start=0;this.att_end=1E3;this.attenuation_type=v.RANGE_ATTENUATION;this.offset=0;this._spot_cone=!0;this.projective_texture=null;this._attenuation_info=new Float32Array([this.att_start,
this.att_end,this.attenuation_type,0]);this.use_target=!1;this._color=vec3.fromValues(1,1,1);this.intensity=1;this._type=v.OMNI;this.frustum_size=50;this._cast_shadows=!1;this._shadowmap=null;this._precompute_shadowmaps_on_startup=!1;this._update_shadowmap_render_settings=null;this._light_matrix=mat4.create();this.extra_texture=null;this._front=vec3.clone(d.FRONT);this._right=vec3.clone(d.RIGHT);this._top=vec3.clone(d.TOP);this._samplers=[];this._uniforms={u_light_info:vec4.fromValues(this._type,
this._spot_cone?1:0,0,0),u_light_front:this._front,u_light_angle:vec4.fromValues(this.angle*DEG2RAD,this.angle_end*DEG2RAD,Math.cos(this.angle*DEG2RAD*0.5),Math.cos(this.angle_end*DEG2RAD*0.5)),u_light_position:this._position,u_light_color:vec3.create(),u_light_att:this._attenuation_info,u_light_offset:this.offset,u_light_extra:vec4.create(),u_light_matrix:this._light_matrix};a&&this.configure(a)}function X(a){this._enabled=!0;this._lod_mesh=this._mesh=null;this._submesh_id=-1;this._material=null;
this._primitive=-1;this._must_update_static=!0;this._transform_version=-1;this.use_submaterials=!1;this.submaterials=[];a&&this.configure(a);this._RI=new d.RenderInstance(null,this);this._is_attached=!1}function D(a){this.enabled=!0;this.mode=D.AUTOMATIC;this.delta_meshes=!1;this.morph_targets=[];this._morph_targets_by_name={};ba.gl&&(void 0===D.max_supported_vertex_attribs&&(D.max_supported_vertex_attribs=gl.getParameter(gl.MAX_VERTEX_ATTRIBS)),void 0===D.max_supported_morph_targets_using_streams&&
(D.max_supported_morph_targets_using_streams=(gl.getParameter(gl.MAX_VERTEX_ATTRIBS)-6)/2));this._stream_weights=new Float32Array(4);this._uniforms={u_morph_weights:this._stream_weights,u_morph_info:0};a&&this.configure(a)}function K(a){this.search_bones_in_parent=this.enabled=!0;this.skeleton_root_node=null;this.cpu_skinning=!1;this.ignore_transform=!0;this._last_bones=this._mesh=null;this._ris_skinned=[];this._skeleton=null;!K._initialized&&ba.gl&&(K.num_supported_uniforms=gl.getParameter(gl.MAX_VERTEX_UNIFORM_VECTORS),
K.num_supported_textures=gl.getParameter(gl.MAX_VERTEX_TEXTURE_IMAGE_UNITS),K.num_supported_uniforms<3*K.MAX_UNIFORM_BONES&&0==K.num_supported_textures&&(K.gpu_skinning_supported=!1),K._initialized=!0);a&&this.configure(a)}function ab(a){this.enabled=!0;this.svg=null;a&&this.configure(a);this._RI=new d.RenderInstance(null,this);this._svg_data=this._mesh=null}function Ea(a){this.enabled=!0;this.material=this.texture=null;this._intensity=1;this.use_environment=!0;this._bake_to_cubemap=this.gamma=!1;
a&&this.configure(a)}function db(a){this.enabled=!0;this.texture=null;this.createProperty("color",vec3.fromValues(1,1,1),"color");this.opacity=1;this.blend_mode=fb.NORMAL;this.material_name=null;a&&this.configure(a)}function Aa(a){this.enabled=!0;this.shape=1;this.mesh=null;this.size=vec3.fromValues(0.5,0.5,0.5);this.center=vec3.create();this.use_mesh_bounding=!1;a&&this.configure(a)}function Ta(a){this._properties=[];this._properties_by_name={};a&&this.configure(a)}function Qa(a){this.enabled=!0;
this.texture=null;this.blend_mode=d.Blend.ALPHA;this._size=vec2.fromValues(100,100);this.frame=null;this.flip_x=!1;this.filtering=!0;this._area=vec4.fromValues(0,0,1,1);this._atlas_component=this._atlas=null;a&&this.configure(a)}function Fa(a){this.enabled=!0;this.texture=null;this.areas=[];this._sprites=[];this._max_sprites=256;a&&this.configure(a)}function H(a){this.include_lights=this.include_cameras=this.include_instances=this.enabled=!0;this._frame_fx_binded=this._frame_fx=!1;this.send_events=
!0;this._scene_path=null;this._scene_is_ready=!1;d.Scene&&(this._scene=new d.Scene,this._scene.root.removeAllComponents(),LEvent.bind(this._scene,"requestFrame",function(){this._root.scene&&this._root.scene.requestFrame()},this));a&&this.configure(a)}function Ra(a){this.in_editor=this.enabled=!0;this.in_player=!1;this.type=Ra.CIRCLE;this.color=[1,1,1,1];this.size=1;this.fill=!1;this.vertical=this.always_on_top=!0;this._is_visible=!1;a&&this.configure(a)}function Ma(a){this.text="";this.notes=[];this._screen_pos=
vec3.create();this._selected=null;this.configure(a)}function Qb(a){this.enabled=!0;this.speed=10;this.axis=[0,1,0];this.local_space=!0;this.swing=!1;this.swing_amplitude=45;a&&this.configure(a)}function C(a){this.enabled=!0;this.no_button_action=C.NONE;this.left_button_action=C.ORBIT;this.middle_button_action=this.right_button_action=C.PAN;this.mouse_wheel_action=C.CHANGE_DISTANCE;this.lock_mouse=this.keyboard_walk_plane=this.keyboard_walk=!1;this.rot_speed=1;this.walk_speed=10;this.wheel_speed=1;
this.render_crosshair=this.smooth=!1;this._moving=vec3.fromValues(0,0,0);this._collision_none=vec3.create();this._collision_left=vec3.create();this._collision_middle=vec3.create();this._collision_right=vec3.create();this._dragging=!1;this._camera=null;this.configure(a)}function gb(a){this.enabled=!0;this.use_global_up_for_yaw=this.on_node_clicked=!1;this.rot_speed=[1,1];a&&this.configure(a)}function S(a){this.enabled=!0;this.node_id=null;this.cylindrical=this.face_camera=!1;this.front=S.NEGZ;this.up=
S.POSY;this.roll=0;this.use_iterative_method=!1;this._global_position=vec3.create();this._target_position=vec3.create();a&&this.configure(a)}function Sa(a){this.enabled=!0;this.start=100;this.end=1E3;this.density=0.001;this.type=Sa.LINEAR;this.color=vec3.fromValues(0.5,0.5,0.5);this._uniforms={u_fog_info:vec3.create(),u_fog_color:this.color};a&&this.configure(a)}function Hb(a){this.enabled=!0;this.node_id="";this.follow_camera=this.fixed_y=this.align=!1;a&&this.configure(a)}function F(a){this.enabled=
!0;this._subdivisions=this._size=10;this._geometry=F.CUBE;this._custom_mesh=null;this._primitive=-1;this._point_size=0.1;this._version=1;this._mesh=null;this._mesh_version=0;a&&this.configure(a)}function Ga(a){this.createProperty("ambient_color",Ga.DEFAULT_AMBIENT_COLOR,"color");this.createProperty("irradiance_color",[1,1,1],"color");this._render_settings=null;this._textures={};this._irradiance_final=this.irradiance=null;this._uniforms={};a&&this.configure(a)}function ca(a){this.enabled=!0;this.force_redraw=
this.from_file=!1;this._graph_properties=this._graphcode=this._filename=this.title=null;this.on_event="update";if("undefined"==typeof LiteGraph)return console.error("Cannot use GraphComponent if LiteGraph is not installed");this._graph_version=-1;this._graph=new LGraph;this._graph.getScene=function(){return this._scene||d.GlobalScene};this._graph._scenenode=null;this._loading=!1;a?this.configure(a):this.from_file||(a=this._default_node=LiteGraph.createNode("scene/node"),this._graph.add(a));LEvent.bind(this,
"trigger",this.trigger,this)}function ea(a){this.enabled=!0;this.frame=new d.RenderFrameContext;this.use_node_camera=this.use_antialiasing=!1;this.title=null;if("undefined"==typeof LGraphTexture)return console.error("Cannot use FXGraphComponent if LiteGraph is not installed");this._graph=new LGraph;this._graph.getScene=function(){return this._scene};this._graph.component=this;a?this.configure(a):(this._graph_frame_node=LiteGraph.createNode("scene/frame","Rendered Frame"),this._graph_frame_node.ignore_remove=
!0,this._graph_frame_node.ignore_rename=!0,this._graph.add(this._graph_frame_node),this._graph_viewport_node=LiteGraph.createNode("texture/toviewport","Viewport"),this._graph_viewport_node.pos[0]=500,this._graph_viewport_node.properties.disable_alpha=!0,this._graph.add(this._graph_viewport_node),this._graph_frame_node.connect(0,this._graph_viewport_node));null==ea.high_precision_format&&ba.gl&&(ea.high_precision_format=gl.half_float_ext?gl.HALF_FLOAT_OES:gl.float_ext?gl.FLOAT:gl.UNSIGNED_BYTE)}function Sb(){this.id=
0;this._pos=vec3.fromValues(0,0,0);this._vel=vec3.fromValues(0,0,0);this.life=1;this.angle=0;this.size=1;this.rot=0}function T(a){this.enabled=!0;this.max_particles=1024;this.warm_up_time=0;this.point_particles=!1;this.emissor_type=T.BOX_EMISSOR;this.emissor_rate=5;this.emissor_size=vec3.fromValues(10,10,10);this.emissor_node=this.emissor_mesh=null;this.particle_life=5;this.particle_speed=10;this.particle_size=5;this.particle_rotation=0;this.particle_size_curve=[[1,1]];this._particle_start_color=
vec3.fromValues(1,1,1);this._particle_end_color=vec3.fromValues(1,1,1);this.particle_opacity_curve=[[0.5,1]];this.texture_grid_size=1;this.physics_gravity=[0,0,0];this.physics_friction=0;this.opacity=1;this.additive_blending=!1;this.texture=null;this.animation_fps=1;this.premultiplied_alpha=this.independent_color=this.loop_animation=this.animated_texture=this.use_node_material=this.soft_particles=!1;this.align_with_camera=!0;this.follow_emitter=this.align_always=!1;this.sort_in_z=!0;this.ignore_lights=
this.stop_update=!1;this.onUpdateParticle=this.onCreateParticle=null;a&&this.configure(a);"number"==typeof this.emissor_size&&(this.emissor_size=[this.emissor_size,this.emissor_size,this.emissor_size]);this._emissor_pos=vec3.create();this._particles=[];this._visible_particles=this._remining_dt=0;this._min_particle_size=0.001;this._last_id=0;ba.gl&&this.createMesh()}function lb(a){this.className=this.text="";this.use_html=!1;this._world_pos=vec3.create();this._screen_pos=vec3.create();this.configure(a)}
function fa(a){this.enabled=!0;this.max_points=1024;this.mesh=null;this._points=[];this.size=1;this.texture=null;this.global_opacity=1;this.color=vec3.fromValues(1,1,1);this.use_perspective=this.sort_in_z=this.in_world_coordinates=this.use_node_material=this.additive_blending=!1;this.serialize_points=!0;a&&this.configure(a);this._render_instance=new d.RenderInstance(null,this);this._min=vec3.create();this._max=vec3.create();ba.gl&&this.createMesh()}function Ha(a){this.enabled=!0;this.max_lines=1024;
this._lines=[];this.global_opacity=1;this.color=vec3.fromValues(1,1,1);this.in_world_coordinates=this.use_node_material=!1;a&&this.configure(a);this._last_id=0;ba.gl&&this.createMesh()}function O(a){this.enabled=!0;this._animation="";this._take="default";this.autoload=!0;this.root_node="@";this.playback_speed=1;this.mode=O.LOOP;this.playing=!0;this.blend_time=this.current_time=0;this.onApplySample=this.onPreApply=this.range=null;this._last_time=0;this._use_blend_animation=!1;this._blend_take=this._blend_animation=
null;this._blend_remaining_time=this._blend_current_time=0;this._blend_updated_frame=-1;this.disabled_tracks={};a&&this.configure(a)}function U(a){this.enabled=!0;this.animation="";this.playback_speed=1;this._skeleton=new d.Skeleton;this.mode=U.LOOP;this.playing=!0;this.current_time=0;this.range=null;this.interpolate=!0;a&&this.configure(a)}function mb(a){this.enabled=!0;this.texture_size=512;this.clip_offset=0.5;this.texture_name="";this.all_cameras=!1;this.blur=0;this.use_mesh_info=this.generate_mipmaps=
!1;this.offset=vec3.create();this.skip_if_node_not_visible=this.ignore_this_mesh=!0;this.high_precision=!1;this.refresh_rate=1;this.layers=255;this._clipping_plane=vec4.create();this._textures={};a&&this.configure(a)}function aa(a){this._enabled=!0;this.texture_size=512;this.high_precision=!1;this.texture_name="";this.generate_irradiance=!0;this.generate_mipmaps=!1;this.refresh_rate=0;this.layers=255;this.near=0.1;this.far=1E3;this.background_color=vec4.create();this._position=vec3.create();this._current=
vec3.create();this._version=-1;this._texture=null;this._irradiance_shs=new Float32Array(27);this._tex_id=":probe_"+aa.last_id;aa.last_id++;this._must_update=this._registered=!1;a&&this.configure(a)}function E(a){this.enabled=!0;this.size=vec3.fromValues(10,10,10);this.subdivisions=new Uint8Array([4,1,4]);this.layers=255;this.force_two_sided=!1;this.near=0.1;this.far=1E3;this.debug=this.sampling_distance=0;this.background_color=vec4.create();this.intensity_color=vec3.fromValues(1,1,1);this.mode=E.VERTEX_MODE;
this._irradiance_cubemaps=[];this._irradiance_shs=[];this._irradiance_matrix=mat4.create();this._irradiance_subdivisions=vec3.clone(this.subdivisions);this._sh_texture=null;this._uniforms={irradiance_texture:d.Renderer.IRRADIANCE_TEXTURE_SLOT,u_irradiance_subdivisions:this._irradiance_subdivisions,u_irradiance_color:this.intensity_color,u_irradiance_imatrix:mat4.create(),u_irradiance_distance:0};this._samplers=[];this.onRecomputingFinished=this.onComputedSphericalHarmonics=this.onPreprocessCubemap=
this.onRecomputingIrradiance=null;this.cache_filename="";this._cache_resource=null;a&&(this.configure(a),a.uid&&!this.cache_filename&&(this.cache_filename="IR_cache_"+a.uid.substr(1)+".bin"))}function xc(a,b,c){var e=b||128,g=c||4,d=[];a.forEach(function(a,b){for(var c=[],g=0;g<e;g++)for(var h=0;h<e;h++){var k=2*g/(e-1)-1,x=[];vec3.scale(x,ic[b][0],2*h/(e-1)-1);var u=[];vec3.scale(u,ic[b][1],k);var k=ic[b][2],L=[];vec3.add(L,x,u);vec3.add(L,L,k);vec3.normalize(L,L);c.push(L)}d.push(c)});var h=[new Float32Array(3),
new Float32Array(3),new Float32Array(3),new Float32Array(3),new Float32Array(3),new Float32Array(3),new Float32Array(3),new Float32Array(3),new Float32Array(3)],k=0;a.forEach(function(a,b){var c=!0,n=!0;"[object Float32Array]"===Object.prototype.toString.call(a)&&(n=c=!1);for(var r=0;r<e;r++)for(var t=0;t<e;t++){var x=d[b][r*e+t],u,L=2*(t+0.5)/e-1,ra=2*(r+0.5)/e-1,q=1/e,G=1/e;u=L-q;var s=ra-G,L=L+q,ra=ra+G;u=Tb(u,s)-Tb(u,ra)-Tb(L,s)+Tb(L,ra);for(var s=4*u/17,ra=8*u/17,G=15*u/17,L=5*u/68,q=15*u/68,
w=x[0],z=x[1],x=x[2],v=0;3>v;v++){var B=a[r*e*g+t*g+v];n&&(B/=255);c&&(B=Math.pow(B,2.2));h[0][v]+=B*s;h[1][v]+=B*ra*z;h[2][v]+=B*ra*x;h[3][v]+=B*ra*w;h[4][v]+=B*G*w*z;h[5][v]+=B*G*z*x;h[6][v]+=B*L*(3*x*x-1);h[7][v]+=B*G*w*x;h[8][v]+=B*q*(w*w-z*z);k+=u}}});a=new Float32Array(3*h.length);for(b=0;b<h.length;b++)a[3*b]=h[b][0]*=4*Math.PI/k,a[3*b+1]=h[b][1]*=4*Math.PI/k,a[3*b+2]=h[b][2]*=4*Math.PI/k;return a}function Tb(a,b){return Math.atan2(a*b,Math.sqrt(a*a+b*b+1))}function s(a){this.enabled=!0;this.code=
this.constructor.templates.script;this._blocked_functions=new Set;this._name="";this._script=new Z;this._script.extra_methods={getComponent:function(a,c){return arguments.length?this._root?this._root.getComponent(a,c):null:this}.bind(this),getLocator:function(){return this.getComponent().getLocator()+"/context"},createProperty:d.BaseComponent.prototype.createProperty,createAction:d.BaseComponent.prototype.createAction,bind:d.BaseComponent.prototype.bind,unbind:d.BaseComponent.prototype.unbind,trigger:function(a,
c){return LEvent.trigger(this,a,c)}.bind(this),unbindAll:d.BaseComponent.prototype.unbindAll};this._script.onerror=this.onError.bind(this);this._script.exported_functions=[];this._breakpoints=this._last_error=null;a&&this.configure(a)}function wa(a){this.enabled=!0;this._name=this._filename="";this._script=new Z;this._blocked_functions=new Set;this._script.extra_methods={getComponent:function(){return this}.bind(this),getLocator:function(){return this.getComponent().getLocator()+"/context"},createProperty:d.BaseComponent.prototype.createProperty,
createAction:d.BaseComponent.prototype.createAction,bind:d.BaseComponent.prototype.bind,unbind:d.BaseComponent.prototype.unbind,unbindAll:d.BaseComponent.prototype.unbindAll};this._script.onerror=this.onError.bind(this);this._script.exported_functions=[];this._last_error=null;a&&this.configure(a)}function ga(a){this.enabled=!0;this.mode=ga.GRID_MODE;this.createProperty("count",vec3.fromValues(10,1,1));this.createProperty("size",vec3.fromValues(100,100,100));this.material=this.lod_mesh=this.mesh=null;
this._instances_matrix=[];this._RI=new d.RenderInstance(null,this);a&&this.configure(a)}function sa(a){this.only_internal_nodes=this.enabled=!0;this.base_nodes=[];this.poses=[];this._poses_by_name={};a&&this.configure(a)}function ta(a){this.enabled=!0;this._render_in_viewport=!1;this.path=new d.Path;this._must_update=!1;this._subdivisions=20;this.preserve_tangents=!0;a&&this.configure(a);this._max_points=1024;this._range=0;this._middle_points=new Float32Array(3072)}function nb(a){this.enabled=!0;
this.spline="";this.factor=0;this._last_position=vec3.create();this._last_position_inc=vec3.create();this._last_rotation=quat.create();a&&this.configure(a)}function Y(a){this.enabled=!0;this.mode=1;this.height=this.width=512;this.texture_name=":canvas3D";this.input_active=this.visible=!0;this.generate_mipmaps=this.use_node_material=!1;this.max_interactive_distance=100;this.high_precision=!1;this.opacity=1;this._skip_backside=this._clear_buffer=!0;this._standard_material=this._RI=this._fbo=this._texture=
null;this._mouse=vec3.create();this._is_mouse_inside=!1;this._local_mouse={mousex:0,mousey:0,buttons:0};this._local_mouse_click={mousex:0,mousey:0};a&&this.configure(a)}function J(a){this._enabled=!0;this._media=document.createElement("video");this._media.muted=!1;this._media.autoplay=!1;this.bindVideoEvents(this._media);this._autoplay=!0;this.generate_mipmaps=!1;this._src="";this._url_loading=null;this.texture_name=":video";this.render_mode=!0;this._playback_rate=1;this._ignore_proxy=!1;this._texture=
null;a&&this.configure(a)}function Ba(a){this.enabled=!0;this.mode=Ba.PICKING;this.layers=3;this._last_collision=null;a&&this.configure(a)}function na(a){this.options=a=a||{};if(!a.canvas){var b=a.container;a.container_id&&(b=document.getElementById(a.container_id));b||(console.log("No container specified in ONE.Player, using BODY as container"),b=document.body);var c=document.createElement("canvas");c.width=b.offsetWidth;c.height=b.offsetHeight;c.width||(c.width=a.width||1);c.height||(c.height=a.height||
1);b.appendChild(c);a.canvas=c}this.skip_play_button=this.autoplay=this.debug=!1;this.gl=GL.create(a);this.canvas=this.gl.canvas;this.render_settings=new d.RenderSettings;this.scene=d.GlobalScene;this._file_drop_enabled=!1;d.Shaders.init();this.renderer=a.renderer||d.Renderer;this.renderer.init();this.state=d.Player.STOPPED;if(this.gl.ondraw)throw"There is already a litegl attached to this context";this.configure(a);this.gl.ondraw=d.Player.prototype._ondraw.bind(this);this.gl.onupdate=d.Player.prototype._onupdate.bind(this);
b=d.Player.prototype._onmouse.bind(this);this.gl.onmousedown=b;this.gl.onmousemove=b;this.gl.onmouseup=b;this.gl.onmousewheel=b;b=d.Player.prototype._onkey.bind(this);this.gl.onkeydown=b;this.gl.onkeyup=b;b=d.Player.prototype._ontouch.bind(this);this.gl.ontouch=b;b=d.Player.prototype._ongamepad.bind(this);this.gl.ongamepadconnected=b;this.gl.ongamepaddisconnected=b;this.gl.ongamepadButtonDown=b;this.gl.ongamepadButtonUp=b;gl.captureMouse(!a.ignore_scroll);gl.captureKeys(!0);gl.captureTouch(!a.ignore_touch);
gl.captureGamepads(!0);d.Input&&d.Input.init();!1!==a.enableFileDrop&&this.setFileDrop(!0);gl.animate()}function yc(a){a=window.atob(a);for(var b=a.length,c=new Uint8Array(b),e=0;e<b;e++)c[e]=a.charCodeAt(e);return c.buffer}(function(a){function b(){}b.classes={};b.HEADER_SIZE=64;b.FOUR_CC="WBIN";b.VERSION=0.3;b.CLASSNAME_SIZE=32;b.LUMPNAME_SIZE=54;b.LUMPHEADER_SIZE=10+b.LUMPNAME_SIZE;b.CODES={ArrayBuffer:"AB",Int8Array:"I1",Uint8Array:"i1",Int16Array:"I2",Uint16Array:"i2",Int32Array:"I4",Uint32Array:"i4",
Float32Array:"F4",Float64Array:"F8",Object:"OB",WideObject:"WO",String:"ST",WideString:"WS",Number:"NU","null":"00"};b.REVERSE_CODES={};for(var c in b.CODES)b.REVERSE_CODES[b.CODES[c]]=c;b.FULL_BINARY=1;b.isWBin=function(a){a=a.subarray(0,4);for(var c=0;c<a.length;c++)if(0!=a[c]&&a[c]!=b.FOUR_CC.charCodeAt(c))return!1;return!0};b.create=function(a,c){if(!a)throw"WBin null origin passed";var d=new Uint8Array([0,0]),h=new Uint8Array((new Float32Array([b.VERSION])).buffer);c=c||"";if(a.toBinary){var k=
a.toBinary();if(!k)return null;if(k.constructor==ArrayBuffer){d[0]|=b.FULL_BINARY;var l=b.getObjectClassName(a),m=new Uint8Array(b.HEADER_SIZE+k.length);m.set(b.stringToUint8Array(b.FOUR_CC));m.set(h,4);m.set(d,8);m.set(b.stringToUint8Array(l,b.CLASSNAME_SIZE),14);m.set(k,b.HEADER_SIZE);return m}a=k}var p=b.HEADER_SIZE,k=[],n=0,r;for(r in a)if(m=a[r],null!=m){if(m.constructor===Blob||m.constructor===File)throw"Wbin does not allow Blobs or Files as data to store, conver to ArrayBuffer";l=b.getObjectClassName(m);
(l=b.CODES[l])||(l="OB");"NU"==l?m=new Float64Array([m]):"OB"==l&&(m=JSON.stringify(m));var t=0;m&&m.constructor==String&&(m=b.stringToTypedArray(m),m.constructor===Uint16Array&&(l="OB"==l?"WO":"WS"));if(m.buffer&&m.buffer.constructor==ArrayBuffer)m=new Uint8Array(new Uint8Array(m.buffer,m.byteOffset,m.byteLength)),t=m.byteLength;else if(m.constructor==ArrayBuffer)t=m.byteLength;else throw"WBin: cannot be anything different to ArrayBuffer";var x=r.substring(0,b.LUMPNAME_SIZE);x.length<r.length&&console.error("Lump name is too long (max is "+
b.LUMPNAME_SIZE+"), it has been cut down, this could lead to an error in the future");k.push({code:l,name:x,data:m,start:n,size:t});n+=t;p+=b.LUMPHEADER_SIZE+t}m=new Uint8Array(p);m.set(b.stringToUint8Array(b.FOUR_CC));m.set(h,4);m.set(d,8);m.set(new Uint8Array((new Uint16Array([k.length])).buffer),10);c&&m.set(b.stringToUint8Array(c,b.CLASSNAME_SIZE),12);var d=b.HEADER_SIZE+k.length*b.LUMPHEADER_SIZE,h=b.HEADER_SIZE,u;for(u in k)r=k[u],p=new Uint8Array(b.LUMPHEADER_SIZE),p.set(new Uint8Array((new Uint32Array([r.start])).buffer),
0),p.set(new Uint8Array((new Uint32Array([r.size])).buffer),4),p.set(b.stringToUint8Array(r.code,2),8),p.set(b.stringToUint8Array(r.name,b.LUMPNAME_SIZE),10),m.set(p,h),h+=b.LUMPHEADER_SIZE,p=new Uint8Array(r.data),m.set(p,d+r.start);return m};b.load=function(a,c,d){if(!a||a.constructor!==Uint8Array&&a.constructor!==ArrayBuffer)throw"WBin data must be ArrayBuffer or Uint8Array";a=new Uint8Array(a);var h=b.getHeaderInfo(a);if(!h)return console.error("Wrong WBin Header"),null;h.version>(new Float32Array([b.VERSION]))[0]&&
console.log("ALERT: WBin version is higher that code version");a=null;for(var k in h.lumps){a||(a={});var l=h.lumps[k],m=h.lump_data.subarray(l.start,l.start+l.size);if(l.size!=m.length)throw"WBin: incorrect wbin lump size";var p=null,n=b.REVERSE_CODES[l.code];if(!n)throw"WBin: Incorrect data code";switch(n){case "null":break;case "WideString":m=new Uint16Array((new Uint8Array(m)).buffer);case "String":p=b.TypedArrayToString(m);break;case "Number":p=0.3>h.version?parseFloat(b.TypedArrayToString(m)):
(new Float64Array(m.buffer))[0];break;case "WideObject":m=new Uint16Array((new Uint8Array(m)).buffer);case "Object":(m=b.TypedArrayToString(m))?p=JSON.parse(m):console.warn('WBIN: lump "'+l.name+'" string is empty, skipping.');break;case "ArrayBuffer":p=(new Uint8Array(m)).buffer;break;default:m=new Uint8Array(m);p=b.classes[n]||window[n];if(!p)throw"WBin referenced class not found: "+n;if(0!=m.length/p.BYTES_PER_ELEMENT%1)throw"WBin: size do not match type";p=new p(m.buffer)}a[l.name]=p}if(!c&&h.classname){if((p=
b.classes[h.classname]||window[h.classname])&&p.fromBinary)return p.fromBinary(a,d);if(p&&p.prototype.fromBinary)return c=new p,c.fromBinary(a,d),c;a["@classname"]=h.classname}return a};b.getHeaderInfo=function(a){for(var c=a.subarray(0,4),d=0;d<c.length;d++)if(0!=c[d]&&c[d]!=b.FOUR_CC.charCodeAt(d))return null;for(var c=b.readFloat32(a,4),h=new Uint8Array(a.subarray(8,10)),k=b.readUint16(a,10),l=b.TypedArrayToString(a.subarray(12,12+b.CLASSNAME_SIZE)),m=[],d=0;d<k;++d){var p=b.HEADER_SIZE+d*b.LUMPHEADER_SIZE,
p=a.subarray(p,p+b.LUMPHEADER_SIZE),n={};n.start=b.readUint32(p,0);n.size=b.readUint32(p,4);n.code=b.TypedArrayToString(p.subarray(8,10));n.name=b.TypedArrayToString(p.subarray(10));m.push(n)}a=a.subarray(b.HEADER_SIZE+k*b.LUMPHEADER_SIZE);return{version:c,flags:h,classname:l,numlumps:k,lumps:m,lump_data:a}};b.getObjectClassName=function(a){if(a&&a.constructor&&a.constructor.toString&&(a=a.constructor.toString().match(/function\s*(\w+)/))&&2==a.length)return a[1]};b.stringToUint8Array=function(a,
b){for(var c=new Uint8Array(b?b:a.length),d=!1,k=0;k<a.length;k++){var l=a.charCodeAt(k);255<l&&(d=!0);c[k]=l}d&&console.warn("WBin: there are characters in the string that cannot be encoded in 1 byte.");return c};b.TypedArrayToString=function(a,b){for(var c="",d=0;d<a.length;d++)if(0!=a[d]||b)c+=String.fromCharCode(a[d]);else break;return c};b.stringToTypedArray=function(a,b){for(var c=new Uint8Array(b?b:a.length),d=!1,k=0;k<a.length;k++){var l=a.charCodeAt(k);255<l&&(d=!0);c[k]=l}if(!d)return c;
c=new Uint16Array(b?b:a.length);for(k=0;k<a.length;k++)l=a.charCodeAt(k),c[k]=l;return c};b.readUint16=function(a,b){return(new DataView(a.buffer,a.byteOffset)).getUint16(b,!0)};b.readUint32=function(a,b){return(new DataView(a.buffer,a.byteOffset)).getUint32(b,!0)};b.readFloat32=function(a,b){return(new DataView(a.buffer,a.byteOffset)).getFloat32(b,!0)};a.WBin=b})("undefined"!=typeof ba?ba:this);Z.onerror=null;Z.eval=function(a,b){return eval("(function("+a+"){\n"+b+"\n})")};Z.catch_exceptions=!1;
Z.show_errors_in_console=!0;Z.prototype.compile=function(a,b){var c=[],e=[];if(a)for(var d in a)c.push(d),e.push(a[d]);var c=c.join(","),f=this.code,f=Z.expandCode(f),h="";for(d in this.exported_callbacks)var k=this.exported_callbacks[d],h=h+("\tif(typeof("+k+") != 'undefined' && "+k+' != window["'+k+'"] ) this.'+k+" = "+k+";\n");this._last_executed_code=f+=h;h=this._context;if(Z.catch_exceptions)try{this._class=new Function(c,f),m=Z.applyToConstructor(this._class,e,this.extra_methods),this._context=
new m}catch(l){this._class||console.error("Parsing error in script\n"+l);this._context=this._class=null;Z.show_errors_in_console&&(c=Z.computeLineFromError(l),console.error("Error in script\n"+l),console.groupCollapsed?(console.groupCollapsed("Error line: "+c+" Watch code"),Z.showCodeInConsole(this._last_executed_code,c),console.groupEnd()):console.error("Error line: "+c));if(this.onerror)this.onerror(l,this._last_executed_code);if(Z.onerror)Z.onerror(l,this._last_executed_code,this);return!1}else{this._class=
new Function(c,f);var m=Z.applyToConstructor(this._class,e,this.extra_methods);this._context=new m}if(b&&h)for(d in h)void 0===this._context[d]||!h[d]||h[d].constructor===Function||this._context[d]&&this._context[d].constructor===Function||(this._context[d]=h[d]);return!0};Z.prototype.hasMethod=function(a){return this._context&&this._context[a]&&"function"==typeof this._context[a]?!0:!1};Z.prototype.callMethod=function(a,b,c,e){if(this._context&&this._context[a]){if(!Z.catch_exceptions)return b&&
b.constructor===Array&&c?this._context[a].apply(this._context,b):this._context[a].call(this._context,b);try{return b&&b.constructor===Array&&c?this._context[a].apply(this._context,b):this._context[a].call(this._context,b)}catch(d){if(b=Z.computeLineFromError(d),c="",e&&e.toInfoString&&(c=" from "+e.toInfoString()),console.error("Error from function "+a+c+": ",d.toString()),console.groupCollapsed?(console.groupCollapsed("Error line: "+b+" Watch code"),Z.showCodeInConsole(this._last_executed_code,b),
console.groupEnd()):console.error("Error line: "+b),this.onerror)this.onerror({error:d,msg:d.toString(),line:b,lscript:this,code:this._last_executed_code,method_name:a})}}};Z.applyToConstructor=function(a,b,c){b=[null].concat(b);if(c)for(var e in c)Object.defineProperty(a.prototype,e,{value:c[e],enumerable:!0});return a.bind.apply(a,b)};Z.showCodeInConsole=function(a,b){if(a)for(var c=a.split("\n"),e=0;e<c.length;e++)e==b?console.log("%c "+e+". "+c[e],"background-color: #A33; color: #FAA;"):console.log("%c "+
e+". ","display: inline-block; width: 40px; background-color:#999; color: white;",c[e])};Z.cleanCode=function(a){if(!a)return"";a=a.replace(/\*([^*]|[\r\n]|(\*+([^*/]|[\r\n])))*\*+/g,"");a=a.split("\n");for(var b=[],c=0;c<a.length;++c){var e=a[c],d=e.indexOf("//");-1!=d&&-1==e.substr(0,d).indexOf('"')&&(e=e.substr(0,d));e=e.trim();e.length&&b.push(e)}return b.join("\n")};Z.expandCode=function(a){if(!a)return"";if(-1!=a.indexOf("'''")){var b=a.split("'''");a="";for(var c=0;c<b.length;c++)a=0==c%2?
a+b[c]:a+('"'+b[c].split("\n").join("\\n\\\n")+'"')}for(var b=a.split("\n"),e=!1,c=0;c<b.length;++c){var g=b[c].trim(),f=g.indexOf(" "),f=g.substr(0,f);if("public"==f||"private"==f||"hidden"==f)if(f=g.indexOf("//"),-1!=f&&(g=g.substr(0,f)),f=g.lastIndexOf(";"),-1!=f&&(g=g.substr(0,f)),"var"==g.split(" ")[1]){var h=g,g=null,f="undefined",k=h.indexOf("=");-1!=k&&(f=h.substr(k+1).trim(),h=h.substr(0,k).trim());k=h.indexOf(":");-1!=k&&(g=h.substr(k+1).trim(),h=h.substr(0,k).trim());h=h.split(" ");if(k=
h[2]){e={};if(g){var l=g.indexOf("[]");-1!=l?(e.type=d.TYPES.ARRAY,e.data_type=g.substr(0,l),f&&"undefined"!==f||(f="[]")):e.type=g;if(d.Components[g])e.component_class=g,e.type=d.TYPES.COMPONENT,f||(f="null");else if(d.ResourceClasses[g])e.resource_classname=g,e.type=d.TYPES.RESOURCE,f||(f="null");else if("int"==g||"integer"==g)e.step=1,e.type=d.TYPES.NUMBER,f||(f=0)}if("private"==h[0]||"hidden"==h[0])e.widget="null";b[c]="this.createProperty('"+k+"',"+f+", "+JSON.stringify(e)+" );";e=!0}}}e&&(a=
b.join("\n"));return a};Z.computeLineFromError=function(a){if(void 0!==a.lineNumber)return a.lineNumber;if(a.stack){a=a.stack.split("\n")[1].trim();if(-1!=a.indexOf("(native)"))return-1;var b=a.split(" "),c=a.lastIndexOf(":"),e=a.lastIndexOf(":",c-1),e=parseInt(a.substr(e+1,c-e-1));parseInt(a.substr(c+1,a.length-2-c));if("Object.CodingModule.eval"==b[1])return-1;if(-1!=a.indexOf("LScript")||-1!=a.indexOf("<anonymous>"))e-=3;return e}return-1};ba.LScript=Z;Uint8Array.prototype.toJSON||[Uint8Array,
Int8Array,Uint16Array,Int16Array,Uint32Array,Int32Array,Float32Array,Float64Array].forEach(function(a){a.prototype.toJSON=function(){return Array.prototype.slice.call(this)}});"undefined"===typeof GL&&console.error("LiteScene requires to include LiteGL first. More info: https://github.com/jagenjo/litegl.js");var d={Version:0.6,ResourcesManager:null,Picking:null,Player:null,GUI:null,Network:null,Input:null,Renderer:null,Physics:null,ShadersManager:null,Formats:null,Tween:null,Classes:{},ResourceClasses:{},
ResourceClasses_by_extension:{},Globals:{},Components:{},MaterialClasses:{},_last_uid:1,_uid_prefix:"@",debug:!1,allow_static:!0,allow_scripts:!0,_gui_element:null,_gui_style:null,generateUId:function(a,b){b=b||"";var c=this._uid_prefix+(a||"")+(window.navigator.userAgent.hashCode()%16777216).toString(16)+"-",c=c+((GL.getTime()|0).toString(16)+"-"),c=c+(Math.floor(16777216*(1+Math.random())).toString(16)+"-"),c=c+(this._last_uid++).toString(16);return c+b},validateName:function(a){return a.match(/^[a-z\s0-9-_.]+$/i)},
valid_property_types:"String Number Boolean color vec2 vec3 vec4 quat mat3 mat4 Resource Animation Texture Prefab Mesh ShaderCode node component".split(" "),validatePropertyType:function(a){return-1==this.valid_property_types.indexOf(a)?(console.error(a+" is not a valid property value type."),!1):!0},_catch_exceptions:!1,registerComponent:function(a,b){var c=d.getClassName(a);if(b&&b.constructor!==String)throw"old_classname must be null or a String";this.Components[c]=a;a.is_component=!0;a.resource_type=
"Component";!!a.prototype.onAddedToNode==!!a.prototype.onRemovedFromNode&&!!a.prototype.onAddedToScene==!!a.prototype.onRemovedFromScene||console.warn("%c Component "+c+" could have a bug, check events: "+c,"font-size: 2em");a.prototype.getResources&&!a.prototype.onResourceRenamed&&console.warn("%c Component "+c+" could have a bug, it uses resources but doesnt implement onResourceRenamed, this could lead to problems when resources are renamed.","font-size: 1.2em");a.actions||(a.actions={});d.extendClass(a,
d.BaseComponent);Pa.addExtraMethods(a);d.debug&&((new a).serialize().object_class||console.warn("%c Component "+c+" could have a bug, serialize() method has object_class missing.","font-size: 1.2em"));LEvent.trigger(Xa,"component_registered",a);d.GlobalScene&&(this.replaceComponentClass(d.GlobalScene,b||c,c),b!=c&&this.unregisterComponent(b))},unregisterComponent:function(a){this.Components[a]&&delete this.Components[a]},isClassComponent:function(a){a=this.getClassName(a);return!!this.Components[a]},
replaceComponentClass:function(a,b,c){var e=c.constructor===String?d.Components[c]:c;if(!e)return 0;var g=null;b.constructor===String&&(g=d.Components[b])&&(b=d.getClassName(g));for(var f=g=0;f<a._nodes.length;++f)for(var h=a._nodes[f],k=0;k<h._components.length;++k){var l=h._components[k],m=l.constructor===d.MissingComponent?l._comp_class:d.getObjectClassName(l);if(l.constructor!==e&&(m==b||m==c)){m=l.serialize();h.removeComponent(l);l=null;try{l=new e}catch(p){console.error("Error in replacement component constructor");
console.error(p);continue}h.addComponent(l,k<h._components.length?k:void 0);l.configure(m);g++}}return g},registerResourceClass:function(a){var b=d.getClassName(a);this.ResourceClasses[b]=a;this.Classes[b]=a;a.is_resource=!0;a.FORMAT||(a.FORMAT={});a.FORMAT.resource=b;a.FORMAT.resourceClass=a;a.EXTENSION&&(a.FORMAT.extension=a.EXTENSION.toLowerCase());var c=a.FORMAT.extension;c||a==d.Resource?(this.ResourceClasses_by_extension[c]=a,a.EXTENSION=c):console.warn("Resource without extension info? "+b);
d.Formats&&c&&((b=d.Formats.supported[c],b)?b.resourceClass||(b.resourceClass=a):d.Formats.supported[c]=a.FORMAT)},coroutines:{},addWaitingCoroutine:function(a,b){b=b||"render";var c=this.coroutines[b];c||(c=this.coroutines[b]=[]);c.push(a)},triggerCoroutines:function(a,b){var c=this.coroutines[a||"render"];if(c){for(var e=0;e<c.length;++e)d.safeCall(c[e],b);c.length=0}},createCoroutine:function(a){return new Promise(function(b){d.addWaitingCoroutine(b,a)})},sleep:function(a){return new Promise(function(b){setTimeout(b,
a)})},nextFrame:function(a){a||d.GlobalScene.requestFrame();return new Promise(function(a){d.addWaitingCoroutine(a,"render")})},safeCall:function(a,b,c){if(!d.catch_exceptions)return c?a.apply(c,b):a(b);try{return a.apply(c,b)}catch(e){LEvent.trigger(Xa,"exception",e),console.error(e.stack)}},setTimeout:function(a,b){if(!d.catch_exceptions)return setTimeout(a,b);try{return setTimeout(a,b)}catch(c){LEvent.trigger(Xa,"exception",c)}},setInterval:function(a,b){if(!d.catch_exceptions)return setInterval(a,
b);try{return setInterval(a,b)}catch(c){LEvent.trigger(Xa,"exception",c)}},extendClass:function(a,b){for(var c in b)a.hasOwnProperty(c)||(a[c]=b[c]);if(b.prototype)for(c in b.prototype)b.prototype.hasOwnProperty(c)&&!a.prototype.hasOwnProperty(c)&&(b.prototype.__lookupGetter__(c)?a.prototype.__defineGetter__(c,b.prototype.__lookupGetter__(c)):a.prototype[c]=b.prototype[c],b.prototype.__lookupSetter__(c)&&a.prototype.__defineSetter__(c,b.prototype.__lookupSetter__(c)))},cloneObject:function(a,b,c,
e,g){if(void 0!==a){if(null===a)return null;switch(a.constructor){case String:case Number:case Boolean:return a}if(a.constructor.BYTES_PER_ELEMENT){if(!b)return new a.constructor(a);if(b.set)b.set(a);else if(b.construtor===Array)for(var f=0;f<a.length;++f)b[f]=a[f];else throw"cloneObject: target has no set method";return b}var h=b;if(void 0===h||null===h)h=a.constructor===Array?[]:{};for(f in a)if("@"!=f[0]&&"_"!=f[0]&&"jQuery"!=f.substr(0,6)&&(!e||b.hasOwnProperty(f)||b.__proto__.hasOwnProperty(f))){var k=
a[f];if(null==k)h[f]=null;else if(!isFunction(k))if(k.constructor===File)h[f]=null;else if(k.constructor===Number||k.constructor===String||k.constructor===Boolean)h[f]=k;else if(k.buffer&&k.byteLength&&k.buffer.constructor===ArrayBuffer)h[f]&&k&&e?h[f].length==k.length&&h[f].set(k):h[f]=new k.constructor(k);else if(k.constructor===Array)if(h[f]&&h[f].set&&h[f].length>=k.length)h[f].set(k);else if(g&&b&&"@ENC"==k[0]){var l=d.decodeObject(k);(h[f]=l)||(d._pending_encoded_objects?d._pending_encoded_objects.push([h,
f,k]):console.warn("Object UID referencing object not found in the scene:",k[2]))}else h[f]=d.cloneObject(k);else if(k.constructor.is_resource)console.error("Resources cannot be saved as a property of a component nor script, they must be saved individually as files in the file system. If assigning them to a component/script use private variables (name start with underscore) to avoid being serialized.");else if(g&&!b)h[f]=d.encodeObject(k);else if(k.constructor===Object||b||k.toJSON)if(k.toJSON)h[f]=
k.toJSON();else if(c)h[f]=d.cloneObject(k,null,!0);else if(k.constructor!==Object&&d.Classes[d.getObjectClassName(k)]&&console.warn("Cannot clone internal classes:",d.getObjectClassName(k)," When serializing an object I found a var with a class that doesnt support serialization. If this var shouldnt be serialized start the name with underscore.'"),d.catch_exceptions)try{h[f]=JSON.parse(JSON.stringify(k))}catch(m){console.error(m)}else h[f]=JSON.parse(JSON.stringify(k));else console.warn("Cannot clone internal classes:",
d.getObjectClassName(k)," When serializing an object I found a var with a class that doesnt support serialization. If this var shouldnt be serialized start the name with underscore.'")}return h}},encodeObject:function(a){if(!a||a.constructor===Number||a.constructor===String||a.constructor===Boolean||a.constructor===Object)return a;if(a.constructor.is_component&&a._root)return["@ENC",d.TYPES.COMPONENT,a.getLocator(),d.getObjectClassName(a)];if(a.constructor==d.SceneNode&&a._in_tree)return["@ENC",d.TYPES.SCENENODE,
a.uid];if(a.constructor==d.Scene)return["@ENC",d.TYPES.SCENE,a.fullpath];if(a.serialize||a.toJSON)return["@ENC",d.TYPES.OBJECT,a.serialize?a.serialize():a.toJSON(),d.getObjectClassName(a)];console.warn("Cannot clone internal classes:",d.getObjectClassName(a)," When serializing an object I found a property with a class that doesnt support serialization. If this property shouldn't be serialized start the name with underscore.'");return null},decodeObject:function(a){if(!a||a.constructor!==Array||"@ENC"!=
a[0])return null;switch(a[1]){case d.TYPES.COMPONENT:case "node":case d.TYPES.SCENENODE:return(a=Oa.get(a[2]))?a:null;case d.TYPES.SCENE:return null;default:if(!a[2]||!a[2].object_class)return null;var b=d.Classes[a[2].object_class];if(!b)return null;b=new b;b.configure(a[2]);return b}},resolvePendingEncodedObjects:function(){if(d._pending_encoded_objects){for(var a=0;a<d._pending_encoded_objects.length;++a){var b=d._pending_encoded_objects[a],c=d.decodeObject(b[2]);c?b[0][b[1]]=c:console.warn("Decoded object not found when configuring from JSON")}d._pending_encoded_objects=
null}else console.warn("no pending enconded objects")},switchGlobalScene:function(a){if(a!==d.GlobalScene){if(null===a||a.constructor!==d.Scene)throw"Not an scene";LEvent.trigger(Xa,"global_scene_changed",a);d.GlobalScene=a}},clearUIds:function(a,b){b=b||{};a.uid&&(b[a.uid]=a,delete a.uid);a.material&&a.material.uid&&(b[a.material.uid]=a.material,delete a.material.uid);var c=a.components;!c&&a.getComponents&&(c=a.getComponents());if(c){if(c)for(var e in c){var g=c[e];g[1].uid&&(b[g[1].uid]=g[1],delete g[1].uid);
g[1]._uid&&(b[g[1]._uid]=g[1],delete g[1]._uid)}c=a.children;!c&&a.getChildren&&(c=a.getChildren());if(c){for(e in c)d.clearUIds(c[e],b);return b}}},getObjectClassName:function(a){if(a){if(a.constructor.fullname)return a.constructor.fullname;if(a.constructor.name)return a.constructor.name;if((a=a.constructor.toString().match(/function\s*(\w+)/))&&2==a.length)return a[1]}},getClassName:function(a){if(a){if(a.name)return a.name;if(a.toString&&(a=a.toString().match(/function\s*(\w+)/))&&2==a.length)return a[1]}},
getObjectProperties:function(a){if(a.getPropertiesInfo)return a.getPropertiesInfo();var b=a.constructor;if(b.properties)return b.properties;var c={},e;for(e in a)if("_"!=e[0]&&"@"!=e[0]&&"jQuery"!=e.substr(0,6)){if(b!=Object){var g=b["@"+e];if(g&&g.type){c[e]=g.type;continue}}g=a[e];null==g?c[e]=null:isFunction(g)||(c[e]=g.constructor===Boolean?d.TYPES.BOOLEAN:g.constructor===Number?d.TYPES.NUMBER:g.constructor===String?d.TYPES.STRING:g.buffer&&g.buffer.constructor===ArrayBuffer?2==g.length?d.TYPES.VEC2:
3==g.length?d.TYPES.VEC3:4==g.length?d.TYPES.VEC4:9==g.length?d.TYPES.MAT3:16==g.length?d.TYPES.MAT4:0:0)}return c},setObjectProperty:function(a,b,c){if(a.setProperty)return a.setProperty(b,c);a[b]=c;if(a.onPropertyChanged)a.onPropertyChanged(b,c)},registerMaterialClass:function(a){var b=d.getClassName(a);this.MaterialClasses[b]=a;this.Classes[b]=a;d.extendClass(a,B);LEvent.trigger(Xa,"materialclass_registered",a);a.resource_type="Material";a.is_material=!0},getScript:function(a){return(a=d.Script.active_scripts[a])?
a.context:null},getDebugRender:function(){d.debug_render||(d.debug_render=new d.DebugRender);return d.debug_render},dispatchCodeError:function(a,b,c,e){a={error:a,line:b,resource:c,extra:e};console.error(a);LEvent.trigger(this,"code_error",a)},dispatchNoErrors:function(a,b){LEvent.trigger(this,"code_no_errors",{resource:a,extra:b})},convertToString:function(a){if(!a)return"";if(a.constructor===String)return a;if(a.constructor===Object)return JSON.stringify(object.serialize?object.serialize():object);
a.constructor===ArrayBuffer&&(a=new Uint8Array(a));return String.fromCharCode.apply(null,a)},checkLocatorBelongsToPrefab:function(a,b){b=b||d.GlobalScene.root;var c=a.split("/");return c.length?(c=Oa.get(c[0],b))?c.insidePrefab():null:null},convertLocatorFromUIDsToName:function(a,b,c){c=c||d.GlobalScene.root;a=a.split("/");if(!a.length||a[0][0]!==d._uid_prefix&&(1==a.length||a[1][0]!==d._uid_prefix))return null;c=Oa.get(a[0],c);if(!c)return console.warn("getIDasName: node not found in ONE.GlobalScene: "+
a[0]),!1;if(!c.name)return console.warn("getIDasName: node without name?"),!1;if(1<a.length&&a[1][0]==d._uid_prefix){var e=d.GlobalScene.findComponentByUId(a[1]);if(e){var g=e.constructor.name;if("Script"==g||"ScriptFromFile"==g)g=e.name,"unnamed"==g&&(console.error("converting component UIDs to component name, but property belongs to a Script without name. You must name the script to avoid errors."),g=e.constructor.name);a[1]=g}}a=a.concat();a[0]=b?c.name:c.fullname;return a.join("/")},reset:function(){d.GlobalScene.clear();
d.ResourcesManager.reset();LEvent.trigger(Xa,"reset")},log:function(){console.log.apply(console,arguments)},stringToValue:function(a){var b=a;try{b=JSON.parse(a)}catch(c){console.error("Not a valid value: "+a)}return b},isValueOfType:function(a,b){if(null===a||void 0===a){switch(b){case "float":case "sampler2D":case "samplerCube":case d.TYPES.NUMBER:case d.TYPES.VEC2:case d.TYPES.VEC3:case d.TYPES.VEC4:case d.TYPES.COLOR:case d.TYPES.COLOR4:case "mat3":case "mat4":return!1}return!0}switch(b){case "float":case "sampler2D":case "samplerCube":case d.TYPES.NUMBER:return isNumber(a);
case d.TYPES.VEC2:return 2===a.length;case d.TYPES.VEC3:return 3===a.length;case d.TYPES.VEC4:return 4===a.length;case d.TYPES.COLOR:return 3===a.length;case d.TYPES.COLOR4:return 4===a.length;case "mat3":return 9===a.length;case "mat4":return 16===a.length}return!0},queryString:function(){for(var a={},b=window.location.search.substring(1).split("&"),c=0;c<b.length;c++){var e=b[c].split("=");if("undefined"===typeof a[e[0]])a[e[0]]=decodeURIComponent(e[1]);else if("string"===typeof a[e[0]]){var d=
[a[e[0]],decodeURIComponent(e[1])];a[e[0]]=d}else a[e[0]].push(decodeURIComponent(e[1]))}return a}(),downloadFile:function(a,b,c){if(b){c||(c=b.constructor===String?"text/plain":"application/octet-stream");var e=null,e=b.constructor!==File&&b.constructor!==Blob?new Blob([b],{type:c}):b,d=URL.createObjectURL(e);b=document.createElement("a");b.setAttribute("href",d);b.setAttribute("download",a);b.style.display="none";document.body.appendChild(b);b.click();document.body.removeChild(b);setTimeout(function(){URL.revokeObjectURL(d)},
6E4)}else console.warn("No file provided to download")}},Xa=d;Object.defineProperty(Xa,"catch_exceptions",{set:function(a){this._catch_exceptions=a;Z.catch_exceptions=a;Z.catch_important_exceptions=a},get:function(){return this._catch_exceptions},enumerable:!0});Object.defineProperty(Xa,"block_scripts",{set:function(a){d._block_scripts=a;Z.block_execution=a},get:function(){return!!d._block_scripts},enumerable:!0});d.Classes.WBin=d.WBin=ba.WBin=WBin;Oa.set=function(a,b,c,e){e=e||d.GlobalScene;if(!c)e.setPropertyValue(a,
b);else if(c.constructor===d.SceneNode)return a=a.split("/"),(c=c.findNodeByUId(a[0]))?c.setPropertyValueFromPath(a.slice(1),b):null;e.requestFrame()};Oa.get=function(a,b,c){if(!a)return null;c=c||d.GlobalScene;var e;if(!b)e=c.getPropertyInfo(a);else if(b.constructor===d.SceneNode){a=a.split("/");b=b.findNodeByUId(a[0]);if(!b)return null;e=b.getPropertyInfoFromPath(a.slice(1))}return e?e.value:null};Oa.shortify=function(a,b){if(a){var c=a.split("/"),e=null;if(c[0][0]!=d._uid_prefix)return a;b=b||
d.GlobalScene;e=b._nodes_by_uid[c[0]];if(!e)return a;c[0]=e.getPathName();c[1]&&c[1][0]==d._uid_prefix&&(e=e.getComponentByUId(c[1]))&&(c[1]=d.getObjectClassName(e));return c.join("/")}};Oa.setFromInfo=function(a,b){if(a&&a.target){var c=a.target;if(c.setPropertyValue&&!0===c.setPropertyValue(a.name,b))return c;if(void 0!==c[a.name]||void 0!==a.value)c[a.name]=b}};Oa.getFromInfo=function(a){if(a&&a.target){var b=a.target;a=a.name;var c=void 0;b.getPropertyValue&&(c=b.getPropertyValue(a));return void 0===
c&&void 0===b[a]?null:void 0!==c?c:b[a]}};ba.GL&&(GL.Mesh.EXTENSION="wbin",GL.Texture.EXTENSION="png",d.registerResourceClass(GL.Mesh),d.registerResourceClass(GL.Texture),d.Mesh=GL.Mesh,d.Texture=GL.Texture,d.Buffer=GL.Buffer);ba.LSQ=Oa;if("undefined"==typeof GL)throw"LiteSCENE requires to have litegl.js included before litescene.js";var fb={AUTOMATIC:1,NORMAL:2,ALPHA:3,ADD:4,MULTIPLY:5,SCREEN:6,CUSTOM:7};d.Blend=fb;d.BlendFunctions={};d.BlendFunctions[fb.AUTOMATIC]=[GL.ONE,GL.ZERO];d.BlendFunctions[fb.NORMAL]=
[GL.ONE,GL.ZERO];d.BlendFunctions[fb.ALPHA]=[GL.SRC_ALPHA,GL.ONE_MINUS_SRC_ALPHA];d.BlendFunctions[fb.ADD]=[GL.SRC_ALPHA,GL.ONE];d.BlendFunctions[fb.MULTIPLY]=[GL.DST_COLOR,GL.ONE_MINUS_SRC_ALPHA];d.BlendFunctions[fb.SCREEN]=[GL.SRC_ALPHA,GL.ONE];d.BlendFunctions[fb.CUSTOM]=[GL.SRC_ALPHA,GL.ONE_MINUS_SRC_ALPHA];d.NONE=0;d.LINEAR=1;d.TRIGONOMETRIC=2;d.CUBIC=3;d.SPLINE=4;d.BEZIER=5;d.HERMITE=6;d.STOPPED=0;d.PLAYING=1;d.PAUSED=2;d.LOADING=3;d.RUNNING=1;d.ZEROS=vec3.create();d.ZEROS4=vec4.create();d.ONES=
vec3.fromValues(1,1,1);d.ONES4=vec4.fromValues(1,1,1,1);d.TOP=vec3.fromValues(0,1,0);d.BOTTOM=vec3.fromValues(0,-1,0);d.RIGHT=vec3.fromValues(1,0,0);d.LEFT=vec3.fromValues(-1,0,0);d.FRONT=vec3.fromValues(0,0,-1);d.BACK=vec3.fromValues(0,0,1);d.IDENTITY=mat4.create();d.QUAT_IDENTITY=quat.create();d.WHITE=d.ONES;d.BLACK=d.ZEROS;d.POSX=1;d.POSY=2;d.POSZ=3;d.NEGX=4;d.NEGY=5;d.NEGZ=6;d.TYPES={BOOLEAN:"boolean",NUMBER:"number",STRING:"string",VEC2:"vec2",VEC3:"vec3",VEC4:"vec4",COLOR:"color",COLOR4:"color4",
EVENT:"event",RESOURCE:"resource",TEXTURE:"texture",MESH:"mesh",OBJECT:"object",SCENE:"scene",NODE:"node",SCENENODE:"node",SCENENODE_ID:"node_id",COMPONENT:"component",COMPONENT_ID:"component_id",MATERIAL:"material",ANIMATION:"animation",ARRAY:"array",QUAT:"quat",TRANS10:"trans10",POSITION:"position"};d.TYPES_INDEX={};var jc=0,Ub;for(Ub in d.TYPES)d.TYPES_INDEX[d.TYPES[Ub]]=jc,d.TYPES_INDEX[d.TYPES[Ub].toUpperCase()]=jc,jc++;d.RESOURCE_TYPES={};d.RESOURCE_TYPES[d.TYPES.RESOURCE]=!0;d.RESOURCE_TYPES[d.TYPES.TEXTURE]=
!0;d.RESOURCE_TYPES[d.TYPES.MESH]=!0;d.RESOURCE_TYPES[d.TYPES.ANIMATION]=!0;var q=d.EVENT={};d.Ray=GL.Ray;d.Network={default_dataType:"arraybuffer",protocol:null,withCredentials:!1,request:function(a){if("string"===typeof a)throw"ONE.Network.request expects object, not string. Use ONE.Network.requestText or ONE.Network.requestJSON";var b=a.url;a.use_proxy&&(b=d.ResourcesManager.getFullURL(b));null===this.protocol&&(this.protocol=d.ResourcesManager.getProtocol(location.href));var c=d.ResourcesManager.getProtocol(b);
"https"==this.protocol&&c&&"https"!=c&&(b="https"+b.substr(b.indexOf(":")));c=a.dataType||this.default_dataType;if("json"==c)c="text";else if("xml"==c)c="text";else if("binary"==c)c="arraybuffer",a.mimeType="application/octet-stream";else if("image"==c)return c=new Image,c.onload=function(){a.success&&a.success.call(this)},c.onerror=a.error,c.src=b,c;var e=new XMLHttpRequest;e.open(a.method||(a.data?"POST":"GET"),b,!0);e.withCredentials=this.withCredentials;void 0!==a.withCredentials&&(e.withCredentials=
a.withCredentials);c&&(e.responseType=c);a.mimeType&&e.overrideMimeType(a.mimeType);a.nocache&&e.setRequestHeader("Cache-Control","no-cache");e.onload=function(c){c=this.response;if(this.status&&200!=this.status)c="Error "+this.status,a.error&&a.error(c);else{if("json"==a.dataType)try{c=JSON.parse(c)}catch(f){a.error&&a.error(f)}else if("xml"==a.dataType)try{c=(new DOMParser).parseFromString(c,"text/xml")}catch(h){a.error&&a.error(h)}else"blob"==a.dataType&&(c.name=d.ResourcesManager.getFilename(b));
if(d.catch_errors)try{a.success&&a.success.call(this,c,a.url),LEvent.trigger(e,"done",c)}catch(k){LEvent.trigger(Xa,"code_error",k)}else a.success&&a.success.call(this,c,a.url),LEvent.trigger(e,"done",c)}};e.onerror=function(b){a.error&&a.error(b);LEvent.trigger(this,"fail",b)};a.uploadProgress&&e.upload.addEventListener("progress",function(b){var c=0;b.lengthComputable&&(c=b.loaded/b.total);a.uploadProgress(b,c)},!1);a.progress&&e.addEventListener("progress",function(b){var c=0;b.lengthComputable&&
(c=b.loaded/b.total);a.progress(b,c)});e.send(a.data);return e},requestText:function(a,b,c,e){"function"==typeof b&&(e=c,c=b);return d.Network.request({url:a,dataType:"text",success:c,error:e})},requestJSON:function(a,b,c,e){"function"==typeof b&&(e=c,c=b,b=null);return d.Network.request({url:a,data:b,dataType:"json",success:c,error:e})},requestFile:function(a,b,c,e,g){"function"==typeof b&&(e=c,c=b,b=null);return d.Network.request({url:a,dataType:g?"blob":"binary",data:b,success:c,error:e})},requestScript:function(a,
b,c,e){function g(a){h--;h?e&&e(this.src,this.num):f()}function f(){d.Network.pending_scripts.length?setTimeout(f,1E3):b&&b()}if(!a)throw"No url";if(d._block_scripts)console.error("Safety: ONE.block_scripts enabled, cannot request script");else{a.constructor===String&&(a=[a]);var h=a.length,k;for(k in a){var l=document.createElement("script");l.num=k;l.type="text/javascript";var m=a[k].trim();"blob:"!=m.substr(0,5)&&(m+="?"+d.RM.getNoCache(!0));l.src=m;l.async=!1;l.charset="UTF-8";l.onload=g;c&&(l.onerror=
function(a){c(a,this.src,this.num)});document.getElementsByTagName("head")[0].appendChild(l)}}},pending_scripts:[],importScript:function(a,b,c){var e=document.createElement("script");e.type="text/javascript";e.src=a;e.async=!1;e.charset="UTF-8";e.onload=function(a){a=d.Network.pending_scripts.indexOf(this);-1!=a&&d.Network.pending_scripts.splice(a);b&&b()};e.onerror=function(a){a=d.Network.pending_scripts.indexOf(this);-1!=a&&d.Network.pending_scripts.splice(a);c&&c()};this.pending_scripts.push(e);
document.getElementsByTagName("head")[0].appendChild(e);return e},requestFont:function(a,b){if(!a||!b)throw"ONE.Network.requestFont: Wrong font name or url";var c=this._loaded_fonts;c||(c=this._loaded_fonts={});if(c[a]!=b){c[a]=b;var e=document.getElementById("ls_fonts");e||(e=document.createElement("style"),e.id="ls_fonts",e.setAttribute("type","text/css"),document.head.appendChild(e));var d="",f;for(f in c)b=c[f],d+='@font-face {\n\tfont-family: "'+f+"\";\n\tsrc: url('"+b+"');\n}\n";e.innerHTML=
d}}};q.MOUSEDOWN="mousedown";q.MOUSEMOVE="mousemove";q.MOUSEUP="mouseup";q.MOUSEWHEEL="mousewheel";q.TOUCHSTART="touchstart";q.TOUCHMOVE="touchmove";q.TOUCHEND="touchend";q.KEYDOWN="keydown";q.KEYUP="keyup";Object.defineProperty(MouseEvent.prototype,"getRay",{value:function(){var a=d.Renderer.getCameraAtPosition(this.mousex,this.mousey,d.Renderer._visible_cameras);return a?a.getRay(this.mousex,this.mousey):null},enumerable:!1});d.Input={mapping:{A_BUTTON:0,B_BUTTON:1,X_BUTTON:2,Y_BUTTON:3,LB_BUTTON:4,
RB_BUTTON:5,BACK_BUTTON:6,START_BUTTON:7,LS_BUTTON:8,RS_BUTTON:9,LX:0,LY:1,RX:2,RY:3,TRIGGERS:4,LEFT_TRIGGER:4,RIGHT_TRIGGER:5,JUMP:0,FIRE:1,LEFT:0,MIDDLE:1,RIGHT:2},LEFT_MOUSE_BUTTON:0,MIDDLE_MOUSE_BUTTON:1,RIGHT_MOUSE_BUTTON:2,BUTTONS_LEFT:1,Keyboard:null,Keyboard_previous:{},Mouse:{},Gamepads:[],last_mouse:null,last_click:null,current_click:null,current_key:null,keys_buffer:[],_last_frame:-1,init:function(){this.Keyboard=gl.keys;this.Mouse=gl.mouse;this.Gamepads=gl.getGamepads()},reset:function(){this.Gamepads=
gl.gamepads=[]},update:function(){for(var a in this.Keyboard_previous)this.Keyboard_previous[a]=!1;for(a in this.Keyboard)this.Keyboard_previous[a]=this.Keyboard[a];this.Mouse.last_buttons=this.Mouse.buttons;this.Gamepads=gl.getGamepads()},isKeyPressed:function(a){return!!this.Keyboard[a]},wasKeyPressed:function(a){return this.Keyboard[a]&&!this.Keyboard_previous[a]},isMouseButtonPressed:function(a){var b=0,b=a&&a.constructor===String?this.mapping[a]:a;return void 0===a?!1:this.Mouse.isButtonPressed(b)},
wasMouseButtonPressed:function(a){var b=0,b=a&&a.constructor===String?this.mapping[a]:a;return void 0===a?!1:this.Mouse.wasButtonPressed(b)},lockMouse:function(a){a?gl.canvas.requestPointerLock():document.exitPointerLock()},isMouseLocked:function(){return!!document.pointerLockElement},onMouse:function(a){this.last_mouse=a;this.isMouseLocked()&&(a.canvasx=a.mousex=0.5*gl.canvas.width|0,a.canvasy=a.mousey=0.5*gl.canvas.height|0);this.Mouse.x=this.Mouse.mousex=a.mousex;this.Mouse.y=this.Mouse.mousey=
a.mousey;this.Mouse.canvasx=a.canvasx;this.Mouse.canvasy=a.canvasy;"mousedown"==a.type?(0==a.button&&(this.last_click=a),this.current_click=a,d.triggerCoroutines("click",a)):"mouseup"==a.type&&(this.current_click=null);return d.GUI.testEventInBlockedArea(a)},onKey:function(a){"keydown"==a.type?(this.current_key=a,d.Renderer._frame!=this._last_frame&&(this.keys_buffer.length=0,d.Renderer._frame=this._last_frame),10>this.keys_buffer.length&&this.keys_buffer.push(a)):this.current_key=null},isMouseInRect:function(a,
b,c,e,d){return this.Mouse.isInsideRect(a,b,c,e,d)},isEventInRect:function(a,b,c){var e=null!=a.mousex?a.mousex:a.x;a=null!=a.mousey?a.mousey:a.y;c&&(e-=c[0],a-=c[1]);return e>=b[0]&&e<b[0]+b[2]&&a>=b[1]&&a<b[1]+b[3]},getAxis:function(a){if("vertical"==a){if(this.isKeyPressed(38)||this.isKeyPressed("W"))return 1;if(this.isKeyPressed(40)||this.isKeyPressed("S"))return-1}else if("horizontal"==a){if(this.isKeyPressed(37)||this.isKeyPressed("A"))return-1;if(this.isKeyPressed(39)||this.isKeyPressed("D"))return 1}var b=
this.Gamepads[0];if(b){if("horizontal"==a)return b.axes[0];if("vertical"==a)return b.axes[1]}return 0},getGamepad:function(a){return this.Gamepads[a||0]},getGamepadAxis:function(a,b,c){a=this.Gamepads[a];if(!a)return 0;var e=0,e=b&&b.constructor===String?this.mapping[b]:b;if(void 0===e)return 0;b=a.axes[e];return!c&&-0.1<b&&0.1>b?0:b},isGamepadButtonPressed:function(a,b){var c=this.Gamepads[a];if(!c)return null;var e=0,e=b&&b.constructor===String?this.mapping[b]:b;return void 0===e?0:(c=c.buttons[e])&&
c.pressed},mouseClick:function(){return new Promise(function(a){d.addWaitingCoroutine(a,"click")})}};var hb={_root:null,_allow_change_cursor:!0,_is_on_top_of_immediate_widget:!1,defaultGUIStyle:{font:"Arial",color:"#FFF",colorTextOver:"#FFF",backgroundColor:"#333",backgroundColorOver:"#AAA",selected:"#AAF",unselected:"#AAA",outline:"#000",margin:0.2},GUIStyle:null,_style_stack:[],_offset:[0,0],_gui_areas:{data:new Float32Array(1024),offset:0},_ctx:null,pressed_enter:!1,getHTMLRoot:function(){if(this._root)return!this._root.parentNode&&
gl.canvas.parentNode&&gl.canvas.parentNode.appendChild(a),this._root;d.GlobalScene._state!=d.PLAYING&&console.warn("GUI element created before the scene is playing will be deleted once the app starts. Only create the GUI elements from onStart or after, otherwise the GUI elements will be lost.");var a=document.createElement("div");a.className="litescene-gui";a.style.position="absolute";a.style.top="0";a.style.left="0";a.style.color="#999";a.style.font="20px Arial";a.style.width="100%";a.style.height=
"100%";a.style.overflow="hidden";a.style.pointerEvents="none";if(!this._style){var b=this._style=document.createElement("style");b.appendChild(document.createTextNode(""));document.head.appendChild(b);b.sheet.insertRule(".litescene-gui button, .litescene-gui input { pointer-events: auto; }",0)}gl.canvas.parentNode.appendChild(a);return this._root=a},createElement:function(a,b){var c=document.createElement(a||"div");c.style.pointerEvents="auto";return this.attach(c,b)},attach:function(a,b){if(a){a.style.position=
"absolute";b=b||"none";switch(b){case "bottom":case "bottom-left":a.style.bottom="0";a.style.left="0";break;case "bottom-right":a.style.bottom="0";a.style.right="0";break;case "bottom-middle":a.style.bottom="0";a.style.width="50%";a.style.margin="0 auto";break;case "right":case "top-right":a.style.top="0";a.style.right="0";break;case "top-middle":a.style.top="0";a.style.width="50%";a.style.margin="0 auto";break;case "left":case "top":case "top-left":a.style.top="0";a.style.left="0";break;case "none":break;
default:console.warn("invalid GUI anchor position: ",b)}this.getHTMLRoot().appendChild(a);return a}console.error("attachToGUI: element cannot be null")},detach:function(a){a&&a.parentNode&&a.parentNode.removeChild(a)},reset:function(){this._root&&(this._root.parentNode&&this._root.parentNode.removeChild(this._root),this._root=null,this._style&&(this._style.parentNode.removeChild(this._style),this._style=null))},showHTML:function(){this._root&&(this._root.style.display="")},hideHTML:function(){this._root&&
(this._root.style.display="none")},loadHTML:function(a,b){d.ResourcesManager.load(a,function(a){var e=d.GUI.getHTMLRoot(),g=a.getAsHTML();g?(g.style.pointerEvents="none",g.style.width="100%",g.style.height="100%",e.appendChild(g),d.GUI.replaceHTMLSources(e),b&&b(g,a)):console.error("html resource is not a string")})},replaceHTMLSources:function(a){a=a.querySelectorAll("*[src]");for(var b=0;b<a.length;++b){var c=a[b],e=c.getAttribute("src");if(e&&"@"==e[0]){var e=e.substr(1),g=d.ResourcesManager.getResource(e),
e=g&&g._local_url?g._local_url:d.ResourcesManager.getFullURL(e);c.setAttribute("src",e)}}},ResetImmediateGUI:function(a){this._is_on_top_of_immediate_widget=!1;this.setCursor(null);this.pressed_enter=!1;this._offset[0]=0;this._offset[1]=0;this._gui_areas.offset=0;this._ctx=gl;this.GUIStyle=this.defaultGUIStyle;this._style_stack.length=0;a||d.GlobalScene.requestFrame()},blockEventArea:function(a){var b=this._gui_areas.data,c=this._gui_areas.offset;c>b.length||(b[c]=a[0]+this._offset[0],b[c+1]=a[1]+
this._offset[1],b[c+2]=a[2],b[c+3]=a[3],this._gui_areas.offset+=4,this._gui_areas.offset>=b.length&&24576>b.length&&(this._gui_areas.data=new Float32Array(2*b.length),this._gui_areas.data.set(b)))},testEventInBlockedArea:function(a){if("mousedown"!=a.type)return!1;for(var b=this._gui_areas.data,c=0;c<this._gui_areas.offset;c+=4)if(a.mousex>=b[c]&&a.mousex<b[c]+b[c+2]&&a.mousey>=b[c+1]&&a.mousey<b[c+1]+b[c+3])return!0;return!1},Box:function(a,b,c,e){if(!a)throw"No area";this.blockEventArea(a);c=c||
0;e=e||c;var d=gl;d.fillStyle=b||"#333";c?(d.beginPath(),d.roundRect(a[0]+this._offset[0],a[1]+this._offset[1],a[2],a[3],c,e),d.fill()):d.fillRect(a[0]+this._offset[0],a[1]+this._offset[1],a[2],a[3])},Label:function(a,b){if(!a)throw"No area";if(null!=b){var c=this._ctx;b.constructor===GL.Texture?(c.constructor===CanvasRenderingContext2D&&(b=!b.data||b.data.constructor!==HTMLImageElement&&b.data.constructor!==Image?null:b.data),b&&c.drawImage(b,a[0]+this._offset[0],a[1]+this._offset[1],a[2],a[3])):
b.constructor===HTMLImageElement||b.constructor===Image?c.constructor===CanvasRenderingContext2D&&c.drawImage(b,a[0]+this._offset[0],a[1]+this._offset[1],a[2],a[3]):(b.constructor===Number?b=b.toFixed(3):b.constructor!==String&&(b=String(b)),c.fillStyle=this.GUIStyle.color,c.font=(0.75*a[3]).toFixed(0)+"px "+this.GUIStyle.font,c.textAlign="left",c.fillText(b,a[0]+0.2*a[3]+this._offset[0],a[1]+0.75*a[3]+this._offset[1]))}},ClickArea:function(a){if(!a)throw"No area";this.blockEventArea(a);d.Input.isEventInRect(d.Input.Mouse,
a,this._offset)&&(this._is_on_top_of_immediate_widget=!0,this.setCursor("pointer"));var b=d.Input.current_click,c=!1;b&&(c=d.Input.isEventInRect(b,a,this._offset))&&(d.Input.current_click=!1);return c},Button:function(a,b,c){if(!a)throw"No area";this.blockEventArea(a);var e=this._ctx,g=d.Input.isEventInRect(d.Input.Mouse,a,this._offset);g&&(this._is_on_top_of_immediate_widget=!0,this.setCursor("pointer"));var f=d.Input.current_click,h=!1;f&&(h=d.Input.isEventInRect(f,a,this._offset))&&(d.Input.current_click=
!1);if(null==b)return h;b.constructor===String&&(e.fillStyle=h?"#FFF":g?this.GUIStyle.backgroundColorOver:this.GUIStyle.backgroundColor,e.fillRect(a[0]+this._offset[0],a[1]+this._offset[1],a[2],a[3]));b.constructor===GL.Texture?(g&&c&&c.constructor===GL.Texture&&(b=c),e.drawImage(b,a[0]+this._offset[0],a[1]+this._offset[0],a[2],a[3])):b.constructor===String&&(e.fillStyle=g?this.GUIStyle.colorTextOver:this.GUIStyle.color,e.font=(0.75*a[3]).toFixed(0)+"px "+this.GUIStyle.font,e.textAlign="center",e.fillText(b,
a[0]+0.5*a[2]+this._offset[0],a[1]+0.75*a[3]+this._offset[1]),e.textAlign="left");return h},Toolbar:function(a,b,c){if(!a)throw"No area";if(!c||c.constructor!==Array)throw"No options";this.blockEventArea(a);var e=this._ctx;d.Input.isEventInRect(d.Input.Mouse,a,this._offset)&&(this._is_on_top_of_immediate_widget=!0,this.setCursor("pointer"));var g=d.Input.current_click,f=c.length,h=a[0],k=a[2];a[2]=k/f;for(var l=0;l<f;++l){var m=c[l],p=b==l,n=!1;a[0]=h+a[2]*l;g&&(n=d.Input.isEventInRect(g,a,this._offset))&&
(b=l,p=!0,d.Input.current_click=!1);m&&m.constructor!==String||(e.fillStyle=p?this.GUIStyle.backgroundColorOver:this.GUIStyle.backgroundColor,e.fillRect(a[0]+this._offset[0],a[1]+this._offset[1],a[2],a[3]));m&&(m.constructor===GL.Texture?(p||(e.globalAlpha=0.5),e.drawImage(m,a[0]+this._offset[0],a[1]+this._offset[1],a[2],a[3]),e.globalAlpha=1):m.constructor===String&&(e.fillStyle=this.GUIStyle.color,e.font=(0.75*a[3]).toFixed(0)+"px "+this.GUIStyle.font,e.textAlign="center",e.fillText(m,a[0]+0.5*
a[2]+this._offset[0],a[1]+0.75*a[3]+this._offset[1]),e.textAlign="left"))}a[0]=h;a[2]=k;return b},Toggle:function(a,b,c,e,g){if(!a)throw"No area";b=!!b;this.blockEventArea(a);var f=this._ctx;d.Input.isEventInRect(d.Input.Mouse,a,this._offset)&&(this._is_on_top_of_immediate_widget=!0,this.setCursor("pointer"));var h=d.Input.current_click,k=!1;h&&(k=d.Input.isEventInRect(h,a,this._offset))&&(d.Input.current_click=!1);h=0.2*a[3];if(c)if(c.constructor===GL.Texture)g=c,!b&&e&&e.constructor===GL.Texture&&
(g=e),f.drawImage(g,a[0]+this._offset[0],a[1]+this._offset[1],a[2],a[3]);else if(c.constructor===String){f.fillStyle=this.GUIStyle.color;f.font=(0.75*a[3]).toFixed(0)+"px "+this.GUIStyle.font;f.textAlign="left";f.fillText(c,a[0]+h+this._offset[0],a[1]+0.75*a[3]+this._offset[1]);e=0.6*a[3];f.fillStyle=this.GUIStyle.backgroundColor;c=a[0]+a[2]-1.5*h-e+this._offset[0];var l=a[1]+0.5*h+this._offset[1];g?f.fillCircle(c,l,a[3]-h):f.fillRect(c,l,e+h,a[3]-h);f.fillStyle=b?this.GUIStyle.selected:"#000";g?
f.fillCircle(a[0]+a[2]-h-e+this._offset[0],a[1]+h+this._offset[1],a[3]-2*h):f.fillRect(a[0]+a[2]-h-e+this._offset[0],a[1]+h+this._offset[1],e,a[3]-2*h)}return k?!b:b},TextField:function(a,b,c,e,g,f){if(!a)throw"No area";this.blockEventArea(a);b=void 0===b?"":String(b);c=c||1024;var h=this._ctx;d.Input.isEventInRect(d.Input.Mouse,a,this._offset)&&(this._is_on_top_of_immediate_widget=!0,this.setCursor("pointer"));var k=d.Input.current_click,l=!1;k&&(l=d.Input.isEventInRect(k,a,this._offset))&&(d.Input.current_click=
null,d.Input.last_click=k);k=!1;d.Input.last_click&&d.Input.isEventInRect(d.Input.last_click,a,this._offset)&&(k=!0);this.pressed_enter=!1;if(k){for(var m=d.Input.keys_buffer,l=0;l<m.length;++l){var p=m[l];switch(p.keyCode){case 8:b=b.substr(0,b.length-1);break;case 13:this.pressed_enter=!0;f||(d.Input.last_click=null);g&&(p=g(b),null!=p&&(b=p));break;case 32:b.length<c&&(b+=" ");break;default:b.length<c&&p.key&&1==p.key.length&&(b+=p.key)}}m.length=0;d.Input.current_key=null}l=0.02*a[3];c=0.2*a[3];
h.fillStyle=this.GUIStyle.backgroundColor;h.fillRect(a[0]+this._offset[0],a[1]+this._offset[1],a[2],a[3]);h.fillStyle="#000";h.fillRect(a[0]+l+this._offset[0],a[1]+l+this._offset[1],a[2]-2*l,a[3]-2*l);h.fillStyle=this.GUIStyle.color;h.font=(0.75*a[3]).toFixed(0)+"px "+this.GUIStyle.font;h.textAlign="left";g="";k&&0==(0.002*getTime()|0)%2&&(g="|");k=b;if(e)for(k="",l=0;l<b.length;++l)k+="*";h.fillText(k+g,a[0]+2*c+this._offset[0],a[1]+0.75*a[3]+this._offset[1]);return b},isTextFieldSelected:function(a){return d.Input.last_click&&
d.Input.isEventInRect(d.Input.last_click,a,this._offset)},HorizontalSlider:function(a,b,c,e,g){if(!a)throw"No area";this.blockEventArea(a);void 0===c&&(c=0);void 0===e&&(e=1);b=Number(b);c=Number(c);e=Number(e);var f=this._ctx,h=d.Input.isEventInRect(d.Input.Mouse,a,this._offset);h&&(this._is_on_top_of_immediate_widget=!0,this.setCursor("pointer"));var k=d.Input.current_click,l=!1;e-=c;var m=(b-c)/e;0>m&&(m=0);1<m&&(m=1);var p=a[3]*this.GUIStyle.margin;k&&(l=d.Input.isEventInRect(k,a,this._offset))&&
(m=(d.Input.Mouse.x-this._offset[0]-(a[0]+p))/(a[2]-2*p),0>m&&(m=0),1<m&&(m=1),b=m*e+c);f.fillStyle=this.GUIStyle.backgroundColor;f.fillRect(a[0]+this._offset[0],a[1]+this._offset[1],a[2],a[3]);f.fillStyle=h?this.GUIStyle.selected:this.GUIStyle.unselected;f.fillRect(a[0]+p+this._offset[0],a[1]+p+this._offset[1],Math.max(2,(a[2]-2*p)*m),a[3]-2*p);g&&(f.textAlign="center",f.fillStyle=this.GUIStyle.color,f.font=(0.5*a[3]).toFixed(0)+"px "+this.GUIStyle.font,f.fillText(b.toFixed(2),a[0]+0.5*a[2]+this._offset[0],
a[1]+0.7*a[3]+this._offset[1]),f.textAlign="left");return b},VerticalSlider:function(a,b,c,e){if(!a)throw"No area";this.blockEventArea(a);b=Number(b);void 0===c&&(c=0);void 0===e&&(e=1);c=Number(c);e=Number(e);var g=this._ctx,f=d.Input.isEventInRect(d.Input.Mouse,a,this._offset);f&&(this._is_on_top_of_immediate_widget=!0,this.setCursor("pointer"));var h=d.Input.current_click,k=!1,l=e-c,m=(b-c)/l;0>m&&(m=0);1<m&&(m=1);e=a[2]*this.GUIStyle.margin;h&&(k=d.Input.isEventInRect(h,a,this._offset))&&(m=(d.Input.Mouse.y-
this._offset[1]-(a[1]+e))/(a[3]-2*e),0>m&&(m=0),1<m&&(m=1),m=1-m,b=m*l+c);g.fillStyle=this.GUIStyle.backgroundColor;g.fillRect(a[0]+this._offset[0],a[1]+this._offset[1],a[2],a[3]);g.fillStyle=f?this.GUIStyle.selected:this.GUIStyle.unselected;c=Math.max(2,(a[3]-2*e)*m);g.fillRect(a[0]+e+this._offset[0],a[1]+a[3]-c-e+this._offset[1],a[2]-2*e,c);return b},Knob:function(a,b,c,e,g,f){if(!a)throw"No area";this.blockEventArea(a);b=Number(b);void 0===c&&(c=0);void 0===e&&(e=1);g=g||0;c=Number(c);e=Number(e);
var h=this._ctx,k=d.Input.isEventInRect(d.Input.Mouse,a,this._offset);k&&(this._is_on_top_of_immediate_widget=!0,this.setCursor("pointer"));var l=d.Input.current_click,m=!1,p=e-c;e=(b-c)/p;0>e&&(e=0);1<e&&(e=1);var n=0.75*-Math.PI,r=1.5*Math.PI;l&&(m=d.Input.isEventInRect(l,a,this._offset))&&(e=(Math.atan2(d.Input.Mouse.x-(a[0]+0.5*a[2])-this._offset[0],-(d.Input.Mouse.y-(a[1]+0.5*a[3])-this._offset[1]))-n)/r,0>e&&(e=0),1<e&&(e=1),b=e*p+c);g&&(e=Math.round(e*g)/g);void 0!==f?null!==f&&(c=null,f.constructor===
GL.Texture?(h.constructor===CanvasRenderingContext2D&&(f=!f.data||f.data.constructor!==HTMLImageElement&&f.data.constructor!==Image?null:f.data),f&&(c=f)):f.constructor!==HTMLImageElement&&f.constructor!==Image||h.constructor!==CanvasRenderingContext2D||(c=f),c&&(h.save(),h.translate(a[0]+0.5*a[2]+this._offset[0],a[1]+0.5*a[3]+this._offset[1]),h.rotate(e*r+n),h.scale(a[3]/c.height,a[3]/c.height),h.drawImage(c,0.5*-c.width,0.5*-c.height),h.restore())):(h.strokeStyle=this.GUIStyle.outline,h.fillStyle=
this.GUIStyle.backgroundColor,h.beginPath(),h.arc(a[0]+0.5*a[2]+this._offset[0],a[1]+0.5*a[3]+this._offset[1],0.45*a[3],0,2*Math.PI,!1),h.fill(),h.stroke(),h.lineWidth=0.1*a[3],h.strokeStyle=k?this.GUIStyle.selected:this.GUIStyle.unselected,h.beginPath(),n=1.25*-Math.PI,h.arc(a[0]+0.5*a[2]+this._offset[0],a[1]+0.5*a[3]+this._offset[1],0.35*a[3],n,n+Math.max(DEG2RAD,r*e),!1),h.stroke(),h.lineWidth=1);return b},Pad:function(a,b,c){this.DragArea(a,b);var e=this._ctx;!c||c.constructor!==GL.Texture&&c.constructor!==
HTMLImageElement&&c.constructor!==HTMLCanvasElement?(e.globalAlpha=1,e.fillStyle=this.GUIStyle.backgroundColor,e.fillRect(a[0]-2,a[1]-2,a[2]+4,a[3]+4),e.fillStyle="black",e.fillRect(a[0],a[1],a[2],a[3])):e.drawImage(c,a[0],a[1],a[2],a[3]);e.fillStyle="white";e.globalAlpha=1;c=a[0]+b[0]*a[2];a=a[1]+b[1]*a[3];e.beginPath();e.arc(c,a,5,0,2*Math.PI,!1);e.fill()},DragArea:function(a,b,c){if(!a)throw"No area";if(!b)throw"No value";this.blockEventArea(a);d.Input.isEventInRect(d.Input.Mouse,a,this._offset)&&
(this._is_on_top_of_immediate_widget=!0,this.setCursor("pointer"));var e=d.Input.current_click,g=!1;e&&(g=d.Input.isEventInRect(e,a,this._offset))&&(d.Input.current_click=null,d.Input.last_click=e);d.Input.last_click&&d.Input.isEventInRect(d.Input.last_click,a,this._offset)&&d.Input.Mouse.dragging&&(c?(b[0]+=d.Input.Mouse.deltax||0,b[1]+=d.Input.Mouse.deltay||0):(c=(d.Input.Mouse.y-a[1])/a[3],b[0]=Math.clamp((d.Input.Mouse.x-a[0])/a[2],0,1),b[1]=Math.clamp(c,0,1)));return b},pushStyle:function(){var a=
d.cloneObject(this.GUIStyle);this._style_stack.push(this.GUIStyle);this.GUIStyle=a},popStyle:function(){this._style_stack.length&&(this.GUIStyle=this._style_stack.pop())},setCursor:function(a){this._allow_change_cursor&&(gl.canvas.style.cursor=a||"")}};Object.defineProperty(hb,"GUIOffset",{set:function(a){!a.length||2>a.length||(this._offset[0]=a[0],this._offset[1]=a[1])},get:function(){return this._offset},enumerable:!0});hb.show=hb.showHTML;hb.hide=hb.hideHTML;hb.load=hb.loadHTML;hb.getRoot=function(){console.warn("ONE.GUI.getRoot() deprecated, use ONE.GUI.getHTMLRoot() instead.");
return d.GUI.getHTMLRoot()};d.GUI=hb;var zc={path:"",proxy:"",ignore_cache:!1,free_data:!1,keep_files:!1,keep_urls:!1,allow_base_files:!1,scene_external_repository:null,resources:{},meshes:{},textures:{},materials:{},materials_by_uid:{},resources_not_found:{},resources_being_loaded:{},resources_being_processed:{},resources_renamed_recently:{},num_resources_being_loaded:0,MAX_TEXTURE_SIZE:4096,resource_pre_callbacks:{},resource_post_callbacks:{},resource_once_callbacks:{},virtual_file_systems:{},skip_proxy_extensions:["mp3",
"wav","ogg","mp4","webm"],force_nocache_extensions:["js","glsl","json"],nocache_files:{},valid_resource_name_reg:/^[A-Za-z\d\s\/\_\-\.]+$/,getNoCache:function(a){return this.ignore_cache||a?"nocache="+getTime()+Math.floor(1E3*Math.random()):""},reset:function(){this.resources={};this.meshes={};this.textures={};this.materials={};this.materials_by_uid={};this.scene_external_repository=null},registerResourcePreProcessor:function(a,b,c,e){if(a){a=a.split(",");for(var d in a)c=a[d].toLowerCase(),this.resource_pre_callbacks[c]=
b}},registerResourcePostProcessor:function(a,b){this.resource_post_callbacks[a]=b},getExtension:function(a,b){if(!a)return"";var c=a.indexOf("?");-1!=c&&(a=a.substr(0,c));c=b?a.indexOf("."):a.lastIndexOf(".");return-1==c?"":a.substr(c+1).toLowerCase().trim()},removeExtension:function(a,b){if(!a)return"";var c=a.indexOf("?");-1!=c&&(a=a.substr(0,c));c=b?a.indexOf("."):a.lastIndexOf(".");return-1==c?a:a.substr(0,c)},replaceExtension:function(a,b){if(!a)return"";b=b||"";var c=this.getFolder(a),e=this.getFilename(a);
return this.cleanFullpath((c?c+"/":"")+e+"."+b)},getFilename:function(a){if(!a)return"";var b=a.lastIndexOf("/"),c=a.lastIndexOf("?"),c=(-1==c?a.length:c-1)-b;return a.substr(b+1,c)},getFolder:function(a){if(!a)return"";var b=a.lastIndexOf("/");return a.substr(0,b)},getBasename:function(a){if(!a)return"";a=this.getFilename(a);var b=a.indexOf(".");return-1==b?a:a.substr(0,b)},getProtocol:function(a){if(!a)return"";var b=a.substr(0,10).indexOf(":"),c="";-1!=b&&(c=a.substr(0,b));return c},cleanFullpath:function(a){return a?
-1==a.indexOf("//")?47==a.charCodeAt(0)?a.substr(1):a:-1==a.indexOf("://")?a.split("/").filter(function(a){return!!a}).join("/"):a:""},loadResources:function(a,b){if(a){if(a.constructor===Array)for(var c=0;c<a.length;++c){var e=a[c];e&&":"!=e[0]&&"_"!=e[0]&&this.load(e,b)}else for(c in a)c&&":"!=c[0]&&"_"!=c[0]&&this.load(c,b);this._total_resources_to_load=this.num_resources_being_loaded;LEvent.trigger(this,"start_loading_resources",this._total_resources_to_load);this._total_resources_to_load||LEvent.trigger(this,
"end_loading_resources");return this._total_resources_to_load}},setPath:function(a){this.path=a},setProxy:function(a){a?(-1!=a.indexOf("@")?this.proxy=location.protocol+"//"+a.replace("@",window.location.host):this.proxy=a,"undefined"!==typeof LiteGraph&&(LiteGraph.proxy=this.proxy)):this.proxy=null},getFullURL:function(a,b){if(!a)return null;var c=a.substr(0,10).indexOf(":"),e="";-1!=c&&(e=a.substr(0,c));var d=this.path;this.scene_external_repository&&(d=this.scene_external_repository);b&&b.force_local_url&&
(d=".");b&&b.external_repository&&(d=b.external_repository);if(e)switch(e){case "http":case "https":return c=this.getExtension(a).toLowerCase(),d=a.substr(0,a.indexOf("/",e.length+3)),d=d.substr(e.length+3),this.proxy&&d!=location.host&&-1==this.skip_proxy_extensions.indexOf(c)&&(!b||b&&!b.ignore_proxy)?this.proxy+a:a;case "blob":return a;case "":return a;default:return":"==a[0]||"_"==a[0]?a:(this.virtual_file_systems[e]||d)+"/"+a.substr(c+1)}else return d+"/"+a},registerFileSystem:function(a,b){this.virtual_file_systems[a]=
b},getResource:function(a,b){if(!a)return null;a=this.cleanFullpath(a);if(!b)return this.resources[a];var c=this.resources[a];return c&&c.constructor===b?c:null},getResourceType:function(a){return a?a.object_class?a.object_class:a.constructor.resource_type?a.constructor.resource_type:d.getObjectClassName(a):null},getResourcesData:function(a,b){if(a.constructor!==Array)return console.error("getResourcesData expects Array"),null;for(var c={},e=0;e<a.length;++e){var g=a[e],f=d.ResourcesManager.resources[g];
if(f){var h=null;if(h=f._original_data?f._original_data:d.Resource.getDataToStore(f).data){if(h.constructor===Blob||h.constructor===File){if(!(b||h.data&&h.data.constructor===ArrayBuffer)){console.warn("Not support to store File or Blob, please, use ArrayBuffer");continue}h=h.data}c[g]=h}else console.warn("Wrong data in resource")}}return c},createResource:function(a,b,c){var e=null,e=this.getExtension(a),g=null;e&&(g=d.Formats.supported[e]);g&&g.resourceClass?e=new g.resourceClass:(e=this.resources[a])&&
e.constructor===d.Resource?(delete e._original_data,delete e._original_file,e._modified=!1):e=new d.Resource;if(b)if(e.setData)e.setData(b,!0);else if(e.fromData)e.fromData(b);else throw"Resource without setData, cannot assign";c&&d.ResourcesManager.registerResource(a,e);return e},resourceModified:function(a){if(a)if(a.constructor===String)console.warn("resourceModified parameter must be a resource, not a string");else{delete a._original_data;delete a._original_file;a._version=(a._version||0)+1;a.remotepath&&
(a._modified=!0);LEvent.trigger(this,"resource_modified",a);if(a.from_pack&&a.from_pack.constructor===String){var b=d.ResourcesManager.getResource(a.from_pack);b&&this.resourceModified(b)}a.from_prefab&&a.from_prefab.constructor===String&&(a=d.ResourcesManager.getResource(a.from_prefab))&&this.resourceModified(a)}},resourceSaved:function(a){a&&(delete a._modified,a.remotepath=a.fullpath,LEvent.trigger(this,"resource_saved",a))},load:function(a,b,c,e,g){if(!a)return console.error("ONE.ResourcesManager.load requires url");
b&&b.constructor===Function&&!c&&(c=b,b=null);var f=this.resources[a];if(null!=f&&!(f.is_preview||b&&b.force||e))return c&&c(f,a),!0;b=b||{};e=this.getExtension(a);if(!e&&!this.resources[a])return console.warn("Cannot load a file without extension: "+a),!1;if(!this.resources_not_found[a])if(this.resources_being_loaded[a])c&&this.resources_being_loaded[a].push({options:b,callback:c});else if(!this.resources_being_processed[a]){if(this.allow_base_files||-1!=a.indexOf("/")){this.resources_being_loaded[a]=
[{options:b,callback:c}];LEvent.trigger(d.ResourcesManager,"resource_loading",a);this.num_resources_being_loaded++;f=this.getFullURL(a);(c=d.Formats.getFileFormatInfo(e))&&c.has_preview&&!b.is_preview&&LEvent.trigger(this,"load_resource_preview",a);f={url:f,success:function(c){d.ResourcesManager.processResource(a,c,b,d.ResourcesManager._resourceLoadedEnd,!0)},error:function(b){d.ResourcesManager._resourceLoadedError(a,b);g&&g(a)},progress:function(b){var c=0;b.total&&(c=b.loaded/b.total);LEvent.hasBind(d.ResourcesManager,
"resource_loading_progress")&&LEvent.trigger(d.ResourcesManager,"resource_loading_progress",{url:a,event:b,progress:c});LEvent.hasBind(d.ResourcesManager,"loading_resources_progress")&&LEvent.trigger(d.ResourcesManager,"loading_resources_progress",1-(d.ResourcesManager.num_resources_being_loaded-c)/d.ResourcesManager._total_resources_to_load)}};f.nocache=this.ignore_cache||-1!=this.force_nocache_extensions.indexOf[e]||this.nocache_files[a];if(c=d.Formats.supported[e])c.dataType&&(f.dataType=c.dataType),
c.mimeType&&(f.mimeType=c.mimeType),c["native"]&&(f.dataType=null);d.Network.request(f);return!1}this._parsing_local_file||console.warn("Cannot load resource, filename has no folder and ONE.ResourcesManager.allow_base_files is set to false: ",a)}},processResource:function(a,b,c,e,g){if((c=c||{})&&c.constructor!==Object)throw"processResource options must be object";if(null===b||void 0===b)throw"No data found when processing resource: "+a;var f=null,f=this.getExtension(a),h=null;f&&(h=d.Formats.supported[f]);
var k=function(a,c,f){if(c){var k=d.ResourcesManager.getExtension(a);k&&(h=d.Formats.supported[k]);h&&h.convert_to&&k!=h.convert_to&&(a+="."+h.convert_to,c.filename+="."+h.convert_to,c.fullpath&&(c.fullpath+="."+h.convert_to),f.filename&&(f.filename+="."+h.convert_to));d.ResourcesManager.processFinalResource(a,c,f,e,g);!d.ResourcesManager.keep_files||b.constructor!=ArrayBuffer&&b.constructor!=String||c._original_data||c._original_file||k!=d.ResourcesManager.getExtension(c.filename)||(c._original_data=
b)}else d.ResourcesManager._resourceLoadedEnd(a,null)};this.resources_being_processed[a]=!0;if(!f)return this.processDataResource(a,b,c,k);if(f=this.resource_pre_callbacks[f.toLowerCase()])f=f(a,b,c,k),!0!==f&&(f?k(a,f,c):(console.warn("resource preprocessor_callback returned null"),this._resourceLoadedError(a,"Resource couldn't be processed")));else if(h&&(h.type||h.parse)){f=null;switch(h.type){case "scene":f=d.ResourcesManager.processScene(a,b,c,k);break;case "mesh":f=d.ResourcesManager.processTextMesh(a,
b,c,k);break;case "texture":case "image":f=d.ResourcesManager.processImage(a,b,c,k);break;default:h.parse?(f=h.parse(b))&&k(a,f,c):console.warn("Format Info without parse function")}f&&!0!==f&&k(a,f,c)}else if(h&&h.resourceClass)f=new h.resourceClass,f.fromData?f.fromData(b):f.configure?f.configure(JSON.parse(b)):console.error("Resource Class doesnt have a function to process data after loading: ",h.resourceClass.name),f&&!0!==f&&k(a,f,c);else if(f=d.ResourcesManager.createResource(a,b))f.filename=
f.fullpath=a,k(a,f,c)},processFinalResource:function(a,b,c,e,g){if(!b||b.constructor===String)return d.ResourcesManager._resourceLoadedError(a,"error processing the resource");b.filename=a;c.filename&&(b.filename=c.filename);c.is_local?a=b.fullpath=b.filename:b.fullpath=a;c.from_prefab&&(b.from_prefab=c.from_prefab);c.from_pack&&(b.from_pack=c.from_pack);g&&(b.remotepath=a);c.is_preview&&(b.is_preview=!0);d.ResourcesManager.resources_being_processed[a]&&delete d.ResourcesManager.resources_being_processed[a];
b.getResources&&d.ResourcesManager.loadResources(b.getResources({}));d.ResourcesManager.registerResource(a,b);c.preview_of&&d.ResourcesManager.registerResource(c.preview_of,b);e&&e(a,b,c)},registerResource:function(a,b){if(!a||!b)throw"registerResource missing filename or resource";":"!=a[0]&&!1==this.valid_resource_name_reg.test(a)&&"http"!=a.substr(0,4)&&console.warn("invalid filename for resource: ",a);a=this.cleanFullpath(a);if(!(this.resources[a]===b||b.is_preview&&this.resources[a])){b.filename=
a;b.object_class||(b.object_class=d.getObjectClassName(b));var c=b.object_class;b.constructor.resource_type&&(c=b.constructor.resource_type);this.resources[a]=b;(c=this.resource_post_callbacks[c])&&c(a,b);b.is_preview||LEvent.trigger(this,"resource_registered",b);d.GlobalScene.requestFrame()}},unregisterResource:function(a){var b=this.resources[a];if(!b)return!1;delete this.resources[a];this.meshes[a]&&delete this.meshes[a];this.textures[a]&&delete this.textures[a];this.materials[a]&&delete this.materials[a];
b.constructor!==d.Pack&&b.constructor!==d.Prefab||b.setResourcesLink(null);LEvent.trigger(this,"resource_unregistered",b);d.GlobalScene.requestFrame();return!0},getURLasFile:function(a,b){var c=new XMLHttpRequest;c.open("GET",this.getFullURL(a),!0);c.responseType="blob";c.onload=function(e){e=c.response;b&&b(e,a)};c.send()},renameResource:function(a,b,c){var e=this.resources[a];if(!e)return!1;this.resources[b]&&console.warn("There is a resource already with this name, overwritting it: "+b);e.filename=
b;e.fullpath&&(e.fullpath=b);this.resources[b]=e;delete this.resources[a];c||d.GlobalScene.sendResourceRenamedEvent(a,b,e);for(var g in this.resources){var f=this.resources[g];f!=e&&f.onResourceRenamed&&f.onResourceRenamed(a,b,e)&&this.resourceModified(f)}this.meshes[a]&&(delete this.meshes[a],this.meshes[b]=e);this.textures[a]&&(delete this.textures[a],this.textures[b]=e);this.materials[a]&&(delete this.materials[a],this.materials[b]=e);this.resources_renamed_recently[a]=b;c||LEvent.trigger(d.ResourcesManager,
"resource_renamed",[a,b,e]);return!0},isLoading:function(a){return a?this.resources_being_loaded[a]||this.resources_being_processed[a]?!0:!1:0<this.num_resources_being_loaded},clearNotFoundResources:function(){this.resources_not_found={}},computeImageMetadata:function(a){return{width:a.width,height:a.height}},getMesh:function(a){return a?a.constructor===String?this.meshes[a]:a.constructor===GL.Mesh?a:null:null},getTexture:function(a){return a?a.constructor===String?this.textures[a]:a.constructor===
GL.Texture?a:null:null},getMaterial:function(a){if(a)return"@"==a[0]?this.materials_by_uid[a]:this.materials[a]},convertFilenameToLocator:function(a){return"@RES-"+a.replace(/\//gi,"\\")},convertLocatorToFilename:function(a){return a.substr(5).replace(/\\/gi,"/")},onceLoaded:function(a,b){var c=this.resource_once_callbacks[a];if(!c)this.resource_once_callbacks[a]=[b];else if(-1==c.indexOf(b))return c.push(b),c.length-1},cancelOnceLoaded:function(a,b){var c=this.resource_once_callbacks[a];c&&(c[b]=
null)},_resourceLoadedEnd:function(a,b){d.ResourcesManager.debug&&console.log("RES: "+a+" ---\x3e "+d.ResourcesManager.num_resources_being_loaded);if(b){var c=d.ResourcesManager.resources_being_loaded[a];if(c)for(var e=0;e<c.length;++e)null!=c[e].callback&&c[e].callback(b,a);if(c=d.ResourcesManager.resource_once_callbacks[a]){for(e=0;e<c.length;++e)if(c[e])c[e](a,b);delete d.ResourcesManager.resource_once_callbacks[a]}}d.ResourcesManager.resources_being_loaded[a]&&(delete d.ResourcesManager.resources_being_loaded[a],
d.ResourcesManager.num_resources_being_loaded--,b?LEvent.trigger(d.ResourcesManager,"resource_loaded",a):LEvent.trigger(d.ResourcesManager,"resource_problem_loading",a),LEvent.trigger(d.ResourcesManager,"loading_resources_progress",1-d.ResourcesManager.num_resources_being_loaded/d.ResourcesManager._total_resources_to_load),0==d.ResourcesManager.num_resources_being_loaded&&(LEvent.trigger(d.ResourcesManager,"end_loading_resources",!0),d.ResourcesManager._total_resources_to_load=0));d.GlobalScene.requestFrame()},
_resourceLoadedError:function(a,b){console.log("Error loading "+a);delete d.ResourcesManager.resources_being_loaded[a];delete d.ResourcesManager.resource_once_callbacks[a];d.ResourcesManager.resources_not_found[a]=!0;LEvent.trigger(d.ResourcesManager,"resource_not_found",a);d.ResourcesManager.num_resources_being_loaded--;0==d.ResourcesManager.num_resources_being_loaded&&LEvent.trigger(d.ResourcesManager,"end_loading_resources",!1)}};d.RM=d.ResourcesManager=zc;d.getTexture=function(a){return d.ResourcesManager.getTexture(a)};
d.ResourcesManager.registerResourcePreProcessor("wbin",function(a,b,c){if(b.constructor===Object&&b.object_class){if(d.Classes[b.object_class]){if((c=d.Classes[b.object_class]||window[b.object_class])&&c.fromBinary)return c.fromBinary(b,a);c&&c.prototype.fromBinary&&(b=new c,b.fromBinary(object,a))}return b}return WBin.load(b,!1,a)},"binary");d.ResourcesManager.registerResourcePreProcessor("json",function(a,b,c){c=b;if(b.constructor===String)try{b=JSON.parse(b)}catch(e){return console.error("invalid JSON"),
null}c=b.object_class||b.object_type;!c&&b.material_class&&(c=b.material_class);if(!c){var g=d.ResourcesManager.getExtension(a,!0);(g=d.ResourceClasses_by_extension[g])&&(c=d.getClassName(g))}if(c&&!b.is_data)if(g=d.Classes[c]||window[c])g.prototype.configure?(c=new g,c.configure(b)):c=new g(b);else return console.error("JSON object_class class not found: "+c),null;else c=new d.Resource,c.filename=a,c._data=b,c.type="json",c.category="json";return c});d.ResourcesManager.registerResourcePreProcessor("zip",
function(a,b,c){if(!ba.JSZip)throw"JSZip not found. To use ZIPs you must have the JSZip.js library included in the website.";(new JSZip).loadAsync(b).then(function(a){a.forEach(function(a,b){if(!b.dir){var e=d.ResourcesManager.getExtension(a),e=d.Formats.supported[e];b.async(e&&"text"==e.dataType?"string":"arraybuffer").then(function(b){"scene.json"!=a||c&&c.to_memory?d.ResourcesManager.processResource(a,b):d.GlobalScene.configure(JSON.parse(b))})}})});return!0},"binary");d.ResourcesManager.processDataResource=
function(a,b,c,e){b.constructor===String&&(b=JSON.parse(b));if(b.constructor==ArrayBuffer){if(!b.byteLength)return console.warn("Empty WBin?"),null;f=WBin.load(b);e&&e(a,f,c);return f}var g=b.object_class;if(g&&d.Classes[g]){var f=null;d.Classes[g].prototype.configure?(f=new d.Classes[g],f.configure(b)):f=new d.Classes[g](b);e&&e(a,f,c);return f}console.warn("Resource Class name unknown: "+g);return!1};d.ResourcesManager.processImage=function(a,b,c,e){function g(g){g&&d.ResourcesManager.keep_files&&
(g._original_data=b);k&&(d.ResourcesManager.keep_urls?g._local_url=k:URL.revokeObjectURL(k));e&&e(a,g,c)}var f=d.ResourcesManager.getExtension(a),h="application/octet-stream";if("jpg"==f||"jpeg"==f)h="image/jpg";else if("webp"==f)h="image/webp";else if("gif"==f)h="image/gif";else if("png"==f)h="image/png";else if(f=d.Formats.supported[f],f.mimetype)h=f.mimetype;else{f=this.processImageNonNative(a,b,c);g(f);return}var f=new Blob([b],{type:h}),k=URL.createObjectURL(f),f=new Image;f.src=k;f.real_filename=
a;f.onload=function(){var a=d.ResourcesManager.processTexture(this.real_filename,this,c);g(a)};f.onerror=function(b){URL.revokeObjectURL(k);e&&e(a,null,c);console.error("Error while loading image, file is not native image format: "+a)};return!0};d.ResourcesManager.processImageNonNative=function(a,b,c){b=(new Uint8Array(b)).buffer;c=d.Formats.parse(a,b,c);return c?c.constructor==GL.Texture?(c.filename=a,c._original_data=b,c):c=d.ResourcesManager.processTexture(a,c):(console.error("Cannot parse image format"),
null)};d.ResourcesManager.processTexture=function(a,b,c){if(b.width==b.height/6||-1!=a.indexOf("CUBECROSS"))c={wrapS:gl.MIRROR,wrapT:gl.MIRROR,magFilter:gl.LINEAR,minFilter:gl.LINEAR_MIPMAP_LINEAR},-1!=a.indexOf("CUBECROSSL")&&(c.is_cross=1),c=GL.Texture.cubemapFromImage(b,c);else{c=gl.LINEAR;var e=gl.REPEAT,d=gl.LINEAR_MIPMAP_LINEAR;isPowerOfTwo(b.width)&&isPowerOfTwo(b.height)||(d=gl.LINEAR,e=gl.CLAMP_TO_EDGE);c=b.pixels?GL.Texture.fromMemory(b.width,b.height,b.pixels,{format:24==b.bpp?gl.RGB:gl.RGBA,
no_flip:b.flipY,wrapS:e,wrapT:e,magFilter:c,minFilter:d}):GL.Texture.fromImage(b,{format:gl.RGBA,wrapS:e,wrapT:e,magFilter:c,minFilter:d})}if(c)return c.img=b,c.filename=a,c.generateMetadata(),c};d.ResourcesManager.processTextMesh=function(a,b,c){b=d.Formats.parse(a,b,c);return null==b?(console.error("Error parsing mesh: "+a),null):GL.Mesh.load(b)};d.ResourcesManager.processScene=function(a,b,c){b=d.Formats.parse(a,b,c);if(null==b)return console.error("Error parsing scene: "+a),null;if(b&&b.constructor===
d.Scene)throw"processScene must receive object, no Scene";if(!b.root)throw"this is not an scene, root property missing";d.ResourcesManager._parsing_local_file=!0;for(var e in b.meshes)d.ResourcesManager.processResource(e,b.meshes[e]);for(e in b.resources)d.ResourcesManager.processResource(e,b.resources[e]);for(e in b.materials)d.ResourcesManager.processResource(e,b.materials[e]);a=new d.SceneNode;a.configure(b.root);c&&c.filename&&"json"!=d.RM.getExtension(c.filename)&&(c.filename+=".json");d.ResourcesManager._parsing_local_file=
!1;return a};d.ResourcesManager.loadTextureAtlas=function(a,b,c){var e=new Image;e.src=this.getFullURL(a.filename);e.onload=function(){var e=a.thumbnail_size,f=document.createElement("canvas");f.width=e;f.height=e;var e=f.getContext("2d"),h;for(h in a.textures){var k=a.textures[h];e.clearRect(0,0,f.width,f.height);e.drawImage(this,-k.pos[0],-k.pos[1]);var l=GL.Texture.fromImage(f,{format:GL.RGBA,magFilter:gl.LINEAR,minFilter:gl.LINEAR_MIPMAP_LINEAR,wrap:gl.REPEAT});c||(l.is_preview=!0);d.ResourcesManager.registerResource(k.name,
l)}d.GlobalScene.requestFrame();b&&b()}};d.ResourcesManager.registerResourcePostProcessor("Mesh",function(a,b){b.object_class="Mesh";b.metadata&&(b.metadata={},b.generateMetadata());if(!b.bounding||b.bounding.length!=BBox.data_length||b.info&&b.info.groups&&b.info.groups.length&&!b.info.groups[0].bounding)b.bounding=null,b.updateBoundingBox();b.getBuffer("normals")||b.computeNormals();d.ResourcesManager.free_data&&b.freeData();d.ResourcesManager.meshes[a]=b});d.ResourcesManager.registerResourcePostProcessor("Texture",
function(a,b){d.ResourcesManager.textures[a]=b});d.ResourcesManager.registerResourcePostProcessor("Material",function(a,b){d.ResourcesManager.materials[a]=b;d.ResourcesManager.materials_by_uid[b.uid]=b;b.prepare&&b.prepare(d.GlobalScene)});d.ResourcesManager.registerResourcePostProcessor("Pack",function(a,b){b.flagResources()});d.ResourcesManager.registerResourcePostProcessor("Prefab",function(a,b){b.applyToNodes()});d.ResourcesManager.registerResourcePostProcessor("ShaderCode",function(a,b){b.applyToMaterials()});
GL.Mesh.load_priority=-10;var Kc={snippets:{},shader_blocks_by_id:new Map,shader_blocks:[],num_shaderblocks:0,global_extra_shader_code:"",dump_compile_errors:!0,on_compile_error:null,init:function(a,b){var c=[];c.push(["STANDARD_DERIVATIVES","OES_standard_derivatives","#extension GL_OES_standard_derivatives : enable"]);c.push(["DRAW_BUFFERS","WEBGL_draw_buffers"]);this.global_extra_shader_code=String.fromCharCode(10)+"#define WEBGL_VERSION "+gl.webgl_version+"\n";for(var e in c){var d=c[e];if(2==
gl.webgl_version||gl.extensions[d[1]])this.global_extra_shader_code+="#define "+d[0]+"\n",1==gl.webgl_version&&d[2]&&(this.global_extra_shader_code+=d[2]+"\n")}},reloadShaders:function(a){},compile:function(a,b,c){if(!c)throw"compileShader must have a name specified";if(!gl)return null;var e=null;try{a=this.global_extra_shader_code+a;b=this.global_extra_shader_code+b;var d=this.compiled_shaders[c+":VS"];d||(d=this.compiled_shaders[c+":VS"]=GL.Shader.compileSource(gl.VERTEX_SHADER,a));var f=this.compiled_shaders[c+
":FS"];f||(f=this.compiled_shaders[c+":FS"]=GL.Shader.compileSource(gl.FRAGMENT_SHADER,b));var h=getTime(),e=new GL.Shader(d,f);this.debug&&console.log("Shader compile time: ",(getTime()-h).toFixed(3),"ms");e.name=c}catch(k){this.dump_compile_errors&&(this.dumpShaderError(c,k,a,b),this.dump_compile_errors=!1);if(this.on_compile_error)this.on_compile_error(k);return null}return e},clearShaderCodeCache:function(){var a=[],b=d.StandardMaterial.shader_codes,c;for(c in b)a.push(b[c]);b=d.ResourcesManager.resources;
for(c in b)b[c].constructor===d.ShaderCode&&a.push(b[c]);for(c in a)a[c].clearCache()},dumpShaderError:function(a,b,c,e){console.error("Error compiling shader: "+a);console.log(b);console.groupCollapsed("Vertex Shader Code");a=c.split("\n");for(var d in a)console.log(d+": "+a[d]);console.groupEnd();console.groupCollapsed("Fragment Shader Code");a=e.split("\n");for(d in a)console.log(d+": "+a[d]);console.groupEnd()},registerSnippet:function(a,b){this.snippets[a]={id:a,code:b}},getSnippet:function(a){return this.snippets[a]},
registerShaderBlock:function(a,b,c){var e=-1;!c&&this.shader_blocks_by_id.get(a)?(console.warn("There is already a ShaderBlock with that name, replacing it: ",a),e=this.shader_blocks_by_id.get(a).flag_id,this.clearShaderCodeCache()):e=this.num_shaderblocks++;64<=e&&console.warn("Too many shaderblocks registered, not enought bits in a 64bits variable");b.flag_id=e;b.flag_mask=1<<e;this.shader_blocks_by_id.set(a,b);this.shader_blocks[e]=b},getShaderBlock:function(a){return a.constructor===String?this.shader_blocks_by_id.get(a):
this.shader_blocks[a]},common_vscode:"\n\t\tprecision mediump float;\n\t\tattribute vec3 a_vertex;\n\t\tattribute vec3 a_normal;\n\t\tattribute vec2 a_coord;\n\t\tuniform mat4 u_model;\n\t\tuniform mat4 u_viewprojection;\n\t",common_fscode:"\n\t\tprecision mediump float;\n\t"};d.Shaders=Kc;ub.prototype.defineContextMacros=function(a){this.context_macros=a};ub.prototype.addCode=function(a,b,c,e){c=c||"";b={enabled:new d.GLSLCode(b||""),disabled:new d.GLSLCode(c),macros:e};this.code_map.set(a,b)};ub.prototype.bindEvent=
function(a,b){this.events||(this.events={});this.events[a]=b};ub.prototype.getFinalCode=function(a,b,c){b=b||0;var e=this.code_map.get(a);if(!e)return null;a=(b&this.flag_mask?e.enabled:e.disabled).getFinalCode(a,b,c);if(e.macros){b="";for(var d in e.macros)b+="#define "+d+e.macros[d]+"\n";a=b+a}return a};ub.prototype.register=function(a){d.Shaders.registerShaderBlock(this.name,this,a)};ub.prototype.checkDependencies=function(a){};d.ShaderBlock=ub;d.GLSLCode=ia;ia.pragma_methods={};ia.types_conversor=
{number:"float",texture:"sampler2D",textureCube:"samplerCube"};ia.CODE=1;ia.PRAGMA=2;ia.INCLUDE=1;ia.SHADERBLOCK=2;ia.SNIPPET=3;ia.EVENT=4;ia.prototype.parse=function(){var a=this.code.replace(/(\/\*([\s\S]*?)\*\/)|(\/\/(.*)$)/gm,"");this.fragments=[];this.pragmas={};this.uniforms={};this.streams={};this.includes={};this.snippets={};this.shader_blocks={};this.is_dynamic=!1;for(var b=[],a=a.split("\n"),c=0;c<a.length;c++){var e=a[c].trim();if(e.length)if("#"!=e[0]){var g=e.split(" ");if("uniform"==
g[0]){var f=g[2].split(";");this.uniforms[f[0]]=g[1]}else"attribute"==g[0]&&(f=g[2].split(";"),this.attributes[f[0]]=g[1]);b.push(e)}else if(g=e.split(" "),"#pragma"==g[0]){f=b.join("\n");f.trim()&&this.fragments.push({type:ia.CODE,code:f});this.is_dynamic=!0;this.pragmas[g[2]]=!0;f=g[1];b.length=0;var e={type:ia.PRAGMA,line:e,action:f,param:g[2]},h=d.GLSLCode.pragma_methods[f];h&&h.parse?!1!==h.parse.call(this,e,g)&&this.fragments.push(e):console.warn("#pragma action unknown: ",f)}else b.push(e)}b.length&&
(f=b.join("\n"),f.trim()&&this.fragments.push({type:ia.CODE,code:f}));return!0};ia.prototype.getFinalCode=function(a,b,c){if(!this.is_dynamic)return this.code;var e="";c=c||{};for(var d=this.fragments,f=0;f<d.length;++f){var h=d[f];if(h.type===ia.CODE)e+=h.code;else{var k=ia.pragma_methods[h.action];k&&k.getCode?(h=k.getCode.call(this,a,h,b,c))&&(e+=h):e+="\n"}}return e};ia.pragma_methods.include={parse:function(a,b){if(!b[2])return console.error("shader include without path"),!1;a.action_type=ia.INCLUDE;
var c=b[2].substr(1,b[2].length-2).split(":"),e=c[1];a.include=c[0];a.include_subfile=e;this.includes[a.include]=!0},getCode:function(a,b,c,e){a="";a=b.include;if(d.ResourcesManager.getExtension(a)){c=d.ResourcesManager.getResource(a,d.ShaderCode);if(!c)return d.ResourcesManager.load(a),null;if(b.include_subfile){b=c._subfiles[b.include_subfile];if(void 0===b)return null;a="\n"+b+"\n"}else a="\n"+c._subfiles[""]+"\n"}else{b=d.Shaders.getSnippet(a);if(!b)return null;a="\n"+b.code+"\n"}return a}};ia.pragma_methods.define=
{parse:function(a,b){var c=b[2],e=b[3];if(!c||!e)return console.error("#pragma define missing parameters"),!1;a.define=[c,e.substr(1,e.length-2)]},getCode:function(a,b,c,e){e[b.define[0]]=b.define[1]}};ia.pragma_methods.shaderblock={parse:function(a,b){if(!b[2])return console.error("#pragma shaderblock without name"),!1;a.action_type=ia.SHADERBLOCK;var c=b[2];'"'==c[0]?(a.shader_block=[1,c.substr(1,c.length-2)],this.shader_blocks[a.shader_block[1]]=!0):(a.shader_block=[2,c],b[3]&&(a.shader_block.push(b[3].substr(1,
b[3].length-2)),this.shader_blocks[a.shader_block[2]]=!0))},getCode:function(a,b,c,e){var g=b.shader_block[1];if(2==b.shader_block[0]&&(g=e[g]?e[g]:b.shader_block[2],!g))return console.error("ShaderBlock: no context var found: "+g),null;g=d.Shaders.getShaderBlock(g);if(!g)return null;b="\n";g.flag_mask&c&&(b="\n#define BLOCK_"+g.name.toUpperCase()+"\n");(a=g.getFinalCode(a,c,e))&&(b+=a+"\n");return b}};ia.pragma_methods.snippet={parse:function(a,b){if(!b[2])return console.error("#pragma snippet without name"),
!1;a.action_type=ia.SNIPPET;var c=b[2].substr(1,b[2].length-2);a.snippet=c;this.snippets[c]=!0},getCode:function(a,b,c,e){a=d.Shaders.getSnippet(b.snippet);return a?"\n"+a.code+"\n":(console.error("ShaderCode uses unknown Snippet: ",b.snippet),null)}};ia.pragma_methods.event={parse:function(a,b){if(!b[2])return console.error("#pragma event without name"),!1;a.action_type=ia.EVENT;var c=b[2].substr(1,b[2].length-2);a.event=c},getCode:function(a,b,c,e){a="\n";e=0;for(var g=d.Shaders.shader_blocks.length;e<
g;++e){var f=d.Shaders.shader_blocks[e];c&f.flag_mask&&f.events&&(f=f.events[b.event])&&(a+=f+"\n")}return a}};ia.breakLines=function(a){for(var b=[],c=0;c<a.length;c++){var e=a[c].trim();if(e){var d=e.lastIndexOf(";");if(-1==d||d==a.length-1)b.push(e);else for(e=e.split(";"),d=0;d<e.length;++d)e[d]&&b.push(e[d]+";")}}return b};d.Shaders.registerSnippet("input","\n\t\t\t#ifndef SNIPPET_INPUT\n\t\t\t#define SNIPPET_INPUT\n\t\t\t//used to store topology input information\n\t\t\tstruct Input {\n\t\t\t\tvec4 color;\n\t\t\t\tvec3 vertex;\n\t\t\t\tvec3 normal;\n\t\t\t\tvec2 uv;\n\t\t\t\tvec2 uv1;\n\t\t\t\t\n\t\t\t\tvec3 camPos;\n\t\t\t\tfloat camDist;\n\t\t\t\tvec3 viewDir;\n\t\t\t\tvec3 worldPos;\n\t\t\t\tvec3 worldNormal;\n\t\t\t\tvec4 screenPos;\n\t\t\t};\n\t\t\t\n\t\t\tInput getInput()\n\t\t\t{\n\t\t\t\tInput IN;\n\t\t\t\tIN.color = vec4(1.0);\n\t\t\t\tIN.vertex = v_pos;\n\t\t\t\tIN.normal = v_normal;\n\t\t\t\tIN.uv = v_uvs;\n\t\t\t\tIN.uv1 = IN.uv;\n\t\t\t\t\n\t\t\t\tIN.camPos = u_camera_eye;\n\t\t\t\tIN.viewDir = u_camera_eye - v_pos;\n\t\t\t\tIN.camDist = length(IN.viewDir);\n\t\t\t\tIN.viewDir /= IN.camDist;\n\t\t\t\tIN.worldPos = v_pos;\n\t\t\t\tIN.worldNormal = normalize(v_normal);\n\t\t\t\tIN.screenPos = vec4( (v_screenpos.xy / v_screenpos.w) * 0.5 + vec2(0.5), v_screenpos.zw );  //sometimes we need also z and w, thats why we pass all\n\t\t\t\t//IN.screenPos = vec4( (gl_FragCoord.xy / gl_FragCoord.w) * 0.5 + vec2(0.5), gl_FragCoord.zw );  //sometimes we need also z and w, thats why we pass all\n\t\t\t\treturn IN;\n\t\t\t}\n\t\t\t#endif\n\t");
d.Shaders.registerSnippet("structs","\n\t\t\t//used to store topology input information\n\t\t\tstruct Input {\n\t\t\t\tvec4 color;\n\t\t\t\tvec3 vertex;\n\t\t\t\tvec3 normal;\n\t\t\t\tvec2 uv;\n\t\t\t\tvec2 uv1;\n\t\t\t\t\n\t\t\t\tvec3 camPos;\n\t\t\t\tvec3 viewDir;\n\t\t\t\tfloat camDist;\n\t\t\t\tvec3 worldPos;\n\t\t\t\tvec3 worldNormal;\n\t\t\t\tvec4 screenPos;\n\t\t\t};\n\t\t\t\n\t\t\t//used to store surface shading properties\n\t\t\tstruct SurfaceOutput {\n\t\t\t\tvec3 Albedo;\n\t\t\t\tvec3 Normal; //separated in case there is a normal map\n\t\t\t\tvec3 Emission;\n\t\t\t\tvec3 Ambient;\n\t\t\t\tfloat Specular;\n\t\t\t\tfloat Gloss;\n\t\t\t\tfloat Alpha;\n\t\t\t\tfloat Reflectivity;\n\t\t\t\tvec4 Extra; //for special purposes\n\t\t\t};\n\t\t\t\n\t\t\t//used to store light contribution\n\t\t\t//CAREFUL: this one is different than \n\t\t\tstruct FinalLight {\n\t\t\t\tvec3 Color;\n\t\t\t\tvec3 Ambient;\n\t\t\t\tfloat Diffuse; //NdotL\n\t\t\t\tfloat Specular; //RdotL\n\t\t\t\tvec3 Emission;\n\t\t\t\tvec3 Reflection;\n\t\t\t\tfloat Attenuation;\n\t\t\t\tfloat Shadow; //1.0 means fully lit\n\t\t\t};\n\t");
d.Shaders.registerSnippet("spotFalloff","\n\t\t\tfloat spotFalloff(vec3 spotDir, vec3 lightDir, float angle_phi, float angle_theta)\n\t\t\t{\n\t\t\t\tfloat sqlen = dot(lightDir,lightDir);\n\t\t\t\tfloat atten = 1.0;\n\t\t\t\t\n\t\t\t\tvec4 spotParams = vec4( angle_phi, angle_theta, 1.0, 0.0 );\n\t\t\t\tspotParams.w = 1.0 / (spotParams.x-spotParams.y);\n\t\t\t\t\n\t\t\t\tvec3 dirUnit = lightDir * sqrt(sqlen); //we asume they are normalized\n\t\t\t\tfloat spotDot = dot(spotDir, -dirUnit);\n\t\t\t\tif (spotDot <= spotParams.y)// spotDot <= cos phi/2\n\t\t\t\t\treturn 0.0;\n\t\t\t\telse if (spotDot > spotParams.x) // spotDot > cos theta/2\n\t\t\t\t\treturn 1.0;\n\t\t\t\t\n\t\t\t\t// vertex lies somewhere beyond the two regions\n\t\t\t\tfloat ifallof = pow( (spotDot-spotParams.y)*spotParams.w,spotParams.z );\n\t\t\t\treturn ifallof;\n\t\t\t}\n\t");
d.Shaders.registerSnippet("getFlatNormal","\n\t\t\t#ifdef STANDARD_DERIVATIVES\n\t\t\t\tvec3 getFlatNormal(vec3 pos)\n\t\t\t\t{\n\t\t\t\t\tvec3 A = dFdx( pos );\n\t\t\t\t\tvec3 B = dFdy( pos );\n\t\t\t\t\treturn normalize( cross(A,B) );\n\t\t\t\t}\n\t\t\t#else\n\t\t\t\tvec3 getFlatNormal(vec3 pos)\n\t\t\t\t{\n\t\t\t\t\treturn vec3(0.0);\n\t\t\t\t}\n\t\t\t#endif\n\t");d.Shaders.registerSnippet("PackDepth32","\n\t\t\t\n\t\t\tfloat linearDepth(float z, float near, float far)\n\t\t\t{\n\t\t\t\treturn (z - near) / (far - near);\n\t\t\t}\n\t\t\tfloat linearDepthNormalized(float z, float near, float far)\n\t\t\t{\n\t\t\t\tfloat z_n = 2.0 * z - 1.0;\n\t\t\t\treturn 2.0 * near * far / (far + near - z_n * (far - near));\n\t\t\t}\n\t\t\t\n\t\t\t//packs depth normalized \n\t\t\tvec4 PackDepth32(float depth)\n\t\t\t{\n\t\t\t  const vec4 bitShift = vec4( 256.0 * 256.0 * 256.0, 256.0 * 256.0, 256.0, 1.0 );\n\t\t\t  const vec4 bitMask = vec4( 0.0, 1.0 / 256.0, 1.0 / 256.0, 1.0 / 256.0 );\n\t\t\t  vec4 comp = fract(depth * bitShift);\n\t\t\t  comp -= comp.xxyz * bitMask;\n\t\t\t  return comp;\n\t\t\t}\n");
d.Shaders.registerSnippet("perturbNormal","\n\t\t\t\tmat3 cotangent_frame(vec3 N, vec3 p, vec2 uv)\n\t\t\t\t{\n\t\t\t\t\t// get edge vectors of the pixel triangle\n\t\t\t\t\t#ifdef STANDARD_DERIVATIVES\n\t\t\t\t\t\n\t\t\t\t\tvec3 dp1 = dFdx( p );\n\t\t\t\t\tvec3 dp2 = dFdy( p );\n\t\t\t\t\tvec2 duv1 = dFdx( uv );\n\t\t\t\t\tvec2 duv2 = dFdy( uv );\n\t\t\t\t\t\n\t\t\t\t\t// solve the linear system\n\t\t\t\t\tvec3 dp2perp = cross( dp2, N );\n\t\t\t\t\tvec3 dp1perp = cross( N, dp1 );\n\t\t\t\t\tvec3 T = dp2perp * duv1.x + dp1perp * duv2.x;\n\t\t\t\t\tvec3 B = dp2perp * duv1.y + dp1perp * duv2.y;\n\t\t\t\t\t#else\n\t\t\t\t\tvec3 T = vec3(1.0,0.0,0.0); //this is wrong but its a fake solution\n\t\t\t\t\tvec3 B = cross(N,T);\n\t\t\t\t\tT = cross(B,N);\n\t\t\t\t\t#endif\n\t\t\t\t\t \n\t\t\t\t\t// construct a scale-invariant frame \n\t\t\t\t\tfloat invmax = inversesqrt( max( dot(T,T), dot(B,B) ) );\n\t\t\t\t\treturn mat3( T * invmax, B * invmax, N );\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\tvec3 perturbNormal( vec3 N, vec3 V, vec2 texcoord, vec3 normal_pixel )\n\t\t\t\t{\n\t\t\t\t\t#ifdef USE_POINTS\n\t\t\t\t\t\treturn N;\n\t\t\t\t\t#endif\n\t\t\t\t\t\n\t\t\t\t\t// assume N, the interpolated vertex normal and \n\t\t\t\t\t// V, the view vector (vertex to eye)\n\t\t\t\t\t//vec3 normal_pixel = texture2D(normalmap, texcoord ).xyz;\n\t\t\t\t\tnormal_pixel = normal_pixel * 255./127. - 128./127.;\n\t\t\t\t\tmat3 TBN = cotangent_frame(N, V, texcoord);\n\t\t\t\t\treturn normalize(TBN * normal_pixel);\n\t\t\t\t}\n\t\t");
d.Shaders.registerSnippet("bumpNormal","\n\t\t\t\t\n\t\t\t\t// Calculate the surface normal using screen-space partial derivatives of the height field\n\t\t\t\tvec3 bumpNormal(vec3 position, vec3 normal, sampler2D texture, vec2 uvs, float factor)\n\t\t\t\t{\n\t\t\t\t#ifdef STANDARD_DERIVATIVES\n\t\t\t        vec3 dpdx = dFdx(position);\n\t\t\t        vec3 dpdy = dFdy(position);\n\t\t\t\t\tvec3 r1 = cross(dpdy, normal);\n\t\t\t\t\tvec3 r2 = cross(normal, dpdx);\n\t\t\t\t\t\n\t\t\t\t\tvec2 dtdx = dFdx(uvs) * factor;\n\t\t\t\t\tvec2 dtdy = dFdy(uvs) * factor;\n\t\t\t\t\t\n\t\t\t        float h = texture2D( texture,  uvs ).r;\n\t\t\t        float hdx = texture2D( texture,  uvs + dtdx ).r;\n\t\t\t        float hdy = texture2D( texture,  uvs + dtdy ).r;\n\t\t\t\t\t\n\t\t\t\t\treturn normalize(normal + (r1 * (hdx - h) - r2 * (hdy - h)) / dot(dpdx, r1));\n\t\t\t\t#else\n\t\t\t\t\treturn normal;\n\t\t\t\t#endif\n\t\t\t\t}\n\t\t");
d.Shaders.registerSnippet("testClippingPlane","\n\t\t\tfloat testClippingPlane(vec4 plane, vec3 p)\n\t\t\t{\n\t\t\t\tif(plane.x == 0.0 && plane.y == 0.0 && plane.z == 0.0)\n\t\t\t\t\treturn 0.0;\n\t\t\t\treturn (dot(plane.xyz, p) - plane.w) / dot(plane.xyz,plane.xyz);\n\t\t\t}\n\t");d.Shaders.registerSnippet("computePointSize","\n\t\t\tfloat computePointSize(float radius, float w)\n\t\t\t{\n\t\t\t\tif(radius < 0.0)\n\t\t\t\t\treturn -radius;\n\t\t\t\treturn u_viewport.w * u_camera_perspective.z * radius / w;\n\t\t\t}\n\t");
d.Shaders.registerSnippet("vec3ToCubemap2D","\n\tvec2 vec3ToCubemap2D( vec3 v )\n\t{\n\t\tvec3 abs_ = abs(v);\n\t\tfloat max_ = max(max(abs_.x, abs_.y), abs_.z); // Get the largest component\n\t\tvec3 weights = step(max_, abs_); // 1.0 for the largest component, 0.0 for the others\n\t\tfloat sign_ = dot(weights, sign(v)) * 0.5 + 0.5; // 0 or 1\n\t\tfloat sc = dot(weights, mix(vec3(v.z, v.x, -v.x), vec3(-v.z, v.x, v.x), sign_));\n\t    float tc = dot(weights, mix(vec3(-v.y, -v.z, -v.y), vec3(-v.y, v.z, -v.y), sign_));\n\t    vec2 uv = (vec2(sc, tc) / max_) * 0.5 + 0.5;\n\t\t// Offset into the right region of the texture\n\t\tfloat offsetY = dot(weights, vec3(1.0, 3.0, 5.0)) - sign_;\n\t\tuv.y = (uv.y + offsetY) / 6.0;\n\t\treturn uv;\n\t}\n");
var Ac=d.Shaders.firstpass_block=new d.ShaderBlock("firstPass");Ac.addCode(GL.FRAGMENT_SHADER,"","");Ac.register();var Bc=d.Shaders.lastpass_block=new d.ShaderBlock("lastPass");Bc.addCode(GL.FRAGMENT_SHADER,"","");Bc.register();(d.Shaders.vertex_color_block=new d.ShaderBlock("vertex_color")).register();(d.Shaders.coord1_block=new d.ShaderBlock("coord1")).register();var Cc=d.Shaders.extra2_block=new d.ShaderBlock("extra2");Cc.bindEvent("vs_attributes","attribute vec2 a_extra2;\n");Cc.register();var Dc=
d.Shaders.extra3_block=new d.ShaderBlock("extra3");Dc.bindEvent("vs_attributes","attribute vec3 a_extra3;\n");Dc.register();var Ec=d.Shaders.extra4_block=new d.ShaderBlock("extra4");Ec.bindEvent("vs_attributes","attribute vec4 a_extra4;\n");Ec.register();var Fc=d.Shaders.normalbuffer_block=new d.ShaderBlock("normalBuffer");Fc.addCode(GL.FRAGMENT_SHADER,"","");Fc.register();(d.Shaders.instancing_block=new d.ShaderBlock("instancing")).register();var Ib=new d.ShaderBlock("pointparticles");Ib.bindEvent("vs_final",
"\n\tgl_PointSize = u_point_size * u_viewport.w * u_camera_perspective.z / gl_Position.w;\n\t#ifdef EXTRA2_BLOCK\n\t\tgl_PointSize *= a_extra2.x;\n\t#endif\n");Ib.register();d.Shaders.registerSnippet("snoise","\n//\tSimplex 3D Noise \n//\tby Ian McEwan, Ashima Arts\nvec4 permute(vec4 x){return mod(((x*34.0)+1.0)*x, 289.0);}\nvec4 taylorInvSqrt(vec4 r){return 1.79284291400159 - 0.85373472095314 * r;}\nfloat snoise(vec3 v){ \n  const vec2  C = vec2(1.0/6.0, 1.0/3.0) ;\n  const vec4  D = vec4(0.0, 0.5, 1.0, 2.0);\n// First corner\n  vec3 i  = floor(v + dot(v, C.yyy) );\n  vec3 x0 =   v - i + dot(i, C.xxx) ;\n// Other corners\n  vec3 g = step(x0.yzx, x0.xyz);\n  vec3 l = 1.0 - g;\n  vec3 i1 = min( g.xyz, l.zxy );\n  vec3 i2 = max( g.xyz, l.zxy );\n  //  x0 = x0 - 0. + 0.0 * C \n  vec3 x1 = x0 - i1 + 1.0 * C.xxx;\n  vec3 x2 = x0 - i2 + 2.0 * C.xxx;\n  vec3 x3 = x0 - 1. + 3.0 * C.xxx;\n// Permutations\n  i = mod(i, 289.0 ); \n  vec4 p = permute( permute( permute( \n             i.z + vec4(0.0, i1.z, i2.z, 1.0 ))\n           + i.y + vec4(0.0, i1.y, i2.y, 1.0 )) \n           + i.x + vec4(0.0, i1.x, i2.x, 1.0 ));\n// Gradients\n// ( N*N points uniformly over a square, mapped onto an octahedron.)\n  float n_ = 1.0/7.0; // N=7\n  vec3  ns = n_ * D.wyz - D.xzx;\n  vec4 j = p - 49.0 * floor(p * ns.z *ns.z);  //  mod(p,N*N)\n  vec4 x_ = floor(j * ns.z);\n  vec4 y_ = floor(j - 7.0 * x_ );    // mod(j,N)\n  vec4 x = x_ *ns.x + ns.yyyy;\n  vec4 y = y_ *ns.x + ns.yyyy;\n  vec4 h = 1.0 - abs(x) - abs(y);\n  vec4 b0 = vec4( x.xy, y.xy );\n  vec4 b1 = vec4( x.zw, y.zw );\n  vec4 s0 = floor(b0)*2.0 + 1.0;\n  vec4 s1 = floor(b1)*2.0 + 1.0;\n  vec4 sh = -step(h, vec4(0.0));\n  vec4 a0 = b0.xzyw + s0.xzyw*sh.xxyy ;\n  vec4 a1 = b1.xzyw + s1.xzyw*sh.zzww ;\n  vec3 p0 = vec3(a0.xy,h.x);\n  vec3 p1 = vec3(a0.zw,h.y);\n  vec3 p2 = vec3(a1.xy,h.z);\n  vec3 p3 = vec3(a1.zw,h.w);\n//Normalise gradients\n  vec4 norm = taylorInvSqrt(vec4(dot(p0,p0), dot(p1,p1), dot(p2, p2), dot(p3,p3)));\n  p0 *= norm.x;\n  p1 *= norm.y;\n  p2 *= norm.z;\n  p3 *= norm.w;\n// Mix final noise value\n  vec4 m = max(0.6 - vec4(dot(x0,x0), dot(x1,x1), dot(x2,x2), dot(x3,x3)), 0.0);\n  m = m * m;\n  return 42.0 * dot( m*m, vec4( dot(p0,x0), dot(p1,x1), \n                                dot(p2,x2), dot(p3,x3) ) );\n}");
d.Formats={supported:{},safe_parsing:!1,merge_smoothgroups:!1,addSupportedFormat:function(a,b){a.constructor===String&&(a=a.split(","));for(var c=0;c<a.length;++c){var e=a[c].toLowerCase();this.supported[e]&&console.warn("There is already another parser associated to this extension: "+e);this.supported[e]=b}},parse:function(a,b,c){c=c||{};var e=this.getFileFormatInfo(a);if(!e)return null;e.extension=c.extension?c.extension:d.ResourcesManager.getExtension(a);var g=this.supported[e.extension];if(!g||
!g.parse)return console.error("Parser Error: No parser found for "+e.extension+" format"),null;e=null;if(this.safe_parsing)try{e=g.parse(b,c,a)}catch(f){return console.error("Error parsing content",f),null}else e=g.parse(b,c,a);e&&(e.name=a);return e},TEXT_FORMAT:"text",JSON_FORMAT:"json",XML_FORMAT:"xml",BINARY_FORMAT:"binary",MESH_DATA:"MESH",IMAGE_DATA:"IMAGE",NONATIVE_IMAGE_DATA:"NONATIVE_IMAGE",SCENE_DATA:"SCENE",GENERIC_DATA:"GENERIC",getFileFormatInfo:function(a){a=a.substr(a.lastIndexOf(".")+
1).toLowerCase();return this.supported[a]},guessType:function(a){if(!a)return null;a=d.RM.getExtension(a).toLowerCase();return(a=this.supported[a])?a.resource:null},convertToDataURL:function(a){var b=document.createElement("canvas");b.width=a.width;b.height=a.height;var c=b.getContext("2d"),e=c.createImageData(a.width,a.height);if(3==a.bytesPerPixel)for(var d=0;d<b.width;++d)for(var f=0;f<b.height;++f){var h=f*b.width*4+4*d,k=(b.height-f-1)*b.width*3+3*d;e.data[h+2]=a.pixels[k];e.data[h+1]=a.pixels[k+
1];e.data[h+0]=a.pixels[k+2];e.data[h+3]=255}else for(d=0;d<b.width;++d)for(f=0;f<b.height;++f)h=f*b.width*4+4*d,k=(b.height-f-1)*b.width*4+4*d,e.data[h+0]=a.pixels[k+2],e.data[h+1]=a.pixels[k+1],e.data[h+2]=a.pixels[k+0],e.data[h+3]=a.pixels[k+3];c.putImageData(e,0,0);a.dataurl=b.toDataURL("image/png");return a.dataurl},computeMeshBounding:function(a){for(var b=[a[0],a[1],a[2]],c=[a[0],a[1],a[2]],e=0;e<a.length;e+=3){var d=[a[e],a[e+1],a[e+2]];d[0]<b[0]?b[0]=d[0]:d[0]>c[0]&&(c[0]=d[0]);d[1]<b[1]?
b[1]=d[1]:d[1]>c[1]&&(c[1]=d[1]);d[2]<b[2]?b[2]=d[2]:d[2]>c[2]&&(c[2]=d[2])}a=[0.5*(b[0]+c[0]),0.5*(b[1]+c[1]),0.5*(b[2]+c[2])];b=[b[0]-a[0],b[1]-a[1],b[2]-a[2]];return BBox.setCenterHalfsize(BBox.create(),a,b)}};d.Formats.addSupportedFormat("png,jpg,jpeg,webp,bmp,gif",{"native":!0,dataType:"arraybuffer",resource:"Texture",resourceClass:GL.Texture,has_preview:!0,type:"image"});d.Formats.addSupportedFormat("wbin",{dataType:"arraybuffer"});d.Formats.addSupportedFormat("json",{dataType:"text"});d.Formats.addSupportedFormat("js",
{dataType:"text"});d.Formats.addSupportedFormat("txt,html,css,csv",{dataType:"text"});d.Formats.addSupportedFormat("glsl",{dataType:"text",resource:"ShaderCode",resourceClass:d.ShaderCode});d.Formats.addSupportedFormat("zip",{dataType:"arraybuffer"});WBin.classes=d.Classes;d.Formats.addSupportedFormat("mesh",{extension:"mesh",type:"mesh",resource:"Mesh",format:"text",dataType:"text",parse:function(a,b){b=b||{};var c=(0,GL.Mesh.parsers.mesh)(a,b);(0==c.bounding.radius||isNaN(c.bounding.radius))&&console.log("no radius found in mesh");
return c}});GL.Mesh.prototype.convertBoneNames=function(a,b){if(!this.bones||!this.bones.length)return 0;a=a||d.GlobalScene;a.constructor==d.Scene&&(a=a.root);if(!a.findNode)return console.error("convertBoneNames first parameter must be node or scene"),0;for(var c=!1,e=0;e<this.bones.length;++e){var g=this.bones[e],f=g[0];if(b)f[0]!=d._uid_prefix&&((h=a.findNode(f))?(g[0]=h.uid,c=!0):console.warn("Bone node not found: "+f));else if(f[0]==d._uid_prefix){var h=a.findNode(f);h?(g[0]=h.name,c=!0):console.warn("Bone node not found: "+
f)}}c&&d.RM.resourceModified(this)};B["@color"]={type:"color"};B.icon="mini-icon-material.png";B.last_index=0;B.NO_LIGHTS=0;B.ONE_LIGHT=1;B.SEVERAL_LIGHTS=2;B.EXTENSION="json";B.COLOR="color";B.OPACITY="opacity";B.SPECULAR_FACTOR="specular_factor";B.SPECULAR_GLOSS="specular_gloss";B.OPACITY_TEXTURE="opacity";B.COLOR_TEXTURE="color";B.AMBIENT_TEXTURE="ambient";B.SPECULAR_TEXTURE="specular";B.EMISSIVE_TEXTURE="emissive";B.ENVIRONMENT_TEXTURE="environment";B.IRRADIANCE_TEXTURE="irradiance";B.COORDS_UV0=
0;B.COORDS_UV1=1;B.COORDS_UV0_TRANSFORMED=2;B.COORDS_UV1_TRANSFORMED=3;B.COORDS_UV_POINTCOORD=4;B.TEXTURE_COORDINATES={uv0:B.COORDS_UV0,uv1:B.COORDS_UV1,uv0_transformed:B.COORDS_UV0_TRANSFORMED,uv1_transformed:B.COORDS_UV1_TRANSFORMED,uv_pointcoord:B.COORDS_UV_POINTCOORD};B.available_shaders="default global lowglobal phong_texture flat normal phong flat_texture cell_outline".split(" ");B.prototype.fillUniforms=function(a,b){var c={},e=[];c.u_material_color=this._color;c.u_ambient_color=a.info?a.info.ambient_color:
d.ONES;c.u_texture_matrix=this.uvs_matrix;c.u_specular=vec2.create([1,50]);var g=c.u_reflection=0,f;for(f in this.textures){var h=this.getTextureSampler(f);if(h){var k=B.getTextureFromSampler(h);k&&(e[g]=h,c[f+(k.texture_type==gl.TEXTURE_2D?"_texture":"_cubemap")]=g,g++)}}for(f in this.extra_uniforms)c[f]=this.extra_uniforms[f];this._uniforms=c;this._samplers=e};B.prototype.configure=function(a){for(var b in a)"function"!==typeof a[b]&&!this.setProperty(b,a[b])&&d.debug&&console.warn("Material property not assigned: "+
b)};B.prototype.serialize=function(a){for(var b in this.textures)this.textures[b]&&this.textures[b].constructor===GL.Texture&&(this.textures[b]=null);b=d.cloneObject(this);delete b.filename;delete b.fullpath;delete b.remotepath;b.material_class=d.getObjectClassName(this);a&&(delete b.render_state,delete b.flags,b.uvs_matrix&&b.uvs_matrix.equal([1,0,0,0,1,0,0,0,1])&&delete b.uvs_matrix);return b};B.prototype.clone=function(){var a=this.serialize();a.uid&&delete a.uid;return new this.constructor(JSON.parse(JSON.stringify(a)))};
B.prototype.loadAndSetTexture=function(a,b,c){c=c||{};var e=this;if(b&&b.constructor===String)":"!=b[0]?d.ResourcesManager.load(b,c,function(b){e.setTexture(a,b);if(c.on_complete)c.on_complete()}):this.setTexture(a,b);else if(this.setTexture(a,b),c.on_complete)c.on_complete()};B.prototype.getPropertiesInfo=function(){var a={color:"vec3",opacity:"number",uvs_matrix:"mat3"},b=this.getTextureChannels(),c;for(c in b)a["tex_"+b[c]]="Texture";return a};B.prototype.getProperty=function(a){return"tex_"==
a.substr(0,4)?this.textures[a.substr(4)]:this[a]};B.prototype.setProperty=function(a,b){if(void 0!==b){if("tex_"==a.substr(0,4))return(!b||b.constructor!==String&&b.constructor!==GL.Texture)&&b||this.setTexture(a.substr(4),b),!0;switch(a){case "queue":0===b&&(b=pa.AUTO);case "opacity":null!==b&&b.constructor===Number&&(this[a]=b);break;case "uid":this[a]=b;break;case "uvs_matrix":case "color":this[a].length==b.length&&this[a].set(b);break;case "textures":for(var c in b){var e=b[c];if(null==e)delete this.textures[c];
else{e.constructor===String&&(e={texture:e,uvs:0,wrap:0,minFilter:0,magFilter:0});if(e.constructor!==GL.Texture&&e.constructor!=Object){console.warn("invalid value for texture:",e);break}e._must_update=!0;this.textures[c]=e;null!=e.uvs&&e.uvs.constructor===String&&(e.uvs=0);this.textures[c]&&this.textures[c].texture&&(this.textures[c].texture=d.ResourcesManager.cleanFullpath(this.textures[c].texture))}}break;case "flags":for(c in b)this.flags[c]=b[c];break;case "transparency":this.opacity=1-b;break;
case "render_state":this._render_state.configure(b);break;case "material_class":case "object_type":break;default:return!1}return!0}};B.prototype.setPropertyValueFromPath=function(a,b,c){c=c||0;a.length<c+1||this.setProperty(a[c],b)};B.prototype.getPropertyInfoFromPath=function(a){if(!(1>a.length)){var b=a[0],c=null;switch(b){case "queue":case "opacity":case "transparency":c="number";break;case "uvs_matrix":c="mat3";break;case "color":c="vec3";break;case "textures":if(1<a.length)return{node:this._root,
target:this.textures,name:a[1],value:this.textures[a[1]]||null,type:"Texture"};c="Texture";break;default:return null}return{node:this._root,target:this,name:b,value:this[b],type:c}}};B.prototype.getTextureChannels=function(){return[]};B.prototype.setTexture=function(a,b,c){if(!a)throw"Material.prototype.setTexture channel must be specified";if(b){b.constructor===String&&(b=d.ResourcesManager.cleanFullpath(b));var e=this.textures[a];if(e)if(e.texture!=b||c)e.texture=b;else return e;else this.textures[a]=
e={texture:b,uvs:0,wrap:0,minFilter:0,magFilter:0,missing:"white"};if(c)for(var g in c)e[g]=c[g];e._must_update=!0;b.constructor===String&&":"!=b[0]&&d.ResourcesManager.load(b);return e}delete this.textures[a]};B.prototype.setTextureProperty=function(a,b,c){var e=this.textures[a];e?e[b]=c:"texture"==b&&(this.textures[a]={texture:c,uvs:0,wrap:0,minFilter:0,magFilter:0})};B.prototype.getTexture=function(a){a=a||B.COLOR_TEXTURE;a=this.textures[a];return a?a.constructor===String?d.ResourcesManager.textures[a]:
(a=a.texture)?a.constructor===String?d.ResourcesManager.textures[a]:a.constructor==Texture?a:null:null:null};B.prototype.getTextureSampler=function(a){return this.textures[a]};B.getTextureFromSampler=function(a){a=a.constructor===String?a:a.texture;if(!a)return null;a.constructor===String&&(a=d.ResourcesManager.textures[a]);return a&&a.constructor==GL.Texture?a:null};B.prototype.setTextureSampler=function(a,b){if(!a)throw"Cannot call Material setTextureSampler without channel";b?this.textures[a]=
b:delete this.textures[a]};B.prototype.getResources=function(a){for(var b in this.textures){var c=this.textures[b];c&&"string"==typeof c.texture&&(a[c.texture]=GL.Texture)}return a};B.prototype.onResourceRenamed=function(a,b,c){c=!1;for(var e in this.textures){var d=this.textures[e];d&&d.texture==a&&(d.texture=b,c=!0)}return c};B.prototype.loadTextures=function(){var a=this.getResources({}),b;for(b in a)d.ResourcesManager.load(b)};B.prototype.registerMaterial=function(a){this.name=a;d.ResourcesManager.registerResource(a,
this);this.material=a};B.prototype.getCategory=function(){return this.category||"Material"};B.prototype.getLocator=function(){return this.filename?d.ResourcesManager.convertFilenameToLocator(this.fullpath||this.filename):this._root?this._root.uid+"/material":this.uid};B.prototype.assignToNode=function(a){if(!a)return!1;var b=this.fullpath||this.filename;a.material=b?b:this;return!0};B.prototype.createProperty=function(a,b,c,e){c&&(d.validatePropertyType(c),this.constructor["@"+a]={type:c});e&&(this.constructor["@"+
a]||(this.constructor["@"+a]={}),d.cloneObject(e,this.constructor["@"+a]));null!=b&&(b.constructor===Number||b.constructor===String||b.constructor===Boolean?this[a]=b:b.constructor===Float32Array&&(c="_"+a,b=new Float32Array(b),this[c]=b,Object.defineProperty(this,a,{get:function(){return b},set:function(a){b.set(a)},enumerable:!0,configurable:!0})))};B.prototype.prepare=function(a){this._uniforms||(this._uniforms={},this._samplers=[]);if(this.onPrepare)this.onPrepare(a);this.fillUniforms(a)};B.prototype.getShader=
function(a){a=B._shader_color;a||(a=B._shader_color=new GL.Shader(d.Shaders.common_vscode+"void main(){ vec4 vertex = u_model * a_vertex;\ngl_Position = u_viewprojection * vertex;\n }",d.Shaders.common_vscode+"uniform vec4 u_color;\n\void main(){ gl_FragColor = u_color;\n }"));return a};B.prototype.renderInstance=function(a,b,c){b=d.Renderer;var e=d.Renderer._current_camera,g=d.Renderer._current_scene,f=d.Renderer._render_uniforms;f.u_model=a.matrix;f.u_normal_model=a.normal_matrix;this._render_state.enable();
d.Renderer.bindSamplers(this._samplers);if(this.onRenderInstance)this.onRenderInstance(a);c=shader_code.getShader(c.name);if(!c)return!1;c.uniformsArray([g._uniforms,e._uniforms,f,this._uniforms,a.uniforms]);a.render(c,-1!=this._primitive?this._primitive:void 0);b._rendercalls+=1;return!0};d.registerResourceClass(B);d.Material=B;M.description="This material allows full control of the shader being used to render it.\nIt forces to code not only the surface properties but also the light equation.\nIt may be a little bit complex but it comes with examples.";
Object.defineProperty(M.prototype,"shader",{enumerable:!0,get:function(){return this._shader},set:function(a){a&&(a=d.ResourcesManager.cleanFullpath(a));this._shader!=a&&(this._shader_code=null,this._shader=a,this.processShaderCode())}});Object.defineProperty(M.prototype,"shader_code",{enumerable:!1,get:function(){return this._shader_code},set:function(a){this._shader=null;this._shader_code=a;this.processShaderCode()}});Object.defineProperty(M.prototype,"properties",{enumerable:!0,get:function(){return this._properties},
set:function(a){if(a){this._properties=a;this._properties_by_name={};for(var b in this._properties)a=this._properties[b],this._properties_by_name[a.name]=a}}});Object.defineProperty(M.prototype,"enableLights",{enumerable:!0,get:function(){return 0!=this._light_mode},set:function(a){this._light_mode=a?1:0}});Object.defineProperty(M.prototype,"version",{enumerable:!1,get:function(){return this._version},set:function(a){console.error("version cannot be set manually")}});M.prototype.addPass=function(a,
b,c,e){this._passes[a]={vertex:b,fragment:c,macros:e}};M.prototype.prepare=function(a){this.fillUniforms();if(this.onPrepare)this.onPrepare(a)};M.prototype.fillUniforms=function(){var a=this._samplers;a.length=0;this._uniforms.u_material_color=this._color;for(var b=0;b<this._properties.length;++b){var c=this._properties[b];c.internal||(c.is_texture?(this._uniforms[c.uniform]=a.length,c.value?a.push(c.value):a.push(" ")):this._uniforms[c.uniform]=c.value)}};M.prototype.setProperty=function(a,b){if(B.prototype.setProperty.call(this,
a,b))return!0;if("shader"==a)this.shader=b;else if("properties"==a){this.properties.length=0;this._properties_by_name={};for(var c=0;c<b.length;++c){var e=b[c];e.is_texture&&e.value&&e.value.constructor===String&&(e.value={texture:e.value});this.properties[c]=e;this._properties_by_name[e.name]=e}}else if(this._properties_by_name[a])e=this._properties_by_name[a],e.value&&e.value.constructor!==String&&e.value.length?e.value.set(b):e.value=b;else return!1;return!0};M.prototype.processShaderCode=function(){if(!this._shader_code&&
!this._shader)return this._properties.length=0,this._properties_by_name={},this._passes={},this._samplers.length=0,!1;var a=this._shader_code;!a&&this._shader&&(a=d.ResourcesManager.getResource(this.shader));if(!a||a.constructor!==d.ShaderCode)return!1;var b=this._properties_by_name,c=this._render_state.serialize();a._has_error?this._last_valid_properties=b:this._last_valid_properties&&(b=this._last_valid_properties,this._last_valid_properties=null);this._properties.length=0;this._properties_by_name=
{};this._passes={};this._light_mode=this._samplers.length=0;this._primitive=-1;this._queue=d.RenderQueue.GEOMETRY;this._render_state.init();for(var e in this)this.hasOwnProperty(e)&&this[e]&&this[e].constructor===Function&&delete this[e];this._render_state.configure(c);if(a._functions.init)if(d.catch_exceptions)try{a._functions.init.call(this)}catch(g){d.dispatchCodeError(g)}else a._functions.init.call(this);for(e in a._global_uniforms)c=a._global_uniforms[e],c.disabled||this.createUniform(c.name,
c.uniform,c.type,c.value,c.options);this._shader_version=a._version;this._version++;this.assignOldProperties(b)};M.prototype.assignOldProperties=function(a){var b=null,c=this.getShaderCode();c&&(b=c.getShader());for(c=0;c<this._properties.length;++c){var e=this._properties[c];if(a[e.name]){var d=a[e.name];if(void 0!==d.value){if(!d.internal&&b&&!e.is_texture){var f=b.uniformInfo[e.uniform];if(!f)continue;if(void 0!==e.value&&!GL.Shader.validateValue(e.value,f)){e.value=void 0;continue}}e.value&&e.value.set?
d.value&&d.value.length&&e.value.length&&d.value.length<=e.value.length?e.value.set(d.value):e.value=d.value:e.value=d.value}}}};M.nolights_vec4=new Float32Array([0,0,0,1]);M.missing_color=new Float32Array([1,0,1,1]);M.prototype.renderInstance=function(a,b,c){var e=this.getShaderCode(a,b,c);e&&e.constructor===d.ShaderCode||(e=d.ShaderCode.getDefaultCode(a,b,c),c.id==xb.id&&(this._uniforms.u_material_color=M.missing_color));e._version!==this._shader_version&&this.processShaderCode&&this.processShaderCode();
var g=d.Renderer,f=d.Renderer._current_camera,h=d.Renderer._current_scene,k=d.Renderer._uniforms;k.u_model=a.matrix;k.u_normal_model=a.normal_matrix;var l=a.computeShaderBlockFlags(),m=d.Renderer._global_shader_blocks_flags;if(c==xb){var m=m|d.ShaderMaterial.reflection_block.flag_mask,p=this.textures.environment,p=p&&p.texture?p.texture:null;p||(d.Renderer._global_textures.environment&&(p=d.Renderer._global_textures.environment),a._nearest_reflection_probe&&a._nearest_reflection_probe._texture&&(p=
a._nearest_reflection_probe._tex_id));if(p)var n=p.constructor===String?d.ResourcesManager.textures[p]:p,m=n&&n.texture_type==GL.TEXTURE_2D?n._is_planar?m|Vb.flag_mask:m|Wb.flag_mask:m|Xb.flag_mask;this._samplers[d.Renderer.ENVIRONMENT_TEXTURE_SLOT]=p}else this._samplers[d.Renderer.ENVIRONMENT_TEXTURE_SLOT]=null;this._render_state.enable(b);d.Renderer.bindSamplers(this._samplers);d.Renderer.bindSamplers(a.samplers);a.vertex_buffers.colors&&(l|=d.Shaders.vertex_color_block.flag_mask);a.vertex_buffers.coords1&&
(l|=d.Shaders.coord1_block.flag_mask);a.instanced_models&&a.instanced_models.length&&gl.extensions.ANGLE_instanced_arrays&&(l|=d.Shaders.instancing_block.flag_mask);if(this.onRenderInstance)this.onRenderInstance(a,c);if(c==kc){l|=d.Shaders.firstpass_block.flag_mask;l|=d.Shaders.lastpass_block.flag_mask;l=e.getShader(c.name,l);if(!l)return!1;l.uniformsArray([h._uniforms,f._uniforms,k,this._uniforms,a.uniforms]);gl.disable(gl.BLEND);a.render(l,-1!=this._primitive?this._primitive:void 0);g._rendercalls+=
1;return!0}p=null;(n=c!=xb||b.lights_disabled||this._light_mode===B.NO_LIGHTS)||(p=d.Renderer.getNearLights(a));d.Renderer._use_normalbuffer&&(l|=d.Shaders.normalbuffer_block.flag_mask);if(!p||0==p.length||n){n||(l|=m);l|=d.Shaders.firstpass_block.flag_mask;l|=d.Shaders.lastpass_block.flag_mask;l=e.getShader(null,l);if(!l)return!1;l.uniformsArray([h._uniforms,f._uniforms,k,this._uniforms,a.uniforms]);l.setUniform("u_light_info",M.nolights_vec4);n&&l.setUniform("u_ambient_light",d.ONES);a.render(l,
-1!=this._primitive?this._primitive:void 0);g._rendercalls+=1;return!0}for(var n=l,f=[h._uniforms,f._uniforms,k,null,this._uniforms,a.uniforms],h=null,k=0,r=p.length;k<r;++k){var t=p[k],l=t.applyShaderBlockFlags(n,c,b),l=l|m;0==k&&(l|=d.Shaders.firstpass_block.flag_mask);k==r-1&&(l|=d.Shaders.lastpass_block.flag_mask);(l=e.getShader(null,l))?(d.Renderer.bindSamplers(t._samplers),t._uniforms.u_light_info[2]=k,t._uniforms.u_light_info[3]=p.length,f[3]=t._uniforms,h!=l?l.uniformsArray(f):l.uniforms(t._uniforms),
h=l,1==k&&(gl.depthMask(!1),gl.depthFunc(gl.EQUAL),gl.enable(gl.BLEND),gl.blendFunc(gl.SRC_ALPHA,gl.ONE)),a.render(l,-1!=this._primitive?this._primitive:void 0),g._rendercalls+=1):console.warn("material without pass: "+c.name)}gl.disable(gl.BLEND);gl.depthMask(!0);gl.depthFunc(gl.LESS);return!0};M.prototype.renderPickingInstance=function(a,b,c){var e=this.getShaderCode(a,b,c);e&&e.constructor===d.ShaderCode||(e=d.ShaderCode.getDefaultCode(a,b,c));var g=d.Renderer,f=d.Renderer._current_camera,h=a.node,
k=d.Renderer._uniforms;k.u_model=a.matrix;k.u_normal_model=a.normal_matrix;var l=a.computeShaderBlockFlags();this._render_state.enable(b);gl.disable(gl.BLEND);d.Renderer.bindSamplers(this._samplers);d.Renderer.bindSamplers(a.samplers);b=e.getShader(c.name,l);if(!b&&(e=d.ShaderMaterial.getDefaultPickingShaderCode(),b=e.getShader(c.name,l),!b))return!1;b.uniformsArray([f._uniforms,k,this._uniforms,a.uniforms]);c=d.Picking.getNextPickingColor(a.picking_node||h);b.setUniform("u_material_color",c);a.render(b,
-1!=this._primitive?this._primitive:void 0);g._rendercalls+=1;gl.disable(gl.BLEND);gl.depthMask(!0);gl.depthFunc(gl.LESS);return!0};M.prototype.getTextureChannels=function(){var a=[],b;for(b in this._properties){var c=this._properties[b];c.is_texture&&a.push(c.name)}return a};M.prototype.getResources=function(a){this.shader&&(a[this.shader]=d.ShaderCode);var b=d.ResourcesManager.getResource(this._shader);b&&b.getResources(a);for(var c in this._properties)if(b=this._properties[c],b.value&&b.is_texture&&
b.value){var e=null;(e=b.value.texture?b.value.texture:a[b.value])&&e.constructor===String&&(a[e]=GL.Texture)}return a};M.prototype.getPropertyInfoFromPath=function(a){if(!(1>a.length)){var b=B.prototype.getPropertyInfoFromPath.call(this,a);if(b)return b;a=this._properties_by_name[a[0]];if(!a)return null;b=a.type;if("float"==b||"int"==b)b="number";return{node:this._root,target:this,name:a.name,value:a.value,type:b}}};M.prototype.setPropertyValue=function(a,b){if(!B.prototype.setProperty.call(this,
a,b)){var c=this._properties_by_name[a];if(!c)return null;c.value&&c.value.set?c.value.set(b):c.value=b}};M.prototype.getShaderCode=function(a,b,c){a=this._shader_code||d.ResourcesManager.getResource(this._shader);if(!a||a.constructor!==d.ShaderCode)return null;a._version!==this._shader_version&&this.processShaderCode&&(a._version=this._shader_version,this.processShaderCode());return a};M.prototype.applyToTexture=function(a,b){if(!this.shader||!a)return!1;var c=this.getShaderCode();if(!c)return!1;
var e=c.getShader("fx");if(!e)return!1;this.fillUniforms();this._uniforms.u_time=d.GlobalScene._time;this._uniforms.u_viewport=gl.viewport_data;d.Renderer.bindSamplers(this._samplers);gl.disable(gl.DEPTH_TEST);gl.disable(gl.CULL_FACE);b?b.drawTo(function(){a.toViewport(e,this._uniforms)}):a.toViewport(e,this._uniforms)};M.prototype.createUniform=function(a,b,c,e,d){if(!a||!b)throw"parameter missing in createUniform";c=c||"Number";if(c.constructor!==String)throw"type must be string";if((e=e||0)&&e.length)e=
new Float32Array(e);else switch(c){case "vec2":e=vec2.create();break;case "color":case "vec3":e=vec3.create();break;case "color4":case "vec4":e=vec4.create();break;case "mat3":e=mat3.create();break;case "mat4":e=mat4.create()}b={name:a,uniform:b,value:e,type:c,is_texture:0};if("texture"==c.toLowerCase()||"sampler2D"==c||"samplerCube"==c||"sampler"==c)b.is_texture="samplerCube"==c?2:1;b.is_texture&&(b.sampler={},b.type="sampler",b.sampler_slot=this._samplers.length,this._samplers.push(b.sampler));
if(d)for(var f in d)b[f]=d[f];this._properties.push(b);this._properties_by_name[a]=b};M.prototype.createSampler=function(a,b,c,e){if(!a||!b)throw"parameter missing in createSampler";var d="sampler";c&&c.type&&(d=c.type);var f=null;if(this._properties_by_name[a]){var h=this._properties_by_name[a];h.type==d&&h.value&&(f=h.value)}f||(f={texture:e});b={name:a,uniform:b,value:f,type:d,is_texture:1,sampler_slot:-1};if(c){c.filter&&(f.magFilter=c.filter,f.minFilter=c.filter,delete c.filter);c.wrap&&(f.wrapS=
c.wrap,f.wrapT=c.wrap,delete c.wrap);for(var k in c)f[k]=c[k]}b.sampler_slot=this._samplers.length;this._properties.push(b);this._properties_by_name[a]=b;this._samplers.push(b.value)};M.prototype.createProperty=function(a,b,c,e){var d=this._properties_by_name[a];if(!d||d.type!=c){d={name:a,type:c,internal:!0,value:b};if(e)for(var f in e)d[f]=e[f];this._properties.push(d);this._properties_by_name[a]=d;Object.defineProperty(this,a,{get:function(){var b=this._properties_by_name[a];if(b)return b.value},
set:function(b){var c=this._properties_by_name[a];c&&(c.value&&c.value.set?c.value.set(b):c.value=b)},enumerable:!1,configurable:!0})}};M.prototype.getProperty=function(a){if(null==B.prototype.getProperty.call(this,a))return(a=this._properties_by_name[a])?a.value:null};M.prototype.onResourceRenamed=function(a,b,c){c=B.prototype.onResourceRenamed.call(this,a,b,c);this.shader==a&&(this.shader=b,c=!0);for(var e=0;e<this._properties.length;++e){var d=this._properties[e];!d.internal&&d.is_texture&&d.value&&
d.value.texture==a&&(d.value.texture=b,c=!0)}return c};M.getDefaultPickingShaderCode=function(){if(M.default_picking_shader_code)return M.default_picking_shader_code;var a=new d.ShaderCode;a.code=d.ShaderCode.flat_code;return M.default_picking_shader_code=a};M.createFlatMaterial=function(){var a=new d.ShaderMaterial;a.shader_code=d.ShaderCode.getDefaultCode();return a};d.registerMaterialClass(M);d.ShaderMaterial=M;Object.defineProperty(I.prototype,"detail_factor",{get:function(){return this._detail[0]},
set:function(a){this._detail[0]=a},enumerable:!0});Object.defineProperty(I.prototype,"detail_scale",{get:function(){return this._detail.subarray(1,3)},set:function(a){this._detail[1]=a[0];this._detail[2]=a[1]},enumerable:!0});Object.defineProperty(I.prototype,"emissive_extra",{get:function(){return this._emissive[3]},set:function(a){this._emissive[3]=a},enumerable:!0});Object.defineProperty(I.prototype,"specular_factor",{get:function(){return this._specular_data[0]},set:function(a){null!=a&&a.constructor===
Number&&(this._specular_data[0]=a)},enumerable:!0});Object.defineProperty(I.prototype,"specular_gloss",{get:function(){return this._specular_data[1]},set:function(a){this._specular_data[1]=a},enumerable:!0});I.description="This material is a general use material that allows to control the most common properties.";I["@blend_mode"]={type:"enum",values:d.Blend};I.actions={};I.DETAIL_TEXTURE="detail";I.NORMAL_TEXTURE="normal";I.DISPLACEMENT_TEXTURE="displacement";I.BUMP_TEXTURE="bump";I.REFLECTIVITY_TEXTURE=
"reflectivity";I.EXTRA_TEXTURE="extra";I.IRRADIANCE_TEXTURE="irradiance";I.TEXTURES_INDEX={color:0,opacity:1,ambient:2,specular:3,emissive:4,detail:5,normal:6,displacement:7,bump:8,reflectivity:9,extra:10,environment:11};I.prototype.renderInstance=M.prototype.renderInstance;I.prototype.renderShadowInstance=M.prototype.renderShadowInstance;I.prototype.renderPickingInstance=M.prototype.renderPickingInstance;I.prototype.prepare=function(a){var b=this.flags,c=this._render_state;this._texture_settings||
(this._texture_settings=this._uniforms.u_texture_settings=new Uint8Array(9));c.cull_face=!b.two_sided;c.front_face=b.flip_normals?GL.CW:GL.CCW;c.depth_test=b.depth_test;c.depth_mask=b.depth_write;c.blend=this.blend_mode!=d.Blend.NORMAL;this.blend_mode!=d.Blend.NORMAL&&(b=d.BlendFunctions[this.blend_mode])&&(c.blendFunc0=b[0],c.blendFunc1=b[1]);for(var e in this.textures)if(c=this.textures[e])null==c.index&&(c.index=I.TEXTURES_INDEX[e]),this._texture_settings[c.index]=c.uvs;this._light_mode=this.flags.ignore_lights?
B.NO_LIGHTS:1;this.fillUniforms(a)};I.FLAGS={COLOR_TEXTURE:2,OPACITY_TEXTURE:4,SPECULAR_TEXTURE:8,REFLECTIVITY_TEXTURE:16,AMBIENT_TEXTURE:32,EMISSIVE_TEXTURE:64,DETAIL_TEXTURE:128,NORMAL_TEXTURE:256,DISPLACEMENT_TEXTURE:512,EXTRA_TEXTURE:1024,ENVIRONMENT_TEXTURE:2048,ENVIRONMENT_CUBEMAP:4096,IRRADIANCE_CUBEMAP:8192,DEGAMMA_COLOR:67108864,SPEC_ON_ALPHA:134217728,SPEC_ON_TOP:268435456,ALPHA_TEST:536870912};I.shader_codes={};I.prototype.getShaderCode=function(a,b,c){c=I.FLAGS;a=0;this.textures.color&&
(a|=c.COLOR_TEXTURE,this.textures.color.degamma&&(a|=c.DEGAMMA_COLOR));this.textures.opacity&&(a|=c.OPACITY_TEXTURE);this.textures.displacement&&(a|=c.DISPLACEMENT_TEXTURE);this.textures.normal&&(a|=c.NORMAL_TEXTURE);this.textures.specular&&(a|=c.SPECULAR_TEXTURE);0<this.reflection_factor&&this.textures.reflectivity&&(a|=c.REFLECTIVITY_TEXTURE);this.textures.emissive&&(a|=c.EMISSIVE_TEXTURE);this.textures.ambient&&(a|=c.AMBIENT_TEXTURE);this.textures.detail&&(a|=c.DETAIL_TEXTURE);this.textures.extra&&
(a|=c.EXTRA_TEXTURE);this.specular_on_alpha&&(a|=c.SPEC_ON_ALPHA);this.specular_on_top&&(a|=c.SPEC_ON_TOP);this.flags.alpha_test&&(a|=c.ALPHA_TEST);var e=d.StandardMaterial.shader_codes[a];if(e)return e;b={vs_local:"",vs_global:"",fs:"",fs_shadows:""};a&c.DISPLACEMENT_TEXTURE&&(b.vs_local+="\tvertex4.xyz += v_normal * texture2D( displacement_texture, v_uvs ).x * u_displacementmap_factor;\n");b.fs+="\n\tuvs[0] = IN.uv;\n\tuvs[1] = IN.uv1;\n\tuvs[2] = (u_texture_matrix * vec3(uvs[0],1.0)).xy;\n\t#ifdef COORD1_BLOCK\n\t\tuvs[3] = (vec3(uvs[1],1.0) * u_texture_matrix).xy;\n\t#else\n\t\tuvs[3] = uvs[2];\n\t#endif\n\tuvs[4] = gl_PointCoord;\n\t";
b.fs_shadows+="\n\tuvs[0] = IN.uv;\n\tuvs[1] = IN.uv1;\n\tuvs[2] = (u_texture_matrix * vec3(uvs[0],1.0)).xy;\n\t#ifdef COORD1_BLOCK\n\t\tuvs[3] = (vec3(uvs[1],1.0) * u_texture_matrix).xy;\n\t#else\n\t\tuvs[3] = uvs[2];\n\t#endif\n\tuvs[4] = gl_PointCoord;\n\t";a&c.NORMAL_TEXTURE&&(b.fs+="vec2 normal_uv = getUVs( u_texture_settings["+I.TEXTURES_INDEX.normal+"]);\n\t\tvec3 normal_pixel = texture2D( normal_texture, normal_uv ).xyz;\n\t\tif( u_normal_info.y > 0.0 )\n\t\t{\n\t\t\tnormal_pixel.xy = vec2(1.0) - normal_pixel.xy;\n\t\t\tnormal_pixel = normalize( perturbNormal( IN.worldNormal, IN.viewDir, normal_uv, normal_pixel ));\n\t\t}\n\t\telse\n\t\t\tnormal_pixel = normal_pixel * 2.0 - vec3(1.0);\n\t\to.Normal = normalize( mix( o.Normal, normal_pixel, u_normal_info.x ) );\n");
a&c.COLOR_TEXTURE&&(e="\tvec4 tex_color = texture2D( color_texture, getUVs( u_texture_settings["+I.TEXTURES_INDEX.color+"] ) );\n",b.fs+=e,b.fs_shadows+=e,a&c.DEGAMMA_COLOR&&(b.fs+="\ttex_color.xyz = pow( tex_color.xyz, vec3(2.0) );\n"),e="\to.Albedo *= tex_color.xyz;\n\to.Alpha *= tex_color.w;\n",b.fs+=e,b.fs_shadows+=e);a&c.OPACITY_TEXTURE&&(e="\to.Alpha *= texture2D( opacity_texture, getUVs( u_texture_settings["+I.TEXTURES_INDEX.opacity+"]) ).x;\n",b.fs+=e,b.fs_shadows+=e);a&c.SPECULAR_TEXTURE&&
(b.fs+="\tvec4 spec_info = texture2D( specular_texture, getUVs( u_texture_settings["+I.TEXTURES_INDEX.specular+"]) );\n\to.Specular *= spec_info.x;\n\to.Gloss *= spec_info.y;\n");a&c.REFLECTIVITY_TEXTURE&&(b.fs+="\to.Reflectivity *= texture2D( reflectivity_texture, getUVs( u_texture_settings["+I.TEXTURES_INDEX.reflectivity+"]) ).x;\n");a&c.EMISSIVE_TEXTURE&&(b.fs+="\to.Emission *= texture2D( emissive_texture, getUVs( u_texture_settings["+I.TEXTURES_INDEX.emissive+"]) ).xyz;\n");a&c.AMBIENT_TEXTURE&&
(b.fs+="\to.Ambient *= texture2D( ambient_texture, getUVs( u_texture_settings["+I.TEXTURES_INDEX.ambient+"]) ).xyz;\n");a&c.DETAIL_TEXTURE&&(b.fs+="\to.Albedo += (texture2D( detail_texture, getUVs( u_texture_settings["+I.TEXTURES_INDEX.detail+"]) * u_detail_info.yz).xyz - vec3(0.5)) * u_detail_info.x;\n");a&c.EXTRA_TEXTURE&&(b.fs+="\tif(u_light_info.z == 0.0) o.Extra = u_extra_color * texture2D( extra_texture, getUVs( u_texture_settings["+I.TEXTURES_INDEX.extra+"] ) );\n");a&c.ALPHA_TEST&&(e="\tif(o.Alpha < 0.01) discard;\n",
b.fs+=e,b.fs_shadows+=e);a&c.SPEC_ON_TOP&&(b.fs+="\t#define SPEC_ON_TOP\n");a&c.SPEC_ON_ALPHA&&(b.fs+="\t#define SPEC_ON_ALPHA\n");e=new d.ShaderCode;c=I.code_template;if(I.onShaderCode)I.onShaderCode(b,this,a);e.code=P.replaceCode(c,b);return d.StandardMaterial.shader_codes[a]=e};I.prototype.fillUniforms=function(a,b){var c=this._uniforms;c.u_reflection_info[0]=this.reflection_factor;c.u_reflection_info[1]=this.reflection_fresnel;c.u_backlight_factor=this.backlight_factor;c.u_translucency=this.translucency;
c.u_normal_info[0]=this.normalmap_factor;c.u_normal_info[1]=this.normalmap_tangent?1:0;c.u_displacementmap_factor=this.displacementmap_factor;c.u_velvet_info.set(this._velvet);c.u_velvet_info[3]=this.velvet_additive?this.velvet_exp:-this.velvet_exp;c.u_point_size=this.point_size;var e=0,g=this._samplers;g.length=0;for(var f in this.textures){var h=this.getTextureSampler(f);if(h){var k=null;if(k=h.constructor===GL.Texture?h:h.texture){if(k.constructor===String)k=d.ResourcesManager.textures[k];else if(k.constructor!=
Texture)continue;k||(h={texture:":missing"});k=e;"environment"==f?k=d.Renderer.ENVIRONMENT_TEXTURE_SLOT:"irradiance"==f?k=d.Renderer.IRRADIANCE_TEXTURE_SLOT:e++;g[k]=h;c[f+"_texture"]=k}}}};I.prototype.getTextureChannels=function(){return[B.COLOR_TEXTURE,B.OPACITY_TEXTURE,B.AMBIENT_TEXTURE,B.SPECULAR_TEXTURE,B.EMISSIVE_TEXTURE,I.DETAIL_TEXTURE,I.NORMAL_TEXTURE,I.DISPLACEMENT_TEXTURE,I.BUMP_TEXTURE,I.REFLECTIVITY_TEXTURE,I.EXTRA_TEXTURE,B.ENVIRONMENT_TEXTURE,I.IRRADIANCE_TEXTURE]};I.prototype.setProperty=
function(a,b){if(B.prototype.setProperty.call(this,a,b))return!0;switch(a){case "render_state":case "specular_factor":case "specular_gloss":case "backlight_factor":case "translucency":case "reflection_factor":case "reflection_fresnel":case "velvet_exp":case "velvet_additive":case "normalmap_tangent":case "normalmap_factor":case "bumpmap_factor":case "displacementmap_factor":case "detail_factor":case "emissive_extra":case "point_size":case "shader_name":case "specular_on_top":case "specular_on_alpha":case "normalmap_tangent":case "reflection_specular":case "use_scene_ambient":case "blend_mode":null!==
b&&(this[a]=b);break;case "flags":if(b)for(var c in b)this.flags[c]=b[c];break;case "ambient":case "emissive":case "velvet":case "extra":case "detail_scale":this[a].length>=b.length&&this[a].set(b);break;default:return!1}return!0};I.prototype.getPropertiesInfo=function(){var a=B.prototype.getPropertiesInfo.call(this);a.merge({shader_name:d.TYPES.STRING,blend_mode:d.TYPES.NUMBER,specular_factor:d.TYPES.NUMBER,specular_gloss:d.TYPES.NUMBER,backlight_factor:d.TYPES.NUMBER,translucency:d.TYPES.NUMBER,
reflection_factor:d.TYPES.NUMBER,reflection_fresnel:d.TYPES.NUMBER,velvet_exp:d.TYPES.NUMBER,point_size:d.TYPES.NUMBER,normalmap_factor:d.TYPES.NUMBER,bumpmap_factor:d.TYPES.NUMBER,displacementmap_factor:d.TYPES.NUMBER,emissive_extra:d.TYPES.NUMBER,ambient:d.TYPES.VEC3,emissive:d.TYPES.VEC3,velvet:d.TYPES.VEC3,extra:d.TYPES.VEC4,detail_factor:d.TYPES.NUMBER,detail_scale:d.TYPES.VEC2,specular_on_top:d.TYPES.BOOLEAN,normalmap_tangent:d.TYPES.BOOLEAN,reflection_specular:d.TYPES.BOOLEAN,use_scene_ambient:d.TYPES.BOOLEAN,
velvet_additive:d.TYPES.BOOLEAN});return a};I.prototype.getPropertyInfoFromPath=function(a){if(!(1>a.length)){var b=B.prototype.getPropertyInfoFromPath.call(this,a);if(b)return b;a=a[0];switch(a){case "blend_mode":case "backlight_factor":case "translucency":case "reflection_factor":case "reflection_fresnel":case "velvet_exp":case "normalmap_factor":case "bumpmap_factor":case "displacementmap_factor":case "emissive_extra":case "detail_factor":case "point_size":b=d.TYPES.NUMBER;break;case "extra":b=
d.TYPES.VEC4;break;case "ambient":case "emissive":case "velvet":b=d.TYPES.VEC3;break;case "detail_scale":b=d.TYPES.VEC2;break;case "specular_on_top":case "specular_on_alpha":case "normalmap_tangent":case "reflection_specular":case "use_scene_ambient":case "velvet_additive":b=d.TYPES.BOOLEAN;break;default:return null}return{node:this._root,target:this,name:a,value:this[a],type:b}}};I.clearShadersCache=function(){d.log("StandardMaterial ShaderCode cache cleared");I.shader_codes={}};d.registerMaterialClass(I);
d.StandardMaterial=I;d.Classes.newStandardMaterial=I;I.code_template='\n\n\n\\default.vs\n\nprecision mediump float;\n//global defines from blocks\n#pragma shaderblock "vertex_color"\n#pragma shaderblock "coord1"\n#pragma shaderblock "instancing"\n\nattribute vec3 a_vertex;\nattribute vec3 a_normal;\nattribute vec2 a_coord;\n#ifdef BLOCK_COORD1\n\tattribute vec2 a_coord1;\n\tvarying vec2 v_uvs1;\n#endif\n#ifdef BLOCK_VERTEX_COLOR\n\tattribute vec4 a_color;\n\tvarying vec4 v_vertex_color;\n#endif\n#pragma event "vs_attributes"\n\n//varyings\nvarying vec3 v_pos;\nvarying vec3 v_normal;\nvarying vec2 v_uvs;\nvarying vec3 v_local_pos;\nvarying vec3 v_local_normal;\nvarying vec4 v_screenpos;\n\n//matrices\n#ifdef BLOCK_INSTANCING\n\tattribute mat4 u_model;\n#else\n\tuniform mat4 u_model;\n#endif\nuniform mat4 u_normal_model;\nuniform mat4 u_view;\nuniform mat4 u_viewprojection;\n//material\nuniform float u_displacementmap_factor;\nuniform sampler2D displacement_texture;\n\n//globals\nuniform float u_time;\nuniform vec4 u_viewport;\nuniform float u_point_size;\n\n#pragma shaderblock "light"\n#pragma shaderblock "morphing"\n#pragma shaderblock "skinning"\n\n//camera\nuniform vec3 u_camera_eye;\nuniform vec2 u_camera_planes;\nuniform vec3 u_camera_perspective;\n\n#pragma event "vs_functions"\n\n//special cases\n{{vs_out}}\n\nvoid main() {\n\t\n\tvec4 vertex4 = vec4(a_vertex,1.0);\n\tv_local_pos = a_vertex;\n\tv_local_normal = a_normal;\n\tv_normal = a_normal;\n\tv_uvs = a_coord;\n\t#ifdef BLOCK_COORD1\n\t\tv_uvs1 = a_coord1;\n\t#endif\n\t#ifdef BLOCK_VERTEX_COLOR\n\t\tv_vertex_color = a_color;\n\t#endif\n\t\n\t//local deforms\n\t{{vs_local}}\n\tapplyMorphing( vertex4, v_normal );\n\tapplySkinning( vertex4, v_normal );\n\t\n\t//vertex\n\tv_pos = (u_model * vertex4).xyz;\n\t\n\tapplyLight(v_pos);\n\t\n\t//normal\n\t#ifdef BLOCK_INSTANCING\n\t\tv_normal = (u_model * vec4(v_normal,0.0)).xyz;\n\t#else\n\t\tv_normal = (u_normal_model * vec4(v_normal,0.0)).xyz;\n\t#endif\n\t//world deform\n\t{{vs_global}}\n\t\n\t#pragma event "vs_final_pass"\n\t\n\tgl_Position = u_viewprojection * vec4(v_pos,1.0);\n\tgl_PointSize = u_point_size;\n\tv_screenpos = gl_Position;\n\t#pragma event "vs_final"\n}\n\n\\color.fs\n\n#ifdef DRAW_BUFFERS\n\t#extension GL_EXT_draw_buffers : require \n#endif\n\nprecision mediump float;\n\n//global defines from blocks\n#pragma shaderblock "vertex_color"\n#pragma shaderblock "coord1"\n//#pragma shaderblock "firstPass"\n//#pragma shaderblock "lastPass"\n\n//varyings\nvarying vec3 v_pos;\nvarying vec3 v_normal;\nvarying vec2 v_uvs;\nvarying vec3 v_local_pos;\nvarying vec3 v_local_normal;\n#ifdef BLOCK_COORD1\n\tvarying vec2 v_uvs1;\n#endif\n#ifdef BLOCK_VERTEX_COLOR\n\tvarying vec4 v_vertex_color;\n#endif\nvarying vec4 v_screenpos;\n\n//globals\nuniform vec4 u_viewport;\nuniform mat4 u_view;\nuniform vec3 u_camera_eye;\nuniform vec4 u_clipping_plane;\nuniform vec4 u_background_color;\nuniform vec4 u_material_color;\n\nuniform vec3 u_ambient_color;\nuniform vec4 u_emissive_color;\nuniform vec4 u_specular;\nuniform vec2 u_reflection_info;\nuniform vec4 u_velvet_info;\nuniform vec2 u_normal_info;\nuniform vec3 u_detail_info;\nuniform mat3 u_texture_matrix;\nuniform vec4 u_extra_color;\nuniform float u_backlight_factor;\nuniform float u_translucency;\n\nuniform sampler2D color_texture;\nuniform sampler2D opacity_texture;\nuniform sampler2D specular_texture;\nuniform sampler2D ambient_texture;\nuniform sampler2D emissive_texture;\nuniform sampler2D reflectivity_texture;\nuniform sampler2D detail_texture;\nuniform sampler2D normal_texture;\nuniform sampler2D extra_texture;\n\n\n#pragma snippet "input"\n#pragma shaderblock "light"\n#pragma shaderblock "light_texture"\n#pragma shaderblock "applyReflection"\n#pragma shaderblock "normalBuffer"\n\n#pragma snippet "perturbNormal"\n\n#pragma shaderblock "extraBuffers"\n\n\nuniform int u_texture_settings[11];\n\nvec2 uvs[5];\nvec2 getUVs(int index)\n{\n\tif(index == 0)\n\t\treturn uvs[0];\n\tif(index == 1)\n\t\treturn uvs[1];\n\tif(index == 2)\n\t\treturn uvs[2];\n\tif(index == 3)\n\t\treturn uvs[3];\n\tif(index == 4)\n\t\treturn uvs[4];\n\treturn uvs[0];\n}\n\n\nvoid surf(in Input IN, out SurfaceOutput o)\n{\n\to.Albedo = u_material_color.xyz;\n\to.Alpha = u_material_color.a;\n\t#ifdef BLOCK_VERTEX_COLOR\n\to.Albedo *= IN.color.xyz;\n\to.Alpha *= IN.color.a;\n\t#endif\n\to.Normal = normalize( v_normal );\n\to.Specular = u_specular.x;\n\to.Gloss = u_specular.y;\n\to.Ambient = u_ambient_color;\n\to.Emission = u_emissive_color.xyz;\n\to.Reflectivity = u_reflection_info.x;\n\to.Extra = u_extra_color;\n\t\n\t{{fs}}\n\t\n\tif(u_velvet_info.w > 0.0)\n\t\to.Albedo += u_velvet_info.xyz * ( 1.0 - pow( max(0.0, dot( IN.viewDir, o.Normal )), u_velvet_info.w ));\n\telse if(u_velvet_info.w < 0.0)\n\t\to.Albedo = mix( o.Albedo, u_velvet_info.xyz, 1.0 - pow( max(0.0, dot( IN.viewDir, o.Normal )), abs(u_velvet_info.w) ) );\n\tif(u_emissive_color.w > 0.0)\n\t\to.Emission *= o.Albedo;\n\to.Reflectivity *= max(0.0, pow( 1.0 - clamp(0.0, dot(IN.viewDir,o.Normal),1.0), u_reflection_info.y ));\n}\n\n#pragma event "fs_functions"\n#pragma snippet "testClippingPlane"\n\n{{fs_out}}\n\nvoid main() {\n\tInput IN = getInput();\n\tif(testClippingPlane(u_clipping_plane,IN.worldPos) < 0.0)\n\t\tdiscard;\n\t\n\tIN.vertex = v_local_pos;\n\tIN.normal = v_local_normal;\n\tSurfaceOutput o = getSurfaceOutput();\n\t#ifdef BLOCK_VERTEX_COLOR\n\t\tIN.color = v_vertex_color;\n\t#endif\n\t#ifdef BLOCK_COORD1\n\t\tIN.uv1 = v_uvs1;\n\t#endif\n\tsurf(IN,o);\n\tLight LIGHT = getLight();\n\tapplyLightTexture( IN, LIGHT );\n\tif( !gl_FrontFacing )\n\t\to.Normal *= -1.0;\n\tFinalLight FINALLIGHT = computeLight( o, IN, LIGHT );\n\tFINALLIGHT.Diffuse += u_backlight_factor * max(0.0, dot(FINALLIGHT.Vector, -o.Normal));\n\tFINALLIGHT.Diffuse = mix(FINALLIGHT.Diffuse,1.0, u_translucency);\n\tvec4 final_color = vec4( 0.0,0.0,0.0, o.Alpha );\n\t#ifdef SPEC_ON_ALPHA\n\t\tfinal_color.a += FINALLIGHT.Specular;\n\t#endif\n\t#ifdef SPEC_ON_TOP\n\t\tfloat specular = FINALLIGHT.Specular;\n\t\tFINALLIGHT.Specular = 0.0;\n\t#endif\n\tfinal_color.xyz = applyLight( o, FINALLIGHT );\n\t#ifdef SPEC_ON_TOP\n\t\tfinal_color.xyz += specular * LIGHT.Color * FINALLIGHT.Shadow;\n\t#endif\n\tfinal_color = applyReflection( IN, o, final_color );\n\t#pragma event "fs_final_pass"\n\t{{fs_encode}}\n\t#ifdef DRAW_BUFFERS\n\t  gl_FragData[0] = final_color;\n\t  #ifdef BLOCK_FIRSTPASS\n\t\t  #ifdef BLOCK_NORMALBUFFER\n\t\t\t  gl_FragData[1] = vec4( o.Normal * 0.5 + vec3(0.5), 1.0 );\n\t\t  #else\n\t\t\t  gl_FragData[1] = o.Extra;\n\t\t  #endif\n\t  #else\n\t\t  gl_FragData[1] = vec4(0.0);\n\t #endif\n\t#else\n\t  gl_FragColor = final_color;\n\t#endif\n\t#pragma event "fs_final"\n}\n\n\\shadow.fs\n\nprecision mediump float;\n\n//varyings\nvarying vec3 v_pos;\nvarying vec3 v_normal;\nvarying vec2 v_uvs;\nvarying vec4 v_screenpos;\nvarying vec3 v_local_pos;\nvarying vec3 v_local_normal;\n\n//globals\nuniform vec4 u_viewport;\nuniform vec3 u_camera_eye;\nuniform vec2 u_camera_planes;\nuniform vec4 u_clipping_plane;\nuniform vec4 u_material_color;\n\nuniform mat3 u_texture_matrix;\n\n\nuniform int u_texture_settings[11];\n\nvec2 uvs[5];\nvec2 getUVs(int index)\n{\n\tif(index == 0)\n\t\treturn uvs[0];\n\tif(index == 1)\n\t\treturn uvs[1];\n\tif(index == 2)\n\t\treturn uvs[2];\n\tif(index == 3)\n\t\treturn uvs[3];\n\tif(index == 4)\n\t\treturn uvs[4];\n\treturn uvs[0];\n}\n\n\n\nuniform sampler2D color_texture;\nuniform sampler2D opacity_texture;\n\n#pragma snippet "input"\n#pragma snippet "surface"\n#pragma snippet "PackDepth32"\n\nvoid surf(in Input IN, out SurfaceOutput o)\n{\n\to.Albedo = u_material_color.xyz;\n\to.Alpha = u_material_color.a;\n\t\n\t{{fs_shadows}}\n}\n\n{{fs_shadow_out}}\n\nvoid main() {\n\tInput IN = getInput();\n\tIN.vertex = v_local_pos;\n\tIN.normal = v_local_normal;\n\tSurfaceOutput o = getSurfaceOutput();\n\tsurf(IN,o);\n\t//float depth = length( IN.worldPos - u_camera_eye );\n\t//depth = linearDepth( depth, u_camera_planes.x, u_camera_planes.y );\n\tfloat depth = (v_screenpos.z / v_screenpos.w) * 0.5 + 0.5;\n\t//depth = linearDepthNormalized( depth, u_camera_planes.x, u_camera_planes.y );\n\tvec4 final_color;\n\tfinal_color = PackDepth32(depth);\n\t{{fs_shadow_encode}}\n\tgl_FragColor = final_color;\n}\n\\picking.fs\n\tprecision mediump float;\n\tvarying vec4 v_screenpos;\n\tuniform vec2 u_camera_planes;\n\tuniform vec4 u_material_color;\n\tvoid main() {\n\t\tfloat n = u_camera_planes.x;\n\t\tfloat f = u_camera_planes.y;\n\t\tfloat z = v_screenpos.z / v_screenpos.w * 0.5 + 0.5;\n\t\t//float linear = n * (z + 1.0) / (f + n - z * (f - n));\n\t\tgl_FragColor = vec4( u_material_color.xyz, gl_FragCoord.z );\n\t}\n';
ua.description="This material allows to control the surface properties by coding your own shader in GLSL.\nYou dont have to worry about the complexities of the render engine and light equation, just the surface properties for every pixel.";ua.prototype.prepare=I.prototype.prepare;ua.icon="mini-icon-material.png";ua.prototype.onCodeChange=function(){this._mustUpdate=!0};Object.defineProperty(ua.prototype,"code",{enumerable:!0,get:function(){return this._code},set:function(a){this._code=String(a);this._mustUpdate=
!0}});ua.prototype.getCode=function(){return this._code};ua.prototype.computeCode=function(){for(var a="",b=0,c=this.properties.length;b<c;++b){var e="uniform ",g=this.properties[b];switch(g.type){case "number":e+="float ";break;case "vec2":e+="vec2 ";break;case "color":case "vec3":e+="vec3 ";break;case "color4":case "vec4":e+="vec4 ";break;case "sampler":case "texture":e+="sampler2D ";break;case "cubemap":e+="samplerCube ";break;default:continue}e+=g.name+";\n";a+=e}this.surf_code=a+"\n"+this._code;
a=d.ShaderCode.replaceCode(d.SurfaceMaterial.code_template,{fs_out:this.surf_code});this._shadercode||(this._shadercode=new d.ShaderCode);this._shadercode.code=a;this._mustUpdate=!1};ua.prototype.renderInstance=M.prototype.renderInstance;ua.prototype.getShaderCode=function(a,b,c){this._shadercode&&!this._mustUpdate||this.computeCode();return this._shadercode};ua.prototype.fillUniforms=function(a,b){for(var c=this._samplers,e=c.length=0,d=0,f=this.properties.length;d<f;++d){var h=this.properties[d];
"texture"==h.type||"cubemap"==h.type||"sampler"==h.type?(c[e]=h.value,this._uniforms[h.name]=e,e++):this._uniforms[h.name]=h.value}this._uniforms.u_material_color=this._color};ua.prototype.configure=function(a){void 0!==a.flags&&a.flags.constructor===Number&&delete a.flags;B.prototype.configure.call(this,a);a.properties&&(this.properties=d.cloneObject(a.properties));this.computeCode()};ua.prototype.getPropertiesInfo=function(){var a={color:d.TYPES.VEC3,opacity:d.TYPES.NUMBER,shader_name:d.TYPES.STRING,
blend_mode:d.TYPES.NUMBER,code:d.TYPES.STRING},b;for(b in this.properties){var c=this.properties[b];a[c.name]=c.type}return a};ua.prototype.onResourceRenamed=function(a,b,c){B.prototype.onResourceRenamed.call(this,a,b,c);c=0;for(var e=this.properties.length;c<e;++c){var d=this.properties[c];d.value==a&&(d.value=b)}};ua.prototype.getProperty=function(a){if(this[a])return this[a];if("tex_"==a.substr(0,4))return(a=this.textures[a.substr(4)])?a.texture:null;for(var b=0,c=this.properties.length;b<c;++b){var e=
this.properties[b];if(e.name==a)return e.value}return null};ua.prototype.setProperty=function(a,b){if(B.prototype.setProperty.call(this,a,b))return!0;"shader_name"==a&&(this.shader_name=b);for(var c=0,e=this.properties.length;c<e;++c){var d=this.properties[c];if(d.name==a)return d.value=b,!0}if(void 0!==this[a])this[a]=b;else return!1;return!0};ua.prototype.getPropertyInfoFromPath=function(a){if(!(1>a.length)){var b=B.prototype.getPropertyInfoFromPath.call(this,a);if(b)return b;a=a[0];for(var b=0,
c=this.properties.length;b<c;++b){var e=this.properties[b];if(e.name==a)return{node:this._root,target:this,name:e.name,value:e.value,type:e.type}}}};ua.prototype.getTextureChannels=function(){for(var a=[],b=0,c=this.properties.length;b<c;++b){var e=this.properties[b];"texture"!=e.type&&"cubemap"!=e.type&&"sampler"!=e.type||a.push(e.name)}return a};ua.prototype.setTexture=function(a,b,c){if(!a)throw"SurfaceMaterial.prototype.setTexture channel must be specified";var e=null;if("environment"==a)return B.prototype.setTexture.call(this,
a,b,c);for(var g=0;g<this.properties.length;++g){var f=this.properties[g];if("texture"==f.type||"cubemap"==f.type||"sampler"==f.type)if(!a||f.name==a){(e=this.textures[a])||(e=this.textures[a]={texture:b,uvs:"0",wrap:0,minFilter:0,magFilter:0});if(c)for(g in c)e[g]=c[g];f.value="sampler"==f.type?e:b;break}}b&&b.constructor==String&&":"!=b[0]&&d.ResourcesManager.load(b);return e};ua.prototype.getResources=function(a){for(var b=0,c=this.properties.length;b<c;++b){var e=this.properties[b];"texture"!=
e.type&&"cubemap"!=e.type&&"sampler"!=e.type||!e.value||(e="sampler"==e.type?e.value.texture:e.value,"string"==typeof e&&(a[e]=GL.Texture))}return a};d.registerMaterialClass(ua);d.SurfaceMaterial=ua;ua.code_template='\n\n\n\\color.vs\n\nprecision mediump float;\nattribute vec3 a_vertex;\nattribute vec3 a_normal;\nattribute vec2 a_coord;\n#pragma shaderblock "vertex_color"\n#pragma shaderblock "coord1"\n#ifdef BLOCK_COORD1\n\tattribute vec2 a_coord1;\n\tvarying vec2 v_uvs1;\n#endif\n#ifdef BLOCK_VERTEX_COLOR\n\tattribute vec4 a_color;\n\tvarying vec4 v_vertex_color;\n#endif\n\n//varyings\nvarying vec3 v_pos;\nvarying vec3 v_normal;\nvarying vec2 v_uvs;\nvarying vec3 v_local_pos;\nvarying vec3 v_local_normal;\n\n//matrices\nuniform mat4 u_model;\nuniform mat4 u_normal_model;\nuniform mat4 u_view;\nuniform mat4 u_viewprojection;\n\n//globals\nuniform float u_time;\nuniform vec4 u_viewport;\nuniform float u_point_size;\n\n#pragma snippet "input"\n#pragma shaderblock "light"\n#pragma shaderblock "morphing"\n#pragma shaderblock "skinning"\n\n//camera\nuniform vec3 u_camera_eye;\n{{vs_out}}\nvoid main() {\n\t\n\tvec4 vertex4 = vec4(a_vertex,1.0);\n\tv_local_pos = a_vertex;\n\tv_local_normal = a_normal;\n\tv_normal = a_normal;\n\tv_uvs = a_coord;\n\t#ifdef BLOCK_COORD1\n\t\tv_uvs1 = a_coord1;\n\t#endif\n\t#ifdef BLOCK_VERTEX_COLOR\n\t\tv_vertex_color = a_color;\n\t#endif\n  \n  //deforms\n  {{vs_local}}\n  applyMorphing( vertex4, v_normal );\n  applySkinning( vertex4, v_normal );\n\t\n\t//vertex\n\tv_pos = (u_model * vertex4).xyz;\n  \n  applyLight(v_pos);\n  \n\t//normal\n\tv_normal = (u_normal_model * vec4(v_normal,0.0)).xyz;\n    {{vs_global}}\n\tgl_Position = u_viewprojection * vec4(v_pos,1.0);\n}\n\n\\color.fs\n\nprecision mediump float;\n\n//varyings\nvarying vec3 v_pos;\nvarying vec3 v_normal;\nvarying vec3 v_local_pos;\nvarying vec3 v_local_normal;\nvarying vec2 v_uvs;\n#pragma shaderblock "vertex_color"\n#pragma shaderblock "coord1"\n#ifdef BLOCK_COORD1\n\tvarying vec2 v_uvs1;\n#endif\n#ifdef BLOCK_VERTEX_COLOR\n\tvarying vec4 v_vertex_color;\n#endif\n\n//globals\nuniform vec3 u_camera_eye;\nuniform vec4 u_clipping_plane;\nuniform float u_time;\nuniform vec4 u_background_color;\nuniform vec4 u_material_color;\n\n#pragma snippet "input"\n#pragma shaderblock "light"\n#pragma shaderblock "applyReflection"\n\n#pragma snippet "perturbNormal"\n#pragma snippet "testClippingPlane"\n\n{{fs_out}}\n\nvoid main() {\n\tInput IN = getInput();\n\tif(testClippingPlane(u_clipping_plane,IN.worldPos) < 0.0)\n\t\tdiscard;\n\t\n\tIN.vertex = v_local_pos;\n\tIN.normal = v_local_normal;\n\t#ifdef BLOCK_VERTEX_COLOR\n\t\tIN.color = v_vertex_color;\n\t#endif\n\t#ifdef BLOCK_COORD1\n\t\tIN.uv1 = v_uvs1;\n\t#endif\n\tSurfaceOutput o = getSurfaceOutput();\n\tsurf(IN,o);\n\tvec4 final_color = vec4(0.0);\n\tLight LIGHT = getLight();\n\tFinalLight final_light = computeLight( o, IN, LIGHT );\n\tfinal_color.xyz = applyLight( o, final_light );\n\tfinal_color.a = o.Alpha;\n\tif( o.Reflectivity > 0.0 )\n\t\tfinal_color = applyReflection( IN, o, final_color );\n\t\n\tgl_FragColor = final_color;\n}\n\n\\shadow.vs\n\nprecision mediump float;\nattribute vec3 a_vertex;\nattribute vec3 a_normal;\nattribute vec2 a_coord;\n#ifdef USE_COLORS\nattribute vec4 a_color;\n#endif\n\n//varyings\nvarying vec3 v_pos;\nvarying vec3 v_normal;\nvarying vec3 v_local_pos;\nvarying vec3 v_local_normal;\nvarying vec2 v_uvs;\n\n//matrices\nuniform mat4 u_model;\nuniform mat4 u_normal_model;\nuniform mat4 u_view;\nuniform mat4 u_viewprojection;\n\n//globals\nuniform float u_time;\nuniform vec4 u_viewport;\nuniform float u_point_size;\n\n#pragma snippet "input"\n#pragma shaderblock "light"\n#pragma shaderblock "morphing"\n#pragma shaderblock "skinning"\n\n//camera\nuniform vec3 u_camera_eye;\n{{vs_out}}\nvoid main() {\n\t\n\tvec4 vertex4 = vec4(a_vertex,1.0);\n\tv_local_pos = a_vertex;\n\tv_local_normal = a_normal;\n\tv_normal = a_normal;\n\tv_uvs = a_coord;\n  \n  //deforms\n  {{vs_local}}\n  applyMorphing( vertex4, v_normal );\n  applySkinning( vertex4, v_normal );\n\t\n\t//vertex\n\tv_pos = (u_model * vertex4).xyz;\n  \n  applyLight(v_pos);\n  \n\t//normal\n\tv_normal = (u_normal_model * vec4(v_normal,0.0)).xyz;\n    {{vs_global}}\n\tgl_Position = u_viewprojection * vec4(v_pos,1.0);\n}\n\\shadow.fs\n\nprecision mediump float;\n\n//varyings\nvarying vec3 v_pos;\nvarying vec3 v_normal;\nvarying vec2 v_uvs;\nvarying vec3 v_local_pos;\nvarying vec3 v_local_normal;\n\n//globals\nuniform vec3 u_camera_eye;\nuniform vec4 u_clipping_plane;\nuniform vec4 u_material_color;\n\nuniform mat3 u_texture_matrix;\n\n#pragma snippet "input"\n#pragma snippet "surface"\n#pragma snippet "perturbNormal"\n#define SHADOWMAP\n\n{{fs_out}}\n\nvoid main() {\n\tInput IN = getInput();\n\tIN.vertex = v_local_pos;\n\tIN.normal = v_local_normal;\n\tSurfaceOutput o = getSurfaceOutput();\n\tsurf(IN,o);\n\tgl_FragColor = vec4(o.Albedo,o.Alpha);\n}\n';
$.icon="mini-icon-graph.png";$["@filename"]={type:"resource",data_type:"graph"};$.prototype.renderInstance=M.prototype.renderInstance;$.prototype.renderShadowInstance=M.prototype.renderShadowInstance;$.prototype.renderPickingInstance=M.prototype.renderPickingInstance;$.valid_properties="float vec2 vec3 vec4 color texture".split(" ");$.description="This material allows to design the shader using the build-in visual graph designer, this helps prototyping materials very fast.";Object.defineProperty($.prototype,
"filename",{enumerable:!1,get:function(){return this._filename},set:function(a){this._filename==a&&(a&&this._graphcode||!a&&!this._graphcode)||(a&&(a=d.ResourcesManager.cleanFullpath(a)),this._filename=a,this._loading=!1,this.processGraph())}});Object.defineProperty($.prototype,"graphcode",{enumerable:!1,get:function(){return this._graphcode},set:function(a){this._loading=!1;this._filename=(this._graphcode=a)?this._graphcode.fullpath||this._graphcode.filename:null;this.processGraph()}});Object.defineProperty($.prototype,
"graph",{enumerable:!1,get:function(){return this._graphcode?this._graphcode.graph:null},set:function(a){throw"graph cannot be set to a material, you must assign a graphcode instead";}});$.shader_codes={};$.prototype.getShaderCode=function(a,b,c){if(!this._graphcode)return null;a=this._graphcode.graph;if(!a)return null;if(this._shader_code&&this._code_version==a._version)return this._shader_code;this._shader_code||(this._shader_code=new d.ShaderCode);if(!this._context){if("undefined"!=typeof LiteGraph&&
LiteGraph.ShaderContext)this._context=new LiteGraph.ShaderContext,this._context.buffer_names={position:"v_pos",normal:"v_normal",local_position:"v_local_pos",local_normal:"v_local_normal",color:"v_color",uvs:"v_uvs"};else return console.error("LiteGraph or LiteGraph glshaders not found. You must include it."),null;this._context.material=this}b=this.getUniformsInfo();b=this._context.computeCodeBlocks(a,b);if(!b)return null;b=GL.Shader.replaceCodeUsingContext($.code_template,b);if(b==a._last_code)return this._code_version=
a._version,this._shader_code;a._last_code=b;this._shader_code.code=b;this._code_version=a._version;return this._shader_code};$.prototype.getResources=function(a){for(var b=0;b<this._properties.length;++b){var c=this._properties[b];"texture"==c.type&&c.value&&(a[c.value]=GL.Texture)}if(!this._graphcode)return a;a[this.filename]=!0;this._graphcode&&this._graphcode.graph.sendEventToAllNodes("getResources",a);return a};$.prototype.serialize=function(){return{uid:this.uid,material_class:d.getObjectClassName(this),
filename:this.filename,properties:d.cloneObject(this._properties)}};$.prototype.configure=function(a){d.cloneObject(a,this);if(a.properties)for(this._properties=d.cloneObject(a.properties),a=0;a<this._properties.length;++a){var b=this._properties[a];this._properties_by_name[b.name]=b}this.processGraph()};$.prototype.processGraph=function(a,b){if(this._filename){var c=this;this._graphcode=d.ResourcesManager.getResource(this._filename);this._graphcode||this._loading||(this._loading=!0,d.ResourcesManager.load(this._filename,
null,function(a,d){this._loading=!1;d==c.filename&&(a&&a.type==Ka.SHADER_GRAPH?c._graphcode=a:console.error("Shader Graph not found or not a Shader Graph"),b&&b(c))}))}else this._graphcode=null};$.prototype.updatePropertiesFromGraph=function(){var a=[],b={},c=this._graphcode;if(c)for(var e=0;e<c.properties.length;++e){var g=c.properties[e],f=this._properties_by_name[g.name],f=f&&f.type==g.type?f.value:d.cloneObject(g.value),f={name:g.name,type:g.type,widget:g.widget||null,value:f};a.push(f);b[g.name]=
f}this._properties=a;this._properties_by_name=b};$.prototype.getUniformsInfo=function(){var a={},b;for(b in this._properties){var c=this._properties[b],e=c.type;"texture"==e?e="sampler2D":"number"==e?e="float":"color"==e?e="vec3":"color4"==e&&(e="vec4");a["u_"+c.name]=e}return a};$.prototype.fillUniforms=function(){if(this._context){var a=0,b;for(b in this._properties){var c=this._properties[b];if("texture"==c.type){var e=a++;this._samplers[e]=c.value||":white";this._uniforms["u_"+c.name]=e}else this._uniforms["u_"+
c.name]=c.value}this._context.fillUniforms(this._uniforms)}};$.prototype.getProperties=function(){if(!this.graph)return null;for(var a={},b=0;b<this._properties.length;++b){var c=this._properties[b];a[c.name]=c.type}return a};$.prototype.onResourceRenamed=function(a,b,c){B.prototype.onResourceRenamed.call(this,a,b,c);for(var e in this._properties)c=this._properties[e],c.value==a&&(c.value=b)};$.prototype.getProperty=function(a){if(this[a])return this[a];if("tex_"==a.substr(0,4))return this.textures[a.substr(4)];
for(var b in this._properties){var c=this._properties[b];if(c.name==a)return c.value}return null};$.prototype.setProperty=function(a,b){if(B.prototype.setProperty.call(this,a,b))return!0;for(var c in this._properties){var e=this._properties[c];if(e.name==a)return e.value=b,!0}return!1};$.prototype.getTextureChannels=function(){var a=[],b;for(b in this._properties){var c=this._properties[b];"texture"!=c.type&&"cubemap"!=c.type||a.push(c.name)}return a};$.prototype.setTexture=function(a,b,c){for(var e in this._properties)if(c=
this._properties[e],"texture"==c.type||"cubemap"==c.type)if(!b||c.name==b)if(c.value=a,this.textures&&(this.textures[b]=a),!b)break;a&&a.constructor==String&&":"!=a[0]&&zc.load(a)};d.registerMaterialClass($);d.GraphMaterial=$;$.default_graph={last_node_id:3,last_link_id:2,nodes:[{id:3,type:"shader::output/fragcolor",pos:[579,339],size:[140,26],flags:{},order:0,mode:0,inputs:[{name:"color",type:"float,vec2,vec3,vec4",link:null}],properties:{}}],links:[],groups:[],config:{},extra:{},version:0.4};$.node_types=
{uniform:"shader::input/uniform"};$.code_template='\n\n\\default.vs\n\nprecision mediump float;\n#define VERTEX\nattribute vec3 a_vertex;\nattribute vec3 a_normal;\nattribute vec2 a_coord;\n#pragma shaderblock "vertex_color"\n#pragma shaderblock "coord1"\n#ifdef BLOCK_COORD1\n\tattribute vec2 a_coord1;\n\tvarying vec2 v_uvs1;\n#endif\n#ifdef BLOCK_VERTEX_COLOR\n\tattribute vec4 a_color;\n\tvarying vec4 v_vertex_color;\n#endif\n#pragma shaderblock "instancing"\n\n//varyings\nvarying vec3 v_pos;\nvarying vec3 v_normal;\nvarying vec2 v_uvs;\nvarying vec3 v_local_pos;\nvarying vec3 v_local_normal;\nvarying vec4 v_screenpos;\n\n//matrices\n#ifdef BLOCK_INSTANCING\n\tattribute mat4 u_model;\n\tvarying mat4 v_model;\n\t//varying float v_instance_id;\n#else\n\tuniform mat4 u_model;\n#endif\nuniform mat4 u_normal_model;\nuniform mat4 u_view;\nuniform mat4 u_viewprojection;\n\n//globals\nuniform float u_time;\nuniform vec4 u_viewport;\nuniform float u_point_size;\n\n#pragma shaderblock "morphing"\n#pragma shaderblock "skinning"\n\n//camera\nuniform vec3 u_camera_eye;\n{{uniforms}}\n{{functions}}\n{{vs_out}}\nvoid main() {\n\t\n\tvec4 vertex4 = vec4(a_vertex,1.0);\n\tv_local_pos = a_vertex;\n\tv_local_normal = a_normal;\n\tv_normal = a_normal;\n\tv_uvs = a_coord;\n\t#ifdef BLOCK_COORD1\n\t\tv_uvs1 = a_coord1;\n\t#endif\n\t#ifdef BLOCK_VERTEX_COLOR\n\t\tv_vertex_color = a_color;\n\t#endif\n  \n  //deforms\n  {{vs_local}}\n  applyMorphing( vertex4, v_normal );\n  applySkinning( vertex4, v_normal );\n\t\n\t//vertex\n\tv_pos = (u_model * vertex4).xyz;\n  \n  \n\t//normal\n\t#ifdef BLOCK_INSTANCING\n\t\tv_normal = (u_model * vec4(v_normal,0.0)).xyz;\n\t\t//v_instance_id = gl_InstanceID;\n\t#else\n\t\tv_normal = (u_normal_model * vec4(v_normal,0.0)).xyz;\n\t#endif\n\t{{vs_global}}\n\t{{vs_code}}\n\tv_screenpos = u_viewprojection * vec4(v_pos,1.0);\n\tgl_Position = v_screenpos;\n}\n\n\\color.fs\n\n#ifdef DRAW_BUFFERS\n\t#extension GL_EXT_draw_buffers : require \n#endif\nprecision mediump float;\n#define FRAGMENT\n\n//varyings\nvarying vec3 v_pos;\nvarying vec3 v_normal;\nvarying vec3 v_local_pos;\nvarying vec3 v_local_normal;\nvarying vec2 v_uvs;\n#pragma shaderblock "vertex_color"\n#pragma shaderblock "coord1"\n#ifdef BLOCK_COORD1\n\tvarying vec2 v_uvs1;\n#endif\n#ifdef BLOCK_VERTEX_COLOR\n\tvarying vec4 v_vertex_color;\n#endif\nvarying vec4 v_screenpos;\n#pragma shaderblock "instancing"\n\n//globals\nuniform vec3 u_camera_eye;\nuniform vec4 u_clipping_plane;\nuniform vec4 u_viewport;\nuniform float u_time;\nuniform vec4 u_background_color;\nuniform vec4 u_material_color;\n#ifdef BLOCK_INSTANCING\n\tmat4 u_model;\n\tvarying mat4 v_model;\n\t//varying v_instance_id;\n#else\n\tuniform mat4 u_model;\n\t//float v_instance_id;\n#endif\nuniform mat4 u_normal_model;\nuniform mat4 u_view;\nuniform mat4 u_viewprojection;\n#pragma snippet "input"\n\n#pragma snippet "testClippingPlane"\n\n{{uniforms}}\n{{functions}}\n{{fs_out}}\n\nvoid main() {\n\tInput IN = getInput();\n\tif(testClippingPlane(u_clipping_plane,IN.worldPos) < 0.0)\n\t\tdiscard;\n\t\n\t#ifdef BLOCK_INSTANCING\n\t\tu_model = v_model;\n\t#else\n\t\t//v_instance_id = 0.0;\n\t#endif\n\tIN.vertex = v_local_pos;\n\tIN.normal = v_local_normal;\n\t#ifdef BLOCK_VERTEX_COLOR\n\t\tIN.color = v_vertex_color;\n\t#endif\n\t#ifdef BLOCK_COORD1\n\t\tIN.uv1 = v_uvs1;\n\t#endif\n\tvec4 fragcolor = vec4(1.0);\n\tvec4 fragcolor1 = vec4(0.0);\n{{fs_code}}\n\t\n\t#ifdef DRAW_BUFFERS\n\t  gl_FragData[0] = fragcolor;\n\t  #ifdef BLOCK_FIRSTPASS\n\t\t  #ifdef BLOCK_NORMALBUFFER\n\t\t\t  gl_FragData[1] = vec4( o.Normal * 0.5 + vec3(0.5), 1.0 );\n\t\t  #else\n\t\t\t  gl_FragData[1] = fragcolor1;\n\t\t  #endif\n\t  #else\n\t\t  gl_FragData[1] = vec4(0.0);\n\t #endif\n\t#else\n\t  gl_FragColor = fragcolor;\n\t#endif\n}\n\n\\shadow.fs\n\nprecision mediump float;\n#define FRAGMENT\n\n//varyings\nvarying vec3 v_pos;\nvarying vec3 v_normal;\nvarying vec2 v_uvs;\nvarying vec3 v_local_pos;\nvarying vec3 v_local_normal;\nvarying vec4 v_screenpos;\n#pragma shaderblock "instancing"\n\n//globals\nuniform vec4 u_viewport;\nuniform vec3 u_camera_eye;\nuniform vec4 u_clipping_plane;\nuniform vec4 u_material_color;\n\nuniform mat3 u_texture_matrix;\n\n#pragma snippet "input"\n#pragma snippet "surface"\n#pragma snippet "perturbNormal"\n#define SHADOWMAP\n\n{{fs_out}}\n\nvoid main() {\n\tInput IN = getInput();\n\tIN.vertex = v_local_pos;\n\tIN.normal = v_local_normal;\n\tgl_FragColor = vec4(u_material_color);\n}\n';
Ca.prototype.configureComponents=function(a){if(a.components){for(var b=[],c=0,e=a.components.length;c<e;++c){var g=a.components[c],f=g[0],h=null;"Transform"==f&&0==c&&this.transform?h=this.transform:(h=d.Components[f],h||(console.error("Unknown component found: "+f),h=d.MissingComponent),h=new h,this.addComponent(h),h.constructor===d.MissingComponent&&(h._comp_class=f));b.push(h,g[1]);h.constructor===d.Components.ScriptFromFile&&(h._filename=g[1].filename);g[1].editor&&(h._editor=g[1].editor);g[1].uid&&
g[1].uid!==h.uid&&(h.uid=g[1].uid)}c=0;for(e=b.length;c<e;c+=2)if(h=b[c],a=b[c+1],d.catch_exceptions)try{h.configure(a)}catch(k){console.error("Error found when configuring node of type ",d.getObjectClassName(h),", skipping. All data for this component is lost."),console.error(k)}else h.configure(a)}};Ca.prototype.serializeComponents=function(a,b){if(this._components){a.components=[];for(var c=0,e=this._components.length;c<e;++c){var g=this._components[c];if(g.serialize&&!g.skip_serialize){var f=
g.serialize(b);g._editor&&!b&&(f.editor=g._editor);g.hasOwnProperty("_uid")&&!f.uid&&(f.uid=g.uid);var h=null,h=g.constructor===d.MissingComponent?g._comp_class:d.getObjectClassName(g);d.debug&&h!=f.object_class&&console.warn("Component serialize without object_class: ",h);f.object_class||(f.object_class=h);a.components.push([h,f])}}}};Ca.prototype.getComponents=function(a){if(a){var b=[];a.constructor===String&&(a=d.Components[a]);for(var c=0,e=this._components.length;c<e;++c){var g=this._components[c];
g.constructor===a&&b.push(g)}return b}return this._components};Ca.prototype.addComponent=function(a,b){if(!a)throw"addComponent cannot receive null";if(a.constructor===String&&(a=d.Components[a],!a))throw"component class not found: "+a;a.is_component&&(a=new a);a._root=this;a.uid||(a.uid=d.generateUId("COMP-"));if(a.onAddedToNode)a.onAddedToNode(this);if(this._in_tree&&(a.uid?this._in_tree._components_by_uid[a.uid]=a:console.warn("component without uid?",a),a.onAddedToScene))a.onAddedToScene(this.constructor==
d.Scene?this:this._in_tree);this._components||Object.defineProperty(this,"_components",{value:[],enumerable:!1});if(-1!=this._components.indexOf(a))throw"inserting the same component twice";void 0!==b&&b<=this._components.length?this._components.splice(b,0,a):this._components.push(a);LEvent.trigger(this,"componentAdded",a);return a};Ca.prototype.removeComponent=function(a){if(!a)throw"removeComponent cannot receive null";a._root=null;if(a.onRemovedFromNode)a.onRemovedFromNode(this);if(this._in_tree&&
(delete this._in_tree._components_by_uid[a.uid],a.onRemovedFromScene))a.onRemovedFromScene(this._in_tree);LEvent.unbindAll(this,a);var b=this._components.indexOf(a);-1!=b?this._components.splice(b,1):console.warn("removeComponent: Component not found in node");LEvent.trigger(this,"componentRemoved",a)};Ca.prototype.removeAllComponents=function(){for(;this._components.length;)this.removeComponent(this._components[0])};Ca.prototype.hasComponent=function(a){if(!this._components||a.constructor===String&&
(a=d.Components[a],!a))return!1;for(var b=0,c=this._components.length;b<c;++b)if(this._components[b].constructor===a)return!0;return!1};Ca.prototype.getComponent=function(a,b){if(!this._components||!a)return null;if(a.constructor===String){if("_"==a[0]){a=a.substr(1);for(var c=0,e=this._components.length;c<e;++c)if(this._components[c].name==a)if(void 0!==b&&0<b)b--;else return this._components[c];return!1}a=d.Components[a];if(!a)return}c=0;for(e=this._components.length;c<e;++c)if(this._components[c].constructor===
a)if(void 0!==b&&0<b)b--;else return this._components[c];return null};Ca.prototype.getComponentByUId=function(a){if(!this._components)return null;for(var b=0,c=this._components.length;b<c;++b)if(this._components[b].uid==a)return this._components[b];return null};Ca.prototype.getIndexOfComponent=function(a){return this._components?this._components.indexOf(a):-1};Ca.prototype.getComponentByIndex=function(a){return this._components?this._components[a]:null};Ca.prototype.findComponents=function(a,b){b=
b||[];if(!a)return b;a.constructor===String&&(a=d.Components[a]);if(!a)return b;for(var c=0;c<this._components.length;++c){var e=this._components[c];e&&e.constructor===a&&b.push(e)}if(this._children)for(c=0;c<this._children.length;++c)this._children[c].findComponents(a,b);return b};Ca.prototype.setComponentIndex=function(a,b){if(!this._components)return null;0>b&&(b=0);var c=this._components.indexOf(a);-1!=c&&(this._components.splice(c,1),b>=this._components.length?this._components.push(a):this._components.splice(b,
0,a))};Ca.prototype.requireComponent=function(a,b){if(!a)throw"no component class specified";if(a.constructor===String&&(a=d.Components[a],!a))return console.error("component class not found:",a),null;for(var c=this._components.length,e=0;e<c;++e)if(this._components[e].constructor===a)return this._components[e];e=new a;this.addComponent(e,c);b&&e.configure(b);return e};Ca.prototype.requireScript=function(a){if(!a)throw"no url specified";var b=d.Components.ScriptFromFile;a=d.ResourcesManager.cleanFullpath(a);
for(var c=this._components.length,e=0;e<c;++e){var g=this._components[e];if(g.constructor===b&&g._filename==a)return g}b=new b;b.filename=a;this.addComponent(b,c);return b};Ca.prototype.processActionInComponents=function(a,b,c){if(this._components&&this._components.length)for(var e=0,d=this._components.length;e<d;++e){var f=this._components[e];f[a]&&f[a].constructor===Function?b&&b.constructor===Array?f[a].apply(f,b):f[a].call(f,b):c||(f.callMethod?f.callMethod(a,b,!0):f._script&&f._script.callMethod(a,
b,!0))}};Ca.prototype.broadcastMessage=function(a,b){this.processActionInComponents(a,b);if(this._children&&this._children.length)for(var c=0,e=this._children.length;c<e;++c)this._children[c].broadcastMessage(a,b)};qa.prototype.compositeCtor=function(){this._in_tree=this._children=this._parentNode=null};qa.prototype.addChild=function(a,b,c){function e(a){if(a._children)for(var b in a._children){var c=a._children[b];c._in_tree||(LEvent.trigger(f,"treeItemAdded",c),c._in_tree=f);e(c)}}if(!a)throw"cannot addChild of null";
if(a.constructor!==this.constructor)throw"added child must be of the same type";for(var d=this;d._parentNode;){if(d==a)return console.error("addChild: Cannot insert a node as his own child"),!1;d=d._parentNode}a._parentNode&&a._parentNode==this._parentNode&&void 0!==b&&this._parentNode._children.indexOf(a)<b&&b--;a._parentNode&&a._parentNode.removeChild(a,c);a._parentNode=this;this._children?void 0==b?this._children.push(a):this._children.splice(b,0,a):this._children=[a];var f=this._in_tree;if(f&&
a._in_tree&&a._in_tree!=f)throw"Cannot add a node that belongs to another scene tree";a._in_tree=f;this._onChildAdded&&this._onChildAdded(a,c);LEvent.trigger(this,"childAdded",a);f&&(LEvent.trigger(f,"treeItemAdded",a),e(a))};qa.prototype.removeChild=function(a,b,c){function e(a){if(a._children)for(var b=0,c=a._children.length;b<c;++b){var d=a._children[b];d._in_tree&&(LEvent.trigger(d._in_tree,"treeItemRemoved",d),d._in_tree=null);e(d)}}if(!a)throw"cannot removeChild of null";if(!this._children||
a._parentNode!=this||a._parentNode!=this)return!1;var d=this._children.indexOf(a);if(-1==d)return!1;this._children.splice(d,1);this._onChildRemoved&&this._onChildRemoved(a,b,c);LEvent.trigger(this,"childRemoved",a);a._in_tree&&(LEvent.trigger(a._in_tree,"treeItemRemoved",a),e(a));a._in_tree=null;return!0};qa.prototype.removeAllChildren=function(a,b){if(this._children)for(;this._children.length;)this.removeChild(this._children[0],a,b)};qa.prototype.serializeChildren=function(a){var b=[];if(this._children)for(var c in this._children)b.push(this._children[c].serialize(!1,
a));return b};qa.prototype.configureChildren=function(a,b){if(a.children)for(var c=0;c<a.children.length;++c){var e=a.children[c],d=new this.constructor(e.id);e.uid&&(d.uid=e.uid);e.editor&&(d._editor=e.editor);this.addChild(d);d.configure(e,b)}};qa.prototype.getParent=function(){return this._parentNode};qa.prototype.getChildren=function(){return this._children||[]};qa.prototype.getChildIndex=function(a){return this._children?this._children.indexOf(a):-1};qa.prototype.getChildByIndex=function(a){return this._children&&
this._children.length>a?this._children[a]:null};qa.prototype.getChildByName=function(a){if(!this._children)return null;for(var b=0;b<this._children.length;++b)if(this._children[b].name==a)return this._children[b];return null};qa.prototype.getPathName=function(){if(!this._in_tree)return null;if(this===this._in_tree.root)return"";for(var a=this.name,b=this._parentNode;b;){if(b===this._in_tree.root)return a;a=b.name+"|"+a;b=b._parentNode}return null};Object.defineProperty(qa.prototype,"childNodes",{enumerable:!0,
get:function(){return this._children||[]},set:function(a){}});Object.defineProperty(qa.prototype,"parentNode",{enumerable:!0,get:function(){return this._parentNode},set:function(a){throw"parentNode cannot be assigned, use parent.addChild(node) instead.";}});Object.defineProperty(qa.prototype,"scene",{enumerable:!0,get:function(){return this._in_tree},set:function(a){throw"Scene cannot be set, you must use addChild in parent";}});qa.prototype.getAncestors=function(a){var b=[],c=this._parentNode;for(a&&
b.push(this);c;)b.push(c),c=c._parentNode;return b};qa.prototype.getDescendants=function(){if(!this._children||0==this._children.length)return[];for(var a=this._children.concat(),b=0;b<this._children.length;++b)a=a.concat(this._children[b].getDescendants());return a};qa.prototype.moveBefore=function(a){if(!this._parentNode||a&&this._parentNode!==a._parentNode)return-1;var b=this._parentNode._children,c=b.indexOf(this);if(-1==c)throw"moveBefore node not found in parent, this is impossible";var e=c-
1;if(a){e=b.indexOf(a);if(-1==e)return-1;e-=1}if(c==e||0>e)return e;b.splice(c,1);e>c&&(e-=1);b.splice(e,0,this);LEvent.trigger(this._in_tree,"node_rearranged",this);return e};qa.prototype.moveAfter=function(a){if(!this._parentNode||a&&this._parentNode!==a._parentNode)return-1;var b=this._parentNode._children,c=b.indexOf(this);if(-1==c)throw"moveBefore node not found in parent, this is impossible";var e=c+1;if(a){e=b.indexOf(a);if(-1==e)return-1;e+=1}if(c==e||e>=b.length)return e;b.splice(c,1);e>
c&&(e-=1);b.splice(e,0,this);LEvent.trigger(this._in_tree,"node_rearranged",this);return e};qa.prototype.findNode=function(a){return""==a?this:a?a.charAt(0)!=d._uid_prefix?this.findNodeByName(a):this.findNodeByUId(a):null};qa.prototype.findNodeByName=function(a){if(!a)return null;if(this.name==a)return this;var b=this._children;if(b)for(var c=0,e=b.length;c<e;++c){var d=b[c];if(d.name==a||d._children&&(d=d.findNodeByName(a)))return d}return null};qa.prototype.findNodeByUId=function(a){if(!a)return null;
if(this.uid==a)return this;var b=this._children;if(b)for(var c=0;c<b.length;++c){var e=b[c];if(e.uid==a||e._children&&(e=e.findNodeByUId(a)))return e}return null};qa.prototype.getHierarchyLevel=function(){return this._parentNode?this._parentNode.getHierarchyLevel()+1:0};Pa.prototype.getRootNode=function(){return this._root};Pa.prototype.configure=function(a){if(a&&(a.uid&&(this.uid=a.uid),d.cloneObject(a,this,!1,!0,!0),this.onConfigure))this.onConfigure(a)};Pa.prototype.serialize=function(){var a=
d.cloneObject(this,null,!1,!1,!0);this.uid&&(a.uid=this.uid);a.object_class||(a.object_class=d.getObjectClassName(this));if(this.onSerialize)this.onSerialize(a);return a};Pa.prototype.clone=function(){var a=this.serialize();a.uid=null;return new this.constructor(a)};Pa.prototype.createProperty=function(a,b,c,e,g){if(void 0===this[a]){if(c){if("String"==c||"Number"==c||"Boolean"==c)console.warn("createProperty: Basic types must be in lowercase -> "+c),c=c.toLowerCase();this.constructor["@"+a]="object"==
typeof c?c:{type:c};if(c==d.TYPES.COMPONENT||d.Components[c]||c.constructor.is_component||c.type==d.TYPES.COMPONENT){var f="_"+a;Object.defineProperty(this,a,{get:function(){return this[f]?Oa.get(this[f],null,this._root&&this._root.scene?this._root._in_tree:d.GlobalScene):null},set:function(a){this[f]=a?a.constructor===String?a:a.uid:a},enumerable:!0});if(d.Components[c]||c.constructor.is_component)c={type:d.TYPES.COMPONENT,component_class:c.constructor===String?c:d.getClassName(c)};this.constructor["@"+
a]="object"==typeof c?c:{type:c};return}}null!==b&&void 0!==b&&b.constructor!==Number&&b.constructor!==String&&b.constructor!==Boolean||e||g?(f="_"+a,Object.hasOwnProperty(this,f)||(c=this,b&&b.constructor===Float32Array?(b=new Float32Array(b),this[f]=b,Object.defineProperty(c,a,{get:g||function(){return b},set:e||function(a){b.set(a)},enumerable:!0})):(Object.defineProperty(c,f,{value:b,enumerable:!1,writable:!0}),Object.defineProperty(c,a,{get:g||function(){return this[f]},set:e||function(a){this[f]=
a},enumerable:!0})))):this[a]=b}};Pa.prototype.createAction=function(a,b,c){b||console.error("action '"+a+"' with no callback associated. Remember to create the action after the callback is defined.");var e=a.replace(/ /gi,"_");this[e]=b;this.constructor["@"+e]=c||{type:"function",button_text:a,widget:"button",callback:b}};Pa.prototype.getLocator=function(a){return this._root?a?(void 0===this[a]&&console.warn("No property found in this component with that name:",a),this._root.uid+"/"+this.uid+"/"+
a):this._root.uid+"/"+this.uid:""};Pa.prototype.getPropertyInfoFromPath=function(a){if(!a.length)return null;var b,c=a[0];this.getPropertyValue&&(b=this.getPropertyValue(c));if(void 0===b&&1<a.length&&this[c]&&this[c].getPropertyInfoFromPath&&(a=this[c].getPropertyInfoFromPath(a.slice(1))))return a.node=this.root,a;if(void 0===b&&Object.hasOwnProperty(this,c))return null;b=void 0!==b?b:this[c];a=this.constructor["@"+c];var e="";a&&(e=a.type);e||null===b||void 0===b||(b.constructor===String?e="string":
b.constructor===Boolean?e="boolean":b.length?e="vec"+b.length:b.constructor===Number&&(e="number"));return{node:this.root,target:this,name:c,value:b,type:e}};Pa.prototype.broadcastMessage=function(a,b){var c=this._root;c&&c.broadcastMessage(a,b)};Pa.prototype.getComponent=function(a){return this._root?this._root.getComponent(a):null};Pa.prototype.bind=function(a,b,c){if(3<arguments.length)console.error("Component.bind cannot use a fourth parameter, all callbacks will be binded to the component");
else if(a){if(c)return this.__targeted_instances||Object.defineProperty(this,"__targeted_instances",{value:[],enumerable:!1,writable:!0}),-1==this.__targeted_instances.indexOf(a)&&this.__targeted_instances.push(a),LEvent.bind(a,b,c,this);console.error("You cannot bind a method before defining it.")}else console.error("Cannot bind to null.")};Pa.prototype.unbind=function(a,b,c){b=LEvent.unbind(a,b,c,this);if(this.__targeted_instances){if(!LEvent.hasBindTo(a,this))return b;a=this.__targeted_instances.indexOf(a);
-1==a&&this.__targeted_instances.splice(a,1);0==this.__targeted_instances.length&&delete this.__targeted_instances}return b};Pa.prototype.unbindAll=function(){if(this.__targeted_instances){for(var a=0;a<this.__targeted_instances.length;++a)LEvent.unbindAll(this.__targeted_instances[a],this);this.__targeted_instances=null}};Pa.addExtraMethods=function(a){Object.defineProperty(a.prototype,"uid",{set:function(a){a&&(a[0]!=d._uid_prefix&&(console.warn("Invalid UID, renaming it to: "+a),a=d._uid_prefix+
a),a!=this._uid&&(this._uid=a))},get:function(){return this._uid},enumerable:!1});Object.defineProperty(a.prototype,"root",{set:function(a){throw"root cannot be set, call addComponent to the root";},get:function(){return this._root},enumerable:!1});Object.defineProperty(a.prototype,"parentNode",{set:function(){throw"parentNode cannot be set, call addComponent to the parentNode";},get:function(){return this._root},enumerable:!1})};d.BaseComponent=Pa;gc.prototype.configure=function(a){this.uid=a.uid;
this._last_serialization=a};gc.prototype.serialize=function(){return this._last_serialization};d.MissingComponent=gc;q.INIT="init";q.CLEAR="clear";q.PRECONFIGURE="preConfigure";q.CONFIGURE="configure";q.CHANGE="change";q.BEFORE_LOAD="beforeLoad";q.LOAD="load";q.LOAD_COMPLETED="load_completed";q.BEFORE_RELOAD="beforeReload";q.RELOAD="reload";q.AWAKE="awake";q.START="start";q.PAUSE="pause";q.UNPAUSE="unpause";q.FINISH="finish";q.BEFORE_UPDATE="before_update";q.UPDATE="update";q.FIXED_UPDATE="fixedUpdate";
q.AFTER_UPDATE="afterUpdate";q.COLLECT_RENDER_INSTANCES="collectRenderInstances";q.COLLECT_PHYSIC_INSTANCES="collectPhysicInstances";q.COLLECT_LIGHTS="collectLights";q.COLLECT_CAMERAS="collectCameras";q.COLLECT_DATA="collectData";q.SERIALIZE="serialize";q.NODE_ADDED="nodeAdded";q.NODE_REMOVED="nodeRemoved";q.REQUEST_FRAME="requestFrame";Object.defineProperty(y.prototype,"root",{enumerable:!0,get:function(){return this._root},set:function(a){throw"Root node cannot be replaced";}});Object.defineProperty(y.prototype,
"time",{enumerable:!0,get:function(){return this._time},set:function(a){throw"Cannot set time directly";}});Object.defineProperty(y.prototype,"state",{enumerable:!0,get:function(){return this._state},set:function(a){throw"Cannot set state directly, use start, finish, pause, unpause";}});Object.defineProperty(y.prototype,"globalTime",{enumerable:!0,get:function(){return this._global_time},set:function(a){throw"Cannot set global_time directly";}});Object.defineProperty(y.prototype,"frame",{enumerable:!0,
get:function(){return this._frame},set:function(a){throw"Cannot set frame directly";}});y.supported_events=[d.EVENT.START,d.EVENT.UPDATE,d.EVENT.FINISH,d.EVENT.CLEAR,d.EVENT.BEFORE_RELOAD,d.EVENT.CHANGE,q.AFTER_RENDER,d.EVENT.CONFIGURE,q.NODE_ADDED,"nodeChangeParent","nodeComponentRemoved",d.EVENT.RELOAD,"renderPicking","scene_loaded",d.EVENT.SERIALIZE];y.prototype.init=function(){this.id="";this.external_repository=null;this.global_scripts=[];this.external_scripts=[];this.preloaded_resources={};
this.texture_atlas=null;this._root.removeAllComponents();this._root.uid=d.generateUId("NODE-");this._nodes=[this._root];this._nodes_by_name={root:this._root};this._nodes_by_uid={};this._nodes_by_uid[this._root.uid]=this._root;this._components_by_uid={};this._spatial_container.clear();this.info=new d.Components.GlobalInfo;this._root.addComponent(this.info);this._root.addComponent(new d.Camera({eye:[0,100,100],center:[0,0,0]}));this._root.addComponent(new d.Light({position:vec3.fromValues(100,100,100),
target:vec3.fromValues(0,0,0)}));this._frame=0;this._last_collect_frame=-1;this._state=d.STOPPED;this._start_time=this._global_time=this._time=0;this._last_dt=1/60;this._must_redraw=!0;this._fixed_update_timestep=1/60;this._remaining_fixed_update_time=0;this.selected_node&&delete this.selected_node;this.layer_names=["main","secondary"];this.animation=null;this._local_resources={};this.extra={}};y.prototype.clear=function(){for(;this._root._children&&this._root._children.length;)this._root.removeChild(this._root._children[0],
!1,!0);this._root.processActionInComponents("onRemovedFromNode",this);this._root.processActionInComponents("onRemovedFromScene",this);this._instances.length=0;this._lights.length=0;this._cameras.length=0;this._colliders.length=0;this._reflection_probes.length=0;this._local_resources={};this.init();LEvent.trigger(this,q.CLEAR);LEvent.trigger(this,q.CHANGE)};y.prototype.configure=function(a){if(!a||a.constructor===String)throw"Scene configure requires object";LEvent.trigger(this,q.PRECONFIGURE,a);this._root.removeAllComponents();
a.uid&&(this.uid=a.uid);"Scene"!=(a.object_class||a.object_type)&&console.warn("Warning: object set to scene doesnt look like a propper one.",a);a.external_repository&&(this.external_repository=a.external_repository);a.extra&&(this.extra=a.extra);if(a.root){this._spatial_container.clear();var b=[];d._pending_encoded_objects=[];this._root.configure(a.root,b);for(var c=0;c<b.length;c+=2)b[c].configureComponents(b[c+1]);d.resolvePendingEncodedObjects()}a.global_scripts&&(this.global_scripts=a.global_scripts.concat());
a.external_scripts&&(this.external_scripts=a.external_scripts.concat());a.preloaded_resources&&(this.preloaded_resources=d.cloneObject(a.preloaded_resources));a.local_resources&&(this._local_resources=a.local_resources);a.layer_names&&(this.layer_names=a.layer_names.concat());a.animation&&(this.animation=new d.Animation(a.animation));a.editor&&(this._editor=a.editor);a.texture_atlas&&(this.texture_atlas=a.texture_atlas);LEvent.trigger(this,q.CONFIGURE,a);LEvent.trigger(this,q.AWAKE);LEvent.trigger(this,
q.CHANGE)};y.prototype.serialize=function(a){var b={};b.version=d.Version;b.uid=this.uid;b.object_class=d.getObjectClassName(this);b.external_repository=this.external_repository;b.extra=this.extra||{};b.root=this.root.serialize(!1,a);this.animation&&(b.animation=this.animation.serialize());b.layer_names=this.layer_names.concat();b.global_scripts=this.global_scripts.concat();b.external_scripts=this.external_scripts.concat();b.preloaded_resources=d.cloneObject(this.preloaded_resources);b.texture_atlas=
d.cloneObject(this.texture_atlas);b.local_resources=d.cloneObject(this._local_resources);this._editor&&(b.editor=this._editor);LEvent.trigger(this,q.SERIALIZE,b);return b};y.prototype.setFromJSON=function(a,b,c,e,g,f){function h(a){f&&f(p,a);p.init();p.configure(a);p.texture_atlas?d.RM.loadTextureAtlas(p.texture_atlas,k):k()}function k(){p.loadResources(l);LEvent.trigger(p,q.LOAD);d.ResourcesManager.isLoading()||l();b&&b(p)}function l(){g&&g(p);LEvent.trigger(p,q.LOAD_COMPLETED)}function m(a,b){console.error("Error loading script: "+
b);c&&c(a)}if(a){var p=this;if(a.constructor===String)try{a=JSON.parse(a)}catch(n){console.log("Error: "+n);return}e=d.Scene.getScriptsList(a,!0);this.external_scripts=a.external_scripts;e.length?this.loadScripts(e,function(){h(a)},m):h(a)}};y.prototype.load=function(a,b,c,e,g,f){function h(b){d.ResourcesManager.processResource(a,b,null,k)}function k(a,b){if(b)if("Scene"==b.object_class)l(b);else if("SceneNode"==b.object_class){var c=b.serialize();l({object_class:"Scene",root:c})}else b._data&&b._data["scene.json"]?
(c=JSON.parse(b._data["scene.json"]),l(c)):console.error("Error loading PACK, doesnt look like it has a valid scene inside")}function l(a){if(a.constructor!==Object)throw"response must be object";var b=d.Scene.getScriptsList(a,!0);b.length?r.loadScripts(b,function(){m(a)},c):m(a)}function m(c){f&&f(r,a);r.init();r.configure(c);b&&b(r,a);r.loadResources(p);LEvent.trigger(r,q.LOAD);d.ResourcesManager.isLoading()||p()}function p(){g&&g(r,a);LEvent.trigger(r,q.LOAD_COMPLETED)}function n(b){var e=b&&b.target?
b.target.status:0;console.warn("Error loading scene: "+a+" -> "+e);c&&c(a,e,b)}if(a){var r=this,t=d.ResourcesManager.getExtension(a),x=d.Formats.getFileFormatInfo(t);x||(x={dataType:"json"});d.Network.request({url:a,nocache:!0,dataType:"json"==t?"json":x.dataType||"text",success:"json"==t?l:h,progress:e,error:n});this._state=d.LOADING;LEvent.trigger(this,q.BEFORE_LOAD)}};y.prototype.loadFromResources=function(a,b,c,e,g){a=d.ResourcesManager.getFullURL(a);this.load(a,b,c,e,g)};y.getScriptsList=function(a,
b,c){if(!a)throw"Scene.getScriptsList: scene cannot be null";var e=[];a.external_scripts&&a.external_scripts.length&&(e=e.concat(a.external_scripts));if(a.global_scripts&&a.global_scripts.length)for(var g in a.global_scripts){var f=a.global_scripts[g];f&&"js"==d.ResourcesManager.getExtension(f)&&(d.ResourcesManager.getResource(f)&&b&&(f=d.ResourcesManager.cleanFullpath(f)),c&&(f=d.ResourcesManager.getFullURL(f)),e.push(f))}return e=e.map(function(a){return a.trim()})};y.prototype.loadScripts=function(a,
b,c,e){function g(){for(var a in h)URL.revokeObjectURL(h[a]);b&&b()}if(d.allow_scripts)if(a=a||d.Scene.getScriptsList(this,!0),a.length)if(d._block_scripts)console.error("Safety: ONE.block_scripts enabled, cannot request script");else{var f=[],h=[],k;for(k in a){var l=a[k];if(-1==this.external_scripts.indexOf(l)){var m=d.ResourcesManager.getResource(l);!m||e?(l=d.ResourcesManager.getFullURL(l),f.push(l)):(l=new Blob([m.data],{encoding:"UTF-8",type:"text/plain;charset=UTF-8"}),l=URL.createObjectURL(l),
f.push(l),h.push(l))}else f.push(l)}d.Network.requestScript(f,g,c)}else b&&b();else console.error("LiteScene.allow_scripts is set to false, so scripts imported into this scene are ignored."),b&&b()};y.prototype.checkComponentsCodeModification=function(){for(var a=0;a<this._nodes.length;++a)for(var b=this._nodes[a],c=0;c<b._components.length;++c){var e=b._components[c],g=d.getObjectClassName(e);e.constructor==d.MissingComponent&&(g=e._comp_class);var f=d.Components[g];if(f&&f!=e.constructor){var h=
e.serialize(),f=new f(h),h=b.getIndexOfComponent(e);b.removeComponent(e);b.addComponent(f,h);console.log("Class replaced: "+g)}}};y.prototype.appendScene=function(a){a=a.root.childNodes;for(var b in a){var c=a[b],e=new d.SceneNode(c.id);this.root.addChild(e);e.configure(c.constructor==d.SceneNode?c.serialize():c)}};y.prototype.getCamera=function(){var a=this._root.camera;if(a)return a;if(this._cameras&&this._cameras.length)return this._cameras[0];this.collectData();return this._cameras[0]};y.prototype.getActiveCameras=
function(a){a&&LEvent.trigger(this,q.COLLECT_CAMERAS,this._cameras);return this._cameras};y.prototype.getAllCameras=function(){for(var a=[],b=0;b<this._nodes.length;++b){var c=this._nodes[b].getComponents(d.Components.Camera);c&&c.length&&(a=a.concat(c))}return a};y.prototype.getLight=function(){return this._root.light};y.prototype.getActiveLights=function(a){a&&LEvent.trigger(this,q.COLLECT_LIGHTS,this._lights);return this._lights};y.prototype.onNodeAdded=function(a,b){if(b._in_tree&&b._in_tree!=
this)throw"Cannot add a node from other scene, clone it";b._name&&!this._nodes_by_name[b._name]&&(this._nodes_by_name[b._name]=b);if(!b.uid||this._nodes_by_uid[b.uid])b._uid=d.generateUId("NODE-");this._nodes_by_uid[b.uid]=b;this._nodes.push(b);b.processActionInComponents("onAddedToScene",this);for(var c=0;c<b._components.length;++c)b._components[c].uid?this._components_by_uid[b._components[c].uid]=b._components[c]:console.warn("component without uid?",b._components[c].uid);LEvent.trigger(this,q.NODE_ADDED,
b);LEvent.trigger(this,q.CHANGE)};y.prototype.onNodeRemoved=function(a,b){var c=this._nodes.indexOf(b);if(-1!=c){this._nodes.splice(c,1);b._name&&this._nodes_by_name[b._name]==b&&delete this._nodes_by_name[b._name];b.uid&&delete this._nodes_by_uid[b.uid];b.processActionInComponents("onRemovedFromScene",this);for(c=0;c<b._components.length;++c)delete this._components_by_uid[b._components[c].uid];LEvent.trigger(this,q.NODE_REMOVED,b);LEvent.trigger(this,q.CHANGE);return!0}};y.prototype.recomputeNodesArray=
function(){function a(e){b[c]=e;c+=1;if(e._children&&e._children.length)for(var d=0;d<e._children.length;++d)a(e._children[d])}var b=this._nodes,c=0;a(this._root)};y.prototype.attachSceneElement=function(a){this._spatial_container.add(a)};y.prototype.detachSceneElement=function(a){this._spatial_container.remove(a)};y.prototype.getNodes=function(a){a&&this.recomputeNodesArray();return this._nodes};y.prototype.getNode=function(a){if(""==a)return this.root;if(!a||a.constructor!==String)return null;if(a.charAt(0)==
d._uid_prefix)return this._nodes_by_uid[a];if(-1!=a.indexOf("|")){a=a.split("|");for(var b=this.root,c=0;c<a.length&&b;++c)b=b.getChildByName(a[c]);return b}return this._nodes_by_name[a]};y.prototype.getNodeByName=function(a){return this._nodes_by_name[a]};y.prototype.getNodeByUId=function(a){return this._nodes_by_uid[a]};y.prototype.getNodeByIndex=function(a){return this._nodes[a]};y.prototype.getElementById=y.prototype.getNode;y.prototype.filterNodes=function(a){for(var b=[],c=0;c<this._nodes.length;++c)a(this._nodes[c])&&
b.push(this._nodes[c]);return b};y.prototype.findComponentByUId=function(a){for(var b=0;b<this._nodes.length;++b){var c=this._nodes[b].getComponentByUId(a);if(c)return c}return null};y.prototype.findMaterialByUId=function(a){if(d.RM.materials[a])return d.RM.materials[a];for(var b=0;b<this._nodes.length;++b){var c=this._nodes[b].getMaterial();if(c&&c.uid==a)return c}return null};y.prototype.getPropertyInfo=function(a){a=a.split("/");var b=a[0].substr(0,5);return"@RES-"==b?(b=d.ResourcesManager.convertLocatorToFilename(a[0]),
b=d.ResourcesManager.getResource(b),1==a.length?b:b&&b.getPropertyInfoFromPath?b.getPropertyInfoFromPath(a.slice(1)):null):"@MAT-"==b?(b=d.RM.materials_by_uid[a[0]])?b.getPropertyInfoFromPath(a.slice(1)):null:"@COMP"==b?(b=this.findComponentByUId(a[0]))?1==a.length?{node:b.root,target:b,name:b?d.getObjectClassName(b):"",type:"component",value:b}:b.getPropertyInfoFromPath(a.slice(1)):null:(b=this.getNode(a[0]))?b.getPropertyInfoFromPath(a.slice(1)):null};y.prototype.getPropertyInfoFromPath=function(a){var b=
a[0].substr(0,5);return"@RES-"==b?(b=d.ResourcesManager.convertLocatorToFilename(a[0]),b=d.ResourcesManager.getResource(b),1==a.length?b:b&&b.getPropertyInfoFromPath?b.getPropertyInfoFromPath(a.slice(1)):null):"@MAT-"==b?(b=d.RM.materials_by_uid[a[0]])?b.getPropertyInfoFromPath(a.slice(1)):null:(b=this.getNode(a[0]))?b.getPropertyInfoFromPath(a.slice(1)):null};y.prototype.getPropertyValue=function(a,b){var c=a.split("/");return b?b.getPropertyValueFromPath(c):this.getPropertyValueFromPath(c)};y.prototype.getPropertyValueFromPath=
function(a){var b=a[0].substr(0,5);return"@RES-"==b?(b=d.ResourcesManager.convertLocatorToFilename(a[0]),b=d.ResourcesManager.getResource(b),1==a.length?b:b&&b.getPropertyInfoFromPath?b.getPropertyInfoFromPath(a.slice(1)):null):"@MAT-"==b?(b=d.RM.materials_by_uid[a[0]])?b.getPropertyValueFromPath(a.slice(1)):null:(b=this.getNode(a[0]))?b.getPropertyValueFromPath(a.slice(1)):null};y.prototype.setPropertyValue=function(a,b,c){a=a.split("/");this.setPropertyValueFromPath(a,b,c,0)};y.prototype.setPropertyValueFromPath=
function(a,b,c,e){e=e||0;if(!(a.length<e+1)){var g=a[e].substr(0,5);if("@RES-"==g)return c=d.ResourcesManager.convertLocatorToFilename(a[0]),c=d.ResourcesManager.getResource(c),1==a.length?(console.warn("assigning a value to a locator with only the name of a resource doesn't make any sense"),null):c&&c.setPropertyValueFromPath?c.setPropertyValueFromPath(a,b,e+1):null;if("@MAT-"==g)return(c=d.RM.materials_by_uid[a[e]])?c.setPropertyValueFromPath(a,b,e+1):null;g=null;if(c)if(g=a[e],-1!=g.indexOf("|")){var f=
g.split("|"),g=c;for(c=0;c<f.length&&g;++c)g=g.getChildByName(f[c])}else g=c.findNode(a[e]);else g=this.getNode(a[e]);return g?g.setPropertyValueFromPath(a,b,e+1):null}};y.prototype.getResources=function(a,b,c,e){a=a||{};var g=null;a.constructor===Array&&(g=a,a={},b=!0);if(this.preloaded_resources)for(var f in this.preloaded_resources)a[f]=!0;this.texture_atlas&&(a[this.texture_atlas.filename]=!0);for(f=0;f<this.global_scripts.length;++f)this.global_scripts[f]&&(a[this.global_scripts[f]]=!0);for(f=
0;f<this._nodes.length;++f)this._nodes[f].getResources(a);if(c)for(f in a)(c=d.ResourcesManager.resources[f])&&c&&(c.from_prefab||c.from_pack)&&delete a[f];if(e)for(f in a)":"==f[0]&&delete a[f];for(f in a)(c=d.ResourcesManager.resources[f])&&c.getResources&&c.getResources(a);delete a[""];delete a["null"];if(!b)return a;b=g||[];for(f in a)b.push(f);return b};y.prototype.loadResources=function(a){function b(){LEvent.unbind(d.ResourcesManager,"end_loading_resources",b);a&&a()}var c=this.getResources([]),
e=0,g;for(g in c)++e;0==e?a&&a():(LEvent.bind(d.ResourcesManager,"end_loading_resources",b),d.ResourcesManager.loadResources(c))};y.prototype.addPreloadResource=function(a){this.preloaded_resources[a]=!0};y.prototype.removePreloadResource=function(a){delete this.preloaded_resources[a]};y.prototype.start=function(){this._state!=d.PLAYING&&(this._state=d.PLAYING,this._start_time=0.001*getTime(),LEvent.trigger(this,q.INIT,this),this.triggerInNodes(q.INIT),LEvent.trigger(this,q.START,this),this.triggerInNodes(q.START))};
y.prototype.pause=function(){this._state==d.PLAYING&&(this._state=d.PAUSED,LEvent.trigger(this,q.PAUSE,this),this.triggerInNodes(q.PAUSE),this.purgeResidualEvents())};y.prototype.unpause=function(){this._state==d.PAUSED&&(this._state=d.PLAYING,LEvent.trigger(this,q.UNPAUSE,this),this.triggerInNodes(q.UNPAUSE),this.purgeResidualEvents())};y.prototype.finish=function(){this._state!=d.STOPPED&&(this._state=d.STOPPED,LEvent.trigger(this,q.FINISH,this),this.triggerInNodes(q.FINISH),this.purgeResidualEvents())};
y.prototype.collectData=function(a){var b=this._instances,c=this._lights,e=this._colliders;b.length=0;c.length=0;e.length=0;a&&0!=a.length||(a=this._cameras,a.length=0,LEvent.trigger(this,q.COLLECT_CAMERAS,a));var d=this.getNodes();a=0;for(var f=d.length;a<f;++a){var h=d[a];!1!=h.flags.visible&&(h.transform&&h.transform.updateGlobalMatrix(),h._instances.length=0,LEvent.trigger(h,q.COLLECT_RENDER_INSTANCES,h._instances),LEvent.trigger(h,q.COLLECT_PHYSIC_INSTANCES,e),b.push.apply(b,h._instances))}LEvent.trigger(this,
q.COLLECT_RENDER_INSTANCES,b);LEvent.trigger(this,q.COLLECT_PHYSIC_INSTANCES,e);LEvent.trigger(this,q.COLLECT_LIGHTS,c);LEvent.trigger(this,q.COLLECT_DATA);a=0;for(f=b.length;a<f;++a)c=b[a],c.use_bounding&&c.updateAABB();a=0;for(f=e.length;a<f;++a)e[a].updateAABB();this._last_collect_frame=this._frame};y.prototype.update=function(a){LEvent.trigger(this,d.EVENT.BEFORE_UPDATE,this);this._global_time=0.001*getTime();this._time+=a;this._last_dt=a;LEvent.trigger(this,d.EVENT.UPDATE,a);if(0<this._fixed_update_timestep)if(this._remaining_fixed_update_time+=
a,LEvent.hasBind(this,d.EVENT.FIXED_UPDATE))for(;this._remaining_fixed_update_time>this._fixed_update_timestep;)LEvent.trigger(this,d.EVENT.FIXED_UPDATE,this._fixed_update_timestep),this._remaining_fixed_update_time-=this._fixed_update_timestep;else this._remaining_fixed_update_time%=this._fixed_update_timestep;LEvent.trigger(this,d.EVENT.AFTER_UPDATE,this)};y.prototype.triggerInNodes=function(a,b){LEvent.triggerArray(this._nodes,a,b)};y.prototype.generateUniqueNodeName=function(a){a=a||"node";var b=
1,c=a.lastIndexOf("_");if(c){var e=a.substr(c+1);parseInt(e)&&(b=parseInt(e),a=a.substr(0,c))}for(c=a+"_"+b;null!=this.getNode(c);)c=a+"_"+b++;return c};y.prototype.requestFrame=function(){this._must_redraw=!0;LEvent.trigger(this,d.EVENT.REQUEST_FRAME)};y.prototype.refresh=y.prototype.requestFrame;y.prototype.getTime=function(){return this._time};y.prototype.purgeResidualEvents=function(){if(this.__events)for(var a in this.__events){var b=this.__events[a];if(b){for(var c=[],e=0;e<b.length;++e){var g=
b[e][1];!g||!d.isClassComponent(g.constructor)||g._root&&g._root.scene===this?c.push(b[e]):console.warn("Event attached to the Scene belongs to a removed node, purged. Event:",a,"Class:",d.getObjectClassName(g))}this.__events[a]=c}}};y.prototype.getLayerNames=function(a){for(var b=[],c=0;32>c;++c)(void 0===a||a&1<<c)&&b.push(this.layer_names[c]||"layer"+c);return b};y.prototype.findNodeComponents=function(a){if(a){var b=null;if(b=a.constructor===String?d.Components[a]:a){a=[];for(var c=this._nodes,
e=0;e<c.length;++e)for(var g=c[e]._components,f=0;f<g.length;++f)g[f].constructor===b&&a.push(g[f]);return a}}};y.prototype.instantiate=function(a,b,c,e){if(!a||a.constructor!==String)throw"prefab must be the url to the prefab";var g=new d.SceneNode;b&&3===b.length&&(g.transform.position=b);c&&4===c.length&&(g.transform.rotation=c);e=e||this.root;e.addChild(g);g.prefab=a;return g};y.prototype.toPack=function(a,b){var c=d.RM.removeExtension(a||"unnamed_scene",!0)+".SCENE.wbin",e=JSON.stringify(this.serialize());
b||(b=this.getResources(null,!0,!0,!0));e=d.Pack.createPack(d.RM.getFilename(c),b,{"scene.json":e});e.fullpath=c;e.category="Scene";return e};y.prototype.updateStaticObjects=function(){var a=d.allow_static;d.allow_static=!1;this.collectData();d.allow_static=a};y.prototype.findNearestReflectionProbe=function(a){if(!this._reflection_probes.length)return null;if(1==this._reflection_probes.length)return this._reflection_probes[0];for(var b=this._reflection_probes,c=1E6,e=null,d=0;d<b.length;++d){var f=
b[d],h=vec3.squaredDistance(a,f._position);h>c||(c=h,e=f)}return e};y.prototype.sendResourceRenamedEvent=function(a,b,c){for(var e=0;e<this.external_scripts.length;e++)this.external_scripts[e]==a&&(this.external_scripts[e]=b);for(e=0;e<this.global_scripts.length;e++)this.global_scripts[e]==a&&(this.global_scripts[e]=b);for(e in this.preloaded_resources)e==a&&(delete this.preloaded_resources[a],this.preloaded_resources[b]=!0);this.texture_atlas&&this.texture_atlas.filename==a&&(this.texture_atlas.filename=
b);for(var g=this._nodes.concat(),e=0;e<g.length;e++){var f=g[e];f.prefab&&f.prefab===a&&(f.prefab=b);for(var h=0;h<f._components.length;h++){var k=f._components[h];if(k.onResourceRenamed)k.onResourceRenamed(a,b,c);else for(var l in k)if(k[l]==a){var m=k.constructor["@"+l];m&&(m=m.type||m.widget)&&(m==d.TYPES.RESOURCE||d.ResourceClasses[m])&&(k[l]=b)}}f.material&&(f.material==a?f.material=b:(f=f.getMaterial())&&f.onResourceRenamed?f.onResourceRenamed(a,b,c)&&d.RM.resourceModified(f):console.warn("sendResourceRenamedEvent: Material not found or it didnt have a onResourceRenamed"))}};
y.prototype.getDataPath=function(a){return d.RM.cleanFullpath((this.extra.data_folder||this.extra.folder)+"/"+(a||""))};y.prototype.createAnimation=function(){if(this.animation)return this.animation;this.animation=new d.Animation;this.animation.name=d.Animation.DEFAULT_SCENE_NAME;this.animation.createTake("default",d.Animation.DEFAULT_DURATION);return this.animation};d.Scene=y;d.Classes.Scene=y;d.Classes.SceneTree=y;N.prototype.init=function(a,b){b||(this.layers=3,this._name=name||"node_"+(1E4*Math.random()).toFixed(0),
this._uid=d.generateUId("NODE-"),this._classList={},this._material=null,this.extra={},this.node_type=null,this.flags={visible:!0,is_static:!1,selectable:!0});a||(this._components&&this._components.length&&console.warn("SceneNode.init() should not be called if it contains components, call clear instead"),this._components=[],this.addComponent(new d.Transform))};d.extendClass(N,Ca);d.extendClass(N,qa);Object.defineProperty(N.prototype,"name",{set:function(a){this.setName(a)},get:function(){return this._name},
enumerable:!0});Object.defineProperty(N.prototype,"fullname",{set:function(a){throw"You cannot set fullname, it depends on the parent nodes";},get:function(){return this.getPathName()},enumerable:!1});Object.defineProperty(N.prototype,"uid",{set:function(a){a&&(a[0]!=d._uid_prefix&&(console.warn("Invalid UID, renaming it to: "+a),a=d._uid_prefix+a),a!=this._uid&&(N._last_uid_changed=this._uid,this._in_tree&&this._in_tree._nodes_by_uid[this.uid]&&delete this._in_tree._nodes_by_uid[this.uid],this._uid=
a,this._in_tree&&(this._in_tree._nodes_by_uid[this.uid]=this),LEvent.trigger(this,"uid_changed",a),this._in_tree&&LEvent.trigger(this._in_tree,"node_uid_changed",this)))},get:function(){return this._uid},enumerable:!0});Object.defineProperty(N.prototype,"visible",{set:function(a){this.flags.visible=a;if(this._children)for(var b=0;b<this._children.length;++b)this._children[b].visible=a},get:function(){return this.flags.visible},enumerable:!0});Object.defineProperty(N.prototype,"is_static",{set:function(a){if((this.flags.is_static=
a)&&this._children)for(var b=0;b<this._children.length;++b)this._children[b].is_static=a},get:function(){return this.flags.is_static},enumerable:!0});Object.defineProperty(N.prototype,"material",{set:function(a){if(this._material!=a){if(this._material=a){if(a.constructor===String)return;a._root&&a._root!=this?console.warn("Cannot assign a material of one SceneNode to another, you must clone it or register it"):a._root=this}LEvent.trigger(this,"materialChanged")}},get:function(){return this._material},
enumerable:!0});Object.defineProperty(N.prototype,"prefab",{set:function(a){if(this._prefab=a){var b=this;d.RM.getResource(a)?this.reloadFromPrefab():d.ResourcesManager.load(a,function(){b.reloadFromPrefab()})}},get:function(){return this._prefab},enumerable:!0});N.prototype.clear=function(){this.removeAllComponents();this.removeAllChildren();this.init()};N.prototype.setName=function(a){if(this._name==a)return!0;if(!d.validateName(a))return console.warn("invalid name for node: "+a),!1;var b=this._in_tree;
if(!b)return this._name=a,!0;this._name&&delete b._nodes_by_name[this._name];(this._name=a)&&!b._nodes_by_name[a]&&(b._nodes_by_name[this._name]=this);LEvent.trigger(this,"name_changed",a);b&&LEvent.trigger(b,"node_name_changed",this);return!0};Object.defineProperty(N.prototype,"classList",{get:function(){return this._classList},set:function(a){},enumerable:!1});Object.defineProperty(N.prototype,"className",{get:function(){var a=null;if(Object.keys)a=Object.keys(this._classList);else{var a=[],b;for(b in this._classList)a.push(b)}return a.join(" ")},
set:function(a){this._classList={};if(a){a=a.split(" ");for(var b in a)this._classList[a[b]]=!0}},enumerable:!0});N.prototype.destroy=function(a){if(a&&a.constructor===Number&&0<a)setTimeout(this.destroy.bind(this,0),0.001*a);else{LEvent.trigger(this,"destroy");this.removeAllComponents();if(this.children)for(;this.children.length;)this.children[0].destroy();this._parentNode&&this._parentNode.removeChild(this)}};N.prototype.getLocator=function(a){return a?this.uid+"/"+a:this.uid};N.prototype.getPropertyInfo=
function(a){a=a.split("/");return this.getPropertyInfoFromPath(a)};N.prototype.getPropertyInfoFromPath=function(a){var b=this,c=!1;if(0==a.length)return{node:this,target:null,name:"",value:this,type:"node"};if(1==a.length){if("@"==a[0][0])return b=this.getComponentByUId(a[0]),{node:this,target:b,name:b?d.getObjectClassName(b):"",type:"component",value:b};if("material"==a[0])return b=this.getMaterial(),{node:this,target:b,name:b?d.getObjectClassName(b):"",type:"material",value:b};if("visible"==a[0])return{node:this,
target:this,name:"visible",type:"boolean",value:this.visible};if(b=this.getComponent(a[0]))return{node:this,target:b,name:b?d.getObjectClassName(b):"",type:"component",value:b};switch(a[0]){case "matrix":case "x":case "y":case "z":case "position":case "rotX":case "rotY":case "rotZ":b=this.transform;c=!0;break;default:b=this}}else if(1<a.length&&(b="@"==a[0][0]?this.getComponentByUId(a[0]):"material"==a[0]?this.getMaterial():"flags"==a[0]?this.flags:this.getComponent(a[0]),!b))return null;return b?
b!=this&&b.getPropertyInfoFromPath?b.getPropertyInfoFromPath(c?a:a.slice(1)):null:null};N.prototype.getPropertyValue=function(a){a=a.split("/");return this.getPropertyValueFromPath(a)};N.prototype.getPropertyValueFromPath=function(a){var b=this,c=a[0],e=!1;if(0==a.length)return null;if(1==a.length){if("@"==a[0][0])return this.getComponentByUId(a[0]);if("material"==a[0])return this.getMaterial();if(b=this.getComponent(a[0]))return b;switch(a[0]){case "matrix":case "x":case "y":case "z":case "position":case "rotX":case "rotY":case "rotZ":b=
this.transform;c=a[0];e=!0;break;default:b=this,c=a[0]}}else if(1<a.length&&("@"==a[0][0]?(c=a[1],b=this.getComponentByUId(a[0])):"material"==a[0]?(b=this.getMaterial(),c=a[1]):"flags"==a[0]?(b=this.flags,c=a[1]):"visible"==a[0]?(b=this,c=a[0]):(b=this.getComponent(a[0]),c=a[1]),!b))return null;var d=void 0;if(b.getPropertyValueFromPath&&b!=this){var f=b.getPropertyValueFromPath(e?a:a.slice(1));if(f)return f}b.getPropertyValue&&b!=this&&(d=b.getPropertyValue(c));return void 0===d&&2<a.length&&b[c]&&
b[c].getPropertyValueFromPath&&(f=b[c].getPropertyValueFromPath(e?a.slice(1):a.slice(2)))?(f.node=this,f):void 0===d&&void 0===b[c]?null:void 0!==d?d:b[c]};N.prototype.setPropertyValue=function(a,b){var c=a.split("/");return this.setPropertyValueFromPath(c,b,0)};N.prototype.setPropertyValueFromPath=function(a,b,c){c=c||0;if(!this.flags||!this.flags.locked){var e=null,d=a[c];if(a.length>c+1){if("@"==a[c][0]?(d=a[c+1],e=this.getComponentByUId(a[c])):"material"==a[c]?(e=this.getMaterial(),d=a[c+1]):
"flags"==a[c]?(e=this.flags,d=a[c+1]):"visible"==a[c]?(e=this,d=a[c]):(e=this.getComponent(a[c]),d=a[c+1]),!e)return null}else switch(a[c]){case "matrix":e=this.transform;break;case "position":e=this.transform;d=a[c];break;case "rotation":e=this.transform;d=a[c];break;case "x":case "y":case "z":case "xrotation":case "yrotation":case "zrotation":e=this.transform;d=a[c];break;case "translate.X":e=this.transform;d="x";break;case "translate.Y":e=this.transform;d="y";break;case "translate.Z":e=this.transform;
d="z";break;case "rotateX.ANGLE":e=this.transform;d="pitch";break;case "rotateY.ANGLE":e=this.transform;d="yaw";break;case "rotateZ.ANGLE":e=this.transform;d="roll";break;default:e=this}if(!e)return null;if(e.setPropertyValueFromPath&&e!=this&&!0===e.setPropertyValueFromPath(a,b,c+1)||e.setPropertyValue&&e!=this&&!0===e.setPropertyValue(d,b))return e;if(void 0!==e[d]){if(2<a.length&&e[d]&&e[d].setPropertyValueFromPath)return e[d].setPropertyValueFromPath(a,b,c+2);e[d]=b;return e}}};N.prototype.getResources=
function(a,b){for(var c in this._components){var e=this._components[c];if(e.getResources)e.getResources(a);else for(var g in e)if(e[g]&&e[g].constructor!==Function&&"_"!=g[0]){var f=e.constructor["@"+g];f&&(f=f.type||f.widget)&&(f==d.TYPES.RESOURCE||d.ResourceClasses[f])&&(a[e[g]]=d.ResourceClasses[f])}}this.material&&(this.material.constructor===String&&":"!=this.material[0]&&(a[this.material]=d.Material),(e=this.getMaterial())&&e.getResources(a));this.prefab&&(a[this.prefab]=d.Prefab);if(b)for(c in this._children)this._children[c].getResources(a,
!0);return a};N.prototype.getTransform=function(){return this.transform};N.prototype.getMesh=function(a){var b=this.mesh,c=this.getComponent(d.Components.MeshRenderer);!b&&c&&(a&&(b=c.lod_mesh),b||(b=c.mesh));return b?b.constructor===String?d.ResourcesManager.meshes[b]:b:null};N.prototype.getLight=function(){return this.light};N.prototype.getCamera=function(){return this.camera};N.prototype.load=function(a,b){var c=this;d.ResourcesManager.load(a,function(a){a&&(c.assign(a),b&&b())})};N.prototype.assign=
function(a,b){if(a){if(a.constructor===String&&(a=d.ResourcesManager.getResource(a)),a)switch(a.constructor){case d.SceneNode:this.addChild(a);break;case d.Scene:var c=this;a.loadScripts(null,function(){a.loadResources(function(){c.addChild(a.root.clone())})});break;case d.Prefab:this.prefab=a.fullpath||a.filename;break;case GL.Mesh:var e=this.getComponent(d.Components.MeshRenderer);e?e.configure({mesh:a.fullpath||a.filename}):this.addComponent(new d.MeshRenderer({mesh:mesh_name,submesh_id:submesh_id}));
break;case d.Animation:(e=this.getComponent(d.Components.PlayAnimation))||(e=this.addComponent(new d.Components.PlayAnimation));e.animation=a.fullpath||a.filename;break;case d.Resource:"js"==d.ResourcesManager.getExtension(a.filename)&&((e=this.getComponent(d.Components.ScriptFromFile))||(e=this.addComponent(new d.Components.ScriptFromFile)),e.src=a.fullpath||a.filename);break;default:console.error("feature not supported loading this type of resource",a)}}else console.error("assignResource cannot have null as resource")};
N.prototype.setMesh=function(a,b){var c=this.getComponent(d.Components.MeshRenderer);c?c.configure({mesh:a,submesh_id:b}):this.addComponent(new d.MeshRenderer({mesh:a,submesh_id:b}))};N.prototype.getMaterial=function(){return this.material?this.material.constructor===String?this._in_tree?"@"==this.material[0]?d.ResourcesManager.materials_by_uid[this.material]:d.ResourcesManager.materials[this.material]:null:this.material:null};N.prototype.reloadFromPrefab=function(){if(this.prefab){var a=d.ResourcesManager.resources[this.prefab];
if(a){if(a.constructor!==d.Prefab)throw"prefab must be a ONE.Prefab class";this.removeAllChildren();this.init(!0,!0);var b=a.prefab_data,b={children:a.prefab_data.children};this.configure(b);b=this.getResources({},!0);d.ResourcesManager.loadResources(b);LEvent.trigger(this,"prefabReady",a)}}};N.prototype.setLayer=function(a,b){if(null==a)throw"setLayer expects layer";var c;if(a.constructor===String){if(c=(this.scene||d.GlobalScene).layer_names.indexOf(a),-1==c){console.error("Layer with name:",a,
"not found in scene");return}}else c=a;c=1<<c;this.layers&=~c;b&&(this.layers|=c)};N.prototype.isInLayer=function(a){if(null==a)throw"setLayer expects layer";if(a.constructor===String){var b=(this.scene||d.GlobalScene).layer_names.indexOf(a);if(-1==b){console.error("Layer with name:",a,"not found in scene");return}a=b}return 0!==(this.layers&1<<a)};N.prototype.getLayers=function(){var a=[];if(!this.scene)return a;for(var b=0;32>b;++b)this.layers&1<<b&&a.push(this.scene.layer_names[b]||"layer"+b);
return a};N.prototype.insidePrefab=function(){for(var a=this;a;){if(a.prefab)return a;a=a._parentNode}return null};N.prototype.clone=function(){var a=this._in_tree,a=a?a.generateUniqueNodeName(this._name):this._name,a=new d.SceneNode(a),b=this.serialize();d.clearUIds(b);b.uid=d.generateUId("NODE-");a.configure(b);return a};N.prototype.configure=function(a,b){a.name?this.setName(a.name):a.id&&this.setName(a.id);void 0!==a.layers&&(this.layers=a.layers);a.uid&&(this.uid=a.uid);a.className&&a.className.constructor==
String&&(this.className=a.className);a.node_type&&(this.node_type=a.node_type,"JOINT"==a.node_type&&(this._is_bone=!0));a.camera&&this.addComponent(new d.Camera(a.camera));a.light&&this.addComponent(new d.Light(a.light));if(a.meshes)for(var c=0;c<a.meshes.length;++c)this.addMeshComponents(a.meshes[c],a);else a.mesh&&this.addMeshComponents(a.mesh,a);(a.position||a.model||a.transform)&&!this.transform&&this.addComponent(new d.Transform);a.position&&(this.transform.position=a.position);a.model&&this.transform.fromMatrix(a.model);
a.matrix&&this.transform.fromMatrix(a.matrix);a.transform&&this.transform.configure(a.transform);if(a.material){var e=a.material.material_class;e&&"newStandardMaterial"!=e||(e="StandardMaterial");var g=d.MaterialClasses[e];g?this.material="string"==typeof a.material?a.material:new g(a.material):console.warn("Material not found: "+e)}if(a.flags)for(c in a.flags)this.flags[c]=a.flags[c];a.animation&&(this.animation=a.animation,this.addComponent(new d.Components.PlayAnimation({animation:this.animation})));
a.extra&&(this.extra=a.extra);a.editor&&(this._editor=a.editor);a.comments&&(this.comments=a.comments);a.components&&(b?b.push(this,a):this.configureComponents(a));a.prefab&&!this._is_root?this.prefab=a.prefab:this.configureChildren(a,b);LEvent.trigger(this,"configure",a)};N.prototype.addMeshComponents=function(a,b){b=b||{};if(a){if(a.constructor!==String&&(b=a,a=b.mesh,!a))return console.warn("Mesh info without mesh id"),null;var c=d.ResourcesManager.meshes[a];if(c){var e={mesh:a};void 0!==b.submesh_id&&
(e.submesh_id=b.submesh_id);void 0!==b.morph_targets&&(e.morph_targets=b.morph_targets);void 0!==b.material&&(e.material=b.material);e=new d.Components.MeshRenderer(e);if(c.primitive){switch(c.primitive){case "points":e.primitive=GL.POINTS;break;case "lines":e.primitive=GL.LINES;break;case "line_strip":e.primitive=GL.LINE_STRIP}delete c.primitive}this.addComponent(e);c&&c.bones&&(e=new d.Components.SkinDeformer({search_bones_in_parent:c.search_bones_in_parent||!1}),this.addComponent(e));c&&c.morph_targets&&
(e=new d.Components.MorphDeformer({morph_targets:c.morph_targets}),this.addComponent(e))}else console.warn("SceneNode mesh not found: "+a)}};N.prototype.serialize=function(a,b){var c={object_class:"SceneNode"};this._name&&(c.name=this._name);this.uid&&(c.uid=this.uid);this.className&&(c.className=this.className);c.layers=this.layers;this.node_type&&(c.node_type=this.node_type);this.mesh&&"string"==typeof this.mesh&&(c.mesh=this.mesh);null!=this.submesh_id&&(c.submesh_id=this.submesh_id);this.material&&
(c.material="string"==typeof this.material?this.material:this.material.serialize(b));!this.prefab||a||this._is_root||(c.prefab=this.prefab);this.flags&&(c.flags=d.cloneObject(this.flags));this.extra&&(c.extra=this.extra);this.comments&&(c.comments=this.comments);!this._children||this.prefab&&!a||(c.children=this.serializeChildren(b));this._editor&&(c.editor=this._editor);this.serializeComponents(c,b);LEvent.trigger(this,"serialize",c);return c};N.prototype._onChildAdded=function(a,b){if(b&&this.transform){var c=
a.transform.getGlobalMatrix(),e=this.transform.getGlobalMatrix();mat4.invert(e,e);a.transform.fromMatrix(mat4.multiply(e,e,c));a.transform.getGlobalMatrix()}this.transform&&(a.transform||a.transform.addComponent(new d.Transform),a.transform._parent=this.transform)};N.prototype._onChangeParent=function(a,b){if(b&&a.transform){var c=this.transform.getGlobalMatrix(),e=a.transform.getGlobalMatrix();mat4.invert(e,e);this.transform.fromMatrix(mat4.multiply(e,e,c))}a.transform&&(this.transform._parent=a.transform)};
N.prototype._onChildRemoved=function(a,b,c){this.transform&&a.transform&&(b?(b=a.transform.getGlobalMatrix(),a.transform._parent=null,a.transform.fromMatrix(b)):a.transform._parent=null);c&&a.removeAllComponents()};N.prototype.getBoundingBox=function(a,b){a=a||BBox.create();var c=this._instances;if(c)for(var e=0;e<c.length;++e)0==e?a.set(c[e].aabb):BBox.merge(a,a,c[e].aabb);return b?a:c&&0!=c.length||!this.transform?a:BBox.fromPoint(this.transform.getGlobalPosition())};d.Scene.Node=N;d.SceneNode=
N;d.Classes.SceneNode=N;Object.defineProperty(Ja.prototype,"data",{set:function(a){this._data=a;this._modified=!0},get:function(){return this._data},enumerable:!0});Ja.prototype.register=function(){d.ResourcesManager.registerResource(this.fullpath||this.filename,this)};Ja.prototype.rename=function(a){d.ResourcesManager.renameResource(this.fullpath||this.filename,a)};Object.defineProperty(Ja.prototype,"uid",{get:function(){return this.fullpath||this.filename},set:function(a){},enumerable:!0});Ja.getDataToStore=
function(a,b){var c=null,e="text",d="";a.getDataToStore?(c=a.getDataToStore())&&c.constructor==ArrayBuffer&&(e="binary"):a._original_file?((c=a._original_file)&&c.constructor!==File&&c.constructor!==Blob&&console.warn("Resource._original_file is not File or Blob"),e="file"):a._original_data?(c=a._original_data)&&c.constructor===ArrayBuffer&&(e="binary"):a.toBinary?(c=a.constructor===GL.Texture?a.toBinary(!0):a.toBinary(),e="binary",d=a.constructor.binary_extension?a.constructor.binary_extension:"wbin"):
a.toBlob&&b?(c=a.toBlob(),e="file"):a.toBase64?(c=a.toBase64(),e="base64"):a.serialize?(c=a.serialize(),delete c.filename,delete c.fullpath,delete c.remotepath,delete c.preview_url,c=JSON.stringify(c)):c=a.data?a.data:JSON.stringify(a);c.buffer&&c.buffer.constructor==ArrayBuffer&&(c=c.buffer);return{data:c,encoding:e,extension:d}};Ja.prototype.getData=function(){return this._data};Ja.prototype.setData=function(a,b){this._original_data&&(this._original_data=null);this._data=a;b||(this._modified=!0)};
Ja.prototype.getDataToStore=function(){var a=this.data||"";a.constructor===Object&&(a=JSON.stringify(a));return a};Ja.prototype.clone=function(){var a=new d.Resource;a._data=this._data;return a};Ja.prototype.getCategory=function(){return"js"==d.ResourcesManager.getExtension(this.fullpath||this.filename)?"Script":"Data"};Ja.prototype.assignToNode=function(a){if(!a)return!1;var b=this.fullpath||this.filename;"Script"==this.getCategory()&&(b=new d.Components.ScriptFromFile({filename:b}),a.addComponent(b));
return!0};Ja.prototype.getAsSubfiles=function(){return this._data?GL.processFileAtlas(this._data):null};Ja.prototype.getAsHTML=function(){if(!this._data||this._data.constructor!==String)return null;var a=document.createElement("div");a.innerHTML=this._data;return a};Ja.prototype.hasEditableText=function(){return this._data&&this._data.constructor===String};Ja.hasPreview=!1;d.Resource=Ja;d.registerResourceClass(Ja);d.Classes.Animation=d.Animation=V;V.EXTENSION="wbin";V.DEFAULT_SCENE_NAME="@scene";
V.DEFAULT_DURATION=10;V.prototype.createTake=function(a,b){if(!a)throw"Animation Take name missing";var c=new V.Take;c.name=a;c.duration=b;void 0===b&&(c.duration=V.DEFAULT_DURATION);this.addTake(c);return c};V.prototype.addTake=function(a){return this.takes[a.name]=a};V.prototype.getTake=function(a){return this.takes[a]};V.prototype.renameTake=function(a,b){var c=this.takes[a];c&&(delete this.takes[a],c.name=b,this.takes[b]=c,LEvent.trigger(this,"take_renamed",[a,b]))};V.prototype.removeTake=function(a){this.takes[a]&&
(delete this.takes[a],LEvent.trigger(this,"take_removed",a))};V.prototype.getNumTakes=function(){var a=0,b;for(b in this.takes)a++;return a};V.prototype.addTrackToTake=function(a,b){var c=this.takes[a];c||(c=this.createTake(a));c.addTrack(b)};V.prototype.configure=function(a){a.name&&(this.name=a.name);if(a.takes){var b=0;this.takes={};for(var c in a.takes){var e=new d.Animation.Take(a.takes[c]);e.name?(this.addTake(e),e.loadResources()):console.warn("Take without name");b++}b||this.createTake("default",
d.Animation.DEFAULT_DURATION)}};V.prototype.serialize=function(){return d.cloneObject(this,null,!0)};V.fromBinary=function(a){a.constructor==ArrayBuffer&&(a=WBin.load(a,!0));var b=a["@json"];b||(b=a);for(var c in b.takes){var e=b.takes[c],g;for(g in e.tracks){var f=e.tracks[g],h="@take_"+c+"_track_"+g;a[h]&&(f.data=a[h])}}return new d.Animation(b)};V.prototype.toBinary=function(){var a={},b=[],c;for(c in this.takes){var e=this.takes[c],g;for(g in e.tracks){var f=e.tracks[g];f.packData();if(f.packed_data){var h=
f.data,k="@take_"+c+"_track_"+g;a[k]=h;f.data=null;b.push(h)}}}a["@json"]=d.cloneObject(this,null,!0);b=WBin.create(a,"Animation");for(c in this.takes)for(g in e=this.takes[c],e.tracks)f=e.tracks[g],k="@take_"+c+"_track_"+g,a[k]&&(f.data=a[k]);return b};V.prototype.convertNamesToIDs=function(a,b){var c=0,e;for(e in this.takes)c+=this.takes[e].convertNamesToIDs(a,b);return c};V.prototype.convertIDsToNames=function(a,b){var c=0,e;for(e in this.takes)c+=this.takes[e].convertIDsToNames(a,b);return c};
V.prototype.setTracksPacking=function(a){var b=0,c;for(c in this.takes)b+=this.takes[c].setTracksPacking(a);return b};V.prototype.optimizeTracks=function(){var a=0,b;for(b in this.takes)a+=this.takes[b].optimizeTracks();return a};V.prototype.assignToNode=function(a){var b=a.getComponent(d.Components.PlayAnimation);b||(b=a.addComponent(d.Components.PlayAnimation));b.animation=this.fullpath||this.filename};Da.prototype.clear=function(){this.tracks=[]};Da.prototype.configure=function(a){a.name&&(this.name=
a.name);if(a.tracks){this.tracks=[];for(var b in a.tracks){var c=new d.Animation.Track(a.tracks[b]);this.addTrack(c)}}a.duration&&(this.duration=a.duration)};Da.prototype.serialize=Da.prototype.toJSON=function(){return d.cloneObject(this,null,!0)};Da.prototype.createTrack=function(a){if(!a)throw"Data missing when creating track";var b=this.getTrack(a.property);if(b)return b;b=new d.Animation.Track(a);this.addTrack(b);return b};Da.prototype.applyTracks=function(a,b,c,e,g,f,h,k){g=g||d.GlobalScene;
if(0!==f){f=f||1;for(var l=0;l<this.tracks.length;++l){var m=this.tracks[l];if(!1!==m.enabled&&m.data&&(!h||!1!==h(m,a,e,f)))if(m._type_index==R.EVENT){var p=m.getKeyframeByTime(a);if(!p||p[0]<b||p[0]>a)break;m=g.getPropertyInfoFromPath(m._property_path);if(!m)break;var n=p[1];1==n[2]?m.node&&m.target&&m.target[n[0]]&&m.target[n[0]].call(m.target,n[1]):m.target?LEvent.trigger(m.target,p[1],p[1][1]):m.node&&LEvent.trigger(m.node,p[1][0],p[1][1])}else p=m.getSample(a,!c),1!==f&&(n=g.getPropertyValueFromPath(m._property_path,
p,e,0),p=d.Animation.interpolateLinear(p,n,f,null,m._type,m.value_size,m)),void 0===p||k&&!1===k(m,p,e,f)||(m._target=g.setPropertyValueFromPath(m._property_path,p,e,0))}}};Da.prototype.addTrack=function(a){this.tracks.push(a)};Da.prototype.getTrack=function(a){if(null==a)return null;if(a.constructor===Number)return this.tracks[a];if(a.constructor===String)for(var b=0;b<this.tracks.length;++b)if(this.tracks[b].property==a)return this.tracks[b];return null};Da.prototype.removeTrack=function(a){for(var b=
0;b<this.tracks.length;++b)if(this.tracks[b]==a){this.tracks.splice(b,1);break}};Da.prototype.getPropertiesSample=function(a,b){b=b||[];for(var c=0;c<this.tracks.length;++c){var e=this.tracks[c],d=e.getSample(a);b.push([e.property,d])}return b};Da.prototype.actionPerSample=function(a,b,c){for(var e=0;e<this.tracks.length;++e){var d=this.tracks[e],f=d.getSample(a,!0);c.disabled_tracks&&c.disabled_tracks[d.property]||b(d.property,f,c)}};Da.prototype.loadResources=function(){for(var a=0;a<this.tracks.length;++a){var b=
this.tracks[a];if("texture"==b._type)for(var c=b.getNumberOfKeyframes(),e=0;e<c;++e){var g=b.getKeyframe(e);g&&g[1]&&":"!=g[1][0]&&d.ResourcesManager.load(g[1])}}};Da.prototype.convertNamesToIDs=function(a,b){for(var c=0,e=0;e<this.tracks.length;++e)c+=this.tracks[e].convertNameToID(a,b);return c};Da.prototype.convertIDsToNames=function(a,b){for(var c=0,e=0;e<this.tracks.length;++e)c+=this.tracks[e].convertIDtoName(a,b);return c};Da.prototype.setTracksPacking=function(a){for(var b=0,c=0;c<this.tracks.length;++c){var e=
this.tracks[c];e.packed_data!=a&&(a?e.packData():e.unpackData(),b+=1)}return b};Da.prototype.optimizeTracks=function(){var a=0;new Float32Array(10);for(var b=0;b<this.tracks.length;++b)this.tracks[b].convertToTrans10()&&(a+=1);return a};Da.prototype.setInterpolationToAllTracks=function(a){for(var b=0,c=0;c<this.tracks.length;++c){var e=this.tracks[c];e.interpolation!=a&&(e.interpolation=a,b+=1)}return b};V.Take=Da;V.Track=R;R.FRAMERATE=30;R.QUAT=d.TYPES_INDEX.quat;R.TRANS10=d.TYPES_INDEX.trans10;
R.EVENT=d.TYPES_INDEX.event;Object.defineProperty(R.prototype,"property",{set:function(a){this._property=a.trim();this._property_path=this._property.split("/")},get:function(){return this._property},enumerable:!0});Object.defineProperty(R.prototype,"type",{set:function(a){this._type=a;this._type_index=d.TYPES_INDEX[a]},get:function(){return this._type},enumerable:!0});R.prototype.configure=function(a){a.property||console.warn("Track with property name");void 0!==a.enabled&&(this.enabled=a.enabled);
a.name&&(this.name=a.name);a.property&&(this.property=a.property);a.type&&(this.type=a.type);a.looped&&(this.looped=a.looped);this.interpolation=void 0!==a.interpolation?a.interpolation:d.LINEAR;a.data_table&&(this.data_table=a.data_table);a.value_size&&(this.value_size=a.value_size);a.data&&(this.data=a.data,this.packed_data=void 0===a.packed_data&&this.data.constructor!==Array?!0:!!a.packed_data,a.data.constructor==Array&&(this.data=this.packed_data?new Float32Array(a.data):a.data.concat()));a.interpolation&&
!this.value_size&&(a.interpolation=d.NONE)};R.prototype.serialize=function(){var a={enabled:this.enabled,name:this.name,property:this.property,type:this._type,interpolation:this.interpolation,looped:this.looped,value_size:this.value_size,packed_data:this.packed_data,data_table:this.data_table};if(this.data)if(1>=this.value_size){if("event"==this.data.type)for(var b=0;b<data.length;++b){var c=data[b];c[1]&&c[1].constructor.is_component&&(c[1]=null)}a.data=this.data.concat?this.data.concat():new this.data.constructor(this.data)}else this.packData(),
a.data=new Float32Array(this.data),a.packed_data=this.packed_data;return a};R.prototype.toJSON=R.prototype.serialize;R.prototype.clear=function(){this.data=[];this.packed_data=!1};R.prototype.getIDasName=function(a,b){return this._property_path&&this._property_path.length?d.convertLocatorFromUIDsToName(this._property,a,b):null};R.prototype.convertNameToID=function(a){if(this._property_path[0][0]===d._uid_prefix)return!1;a=Oa.get(this._property_path[0],a);if(!a)return!1;this._property_path[0]=a.uid;
1<this._property_path.length&&(a=a.getComponent(this._property_path[1]))&&(this._property_path[1]=a.uid);this._property=this._property_path.join("/");return!0};R.prototype.convertIDtoName=function(a,b){var c=this.getIDasName(a,b);if(!c)return!1;this._property=c;this._property_path=this._property.split("/");return!0};R.prototype.convertToTrans10=function(){if(16!=this.value_size)return!1;this.packed_data||this.packData();var a=this.property.split("/");if("matrix"!=a[a.length-1])return!1;a[a.length-
1]="Transform/data";this.property=a.join("/");this.type="trans10";this.value_size=10;for(var a=new Float32Array(10),b=this.data,c=b.length/17,e=0;e<c;++e){var g=b.subarray(17*e+1,17*e+17);d.Transform.fromMatrix4ToTransformData(g,a);b[11*e]=b[17*e];b.set(a,11*e+1)}this.data=new Float32Array(b.subarray(0,11*c));return!0};R.prototype.addKeyframeFromCurrent=function(a,b){b=b||d.GlobalScene;var c=b.getPropertyInfoFromPath(this._property_path);return c?this.addKeyframe(a,c.value):null};R.prototype.addKeyframe=
function(a,b,c){1<this.value_size&&(b=new Float32Array(b));this.packed_data&&this.unpackData();this.data||(this.data=[]);for(var e=0;e<this.data.length;++e)if(!(this.data[e][0]<a))return this.data[e][0]!=a||c?this.data.splice(e,0,[a,b]):this.data[e][1]=b,e;this.data.push([a,b]);return this.data.length-1};R.prototype.getKeyframe=function(a){return 0>a||a>=this.data.length?(console.warn("keyframe index out of bounds"),null):this.packed_data?(a*=1+this.value_size,a>this.data.length-this.value_size?null:
[this.data[a],this.data.subarray(a+1,a+this.value_size+1)]):this.data[a]};R.prototype.getKeyframeByTime=function(a){a=this.findTimeIndex(a);if(-1!=a)return this.getKeyframe(a)};R.prototype.moveKeyframe=function(a,b){if(this.packed_data)return console.warn("Cannot move keyframes if packed"),-1;if(0>a||a>=this.data.length)return console.warn("keyframe index out of bounds"),-1;var c=this.findTimeIndex(b),e=this.data[a],d=e[0];if(d==b)return a;e[0]=b;d>b&&(c+=1);if(a==c)return a;this.data.splice(a,1);
a=this.addKeyframe(e[0],e[1],!0);this.sortKeyframes();return a};R.prototype.sortKeyframes=function(){this.packed_data&&(this.unpackData(),this.sortKeyframes(),this.packData());this.data.sort(function(a,b){return a[0]-b[0]})};R.prototype.removeKeyframe=function(a){this.packed_data&&this.unpackData();0>a||a>=this.data.length?console.warn("keyframe index out of bounds"):this.data.splice(a,1)};R.prototype.getNumberOfKeyframes=function(){return this.data&&0!=this.data.length?this.packed_data?this.data.length/
(1+this.value_size):this.data.length:0};R.prototype.computeDuration=function(){if(!this.data||0==this.data.length)return 0;if(this.packed_data){var a=this.data[this.data.length-2-this.value_size];return this.duration=a}return(a=this.data[this.data.length-1])?a[0]:0};R.prototype.isInterpolable=function(){return 0<this.value_size||d.Interpolators[this._type]?!0:!1};R.prototype.packData=function(){if(!this.data||0==this.data.length)return 0;if(!this.packed_data&&0!=this.value_size){for(var a=this.value_size+
1,b=this.data,c=new Float32Array(b.length*a),e=0;e<b.length;++e)c[e*a]=b[e][0],1==this.value_size?c[e*a+1]=b[e][1]:c.set(b[e][1],e*a+1);this.data=c;this.packed_data=!0}};R.prototype.unpackData=function(){if(!this.data||0==this.data.length)return 0;if(this.packed_data){for(var a=this.value_size+1,b=this.data,c=Array(b.length/a),e=0;e<b.length;e+=a)c[e/a]=[b[e],b.subarray(e+1,e+a)];this.data=c;this.packed_data=!1}};R.prototype.findTimeIndex=function(a){var b=this.data;if(!b||0==b.length)return-1;if(this.packed_data){var c=
this.value_size+1,e=b.length/c,d=0,f=0,h=e;if(0==e)return-1;if(1==e)return 0;if(b[(h-1)*c]<a)return h-1;for(;h>=d;){f=0.5*(h+d)|0;e=b[f*c];if(e==a)break;if(d==h-1)return d;e<a?d=f:h=f}return f}e=b.length;f=d=0;h=e;if(0==e)return-1;if(1==e)return 0;if(b[h-1][0]<a)return h-1;for(;h>=d;){f=0.5*(h+d)|0;e=b[f][0];if(e==a)break;if(d==h-1)return d;e<a?d=f:h=f}return f};R.prototype.getSample=function(a,b,c){return this.data&&0!==this.data.length?this.packed_data?this.getSamplePacked(a,b,c):this.getSampleUnpacked(a,
b,c):void 0};R.prototype.getSampleUnpacked=function(a,b,c){a=Math.clamp(a,0,this.duration);var e=this.findTimeIndex(a);-1===e&&(e=0);var g=e,f=e+1,h=this.data,k=this.value_size;b=b&&this.interpolation&&(0<this.value_size||d.Interpolators[this._type]);if(!b||1==h.length||f==h.length||0==g&&this.data[0][0]>a)return this.data[e][1];b=h[g];f=h[f];a=(f[0]-a)/(f[0]-b[0]);1<k&&(c=c||this._result,c&&c.length==k||(c=this._result=new Float32Array(k)));if(this.interpolation===d.LINEAR)return 1==k?b[1]*a+f[1]*
(1-a):d.Animation.interpolateLinear(b[1],f[1],a,c,this._type,k,this);if(this.interpolation===d.CUBIC){if(0===k&&d.Interpolators[this._type])return this._last_value=c=(0,d.Interpolators[this._type])(b[1],f[1],a,this._last_value);g=0<e?h[e-1]:b;e=e<h.length-2?h[e+2]:f;if(1===k)return V.EvaluateHermiteSpline(b[1],f[1],g[1],e[1],1-a);c=V.EvaluateHermiteSplineVector(b[1],f[1],g[1],e[1],1-a,c);this._type_index==R.QUAT?(quat.slerp(c,f[1],b[1],a),quat.normalize(c,c)):this._type_index==R.TRANS10&&(k=c.subarray(3,
7),e=b[1].subarray(3,7),h=f[1].subarray(3,7),quat.slerp(k,h,e,a),quat.normalize(k,k));return c}return null};R.prototype.getSamplePacked=function(a,b,c){a=Math.clamp(a,0,this.duration);var e=this.findTimeIndex(a);-1==e&&(e=0);var g=this.value_size,f=g+1,h=e,k=e+1,l=this.data,m=l.length/f;b=b&&this.interpolation&&(0<g||d.Interpolators[this._type]);if(!b||1==m||k==m||0==h&&this.data[0]>a)return this.getKeyframe(e)[1];1<g&&(c=c||this._result,c&&c.length==g||(c=this._result=new Float32Array(g)));h=l.subarray(h*
f,(h+1)*f);b=l.subarray(k*f,(k+1)*f);a=(b[0]-a)/(b[0]-h[0]);if(this.interpolation===d.LINEAR){if(1==g)return h[1]*a+b[1]*(1-a);f=h.subarray(1,g+1);b=b.subarray(1,g+1);return d.Animation.interpolateLinear(f,b,a,c,this._type,g,this)}if(this.interpolation===d.CUBIC){if(0===g)return h[1];e=0<e?l.subarray((e-1)*f,e*f):h;k=k<m-1?l.subarray((k+1)*f,(k+2)*f):b;if(1===g)return V.EvaluateHermiteSpline(h[1],b[1],e[1],k[1],1-a);g=h.subarray(1,f);b=b.subarray(1,f);c=V.EvaluateHermiteSplineVector(g,b,e.subarray(1,
f),k.subarray(1,f),1-a,c);this._type_index==R.QUAT?(quat.slerp(c,b,g,a),quat.normalize(c,c)):this._type_index==R.TRANS10&&(f=c.subarray(3,7),g=g.subarray(3,7),b=b.subarray(3,7),quat.slerp(f,b,g,a),quat.normalize(f,f));return c}return null};R.prototype.getPropertyInfo=function(a){a=a||d.GlobalScene;return a.getPropertyInfo(this.property)};R.prototype.getPropertyNode=function(a){return(a||d.GlobalScene).getNode(this.property.split("/")[0])};R.prototype.getSampledData=function(a,b,c){b=(b-a)/c;if(0>=
b)return null;for(var e=[],d=0;d<c;++d){var f=this.getSample(d*b+a,!0);1<this.value_size&&(f=new f.constructor(f));e.push(f)}return e};V.interpolateLinear=function(a,b,c,e,g,f,h){if(1==f)return a*c+b*(1-c);if(d.Interpolators[g])return c=(0,d.Interpolators[g])(a,b,c,h._last_v),h._last_v=c;e=e||h._result;e&&e.length==f||(e=h._result=new Float32Array(f));switch(d.TYPES_INDEX[g]){case R.QUAT:quat.slerp(e,b,a,c);quat.normalize(e,e);break;case R.TRANS10:for(h=0;3>h;h++)e[h]=a[h]*c+b[h]*(1-c);for(h=7;10>
h;h++)e[h]=a[h]*c+b[h]*(1-c);a=a.subarray(3,7);b=b.subarray(3,7);f=e.subarray(3,7);quat.slerp(f,b,a,c);quat.normalize(f,f);break;default:for(h=0;h<f;h++)e[h]=a[h]*c+b[h]*(1-c)}return e};V.EvaluateHermiteSpline=function(a,b,c,e,d){var f=d*d,h=f*d;return(2*h-3*f+1)*a+(-2*h+3*f)*b+(h-2*f+d)*(b-c)+(h-f)*(e-a)};V.EvaluateHermiteSplineVector=function(a,b,c,e,d,f){f=f||new Float32Array(f.length);var h=d*d,k=h*d,l=2*k-3*h+1,m=-2*k+3*h;d=k-2*h+d;for(var h=k-h,k=0,p=f.length;k<p;++k)f[k]=l*a[k]+m*b[k]+d*(b[k]-
c[k])+h*(e[k]-a[k]);return f};d.registerResourceClass(V);d.Interpolators={};d.Interpolators.texture=function(a,b,c,e){var g=a?d.getTexture(a):null,f=b?d.getTexture(b):null;a&&!g&&":"!=a[0]&&d.ResourcesManager.load(a);b&&!f&&":"!=b[0]&&d.ResourcesManager.load(b);a=g||f;(b=gl.textures[":black"])||(b=gl.textures[":black"]=new GL.Texture(1,1,{format:gl.RGB,pixel_data:[0,0,0],filter:gl.NEAREST}));if(!a)return b;var h=a?a.width:256,k=a?a.height:256;g||(g=b);f||(f=b);e&&e.width==h&&e.height==k&&e.format==
a.format||(e=new GL.Texture(h,k,{format:a.format,type:a.type,filter:gl.LINEAR}));var l=gl.shaders[":interpolate_texture"];l||(l=gl.shaders[":interpolate_texture"]=GL.Shader.createFX("color = mix( texture2D( u_texture_b, uv ), color , u_factor );","uniform sampler2D u_texture_b; uniform float u_factor;"));gl.disable(gl.DEPTH_TEST);e.drawTo(function(){gl.clearColor(0,0,0,0);gl.clear(gl.COLOR_BUFFER_BIT);f.bind(1);g.toViewport(l,{u_texture_b:1,u_factor:c})});return e};Math.lerp||(Math.lerp=wc);Fb.prototype.serialize=
function(){return{name:this.name,model:typedArrayToArray(this.model),parent:this.parent,layer:this.layer,children:this.num_children?typedArrayToArray(this.children.subarray(0,this.num_children)):null}};Fb.prototype.configure=function(a){this.name=a.name;this.model.set(a.model);this.parent=a.parent;this.layer=a.layer;this.num_children=0;a.children&&(this.children.set(a.children),this.num_children=a.children.constructor===Array?a.children.length:a.num_children)};Fb.prototype.copyFrom=Fb.prototype.configure;
oa.Bone=Fb;oa.prototype.applyTransformToBones=function(a,b){var c=this.getBone(a);c&&mat4.multiply(c.model,c.model,b)};oa.prototype.getBone=function(a){return this.bones[this.bones_by_name.get(a)]};oa.identity=mat4.create();oa.prototype.getBoneMatrix=function(a,b){void 0===b&&(b=!0);var c=this.bones_by_name.get(a);return void 0===c?oa.identity:b?this.bones[c].model:this.global_bone_matrices[c]};oa.temp_mat4=mat4.create();oa.temp_mat43=oa.temp_mat4.subarray(0,12);oa.prototype.computeFinalBoneMatrices=
function(a,b,c){if(!this.bones.length||!b||!b.bones)return a||[];this.updateGlobalMatrices();var e=c?12*b.bones.length:16*b.bones.length;a&&a.length==e||(a=new Float32Array(e));if(c){var d=oa.temp_mat4,d=oa.temp_mat43;for(c=0;c<b.bones.length;++c)e=b.bones[c],mat4.multiply(temp_mat4,this.getBoneMatrix(e[0],!1),e[1]),mat4.transpose(temp_mat4,temp_mat4),a.set(d,12*c)}else for(c=0;c<b.bones.length;++c)e=b.bones[c],d=a.subarray(16*c,16*c+16),mat4.multiply(d,this.getBoneMatrix(e[0],!1),e[1]);return a};
oa.prototype.computeFinalBoneMatricesAsArray=function(a,b,c){if(!this.bones.length||!b||!b.bones)return a||[];this.updateGlobalMatrices();a=a||[];a.length=b.bones.length;for(var e=0;e<b.bones.length;++e){var d=b.bones[e];a[e]||(a[e]=mat4.create());var f=a[e];mat4.multiply(f,this.getBoneMatrix(d[0],!1),d[1]);b.bind_matrix&&mat4.multiply(f,f,b.bind_matrix);c&&mat4.multiply(f,c,f)}return a};oa.prototype.updateGlobalMatrices=function(){var a=this.bones;if(a.length){var b=this.bones.length;this.global_bone_matrices[0].set(a[0].model);
for(var c=1;c<b;++c){var e=a[c];mat4.multiply(this.global_bone_matrices[c],this.global_bone_matrices[e.parent],e.model)}}};oa.prototype.assignLayer=function(a,b){};oa.prototype.getVertices=function(){if(!this.bones.length)return null;var a=6*(this.bones.length-1);this._vertices&&this._vertices.length==a||(this._vertices=new Float32Array(a));for(var a=this._vertices,b=0;b<this.bones.length-1;++b){var c=this.global_bone_matrices[this.bones[b+1].parent],e=this.global_bone_matrices[b+1],d=a.subarray(6*
b,6*b+3),f=a.subarray(6*b+3,6*b+6);mat4.getTranslation(d,e);mat4.getTranslation(f,c)}return a};oa.prototype.resizeBones=function(a){if(this.bones.length!=a)if(this.bones.length>a)this.bones.length=a,this.global_bone_matrices.length=a;else{var b=this.bones.length;for(this.bones.length=a;b<a;++b)this.bones[b]=new Fb,this.global_bone_matrices[b]=mat4.create()}};oa.prototype.copyFrom=function(a){this.resizeBones(a.bones.length);for(var b=0;b<a.bones.length;++b)this.bones[b].copyFrom(a.bones[b]),this.global_bone_matrices[b].set(a.global_bone_matrices[b]);
this.bones_by_name=new Map(a.bones_by_name)};oa.prototype.serialize=function(){for(var a={bones:[],bone_names:{}},b=0;b<this.bones.length;++b)a.bones.push(this.bones[b].serialize());return a};oa.prototype.configure=function(a){this.resizeBones(a.bones.length);a.bones_by_name?this.bones_by_name=new Map(a.bones_by_name):this.bones_by_name.clear();for(var b=0;b<a.bones.length;++b)this.bones[b].copyFrom(a.bones[b]),a.global_bone_matrices?this.global_bone_matrices[b].set(a.global_bone_matrices[b]):this.bones_by_name[this.bones[b].name]=
b};var ob=vec3.create();oa.blend=function(a,b,c,e,d,f){if(a.bones.length!=b.bones.length)console.error("skeleton must contain the same number of bones");else{c=Math.clamp(c,0,1);if(255==d){if(0==c){if(e==a)return;e.copyFrom(a);return}if(1==c){e.copyFrom(b);return}}if(e!=a){e.bones.length=a.bones.length;for(d=0;d<e.bones.length;++d)(b=e.bones[d])||(b=new oa.Bone),b.copyFrom(a.bones[d]);e.bones_by_name=new Map(a.bones_by_name)}for(d=0;d<e.bones.length;++d){for(var h=e.bones[d],k=a.bones[d],l=b.bones[d],
m=0;16>m;++m)h.model[m]=Math.lerp(k.model[m],l.model[m],c);if(!f)for(h=h.model,m=0;3>m;++m)ob[0]=h[0+m],ob[1]=h[4+m],ob[2]=h[8+m],vec3.normalize(ob,ob),h[0+m]=ob[0],h[4+m]=ob[1],h[8+m]=ob[2]}}};oa.shader_code="\n\tattribute vec4 a_bone_indices;\n\tattribute vec4 a_weights;\n\tuniform mat4 u_bones[64];\n\tvoid computeSkinning(inout vec3 vertex, inout vec3 normal)\n\t{\n\t\tvec4 v = vec4(vertex,1.0);\n\t\tvertex = (u_bones[int(a_bone_indices.x)] * a_weights.x * v + \n\t\t\t\tu_bones[int(a_bone_indices.y)] * a_weights.y * v + \n\t\t\t\tu_bones[int(a_bone_indices.z)] * a_weights.z * v + \n\t\t\t\tu_bones[int(a_bone_indices.w)] * a_weights.w * v).xyz;\n\t\tvec4 N = vec4(normal,0.0);\n\t\tnormal =\t(u_bones[int(a_bone_indices.x)] * a_weights.x * N + \n\t\t\t\tu_bones[int(a_bone_indices.y)] * a_weights.y * N + \n\t\t\t\tu_bones[int(a_bone_indices.z)] * a_weights.z * N + \n\t\t\t\tu_bones[int(a_bone_indices.w)] * a_weights.w * N).xyz;\n\t\tnormal = normalize(normal);\n\t}\n";
vb.FORMAT={extension:"skanim",dataType:"text"};vb.prototype.assignTime=function(a,b,c,e){if(this.duration){b||void 0===b?(a%=this.duration,0>a&&(a=this.duration+a)):a=Math.clamp(a,0,this.duration-1/this.samples_per_second);void 0===c&&(c=!0);a*=this.samples_per_second;var d=Math.floor(a),f=(d+1)%this.num_keyframes,d=d%this.num_keyframes;a-=Math.floor(a);b=this.num_animated_bones;e=16*b;for(var d=d*e,f=f*e,h=this.skeleton,k=this.keyframes,l=this.bones_map,m=0;m<b;++m){var p=h.bones[l[m]];e=16*m;if(c)for(var n=
0;16>n;++n)p.model[n]=wc(k[d+e+n],k[f+e+n],a);else p.model.set(k.subarray(d+e,d+e+16))}}};vb.prototype.resize=function(a,b){this.num_keyframes=a;this.num_animated_bones=b;this.keyframes=new Float32Array(a*b*16)};vb.prototype.fromData=function(a){a=a.split("\n");var b=a[0].split(",");this.duration=Number(b[0]);this.samples_per_second=Number(b[1]);this.num_keyframes=Number(b[2]);this.skeleton.resizeBones(Number(b[3]));for(var b=0,c=1;c<a.length;++c){var e=a[c],d=e[0],e=e.substr(1).split(",");if("B"==
d){var f=Number(e[0]),h=this.skeleton.bones[f];h.name=e[1];h.parent=Number(e[2]);for(d=0;16>d;++d)h.model[d]=Number(e[3+d]);-1!=h.parent&&(e=this.skeleton.bones[h.parent],16<=e.num_children?console.warn("too many child bones, max is 16"):e.children[e.num_children++]=f);this.skeleton.bones_by_name.set(h.name,f)}else if("@"==d){this.num_animated_bones=Number(e[0]);for(d=0;d<this.num_animated_bones;++d)this.bones_map[d]=Number(e[d+1]);this.resize(this.num_keyframes,this.num_animated_bones)}else if("K"==
d){f=b*this.num_animated_bones*16;d=0;for(h=16*this.num_animated_bones;d<h;++d)this.keyframes[f+d]=Number(e[d+1]);b++}else break}this.assignTime(0,!1,!1)};vb.prototype.toData=function(){console.error("no toData in Skeletal Animation");return""};"undefined"!=typeof Xa&&(d.Skeleton=oa,d.Classes.SkeletalAnimation=d.SkeletalAnimation=vb,d.registerResourceClass(vb));ja.version="0.2";ja.EXTENSION="wbin";ja.prototype.configure=function(a){this._data=d.cloneObject(a);this.resource_names=a["@resource_names"];
this._resources_data={};if(this.resource_names){delete this._data["@resource_names"];for(var b in this.resource_names)this._resources_data[this.resource_names[b]]=a["@RES_"+b],delete this._data["@RES_"+b]}this.processResources()};Object.defineProperty(ja.prototype,"bindata",{set:function(a){throw"Pack bindata cannot be assigned";},get:function(){this._original_data||(this._original_data=d.Pack.packResources(this.resource_names,this._data));return this._original_data},enumerable:!0});ja.fromBinary=
function(a){a.constructor==ArrayBuffer&&(a=WBin.load(a,!0));return new d.Pack(a)};ja.prototype.processResources=function(){if(this.resource_names){for(var a=this.fullpath||this.filename,b=0;b<this.resource_names.length;++b){var c=this.resource_names[b];d.ResourcesManager.resources[c]||(d.ResourcesManager.resources_being_processed[c]=!0)}for(b=0;b<this.resource_names.length;++b)if(c=this.resource_names[b],!d.ResourcesManager.resources[c]){var e=this._resources_data[c];e?d.ResourcesManager.processResource(c,
e,{is_local:!0,from_pack:a}):console.warn("resource data in Pack is undefined, skipping it:"+c)}}};ja.prototype.setResources=function(a,b){this.resource_names=[];this._resources_data={};for(var c=this.fullpath||this.filename,e=0;e<a.length;++e){var g=a[e];if(-1==this.resource_names.indexOf(g)){var f=d.ResourcesManager.resources[g];f&&(b&&(f.from_pack=c),this.resource_names.push(g))}}this._original_data=d.Pack.packResources(a,this.getBaseData());this._modified=!0};ja.prototype.getBaseData=function(){return{"@metadata":this.metadata,
"@version":d.Pack.version}};ja.prototype.setResourcesLink=function(a){for(var b=0;b<this.resource_names.length;++b){var c=d.ResourcesManager.resources[this.resource_names[b]];c&&(a?c.from_pack=a:delete c.from_pack)}};ja.prototype.addResources=function(a,b){a&&(a.constructor!==Array&&(a=[a]),this.setResources(this.resource_names.concat(a),b))};ja.prototype.addResource=function(a){a=d.ResourcesManager.cleanFullpath(a);-1==this.resource_names.indexOf(a)&&this.resource_names.push(a)};ja.prototype.removeResource=
function(a){a=d.ResourcesManager.cleanFullpath(a);a=this.resource_names.indexOf(a);-1!=a&&this.resource_names.splice(a,1)};ja.createPack=function(a,b,c,e){if(a){if(!b||b.constructor!==Array)throw"Pack.createPack resources must be array with names";if(c&&c.constructor!==Object)throw"Pack.createPack extra_data must be an object with the chunks to store";a=a.replace(/ /gi,"_");var g=new d.Pack;g.filename=a+".wbin";c&&(g._data=c);g.resource_names=b;for(a=0;a<b.length;++a){var f=d.ResourcesManager.resources[b[a]];
f&&e&&(f.from_pack=g.filename)}this.metadata=c;b=d.Pack.packResources(b,g.getBaseData());g._original_data=b;return g}};ja.packResources=function(a,b){for(var c=b||{},e=[],g=0;g<a.length;++g){var f=a[g],h=d.ResourcesManager.resources[f];if(h){var k=null;if(k=h._original_data?h._original_data:d.Resource.getDataToStore(h).data){if(k.constructor===Blob||k.constructor===File){if(!k.data||k.data.constructor!==ArrayBuffer){console.warn("WBin does not support to store File or Blob, please, use ArrayBuffer");
continue}k=k.data}c["@RES_"+e.length]=k;e.push(f)}else console.warn("Wrong data in resource")}}c["@resource_names"]=e;return WBin.create(c,"Pack")};ja.prototype.flagResources=function(){if(this.resource_names)for(var a=0;a<this.resource_names.length;++a){var b=d.ResourcesManager.resources[this.resource_names[a]];b&&(b.from_pack=this.fullpath||this.filename)}};ja.prototype.getDataToStore=function(){return d.Pack.packResources(this.resource_names,this.getBaseData())};ja.prototype.checkResourceNames=
function(){if(!this.resource_names)return 0;for(var a=0,b=0;b<this.resource_names.length;++b){var c=this.resource_names[b],e=c,g=d.ResourcesManager.resources[c];if(g){!1==d.ResourcesManager.valid_resource_name_reg.test(c)&&(console.warn("Invalid filename in pack/prefab: ",c),c=c.replace(/[^a-zA-Z0-9-_\.\/]/g,"_"));var f=d.ResourcesManager.getExtension(c);f||((f=g.constructor.EXTENSION)?c=c+"."+f:console.warn("Resource without extension and not known default extension: ",c,g.constructor.name));e!=
c&&(this.resource_names[b]=c,d.ResourcesManager.renameResource(e,c),a++)}}a&&d.ResourcesManager.resourceModified(this);return a};ja.prototype.onResourceRenamed=function(a,b,c){this.resource_names&&(a=this.resource_names[a],-1!=a&&(this.resource_names[a]=b,d.ResourcesManager.resourceModified(this)))};ja.prototype.containsResources=function(){return this.resource_names&&0<this.resource_names.length?!0:!1};ja.prototype.getSizeInBytes=function(){return this._original_data?this._original_data.byteLength:
0};d.Pack=ja;d.registerResourceClass(ja);la.version="0.2";la.EXTENSION="wbin";la.prototype.setData=function(a){a&&a.constructor===d.SceneNode&&(a=a.serialize());a.object_class="SceneNode";this.prefab_data=a;this.prefab_json=JSON.stringify(a)};la.prototype.configure=function(a){if(!a)throw"No prefab data found";if(a.hasOwnProperty("prefab_data"))this.prefab_data=a.prefab_data,this.prefab_json=a.prefab_json||JSON.stringify(this.prefab_data);else{var b=a["@json"];if(!b){console.warn("No JSON found in prefab");
return}var c=a["@version"];this.prefab_json=b;this.prefab_data=JSON.parse(b)}this.resource_names=a["@resources_name"]||a.resource_names||[];var b={},e;for(e in this.resource_names)b[this.resource_names[e]]=c?a["@RES_"+e]:a[this.resource_names[e]];this._resources_data=b;this.processResources()};la.fromBinary=function(a,b){a.constructor==ArrayBuffer&&(a=WBin.load(a,!0));return new d.Prefab(a,b)};la.prototype.processResources=function(){if(this._resources_data){var a=this.fullpath||this.filename,b=this._resources_data,
c;for(c in b)d.ResourcesManager.resources[c]||(d.ResourcesManager.resources_being_processed[c]=!0);for(c in b)if(!d.ResourcesManager.resources[c]){var e=b[c];e?d.ResourcesManager.processResource(c,e,{is_local:!0,from_prefab:a}):console.warn("resource data in prefab is undefined, skipping it:"+c)}}};la.prototype.createObject=function(){if(!this.prefab_json)throw"No prefab_json data found";var a=JSON.parse(this.prefab_json);if(!a)return console.error("Prefab data is null"),null;var b=new d.SceneNode;
b.configure(a);d.ResourcesManager.loadResources(b.getResources({},!0));this.fullpath&&(b.prefab=this.fullpath);return b};la.prototype.addResource=function(a){a=d.ResourcesManager.cleanFullpath(a);-1==this.resource_names.indexOf(a)&&this.resource_names.push(a)};la.prototype.removeResource=function(a){a=d.ResourcesManager.cleanFullpath(a);a=this.resource_names.indexOf(a);-1!=a&&this.resource_names.splice(a,1)};la.createPrefab=function(a,b,c){if(a){if(!b)throw"No node_data in prefab";a=a.replace(/ /gi,
"_");c=c||[];var e=new d.Prefab;"wbin"!=d.ResourcesManager.getExtension(a)&&(a+=".wbin");e.filename=a;e.resource_names=c;e.setData(b);a=d.Prefab.packResources(c,{"@json":e.prefab_json,"@version":la.version},this);e._original_data=a;return e}};la.packResources=function(a,b,c){b=b||{};c=[];if(a&&a.length)for(var e=0;e<a.length;++e){var g=a[e],f=d.ResourcesManager.resources[g];if(f){var h=null;if(f._original_data)h=f._original_data;else{h=d.Resource.getDataToStore(f);if(!h){console.warn("Data to store from resource is null, skipping: ",
g);continue}if(h.extension&&h.extension!=d.ResourcesManager.getExtension(g)){console.warn("The resource extension has changed while saving, this could lead to problems: ",g,h.extension);var k=g,g=g+"."+h.extension;a[e]=g;d.GlobalScene.sendResourceRenamedEvent(k,g,f)}h=h.data}h?h.constructor===Blob||h.constructor===File?console.warn("WBin does not support to store File or Blob, please convert to ArrayBuffer using FileReader"):(b["@RES_"+c.length]=h,c.push(g)):console.warn("Wrong data in resource")}}b["@resources_name"]=
c;return WBin.create(b,"Prefab")};la.prototype.updateFromNode=function(a,b){var c=a.serialize(!0);b&&d.clearUIds(c);this.prefab_data=c;this.prefab_json=JSON.stringify(c)};la.prototype.flagResources=function(){if(this.resource_names)for(var a=0;a<this.resource_names.length;++a){var b=d.ResourcesManager.resources[this.resource_names[a]];b&&(b.from_prefab=this.fullpath||this.filename)}};la.prototype.setResourcesLink=function(a){if(this.resource_names)for(var b=0;b<this.resource_names.length;++b){var c=
d.ResourcesManager.resources[this.resource_names[b]];c&&(a?c.from_prefab=a:delete c.from_prefab)}};la.prototype.applyToNodes=function(a){a=a||d.GlobalScene;for(var b=this.fullpath||this.filename,c=0;c<a._nodes.length;++c){var e=a._nodes[c];e.prefab==b&&e.reloadFromPrefab()}};la.prototype.getDataToStore=function(){this.prefab_json=JSON.stringify(this.prefab_data);var a=this.fullpath||this.filename;return this.resource_names&&this.resource_names.length||!a||"json"!=d.RM.getExtension(a)?d.Prefab.packResources(this.resource_names,
this.getBaseData(),this):JSON.stringify({object_class:d.getObjectClassName(this),"@json":this.prefab_json})};la.prototype.getBaseData=function(){return{"@json":this.prefab_json,"@version":d.Prefab.version}};la.prototype.recomputeData=function(){var a=this.getDataToStore();a&&(this._original_data=a.buffer)};la.prototype.containsResources=ja.prototype.containsResources;la.prototype.onResourceRenamed=ja.prototype.onResourceRenamed;la.prototype.checkResourceNames=ja.prototype.checkResourceNames;la.prototype.setResources=
ja.prototype.setResources;la.prototype.getSizeInBytes=ja.prototype.getSizeInBytes;d.Prefab=la;d.registerResourceClass(la);P.help_url="https://github.com/jagenjo/litescene.js/blob/master/guides/shaders.md";P.CODE=1;P.PRAGMA=2;P.INCLUDE=1;P.SHADERBLOCK=2;P.SNIPPET=3;P.EXTENSION="glsl";Object.defineProperty(P.prototype,"code",{enumerable:!0,get:function(){return this._code},set:function(a){this._code!=a&&(this._code=a,this.processCode())}});Object.defineProperty(P.prototype,"version",{enumerable:!1,
get:function(){return this._version},set:function(a){console.error("version cannot be set manually")}});P.prototype.getResources=function(a){for(var b in this._code_parts){var c=this._code_parts[b],e;for(e in c){var d=c[e],f;for(f in d.includes)a[f]=!0}}};P.prototype.processCode=function(){this._global_uniforms={};this._code_parts={};this._compiled_shaders={};this._functions={};this._shaderblock_flags_num=0;this._shaderblock_flags={};this._shaderblock_vars=null;this._has_error=!1;var a=GL.processFileAtlas(this._code);
this._subfiles=a;var b=0,c=null;a["default.vs"]||(a["default.vs"]=P.default_vs);a["default.fs"]||(a["default.fs"]=P.default_fs);for(var e in a){var g=e,f=a[e];b++;if(g)if("js"==g)c=f;else if("uniforms"==g)for(var g=f.split("/n"),h=0;h<g.length;++h){var k=g[h].trim(),l=k.split(" "),f=l[0],m=l[1],p=l[2],l=l[3];void 0!==l&&(l=d.stringToValue(l));var n=null,r=k.indexOf("{");-1!=r&&(n=d.stringToValue(k.substr(r)));this._global_uniforms[f]={name:f,uniform:m,type:p,value:l,options:n}}else if(m=d.ResourcesManager.removeExtension(g),
g=d.ResourcesManager.getExtension(g),"vs"==g||"fs"==g){(k=this._code_parts[m])||(k=this._code_parts[m]={});f=new ia(f);for(h in f.blocks)(m=f.blocks[h])&&m.type==P.PRAGMA&&(m.shader_block_flag=this._shaderblock_flags_num,this._shaderblock_flags[m.shader_block]=m.shader_block_flag,this._shaderblock_flags_num+=1);k[g]=f}}if(a=this.getShader()){if(c&&(c=d.ShaderCode.removeComments(c)))if(d.catch_exceptions)try{this._functions.init=new Function(c)}catch(t){d.dispatchCodeError(t,Z.computeLineFromError(t),
this)}else this._functions.init=new Function(c);this.validatePublicUniforms(a);LEvent.trigger(d.ShaderCode,"modified",this);this._version+=1}};P.prototype.setData=function(a,b){this.code=a;b||(this._modified=!0)};P.prototype.getData=function(){return this._code};P.prototype.fromData=P.prototype.setData;P.prototype.toData=P.prototype.getData;P.prototype.getDataToStore=function(){return this._code};P.prototype.getShader=function(a,b){if(this._has_error)return null;a=a||"color";b=b||0;var c=this._compiled_shaders[a];
if(c){var e=c.get(b);if(e)return e}var e=this._code_parts[a],g=this._code_parts["default"];if(!e&&!g)return null;for(var c={},f=0,h=d.Shaders.shader_blocks.length;f<h;++f)if(b&1<<f){var k=d.Shaders.shader_blocks[f];if(k&&k.context_macros)for(var l in k.context_macros)c[l]=k.context_macros[l]}l=null;if("fx"==a)l=GL.Shader.SCREEN_VERTEX_SHADER;else if(e&&e.vs)l=e.vs.getFinalCode(GL.VERTEX_SHADER,b,c);else if(g&&g.vs)l=g.vs.getFinalCode(GL.VERTEX_SHADER,b,c);else return null;h=null;if(e&&e.fs)h=e.fs.getFinalCode(GL.FRAGMENT_SHADER,
b,c);else if(g&&g.fs)h=g.fs.getFinalCode(GL.FRAGMENT_SHADER,b,c);else return null;if(!l||!h)return this._has_error=!0,null;l=d.Shaders.global_extra_shader_code+l;h=d.Shaders.global_extra_shader_code+h;e=this.compileShader(l,h);if(!e)return null;f=d.ShaderCode.removeComments(h);e.supports_drawbuffers=-1!=f.indexOf("gl_FragData");if(d.debug){g=[];for(f=0;f<d.Shaders.num_shaderblocks;++f)b&1<<f&&(k=d.Shaders.shader_blocks[f])&&g.push(k);e._shadercode_info={vs:l,fs:h,context:c,blocks:g,flags:b}}this._compiled_shaders[a]||
(this._compiled_shaders[a]=new Map);this._compiled_shaders[a].set(b,e);return e};P.prototype.compileShader=function(a,b){if(this._has_error)return null;d.Debug&&(console.log("Shader Compiled: ",this.fullpath||this.filename),console.groupCollapsed("VS shader"),console.log(a),console.groupEnd(),console.groupCollapsed("FS shader"),console.log(b),console.groupEnd());var c=null;if(d.catch_exceptions)try{c=new GL.Shader(a,b)}catch(e){this._has_error=!0;d.Shaders.dumpShaderError(this.filename,e,a,b);var g=
GL.Shader.parseError(e,a,b),f=this._code.split("\n"),h=-1;if(g.line_code){g=g.line_code.trim();for(h=0;h<f.length;++h)f[h]=f[h].trim();h=f.indexOf(g)}d.dispatchCodeError(e,h,this,"shader")}else c=new GL.Shader(a,b);c&&(d.debug&&console.log(" + shader compiled: ",this.fullpath||this.filename),d.dispatchNoErrors(this,"shader"));return c};P.prototype.clearCache=function(){this._compiled_shaders={}};P.prototype.validatePublicUniforms=function(a){if(!a)throw"ShaderCode: Shader cannot be null";for(var b in this._global_uniforms)a.uniformInfo[this._global_uniforms[b].uniform]||
(info.disabled=!0)};P.prototype.register=function(){d.ResourcesManager.registerResource(this.fullpath||this.filename,this)};P.prototype.applyToMaterials=function(a){a=a||d.GlobalScene;var b=this.fullpath||this.filename,c;for(c in d.ResourcesManager.resources){var e=d.ResourcesManager.resources[c];e.constructor===d.ShaderMaterial&&e._shader==b&&e.processShaderCode()}a=a.getNodes();for(c=0;c<a.length;++c)e=a[c],e.material&&e.material.constructor===d.ShaderMaterial&&e.material._shader==b&&e.material.processShaderCode()};
P.prototype.hasEditableText=function(){return!0};P.removeComments=function(a){return a.replace(/(\/\*([\s\S]*?)\*\/)|(\/\/(.*)$)/gm,"")};P.replaceCode=function(a,b){return GL.Shader.replaceCodeUsingContext(a,b)};P.parseShaderLab=function(a){var b={},c=b,e=[],d=[],f=0,h="";a=P.removeComments(a).split("\n");for(var k=0;k<a.length;++k){var l=a[k].trim(),m=l.match(/[^\s"]+|"([^"]*)"/gi);if(m)if(0!=f){var p=m[0].trim();"ENDGLSL"==p||"ENDCG"==p?(f=0,c.codetype=f,c.code=h,h=""):h+=l+"\n"}else for(l=0;l<
m.length;++l)if(p=m[l],"{"==p)p={name:e[0],params:e.slice(1).join(" "),content:{}},c[p.name]=p,e=[],d.push(c),c=p.content;else if("}"==p){if(0==d.length)return console.error("error parsing ShaderLab code, the number of { do not matches the }"),null;e.length&&(c[e[0]]=e.join(" "),e=[]);c=d.pop()}else"{}"==p?(p={name:e[0],params:e.slice(1).join(" "),content:{}},c[p.name]=p,e=[]):"GLSLPROGRAM"==p||"CGPROGRAM"==p?(f="GLSLPROGRAM"==p?1:2,h=""):e.push(p)}return b};P.getDefaultCode=function(a,b,c){if(P.default_code_instance)return P.default_code_instance;
a=P.default_code_instance=new d.ShaderCode;a.code=P.flat_code;return a};P.default_vs='\nprecision mediump float;\nattribute vec3 a_vertex;\nattribute vec3 a_normal;\nattribute vec2 a_coord;\n#pragma shaderblock "vertex_color"\n#pragma shaderblock "coord1"\n#ifdef BLOCK_COORD1\n\tattribute vec2 a_coord1;\n\tvarying vec2 v_uvs1;\n#endif\n#ifdef BLOCK_VERTEX_COLOR\n\tattribute vec4 a_color;\n\tvarying vec4 v_vertex_color;\n#endif\n\n//varyings\nvarying vec3 v_pos;\nvarying vec3 v_normal;\nvarying vec2 v_uvs;\nvarying vec3 v_local_pos;\nvarying vec3 v_local_normal;\nvarying vec4 v_screenpos;\n\n//matrices\nuniform mat4 u_model;\nuniform mat4 u_normal_model;\nuniform mat4 u_view;\nuniform mat4 u_viewprojection;\n\n//globals\nuniform float u_time;\nuniform vec4 u_viewport;\nuniform float u_point_size;\n\n#pragma shaderblock "morphing"\n#pragma shaderblock "skinning"\n\n//camera\nuniform vec3 u_camera_eye;\nvoid main() {\n\t\n\tvec4 vertex4 = vec4(a_vertex,1.0);\n\tv_local_pos = a_vertex;\n\tv_local_normal = a_normal;\n\tv_normal = a_normal;\n\tv_uvs = a_coord;\n\t#ifdef BLOCK_COORD1\n\t\tv_uvs1 = a_coord1;\n\t#endif\n\t#ifdef BLOCK_VERTEX_COLOR\n\t\tv_vertex_color = a_color;\n\t#endif\n  \n  //deforms\n  applyMorphing( vertex4, v_normal );\n  applySkinning( vertex4, v_normal );\n\t\n\t//vertex\n\tv_pos = (u_model * vertex4).xyz;\n  \n  \n\t//normal\n\tv_normal = (u_normal_model * vec4(v_normal,0.0)).xyz;\n\tgl_Position = u_viewprojection * vec4(v_pos,1.0);\n\tv_screenpos = gl_Position;\n}\n';
P.default_fs="\n\t#ifdef DRAW_BUFFERS\n\t\t#extension GL_EXT_draw_buffers : require \n\t#endif\n\tprecision mediump float;\n\tuniform vec4 u_material_color;\n\tvoid main() {\n\t\t#ifdef DRAW_BUFFERS\n\t\t\tgl_FragData[0] = u_material_color;\n\t\t#else\n\t\t\tgl_FragColor = u_material_color;\n\t\t#endif\n\t}\n";P.flat_code="\n\\color.fs\n"+P.default_fs+"\n";d.ShaderCode=P;d.registerResourceClass(P);Ka.LOGIC_GRAPH=1;Ka.SHADER_GRAPH=2;Ka.EXTENSION="GRAPH.json";Ka.hasPreview=!1;Object.defineProperty(Ka.prototype,
"graph",{enumerable:!1,get:function(){return this._graph},set:function(a){console.error("graph cannot be set manually")}});Object.defineProperty(Ka.prototype,"data",{enumerable:!1,get:function(){return this.getData()},set:function(a){this.setData(a)}});Object.defineProperty(Ka.prototype,"version",{enumerable:!1,get:function(){return this._version},set:function(a){console.error("version cannot be set manually")}});Ka.prototype.setData=function(a,b){if(a){if(d.catch_exceptions)try{this._data=a.constructor===
String?JSON.parse(a):JSON.parse(JSON.stringify(a))}catch(c){console.error("error in graph data");return}else this._data=a.constructor===String?JSON.parse(a):JSON.parse(JSON.stringify(a));this._graph.configure(this._data);this.type=this._data.type||d.GraphCode.LOGIC_GRAPH;this.extra=this._data.extra||{};this.properties=this._data.properties||[];b||(this._version++,this._modified=!0)}else this._data=null,this.properties=[],this.type=d.GraphCode.LOGIC_GRAPH,this.extra={}};Ka.prototype.getData=function(){var a=
this.graph.serialize();a.object_class="GraphCode";a.type=this.type;a.properties=this.properties;a.extra=this.extra;return a};Ka.prototype.getDataToStore=function(){return JSON.stringify(this.getData())};Ka.prototype.getCategory=function(){return"Graph"};Ka.prototype.getProperty=function(a){for(var b=0;b<this.properties.length;++b)if(this.properties[b].name==a)return this.properties[b];return null};Ka.prototype.propagate=function(){if(this.type==Ka.LOGIC_GRAPH)for(var a=d.GlobalScene.findNodeComponents(d.Components.GraphComponent),
b=0;b<a.length;++b){var c=a[b];c.filename==this.filename&&(c.graphcode=this)}};d.GraphCode=Ka;d.registerResourceClass(Ka);if("undefined"!=typeof LiteGraph){var Jb=function(){this.addInput("tween",LiteGraph.ACTION);this.addInput("value","");this.addInput("prop","");this.addOutput("start",LiteGraph.EVENT);this.addOutput("finish",LiteGraph.EVENT);this.properties={duration:1,locator:""}};Jb.title="Tween";Jb.desc="tween between two values";Jb.prototype.onAction=function(a,b){function c(){h.triggerSlot(1)}
var e=this.getInputNode(2),g=this.graph._scene||d.GlobalScene,f=null;if(e){if(!e.getLocatorInfo)return;f=e.getLocatorInfo()}else this.properties.locator&&(this._locator_split||(this._locator_split=this.properties.locator.split("/")),f=g.getPropertyInfoFromPath(this._locator_split));if(f&&(e=this.getInputData(1),null!=e)){var h=this;this.triggerSlot(0);d.Tween.easeProperty(f.target,f.name,e,this.properties.duration,null,c)}};Jb.prototype.onPropertyChanged=function(a,b){"locator"==a&&(this._locator_split=
b?b.split("/"):null)};Jb.prototype.onDropItem=function(a){if(a=a.dataTransfer.getData("uid"))return this.properties.locator=a,!0};LiteGraph.registerNodeType("core/tween",Jb);var Kb=function(){this.addOutput("out","");this.properties={filename:"",type:""}};Kb.title="resource";Kb.desc="gets a resource";Kb.widgets_info={filename:{widget:"resource"}};Kb.prototype.onExecute=function(){var a=null;this.properties.filename&&(a=d.ResourcesManager.resources[this.properties.filename]);a&&this.properties.type&&
a.constructor.name.toLowerCase()!==this.properties.type.toLowerCase()&&(a=null);this.setOutputData(0,a)};Kb.prototype.getResources=function(a){this.properties.filename&&(a[this.properties.filename]=!0)};LiteGraph.registerNodeType("core/resource",Kb);var Lb=function(){this.addOutput("out","mesh");this.properties={name:""}};Lb.title="mesh";Lb.desc="gets mesh";Lb.widgets_info={name:{widget:"mesh"}};Lb.prototype.onExecute=function(){var a=null;this.properties.name&&(a=d.ResourcesManager.meshes[this.properties.name]);
!a||a.constructor===GL.Mesh&&!1!==a.ready||(a=null);this.setOutputData(0,a)};Lb.prototype.getResources=function(a){this.properties.name&&(a[this.properties.name]=!0)};LiteGraph.registerNodeType("geometry/mesh",Lb);var yb=function(){this.addInput("mesh","mesh");this.addInput("material","material");this.addInput("mat4","mat4");this.addInput("instances","[mat4]");this.properties={enabled:!0,primitive:GL.TRIANGLES,use_node_transform:!0,use_node_material:!0}};yb.title="Render";yb.desc="renders a mesh with a material inside the scene";
yb.PRIMITIVE_VALUES={points:GL.POINTS,lines:GL.LINES,line_loop:GL.LINE_LOOP,line_strip:GL.LINE_STRIP,triangles:GL.TRIANGLES,triangle_fan:GL.TRIANGLE_FAN,triangle_strip:GL.TRIANGLE_STRIP};yb.widgets_info={primitive:{widget:"combo",values:yb.PRIMITIVE_VALUES}};yb.prototype.onExecute=function(){if(this.properties.enabled){this._RI||(this._RI=new d.RenderInstance);var a=this.graph._scenenode;if(a){this._RI.fromNode(a,!0);var b=this.getInputData(0);b&&(this._RI.setMesh(b),b=this.getInputData(1),!b&&this.properties.use_node_material&&
(b=a.getMaterial()),b||(b=d.Renderer.default_material),this._RI.setMaterial(b),this._RI.primitive=this.properties.primitive,(b=this.getInputData(2))||(b=this.properties.use_node_transform&&a&&a.transform?a.transform.getGlobalMatrixRef():d.IDENTITY),this._RI.setMatrix(b),a=this.getInputData(3),this._RI.instanced_models=a?a:null,this._RI.use_bounding=!a,d.Renderer.addImmediateRenderInstance(this._RI))}}};LiteGraph.registerNodeType("geometry/render_mesh_in_scene",yb)}"undefined"!=typeof LiteGraph&&(ba.LGraphScene=
function(){this.addOutput("Time","number");this._scene=null},LGraphScene.title="Scene",LGraphScene.desc="Scene",LGraphScene.getComponents=function(a,b){b=b||[];var c=a.getComponents();if(!c)return b;for(var e=0;e<c.length;++e){var g=d.getClassName(c[e].constructor);b.push([g,g])}return b},LGraphScene.prototype.onAdded=function(a){this.bindEvents(this.graph.getScene?this.graph.getScene():d.GlobalScene)},LGraphScene.prototype.onRemoved=function(){this.bindEvents(null)},LGraphScene.prototype.onConnectionsChange=
function(){this.bindEvents(this.graph.getScene?this.graph.getScene():d.GlobalScene)},LGraphScene.prototype.bindEvents=function(a){this._scene&&LEvent.unbindAll(this._scene,this);if((this._scene=a)&&this.outputs&&this.outputs.length)for(a=0;a<this.outputs.length;++a){var b=this.outputs[a];b.type===LiteGraph.EVENT&&(b=b.name.substr(3),LEvent.bind(this._scene,b,this.onEvent,this))}},LGraphScene.prototype.onEvent=function(a,b){this.trigger("on_"+a,b)},LGraphScene.prototype.onExecute=function(){var a=
this.graph.getScene?this.graph.getScene():d.GlobalScene;if(this.inputs)for(var b=0;b<this.inputs.length;++b)this.getInputData(b);if(this.outputs)for(b=0;b<this.outputs.length;++b){var c=this.outputs[b];if(c.links&&c.links.length&&c.type!=LiteGraph.EVENT){var e=null;switch(c.name){case "Time":e=a.getTime();break;case "Elapsed":e=null!=a._last_dt?a._last_dt:0;break;case "Frame":e=null!=a._frame?a._frame:0;break;default:e=a.root.getComponent(c.name)}this.setOutputData(b,e)}}},LGraphScene.prototype.onGetOutputs=
function(){var a=[["Elapsed","number"],["Frame","number"],["on_start",LiteGraph.EVENT],["on_finish",LiteGraph.EVENT]];return LGraphScene.getComponents(this.graph.getScene().root,a)},LiteGraph.registerNodeType("scene/scene",LGraphScene),ba.LGraphSceneNode=function(){this.properties={node_id:""};this.size=[140,30];this._node=null},LGraphSceneNode.title="SceneNode",LGraphSceneNode.desc="Node on the scene",LGraphSceneNode.highlight_color="#CCC",LGraphSceneNode.prototype.onRemoved=function(){this._node&&
this.bindNodeEvents(null)},LGraphSceneNode.prototype.onConnectionsChange=function(){this.bindNodeEvents(this._component)},LGraphSceneNode.prototype.getTitle=function(){var a=this._node||this.getNode();return a?a.name:this.title},LGraphSceneNode.prototype.getNode=function(){var a=null;if(!this.graph)return null;this.inputs&&this.inputs[0]&&(a=this.getInputData(0));if(a&&a.constructor===d.SceneNode)return this._node!=a&&this.bindNodeEvents(a),a;a&&a.constructor===String&&(this.properties.node_id=a);
!a&&this.properties.node_id&&(a=this.properties.node_id);if("@"==a||!a)return this.graph._scenenode?this.graph._scenenode:null;var b=this.graph&&this.graph.getScene?this.graph.getScene():d.GlobalScene;if(b){var c=null;a&&(c=b.getNode(a));this._node!=c&&this.bindNodeEvents(c);return c}},LGraphSceneNode.prototype.onExecute=function(){var a=this.getNode();if(a){if(this.inputs)for(var b=0;b<this.inputs.length;++b){var c=this.inputs[b];if(c.type!==LiteGraph.ACTION){var e=this.getInputData(b);if(void 0!==
e)switch(c.name){case "UID":this.properties.node_id=e;break;case "SceneNode":this.properties.node_id=e?e.uid:null;e&&(a=e);break;case "Transform":a.transform.copyFrom(e);break;case "Material":a.material=e;break;case "Visible":a.flags.visible=e}}}if(this.outputs)for(b=0;b<this.outputs.length;++b)if(c=this.outputs[b],c.links&&c.links.length&&c.type!=LiteGraph.EVENT)switch(c.name){case "SceneNode":this.setOutputData(b,a);break;case "Material":this.setOutputData(b,a.getMaterial());break;case "Mesh":this.setOutputData(b,
a.getMesh());break;case "Transform":this.setOutputData(b,a.transform);break;case "Global Model":this.setOutputData(b,a.transform?a.transform._global_matrix:d.IDENTITY);break;case "Name":this.setOutputData(b,a.name);break;case "Children":this.setOutputData(b,a.children);break;case "UID":this.setOutputData(b,a.uid);break;case "Mesh":this.setOutputData(b,a.getMesh());break;case "Visible":this.setOutputData(b,a.flags.visible);break;default:e=a.getComponentByUId(c.name);if(!e){var g=a.scene.findComponentByUId(c.name);
g&&(e=d.getObjectClassName(g),e=a.getComponent(e))&&(c.name=e.uid)}this.setOutputData(b,e)}}},LGraphSceneNode.prototype.onDrawBackground=function(a){var b=this.getNode();b?b._is_selected?(this.boxcolor=LGraphSceneNode.highlight_color,this.flags.collapsed||(a.fillStyle=LGraphSceneNode.highlight_color,a.fillRect(0,0,this.size[0],2))):this.boxcolor=null:this.boxcolor="red"},LGraphSceneNode.prototype.getComponents=function(a){a=a||[];var b=this.getNode();if(!b)return a;b=b.getComponents();if(!b)return a;
for(var c=0;c<b.length;++c){var e=d.getClassName(b[c].constructor);a.push([b[c].uid,e,{label:e}])}return a},LGraphSceneNode.prototype.onDropItem=function(a){if(a=a.dataTransfer.getData("node_uid"))return this.properties.node_id=a,this.onExecute(),!0},LGraphSceneNode.prototype.onPropertyChanged=function(a,b){"node_id"==a&&this.getNode()},LGraphSceneNode.prototype.bindNodeEvents=function(a){this._node&&LEvent.unbindAll(this._node,this);if((this._node=a)&&this.outputs&&this.outputs.length)for(a=0;a<
this.outputs.length;++a){var b=this.outputs[a];b.type===LiteGraph.EVENT&&(b=b.name.substr(3),LEvent.bind(this._node,b,this.onNodeEvent,this))}},LGraphSceneNode.prototype.onNodeEvent=function(a,b){this.trigger("on_"+a,b)},LGraphSceneNode.prototype.onGetInputs=function(){return this.getComponents([["Visible","boolean"],["UID","string"],["SceneNode","SceneNode"],["Material","Material"]])},LGraphSceneNode.prototype.onGetOutputs=function(){return this.getComponents([["SceneNode","SceneNode"],["Visible",
"boolean"],["Material","Material"],["Mesh","Mesh"],["Name","string"],["UID","string"],["Global Model","mat4"],["Children","scenenode[]"],["on_clicked",LiteGraph.EVENT]])},LGraphSceneNode.prototype.onInspect=function(a){var b=this;a.addButton(null,"Inspect node",function(){var a=b.getNode();a&&EditorModule.inspect(a)})},LiteGraph.registerNodeType("scene/node",LGraphSceneNode),ba.LGraphMaterial=function(){this.properties={material_id:"",node_id:""};this.addInput("","Material");this.addOutput("","Material");
this.material=null;this.addWidget("button","Create","",this.onCreateMaterial.bind(this))},LGraphMaterial.title="Material",LGraphMaterial.desc="Material of a node",LGraphMaterial.prototype.onCreateMaterial=function(a,b,c,e,g){a=Object.keys(d.MaterialClasses);a.push(null,"clear");new LiteGraph.ContextMenu(a,{event:g,callback:function(a){"clear"==a?f.material=null:d.MaterialClasses[a]&&(a=new d.MaterialClasses[a],f.material=a,EditorModule.inspect(f))}});var f=this},LGraphMaterial.prototype.getResources=
function(a){this.material&&this.material.getResources&&this.material.getResources(a)},LGraphTexture.prototype.onResourceRenamed=function(a,b){if(this.material&&this.material.onResourceRenamed)this.material.onResourceRenamed(a,b)},LGraphMaterial.prototype.onExecute=function(){var a=this.getMaterial();if(a){for(var b=0;b<this.inputs.length;++b){var c=this.inputs[b],e=this.getInputData(b);void 0!==e&&"Material"!=c.name&&a.setProperty(c.name,e)}if(this.outputs)for(this.setOutputData(0,a),b=1;b<this.outputs.length;++b)c=
this.outputs[b],c.links&&c.links.length&&(e=a.getProperty(c.name),this.setOutputData(b,e))}},LGraphMaterial.prototype.getMaterial=function(){if(this.material)return this.material;var a=this.findInputSlot("Material");return-1!=a?this.getInputData(a):this.properties.material_id&&d.RM.materials[this.properties.material_id]?d.RM.materials[this.properties.material_id]:this.properties.node_id&&(a=this.graph.getScene().getNode(this.properties.node_id))?a.getMaterial():null},LGraphMaterial.prototype.onGetInputs=
function(){var a=this.getMaterial();if(a){var a=a.getPropertiesInfo(),b=[["Material","Material"]],c;for(c in a)b.push([c,a[c]]);return b}},LGraphMaterial.prototype.onGetOutputs=function(){var a=this.getMaterial();if(a){var a=a.getPropertiesInfo(),b=[["Material","Material"]],c;for(c in a)b.push([c,a[c]]);return b}},LGraphMaterial.prototype.onSerialize=function(a){this.material&&this.material.serialize&&(a.material=this.material.serialize(),a.material.className=d.getObjectClassName(this.material))},
LGraphMaterial.prototype.onConfigure=function(a){if(a.material){var b=d.MaterialClasses[a.material.className];b&&(this.material=new b,this.material.configure(a.material))}},LGraphMaterial.prototype.onInspect=function(a){var b=this.getMaterial();b&&(a.addTitle("Material ("+d.getObjectClassName(b)+")"),EditorModule.showMaterialProperties(b,a))},LiteGraph.registerNodeType("scene/material",LGraphMaterial),ba.LGraphMaterial=LGraphMaterial,ba.LGraphGlobal=function(){this.addOutput("Value");this.properties=
{name:"myvar",value:0,type:"number",widget:"default",min:0,max:1}},LGraphGlobal.title="Global",LGraphGlobal.desc="Global var for the graph",LGraphGlobal["@type"]={type:"enum",values:"number boolean string node vec2 vec3 vec4 color texture".split(" ")},LGraphGlobal["@widget"]={type:"enum",values:["default","slider","pad"]},LGraphGlobal.prototype.onExecute=function(){this.properties.name&&this.setOutputData(0,this.properties.value)},LGraphGlobal.prototype.onDrawBackground=function(){this.outputs[0].label=
this.properties.name},LiteGraph.registerNodeType("scene/global",LGraphGlobal),ba.LGraphSceneTime=function(){this.addOutput("Time","number");this._scene=null},LGraphSceneTime.title="Time",LGraphSceneTime.desc="Time",LGraphSceneTime.prototype.onExecute=function(){var a=this.graph.getScene();if(a){if(this.inputs)for(var b=0;b<this.inputs.length;++b)this.getInputData(b);if(this.outputs)for(b=0;b<this.outputs.length;++b){var c=this.outputs[b];if(c.links&&c.links.length&&c.type!=LiteGraph.EVENT){var e=
null;switch(c.name){case "Time":e=a.getTime();break;case "Elapsed":e=null!=a._last_dt?a._last_dt:0;break;case "Frame":e=null!=a._frame?a._frame:0;break;default:continue}this.setOutputData(b,e)}}}},LGraphSceneTime.prototype.onGetOutputs=function(){return[["Elapsed","number"],["Time","number"]]},LiteGraph.registerNodeType("scene/time",LGraphSceneTime),ba.LGraphLocatorProperty=function(){this.addInput("in");this.addOutput("out");this.properties={locator:"",cache_object:!0};this._locator_info=this._locator_split=
null},LGraphLocatorProperty.title="Property",LGraphLocatorProperty.desc="A property of a node or component of the scene specified by its locator string",LGraphLocatorProperty.highlight_color="#CCC",LGraphLocatorProperty.prototype.getLocatorInfo=function(a){if(!this._locator_split)return null;if(!a&&this.properties.cache_object&&this._locator_info)return this._locator_info;if(!this.graph)return null;(this._locator_info=(this.graph._scene||d.GlobalScene).getPropertyInfoFromPath(this._locator_split))&&
this.inputs&&this.inputs.length&&(this.inputs[0].type=this._locator_info.type);return this._locator_info},LGraphLocatorProperty.prototype.onDropItem=function(a){a.dataTransfer.getData("type");if(a=a.dataTransfer.getData("uid"))return this.properties.locator=a,this.onExecute(),!0},LGraphLocatorProperty.prototype.onPropertyChanged=function(a,b){"locator"==a&&(this._locator_split=b?b.split("/"):null)},LGraphLocatorProperty.prototype.onAction=function(a,b){var c=this.getLocatorInfo();Oa.setFromInfo(c,
!Oa.getFromInfo(c))},LGraphLocatorProperty.prototype.getTitle=function(){return this.title&&this.title!=LGraphLocatorProperty.title||!this._locator_info?this.title||LGraphLocatorProperty.title:this._locator_info.name},LGraphLocatorProperty.prototype.onDrawBackground=function(a){var b=this.getLocatorInfo();b?b.node&&b.node._is_selected?(this.boxcolor=LGraphLocatorProperty.highlight_color,this.flags.collapsed||(a.fillStyle=LGraphLocatorProperty.highlight_color,a.fillRect(0,0,this.size[0],2))):this.boxcolor=
null:this.boxcolor="red"},LGraphLocatorProperty.prototype.onExecute=function(){var a=this.getLocatorInfo();if((this._last_info=a)&&a.target){if(this.inputs.length&&null!==this.inputs[0].link){var b=this.getInputData(0);void 0!==b&&Oa.setFromInfo(a,b)}this.outputs.length&&this.outputs[0].links&&this.outputs[0].links.length&&this.setOutputData(0,Oa.getFromInfo(a))}this.setOutputData(1,this.properties.locator)},LGraphLocatorProperty.prototype.onInspect=function(a){var b=this.getLocatorInfo(!0);if(b){a.addSeparator();
var c=b.type,e=null;b.target&&b.target.constructor["@"+b.name]&&(e=b.target.constructor["@"+b.name],e.widget?c=e.widget:e.type&&(c=e.type));a.add(c,b.name,b.value,{callback:function(a){d.setObjectProperty(b.target,b.name,a)}})}},LGraphLocatorProperty.prototype.onGetOutputs=function(){return[["locator","string"]]},LiteGraph.registerNodeType("scene/property",LGraphLocatorProperty),ba.LGraphToggleValue=function(){this.addInput("target","Component");this.addInput("toggle",LiteGraph.ACTION);this.properties=
{property_name:"enabled"}},LGraphToggleValue.title="Toggle",LGraphToggleValue.desc="Toggle a property value",LGraphToggleValue.prototype.getTitle=function(){return"Toggle: "+this.properties.property_name},LGraphToggleValue.prototype.onAction=function(a,b){var c=this.getInputData(0,!0);if(c){var e=this.properties.property_name||"enabled";void 0!==c[e]&&(c[e]=!c[e])}},LiteGraph.registerNodeType("scene/toggle",LGraphToggleValue),ba.LGraphFrame=function(){this.addOutput("Color","Texture");this.addOutput("Depth",
"Texture");this.addOutput("Extra","Texture");this.addOutput("Camera","Camera");this.properties={}},LGraphFrame.title="Frame",LGraphFrame.desc="One frame rendered from the scene renderer",LGraphFrame.prototype.onExecute=function(){this.setOutputData(0,LGraphTexture.getTexture(this._color_texture));this.setOutputData(1,LGraphTexture.getTexture(this._depth_texture));this.setOutputData(2,LGraphTexture.getTexture(this._extra_texture));this.setOutputData(3,this._camera)},LGraphFrame.prototype.onDrawBackground=
function(a){if(!(this.flags.collapsed||20>=this.size[1])&&this._color_texture&&a.webgl){if(this._last_preview_tex!=this._last_tex||!this._last_preview_tex)if(a.webgl&&this._canvas&&this._canvas.constructor===GL.Texture)this._canvas=this._last_tex;else{var b=LGraphTexture.getTexture(this._color_texture);if(!b)return;b=LGraphTexture.generateLowResTexturePreview(b);if(!b)return;this._last_preview_tex=this._last_tex;this._canvas=cloneCanvas(b)}if(this._canvas){a.save();if(!a.webgl){if(this._canvas.constructor===
GL.Texture){this._canvas=null;return}a.translate(0,this.size[1]);a.scale(1,-1)}a.drawImage(this._canvas,0,0,this.size[0],this.size[1]);a.restore()}}},LGraphFrame.prototype.onInspect=function(a){var b=this;this.graph.component&&(a.showObjectFields(this.graph.component.frame),a.addSeparator(),a.addCheckbox("Antialiasing",this.graph.component.use_antialiasing,function(a){b.graph.component.use_antialiasing=a}))},LiteGraph.registerNodeType("scene/frame",LGraphFrame));"undefined"!=typeof LiteGraph&&(ba.LGraphComponent=
function(){this.properties={node_id:"",component_id:""};this._component=null},LGraphComponent.title="Component",LGraphComponent.desc="A component from a node",LGraphComponent.highlight_color="#CCC",LGraphComponent.prototype.onRemoved=function(){this.bindComponentEvents(null)},LGraphComponent.prototype.onConnectionsChange=function(a){this.bindComponentEvents(this._component)},LGraphComponent.prototype.onInit=function(){var a=this.getComponent();a&&this.processOutputs(a)},LGraphComponent.prototype.processOutputs=
function(a){if(this.outputs&&this.outputs.length)for(var b=0;b<this.outputs.length;b++){var c=this.outputs[b];if(c.links&&c.links.length&&c.type!=LiteGraph.EVENT)if("Component"==c.name)this.setOutputData(b,a);else if(a.getProperty){var e=a.getProperty(c.name);void 0!==e?this.setOutputData(b,e):this.setOutputData(b,a[c.name])}else this.setOutputData(b,a[c.name])}},LGraphComponent.prototype.onExecute=function(){var a=this.getComponent();if(a){if(this.inputs)for(var b=0;b<this.inputs.length;b++){var c=
this.inputs[b];if(c.type!==LiteGraph.ACTION){var e=this.getInputData(b);void 0!==e&&d.setObjectProperty(a,c.name,e)}}this.processOutputs(a)}},LGraphComponent.updateOutputData=function(a){if(this.outputs&&!(a>=this.outputs.length)){var b=this.outputs[Ub];if(b.links&&b.links.length&&b.type!=LiteGraph.EVENT){var c=this.getComponent();c&&("Component"==b.name?this.setOutputData(a,c):this.setOutputData(a,c[b.name]))}}},LGraphComponent.prototype.onDrawBackground=function(a){var b=this.getComponent();if(b&&
b._root){var c=this.boxcolor=null;b._root._is_selected&&(c=LGraphComponent.highlight_color);b._is_selected&&(c="#39F");c&&(this.boxcolor=c,this.flags.collapsed||(a.fillStyle=c,a.fillRect(0,0,this.size[0],2)));this.title=d.getClassName(b.constructor)}else this.boxcolor="red"},LGraphComponent.prototype.onConnectionsChange=function(a,b,c,e,d){a==LiteGraph.INPUT&&d&&"Component"==d.name&&(a=this.getInputNode(b))&&a.onExecute&&(a.onExecute(),this.setDirtyCanvas(!0,!0))},LGraphComponent.prototype.getComponent=
function(){var a=this.graph._scene||d.GlobalScene,b=this.properties.node_id;if(!b)return this.inputs&&this.inputs.length&&(a=this.findInputSlot("Component"),-1!=a)?(a=this.getInputData(a))?a:null:null;a=a.getNode(b);if(!a)return null;var b=this.properties.component_id,c=null;if("@"==b.charAt(0))c=a.getComponentByUId(b);else if(d.Components[b])c=a.getComponent(d.Components[b]);else return null;if(c&&!c.constructor.is_component)return null;this._component!=c&&this.bindComponentEvents(c);return this._component=
c},LGraphComponent.prototype.bindComponentEvents=function(a){this._component&&LEvent.unbindAll(this._component,this);if((this._component=a)&&this.outputs&&this.outputs.length)for(a=0;a<this.outputs.length;++a){var b=this.outputs[a];b.type===LiteGraph.EVENT&&(b=b.name.substr(3),LEvent.bind(this._component,b,this.onComponentEvent,this))}},LGraphComponent.prototype.onComponentEvent=function(a,b){this.trigger("on_"+a,b)},LGraphComponent.prototype.getComponentProperties=function(a,b){var c=this.getComponent();
if(!c)return null;var e=null,e=c.getPropertiesInfo?c.getPropertiesInfo(a):d.getObjectProperties(c);b=b||[];for(var g in e)b.push([g,e[g]]);c.constructor.getExtraProperties&&c.constructor.getExtraProperties(b);c.getExtraProperties&&c.getExtraProperties(b);return b},LGraphComponent.prototype.onAction=function(a,b){if(a){var c=this.getComponent();if(c)if(c.onAction)c.onAction(a,b);else if(c[a])c[a]()}},LGraphComponent.prototype.onSetValue=function(a,b){var c=this.getComponent();if(c){var e=c[a],d;if(null==
e)b&&b.constructor===String&&(d=b);else switch(e.constructor){case Number:d=Number(b);break;case Boolean:d="true"==b||"1"==b;break;case String:d=String(b);break;case Array:case Float32Array:d=null!=b?b.constructor===String?JSON.parse("["+b+"]"):b.constructor===Number?[b]:b:b}void 0!==d&&(c.setPropertyValue?c.setPropertyValue(a,d):c[a]=d)}},LGraphComponent.prototype.onGetInputs=function(){var a=[["Node",0],["Component",0],["Trigger",LiteGraph.ACTION],null];this.getComponentProperties("input",a);var b=
this.getComponent();if(b&&b.getActions&&(b=b.getActions({})))if(b.constructor===Array)for(var c=0;c<b.length;++c)a.push([b[c],LiteGraph.ACTION]);else for(c in b)a.push([c,LiteGraph.ACTION]);return a},LGraphComponent.prototype.onGetOutputs=function(){var a=[];a.push(["Component","Component"],null);this.getComponentProperties("output",a);var b=this.getComponent();if(b&&b.getEvents&&(b=b.getEvents()))if(b.constructor===Array)for(var c=0;c<b.length;++c)a.push(["on_"+b[c],LiteGraph.EVENT]);else for(c in b)a.push(["on_"+
c,LiteGraph.EVENT]);return a},LGraphComponent.prototype.onInspect=function(a){var b=this,c=this.getComponent();if(c&&c.onInspectNode)c.onInspectNode(a,this);a.addButton(null,"Inspect Component",function(){var a=b.getComponent();a&&EditorModule.inspect(a)})},LiteGraph.registerNodeType("scene/component",LGraphComponent),ba.LGraphTransform=function(){this.properties={node_id:""};LGraphSceneNode._current_node_id&&(this.properties.node_id=LGraphSceneNode._current_node_id);this.addInput("Transform","Transform",
{locked:!0});this.addOutput("Position","vec3")},LGraphTransform.title="Transform",LGraphTransform.desc="Transform info of a node",LGraphTransform.prototype.onExecute=function(){var a=null;this.inputs&&this.inputs[0]&&(a=this.getInputData(0));if(!a){var a=this.graph.getScene?this.graph.getScene():d.GlobalScene,b=this._node;if(this.properties.node_id&&(b=a.getNode(this.properties.node_id),!b))return;b||(b=this.graph._scenenode);a=b.transform}if(a){if(this.inputs)for(b=1;b<this.inputs.length;++b){var c=
this.inputs[b],e=this.getInputData(b);if(void 0!==e)switch(c.name){case "x":a.x=e;break;case "y":a.y=e;break;case "z":a.z=e;break;case "Position":a.setPosition(e);break;case "Rotation":a.setRotation(e);break;case "Scale":a.setScale(e);break;case "Matrix":a.fromMatrix(e);break;case "Mult.Matrix":a.applyTransformMatrix(e);break;case "Translate":a.translate(e);break;case "Translate Global":a.translateGlobal(e);break;case "Rotate":quat.multiply(a._rotation,a._rotation,e);a._must_update=!0;break;case "RotateX":a.rotateX(e);
break;case "RotateY":a.rotateY(e);break;case "RotateZ":a.rotateZ(e)}}if(this.outputs)for(b=0;b<this.outputs.length;++b)if(c=this.outputs[b],c.links&&c.links.length){e=void 0;switch(c.name){case "x":e=a.x;break;case "y":e=a.y;break;case "z":e=a.z;break;case "Position":e=a.position;break;case "Global Position":e=a.getGlobalPosition();break;case "Rotation":e=a.rotation;break;case "Global Rotation":e=a.getGlobalRotation();break;case "Scale":e=a.scaling;break;case "Matrix":e=a.getMatrix()}void 0!==e&&
this.setOutputData(b,e)}}},LGraphTransform.prototype.onGetInputs=function(){return[["Position","vec3"],["Rotation","quat"],["Scale","number"],["x","number"],["y","number"],["z","number"],["Global Position","vec3"],["Global Rotation","quat"],["Matrix","mat4"],["Mult.Matrix","mat4"],["Translate","vec3"],["Translate Global","vec3"],["Rotate","quat"],["RotateX","number"],["RotateY","number"],["RotateZ","number"]]},LGraphTransform.prototype.onGetOutputs=function(){return[["Position","vec3"],["Rotation",
"quat"],["Scale","number"],["x","number"],["y","number"],["z","number"],["Global Position","vec3"],["Global Rotation","quat"],["Matrix","mat4"]]},LiteGraph.registerNodeType("scene/transform",LGraphTransform));"undefined"!=typeof LiteGraph&&(ba.LGraphSetValue=function(){this.properties={property_name:"",value:"",type:"String"};this.addInput("on_set",LiteGraph.ACTION);this.addInput("value","");this.addOutput("on",LiteGraph.EVENT);this.addOutput("node",0);this.mode=LiteGraph.ON_TRIGGER},LGraphSetValue.prototype.onAction=
function(a,b){if(this.properties.property_name){var c=this.getOutputNodes(1);if(c){for(var e=this.getInputOrProperty("value"),d=0;d<c.length;++d){var f=c[d];if(f.onSetValue)f.onSetValue(this.properties.property_name,e);else if(f.properties&&void 0!==f.properties.value&&(f.properties[this.properties.property_name]=e,f.onPropertyChanged))f.onPropertyChanged(this.properties.property_name,e)}this.trigger("on")}}},LGraphSetValue.title="SetValue",LGraphSetValue.desc="sets a value to a node (could be a property)",
LiteGraph.registerNodeType("logic/setValue",LGraphSetValue));if("undefined"!=typeof LiteGraph){var lc=!1;"undefined"==typeof LGraphTexture?console.error("LiteGraph found but no LGraphTexture, this means LiteGL wasnt not included BEFORE litegraph. Be sure to include LiteGL before LiteGraph to ensure all functionalities."):lc=!0;var pb=function(){this.addInput("Color","Texture");this.addInput("Depth","Texture");this.addInput("Intensity","number");this.addOutput("Final","Texture");this.properties={intensity:1,
preserve_aspect:!0};this._fx_stack=new d.FXStack;this._fx_options={}};pb.title="FXStack";pb.desc="Apply FXs to Texture";pb.prototype.onExecute=function(){var a=this.getInputData(0);if(a&&this.isOutputConnected(0)){var b=this._final_texture;b&&b.width==a.width&&b.height==a.height&&b.type==a.type||(this._final_texture=new GL.Texture(a.width,a.height,{type:a.type,format:gl.RGBA,filter:gl.LINEAR}));this.isInputConnected(1)&&(this._fx_options.depth_texture=this.getInputData(1));b=this.properties.intensity;
this.isInputConnected(2)&&(b=this.getInputData(2),this.properties.intensity=b);this._fx_stack.applyFX(a,this._final_texture,this._fx_options);this.setOutputData(0,this._final_texture)}};pb.prototype.onInspect=function(a){return this._fx_stack.inspect(a)};pb.prototype.getResources=function(a){return this._fx_stack.getResources(a)};pb.prototype.onSerialize=function(a){a.stack=this._fx_stack.serialize()};pb.prototype.onConfigure=function(a){a.stack&&this._fx_stack.configure(a.stack)};LiteGraph.registerNodeType("texture/fxstack",
pb);var va=function(){this.addInput("in","Texture");this.addInput("enabled","Boolean");this.addOutput("out","Texture");this.properties={enabled:!0,scale:0.5,position:[0,0],size:[1,1]}};va.title="Histogram";va.desc="Overlaps an histogram";va.priority=2;va.prototype.onExecute=function(){var a=this.getInputData(0);if(a){var b=this.getInputData(1);null!=b&&(this.properties.enabled=Boolean(b));if(this.properties.precision===LGraphTexture.PASS_THROUGH||!1===this.properties.enabled)this.setOutputData(0,
a);else{if(!this._points_mesh){for(var b=new Float32Array(393216),c=0;256>c;++c)for(var e=0;512>e;++e)b.set([e/512,c/256,0],1536*c+3*e);this._points_mesh=GL.Mesh.load({vertices:b})}this._texture||(this._texture=new GL.Texture(256,1,{type:gl.FLOAT,magFilter:gl.LINEAR,format:gl.RGB}));va._shader||(va._shader=new GL.Shader(va.vertex_shader,va.pixel_shader));var d=this._points_mesh,f=va._shader,c=this.properties.scale;f.setUniform("u_texture",0);f.setUniform("u_factor",1/512);a.bind(0);gl.disable(gl.DEPTH_TEST);
gl.enable(gl.BLEND);gl.blendFunc(gl.ONE,gl.ONE);this._texture.drawTo(function(){gl.clearColor(0,0,0,1);gl.clear(gl.COLOR_BUFFER_BIT);for(var a=0;3>a;++a)gl.colorMask(0==a,1==a,2==a,!0),f.setUniform("u_mask",va.masks[a]),f.draw(d,gl.POINTS);gl.colorMask(!0,!0,!0,!0)});if(!this._line_mesh){b=new Float32Array(768);for(e=0;256>e;++e)b.set([e/256,0,0],3*e);this._line_mesh=GL.Mesh.load({vertices:b})}va._line_shader||(va._line_shader=new GL.Shader(va.line_vertex_shader,va.line_pixel_shader));d=this._line_mesh;
f=va._line_shader;f.setUniform("u_texture",0);f.setUniform("u_scale",c);this._texture.bind(0);gl.disable(gl.BLEND);gl.viewport(this.properties.position[0]*gl.canvas.width,this.properties.position[1]*gl.canvas.height,this.properties.size[0]*gl.canvas.width,this.properties.size[1]*gl.canvas.height);for(a=0;3>a;++a)f.setUniform("u_mask",va.masks[a]),f.draw(d,gl.LINE_STRIP);this.setOutputData(0,this._texture);gl.viewport(0,0,gl.canvas.width,gl.canvas.height)}}};va.masks=[vec3.fromValues(1,0,0),vec3.fromValues(0,
1,0),vec3.fromValues(0,0,1)];va.vertex_shader="precision highp float;\n\t\n\tattribute vec3 a_vertex;\n\tuniform sampler2D u_texture;\n\tuniform vec3 u_mask;\n\t\n\tvoid main() {\n\t\tvec3 color = texture2D( u_texture, a_vertex.xy ).xyz * u_mask;\n\t\tfloat pos = min(1.0,length(color));\n\t\tgl_Position = vec4(pos*2.0-1.0,0.5,0.0,1.0);\n\t\tgl_PointSize = 1.0;\n\t}\n";va.pixel_shader="precision highp float;\n\tuniform float u_factor;\n\tvoid main() {\n\t\tgl_FragColor = vec4(u_factor);\n\t}\n";va.line_vertex_shader=
"precision highp float;\n\t\n\tattribute vec3 a_vertex;\n\tuniform sampler2D u_texture;\n\tuniform vec3 u_mask;\n\tuniform float u_scale;\n\t\n\tvoid main() {\n\t\tvec3 color = texture2D( u_texture, a_vertex.xy ).xyz * u_mask;\n\t\tfloat pos = length(color);\n\t\tgl_Position = vec4(a_vertex.x*2.0-1.0, u_scale*pos*2.0-1.0,0.0,1.0);\n\t}\n";va.line_pixel_shader="precision highp float;\n\tuniform vec3 u_mask;\n\tvoid main() {\n\t\tgl_FragColor = vec4(u_mask,1.0);\n\t}\n";LiteGraph.registerNodeType("texture/histogram",
va);var xa=function(){this.addInput("color","Texture");this.addInput("depth","Texture");this.addInput("camera","Camera");this.addOutput("out","Texture");this.properties={enabled:!0,intensity:1,ghosting_mitigation:!0,ghosting_threshold:0.4,freeze_camera:!1,low_quality:!1,precision:LGraphTexture.DEFAULT};this._inv_matrix=mat4.create();this._previous_viewprojection_matrix=mat4.create();this._uniforms={u_color_texture:0,u_depth_texture:1,u_inv_vp:this._inv_matrix,u_intensity:1,u_camera_planes:null,u_viewprojection_matrix:null,
u_previous_viewprojection_matrix:this._previous_viewprojection_matrix}};xa.widgets_info={precision:{widget:"combo",values:lc?LGraphTexture.MODE_VALUES:[]}};xa.title="Camera Motion Blur";xa.desc="A motion blur but only for camera movement";xa.prototype.onExecute=function(){var a=this.getInputData(0),b=this.getInputData(1),c=this.getInputData(2);if(this.isOutputConnected(0)&&a&&b&&c){var e=this.getInputData(3);null!=e&&(this.properties.enabled=Boolean(e));if(this.properties.precision===LGraphTexture.PASS_THROUGH||
!1===this.properties.enabled)this.setOutputData(0,a);else{var e=a.width,d=a.height,f=this.precision===LGraphTexture.LOW?gl.UNSIGNED_BYTE:gl.HIGH_PRECISION_FORMAT;this.precision===LGraphTexture.DEFAULT&&(f=a.type);this._tex&&this._tex.width==e&&this._tex.height==d&&this._tex.type==f||(this._tex=new GL.Texture(e,d,{type:f,format:gl.RGBA,filter:gl.LINEAR}));this.properties.low_quality?xa._shader_low||(xa._shader_low=new GL.Shader(GL.Shader.SCREEN_VERTEX_SHADER,xa.pixel_shader,{SAMPLES:"4"}),xa._shader_no_ghosting_low=
new GL.Shader(GL.Shader.SCREEN_VERTEX_SHADER,xa.pixel_shader,{GHOST_CORRECTION:"",SAMPLES:"4"})):xa._shader||(xa._shader=new GL.Shader(GL.Shader.SCREEN_VERTEX_SHADER,xa.pixel_shader),xa._shader_no_ghosting=new GL.Shader(GL.Shader.SCREEN_VERTEX_SHADER,xa.pixel_shader,{GHOST_CORRECTION:""}));var h=null,h=this.properties.low_quality?this.properties.ghosting_mitigation?xa._shader_no_ghosting_low:xa._shader_low:this.properties.ghosting_mitigation?xa._shader_no_ghosting:xa._shader,e=this._inv_matrix,d=
c._viewprojection_matrix,f=this._previous_viewprojection_matrix,k=this._uniforms;k.u_intensity=this.properties.intensity;k.u_viewprojection_matrix=c._viewprojection_matrix;k.u_camera_planes=c._uniforms.u_camera_planes;k.u_ghosting_threshold=this.properties.ghosting_threshold||0.4;for(var l=0,m=0;m<f.length;++m)l+=Math.abs(d[m]-f[m]);mat4.invert(e,c._viewprojection_matrix);this._tex.drawTo(function(){gl.disable(gl.DEPTH_TEST);gl.disable(gl.CULL_FACE);gl.disable(gl.BLEND);a.bind(0);b.bind(1);var c=
GL.Mesh.getScreenQuad();h.uniforms(k).draw(c)});this.properties.freeze_camera||f.set(c._viewprojection_matrix);this.setOutputData(0,this._tex)}}};xa.prototype.onGetInputs=function(){return[["enabled","boolean"]]};xa.pixel_shader="precision highp float;\n\t\t\n\t\tuniform sampler2D u_color_texture;\n\t\tuniform sampler2D u_depth_texture;\n\t\tvarying vec2 v_coord;\n\t\tuniform mat4 u_inv_vp;\n\t\tuniform mat4 u_viewprojection_matrix;\n\t\tuniform mat4 u_previous_viewprojection_matrix;\n\t\tuniform vec2 u_camera_planes;\n\t\tuniform float u_intensity;\n\t\tuniform float u_ghosting_threshold;\n\t\t#ifndef SAMPLES\n\t\t\t#define SAMPLES 16\n\t\t#endif\n\t\t\n\t\tvoid main() {\n\t\t\tvec2 uv = v_coord;\n\t\t\tfloat depth = texture2D(u_depth_texture, uv).x;\n\t\t\tfloat zNear = u_camera_planes.x;\n\t\t\tfloat zFar = u_camera_planes.y;\n\t\t\t//float z = (2.0 * zNear) / (zFar + zNear - depth * (zFar - zNear));\n\t\t\tdepth = depth * 2.0 - 1.0;\n\t\t\tfloat z = zNear * (depth + 1.0) / (zFar + zNear - depth * (zFar - zNear));\n\t\t\tvec4 screenpos = vec4( uv * 2.0 - vec2(1.0), depth, 1.0 );\n\t\t\tvec4 pos = u_inv_vp * screenpos;\n\t\t\tpos /= pos.w;\n\t\t\tvec4 old_screenpos = u_previous_viewprojection_matrix * pos;\n\t\t\told_screenpos /= old_screenpos.w;\n\t\t\tvec2 uv_final = old_screenpos.xy * 0.5 + vec2(0.5);\n\t\t\tvec2 uv_delta = (uv_final - uv);\n\t\t\tuv -= uv_delta * 0.5;\n\t\t\t//uv_delta *= 1.0 - z;\n\t\t\tuv_delta *= u_intensity / float(SAMPLES);\n\t\t\tvec4 color = vec4(0.0);\n\t\t\tfloat total = 0.0;\n\t\t\tfloat amount = 1.0;\n\t\t\tfor(int i = 0; i < SAMPLES; ++i)\n\t\t\t{\n\t\t\t\t#ifdef GHOST_CORRECTION\n\t\t\t\t\tfloat old_depth = texture2D(u_depth_texture, uv).x;\n\t\t\t\t\told_depth = old_depth * 2.0 - 1.0;\n\t\t\t\t\tfloat old_z = zNear * (old_depth + 1.0) / (zFar + zNear - old_depth * (zFar - zNear));\n\t\t\t\t\tif( abs(old_z - z) > u_ghosting_threshold )\n\t\t\t\t\t{\n\t\t\t\t\t\tuv += uv_delta;\n\t\t\t\t\t\tcontinue;\n\t\t\t\t\t}\n\t\t\t\t#endif\n\t\t\t\tcolor += texture2D( u_color_texture, uv );\n\t\t\t\tuv += uv_delta;\n\t\t\t\ttotal += amount;\n\t\t\t}\n\t\t\tgl_FragColor = color / total;\n\t\t\t//gl_FragColor = vec4( abs( old_screenpos.xy ), 1.0, 1.0 );\n\t\t\t//gl_FragColor = texture2D( u_color_texture, uv_final );\n\t\t\t//gl_FragColor = vec4( abs( pos.xyz * 0.001 ), 1.0 );\n\t\t\t//gl_FragColor = vec4( vec3( abs(old_z - z) ), 1.0);\n\t\t}\n\t\t";
LiteGraph.registerNodeType("texture/motionBlur",xa);var Wa=function(){this.addInput("color","Texture");this.addInput("depth","Texture");this.addInput("camera","Camera");this.addInput("light","Light,Component");this.addOutput("out","Texture");this.properties={enabled:!0,intensity:1,attenuation:2,precision:LGraphTexture.DEFAULT};this._inv_matrix=mat4.create();this._uniforms={u_color_texture:0,u_depth_texture:1,u_shadow_texture:2,u_noise_texture:3,u_intensity:1,u_camera_planes:null,u_inv_vp:this._inv_matrix,
u_rand:vec2.create()}};Wa.widgets_info={precision:{widget:"combo",values:LGraphTexture.MODE_VALUES}};Wa.title="Volumetric Light";Wa.desc="Adds fog with volumetric light";Wa.prototype.onExecute=function(){var a=this.getInputData(0),b=this.getInputData(1),c=this.getInputData(2),e=this.getInputData(3);if(this.isOutputConnected(0)){var g=this.getInputData(4);null!=g&&(this.properties.enabled=Boolean(g));var f=null;e&&e._shadowmap&&(f=e._shadowmap._texture);if(this.properties.precision!==LGraphTexture.PASS_THROUGH&&
!1!==this.properties.enabled&&b&&c&&e&&f){var g=b.width,h=b.height,k=this.precision===LGraphTexture.LOW?gl.UNSIGNED_BYTE:gl.HIGH_PRECISION_FORMAT;this.precision===LGraphTexture.DEFAULT&&(k=a?a.type:gl.UNSIGNED_BYTE);this._tex&&this._tex.width==g&&this._tex.height==h&&this._tex.type==k||(this._tex=new GL.Texture(g,h,{type:k,format:gl.RGBA,filter:gl.LINEAR}));Wa._shader_spot||(Wa._shader_spot=new GL.Shader(GL.Shader.SCREEN_VERTEX_SHADER,Wa.pixel_shader,{USE_SPOT:""}),Wa._shader_directional=new GL.Shader(GL.Shader.SCREEN_VERTEX_SHADER,
Wa.pixel_shader,{USE_DIRECTIONAL:""}));var l=null;switch(e.type){case d.Light.SPOT:l=Wa._shader_spot;break;case d.Light.DIRECTIONAL:l=Wa._shader_directional;break;case d.Light.OMNI:console.warn("volumetric light not supported for omni lights");this.properties.enabled=!1;return;default:return}g=this.properties.intensity;mat4.invert(this._inv_matrix,c._viewprojection_matrix);var m=this._uniforms;m.u_intensity=g;m.u_camera_planes=c._uniforms.u_camera_planes;m.u_shadow_params=e._uniforms.u_shadow_params;
m.u_attenuation=this.properties.attenuation;m.u_rand[1]=m.u_rand[0]=0;var p=e._uniforms;a||(a=d.Renderer._black_texture);var n=LGraphTexture.getNoiseTexture();this._tex.drawTo(function(){gl.disable(gl.DEPTH_TEST);gl.disable(gl.CULL_FACE);gl.disable(gl.BLEND);if(e.enabled){a.bind(0);b.bind(1);f.bind(2);n.bind(3);var c=GL.Mesh.getScreenQuad();l.uniforms(p);l.uniforms(m).draw(c)}else a.toViewport()});this.setOutputData(0,this._tex)}else this.setOutputData(0,a)}};Wa.prototype.onGetInputs=function(){return[["enabled",
"boolean"]]};Wa.pixel_shader="precision highp float;\n\t\t\n\t\tuniform sampler2D u_color_texture;\n\t\tuniform sampler2D u_depth_texture;\n\t\tuniform sampler2D u_shadow_texture;\n\t\tuniform sampler2D u_noise_texture;\n\t\tvarying vec2 v_coord;\n\t\tuniform mat4 u_inv_vp;\n\t\tuniform mat4 u_light_viewprojection_matrix;\n\t\tuniform vec2 u_camera_planes;\n\t\tuniform vec4 u_shadow_params;\n\t\tuniform vec4 u_light_info;\n\t\tuniform vec3 u_light_front;\n\t\tuniform vec3 u_light_color;\n\t\tuniform mat4 u_light_matrix;\n\t\tuniform float u_intensity;\n\t\tuniform float u_attenuation;\n\t\tuniform vec2 u_rand;\n\t\tconst float G_SCATTERING = 0.5;\n\t\tconst float PI = 3.14159265358979323846;\n\t\tfloat ComputeScattering(float lightDotView)\n\t\t{\n\t\t\tfloat result = 1.0 - G_SCATTERING * G_SCATTERING;\n\t\t\tresult /= (4.0 * PI * pow(1.0 + G_SCATTERING * G_SCATTERING - (2.0 * G_SCATTERING) * lightDotView, 1.5));\n\t\t\treturn result;\n\t\t}\n\t\t#define SAMPLES 64\n\t\t\n\t\tvoid main() {\n\t\t\tvec2 uv = v_coord;\n\t\t\tvec4 color = texture2D(u_color_texture, uv);\n\t\t\tfloat depth = texture2D(u_depth_texture, uv).x;\n\t\t\tfloat zNear = u_camera_planes.x;\n\t\t\tfloat zFar = u_camera_planes.y;\n\t\t\tdepth = depth * 2.0 - 1.0;\n\t\t\tfloat z = zNear * (depth + 1.0) / (zFar + zNear - depth * (zFar - zNear));\n\t\t\tvec4 screenpos = vec4( uv * 2.0 - vec2(1.0), depth, 1.0 );\n\t\t\tvec4 farpos = u_inv_vp * screenpos;\n\t\t\tfarpos /= farpos.w;\n\t\t\tscreenpos.z = 0.0;\n\t\t\tvec4 nearpos = u_inv_vp * screenpos;\n\t\t\tnearpos.xyz /= nearpos.w;\n\t\t\tvec3 rayDir = (farpos.xyz - nearpos.xyz) / float(SAMPLES);\n\t\t\tfloat weight = length(rayDir);\n\t\t\tvec4 current_pos = vec4( nearpos.xyz, 1.0 );\n\t\t\tcurrent_pos.xyz += rayDir * texture2D(u_noise_texture, uv * 2.0 + u_rand ).x;\n\t\t\tfloat brightness = 0.0;\n\t\t\tfloat bias = u_shadow_params.y;\n\t\t\tfloat accum = ComputeScattering( dot( normalize(rayDir), -u_light_front));\n\t\t\tfor(int i = 0; i < SAMPLES; ++i)\n\t\t\t{\n\t\t\t\tvec4 light_uv = u_light_matrix * current_pos;\n\t\t\t\tlight_uv.xy /= light_uv.w;\n\t\t\t\tlight_uv.xy = light_uv.xy * 0.5 + vec2(0.5);\n\t\t\t\tfloat shadow_depth = texture2D( u_shadow_texture, light_uv.xy ).x;\n\t\t\t\tif (((light_uv.z - bias) / light_uv.w * 0.5 + 0.5) < shadow_depth )\n\t\t\t\t\tbrightness += accum * weight;\n\t\t\t\tcurrent_pos.xyz += rayDir;\n\t\t\t}\n\t\t\t//color.xyz += u_intensity * u_light_color * brightness / float(SAMPLES);\n\t\t\tcolor.xyz = mix(color.xyz, u_light_color, clamp( pow(u_intensity * brightness / float(SAMPLES), u_attenuation),0.0,1.0));\n\t\t\tgl_FragColor = color;\n\t\t}\n\t\t";
LiteGraph.registerNodeType("texture/volumetric_light",Wa);if(LiteGraph.Nodes.LGraphTextureCanvas2D){var cb=function(){this.addInput("v");this.addOutput("out","Texture");this.properties={filename:"",width:512,height:512,clear:!0,precision:LGraphTexture.DEFAULT,use_html_canvas:!1};this._temp_texture=this._func=null;this.size=[180,30]};cb.title="Canvas2DFromScript";cb.desc="Executes Canvas2D script file inside a texture or the viewport.";cb.help="Set width and height to 0 to match viewport size.";cb.widgets_info=
{precision:{widget:"combo",values:LGraphTexture.MODE_VALUES},filename:{type:"script"},width:{type:"Number",precision:0,step:1},height:{type:"Number",precision:0,step:1}};cb.prototype.onPropertyChanged=function(a,b){var c=this;"filename"==a&&LiteGraph.allow_scripts&&(this._func=null,b&&d.ResourcesManager.load(b,function(a){c.compileCode(a.data);c._code_version=a._version||0}))};cb.prototype.onExecute=function(){if(this.isOutputConnected(0)){var a=d.ResourcesManager.getResource(this.properties.filename);
a&&a._version!=this._code_version&&(this.compileCode(a.data),this._code_version=a._version||0);(a=this._func)&&this.executeDraw(a)}};cb.prototype.getResources=function(a){this.properties.filename&&(a[this.properties.filename]=!0)};cb.prototype.compileCode=LiteGraph.Nodes.LGraphTextureCanvas2D.prototype.compileCode;cb.prototype.compileCode=LiteGraph.Nodes.LGraphTextureCanvas2D.prototype.compileCode;cb.prototype.executeDraw=LiteGraph.Nodes.LGraphTextureCanvas2D.prototype.executeDraw;LiteGraph.registerNodeType("texture/canvas2DfromScript",
cb)}var Ya=function(){this.addInput("color","Texture");this.addInput("depth","Texture");this.addInput("camera","Camera,Component");this.properties={enabled:!0,pointSize:1,offset:0,factor:1,triangles:!1,depth_is_linear:!1,skip_center:!1,layers:255};this._view_matrix=mat4.create();this._projection_matrix=mat4.create();this._viewprojection_matrix=mat4.create();this._uniforms={u_depth_ivp:mat4.create(),u_point_size:1,u_depth_offset:0,u_ires:vec2.create(),u_near_far:vec2.create(),u_color_texture:0,u_depth_texture:1,
u_factor:this.properties.factor,u_vp:this._viewprojection_matrix}};Ya.widgets_info={layers:{widget:"layers"}};Ya.title="Reproj.Depth";Ya.desc="Reproject Depth";Ya.prototype.onGetInputs=function(){return[["enabled","boolean"],["factor","number"]]};Ya.prototype.onExecute=function(){var a=this.getInputData(0),b=this.getInputData(1),c=this.getInputData(2);if(b&&c&&c.constructor===d.Camera&&this.getInputOrProperty("enabled")){var e=!1;a||(a=GL.Texture.getWhiteTexture(),e=!0);if(LiteGraph.LGraphRender.onRequestCameraMatrices){if(LiteGraph.LGraphRender.onRequestCameraMatrices(this._view_matrix,
this._projection_matrix,this._viewprojection_matrix),d.Renderer._current_layers_filter&this.properties.layers){var g=this._mesh;g||(g=this._mesh=GL.Mesh.plane({detailX:b.width,detailY:b.height}));var f=null;Ya._shader||(Ya._shader=new GL.Shader(Ya.vertex_shader,Ya.pixel_shader));var f=Ya._shader,h=this._uniforms;h.u_point_size=this.properties.pointSize;h.u_depth_offset=this.properties.offset;h.u_is_linear=this.properties.depth_is_linear?1:0;h.u_use_depth_as_color=e?1:0;h.u_near_far.set(b.near_far_planes?
b.near_far_planes:[0,1]);h.u_factor=this.getInputOrProperty("factor");this.properties.skip_center?h.u_ires.set([0,0]):h.u_ires.set([1/b.width,1/b.height]);mat4.invert(h.u_depth_ivp,c._viewprojection_matrix);gl.enable(gl.DEPTH_TEST);gl.disable(gl.BLEND);a.bind(0);gl.texParameteri(a.texture_type,gl.TEXTURE_MAG_FILTER,this.properties.skip_center?gl.LINEAR:gl.NEAREST);b.bind(1);gl.texParameteri(b.texture_type,gl.TEXTURE_MAG_FILTER,this.properties.skip_center?gl.LINEAR:gl.NEAREST);f.uniforms(h).draw(g,
this.properties.triangles?gl.TRIANGLES:gl.POINTS)}}else console.warn("cannot render geometry, LiteGraph.onRequestCameraMatrices is null, remember to fill this with a callback(view_matrix, projection_matrix,viewprojection_matrix) to use 3D rendering from the graph")}};Ya.vertex_shader="\n\t\n\tprecision highp float;\n\tattribute vec3 a_vertex;\n\tattribute vec2 a_coord;\n\tuniform sampler2D u_color_texture;\n\tuniform sampler2D u_depth_texture;\n\tuniform mat4 u_depth_ivp;\n\tuniform mat4 u_vp;\n\tuniform vec2 u_ires;\n\tuniform float u_depth_offset;\n\tuniform float u_point_size;\n\tuniform float u_factor;\n\tuniform vec2 u_near_far;\n\tuniform int u_is_linear;\n\tuniform int u_use_depth_as_color;\n\tvarying vec4 color;\n\t\n\tvoid main() {\n\t\tvec2 uv = a_coord + u_ires * 0.5;\n\t\tfloat depth = texture2D( u_depth_texture, uv ).x * u_factor;\n\t\tif(u_is_linear == 1)\n\t\t{\n\t\t\t//must delinearize, doesnt work...\n\t\t\t//lz = u_near_far.x * (depth + 1.0) / (u_near_far.y + u_near_far.x - depth * (u_near_far.y - u_near_far.x));\n\t\t\t//depth = depth * 0.5 + 0.5;\n\t\t\t//depth = depth * 2.0 - 1.0;\n\t\t\tdepth = ((u_near_far.x + u_near_far.y) * depth + u_near_far.x) / (1.0 + u_near_far.y - u_near_far.x);\n\t\t\t//depth = depth * 0.5 + 0.5;\n\t\t\t//depth = depth * 2.0 - 1.0;\n\t\t}\n\t\telse\n\t\t\tdepth = depth * 2.0 - 1.0;\n\t\tif(u_use_depth_as_color == 1)\n\t\t\tcolor = vec4( depth * 0.5 + 0.5);\n\t\telse\n\t\t\tcolor = texture2D( u_color_texture, uv );\n\t\tvec4 pos2d = vec4( uv*2.0-vec2(1.0),depth + u_depth_offset,1.0);\n\t\tvec4 pos3d = u_depth_ivp * pos2d;\n\t\t//if(u_must_linearize == 0)\n\t\t//\tpos3d /= pos3d.w;\n\t\tgl_Position = u_vp * pos3d;\n\t\tgl_PointSize = u_point_size;\n\t}\n";
Ya.pixel_shader="\nprecision mediump float;\nvarying vec4 color;\nvoid main()\n{\n\tgl_FragColor = color;\n}\n";LiteGraph.registerNodeType("texture/reproj.depth",Ya);var eb=function(){this.addInput("depth","Texture");this.addInput("camera","Camera");this.addOutput("out","Texture");this.properties={enabled:!0,intensity:1,radius:5,precision:LGraphTexture.DEFAULT};this._uniforms={tDepth:0,samples:64,u_resolution:vec2.create(),radius:5,zNear:0.1,zFar:1E3}};eb.widgets_info={precision:{widget:"combo",values:lc?
LGraphTexture.MODE_VALUES:[]}};eb.title="SSAO";eb.desc="Screen Space Ambient Occlusion";eb.prototype.onExecute=function(){var a=this.getInputData(0),b=this.getInputData(1);if(this.isOutputConnected(0)&&a&&b){var c=this.getInputData(2);null!=c&&(this.properties.enabled=Boolean(c));if(this.properties.precision===LGraphTexture.PASS_THROUGH||!1===this.properties.enabled)this.setOutputData(0,GL.Texture.getWhiteTexture());else{var c=a.width,e=a.height,d=this.precision===LGraphTexture.LOW?gl.UNSIGNED_BYTE:
gl.HIGH_PRECISION_FORMAT;this.precision===LGraphTexture.DEFAULT&&(d=gl.UNSIGNED_BYTE);this._tex&&this._tex.width==c&&this._tex.height==e&&this._tex.type==d||(this._tex=new GL.Texture(c,e,{type:d,format:gl.RGBA,filter:gl.LINEAR}));var f=null;eb._shader||(eb._shader=new GL.Shader(GL.Shader.SCREEN_VERTEX_SHADER,eb.pixel_shader));var f=eb._shader,d=this.properties.intensity,h=this._uniforms;h.u_resolution.set([c,e]);h.zNear=b.near;h.zFar=b.far;h.radius=this.properties.radius;h.strength=d;this._tex.drawTo(function(){gl.disable(gl.DEPTH_TEST);
gl.disable(gl.CULL_FACE);gl.disable(gl.BLEND);a.bind(0);var b=GL.Mesh.getScreenQuad();f.uniforms(h).draw(b)});this.setOutputData(0,this._tex)}}};eb.pixel_shader="\nprecision mediump float;\nvarying vec2 v_coord;\nuniform sampler2D tDepth;\nuniform vec2 u_resolution;\nuniform float zNear;\nuniform float zFar;\nuniform float strength;\n#define PI    3.14159265\n\nfloat width; //texture width\nfloat height; //texture height\n\nvec2 texCoord;\n\n//general stuff\n\n//user variables\nuniform int samples; //ao sample count //64.0\nuniform float radius; //ao radius //5.0\n\nfloat aoclamp = 0.125; //depth clamp - reduces haloing at screen edges\nbool noise = true; //use noise instead of pattern for sample dithering\nfloat noiseamount = 0.0002; //dithering amount\n\nfloat diffarea = 0.3; //self-shadowing reduction\nfloat gdisplace = 0.4; //gauss bell center //0.4\n\nbool mist = false; //use mist?\nfloat miststart = 0.0; //mist start\nfloat mistend = zFar; //mist end\nbool onlyAO = false; //use only ambient occlusion pass?\nfloat lumInfluence = 0.7; //how much luminance affects occlusion\n\nvec2 rand(vec2 coord) //generating noise/pattern texture for dithering\n{\n  float noiseX = ((fract(1.0-coord.s*(width/2.0))*0.25)+(fract(coord.t*(height/2.0))*0.75))*2.0-1.0;\n  float noiseY = ((fract(1.0-coord.s*(width/2.0))*0.75)+(fract(coord.t*(height/2.0))*0.25))*2.0-1.0;\n  if (noise)\n  {\n    noiseX = clamp(fract(sin(dot(coord ,vec2(12.9898,78.233))) * 43758.5453),0.0,1.0)*2.0-1.0;\n    noiseY = clamp(fract(sin(dot(coord ,vec2(12.9898,78.233)*2.0)) * 43758.5453),0.0,1.0)*2.0-1.0;\n  }\n  return vec2(noiseX,noiseY)*noiseamount;\n}\n\nfloat doMist()\n{\n  float zdepth = texture2D(tDepth,texCoord.xy).x;\n  float depth = -zFar * zNear / (zdepth * (zFar - zNear) - zFar);\n  return clamp((depth-miststart)/mistend,0.0,1.0);\n}\n\nfloat readDepth(vec2 coord)\n{\n  if (v_coord.x<0.0||v_coord.y<0.0) return 1.0;\n  else {\n    float z_b = texture2D(tDepth, coord ).x;\n    float z_n = 2.0 * z_b - 1.0;\n    return (2.0 * zNear) / (zFar + zNear - z_n * (zFar-zNear));\n  }\n}\n\nint compareDepthsFar(float depth1, float depth2) {\n  float garea = 2.0; //gauss bell width\n  float diff = (depth1 - depth2)*100.0; //depth difference (0-100)\n  //reduce left bell width to avoid self-shadowing\n  return diff<gdisplace ? 0 : 1;\n}\n\nfloat compareDepths(float depth1, float depth2)\n{\n  float garea = 2.0; //gauss bell width\n  float diff = (depth1 - depth2)*100.0; //depth difference (0-100)\n  //reduce left bell width to avoid self-shadowing\n  if (diff<gdisplace)\n  {\n    garea = diffarea;\n  }\n\t\n  float gauss = pow(2.7182,-2.0*(diff-gdisplace)*(diff-gdisplace)/(garea*garea));\n  return gauss;\n}\n\nfloat calAO(float depth,float dw, float dh)\n{\n  float dd = (1.0-depth)*radius;\n\n  float temp = 0.0;\n  float temp2 = 0.0;\n  float coordw = v_coord.x + dw*dd;\n  float coordh = v_coord.y + dh*dd;\n  float coordw2 = v_coord.x - dw*dd;\n  float coordh2 = v_coord.y - dh*dd;\n\n  vec2 coord = vec2(coordw , coordh);\n  vec2 coord2 = vec2(coordw2, coordh2);\n\n  float cd = readDepth(coord);\n  int far = compareDepthsFar(depth, cd);\n  temp = compareDepths(depth, cd);\n  //DEPTH EXTRAPOLATION:\n  if (far > 0)\n  {\n    temp2 = compareDepths(readDepth(coord2),depth);\n    temp += (1.0-temp)*temp2;\n  }\n\n  return temp;\n}\n\nvoid main(void)\n{\n\twidth = u_resolution.x; //texture width\n\theight = u_resolution.y; //texture height\n\ttexCoord = v_coord;\n\tvec2 noise = rand(texCoord);\n\tfloat depth = readDepth(texCoord);\n\t\n\tfloat w = (1.0 / width)/clamp(depth,aoclamp,1.0)+(noise.x*(1.0-noise.x));\n\tfloat h = (1.0 / height)/clamp(depth,aoclamp,1.0)+(noise.y*(1.0-noise.y));\n\t\n\tfloat pw = 0.0;\n\tfloat ph = 0.0;\n\t\n\tfloat ao = 0.0;\n\t\n\tfloat dl = PI * (3.0 - sqrt(5.0));\n\tfloat dz = 1.0 / float(samples);\n\tfloat l = 0.0;\n\tfloat z = 1.0 - dz/2.0;\n\t\n\tfor (int i = 0; i < 64; i++)\n\t{\n\t\tif (i > samples) break;\n\t\tfloat r = sqrt(1.0 - z);\n\t\t\n\t\tpw = cos(l) * r;\n\t\tph = sin(l) * r;\n\t\tao += calAO(depth,pw*w,ph*h);\n\t\tz = z - dz;\n\t\tl = l + dl;\n\t}\n\n\n  ao /= float(samples);\n  ao *= strength;\n  ao = 1.0-ao;\n\n  if (mist)\n  {\n    ao = mix(ao, 1.0, doMist());\n  }\n\n\tvec3 final = vec3(ao); //ambient occlusion only\n  gl_FragColor = vec4(final,1.0);\n}\n";
LiteGraph.registerNodeType("texture/SSAO",eb)}if("undefined"!=typeof LiteGraph){LiteGraph.CORNER_TOP_LEFT=0;LiteGraph.CORNER_TOP_RIGHT=1;LiteGraph.CORNER_BOTTOM_LEFT=2;LiteGraph.CORNER_BOTTOM_RIGHT=3;LiteGraph.CORNER_TOP_CENTER=4;LiteGraph.CORNER_BOTTOM_CENTER=5;var ib={type:"enum",values:{"top-left":LiteGraph.CORNER_TOP_LEFT,"top-right":LiteGraph.CORNER_TOP_RIGHT,"bottom-left":LiteGraph.CORNER_BOTTOM_LEFT,"bottom-right":LiteGraph.CORNER_BOTTOM_RIGHT,"top-center":LiteGraph.CORNER_TOP_CENTER,"bottom-center":LiteGraph.CORNER_BOTTOM_CENTER}},
jb=function(a,b,c){var e=a[0];a=a[1];switch(b){case LiteGraph.CORNER_TOP_RIGHT:e=gl.canvas.width-e;break;case LiteGraph.CORNER_BOTTOM_LEFT:a=gl.canvas.height-a;break;case LiteGraph.CORNER_BOTTOM_RIGHT:e=gl.canvas.width-e;a=gl.canvas.height-a;break;case LiteGraph.CORNER_TOP_CENTER:e=0.5*gl.canvas.width;break;case LiteGraph.CORNER_BOTTOM_CENTER:e=0.5*gl.canvas.width,a=gl.canvas.height-a}c[0]=e;c[1]=a},Yb=function(){this.addOutput("pos","vec2");this.addOutput("left_button","boolean");this.addOutput("right_button",
"boolean");this.properties={}};Yb.title="Mouse";Yb.desc="Mouse state info";Yb.prototype.onExecute=function(){this.setOutputData(0,d.Input.Mouse.position);this.setOutputData(1,d.Input.Mouse.buttons&d.Input.BUTTONS_LEFT);this.setOutputData(2,d.Input.Mouse.buttons&d.Input.BUTTONS_RIGHT)};LiteGraph.registerNodeType("input/mouse",Yb);var bb=function(){this.addOutput("pos","vec2");this.addOutput("enabled","boolean");this.properties={enabled:!0,draggable:!1,title:"",color:[0.1,0.1,0.1],opacity:0.7,titlecolor:[0,
0,0],position:[10,10],size:[300,200],rounding:8,corner:LiteGraph.CORNER_TOP_LEFT};this._area=vec4.create();this._color=vec4.create();this._titlecolor=vec4.create();this._offset=[0,0]};bb.title="GUIPanel";bb.desc="renders a rectangle on webgl canvas";bb.priority=-1;bb["@corner"]=ib;bb["@color"]={type:"color"};bb["@titlecolor"]={type:"color"};bb["@opacity"]={widget:"slider",min:0,max:1};bb.prototype.onExecute=function(){this.setOutputData(0,this._area);this.setOutputData(1,this.properties.enabled)};
bb.prototype.onRenderGUI=function(){this.properties.enabled=this.getInputOrProperty("enabled");if(!1!==this.properties.enabled){var a=window.gl;if(a){this._color.set(this.properties.color||[0.1,0.1,0.1]);this._color[3]=this.properties.opacity;a.fillColor=this._color;jb(this.properties.position,this.properties.corner,this._area);this._area[0]+=this._offset[0];this._area[1]+=this._offset[1];this._area[2]=this.properties.size[0];this._area[3]=this.properties.size[1];gl.disable(gl.DEPTH_TEST);gl.enable(gl.BLEND);
gl.blendFunc(gl.SRC_ALPHA,gl.ONE_MINUS_SRC_ALPHA);var b=Math.min(15,this.properties.rounding);0<b?(a.beginPath(),a.roundRect(this._area[0],this._area[1],this.properties.size[0],this.properties.size[1],b,b),a.fill()):a.fillRect(this._area[0],this._area[1],this.properties.size[0],this.properties.size[1]);this.properties.title&&(this._titlecolor.set(this.properties.titlecolor||[0.3,0.3,0.3]),this._titlecolor[3]=this.properties.opacity,a.fillColor=this._titlecolor,0<b?(a.beginPath(),a.roundRect(this._area[0],
this._area[1],this.properties.size[0],30,b,0),a.fill()):a.fillRect(this._area[0],this._area[1],this.properties.size[0],30),a.fillColor=[0.8,0.8,0.8,this.properties.opacity],a.font="20px Arial",a.fillText(this.properties.title,10+this._area[0],24+this._area[1]))}}};bb.prototype.onMouse=function(a,b){if(this.properties.enabled&&this.properties.draggable){var c=this._area,e=a.mousex,d=a.mousey;if("mousedown"==a.type){if(e>=c[0]&&e<c[0]+c[2]&&d>=c[1]&&d<c[1]+c[3])return this._dragging=!0}else if("mousemove"==
a.type){if(this._dragging)return this._offset[0]+=a.deltax,this._offset[1]+=a.deltay,!0}else this._dragging=!1}};bb.prototype.onGetInputs=function(){return[["enabled","boolean"]]};LiteGraph.registerNodeType("gui/panel",bb);var qb=function(){this.addInput("text");this.properties={enabled:!0,text:"",font:"",color:[1,1,1,1],precision:3,position:[20,20],corner:LiteGraph.CORNER_TOP_LEFT};this._pos=vec2.create();this._text=""};qb.title="GUIText";qb.desc="renders text on webgl canvas";qb["@corner"]=ib;qb["@color"]=
{type:"color"};qb.prototype.onGetInputs=function(){return[["enabled","boolean"]]};qb.prototype.onExecute=function(){var a=this.getInputData(0);null!=a&&(this._text=a.constructor===Number?a.toFixed(this.properties.precision):String(a))};qb.prototype.onRenderGUI=function(){var a=window.gl;if(a&&!1!==this.getInputOrProperty("enabled")){var b=(this.properties.text||"")+this._text;""!=b&&(a.font=this.properties.font||"20px Arial",a.textAlign="left",a.fillColor=this.properties.color||[1,1,1,1],jb(this.properties.position,
this.properties.corner,this._pos),gl.disable(gl.DEPTH_TEST),gl.enable(gl.BLEND),gl.blendFunc(gl.SRC_ALPHA,gl.ONE_MINUS_SRC_ALPHA),a.fillText(b,this._pos[0],this._pos[1]))}};LiteGraph.registerNodeType("gui/text",qb);var zb=function(){this.addInput("","image,canvas,texture");this.properties={enabled:!0,opacity:1,keep_aspect:!0,flipX:!1,flipY:!1,force_update:!1,position:[20,20],size:[300,200],corner:LiteGraph.CORNER_TOP_LEFT};this._pos=vec2.create()};zb.title="GUIImage";zb.desc="renders an image on webgl canvas";
zb["@corner"]=ib;zb["@opacity"]={widget:"slider",min:0,max:1};zb.prototype.onGetInputs=function(){return[["enabled","boolean"],["parent_pos","vec2"]]};zb.prototype.onRenderGUI=function(){var a=window.gl;if(a){var b=this.getInputData(0);if(!1!==this.getInputOrProperty("enabled")&&b){this.properties.force_update&&(b.mustUpdate=!0);jb(this.properties.position,this.properties.corner,this._pos);gl.disable(gl.DEPTH_TEST);gl.enable(gl.BLEND);gl.blendFunc(gl.SRC_ALPHA,gl.ONE_MINUS_SRC_ALPHA);var c=a.globalAlpha;
a.globalAlpha*=this.properties.opacity;var e=this._pos[0],d=this._pos[1],f=this.getInputOrProperty("parent_pos");f&&(e+=f[0],d+=f[1]);var f=this.properties.size[0],h=this.properties.size[1];this.properties.keep_aspect&&(h=this.properties.size[0]/b.width*b.height);this.properties.flipX&&(e+=f,f*=-1);this.properties.flipY&&(d+=h,h*=-1);a.drawImage(b,e,d,f,h);a.globalAlpha=c}}};LiteGraph.registerNodeType("gui/image",zb);var Ab=function(){this.addOutput("v");this.properties={enabled:!0,text:"",min:0,
max:1,value:0,position:[20,20],size:[200,40],corner:LiteGraph.CORNER_TOP_LEFT};this._area=vec4.create()};Ab.title="GUISlider";Ab.desc="Renders a slider on the main canvas";Ab["@corner"]=ib;Ab.prototype.onRenderGUI=function(){if(this.getInputOrProperty("enabled")){jb(this.properties.position,this.properties.corner,this._area);this._area[2]=this.properties.size[0];this._area[3]=this.properties.size[1];var a=this.getInputOrProperty("parent_pos");a&&(this._area[0]+=a[0],this._area[1]+=a[1]);this.properties.value=
d.GUI.HorizontalSlider(this._area,Number(this.properties.value),Number(this.properties.min),Number(this.properties.max),!0);this.properties.text&&(gl.textAlign="right",gl.fillStyle="#AAA",gl.fillText(this.properties.text,this._area[0]-20,this._area[1]+0.75*this._area[3]),gl.textAlign="left")}};Ab.prototype.onExecute=function(){this.inputs&&this.inputs.length&&(this.properties.enabled=this.getInputOrProperty("enabled"));this.setOutputData(0,this.properties.value)};Ab.prototype.onGetInputs=function(){return[["enabled",
"boolean"],["parent_pos","vec2"]]};LiteGraph.registerNodeType("gui/slider",Ab);var Bb=function(){this.addOutput("v");this.properties={enabled:!0,value:!0,text:"toggle",position:[20,20],size:[140,40],corner:LiteGraph.CORNER_TOP_LEFT};this._area=vec4.create()};Bb.title="GUIToggle";Bb.desc="Renders a toggle widget on the main canvas";Bb["@corner"]=ib;Bb.prototype.onRenderGUI=function(){if(this.getInputOrProperty("enabled")){jb(this.properties.position,this.properties.corner,this._area);var a=this.getInputOrProperty("parent_pos");
a&&(this._area[0]+=a[0],this._area[1]+=a[1]);this._area[2]=this.properties.size[0];this._area[3]=this.properties.size[1];this.properties.value=d.GUI.Toggle(this._area,this.properties.value,this.properties.text)}};Bb.prototype.onExecute=function(){this.setOutputData(0,this.properties.value)};Bb.prototype.onGetInputs=function(){return[["enabled","boolean"],["parent_pos","vec2"]]};LiteGraph.registerNodeType("gui/toggle",Bb);var Cb=function(){this.addOutput("",LiteGraph.EVENT);this.addOutput("was_pressed");
this.properties={enabled:!0,text:"clickme",position:[20,20],size:[140,40],corner:LiteGraph.CORNER_TOP_LEFT};this.widgets_start_y=2;this.addWidget("text","text","clickme","text");this._area=vec4.create();this._was_pressed=!1};Cb.title="GUIButton";Cb.desc="Renders a toggle widget on the main canvas";Cb["@corner"]=ib;Cb.prototype.onRenderGUI=function(){if(this.getInputOrProperty("enabled")){jb(this.properties.position,this.properties.corner,this._area);var a=this.getInputOrProperty("parent_pos");a&&
(this._area[0]+=a[0],this._area[1]+=a[1]);this._area[2]=this.properties.size[0];this._area[3]=this.properties.size[1];this._was_pressed=d.GUI.Button(this._area,this.properties.text)}};Cb.prototype.onExecute=function(){var a=this.getInputDataByName("enabled");if(!1===a||!0===a)this.properties.enabled=a;this._was_pressed&&this.triggerSlot(0);this.setOutputData(1,this._was_pressed);this._was_pressed=!1};Cb.prototype.onGetInputs=function(){return[["enabled","boolean"],["parent_pos","vec2"]]};LiteGraph.registerNodeType("gui/button",
Cb);var rb=function(){this.addInput("","string");this.addInput("clear",LiteGraph.ACTION);this.addOutput("change",LiteGraph.EVENT);this.addOutput("str");this.properties={enabled:!0,caption:"",value:"",clear_on_intro:!1,keep_focus_on_intro:!1,position:[20,20],size:[200,40],corner:LiteGraph.CORNER_TOP_LEFT};this.widgets_start_y=2;this.addWidget("text","Caption","","caption");this._area=vec4.create();this._changed=!1;this._prev_value=""};rb.title="GUITextField";rb.desc="Renders a input text widget on the main canvas";
rb["@corner"]=ib;rb.prototype.onRenderGUI=function(){if(this.getInputOrProperty("enabled")){jb(this.properties.position,this.properties.corner,this._area);var a=this.getInputOrProperty("parent_pos");a&&(this._area[0]+=a[0],this._area[1]+=a[1]);this._area[2]=this.properties.size[0];this._area[3]=this.properties.size[1];null!=this.properties.caption&&(this._area[2]*=0.5,d.GUI.Label(this._area,String(this.properties.caption)),this._area[0]+=0.5*this._area[2]);var b=this;this.properties.value=d.GUI.TextField(this._area,
this.properties.value,null,!1,function(){b._changed=!0;b._value=b.properties.value;if(b.properties.clear_on_intro)return""},this.properties.keep_focus_on_intro)}};rb.prototype.onAction=function(a){this.properties.value=""};rb.prototype.onExecute=function(){var a=this.getInputDataByName("enabled");if(!1===a||!0===a)this.properties.enabled=a;a=this.getInputData(0);null!=a&&this.setProperty("caption",a);this._value!=this._last_value&&this._changed&&(this._changed=!1,this._last_value=this._value,this.triggerSlot(0));
this.setOutputData(1,this.properties.value)};rb.prototype.onGetInputs=function(){return[["enabled","boolean"],["parent_pos","vec2"]]};LiteGraph.registerNodeType("gui/textfield",rb);var kb=function(){this.addOutput("v");this.addOutput("i");this.properties={enabled:!0,selected:0,values:"option1;option2;option3",one_line:!1,position:[20,20],size:[180,100],corner:LiteGraph.CORNER_TOP_LEFT};this._area=vec4.create();this._values=this.properties.values.split(";");this.widget=this.addWidget("text","Options",
this.properties.values,"values");this.size=[240,70]};kb.title="GUIMultipleChoice";kb.desc="Renders a multiple choice widget on the main canvas";kb["@corner"]=ib;kb.prototype.onPropertyChanged=function(a,b){"values"==a&&(this._values=b.split(";"))};kb.prototype.onAction=function(a,b){"prev"==a?this.properties.selected-=1:"next"==a&&(this.properties.selected+=1);this.properties.selected%=this._values.length;0>this.properties.selected&&(this.properties.selected+=this._values.length)};kb.prototype.onRenderGUI=
function(){var a=this.getInputOrProperty("enabled");if(this._values.length&&a){a=this.properties.selected=Math.floor(this.properties.selected);jb(this.properties.position,this.properties.corner,this._area);var b=gl,c=this.getInputOrProperty("parent_pos");c&&(this._area[0]+=c[0],this._area[1]+=c[1]);if(this.properties.one_line){var c=this.properties.position,e=this.properties.size,g=e[1];this._area[2]=2*g;this._area[3]=e[1];d.GUI.ClickArea(this._area)&&(a-=1);this._area[0]+=e[0]-2*g;d.GUI.ClickArea(this._area)&&
(a+=1);a%=this._values.length;0>a&&(a+=this._values.length);b.fillStyle="black";b.strokeStyle="#AAA";b.lineWidth=2;b.beginPath();b.roundRect(c[0],c[1],e[0],e[1],0.5*g);b.fill();b.stroke();b.fillStyle="white";b.beginPath();var f=0.25*g;b.moveTo(c[0]+f,c[1]+0.5*g);b.lineTo(c[0]+0.5*g+2*f,c[1]+f);b.lineTo(c[0]+0.5*g+2*f,c[1]+g-f);b.fill();b.beginPath();b.moveTo(c[0]+e[0]-f,c[1]+0.5*g);b.lineTo(c[0]+e[0]-0.5*g-2*f,c[1]+f);b.lineTo(c[0]+e[0]-0.5*g-2*f,c[1]+g-f);b.fill();b.fillStyle="#AAA";b.textAlign=
"center";b.font=(0.75*g).toFixed(0)+"px "+d.GUI.GUIStyle.font;b.fillText(String(this._values[a]),c[0]+0.5*e[0],c[1]+0.75*e[1])}else for(this._area[2]=this.properties.size[0],this._area[3]=this.properties.size[1]/this._values.length,b=this._area[1],c=0;c<this._values.length;++c)this._area[1]=b+c*this._area[3],d.GUI.Toggle(this._area,c==a,this._values[c],null,!0)&&(a=c);this.properties.selected=a;(a=d.Input.current_click)&&d.Input.isEventInRect(a,this._area,d.GUI._offset)&&(d.Input.current_click=!1)}};
kb.prototype.onGetInputs=function(){return[["enabled","boolean"],["parent_pos","vec2"],["options","array"],["next",LiteGraph.ACTION],["prev",LiteGraph.ACTION]]};kb.prototype.onExecute=function(){if(this.inputs)for(var a=0;a<this.inputs.length;++a){var b=this.inputs[a],c=this.getInputData(a);"enabled"==b.name?this.properties.enabled=Boolean(c):"options"==b.name&&c&&(this._values=c,this.properties.values=c.join(";"),this.widget.value=this.properties.values)}this.setOutputData(0,this._values[this.properties.selected]);
this.setOutputData(1,this.properties.selected)};LiteGraph.registerNodeType("gui/multiple_choice",kb);var Db=function(){this.addInput("bg","image,texture");this.addOutput("x","number");this.addOutput("y","number");this.addOutput("v","vec2");this.properties={enabled:!0,value:[0,0],position:[20,20],min:[0,0],max:[1,1],size:[200,200],corner:LiteGraph.CORNER_TOP_LEFT};this._area=vec4.create();this._value_norm=vec2.create()};Db.title="GUIPad";Db.desc="Renders a 2D pad on the main canvas";Db["@corner"]=
ib;Db.prototype.onRenderGUI=function(){if(this.getInputOrProperty("enabled")){jb(this.properties.position,this.properties.corner,this._area);this._area[2]=this.properties.size[0];this._area[3]=this.properties.size[1];var a=this.getInputOrProperty("parent_pos");a&&(this._area[0]+=a[0],this._area[1]+=a[1]);var a=this.getInputData(0),b=this.properties.max[0]-this.properties.min[0],c=this.properties.max[1]-this.properties.min[1];this._value_norm[0]=(this.properties.value[0]-this.properties.min[0])/b;
this._value_norm[1]=(this.properties.value[1]-this.properties.min[1])/c;d.GUI.Pad(this._area,this._value_norm,a);this.properties.value[0]=this.properties.min[0]+this._value_norm[0]*b;this.properties.value[1]=this.properties.min[1]+this._value_norm[1]*c}};Db.prototype.onExecute=function(){this.inputs&&this.inputs.length&&(this.properties.enabled=this.getInputOrProperty("enabled"));this.setOutputData(0,this.properties.value[0]);this.setOutputData(1,this.properties.value[1]);this.setOutputData(2,this.properties.value)};
Db.prototype.onGetInputs=function(){return[["enabled","boolean"],["parent_pos","vec2"]]};LiteGraph.registerNodeType("gui/pad",Db);var Mb=function(){this.addInput("text");this.properties={enabled:!0,text:"",font:"",position:[0,0,0],scale:0.1,color:[1,1,1,1],precision:3};this._pos=vec2.create();this._text=""};Mb.title="DebugText";Mb.desc="renders text on world space";Mb["@color"]={type:"color"};Mb.prototype.onGetInputs=function(){return[["enabled","boolean"]]};Mb.prototype.onExecute=function(){var a=
this.getInputData(0);this._text=null!=a?a.constructor===Number?a.toFixed(this.properties.precision):String(a):this.properties.text;0!=this._text.length&&(a=this.graph._scenenode,d.Draw.setColor(this.properties.color),gl.disable(gl.CULL_FACE),a&&a.transform?(d.Draw.push(),d.Draw.setMatrix(a.transform.getGlobalMatrixRef()),d.Draw.renderText(this._text,this.properties.position,this.properties.scale),d.Draw.pop()):d.Draw.renderText(this._text,this.properties.position),gl.enable(gl.CULL_FACE))};LiteGraph.registerNodeType("debug/text",
Mb);var da=function(){this.addInput("x","number");this.addInput("y","number");this.addOutput("[]","array");this.addOutput("obj","object");this.addOutput("img","image");this.addProperty("circular",!1);this.points=[];this.weights=[];this.weights_obj={};this.current_pos=new Float32Array([0.5,0.5]);this.size=[200,200];this.dragging=!1;this.show_names=!0;this.circle_center=[0,0];this.circle_radius=1;this.margin=20;this._values_changed=!0;this._visualize_weights=!1;this._version=0;this._selected_point=
null};LiteGraph.LGraphMap2D=da;da.title="Map2D";da.colors=[[255,0,0],[0,255,0],[0,0,255],[0,128,128,0],[128,0,128],[128,128,0],[255,128,0],[255,0,128],[0,128,255],[128,0,255]];da.grid_size=64;da.prototype.onExecute=function(){var a=this.current_pos;a[0]=this.getInputData(0)||a[0];a[1]=this.getInputData(1)||a[1];this.computeWeights(a);this.setOutputData(0,this.weights);this.setOutputData(1,this.weights_obj);this.isOutputConnected(2)&&(this.temp_canvas||(this.temp_canvas=document.createElement("canvas")),
this.temp_canvas.width=this.size[0],this.temp_canvas.height=this.size[1],a=this.temp_canvas.getContext("2d"),this.renderToCanvas(a,this.temp_canvas),this.setOutputData(2,this.temp_canvas))};da.prototype.computeWeights=function(a){if(this.points.length){var b=this._precomputed_weights;if(!b||this._values_changed)b=this.precomputeWeights();var c=vec2.create(),e=this.properties.circular,d=this.weights;d.length=this.points.length;for(var f=da.grid_size,h=0;h<d.length;++h)d[h]=0;for(var k=0,h=0;h<f;++h)for(var l=
0;l<f;++l){c[0]=l/f;c[1]=h/f;e&&(c[0]=2*c[0]-1,c[1]=2*c[1]-1);var m=2*l+h*f*2,p=b[m];vec2.distance(c,a)<b[m+1]+0.001&&(d[p]+=1,k++)}for(h=0;h<d.length;++h)d[h]/=k,this.weights_obj[this.points[h].name]=d[h];return d}};da.prototype.onMouseDown=function(a,b){return this.flags.collapsed||0>b[1]||b[0]<this.margin||b[0]>this.size[0]-this.margin||b[1]<this.margin?!1:b[1]>this.size[1]-this.margin?(this._visualize_weights=!this._visualize_weights,!0):this.dragging=!0};da.prototype.onMouseUp=function(a,b){this.dragging=
!1};da.prototype.onMouseMove=function(a,b){if(this.dragging&&!this.flags.collapsed){var c=this.margin,e=[0,0],d=this.current_pos;d[0]=Math.clamp((b[0]-c)/(this.size[0]-2*c),0,1);d[1]=Math.clamp((b[1]-c)/(this.size[1]-2*c),0,1);this.properties.circular&&(d[0]=2*d[0]-1,d[1]=2*d[1]-1,1<vec2.distance(d,e)&&vec2.normalize(d,d));return!0}};da.prototype.onDrawBackground=function(a){if(!this.flags.collapsed){this.renderToCanvas(a);var b=this.margin,c=this.size[0],e=this.size[1];a.save();a.fillStyle="black";
a.fillRect(b,e-b+2,c-2*b,b-4);a.strokeStyle="white";a.strokeRect(b,e-b+2,c-2*b,b-4);a.textAlign="center";a.fillStyle="white";a.fillText("Visualize Weights",0.5*c,e-0.3*b);a.textAlign="left";if(this.weights.length&&this._visualize_weights)for(b=c+5,c=0;c<this.weights.length;++c)e=da.colors[c%da.colors.length],a.fillStyle="black",a.fillRect(b,16+5*c,100,4),a.fillStyle="rgb("+(255*e[0]|0)+","+(255*e[1]|0)+","+(255*e[2]|0)+")",a.fillRect(b,16+5*c,100*this.weights[c],4);a.restore()}};da.prototype.renderToCanvas=
function(a,b){var c=this.current_pos,e=this.properties.circular,d=this.show_names,f=this.margin,h=b?b.width:this.size[0],k=b?b.height:this.size[1];a.fillStyle="black";a.strokeStyle="#BBB";e?(this.circle_center[0]=0.5*h,this.circle_center[1]=0.5*k,this.circle_radius=0.5*k-f,a.lineWidth=2,a.beginPath(),a.arc(this.circle_center[0],this.circle_center[1],this.circle_radius,0,2*Math.PI),a.fill(),a.stroke(),a.lineWidth=1,a.beginPath(),a.moveTo(this.circle_center[0]+0.5,this.circle_center[1]-this.circle_radius),
a.lineTo(this.circle_center[0]+0.5,this.circle_center[1]+this.circle_radius),a.moveTo(this.circle_center[0]-this.circle_radius,this.circle_center[1]),a.lineTo(this.circle_center[0]+this.circle_radius,this.circle_center[1]),a.stroke()):(a.fillRect(f,f,h-2*f,k-2*f),a.strokeRect(f,f,h-2*f,k-2*f));var l=this.precomputeWeightsToImage(c);l&&(a.globalAlpha=0.5,a.imageSmoothingEnabled=!1,e?(a.save(),a.beginPath(),a.arc(this.circle_center[0],this.circle_center[1],this.circle_radius,0,2*Math.PI),a.clip(),a.drawImage(l,
this.circle_center[0]-this.circle_radius,this.circle_center[1]-this.circle_radius,2*this.circle_radius,2*this.circle_radius),a.restore()):a.drawImage(l,f,f,h-2*f,k-2*f),a.imageSmoothingEnabled=!0,a.globalAlpha=1);for(l=0;l<this.points.length;++l){var m=this.points[l],p=m.pos[0],n=m.pos[1];e&&(p=0.5*p+0.5,n=0.5*n+0.5);p=p*(h-2*f)+f;n=n*(k-2*f)+f;p=Math.clamp(p,f,h-f);n=Math.clamp(n,f,k-f);a.fillStyle=m==this._selected_point?"#9DF":"#789";a.beginPath();a.arc(p,n,3,0,2*Math.PI);a.fill();d&&a.fillText(m.name,
p+5,n+5)}a.fillStyle="white";a.beginPath();p=c[0];n=c[1];e&&(p=0.5*p+0.5,n=0.5*n+0.5);n=n*(k-2*f)+f;p=Math.clamp(p*(h-2*f)+f,f,h-f);n=Math.clamp(n,f,k-f);a.arc(p,n,5,0,2*Math.PI);a.fill();b&&(b.mustUpdate=!0)};da.prototype.addPoint=function(a,b){if(this.findPoint(a))console.warn("there is already a point with that name");else{b||(b=[this.current_pos[0],this.current_pos[1]]);b[0]=Math.clamp(b[0],-1,1);b[1]=Math.clamp(b[1],-1,1);var c={name:a,pos:b};this.points.push(c);this._values_changed=!0;this.setDirtyCanvas(!0);
return c}};da.prototype.removePoint=function(a){for(var b=0;b<this.points.length;++b)if(this.points[b].name==a){this.points.splice(b,1);this._values_changed=!0;break}};da.prototype.findPoint=function(a){for(var b=0;b<this.points.length;++b)if(this.points[b].name==a)return this.points[b];return null};da.prototype.precomputeWeights=function(){var a=this.points,b=a.length,c=vec2.create(),e=this.properties.circular;this._values_changed=!1;this._version++;var d=da.grid_size,f=2*d*d;this._precomputed_weights&&
this._precomputed_weights.length==f||(this._precomputed_weights=new Float32Array(f));f=this._precomputed_weights;this._precomputed_weights_gridsize=d;for(var h=0;h<d;++h)for(var k=0;k<d;++k){for(var l=-1,m=1E5,p=0;p<b;++p){c[0]=k/d;c[1]=h/d;e&&(c[0]=2*c[0]-1,c[1]=2*c[1]-1);var n=vec2.distance(c,a[p].pos);n>m||(l=p,m=n)}f[2*k+2*h*d]=l;f[2*k+2*h*d+1]=m}return f};da.prototype.precomputeWeightsToImage=function(a){if(!this.points.length)return null;var b=this._precomputed_weights;if(!b||this._values_changed||
this._precomputed_weights_gridsize!=da.grid_size)b=this.precomputeWeights();var c=this._canvas,e=da.grid_size;c||(c=this._canvas=document.createElement("canvas"));c.width=c.height=e;var d=c.getContext("2d"),f=vec2.create(),h=this.properties.circular,k=this.weights;k.length=this.points.length;for(var l=0;l<k.length;++l)k[l]=0;for(var m=0,p=d.getImageData(0,0,e,e),l=0;l<e;++l)for(var n=0;n<e;++n){f[0]=n/e;f[1]=l/e;h&&(f[0]=2*f[0]-1,f[1]=2*f[1]-1);var r=4*n+l*e*4,t=2*n+l*e*2,x=b[t],u=da.colors[x%da.colors.length];
if(t=vec2.distance(f,a)<b[t+1]+0.001)k[x]+=1,m++;p.data[r]=u[0]+(t?128:0);p.data[r+1]=u[1]+(t?128:0);p.data[r+2]=u[2]+(t?128:0);p.data[r+3]=255}for(l=0;l<k.length;++l)k[l]/=m;d.putImageData(p,0,0);return c};da.prototype.clear=function(){this.points.length=0;this._selected_point=this._canvas=this._precomputed_weights=null;this.setDirtyCanvas(!0)};da.prototype.getExtraMenuOptions=function(){return[{content:"Clear Points",callback:this.clear.bind(this)}]};da.prototype.onInspect=function(a){var b=this;
!this._selected_point&&this.points.length&&(this._selected_point=this.points[0]);a.addTitle("Points");a.widgets_per_row=4;for(var c=0;c<this.points.length;++c){var e=this.points[c];a.addString(null,e.name,{point:e,width:"40%",callback:function(a){this.options.point.name=a;b.setDirtyCanvas(!0)}});a.addNumber(null,e.pos[0],{point:e,width:"20%",min:-1,max:1,step:0.01,callback:function(a){this.options.point.pos[0]=Math.clamp(a,-1,1);b._values_changed=!0}});a.addNumber(null,e.pos[1],{point:e,width:"20%",
min:-1,max:1,step:0.01,callback:function(a){this.options.point.pos[1]=Math.clamp(a,-1,1);b._values_changed=!0}});a.addButton(null,"o",{point:e,width:"10%",callback:function(){this.options.point.pos[0]=b.current_pos[0];this.options.point.pos[1]=b.current_pos[1];b._values_changed=!0}});a.addButton(null,"X",{point:e,width:"10%",callback:function(){LiteGUI.confirm("Are you sure? Removing one point could mess up the whole weights order",function(c){c&&(b.removePoint(this.point.name),a.refresh())}.bind(this.options))}})}a.widgets_per_row=
1;var d="";a.widgets_per_row=2;a.addString("New Point","",{width:"75%",callback:function(a){d=a}});a.addButton(null,"Create",{width:"25%",callback:function(c){d&&b.addPoint(d);a.refresh()}});a.widgets_per_row=1;a.addSeparator()};da.prototype.onSerialize=function(a){a.current_pos=this.current_pos;for(var b=0;b<this.points.length;++b)delete this.points[b]._dist;a.points=this.points};da.prototype.onConfigure=function(a){a.current_pos&&(this.current_pos=a.current_pos);a.points&&(this.points=a.points)};
LiteGraph.registerNodeType("math/map2D",da);var Na=function(){this.addInput("in","array");this.addOutput("out","object");this.points=[];this.current_weights={};this.properties={enabled:!0,dimensions:1};var a=this;this.combo=this.addWidget("combo","Point","",function(b){a._selected_point=a.findPoint(b)},{values:[]});this.import_button=this.addWidget("button","import weights","",function(){a.importWeights(!0,!0)});this.size=[170,80];this._selected_point=null;this._dims=1};Na.title="Remap Weights";Na["@dimensions"]=
{widget:"number",min:1,step:1,precision:0};Na.prototype.onPropertyChanged=function(a,b){if("dimensions"==a&&this._dims!=b){this._dims=b;for(var c=0;c<this.points.length;++c){var e=this.points[c],d;for(d in e.weights)e.weights[d]=1==b?0:Array(b).fill(0)}for(c in this.current_weights)null==this.current_weights[c]?this.current_weights[c]=1==b?0:Array(b).fill(0):this.current_weights[c].constructor===Number&&1==b||this.current_weights[c].length==b||(this.current_weights[c]=Array(b).fill(0))}};Na.prototype.onExecute=
function(){if(this.getInputOrProperty("enabled")){var a=this.getInputData(0);if(this.inputs)for(var b=1;b<this.inputs.length;++b)if("selected"==this.inputs[b].name){var c=this.getInputData(b);c&&(this._selected_point=this.findPoint(c),this.combo.value=c)}var e=this.properties.dimensions||1;for(b in this.current_weights)1==e?this.current_weights[b]=0:this.current_weights[b]&&this.current_weights[b].length==e?this.current_weights[b].fill(0):this.current_weights[b]=Array(e).fill(0);c=!1;if(a)for(b=0;b<
a.length;++b){var d=this.points[b];if(d){var f=a[b],h;for(h in d.weights)if(1==e){var k=(d.weights[h]||0)*f;this.current_weights[h]+=k}else for(var l=0;l<e;++l)k=d.weights[h][l]*f,this.current_weights[h][l]+=k}else c=!0}this.setOutputData(0,this.current_weights);if(this.outputs)for(b=1;b<this.outputs.length;++b)(a=this.outputs[b])&&("selected"==a.name?this.setOutputData(b,this._selected_point?this._selected_point.name:""):this.setOutputData(b,this.current_weights[a.name]));c&&this.importPoints()}};
Na.prototype.onAction=function(a,b){"import"==a&&this.importWeights(!0)};Na.prototype.addPoint=function(a,b){if(b){var c={},e;for(e in b)c[e]=b[e];this.points.push({name:a,weights:c})}else console.warn("no weights passed to add point")};Na.prototype.importPoints=function(){var a=this.getInputNode(0);if(a&&a.points&&a.points.length){this.points.length=a.points.length;for(var b=0;b<this.points.length;++b)this.points[b]={name:a.points[b].name,weights:{}};(this._selected_point=this.points[0])?(this.combo.value=
this._selected_point.name,this.combo.options.values=this.points.map(function(a){return a.name})):(this.combo.value="",this.combo.options.values=[""])}};Na.prototype.importWeights=function(a,b){this.graph&&b&&this.graph.runStep(1,!1,this.order);var c=this.getInputDataByName("name_weights"),e=this.properties.dimensions||1;if(c)for(var d in c)this.current_weights[d]=1==e?c[d]:c[d].concat();else{var f=this.getOutputNodes(0);if(!f||0==f.length)return;for(var h=0;h<f.length;++h){var k=f[h];if(k.getComponent&&
(k=k.getComponent())){var l=k.name_weights,l=k.name_weights;for(d in l)this.current_weights[d]=1==e?l[d]:c[d].concat()}}}this.setDirtyCanvas(!0);if(a&&this._selected_point)for(h in this._selected_point.weights={},this.current_weights)this._selected_point.weights[h]=1==e?this.current_weights[h]:this.current_weights[h].concat()};Na.prototype.findPoint=function(a){for(var b=0;b<this.points.length;++b)if(this.points[b].name==a)return this.points[b];return null};Na.prototype.assignCurrentWeightsToPoint=
function(a){var b=this.properties.dimensions||1,c;for(c in this.current_weights)1==b&&(a.weights[c]=1==b?this.current_weights[c]:this.current_weights[c].concat())};Na.prototype.onSerialize=function(a){a.current_weights=this.current_weights;a.points=this.points;a.enabled=this.enabled};Na.prototype.removeWeight=function(a){for(var b=0;b<this.points.length;++b)delete this.points[b].weights[a];delete this.current_weights[a]};Na.prototype.onConfigure=function(a){void 0!==a.enabled&&(this.properties.enabled=
a.enabled);a.current_weights&&(this.current_weights=a.current_weights);this.properties.dimensions=a.properties.dimensions||1;this._dims=this.properties.dimensions;if(a.points){this.points=a.points;a=a.properties.dimensions;for(var b=0;b<this.points.length;++b){var c=this.points[b];c.weights&&c.weights.constructor!==Object&&(c.weights={});for(var e in c.weights)c.weights[e].constructor==Number&&1!=a?c.weights[e]=0:c.weights[e].constructor!==Array&&1<a&&(c.weights[e]=Array(a).fill(0))}this.combo.options.values=
this.points.map(function(a){return a.name});this.combo.value=this.combo.options.values[0]||""}};Na.prototype.onInspect=function(a){var b=this;a.addButton(null,"Import points from input",{callback:function(){b.importPoints();a.refresh()}});a.addButton(null,"Import weights from output",{callback:function(){b.importWeights(null,!0);a.refresh()}});a.addSeparator();a.addTitle("Points");for(var c=[],e=0;e<this.points.length;++e)c.push(this.points[e].name);!this._selected_point&&this.points.length&&(this._selected_point=
this.points[0]);a.addCombo("Points",this._selected_point?this._selected_point.name:"",{values:c,callback:function(c){b._selected_point=b.findPoint(c);b.combo.value=c;if(b._selected_point)for(var e in b._selected_point.weights)b.current_weights[e]=b._selected_point.weights[e];b.setDirtyCanvas(!0);a.refresh()}});a.addButton(null,"current weights to point",{callback:function(){b._selected_point&&(b.assignCurrentWeightsToPoint(b._selected_point),a.refresh())}});a.addStringButton("New Point","",{button:"+",
callback_button:function(c){if(c){var e=JSON.parse(JSON.stringify(b.current_weights));b._selected_point=b.addPoint(c,e);a.refresh()}else LiteGUI.alert("You must specify a name")}});a.addSeparator();a.addTitle("Weights");var d=this.properties.dimensions||1,c=null;switch(d){case 2:c="vec2";break;case 3:c="vec3";break;case 4:c="vec4";break;default:c="number"}a.widgets_per_row=2;if(c)for(e in this.current_weights){var f=e;a.add(c,f||"",this.current_weights[f],{width:"calc(100% - 40px)",name_width:160,
index:f,callback:function(a){b.current_weights[this.options.index]=a}});a.addButton(null,InterfaceModule.icons.trash,{width:30,index:f,callback:function(c){var e=this.options.index;LiteGUI.confirm("Are you sure? It will be removed from all points",function(c){c&&b.removeWeight(e);a.refresh()})}})}a.widgets_per_row=1;a.addStringButton("Add Weight","",{button:"+",callback_button:function(c){c?(b.current_weights[c]=1==d?1:Array(d).fill(0),a.refresh()):LiteGUI.alert("You must specify a name")}});a.addSeparator()};
Na.prototype.onGetOutputs=function(){var a=[["selected","string"]],b=null;switch(this.properties.dimensions){case 2:b="vec2";break;case 3:b="vec3";break;case 4:b="vec4";break;default:b="number"}for(var c in this.current_weights)a.push([c,b]);return a};Na.prototype.onGetInputs=function(){return[["enabled","boolean"],["import",LiteGraph.ACTION],["selected","string"],["name_weights","object"]]};LiteGraph.registerNodeType("math/remap_weights",Na);var mc=function(){this.addInput("camera","component,camera");
this.addInput("pos2D","vec2");this.addOutput("ray","ray");this.properties={reverse_y:!1};this._ray=new d.Ray};mc.title="Camera Ray";mc.prototype.onExecute=function(){var a=this.getInputData(0)||d.Renderer.getCurrentCamera(),b=this.getInputData(1);if(a&&a.constructor==d.Camera&&b){var c=b[1];this.properties.reverse_y&&(c=gl.canvas.height-b[1]);a.getRay(b[0],c,null,!1,this._ray);this.setOutputData(0,this._ray)}};LiteGraph.registerNodeType("math3d/camera_ray",mc);var nc=function(){this.addInput("camera",
"component,camera");this.addInput("pos3D","vec3");this.addOutput("screen_pos","vec4");this.properties={clamp_to_viewport:!1,reverse_y:!0};this._screen_pos=vec4.create();this.size=[160,50]};nc.title="Camera Project";nc.prototype.onExecute=function(){var a=this.getInputData(0),b=this.getInputData(1);a&&a.constructor==d.Camera&&b&&(a.project(b,null,this._screen_pos,this.properties.reverse_y),b=vec3.distance(a.eye,b),this._screen_pos[3]=Math.sin(a.fov*DEG2RAD)/b*100,this.properties.clamp_to_viewport&&
(this._screen_pos[0]=Math.clamp(this._screen_pos[0],0,gl.canvas.width),this._screen_pos[1]=Math.clamp(this._screen_pos[1],0,gl.canvas.height)),this.setOutputData(0,this._screen_pos))};LiteGraph.registerNodeType("math3d/camera_project",nc);var oc=function(){this.addInput("ray","ray");this.addInput("P","vec3");this.addInput("N","vec3");this.addOutput("pos","vec3");this.properties={}};oc.title="Ray-Plane test";oc.prototype.onExecute=function(){var a=this.getInputData(0),b=this.getInputData(1),c=this.getInputData(2);
a&&a.constructor==d.Ray&&(b||(b=d.ZEROS),c||(c=d.TOP),a.testPlane(b,c),this.setOutputData(0,a.collision_point))};LiteGraph.registerNodeType("math3d/rayplane-test",oc);var Za=function(){this.addInput("enabled","boolean");this.addInput("ray","ray");this.addOutput("collides","boolean");this.addOutput("node","scenenode");this.addOutput("pos","vec3");this.addOutput("normal","vec3");this.properties={max_dist:1E3,layers:255,mode:0};this.options={}};Za.COLLIDERS=0;Za.RENDERINSTANCES_BOUNDING=1;Za.RENDERINSTANCES_MESH=
2;Za.title="Ray-Colliders test";Za["@layers"]={widget:"layers"};Za["@mode"]={type:"enum",values:{colliders:Za.COLLIDERS,renderInstance_bounding:Za.RENDERINSTANCES_BOUNDING,renderInstance_mesh:Za.RENDERINSTANCES_MESH}};Za.prototype.onExecute=function(){var a=this.getInputData(0),b=this.getInputData(1);if(!1!==a&&0!==a&&null!==a&&b&&b.constructor==d.Ray){a=this.options;a.max_dist=this.properties.max_dist;a.normal=this.isInputConnected(3);a.layers=this.properties.layers;a.triangle_collision=this.properties.mode==
Za.RENDERINSTANCES_MESH;var c=null;(c=this.properties.mode==Za.COLLIDERS?d.Physics.raycast(b.origin,b.direction,a):d.Physics.raycastRenderInstances(b.origin,b.direction,a))&&c.length?(b=c[0],this.setOutputData(0,!0),this.setOutputData(1,b.node),this.setOutputData(2,b.position),this.setOutputData(3,b.normal)):this.setOutputData(0,!1)}};LiteGraph.registerNodeType("math3d/raycolliders-test",Za);var Zb=function(){this.addOutput("","boolean");this.addOutput("",LiteGraph.EVENT);this.properties={key:"SPACE"};
var a=this;this.widgets_up=!0;this.addWidget("text","Key",this.properties.key,function(b){b&&(a.properties.key=b)})};Zb.title="Key";Zb.prototype.getTitle=function(){return this.flags.collapsed?"Key: "+this.properties.key:this.title};Zb.prototype.onExecute=function(){var a=d.Input.wasKeyPressed(this.properties.key);this.boxcolor=a?"#fff":"#000";this.setOutputData(0,a);a&&this.triggerSlot(1,this.properties.key)};LiteGraph.registerNodeType("input/key",Zb)}if("undefined"!=typeof LiteGraph){var ha=LiteGraph.Shaders,
pc=function(){this.addInput("albedo","vec3");this.addInput("ambient","vec3");this.addInput("emission","vec3");this.addInput("normal","vec3");this.addInput("specular","float");this.addInput("gloss","float");this.addInput("reflectivity","float");this.addInput("alpha","float");this.addInput("extra","vec4");this.addOutput("out","vec4");this.addOutput("light","FinalLight");this.addOutput("surface","SurfaceOutput")};pc.title="Phong";pc.prototype.onGetCode=function(a){var b=ha.getOutputLinkID(this,0),c=
ha.getOutputLinkID(this,1),e=ha.getOutputLinkID(this,2);if(b||c||e){var g=ha.getShaderNodeVarName(this,"SURFACE"),f="SurfaceOutput "+g+";\n",h=ha.getInputLinkID(this,0),f=f+("\t "+g+".Albedo = "+(h?h:"vec3(1.0)")+";\n"),h=ha.getInputLinkID(this,1),f=f+("\t "+g+".Ambient = "+(h?h:"vec3(1.0)")+";\n"),h=ha.getInputLinkID(this,2),f=f+("\t "+g+".Emission = "+(h?h:"vec3(0.0)")+";\n"),h=ha.getInputLinkID(this,3),f=f+("\t "+g+".Normal = "+(h?h:"IN.worldNormal")+";\n"),h=ha.getInputLinkID(this,4),f=f+("\t "+
g+".Specular = "+(h?h:"0.0")+";\n"),h=ha.getInputLinkID(this,5),f=f+("\t "+g+".Gloss = "+(h?h:"10.0")+";\n"),h=ha.getInputLinkID(this,6),f=f+("\t "+g+".Reflectivity = "+(h?h:"0.0")+";\n"),h=ha.getInputLinkID(this,7),f=f+("\t "+g+".Alpha = "+(h?h:"1.0")+";\n"),h=ha.getInputLinkID(this,8),f=f+("\t "+g+".Extra = "+(h?h:"vec4(0.0)")+";\n")+("\n\t\tLight LIGHT = getLight();\n\t\tFinalLight final_light = computeLight( "+g+", IN, LIGHT );\n\t\t");b&&(f+="\n\t\t\tvec4 _surf_color = vec4(0.0);\n\t\t\t_surf_color.xyz = applyLight( "+
g+", final_light );\n\t\t\t_surf_color.a = "+g+".Alpha;\n\t\t\tif( "+g+".Reflectivity > 0.0 )\n\t\t\t\t_surf_color = applyReflection( IN, "+g+", _surf_color );\n\t\t\tvec4 "+b+" = _surf_color;\n\t\t\t");c&&(f+="\tFinalLight "+c+" = final_light;\n");e&&(f+="\tSurfaceOutput "+e+" = "+g+";\n");a.addCode("code",f,this.shader_destination);a.addCode("vs_out",'#pragma shaderblock "light"');a.addCode("vs_global","applyLight(v_pos);");a.addCode("fs_out",'#pragma shaderblock "light"\n\t\t\t#pragma shaderblock "applyReflection"\n\t\t');
a.material.light_mode=d.Material.SEVERAL_LIGHTS;this.setOutputData(0,"vec4");this.setOutputData(1,"Light");this.setOutputData(2,"FinalLight")}};ha.registerShaderNode("light/phong",pc);var sb=function(){this.addInput("light","FinalLight");this.addInput("color","vec3");this.addInput("ambient","vec3");this.addInput("diffuse","float");this.addInput("specular","float");this.addInput("emission","vec3");this.addInput("reflectivity","float");this.addInput("attenuation","float");this.addInput("shadow","float");
this.addInput("vector","vec3");this.addOutput("light","FinalLight");this.addOutput("color","vec3");this.addOutput("ambient","vec3");this.addOutput("diffuse","float");this.addOutput("specular","float");this.addOutput("emission","vec3");this.addOutput("reflectivity","float");this.addOutput("attenuation","float");this.addOutput("shadow","float");this.addOutput("vector","vec3")};sb.title="PhongFinalLight";sb.props="light color ambient diffuse specular emission reflectivity attenuation shadow vector".split(" ");
sb.propstypes="FinalLight vec3 vec3 float float vec3 float float float vec3".split(" ");sb.prototype.onGetCode=function(a,b){if("glsl"==a){var c=ha.getShaderNodeVarName(this,"LIGHT"),e="\tFinalLight "+c+";\n",d=ha.getInputLinkID(this,0);d&&(e+="\t"+c+" = "+d+";\n");for(var f=1;f<sb.props.length;++f){var h=sb.props[f];(d=ha.getInputLinkID(this,f))&&(input_code+="\t"+c+"."+h+" = "+d+";\n");(d=ha.getOutputLinkID(this,f))&&(output_code+="\t"+sb.propstypes[f]+" "+d+" = "+c+"."+h+";\n")}e+="\n\n";(d=ha.getOutputLinkID(this,
0))&&(e+="\tFinalLight "+d+" = "+c+";\n");b.addCode("fs_code",e);b.addCode("vs_out",'#pragma shaderblock "light"\n');b.addCode("fs_out",'\n#pragma shaderblock "light"\n')}};ha.registerShaderNode("light/phongLightInfo",sb);var qc=function(){this.addOutput("worldPos","vec3");this.addOutput("vertex","vec3");this.addOutput("worldNormal","vec3");this.addOutput("normal","vec3");this.addOutput("uv","vec2");this.addOutput("uv1","vec2");this.addOutput("color","vec4");this.addOutput("screenPos","vec4");this.addOutput("viewDir",
"vec3")};qc.title="Vertex";qc.prototype.onGetCode=function(a){var b="",c=ha.getOutputLinkID(this,0);c&&(b+="\tvec3 "+c+" = IN.worldPos;\n");(c=ha.getOutputLinkID(this,1))&&(b+="\tvec3 "+c+" = IN.vertex;\n");(c=ha.getOutputLinkID(this,2))&&(b+="\tvec3 "+c+" = IN.worldNormal;\n");(c=ha.getOutputLinkID(this,3))&&(b+="\tvec3 "+c+" = IN.normal;\n");(c=ha.getOutputLinkID(this,4))&&(b+="\tvec2 "+c+" = IN.uv;\n");(c=ha.getOutputLinkID(this,5))&&(b+="\tvec2 "+c+" = IN.uv1;\n");(c=ha.getOutputLinkID(this,6))&&
(b+="\tvec4 "+c+" = IN.color;\n");(c=ha.getOutputLinkID(this,7))&&(b+="\tvec4 "+c+" = IN.screenPos;\n");(c=ha.getOutputLinkID(this,8))&&(b+="\tvec3 "+c+" = IN.viewDir;\n");a.addCode("code",b,this.shader_destination);this.setOutputData(0,"vec3");this.setOutputData(1,"vec3");this.setOutputData(2,"vec3");this.setOutputData(3,"vec3");this.setOutputData(4,"vec2");this.setOutputData(5,"vec2");this.setOutputData(6,"vec4");this.setOutputData(7,"vec4");this.setOutputData(8,"vec3")};LiteGraph.Shaders.registerShaderNode("input/vertex",
qc)}ya.prototype.clear=function(){this.points.length=0};ya.prototype.addPoint=function(a){var b=vec3.create();b[0]=a[0];b[1]=a[1];2<a.length&&(b[2]=a[2]);this.points.push(b)};ya.prototype.getSegments=function(){var a=this.points.length;switch(this.type){case d.LINEAR:if(2>a)break;return a-1+(this.closed?1:0);case d.HERMITE:if(2>a)break;return a-1+(this.closed?1:0);case d.BEZIER:if(3>a)break;return((a-1)/3|0)+(this.closed?1:0)}return 0};ya.prototype.movePoint=function(a,b,c){if(!(0>a&&a>=this.points.length)){var e=
this.points[a],g=vec3.sub(vec3.create(),b,e);vec3.copy(e,b);c&&this.type==d.BEZIER&&(2==a%3&&this.points.length>a+2?(g=this.points[a+1],a=this.points[a+2],e=vec3.sub(vec3.create(),g,e),vec3.add(a,g,e)):1==a%3&&3<a?(g=this.points[a-1],b=this.points[a-2],e=vec3.sub(vec3.create(),g,e),vec3.add(b,g,e)):0==a%3&&(1<a&&(b=this.points[a-1],vec3.add(b,b,g)),a<this.points.length-1&&(a=this.points[a+1],vec3.add(a,a,g))))}};ya.prototype.computePoint=function(a,b){switch(this.type){case d.HERMITE:return this.getHermitePoint(a,
b);case d.BEZIER:return this.getBezierPoint(a,b);default:return this.getLinearPoint(a,b)}};ya.prototype.getLinearPoint=function(a,b){b=b||vec3.create();var c=this.points.length,e=c;if(2>e)return b;if(0>=a)return vec3.copy(b,this.points[0]);if(1<=a)return this.closed?vec3.copy(b,this.points[0]):vec3.copy(b,this.points[e-1]);this.closed&&(e+=1);var e=(e-1)*a,d=e|0;return vec3.lerp(b,this.points[d%c],this.points[(d+1)%c],e-d)};ya.temp_vec3a=vec3.create();ya.temp_vec3b=vec3.create();ya.temp_vec3c=vec3.create();
ya.prototype.getBezierPoint=function(a,b){b=b||vec3.create();var c=this.points.length;if(4>c)return b;c=3*((c-1)/3|0)+1;if(0>=a)return vec3.copy(b,this.points[0]);if(1<=a)return vec3.copy(b,this.points[this.closed?0:c-1]);var e=(c-1)/3+(this.closed?1:0),d=e*a,f=d|0,d=d-f,h=3*f,k=3*f+1,l=3*f+2,m=3*f+3;this.closed&&f==e-1?(e=this.points[c-1],m=this.points[0],l=vec3.sub(ya.temp_vec3c,e,this.points[c-2]),c=vec3.add(ya.temp_vec3a,e,l),l=vec3.sub(ya.temp_vec3c,m,this.points[1]),l=vec3.add(ya.temp_vec3b,
m,l)):(e=this.points[h],c=this.points[k],l=this.points[l],m=this.points[m]);f=(1-d)*(1-d)*(1-d);k=3*d*(1-d)*(1-d);h=3*d*d*(1-d);d*=d*d;b[0]=e[0]*f+c[0]*k+l[0]*h+m[0]*d;b[1]=e[1]*f+c[1]*k+l[1]*h+m[1]*d;b[2]=e[2]*f+c[2]*k+l[2]*h+m[2]*d;return b};ya.prototype.getHermitePoint=function(a,b){b=b||vec3.create();var c=this.points.length;if(2>c)return b;if(0>=a)return vec3.copy(b,this.points[0]);if(1<=a)return vec3.copy(b,this.points[this.closed?0:c-1]);var e=(c-1+(this.closed?1:0))*a,d=e|0,f=this.points[d-
1],h=this.points[d],k=this.points[d+1],l=this.points[d+2];f||(f=this.closed?this.points[c-1]:h);k||(k=this.points[(d+1)%c]);l||(l=this.closed?this.points[(d+2)%c]:k);V.EvaluateHermiteSplineVector(h,k,f,l,e-d,b);return b};ya.prototype.samplePoints=function(a,b){if(0>=a){var c=this.getSegments();a=this.type==d.LINEAR?c+1:20*c}b=b||Array(a);b.length=a;for(c=0;c<a;c++)b[c]=this.computePoint(c/(a-1));return b};ya.prototype.samplePointsTyped=function(a,b){b&&b.length<3*a&&(a=Math.floor(b.length/3));if(0>=
a){var c=this.getSegments();a=this.type==d.LINEAR?c+1:20*c}b=b||new Float32Array(3*a);for(c=0;c<a;c++)this.computePoint(c/(a-1),b.subarray(3*c,3*c+3));return b};ya.prototype.serialize=function(){for(var a={},b=Array(3*this.points.length),c=0;c<this.points.length;c++){var e=this.points[c];b[3*c]=e[0];b[3*c+1]=e[1];b[3*c+2]=e[2]}a.points=b;a.type=this.type;a.closed=this.closed;return a};ya.prototype.configure=function(a){this.type=a.type;this.closed=a.closed;if(a.points){this.points.length=a.points.length/
3;a=a.points;for(var b=0;b<this.points.length;b++)this.points[b]=vec3.fromValues(a[3*b],a[3*b+1],a[3*b+2])}};d.Path=ya;W.available_fx={brightness_contrast:{name:"Brightness & Contrast",uniforms:{brightness:{name:"u_brightness",type:"float",value:1,step:0.01},contrast:{name:"u_contrast",type:"float",value:1,step:0.01}},code:"color.xyz = (color.xyz * u_brightness@ - vec3(0.5)) * u_contrast@ + vec3(0.5);"},hue_saturation:{name:"Hue & Saturation",functions:["HSV"],uniforms:{hue:{name:"u_hue",type:"float",
value:0,step:0.01},saturation:{name:"u_saturation",type:"float",value:1,step:0.01},brightness:{name:"u_brightness",type:"float",value:0,step:0.01}},code:"color.xyz = rgb2hsv(color.xyz); color.xz += vec2(u_hue@,u_brightness@); color.y *= u_saturation@; color.xyz = hsv2rgb(color.xyz);"},invert:{name:"Invert color",code:"color.xyz = vec3(1.0) - color.xyz;"},threshold:{name:"Threshold",uniforms:{threshold:{name:"u_threshold",type:"float",value:0.5,min:0,max:2,step:0.01},threshold_width:{name:"u_threshold_width",
type:"float",value:0.01,min:0,max:1,step:0.001}},code:"color.xyz = vec3( smoothstep( u_threshold@ - u_threshold_width@ * 0.5, u_threshold@ + u_threshold_width@ * 0.5,  length(color.xyz) ));"},colorize:{name:"Colorize",uniforms:{colorize:{name:"u_colorize",type:"color3",value:[1,1,1]},vibrance:{name:"u_vibrance",type:"float",value:0,min:0,max:2,step:0.01}},code:"color.xyz = color.xyz * (u_colorize@ + vec3(u_vibrance@ * 0.1)) * (1.0 + u_vibrance@);"},color_add:{name:"Color add",uniforms:{color_add:{name:"u_coloradd",
type:"color3",value:[0.1,0.1,0.1]}},code:"color.xyz = color.xyz + u_coloradd@;"},fog:{name:"fog",uniforms:{fog_color:{name:"u_fog_color",type:"color3",value:[0.1,0.1,0.1]},fog_start:{name:"u_fog_start",type:"float",value:10},fog_density:{name:"u_fog_density",type:"float",precision:1E-5,value:0.001,step:1E-5}},code:"float z_n@ = 2.0 * texture2D( u_depth_texture, v_coord).x - 1.0;float cam_dist@ = 2.0 * u_depth_range.x * u_depth_range.y / (u_depth_range.y + u_depth_range.x - z_n@ * (u_depth_range.y - u_depth_range.x));float fog_factor@ = 1. - 1.0 / exp(max(0.0,cam_dist@ - u_fog_start@) * u_fog_density@);color.xyz = mix( color.xyz, u_fog_color@, fog_factor@ );"},
vigneting:{name:"Vigneting",uniforms:{radius:{name:"u_radius",type:"float",value:1},intensity:{name:"u_vigneting",type:"float",value:1,min:0,max:2,step:0.01}},code:"color.xyz = mix( color.xyz * max( 1.0 - (dist_to_center * u_radius@ / 0.7071), 0.0), color.xyz, u_vigneting@);"},aberration:{name:"Chromatic Aberration",break_pass:!0,uniforms:{difraction:{name:"u_difraction",type:"float",value:1}},code:"color.x = texture2D(u_texture, uv - to_center * 0.001 * u_difraction@ ).x;color.z = texture2D(u_texture, uv + to_center * 0.001 * u_difraction@ ).z;"},
halftone:{name:"Halftone",uniforms:{"Halftone angle":{name:"u_halftone_angle",type:"float",value:0,step:0.01},"Halftone size":{name:"u_halftone_size",type:"float",value:1,step:0.01}},functions:["pattern"],code:"color.x = ( (color.x * 10.0 - 5.0) + pattern( u_halftone_angle@, u_halftone_size@ ) );color.y = ( (color.y * 10.0 - 5.0) + pattern( u_halftone_angle@ + 0.167, u_halftone_size@ ) );color.z = ( (color.z * 10.0 - 5.0) + pattern( u_halftone_angle@ + 0.333, u_halftone_size@ ) );"},halftoneBN:{name:"Halftone B/N",
uniforms:{"Halftone angle":{name:"u_halftone_angle",type:"float",value:0,step:0.01},"Halftone size":{name:"u_halftone_size",type:"float",value:1,step:0.01}},functions:["pattern"],code:"color.xyz = vec3( (length(color.xyz) * 10.0 - 5.0) + pattern( u_halftone_angle@, u_halftone_size@ ) );"},lens:{name:"Lens Distortion",break_pass:!0,uniforms:{lens_k:{name:"u_lens_k",type:"float",value:-0.15},lens_kcube:{name:"u_lens_kcube",type:"float",value:0.8},lens_scale:{name:"u_lens_scale",type:"float",value:1}},
uv_code:"float r2 = u_aspect * u_aspect * (uv.x-0.5) * (uv.x-0.5) + (uv.y-0.5) * (uv.y-0.5); float distort@ = 1. + r2 * (u_lens_k@ + u_lens_kcube@ * sqrt(r2)); uv = vec2( u_lens_scale@ * distort@ * (uv.x-0.5) + 0.5, u_lens_scale@  * distort@ * (uv.y-0.5) + 0.5 );"},image:{name:"Image",uniforms:{image_texture:{name:"u_image_texture",type:"sampler2D",widget:"Texture",value:""},image_alpha:{name:"u_image_alpha",type:"float",value:1,step:0.001},image_scale:{name:"u_image_scale",type:"vec2",value:[1,1],
step:0.001}},code:"vec4 image@ = texture2D( u_image_texture@, (uv - vec2(0.5)) * u_image_scale@ + vec2(0.5)); color.xyz = mix(color.xyz, image@.xyz, image@.a * u_image_alpha@ );"},warp:{name:"Warp",break_pass:!0,uniforms:{warp_amp:{name:"u_warp_amp",type:"float",value:0.01,step:0.001},warp_offset:{name:"u_warp_offset",type:"vec2",value:[0,0],step:0.001},warp_scale:{name:"u_warp_scale",type:"vec2",value:[1,1],step:0.001},warp_texture:{name:"u_warp_texture",type:"sampler2D",widget:"Texture",value:""}},
uv_code:"uv = uv + u_warp_amp@ * (texture2D( u_warp_texture@, uv * u_warp_scale@ + u_warp_offset@ ).xy - vec2(0.5));"},LUT:{name:"LUT",functions:["LUT"],uniforms:{lut_intensity:{name:"u_lut_intensity",type:"float",value:1,step:0.01},lut_texture:{name:"u_lut_texture",type:"sampler2D",filter:"nearest",wrap:"clamp",widget:"Texture",value:""}},code:"color.xyz = mix(color.xyz, LUT( color.xyz, u_lut_texture@ ), u_lut_intensity@);"},pixelate:{name:"Pixelate",uniforms:{width:{name:"u_width",type:"float",
value:256,step:1,min:1},height:{name:"u_height",type:"float",value:256,step:1,min:1}},uv_code:"uv = vec2( floor(uv.x * u_width@) / u_width@, floor(uv.y * u_height@) / u_height@ );"},quantize:{name:"Quantize",functions:["dither"],uniforms:{levels:{name:"u_levels",type:"float",value:8,step:1,min:1},dither:{name:"u_dither",type:"float",value:0.1,max:1}},code:"\n\t\tif( u_dither@ > 0.0 )\n\t\t{\n\t\t\tvec3 qcolor@ = floor(color.xyz * u_levels@) / u_levels@;\n\t\t\tvec3 diff@ = (color.xyz - qcolor@) * u_levels@ * u_dither@;\n\t\t\tcolor.xyz = qcolor@ + vec3(dither(diff@.x),dither(diff@.y),dither(diff@.z)) / u_levels@;\n\t\t}\n\t\telse\n\t\t\tcolor.xyz = floor(color.xyz * u_levels@) / u_levels@;\n"},
edges:{name:"Edges",break_pass:!0,uniforms:{"Edges factor":{name:"u_edges_factor",type:"float",value:1}},code:"vec4 color@ = texture2D(u_texture, uv );\n\t\t\t\tvec4 color_up@ = texture2D(u_texture, uv + vec2(0., u_iviewport.y));\n\t\t\t\tvec4 color_right@ = texture2D(u_texture, uv + vec2(u_iviewport.x,0.));\n\t\t\t\tvec4 color_down@ = texture2D(u_texture, uv + vec2(0., -u_iviewport.y));\n\t\t\t\tvec4 color_left@ = texture2D(u_texture, uv + vec2(-u_iviewport.x,0.));\n\t\t\t\tcolor = u_edges_factor@ * (abs(color@ - color_up@) + abs(color@ - color_down@) + abs(color@ - color_left@) + abs(color@ - color_right@));"},
depth:{name:"Depth",uniforms:{near:{name:"u_near",type:"float",value:0.01,step:0.1},far:{name:"u_far",type:"float",value:1E3,step:1}},code:"color.xyz = vec3( (2.0 * u_near@) / (u_far@ + u_near@ - texture2D( u_depth_texture, uv ).x * (u_far@ - u_near@)) );"},logarithmic:{name:"Logarithmic",uniforms:{"Log. A Factor":{name:"u_logfactor_a",type:"float",value:2,step:0.01},"Log. B Factor":{name:"u_logfactor_b",type:"float",value:2,step:0.01}},code:"color.xyz = log( color.xyz * u_logfactor_a@ ) * u_logfactor_b@;"},
ditherBN:{name:"dither B/N",functions:["dither"],code:"color.xyz = vec3( dither( color.x ) );"},dither:{name:"Dither",functions:["dither"],code:"color.xyz = vec3( dither( color.x ), dither( color.y ), dither( color.z ) );"},gamma:{name:"Gamma",uniforms:{Gamma:{name:"u_gamma",type:"float",value:2.2,step:0.01}},code:"color.xyz = pow( color.xyz, vec3( 1.0 / u_gamma@) );"},noiseBN:{name:"Noise B&N",functions:["noise"],uniforms:{noise:{name:"u_noise",type:"float",value:0.1,step:0.01}},code:"color.xyz += u_noise@ * vec3( noise( (u_random + v_coord) * u_viewport) );"}};
W.available_functions={pattern:"float pattern(float angle, float size) {\n\t\t\t\tfloat s = sin(angle * 3.1415), c = cos(angle * 3.1415);\n\t\t\t\tvec2 tex = v_coord * u_viewport.xy;\n\t\t\t\tvec2 point = vec2( c * tex.x - s * tex.y , s * tex.x + c * tex.y ) * size;\n\t\t\t\treturn (sin(point.x) * sin(point.y)) * 4.0;\n\t\t\t}\n\t\t",dither:"float dither(float v) {\n\t\t\t\tvec2 pixel = v_coord * u_viewport;\n\t\t\t\tint i = int(floor(clamp(v,0.0,1.0) * 16.0 + 0.5));\n\t\t\t\tif(i < 1)\n\t\t\t\t\treturn 0.0;\n\t\t\t\tif(i >= 15)\n\t\t\t\t\treturn 1.0;\n\t\t\t\tfloat x = floor(pixel.x);\n\t\t\t\tfloat y = floor(pixel.y);\n\t\t\t\tbool xmod4 = mod(x, 4.0) == 0.0;\n\t\t\t\tbool ymod4 = mod(y, 4.0) == 0.0;\n\t\t\t\tbool xmod2 = mod(x, 2.0) == 0.0;\n\t\t\t\tbool ymod2 = mod(y, 2.0) == 0.0;\n\t\t\t\tbool xmod4_2 = mod(x + 2.0, 4.0) == 0.0;\n\t\t\t\tbool ymod4_2 = mod(y + 2.0, 4.0) == 0.0;\n\t\t\t\tbool xmod2_1 = mod(x + 1.0, 2.0) == 0.0;\n\t\t\t\tbool ymod2_1 = mod(y + 1.0, 2.0) == 0.0;\n\t\t\t\tbool xmod4_1 = mod(x + 1.0, 4.0) == 0.0;\n\t\t\t\tbool ymod4_1 = mod(y + 1.0, 4.0) == 0.0;\n\t\t\t\tbool xmod4_3 = mod(x + 3.0, 4.0) == 0.0;\n\t\t\t\tbool ymod4_3 = mod(y + 3.0, 4.0) == 0.0;\n\t\t\t\t\n\t\t\t\tif(i < 9)\n\t\t\t\t{\n\t\t\t\t\tif(i >= 1 && xmod4 && ymod4 )\n\t\t\t\t\t\treturn 1.0;\n\t\t\t\t\tif(i >= 2 && xmod4_2 && ymod4_2)\n\t\t\t\t\t\treturn 1.0;\n\t\t\t\t\tif(i >= 3 && xmod4_2 && ymod2 )\n\t\t\t\t\t\treturn 1.0;\n\t\t\t\t\tif(i >= 4 && xmod2 && ymod2 )\n\t\t\t\t\t\treturn 1.0;\n\t\t\t\t\tif(i >= 5 && xmod4_1 && ymod4_1 )\n\t\t\t\t\t\treturn 1.0;\n\t\t\t\t\tif(i >= 6 && xmod4_3 && ymod4_3 )\n\t\t\t\t\t\treturn 1.0;\n\t\t\t\t\tif(i >= 7 && xmod4_1 && ymod4_3 )\n\t\t\t\t\t\treturn 1.0;\n\t\t\t\t\tif(i >= 8 && xmod4_3 && ymod4_1 )\n\t\t\t\t\t\treturn 1.0;\n\t\t\t\t\treturn 0.0;\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\tif(i < 15 && xmod4_1 && ymod4 )\n\t\t\t\t\t\treturn 0.0;\n\t\t\t\t\tif(i < 14 && xmod4_3 && ymod4_2)\n\t\t\t\t\t\treturn 0.0;\n\t\t\t\t\tif(i < 13 && xmod4_3 && ymod2 )\n\t\t\t\t\t\treturn 0.0;\n\t\t\t\t\tif(i < 12 && xmod2_1 && ymod2 )\n\t\t\t\t\t\treturn 0.0;\n\t\t\t\t\tif(i < 11 && xmod4_2 && ymod4_1 )\n\t\t\t\t\t\treturn 0.0;\n\t\t\t\t\tif(i < 10 && xmod4 && ymod4_3 )\n\t\t\t\t\t\treturn 0.0;\n\t\t\t\t\treturn 1.0;\n\t\t\t\t}\n\t\t\t}\n\t\t",
dither8x8:"\n\t\tfloat dither8x8(vec2 position, float brightness) {\n\t\t  int x = int(mod(position.x, 8.0));\n\t\t  int y = int(mod(position.y, 8.0));\n\t\t  int index = x + y * 8;\n\t\t  float limit = 0.0;\n\t\t  if (x < 8) {\n\t\t\tif (index == 0) limit = 0.015625;\n\t\t\telse if (index == 1) limit = 0.515625;\n\t\t\telse if (index == 2) limit = 0.140625;\n\t\t\telse if (index == 3) limit = 0.640625;\n\t\t\telse if (index == 4) limit = 0.046875;\n\t\t\telse if (index == 5) limit = 0.546875;\n\t\t\telse if (index == 6) limit = 0.171875;\n\t\t\telse if (index == 7) limit = 0.671875;\n\t\t\telse if (index == 8) limit = 0.765625;\n\t\t\telse if (index == 9) limit = 0.265625;\n\t\t\telse if (index == 10) limit = 0.890625;\n\t\t\telse if (index == 11) limit = 0.390625;\n\t\t\telse if (index == 12) limit = 0.796875;\n\t\t\telse if (index == 13) limit = 0.296875;\n\t\t\telse if (index == 14) limit = 0.921875;\n\t\t\telse if (index == 15) limit = 0.421875;\n\t\t\telse if (index == 16) limit = 0.203125;\n\t\t\telse if (index == 17) limit = 0.703125;\n\t\t\telse if (index == 18) limit = 0.078125;\n\t\t\telse if (index == 19) limit = 0.578125;\n\t\t\telse if (index == 20) limit = 0.234375;\n\t\t\telse if (index == 21) limit = 0.734375;\n\t\t\telse if (index == 22) limit = 0.109375;\n\t\t\telse if (index == 23) limit = 0.609375;\n\t\t\telse if (index == 24) limit = 0.953125;\n\t\t\telse if (index == 25) limit = 0.453125;\n\t\t\telse if (index == 26) limit = 0.828125;\n\t\t\telse if (index == 27) limit = 0.328125;\n\t\t\telse if (index == 28) limit = 0.984375;\n\t\t\telse if (index == 29) limit = 0.484375;\n\t\t\telse if (index == 30) limit = 0.859375;\n\t\t\telse if (index == 31) limit = 0.359375;\n\t\t\telse if (index == 32) limit = 0.0625;\n\t\t\telse if (index == 33) limit = 0.5625;\n\t\t\telse if (index == 34) limit = 0.1875;\n\t\t\telse if (index == 35) limit = 0.6875;\n\t\t\telse if (index == 36) limit = 0.03125;\n\t\t\telse if (index == 37) limit = 0.53125;\n\t\t\telse if (index == 38) limit = 0.15625;\n\t\t\telse if (index == 39) limit = 0.65625;\n\t\t\telse if (index == 40) limit = 0.8125;\n\t\t\telse if (index == 41) limit = 0.3125;\n\t\t\telse if (index == 42) limit = 0.9375;\n\t\t\telse if (index == 43) limit = 0.4375;\n\t\t\telse if (index == 44) limit = 0.78125;\n\t\t\telse if (index == 45) limit = 0.28125;\n\t\t\telse if (index == 46) limit = 0.90625;\n\t\t\telse if (index == 47) limit = 0.40625;\n\t\t\telse if (index == 48) limit = 0.25;\n\t\t\telse if (index == 49) limit = 0.75;\n\t\t\telse if (index == 50) limit = 0.125;\n\t\t\telse if (index == 51) limit = 0.625;\n\t\t\telse if (index == 52) limit = 0.21875;\n\t\t\telse if (index == 53) limit = 0.71875;\n\t\t\telse if (index == 54) limit = 0.09375;\n\t\t\telse if (index == 55) limit = 0.59375;\n\t\t\telse if (index == 56) limit = 1.0;\n\t\t\telse if (index == 57) limit = 0.5;\n\t\t\telse if (index == 58) limit = 0.875;\n\t\t\telse if (index == 59) limit = 0.375;\n\t\t\telse if (index == 60) limit = 0.96875;\n\t\t\telse if (index == 61) limit = 0.46875;\n\t\t\telse if (index == 62) limit = 0.84375;\n\t\t\telse if (index == 63) limit = 0.34375;\n\t\t  }\n\t\t  return brightness < limit ? 0.0 : 1.0;\n\t\t}\n",
LUT:"vec3 LUT(in vec3 color, in sampler2D textureB) {\n\t\t lowp vec3 textureColor = clamp( color, vec3(0.0), vec3(1.0) );\n\t\t mediump float blueColor = textureColor.b * 63.0;\n\t\t mediump vec2 quad1;\n\t\t quad1.y = floor(floor(blueColor) / 8.0);\n\t\t quad1.x = floor(blueColor) - (quad1.y * 8.0);\n\t\t mediump vec2 quad2;\n\t\t quad2.y = floor(ceil(blueColor) / 8.0);\n\t\t quad2.x = ceil(blueColor) - (quad2.y * 8.0);\n\t\t highp vec2 texPos1;\n\t\t texPos1.x = (quad1.x * 0.125) + 0.5/512.0 + ((0.125 - 1.0/512.0) * textureColor.r);\n\t\t texPos1.y = 1.0 - ((quad1.y * 0.125) + 0.5/512.0 + ((0.125 - 1.0/512.0) * textureColor.g));\n\t\t highp vec2 texPos2;\n\t\t texPos2.x = (quad2.x * 0.125) + 0.5/512.0 + ((0.125 - 1.0/512.0) * textureColor.r);\n\t\t texPos2.y = 1.0 - ((quad2.y * 0.125) + 0.5/512.0 + ((0.125 - 1.0/512.0) * textureColor.g));\n\t\t lowp vec3 newColor1 = texture2D(textureB, texPos1).xyz;\n\t\t lowp vec3 newColor2 = texture2D(textureB, texPos2).xyz;\n\t\t lowp vec3 newColor = mix(newColor1, newColor2, fract(blueColor));\n\t\t return newColor.rgb;\n\t }",
noise:"\n\t\tfloat hash(float n) { return fract(sin(n) * 1e4); }\n\t\tfloat hash(vec2 p) { return fract(1e4 * sin(17.0 * p.x + p.y * 0.1) * (0.1 + abs(sin(p.y * 13.0 + p.x)))); }\n\t\tfloat noise(float x) {\n\t\t\tfloat i = floor(x);\n\t\t\tfloat f = fract(x);\n\t\t\tfloat u = f * f * (3.0 - 2.0 * f);\n\t\t\treturn mix(hash(i), hash(i + 1.0), u);\n\t\t}\n\t\tfloat noise(vec2 x) {\n\t\t\tvec2 i = floor(x);\n\t\t\tvec2 f = fract(x);\n\t\t\tfloat a = hash(i);\n\t\t\tfloat b = hash(i + vec2(1.0, 0.0));\n\t\t\tfloat c = hash(i + vec2(0.0, 1.0));\n\t\t\tfloat d = hash(i + vec2(1.0, 1.0));\n\t\t\tvec2 u = f * f * (3.0 - 2.0 * f);\n\t\t\treturn mix(a, b, u.x) + (c - a) * u.y * (1.0 - u.x) + (d - b) * u.x * u.y;\n\t\t}\n\t",
HSV:"vec3 rgb2hsv(vec3 c)\n\t\t{\n\t\t\tvec4 K = vec4(0.0, -1.0 / 3.0, 2.0 / 3.0, -1.0);\n\t\t\tvec4 p = mix(vec4(c.bg, K.wz), vec4(c.gb, K.xy), step(c.b, c.g));\n\t\t\tvec4 q = mix(vec4(p.xyw, c.r), vec4(c.r, p.yzx), step(p.x, c.r));\n\t\t\t\n\t\t\tfloat d = q.x - min(q.w, q.y);\n\t\t\tfloat e = 1.0e-10;\n\t\t\treturn vec3(abs(q.z + (q.w - q.y) / (6.0 * d + e)), d / (q.x + e), q.x);\n\t\t}\n\t\t\n\t\tvec3 hsv2rgb(vec3 c)\n\t\t{\n\t\t\tvec4 K = vec4(1.0, 2.0 / 3.0, 1.0 / 3.0, 3.0);\n\t\t\tvec3 p = abs(fract(c.xxx + K.xyz) * 6.0 - K.www);\n\t\t\treturn c.z * mix(K.xxx, clamp(p - K.xxx, 0.0, 1.0), c.y);\n\t\t}"};
W.prototype.configure=function(a){this.apply_fxaa=!!a.apply_fxaa;a.fx&&(this.fx=a.fx.concat());this._must_update_passes=!0};W.prototype.serialize=W.prototype.toJSON=function(){return{apply_fxaa:this.apply_fxaa,fx:this.fx.concat()}};W.prototype.getResources=function(a){for(var b=this.fx,c=0;c<b.length;c++){var e=b[c],d=W.available_fx[e.name];if(d&&d.uniforms)for(var f in d.uniforms)"sampler2D"==d.uniforms[f].type&&e[f]&&(a[e[f]]=GL.Texture)}return a};W.prototype.onResourceRenamed=function(a,b,c){c=
this.fx;for(var e=0;e<c.length;e++){var d=c[e],f=W.available_fx[d.name];if(f&&f.uniforms)for(var h in f.uniforms)"sampler2D"==f.uniforms[h].type&&d[h]==a&&(d[h]=b)}};W.prototype.addFX=function(a){a&&(W.available_fx[a]?(this.fx.push({name:a}),this._must_update_passes=!0):console.warn("FXStack not found: "+a))};W.prototype.getFX=function(a){return this.fx[a]};W.prototype.moveFX=function(a,b){b=b||-1;var c=this.fx.indexOf(a);-1!=c&&(this.fx.splice(c,1),c+=b,0<=c&&c<this.fx.length?this.fx.splice(c,0,
a):this.fx.push(a),this._must_update_passes=!0)};W.prototype.removeFX=function(a){for(var b=0;b<this.fx.length;b++)if(this.fx[b]===a){this.fx.splice(b,1);this._must_update_passes=!0;break}};W.prototype.buildPasses=function(){for(var a=this.fx,b=[],c={fxs:[],uniforms:{},shader:null,first_fx_id:0},e="",d="",f="",h={},k=!0,l=0,m=0;m<a.length;m++){var p=a[m],l=m,n=W.available_fx[p.name];if(n){n.break_pass&&!k?(c.uv_code=e,c.color_code=d,c.uniforms_code=f,c.included_functions=h,b.push(c),this.buildPassShader(c),
f=d=e="",h={},c={fxs:[],uniforms:{},first_fx_id:l},k=!0):k=!1;if(n.functions)for(var r in n.functions)h[n.functions[r]]=!0;n.code&&(d+=n.code.split("@").join(l)+";\n");n.uv_code&&(e+=n.uv_code.split("@").join(l)+";\n");if(n.uniforms)for(var t in n.uniforms)var x=n.uniforms[t],f=f+("uniform "+x.type+" "+(x.name+l)+";\n");c.fxs.push(p)}}k||(c.uv_code=e,c.color_code=d,c.included_functions=h,b.push(c),this.buildPassShader(c));this._passes=b};W.prototype.buildPassShader=function(a){var b="",c;for(c in a.included_functions){var e=
W.available_functions[c];e?b+=e+"\n":console.error("FXStack: Function not found: "+c)}b="\n\t\t#extension GL_OES_standard_derivatives : enable\n\t\tprecision highp float;\n\t\t#define color3 vec3\n\t\t#define color4 vec4\n\t\tuniform sampler2D u_texture;\n\t\tuniform sampler2D u_depth_texture;\n\t\tvarying vec2 v_coord;\n\t\tuniform vec2 u_viewport;\n\t\tuniform vec2 u_iviewport;\n\t\tuniform float u_aspect;\n\t\tuniform vec2 u_depth_range;\n\t\tuniform vec2 u_random;\n\t\tvec2 uv;\n\t\t"+a.uniforms_code+
"\n\t\t"+b+"\n\t\tvoid main() {\n\t\t\tuv = v_coord;\n\t\t\tvec2 to_center = vec2(0.5) - uv;\n\t\t\tfloat dist_to_center = length(to_center);\n\t\t\t"+a.uv_code+"\n\t\t\tvec4 color = texture2D(u_texture, uv);\n\t\t\tfloat temp = 0.0;\n\t\t\t"+a.color_code+"\n\t\t\tgl_FragColor = color;\n\t\t}\n\t\t";this._must_update_passes=!1;a.shader=new GL.Shader(GL.Shader.SCREEN_VERTEX_SHADER,b);return a.shader};W.prototype.applyFX=function(a,b,c){var e=c.depth_texture,g=this._uniforms;g.u_viewport[0]=a.width;
g.u_viewport[1]=a.height;g.u_iviewport[0]=1/a.width;g.u_iviewport[1]=1/a.height;g.u_aspect=a.width/a.height;g.u_random[0]=Math.random();g.u_random[1]=Math.random();this._passes&&!this._must_update_passes||this.buildPasses();if(this._passes.length){var f=b?b.width:a.width,h=b?b.height:a.height;c=GL.Texture.getTemporary(f,h,{type:a.type,format:a.format});f=GL.Texture.getTemporary(f,h,{type:a.type,format:a.format});a.copyTo(c);for(var k=0,h=0;h<this._passes.length;h++){for(var l=this._passes[h],m=2,
p=l.uniforms,n=0;n<l.fxs.length;++n){var r=l.fxs[n],k=l.first_fx_id+n,t=W.available_fx[r.name];if(t&&t.uniforms)for(var x in t.uniforms){var u=t.uniforms[x],L=u.name+k;"sampler2D"==u.type?(p[L]=m,(L=this.getTexture(r[x]))?(L.bind(m),"nearest"==u.filter&&(gl.texParameteri(L.texture_type,gl.TEXTURE_MAG_FILTER,gl.NEAREST),gl.texParameteri(L.texture_type,gl.TEXTURE_MIN_FILTER,gl.NEAREST)),"clamp"==u.wrap&&(gl.texParameteri(L.texture_type,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE),gl.texParameteri(L.texture_type,
gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE))):(L=d.Renderer._missing_texture)&&L.bind(m),m++):p[L]=void 0!==r[n]?r[n]:u.value}}l=l.shader;if(!l){a.toViewport();break}e&&l.hasUniform("u_depth_texture")&&(e.bind(1),e.near_far_planes&&(p.u_depth_range=e.near_far_planes));l.uniforms(g);c.copyTo(f,l,p);k=c;c=f;f=k}a=f;a.setParameter(gl.TEXTURE_MAG_FILTER,this.filter?gl.LINEAR:gl.NEAREST);a.setParameter(gl.TEXTURE_MIN_FILTER,gl.LINEAR);gl.disable(gl.DEPTH_TEST);gl.disable(gl.BLEND);gl.disable(gl.CULL_FACE);this.apply_fxaa?
(p=GL.Shader.getFXAAShader(),p.setup(),b?a.copyTo(b,p):a.toViewport(p)):b?(l.uniforms(p),a.copyTo(b,l)):a.toViewport();GL.Texture.releaseTemporary(c);GL.Texture.releaseTemporary(f)}else b?a.copyTo(b):(b=GL.Shader.getFXAAShader(),b.setup(),a.toViewport(this.apply_fxaa?b:null))};W.prototype.applyFX=function(a,b,c){c=c.depth_texture;var e=this.fx,g=this._must_update_passes;this._must_update_passes=!1;var f=this._uniforms;f.u_viewport[0]=a.width;f.u_viewport[1]=a.height;f.u_iviewport[0]=1/a.width;f.u_iviewport[1]=
1/a.height;f.u_aspect=a.width/a.height;f.u_random[0]=Math.random();f.u_random[1]=Math.random();for(var h="",k="",l={},m="",p=2,n=0,r=0;r<e.length;r++){var t=e[r],n=r,x=W.available_fx[t.name];if(x){if(g){if(x.functions)for(var u in x.functions)l[x.functions[u]]=!0;x.code&&(k+=x.code.split("@").join(n)+";\n");x.uv_code&&(h+=x.uv_code.split("@").join(n)+";\n")}if(x.uniforms)for(var L in x.uniforms){var ra=x.uniforms[L],q=ra.name+n;g&&(m+="uniform "+ra.type+" "+q+";\n");"sampler2D"==ra.type?(f[q]=p,(q=
this.getTexture(t[L]))?(q.bind(p),"nearest"==ra.filter&&(gl.texParameteri(q.texture_type,gl.TEXTURE_MAG_FILTER,gl.NEAREST),gl.texParameteri(q.texture_type,gl.TEXTURE_MIN_FILTER,gl.NEAREST)),"clamp"==ra.wrap&&(gl.texParameteri(q.texture_type,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE),gl.texParameteri(q.texture_type,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE))):(q=d.Renderer._missing_texture)&&q.bind(p),p++):f[q]=void 0!==t[L]?t[L]:ra.value}}}var G=null;if(g){u="";for(r in l)(l=W.available_functions[r])?u+=l+"\n":
console.error("FXStack: Function not found: "+r);this._last_shader=new GL.Shader(GL.Shader.SCREEN_VERTEX_SHADER,"\n\t\t\t#extension GL_OES_standard_derivatives : enable\n\t\t\tprecision highp float;\n\t\t\t#define color3 vec3\n\t\t\t#define color4 vec4\n\t\t\tuniform sampler2D u_texture;\n\t\t\tuniform sampler2D u_depth_texture;\n\t\t\tvarying vec2 v_coord;\n\t\t\tuniform vec2 u_viewport;\n\t\t\tuniform vec2 u_iviewport;\n\t\t\tuniform float u_aspect;\n\t\t\tuniform vec2 u_depth_range;\n\t\t\tuniform vec2 u_random;\n\t\t\tvec2 uv;\n\t\t\t"+
m+"\n\t\t\t"+u+"\n\t\t\tvoid main() {\n\t\t\t\tuv = v_coord;\n\t\t\t\tvec2 to_center = vec2(0.5) - uv;\n\t\t\t\tfloat dist_to_center = length(to_center);\n\t\t\t\t"+h+"\n\t\t\t\tvec4 color = texture2D(u_texture, uv);\n\t\t\t\tfloat temp = 0.0;\n\t\t\t\t"+k+"\n\t\t\t\tgl_FragColor = color;\n\t\t\t}\n\t\t\t")}G=this._last_shader;gl.disable(gl.DEPTH_TEST);gl.disable(gl.BLEND);gl.disable(gl.CULL_FACE);G?(G.hasUniform("u_depth_texture")&&c&&(c.bind(1),c.near_far_planes&&(f.u_depth_range=c.near_far_planes)),
a.setParameter(gl.TEXTURE_MAG_FILTER,this.filter?gl.LINEAR:gl.NEAREST),a.setParameter(gl.TEXTURE_MIN_FILTER,gl.LINEAR),this.apply_fxaa?(this.temp_tex&&this.temp_tex.width==gl.viewport_data[2]&&this.temp_tex.height==gl.viewport_data[3]||(this.temp_tex=new GL.Texture(gl.viewport_data[2],gl.viewport_data[3])),this.temp_tex.drawTo(function(){a.toViewport(G,f)}),c=GL.Shader.getFXAAShader(),c.setup(),b?this.temp_tex.copyTo(b,c):this.temp_tex.toViewport(c)):(this.temp_tex=null,b?(G.uniforms(f),a.copyTo(b,
G)):a.toViewport(G,f))):a.toViewport()};W.prototype.getTexture=function(a){return d.ResourcesManager.getTexture(a)};W.prototype.getPropertyInfoFromPath=function(a){if(2>a.length)return null;var b=parseInt(a[0]);if(b>=this.fx.length)return null;var b=this.fx[b],c=W.available_fx[b.name];if(!c)return null;a=a[1];return"name"==a?null:(c=c.uniforms[a])?{target:b,name:a,value:b[a],type:c.type||"number"}:null};W.prototype.setPropertyValueFromPath=function(a,b,c){c=c||0;if(a.length<c+1)return null;var e=
parseInt(a[c]);if(e>=this.fx.length)return null;e=this.fx[e];if(!e)return null;a=a[c+1];if(void 0===e[a])return null;void 0!==e[a]&&void 0!==b&&e[a].constructor===b.constructor&&(e[a]=b)};W.registerFX=function(a,b){b.name||(b.name=a);if(void 0===b.code)throw"FXStack must have a code";b.uniforms&&Object.keys(b.uniforms)&&b.code&&-1==b.code.indexOf("@")&&console.warn("FXStack using uniforms must use the character '@' at the end of every use to avoid collisions with other variables with the same name.");
W.available_fx[a]=b};W.registerFunction=function(a,b){W.available_functions[a]=b};d.FXStack=W;d.TextureFX=W;d.Tween={MAX_EASINGS:256,EASE_IN_QUAD:1,EASE_OUT_QUAD:2,EASE_IN_OUT_QUAD:3,QUAD:3,EASE_IN_CUBIC:4,EASE_OUT_CUBIC:5,EASE_IN_OUT_CUBIC:6,CUBIC:6,EASE_IN_QUART:7,EASE_OUT_QUART:8,EASE_IN_OUT_QUART:9,QUART:9,EASE_IN_SINE:10,EASE_OUT_SINE:11,EASE_IN_OUT_SINE:12,SINE:12,EASE_IN_EXPO:13,EASE_OUT_EXPO:14,EASE_IN_OUT_EXPO:15,EXPO:15,EASE_IN_BACK:16,EASE_OUT_BACK:17,EASE_IN_OUT_BACK:18,BACK:18,current_easings:[],
_alife:[],_temp:[],reset:function(){this.current_easings=[];this._alife=[]},easeProperty:function(a,b,c,e,g,f,h){if(!a)throw"ease object cannot be null";if(void 0===c)throw"target value must be defined";if(void 0===a[b])throw"property not found in object, must be initialized to a value";if(this.current_easings.length)for(var k=0;k<this.current_easings.length;++k){var l=this.current_easings[k];if(l.object===a&&l.property==b){this.current_easings.splice(k,1);break}}g=g||this.EASE_IN_OUT_QUAD;k=null;
k=b?d.cloneObject(a[b]):d.cloneObject(a);c=d.cloneObject(c);l=0;c.constructor===Number?l=-1:c&&void 0!==c.length&&(l=c.length);var m=null,p=a.constructor["@"+b];p&&(m=p.type);c={object:a,property:b,origin:k,target:c,current:0,time:e,easing:g,on_complete:f,on_progress:h,size:l,type:m,running:!0};for(k=0;k<this.current_easings.length;++k)if(this.current_easings[k].object==a&&this.current_easings[k].property==b){this.current_easings[k]=c;break}this.current_easings.length>=this.MAX_EASINGS&&this.current_easings.shift();
this.current_easings.push(c);return c},easeObject:function(a,b,c,e,g,f){if(!a||!b)throw"ease object cannot be null";e=e||this.EASE_IN_OUT_QUAD;var h=d.cloneObject(a);b=d.cloneObject(b);var k=0;void 0!==b.length&&(k=b.length);b={object:a,origin:h,target:b,current:0,time:c,easing:e,on_complete:g,on_progress:f,size:k};for(c=0;c<this.current_easings.length;++c)if(this.current_easings[c].object==a){this.current_easings[c]=b;break}this.current_easings.length>=this.MAX_EASINGS&&this.current_easings.shift();
this.current_easings.push(b);return b},cancelEaseObject:function(a,b){if(this.current_easings.length)for(var c=this.current_easings,e=0,d=c.length;e<d;++e){var f=c[e];f.object!=a||b&&f.property!=b||(f.cancel=!0)}},update:function(a){if(this.current_easings.length){var b=this.current_easings;this.current_easings=this._temp;this.current_easings.length=0;var c=this._alife;c.length=b.length;for(var e=0,d=0,f=b.length;d<f;++d){var h=b[d];h.current+=a;var k=1;if(!h.cancel){h.current<h.time&&(k=h.current/
h.time,c[e]=h,e+=1);var l=this.getEaseFactor(k,h.easing);if(h.size){if(-1==h.size)h.object[h.property]=h.target*l+h.origin*(1-l);else{var m=h.object[h.property];if(h.type&&"quat"==h.type)quat.slerp(m,h.origin,h.target,l);else for(var p=0;p<h.size;++p)m[p]=h.target[p]*l+h.origin[p]*(1-l)}void 0!==h.object.mustUpdate&&(h.object.mustUpdate=!0)}if(h.on_progress)h.on_progress(h);if(1<=k){if(h.on_complete)h.on_complete(h);h.running=!1}}}c.length=e;for(d=0;d<this.current_easings.length;++d)c.push(this.current_easings[d]);
this.current_easings=c;this._alife=b}},getEaseFactor:function(a,b){1<a?a=1:0>a&&(a=0);var c=1.70158;b=b||this.QUAD;switch(b){case this.EASE_IN_QUAD:return a*a;case this.EASE_OUT_QUAD:return 1-a*a;case this.EASE_IN_OUT_QUAD:a*=2;if(1>a)return 0.5*a*a;a-=1;return-0.5*(a*(a-2)-1);case this.EASE_IN_CUBIC:return a*a*a;case this.EASE_OUT_CUBIC:return a-=1,a*a*a+1;case this.EASE_IN_OUT_CUBIC:a*=2;if(1>a)return 0.5*a*a*a;a-=2;return 0.5*(a*a*a+2);case this.EASE_IN_QUART:return a*a*a*a;case this.EASE_OUT_QUART:return a-=
1,-(a*a*a*a-1);case this.EASE_IN_OUT_QUART:a*=2;if(1>a)return 0.5*a*a*a*a;a-=2;return-0.5*(a*a*a*a-2);case this.EASE_IN_SINE:return 1-Math.cos(a*Math.PI/2);case this.EASE_OUT_SINE:return Math.sin(a*Math.PI/2);case this.EASE_IN_OUT_SINE:return-0.5*(Math.cos(Math.PI*a)-1);case this.EASE_IN_EXPO:return 0==a?0:Math.pow(2,10*(a-1));case this.EASE_OUT_EXPO:return 1==a?1:1-Math.pow(2,-10*a);case this.EASE_IN_OUT_EXPO:if(0==a)return 0;if(1==a)return 1;a*=2;return 1>a?0.5*Math.pow(2,10*(a-1)):0.5*(-Math.pow(2,
-10*(a-1))+2);case this.EASE_IN_BACK:return a*a*((c+1)*a-c);case this.EASE_OUT_BACK:return a*a*((c+1)*a+c)+1;case this.EASE_IN_OUT_BACK:a*=2;if(1>a)return c*=1.525,0.5*a*a*((c+1)*a-c);a-=2;c*=1.525;return 0.5*(a*a*((c+1)*a+c)+2)}return a}};Pb.prototype.addEntry=function(a,b,c){if(a.constructor===d.AnimationBlender.Entry)this.active_entries.push(a);else{var e=new d.AnimationBlender.Entry;e.animation_name=a;e.take_name=b;e.time=c;this.active_entries.push(e);return e}};Pb.prototype.removeEntry=function(a){a=
this.active_entries.indexOf(a);-1!=a&&this.active_entries.splice(a,1)};Pb.prototype.execute=function(a,b){for(var c={},e=0,d=0;d<this.active_entries.length;++d){var f=this.active_entries[d];if(f._animation_take)for(var e=e+f.weight,f=f._animation_take,h=0;h<f.tracks.length;++h){var k=f.tracks[h],l=c[k.property];l||(l=c[k.property]=[]);k=k.getSample();l.push(k)}}for(d=0;d<this.active_entries.length;++d)f=this.active_entries[d],e+=f.weight;for(d=0;d<this.active_entries.length;++d)f=this.active_entries[d],
f.execute(remaining/e,!1,a,b),remaining-=f.weight};d.AnimationBlender=Pb;Object.defineProperty(Gb.prototype,"take_name",{set:function(a){this._take_name!=a&&(this._take_name=a,this._must_update=!0)},get:function(){return this._take_name},enumerable:!1});Object.defineProperty(Gb.prototype,"animation_name",{set:function(a){this._animation_name!=a&&(this._animation_name=a,this._must_update=!0)},get:function(){return this._animation_name},enumerable:!1});Object.defineProperty(Gb.prototype,"duration",
{set:function(a){throw"duration cannot be set. It depends in the animation duration";},get:function(){return this._animation_take?this._animation_take.duration:-1},enumerable:!1});Object.defineProperty(Gb.prototype,"loaded",{set:function(a){throw"duration cannot be set. It depends in the animation duration";},get:function(){return!!this._animation_take},enumerable:!1});Gb.prototype.execute=function(a,b,c,e){if(!this._animation_name||!this._take_name)return!1;if(this._must_update){var g=d.ResourcesManager.get(this._animation_name);
if(!g)return!1;this._animation_take=g.takes[this._take_name]}if(this._animation_take)return this._animation_take.applyTracks(this.time,this._last_time,b,c,e,a),this._last_time=this.time,!0};Pb.Entry=Gb;wb.prototype.add=function(a,b){var c=this.root;c.push(a);this.objects_cell_by_id.set(a,c);return a.uid};wb.prototype.updateBounding=function(a,b){};wb.prototype.remove=function(a,b){var c=this.objects_cell_by_id.get(a);if(c){var e=c.indexOf(a);-1!==e&&c.splice(e,1);this.objects_cell_by_id["delete"](a)}};
wb.prototype.retrieve=function(a){return this.root};wb.prototype.retrieveFromCamera=function(a){return this.root};wb.prototype.clear=function(){this.root.length=0;this.objects_cell_by_id=new WeakMap};d.SpatialContainer=wb;Ua.AUTO_QUALITY=0;Ua.HIGH_QUALITY=1;Ua.MEDIUM_QUALITY=2;Ua.LOW_QUALITY=3;Ua.default_shadowmap_resolution=1024;Ua["@default_shadowmap_resolution"]={widget:"combo",values:[0,256,512,1024,2048,4096]};Ua["@layers"]={type:"layers"};Ua.prototype.serialize=function(){return d.cloneObject(this)};
Ua.prototype.configure=function(a){if(a)for(var b in a)this[b]=a[b];null===this.layers&&(this.layers=255)};Ua.prototype.toJSON=Ua.prototype.serialize;d.RenderSettings=Ua;Object.defineProperty(A.prototype,"front_face",{set:function(a){this._data[0]=a},get:function(){return this._data[0]},enumerable:!0});A.SKIP_BLEND=1;A.SKIP_DEPTH=2;A.SKIP_STENCIL=4;A["@front_face"]={widget:"combo",values:{CW:GL.CW,CCW:GL.CCW}};Object.defineProperty(A.prototype,"cull_face",{set:function(a){this._data[1]=a?1:0},get:function(){return 0!==
this._data[1]},enumerable:!0});Object.defineProperty(A.prototype,"cull_face_mode",{set:function(a){this._data[2]=a},get:function(){return this._data[2]},enumerable:!0});A["@cull_face_mode"]={widget:"combo",values:{FRONT:GL.FRONT,BACK:GL.BACK,FRONT_AND_BACK:GL.FRONT_AND_BACK}};Object.defineProperty(A.prototype,"depth_test",{set:function(a){this._data[4]=a?1:0},get:function(){return 0!==this._data[4]},enumerable:!0});Object.defineProperty(A.prototype,"depth_mask",{set:function(a){this._data[5]=a?1:
0},get:function(){return 0!==this._data[5]},enumerable:!0});Object.defineProperty(A.prototype,"depth_func",{set:function(a){this._data[6]=a},get:function(){return this._data[6]},enumerable:!0});A["@depth_func"]={widget:"combo",values:{LESS:GL.LESS,LEQUAL:GL.LEQUAL,EQUAL:GL.EQUAL,NOTEQUAL:GL.NOTEQUAL,GREATER:GL.GREATER,GEQUAL:GL.GEQUAL,ALWAYS:GL.ALWAYS,NEVER:GL.NEVER}};Object.defineProperty(A.prototype,"depth_range",{set:function(a){a&&2==a.length&&(this._data[7]=a[0],this._data[8]=a[1])},get:function(){return this._data.subarray(7,
9)},enumerable:!0});Object.defineProperty(A.prototype,"blend",{set:function(a){this._data[9]=a?1:0},get:function(){return 0!==this._data[9]},enumerable:!0});Object.defineProperty(A.prototype,"blendFunc0",{set:function(a){this._data[10]=a},get:function(){return this._data[10]},enumerable:!0});A["@blendFunc0"]={widget:"combo",values:{ZERO:GL.ZERO,ONE:GL.ONE,SRC_COLOR:GL.SRC_COLOR,ONE_MINUS_SRC_COLOR:GL.ONE_MINUS_SRC_COLOR,DST_COLOR:GL.DST_COLOR,ONE_MINUS_DST_COLOR:GL.ONE_MINUS_DST_COLOR,SRC_ALPHA:GL.SRC_ALPHA,
ONE_MINUS_SRC_ALPHA:GL.ONE_MINUS_SRC_ALPHA,DST_ALPHA:GL.DST_ALPHA,ONE_MINUS_DST_ALPHA:GL.ONE_MINUS_DST_ALPHA,CONSTANT_COLOR:GL.CONSTANT_COLOR,ONE_MINUS_CONSTANT_COLOR:GL.ONE_MINUS_CONSTANT_COLOR,CONSTANT_ALPHA:GL.CONSTANT_ALPHA,ONE_MINUS_CONSTANT_ALPHA:GL.ONE_MINUS_CONSTANT_ALPHA,SRC_ALPHA_SATURATE:GL.SRC_ALPHA_SATURATE}};Object.defineProperty(A.prototype,"blendFunc1",{set:function(a){this._data[11]=a},get:function(){return this._data[11]},enumerable:!0});A["@blendFunc1"]={widget:"combo",values:{ZERO:GL.ZERO,
ONE:GL.ONE,SRC_COLOR:GL.SRC_COLOR,ONE_MINUS_SRC_COLOR:GL.ONE_MINUS_SRC_COLOR,DST_COLOR:GL.DST_COLOR,ONE_MINUS_DST_COLOR:GL.ONE_MINUS_DST_COLOR,SRC_ALPHA:GL.SRC_ALPHA,ONE_MINUS_SRC_ALPHA:GL.ONE_MINUS_SRC_ALPHA,DST_ALPHA:GL.DST_ALPHA,ONE_MINUS_DST_ALPHA:GL.ONE_MINUS_DST_ALPHA,CONSTANT_COLOR:GL.CONSTANT_COLOR,ONE_MINUS_CONSTANT_COLOR:GL.ONE_MINUS_CONSTANT_COLOR,CONSTANT_ALPHA:GL.CONSTANT_ALPHA,ONE_MINUS_CONSTANT_ALPHA:GL.ONE_MINUS_CONSTANT_ALPHA,SRC_ALPHA_SATURATE:GL.SRC_ALPHA_SATURATE}};Object.defineProperty(A.prototype,
"blendFunc",{set:function(a){a&&2==a.length&&(this._data[10]=a[0],this._data[11]=a[1])},get:function(){return this._data.subarray(10,12)},enumerable:!1});Object.defineProperty(A.prototype,"colorMask0",{set:function(a){this._data[12]=a?1:0},get:function(){return 0!==this._data[12]},enumerable:!0});Object.defineProperty(A.prototype,"colorMask1",{set:function(a){this._data[13]=a?1:0},get:function(){return 0!==this._data[13]},enumerable:!0});Object.defineProperty(A.prototype,"colorMask2",{set:function(a){this._data[14]=
a?1:0},get:function(){return 0!==this._data[14]},enumerable:!0});Object.defineProperty(A.prototype,"colorMask3",{set:function(a){this._data[15]=a?1:0},get:function(){return 0!==this._data[15]},enumerable:!0});Object.defineProperty(A.prototype,"colorMask",{set:function(a){a&&4==a.length&&(this._data[12]=a[0],this._data[13]=a[1],this._data[14]=a[2],this._data[15]=a[3])},get:function(){return this._data.subarray(12,16)},enumerable:!1});Object.defineProperty(A.prototype,"stencil_test",{set:function(a){this._data[16]=
a?1:0},get:function(){return 0!==this._data[16]},enumerable:!0});Object.defineProperty(A.prototype,"stencil_mask",{set:function(a){this._data[17]=a},get:function(){return this._data[17]},enumerable:!0});Object.defineProperty(A.prototype,"skip_blend",{set:function(a){this._data[25]=a?this._data[25]|A.SKIP_BLEND:this._data[25]&~A.SKIP_BLEND},get:function(){return Boolean(this._data[25]&A.SKIP_BLEND)},enumerable:!0});Object.defineProperty(A.prototype,"skip_depth",{set:function(a){this._data[25]=a?this._data[25]|
A.SKIP_DEPTH:this._data[25]&~A.SKIP_DEPTH},get:function(){return Boolean(this._data[25]&A.SKIP_DEPTH)},enumerable:!0});Object.defineProperty(A.prototype,"skip_stencil",{set:function(a){this._data[25]=a?this._data[25]|A.SKIP_STENCIL:this._data[25]&~A.SKIP_STENCIL},get:function(){return Boolean(this._data[25]&A.SKIP_STENCIL)},enumerable:!0});A["@stencil_mask"]={widget:"number",min:0,max:256,step:1,precision:0};Object.defineProperty(A.prototype,"stencil_func",{set:function(a){a&&3==a.length&&(this._data[18]=
a[0],this._data[19]=a[1],this._data[20]=a[2])},get:function(){return this._data.subarray(18,21)},enumerable:!1});Object.defineProperty(A.prototype,"stencil_func_func",{set:function(a){this._data[18]=a},get:function(){return this._data[18]},enumerable:!0});A["@stencil_func_func"]={widget:"combo",values:{LESS:GL.LESS,LEQUAL:GL.LEQUAL,EQUAL:GL.EQUAL,NOTEQUAL:GL.NOTEQUAL,GREATER:GL.GREATER,GEQUAL:GL.GEQUAL,ALWAYS:GL.ALWAYS,NEVER:GL.NEVER}};Object.defineProperty(A.prototype,"stencil_func_ref",{set:function(a){this._data[19]=
a},get:function(){return this._data[19]},enumerable:!0});A["@stencil_func_ref"]={widget:"number",min:0,max:256,step:1,precision:0};Object.defineProperty(A.prototype,"stencil_func_mask",{set:function(a){this._data[20]=a},get:function(){return this._data[20]},enumerable:!0});A["@stencil_func_mask"]={widget:"number",min:0,max:256,step:1,precision:0};Object.defineProperty(A.prototype,"stencil_op",{set:function(a){a&&3==a.length&&(this._data[21]=a[0],this._data[22]=a[1],this._data[23]=a[2])},get:function(){return this._data.subarray(21,
24)},enumerable:!1});Object.defineProperty(A.prototype,"stencil_op_sfail",{set:function(a){this._data[21]=a},get:function(){return this._data[21]},enumerable:!0});A["@stencil_op_sfail"]={widget:"combo",values:{KEEP:GL.KEEP,ZERO:GL.ZERO,REPLACE:GL.REPLACE,INCR:GL.INCR,INCR_WRAP:GL.INCR_WRAP,DECR:GL.DECR_WRAP,INVERT:GL.INVERT}};Object.defineProperty(A.prototype,"stencil_op_dpfail",{set:function(a){this._data[22]=a},get:function(){return this._data[22]},enumerable:!0});A["@stencil_op_dpfail"]={widget:"combo",
values:{KEEP:GL.KEEP,ZERO:GL.ZERO,REPLACE:GL.REPLACE,INCR:GL.INCR,INCR_WRAP:GL.INCR_WRAP,DECR:GL.DECR_WRAP,INVERT:GL.INVERT}};Object.defineProperty(A.prototype,"stencil_op_dppass",{set:function(a){this._data[23]=a},get:function(){return this._data[23]},enumerable:!0});Object.defineProperty(A.prototype,"flags",{set:function(a){this._data[24]=a},get:function(){return this._data[24]},enumerable:!0});A["@stencil_op_dppass"]={widget:"combo",values:{KEEP:GL.KEEP,ZERO:GL.ZERO,REPLACE:GL.REPLACE,INCR:GL.INCR,
INCR_WRAP:GL.INCR_WRAP,DECR:GL.DECR_WRAP,INVERT:GL.INVERT}};A.default_state={front_face:GL.CCW,cull_face:!0,depth_test:!0,depth_func:GL.LESS,depth_mask:!0,blend:!1,blendFunc0:GL.SRC_ALPHA,blendFunc1:GL.ONE_MINUS_SRC_ALPHA,colorMask0:!0,colorMask1:!0,colorMask2:!0,colorMask3:!0,stencil_test:!1,stencil_mask:255,stencil_func_func:GL.ALWAYS,stencil_func_ref:0,stencil_func_mask:255,stencil_op_sfail:GL.KEEP,stencil_op_dpfail:GL.KEEP,stencil_op_dppass:GL.KEEP};A.last_state=null;A.prototype.init=function(){this.front_face=
GL.CCW;this.depth_mask=this.depth_test=this.cull_face=!0;this.depth_func=GL.LESS;this.blend=!1;this.blendFunc0=GL.SRC_ALPHA;this.blendFunc1=GL.ONE_MINUS_SRC_ALPHA;this.colorMask3=this.colorMask2=this.colorMask1=this.colorMask0=!0;this.stencil_test=!1;this.stencil_mask=255;this.stencil_func_func=GL.ALWAYS;this.stencil_func_ref=0;this.stencil_func_mask=255;this.stencil_op_dppass=this.stencil_op_dpfail=this.stencil_op_sfail=GL.KEEP;this.flags=0};A.prototype.setBlendMode=function(a){a&&a!=d.Blend.NORMAL?
(this.blend=!0,this.blendFunc0=a[0],this.blendFunc1=a[1]):this.blend=!1};A.prototype.enable=function(a){A.enable(this,null,a)};A.enable=function(a,b,c){var e=a.flags;c=c&&c.force_two_sided?!0:!1;if(b){d.Renderer._reverse_faces?gl.frontFace(a.front_face==GL.CCW?GL.CW:GL.CCW):b.front_face!==a.front_face&&gl.frontFace(a.front_face);if(b.cull_face!==a.cull_face||c)a.cull_face&&!c?gl.enable(gl.CULL_FACE):gl.disable(gl.CULL_FACE);e&A.SKIP_DEPTH||(b.depth_test!==a.depth_test&&(a.depth_test?gl.enable(gl.DEPTH_TEST):
gl.disable(gl.DEPTH_TEST)),b.depth_mask!==a.depth_mask&&gl.depthMask(a.depth_mask),b.depth_func!==a.depth_func&&gl.depthFunc(a.depth_func));e&A.SKIP_BLEND||(b.blend!==a.blend&&(a.blend?gl.enable(gl.BLEND):gl.disable(gl.BLEND)),b.blendFunc0===a.blendFunc0&&b.blendFunc1===a.blendFunc1||gl.blendFunc(a.blendFunc0,a.blendFunc1));b.colorMask0===a.colorMask0&&b.colorMask1===a.colorMask1&&b.colorMask2===a.colorMask2&&b.colorMask3===a.colorMask3||gl.colorMask(a.colorMask0,a.colorMask1,a.colorMask2,a.colorMask3);
e&A.SKIP_STENCIL||(b.stencil_test!=a.stencil_test&&(a.stencil_test?gl.enable(gl.STENCIL_TEST):gl.disable(gl.STENCIL_TEST)),a.stencil_test&&(a.stencil_func_func===b.stencil_func_func&&a.stencil_func_ref===b.stencil_func_ref&&a.stencil_func_mask===b.stencil_func_mask||gl.stencilFunc(a.stencil_func_func,a.stencil_func_ref,a.stencil_func_mask),a.stencil_op_sfail===b.stencil_op_sfail&&a.stencil_op_dpfail===stencil_op_dpfail&&a.stencil_op_dppass===stencil_op_dppass||gl.stencilOp(a.stencil_op_sfail,a.stencil_op_dpfail,
a.stencil_op_dppass),a.stencil_mask!==b.stencil_mask&&gl.stencilMask(b.stencil_mask)))}else d.Renderer._reverse_faces?gl.frontFace(a.front_face==GL.CCW?GL.CW:GL.CCW):gl.frontFace(a.front_face),a.cull_face&&!c?gl.enable(gl.CULL_FACE):gl.disable(gl.CULL_FACE),e&A.SKIP_DEPTH||(a.depth_test?gl.enable(gl.DEPTH_TEST):gl.disable(gl.DEPTH_TEST),gl.depthMask(a.depth_mask),gl.depthFunc(a.depth_func)),e&A.SKIP_BLEND||(a.blend?gl.enable(gl.BLEND):gl.disable(gl.BLEND),gl.blendFunc(a.blendFunc0,a.blendFunc1)),
gl.colorMask(a.colorMask0,a.colorMask1,a.colorMask2,a.colorMask3),e&A.SKIP_STENCIL||(a.stencil_test?(gl.enable(gl.STENCIL_TEST),gl.stencilFunc(a.stencil_func_func,a.stencil_func_ref,a.stencil_func_mask),gl.stencilOp(a.stencil_op_sfail,a.stencil_op_dpfail,a.stencil_op_dppass),gl.stencilMask(a.stencil_mask)):gl.disable(gl.STENCIL_TEST));this.last_state=a};A.reset=function(){this.enable(this.default_state)};A.prototype.serialize=function(){return d.cloneObject(this)};A.prototype.toJSON=A.prototype.serialize;
A.prototype.configure=function(a){d.cloneObject(a,this)};A.prototype.copyFrom=function(a){this._data.set(a._data)};d.RenderState=A;ka.NO_SORT=0;ka.SORT_NEAR_FIRST=1;ka.SORT_FAR_FIRST=2;ka.fast_normalmatrix=!1;ka.prototype.fromNode=function(a,b){if(!a)throw"no node";this.node=a;this.layers=a.layers;b||(a.transform?this.setMatrix(a.transform._global_matrix):this.setMatrix(d.IDENTITY),mat4.multiplyVec3(this.position,this.matrix,d.ZEROS))};ka.prototype.setMatrix=function(a,b){this.matrix.set(a);b?this.normal_matrix.set(b):
this.computeNormalMatrix()};ka.prototype.computeNormalMatrix=function(){if(ka.fast_normalmatrix)this.normal_matrix.set(this.matrix),mat4.setTranslation(this.normal_matrix,d.ZEROS);else{var a=mat4.invert(this.normal_matrix,this.matrix);a&&mat4.transpose(this.normal_matrix,a)}};ka.prototype.applyTransform=function(a,b){mat4.mul(this.matrix,a,this.matrix);b?mat4.mul(this.normal_matrix,b,this.normal_matrix):this.computeNormalMatrix()};ka.prototype.setMaterial=function(a){(!a||a.constructor.is_material)&&
(this.material=a)&&a.applyToRenderInstance&&a.applyToRenderInstance(this)};ka.prototype.setMesh=function(a,b){if(-1==b||void 0===b)b=gl.TRIANGLES;this.primitive=b;a!=this.mesh&&(this.mesh=a,this.vertex_buffers={});if(this.mesh){for(var c in a.vertexBuffers)this.vertex_buffers[c]=a.vertexBuffers[c];switch(b){case gl.TRIANGLES:this.index_buffer=a.indexBuffers.triangles;break;case gl.LINES:this.index_buffer=a.indexBuffers.lines;break;case 10:this.primitive=gl.LINES;a.indexBuffers.wireframe||a.computeWireframe();
this.index_buffer=a.indexBuffers.wireframe;break;default:this.index_buffer=null}a.bounding?(this.oobb.set(a.bounding),this.use_bounding=!0):this.use_bounding=!1}};ka.prototype.setBoundingBox=function(a){this.oobb.set(a)};ka.prototype.setRange=function(a,b){this.range[0]=a;this.range[1]=b};ka.prototype.enableFlag=function(a){this.flags|=a};ka.prototype.disableFlag=function(a){this.flags&=~a};ka.prototype.isFlag=function(a){return this.flags&a};ka.prototype.updateAABB=function(){BBox.transformMat4(this.aabb,
this.oobb,this.matrix)};ka.prototype.update=function(){this.node&&this.node.transform&&this.setMatrix(this.node.transform._global_matrix)};ka.prototype.render=function(a,b){a.attributes.a_normal&&!this.vertex_buffers.normals&&(this.mesh.computeNormals(),this.vertex_buffers.normals=this.mesh.vertexBuffers.normals);a.attributes.a_tangent&&!this.vertex_buffers.tangents&&(this.mesh.computeTangents(),this.vertex_buffers.tangents=this.mesh.vertexBuffers.tangents);a.attributes.a_coord1&&!this.vertex_buffers.coords1&&
(this.mesh.createVertexBuffer("coords1",2,vertex_buffers.coords.data),this.vertex_buffers.coords1=this.mesh.vertexBuffers.coords1);a.attributes.a_normal&&!this.vertex_buffers.normals&&(this.mesh.computeNormals(),this.vertex_buffers.normals=this.mesh.vertexBuffers.normals);a.attributes.a_extra&&!this.vertex_buffers.extra&&(this.mesh.createVertexBuffer("extra","a_extra",1),this.vertex_buffers.extra=this.mesh.vertexBuffers.extra);a.attributes.a_extra2&&!this.vertex_buffers.extra2&&(this.mesh.createVertexBuffer("extra2",
"a_extra2",2),this.vertex_buffers.extra2=this.mesh.vertexBuffers.extra2);a.attributes.a_extra3&&!this.vertex_buffers.extra3&&(this.mesh.createVertexBuffer("extra3","a_extra3",3),this.vertex_buffers.extra3=this.mesh.vertexBuffers.extra3);a.attributes.a_color&&!this.vertex_buffers.colors&&(this.mesh.createVertexBuffer("colors","a_color",4),this.vertex_buffers.colors=this.mesh.vertexBuffers.colors);void 0===b&&(b=this.primitive);var c=!1;!a.supports_drawbuffers&&GL.FBO.current&&1<GL.FBO.current.color_textures.length&&
(c=!0,GL.FBO.current.toSingle());if(this.instanced_models&&this.instanced_models.length)if(a.attributes.u_model)this._instanced_uniforms||(this._instanced_uniforms={}),this._instanced_uniforms.u_model=this.instanced_models,a.drawInstanced(this.mesh,b,this.index_buffer,this._instanced_uniforms,this.range[0],this.range[1],this.instanced_models.length);else for(var e=0;e<this.instanced_models.length;++e)a.setUniform("u_model",this.instanced_models[e]),a.drawBuffers(this.vertex_buffers,this.index_buffer,
b,this.range[0],this.range[1]);else a.drawBuffers(this.vertex_buffers,this.index_buffer,b,this.range[0],this.range[1]);c&&GL.FBO.current.toMulti()};ka.prototype.addShaderBlock=function(a,b){if(!(a.flag_mask&this.shader_block_flags&&void 0===b)){for(var c=0;c<this.shader_blocks.length;++c)if(this.shader_blocks[c]&&this.shader_blocks[c].block==a)return void 0!==b&&(this.shader_blocks[c].uniforms=b),c;this.shader_blocks.push({block:a,uniforms:b});this.shader_block_flags|=a.flag_mask;return this.shader_blocks.length-
1}};ka.prototype.disableShaderBlock=function(a){if(a.flag_mask&this.shader_block_flags)for(var b=0;b<this.shader_blocks.length;++b)if(this.shader_blocks[b]&&this.shader_blocks[b].block===a){this.shader_block_flags&=~a.flag_mask;break}};ka.prototype.removeShaderBlock=function(a){if(a.flag_mask&this.shader_block_flags)for(var b=0;b<this.shader_blocks.length;++b)if(this.shader_blocks[b]&&this.shader_blocks[b].block===a){this.shader_blocks.splice(b,1);this.shader_block_flags&=~a.flag_mask;break}};ka.prototype.computeShaderBlockFlags=
function(){return this.shader_block_flags};ka.prototype.overlapsSphere=function(a,b){return this.use_bounding?geo.testSphereBBox(a,b,this.aabb):!0};ka.prototype.wasVisibleByCamera=function(a){return a?this._camera_visibility|1<<a._rendering_index?!0:!1:0!=this._camera_visibility};d.RenderInstance=ka;Q.current=null;Q.stack=[];Q.DEFAULT_PRECISION=0;Q.LOW_PRECISION=1;Q.MEDIUM_PRECISION=2;Q.HIGH_PRECISION=3;Q.DEFAULT_PRECISION_WEBGL_TYPE=GL.UNSIGNED_BYTE;Q["@width"]={type:"number",step:1,precision:0};
Q["@height"]={type:"number",step:1,precision:0};Q["@precision"]={widget:"combo",values:{"default":Q.DEFAULT_PRECISION,low:Q.LOW_PRECISION,medium:Q.MEDIUM_PRECISION,high:Q.HIGH_PRECISION}};Q["@format"]={widget:"combo",values:{RGB:GL.RGB,RGBA:GL.RGBA}};Q["@num_extra_textures"]={type:"number",step:1,min:0,max:4,precision:0};Q["@name"]={type:"string"};Q.prototype.clear=function(){if(this.name){for(var a=0;a<this._textures.length;++a)delete d.ResourcesManager.textures[this.name+(1<a?a:"")];this._depth_texture&&
delete d.ResourcesManager.textures[this.name+"_depth"]}this._fbo=null;this._textures=[];this._depth_textures=this._color_texture=null};Q.prototype.configure=function(a){this.width=a.width||0;this.height=a.height||0;this.format=a.format||GL.RGBA;this.precision=a.precision||0;this.filter_texture=!!a.filter_texture;this.adjust_aspect=!!a.adjust_aspect;this.use_depth_texture=!!a.use_depth_texture;this.use_stencil_buffer=!!a.use_stencil_buffer;this.num_extra_textures=a.num_extra_textures||0;this.name=
a.name;this.clone_after_unbind=!!a.clone_after_unbind};Q.prototype.serialize=function(){return{width:this.width,height:this.height,filter_texture:this.filter_texture,precision:this.precision,format:this.format,adjust_aspect:this.adjust_aspect,use_depth_texture:this.use_depth_texture,use_stencil_buffer:this.use_stencil_buffer,num_extra_textures:this.num_extra_textures,clone_after_unbind:this.clone_after_unbind,name:this.name}};Q.prototype.prepare=function(a,b){var c=this.width,e=this.height;0==c?c=
a:0>c&&(c=a>>Math.abs(this.width));0==e?e=b:0>e&&(e=b>>Math.abs(this.height));var d=this.format,f=this.filter_texture?gl.LINEAR:gl.NEAREST,h=0,k=gl.LINEAR;this.generate_mipmaps&&GL.isPowerOfTwo(c)&&GL.isPowerOfTwo(e)&&(k=gl.LINEAR_MIPMAP_LINEAR);this._minFilter=k;switch(this.precision){case Q.LOW_PRECISION:h=gl.UNSIGNED_BYTE;break;case Q.MEDIUM_PRECISION:h=gl.HIGH_PRECISION_FORMAT;break;case Q.HIGH_PRECISION:h=gl.FLOAT;break;case Q.DEFAULT_PRECISION:h=Q.DEFAULT_PRECISION_WEBGL_TYPE;break;default:h=
this.precision}h!=GL.HALF_FLOAT_OES||GL.FBO.testSupport(h,d)||(d=gl.RGBA);h!=GL.HALF_FLOAT_OES||GL.FBO.testSupport(h,d)||(h=gl.FLOAT);var l=this._textures;this._color_texture&&this._color_texture.width==c&&this._color_texture.height==e&&this._color_texture.type==h&&this._color_texture.format==d&&this._color_texture.minFilter==k?this._color_texture.setParameter(gl.TEXTURE_MAG_FILTER,f):this._color_texture=new GL.Texture(c,e,{minFilter:k,magFilter:f,format:d,type:h});l[0]=this._color_texture;var m=
Math.min(this.num_extra_textures,4);1!=gl.webgl_version||gl.extensions.WEBGL_draw_buffers||(m=0);for(var p=0;p<m;++p){var n=l[1+p];n&&n.width==c&&n.height==e&&n.type==h&&n.format==d&&n.minFilter==k?n.setParameter(gl.TEXTURE_MAG_FILTER,f):n=new GL.Texture(c,e,{minFilter:k,magFilter:f,format:d,type:h});l[1+p]=n}d=gl.DEPTH_COMPONENT;f=gl.UNSIGNED_INT;this.use_stencil_buffer&&gl.extensions.WEBGL_depth_texture&&(d=gl.DEPTH_STENCIL,f=gl.extensions.WEBGL_depth_texture.UNSIGNED_INT_24_8_WEBGL);!this.use_depth_texture||
this._depth_texture&&this._depth_texture.width==c&&this._depth_texture.height==e&&this._depth_texture.format==d&&this._depth_texture.type==f||!gl.extensions.WEBGL_depth_texture?this.use_depth_texture||(this._depth_texture=null):this._depth_texture=new GL.Texture(c,e,{filter:gl.NEAREST,format:d,type:f});this._depth_texture&&!this._depth_texture.near_far_planes&&(this._depth_texture.near_far_planes=vec2.create());this._fbo||(this._fbo=new GL.FBO);l.length=1+m;this._fbo.stencil=this.use_stencil_buffer;
this._fbo.setTextures(l,this._depth_texture);this._version+=1};Q.prototype.enable=function(a,b,c){b=b||gl.viewport_data;this.prepare(b[2],b[3]);if(!this._fbo)throw"No FBO created in RenderFrameContext";Q.enableFBO(this._fbo,this.adjust_aspect);d.RenderFrameContext.current&&Q.stack.push(d.RenderFrameContext.current);d.RenderFrameContext.current=this;c=c||d.Renderer._current_camera;this._depth_texture&&c&&(this._depth_texture.near_far_planes[0]=c.near,this._depth_texture.near_far_planes[1]=c.far)};
Q.prototype.cloneBuffers=function(){gl.bindFramebuffer(gl.FRAMEBUFFER,null);if(this._textures.length){this._cloned_textures||(this._cloned_textures=[]);var a=this._textures;this._cloned_textures.length=a.length;for(var b=0;b<a.length;++b){var c=a[b],e=this._cloned_textures[b];e&&e.hasSameSize(c)&&e.hasSameProperties(c)||(e=this._cloned_textures[b]=new GL.Texture(c.width,c.height,c.getProperties()));c.copyTo(e);0==b&&(d.ResourcesManager.textures[":color_buffer"]=e)}}this._depth_texture&&(a=this._depth_texture,
this._cloned_depth_texture&&this._cloned_depth_texture.width==a.width&&this._cloned_depth_texture.height==a.height&&this._cloned_depth_texture.hasSameProperties(a)||(this._cloned_depth_texture=new GL.Texture(a.width,a.height,a.getProperties())),a.copyTo(this._cloned_depth_texture),this._cloned_depth_texture.near_far_planes||(this._cloned_depth_texture.near_far_planes=vec2.create()),this._cloned_depth_texture.near_far_planes.set(a.near_far_planes),d.ResourcesManager.textures[":depth_buffer"]=this._cloned_depth_texture);
gl.bindFramebuffer(gl.FRAMEBUFFER,this._fbo.handler)};Q.prototype.disable=function(){Q.disableFBO(this._fbo);if(this.name){for(var a=this._textures,b=0;b<a.length;++b){var c=this.name+(0<b?b:"");a[b].filename=c;var e=a[b];this.clone_after_unbind&&0===b&&(this._cloned_texture&&this._cloned_texture.width===e.width&&this._cloned_texture.height===e.height&&this._cloned_texture.type===e.type?e.copyTo(this._cloned_texture):this._cloned_texture=e.clone(),e=this._cloned_texture);this._minFilter==gl.LINEAR_MIPMAP_LINEAR&&
(e.bind(0),gl.generateMipmap(gl.TEXTURE_2D),e.has_mipmaps=!0);d.ResourcesManager.textures[c]=e}this._depth_texture&&(c=this.name+"_depth",a=this._depth_texture,this.clone_after_unbind&&(this._cloned_depth_texture&&this._cloned_depth_texture.width===a.width&&this._cloned_depth_texture.height===a.height&&this._cloned_depth_texture.type===a.type?a.copyTo(this._cloned_depth_texture):this._cloned_depth_texture=a.clone(),this._cloned_depth_texture.near_far_planes||(this._cloned_depth_texture.near_far_planes=
vec2.create()),this._cloned_depth_texture.near_far_planes.set(a.near_far_planes),a=this._cloned_depth_texture),a.filename=c,d.ResourcesManager.textures[c]=a)}d.RenderFrameContext.current=Q.stack.length?Q.stack.pop():null};Q.prototype.getColorTexture=function(a){return this._textures[a||0]||null};Q.prototype.getDepthTexture=function(){return this._depth_texture||null};Q.prototype.clearTextures=function(){for(var a=0;a<this._textures.length;++a){var b=this._textures[a];b&&b.fill([0,0,0,0])}};Q.enableFBO=
function(a,b){a.bind(!0);d.Renderer._full_viewport.set(gl.viewport_data);b?(a._old_aspect=d.Renderer.global_aspect,d.Renderer.global_aspect=gl.canvas.width/gl.canvas.height/(a.color_textures[0].width/a.color_textures[0].height)):delete a._old_aspect};Q.disableFBO=function(a){a.unbind();d.Renderer._full_viewport.set(a._old_viewport);a._old_aspect&&(d.Renderer.global_aspect=a._old_aspect)};Q.prototype.show=function(a){var b=this._color_texture;if(a){a=gl.getViewport();var c=GL.Shader.getFXAAShader(),
e=GL.Mesh.getScreenQuad();b.bind(0);c.uniforms({u_texture:0,uViewportSize:a.subarray(2,4),u_iViewportSize:[1/b.width,1/b.height]}).draw(e)}else b.toViewport()};Q.reset=function(){gl.bindFramebuffer(gl.FRAMEBUFFER,null);d.RenderFrameContext.current=null;d.RenderFrameContext.stack.length=0};d.RenderFrameContext=Q;pa.readback_allowed=!0;pa.prototype.sort=function(){if(this.instances.length){var a=null;switch(this.sort_mode){case 1:a=d.RenderQueue.sort_near_to_far_func;break;case 2:a=d.RenderQueue.sort_far_to_near_func;
break;case 3:a=d.RenderQueue.sort_by_priority_func}a&&this.instances.sort(a)}};pa.prototype.add=function(a){this.instances.push(a)};pa.prototype.clear=function(){this.instances.length=0};pa.prototype.start=function(a,b){if(this.onStart&&!1===this.onStart(a,b))return!1;this.instances.length&&this.must_clone_buffers&&pa.readback_allowed&&a===d.COLOR_PASS&&d.RenderFrameContext.current&&d.RenderFrameContext.current.cloneBuffers()};pa.prototype.finish=function(a){if(this.onFinish)this.onFinish(a,render_settings)};
pa.AUTO=-1;pa.BACKGROUND=5;pa.GEOMETRY=35;pa.TRANSPARENT=75;pa.READBACK_COLOR=95;pa.OVERLAY=115;pa.NO_SORT=0;pa.SORT_NEAR_TO_FAR=1;pa.SORT_FAR_TO_NEAR=2;pa.SORT_BY_PRIORITY=3;pa.sort_far_to_near_func=function(a,b){return b._dist-a._dist};pa.sort_near_to_far_func=function(a,b){return a._dist-b._dist};pa.sort_by_priority_func=function(a,b){return b.priority-a.priority};pa.sort_by_priority_and_near_to_far_func=function(a,b){var c=b.priority-a.priority;return c?c:a._dist-b._dist};pa.sort_by_priority_and_far_to_near_func=
function(a,b){var c=b.priority-a.priority;return c?c:b._dist-a._dist};d.RenderQueue=pa;var xb=d.COLOR_PASS={name:"color",id:1},kc=d.SHADOW_PASS={name:"shadow",id:2},rc=d.PICKING_PASS={name:"picking",id:3};q.BEFORE_RENDER="beforeRender";q.READY_TO_RENDER="readyToRender";q.RENDER_SHADOWS="renderShadows";q.AFTER_VISIBILITY="afterVisibility";q.RENDER_REFLECTIONS="renderReflections";q.BEFORE_RENDER_MAIN_PASS="beforeRenderMainPass";q.ENABLE_FRAME_CONTEXT="enableFrameContext";q.SHOW_FRAME_CONTEXT="showFrameContext";
q.AFTER_RENDER="afterRender";q.BEFORE_RENDER_FRAME="beforeRenderFrame";q.BEFORE_RENDER_SCENE="beforeRenderScene";q.COMPUTE_VISIBILITY="computeVisibility";q.AFTER_RENDER_FRAME="afterRenderFrame";q.AFTER_RENDER_SCENE="afterRenderScene";q.RENDER_HELPERS="renderHelpers";q.RENDER_PICKING="renderPicking";q.BEFORE_SHOW_FRAME_CONTEXT="beforeShowFrameContext";q.BEFORE_CAMERA_ENABLED="beforeCameraEnabled";q.AFTER_CAMERA_ENABLED="afterCameraEnabled";q.BEFORE_RENDER_INSTANCES="beforeRenderInstances";q.RENDER_INSTANCES=
"renderInstances";q.RENDER_SCREEN_SPACE="renderScreenSpace";q.AFTER_RENDER_INSTANCES="afterRenderInstances";q.RENDER_GUI="renderGUI";q.FILL_SCENE_UNIFORMS="fillSceneUniforms";q.AFTER_COLLECT_DATA="afterCollectData";q.PREPARE_MATERIALS="prepareMaterials";var Lc={default_render_settings:new d.RenderSettings,default_material:new d.StandardMaterial,global_aspect:1,default_point_size:1,render_profiler:!1,_global_viewport:vec4.create(),_full_viewport:vec4.create(),_current_scene:null,_current_render_settings:null,
_current_camera:null,_current_target:null,_current_pass:xb,_current_layers_filter:65535,_global_textures:{},_global_shader_blocks:[],_global_shader_blocks_flags:0,_reverse_faces:!1,_in_player:!0,_queues:[],_main_camera:null,_visible_cameras:null,_active_lights:null,_visible_instances:null,_visible_materials:[],_near_lights:[],_active_samples:[],_frame_time:0,_frame_cpu_time:0,_rendercalls:0,_rendered_instances:0,_rendered_passes:0,_frame:0,_last_time:0,gpu_times:{total:0,shadows:0,reflections:0,main:0,
postpo:0,gui:0},timer_queries_enabled:!0,_timer_queries:{},_waiting_queries:!1,_collect_frequency:1,_view_matrix:mat4.create(),_projection_matrix:mat4.create(),_viewprojection_matrix:mat4.create(),_2Dviewprojection_matrix:mat4.create(),_temp_matrix:mat4.create(),_temp_cameye:vec3.create(),_identity_matrix:mat4.create(),_uniforms:{},_samplers:[],_instancing_data:[],_is_rendering_frame:!1,_ignore_reflection_probes:!1,allow_textures:!0,_sphere_mesh:null,_debug_instance:null,SHADOWMAP_TEXTURE_SLOT:7,
ENVIRONMENT_TEXTURE_SLOT:6,IRRADIANCE_TEXTURE_SLOT:5,LIGHTPROJECTOR_TEXTURE_SLOT:4,LIGHTEXTRA_TEXTURE_SLOT:3,BONES_TEXTURE_SLOT:3,MORPHS_TEXTURE_SLOT:2,MORPHS_TEXTURE2_SLOT:1,init:function(){this._black_texture=new GL.Texture(1,1,{pixel_data:[0,0,0,255]});this._gray_texture=new GL.Texture(1,1,{pixel_data:[128,128,128,255]});this._white_texture=new GL.Texture(1,1,{pixel_data:[255,255,255,255]});this._normal_texture=new GL.Texture(1,1,{pixel_data:[128,128,255,255]});this._white_cubemap_texture=new GL.Texture(1,
1,{texture_type:gl.TEXTURE_CUBE_MAP,pixel_data:(new Uint8Array(24)).fill(255)});this._missing_texture=this._gray_texture;[this._black_texture,this._gray_texture,this._white_texture,this._normal_texture,this._missing_texture].forEach(function(a){a._is_internal=!0});d.ResourcesManager.textures[":black"]=this._black_texture;d.ResourcesManager.textures[":gray"]=this._gray_texture;d.ResourcesManager.textures[":white"]=this._white_texture;d.ResourcesManager.textures[":flatnormal"]=this._normal_texture;
this._sphere_mesh=GL.Mesh.sphere({size:1,detail:32});d.Draw&&(d.Draw.init(),d.Draw.onRequestFrame=function(){d.GlobalScene.requestFrame()});ba.enableWebGLCanvas&&!gl.canvas.canvas2DtoWebGL_enabled&&ba.enableWebGLCanvas(gl.canvas);var a=this._max_texture_units=gl.getParameter(gl.MAX_TEXTURE_IMAGE_UNITS);this.SHADOWMAP_TEXTURE_SLOT=a-2;this.ENVIRONMENT_TEXTURE_SLOT=a-3;this.IRRADIANCE_TEXTURE_SLOT=a-4;this.BONES_TEXTURE_SLOT=a-5;this.MORPHS_TEXTURE_SLOT=a-6;this.MORPHS_TEXTURE2_SLOT=a-7;this.LIGHTPROJECTOR_TEXTURE_SLOT=
a-8;this.LIGHTEXTRA_TEXTURE_SLOT=a-9;this._active_samples.length=a;this.createRenderQueues();this._full_viewport.set([0,0,gl.drawingBufferWidth,gl.drawingBufferHeight]);this._uniforms.u_viewport=gl.viewport_data;this._uniforms.environment_texture=this.ENVIRONMENT_TEXTURE_SLOT;this._uniforms.u_clipping_plane=vec4.create()},reset:function(){},resetState:function(){this._reverse_faces=this._is_rendering_frame=!1},setFullViewport:function(a,b,c,e){0==arguments.length?(this._full_viewport[0]=this._full_viewport[1]=
0,this._full_viewport[2]=gl.drawingBufferWidth,this._full_viewport[3]=gl.drawingBufferHeight):a.constructor===Number?(this._full_viewport[0]=a,this._full_viewport[1]=b,this._full_viewport[2]=c,this._full_viewport[3]=e):a.length&&this._full_viewport.set(a)},render:function(a,b,c){a=a||d.GlobalScene;if(this._is_rendering_frame)console.error("Last frame didn't finish and a new one was issued. Remember that you cannot call ONE.Renderer.render from an event dispatched during the render, this would cause a recursive loop. Call ONE.Renderer.reset() to clear from an error.");
else{this._is_rendering_frame=!0;this._current_render_settings=b=b||this.default_render_settings;this._current_scene=a;this._main_camera=c?c[0]:null;a._frame+=1;this._frame+=1;a._must_redraw=!1;var e=getTime();this._frame_time=e-this._last_time;this._last_time=e;this._rendered_passes=this._rendered_instances=this._rendercalls=0;this._global_shader_blocks_flags=this._global_shader_blocks.length=0;for(var g in this._global_textures)this._global_textures[g]=null;this._current_pass||(this._current_pass=
xb);this._reverse_faces=!1;this.resolveQueries();b.ignore_reset||d.RenderFrameContext.reset();gl.canvas.canvas2DtoWebGL_enabled&&gl.resetTransform();d.GUI.ResetImmediateGUI(!0);b.keep_viewport?this.setFullViewport(gl.viewport_data):(gl.viewport(0,0,gl.drawingBufferWidth,gl.drawingBufferHeight),this.setFullViewport(0,0,gl.drawingBufferWidth,gl.drawingBufferHeight));this._global_viewport.set(gl.viewport_data);this.startGPUQuery("beforeRender");LEvent.trigger(a,q.BEFORE_RENDER,b);this.endGPUQuery();
this.processVisibleData(a,b,c);c=c&&c.length?c:a._cameras;if(0==c.length)throw"no cameras";this._visible_cameras=c;this._main_camera=c[0];LEvent.trigger(a,q.READY_TO_RENDER,b);this.startGPUQuery("shadows");LEvent.trigger(a,q.RENDER_SHADOWS,b);this.endGPUQuery();LEvent.trigger(a,q.AFTER_VISIBILITY,b);this.startGPUQuery("reflections");LEvent.trigger(a,q.RENDER_REFLECTIONS,b);this.endGPUQuery();LEvent.trigger(a,q.BEFORE_RENDER_MAIN_PASS,b);b.render_fx&&LEvent.trigger(a,q.ENABLE_FRAME_CONTEXT,b);if(this.onCustomRenderFrameCameras)this.onCustomRenderFrameCameras(c,
b);else this.renderFrameCameras(c,b);b.keep_viewport&&gl.setViewport(this._global_viewport);b.render_fx&&(this.startGPUQuery("postpo"),LEvent.trigger(a,q.SHOW_FRAME_CONTEXT,b),this.endGPUQuery());this.startGPUQuery("gui");this.renderGUI(b);this.endGPUQuery();this._frame_cpu_time=getTime()-e;d.Draw&&(this._rendercalls+=d.Draw._rendercalls);d.Draw._rendercalls=0;LEvent.trigger(a,q.AFTER_RENDER,b);this._is_rendering_frame=!1;d.triggerCoroutines("render");this.render_profiler&&this.renderProfiler()}},
renderFrameCameras:function(a,b){for(var c=this._current_scene,e=0;e<a.length;++e){var d=a[e];LEvent.trigger(c,q.BEFORE_RENDER_FRAME,b);LEvent.trigger(d,q.BEFORE_RENDER_FRAME,b);LEvent.trigger(d,q.ENABLE_FRAME_CONTEXT,b);this.startGPUQuery("main");if(this.onCustomRenderFrame)this.onCustomRenderFrame(d,b);else this.renderFrame(d,b);this.endGPUQuery();this.startGPUQuery("postpo");LEvent.trigger(d,q.SHOW_FRAME_CONTEXT,b);LEvent.trigger(d,q.AFTER_RENDER_FRAME,b);LEvent.trigger(c,q.AFTER_RENDER_FRAME,
b);this.endGPUQuery()}},renderFrame:function(a,b,c){b=b||this.default_render_settings;c&&(c._frame++,this.processVisibleData(c,b));this._current_scene=c=c||this._current_scene;this.enableCamera(a,b,b.skip_viewport,c);this.clearBuffer(a,b);LEvent.trigger(c,q.BEFORE_RENDER_SCENE,a);LEvent.trigger(this,q.BEFORE_RENDER_SCENE,a);LEvent.trigger(this,q.COMPUTE_VISIBILITY,this._visible_instances);if(this.onCustomRenderInstances)this.onCustomRenderInstances(b,this._visible_instances);else this.renderInstances(b,
this._visible_instances);LEvent.trigger(c,q.AFTER_RENDER_SCENE,a);LEvent.trigger(this,q.AFTER_RENDER_SCENE,a);if(this.onRenderScene)this.onRenderScene(a,b,c);b.render_helpers&&(GL.FBO.current&&GL.FBO.current.toSingle(),LEvent.trigger(this,q.RENDER_HELPERS,a),LEvent.trigger(c,q.RENDER_HELPERS,a),GL.FBO.current&&GL.FBO.current.toMulti())},showRenderFrameContext:function(a,b){LEvent.trigger(this,q.BEFORE_SHOW_FRAME_CONTEXT,a);a.show()},enableCamera:function(a,b,c,e){e=e||this._current_scene||d.GlobalScene;
LEvent.trigger(a,q.BEFORE_CAMERA_ENABLED,b);LEvent.trigger(e,q.BEFORE_CAMERA_ENABLED,a);var g=this._full_viewport[0],f=this._full_viewport[1],h=this._full_viewport[2],k=this._full_viewport[3];0==h&&0==k&&(console.warn("enableCamera: full viewport was 0, assigning to full viewport"),h=gl.viewport_data[2],k=gl.viewport_data[3]);var g=Math.floor(h*a._viewport[0]+g),f=Math.floor(k*a._viewport[1]+f),l=Math.ceil(h*a._viewport[2]),m=Math.ceil(k*a._viewport[3]);c||(b&&b.ignore_viewports?(a.final_aspect=h/
k*a._aspect*this.global_aspect,gl.viewport(this._full_viewport[0],this._full_viewport[1],this._full_viewport[2],this._full_viewport[3])):(a.final_aspect=l/m*a._aspect*this.global_aspect,gl.viewport(g,f,l,m)));a._last_viewport_in_pixels.set(gl.viewport_data);a.updateMatrices();mat4.copy(this._view_matrix,a._view_matrix);mat4.copy(this._projection_matrix,a._projection_matrix);mat4.copy(this._viewprojection_matrix,a._viewprojection_matrix);for(c=0;16>c;++c)isNaN(this._viewprojection_matrix[c])&&console.warn("warning: viewprojection matrix contains NaN when enableCamera is used");
mat4.ortho(this._2Dviewprojection_matrix,-1,1,-1,1,1,-1);this._current_camera=a;d.Camera.current=a;this._current_layers_filter=b?a.layers&b.layers:a.layers;d.Draw&&(d.Draw.reset(),d.Draw.setCamera(a));LEvent.trigger(a,q.AFTER_CAMERA_ENABLED,b);LEvent.trigger(e,q.AFTER_CAMERA_ENABLED,a)},getCurrentCamera:function(){return this._current_camera},clearBuffer:function(a,b){b.ignore_clear||!a.clear_color&&!a.clear_depth||(gl.scissor(gl.viewport_data[0],gl.viewport_data[1],gl.viewport_data[2],gl.viewport_data[3]),
gl.enable(gl.SCISSOR_TEST),gl.colorMask(!0,!0,!0,!0),gl.clearColor(a.background_color[0],a.background_color[1],a.background_color[2],a.background_color[3]),gl.depthMask(!0),gl.enable(gl.STENCIL_TEST),gl.clearStencil(0),GL.FBO.current&&GL.FBO.current.toSingle(),gl.clear((a.clear_color?gl.COLOR_BUFFER_BIT:0)|(a.clear_depth?gl.DEPTH_BUFFER_BIT:0)|gl.STENCIL_BUFFER_BIT),GL.FBO.current&&GL.FBO.current.toMulti(),GL.FBO.current&&GL.FBO.current.clearSecondary(d.ZEROS4),gl.disable(gl.SCISSOR_TEST),gl.disable(gl.STENCIL_TEST))},
createRenderQueues:function(){this._queues.length=0;this._renderqueue_background=this.addRenderQueue(new d.RenderQueue(d.RenderQueue.BACKGROUND,d.RenderQueue.NO_SORT,{name:"BACKGROUND"}));this._renderqueue_geometry=this.addRenderQueue(new d.RenderQueue(d.RenderQueue.GEOMETRY,d.RenderQueue.SORT_NEAR_TO_FAR,{name:"GEOMETRY"}));this._renderqueue_transparent=this.addRenderQueue(new d.RenderQueue(d.RenderQueue.TRANSPARENT,d.RenderQueue.SORT_FAR_TO_NEAR,{name:"TRANSPARENT"}));this._renderqueue_readback=
this.addRenderQueue(new d.RenderQueue(d.RenderQueue.READBACK_COLOR,d.RenderQueue.SORT_FAR_TO_NEAR,{must_clone_buffers:!0,name:"READBACK"}));this._renderqueue_overlay=this.addRenderQueue(new d.RenderQueue(d.RenderQueue.OVERLAY,d.RenderQueue.SORT_BY_PRIORITY,{name:"OVERLAY"}))},addRenderQueue:function(a){var b=Math.floor(0.1*a.value);this._queues[b]&&console.warn("Overwritting render queue:",a.name);return this._queues[b]=a},updateRenderQueues:function(a,b){for(var c=a.getEye(this._temp_cameye),e=0,
d=b.length;e<d;++e){var f=b[e];f&&(f._dist=vec3.dist(f.center,c))}c=this._queues;for(e=0;e<c.length;++e)c[e]&&c[e].clear();e=0;for(d=b.length;e<d;++e)(f=b[e])&&f.material&&f._is_visible&&this.addInstanceToQueue(f);e=0;for(d=c.length;e<d;++e)(f=c[e])&&f.sort_mode&&f.instances.length&&f.sort()},addInstanceToQueue:function(a){var b=this._queues,c=null,e=-1;a.material.queue==pa.AUTO||null==a.material.queue?c=a.material._render_state.blend?this._renderqueue_transparent:this._renderqueue_geometry:(e=Math.floor(0.1*
a.material.queue),c=b[e]);c||(c=new d.RenderQueue(10*e+5,d.RenderQueue.NO_SORT),b[e]=c);c&&c.add(a);return c},resetGLState:function(a){gl.enable(gl.CULL_FACE);gl.frontFace(gl.CCW);gl.colorMask(!0,!0,!0,!0);gl.enable(gl.DEPTH_TEST);gl.depthFunc(gl.LESS);gl.depthMask(!0);gl.disable(gl.BLEND);gl.blendFunc(gl.SRC_ALPHA,gl.ONE_MINUS_SRC_ALPHA);gl.disable(gl.STENCIL_TEST);gl.stencilMask(255);gl.stencilOp(gl.KEEP,gl.KEEP,gl.KEEP);gl.stencilFunc(gl.ALWAYS,1,255)},renderInstances:function(a,b,c){c=c||this._current_scene;
if(!c)return console.warn("ONE.Renderer.renderInstances: no scene found in ONE.Renderer._current_scene"),0;this._rendered_passes+=1;var e=this._current_pass,d=this._current_camera,f=-1!=d._rendering_index?1<<d._rendering_index:0,h=a.frustum_culling,k=d.updateFrustumPlanes(),l=this._current_layers_filter=d.layers&a.layers;this._uniforms.u_viewport=gl.viewport_data;LEvent.trigger(c,q.BEFORE_RENDER_INSTANCES,a);this.resetGLState(a);LEvent.trigger(c,q.RENDER_INSTANCES,a);LEvent.trigger(this,q.RENDER_INSTANCES,
a);this.resetGLState(a);b=b||this._visible_instances;this.bindSamplers(this._samplers);for(var m=0,p=b.length;m<p;++m){var n=b[m],r=n.node.flags;n._is_visible=!1;e==kc&&!n.material.flags.cast_shadows||e==rc&&!1===r.selectable||0===(l&n.layers)||n.onPreRender&&!1===n.onPreRender(a)||!n.material||(r=d._overwrite_material||n.material,0>=r.opacity||h&&n.use_bounding&&!r.flags.ignore_frustum&&geo.frustumTestBox(k,n.aabb)==CLIP_OUTSIDE||(n._is_visible=!0,f&&(n._camera_visibility|=f)))}this.updateRenderQueues(d,
b,a);f=this._rendered_instances;h=this._debug_instance;for(k=0;k<this._queues.length;++k)if((l=this._queues[k])&&l.instances.length&&l.enabled&&!1!=l.start(e,a)){b=l.instances;m=0;for(p=b.length;m<p;++m){n=b[m];if(n==h){console.log(h);debugger}if(n._is_visible&&n.mesh){this._rendered_instances+=1;r=d._overwrite_material||n.material;if(e==rc&&r.renderPickingInstance)r.renderPickingInstance(n,a,e);else if(r.renderInstance)r.renderInstance(n,a,e);else continue;if(n.onPostRender)n.onPostRender(a)}}l.finish(e,
a)}this.resetGLState(a);LEvent.trigger(c,q.RENDER_SCREEN_SPACE,a);this.resetGLState(a);LEvent.trigger(c,q.AFTER_RENDER_INSTANCES,a);LEvent.trigger(this,q.AFTER_RENDER_INSTANCES,a);this.resetGLState(a);return this._rendered_instances-f},renderGUI:function(a){gl.viewport(this._full_viewport[0],this._full_viewport[1],this._full_viewport[2],this._full_viewport[3]);gl.start2D&&gl.start2D();a.render_gui&&LEvent.hasBind(this._current_scene,q.RENDER_GUI)&&(d.GUI&&d.GUI.ResetImmediateGUI(),LEvent.trigger(this._current_scene,
q.RENDER_GUI,gl));if(this.on_render_gui)this.on_render_gui(a);gl.finish2D&&gl.finish2D()},getNearLights:function(a,b){b=b||[];b.length=0;var c=this._active_lights;if(!c||!c.length)return b;b.length=0;for(var e=c.length,d=0;d<e;d++){var f=c[d];if(0!=(f.illuminated_layers&a.layers)&&0!=(f.illuminated_layers&this._current_camera.layers)&&!(1E-4>f.computeLightIntensity())){var h=f.computeLightRadius(),k=f.position;(-1==h||a.overlapsSphere(k,h))&&b.push(f)}}return b},regenerateShadowmaps:function(a,b){a=
a||this._current_scene;b=b||this.default_render_settings;LEvent.trigger(a,q.RENDER_SHADOWS,b);for(var c=0;c<this._active_lights.length;++c){var e=this._active_lights[c];e.prepare(b);e.onGenerateShadowmap()}},mergeSamplers:function(a,b){b=b||[];b.length=this._max_texture_units;for(var c=0;c<b.length;++c)for(var e=a.length-1;0<=e;--e)if(a[e][c]){b[c]=a[e][c];break}return b},clearSamplers:function(){for(var a=0;a<this._max_texture_units;++a)gl.activeTexture(gl.TEXTURE0+a),gl.bindTexture(gl.TEXTURE_2D,
null),gl.bindTexture(gl.TEXTURE_CUBE_MAP,null),this._active_samples[a]=null},bindSamplers:function(a){if(a)for(var b=this.allow_textures,c=0;c<a.length;++c){var e=a[c];if(e){var g=null;e.constructor===String||e.constructor===GL.Texture?(g=e,e=null):e.texture&&(g=e.texture);g&&g.constructor===String&&(g=d.ResourcesManager.textures[g]);b||(g=null);if(!g)if(e)switch(e.missing){case "black":g=this._black_texture;break;case "white":g=this._white_texture;break;case "gray":g=this._gray_texture;break;case "normal":g=
this._normal_texture;break;case "cubemap":g=this._white_cubemap_texture;break;default:g=e.is_cubemap?this._white_cubemap_texture:this._missing_texture}else g=this._missing_texture;g._in_current_fbo&&(g=this._missing_texture);g.bind(c);this._active_samples[c]=g;e&&(e.minFilter&&(e.minFilter!==gl.LINEAR_MIPMAP_LINEAR||GL.isPowerOfTwo(g.width)&&GL.isPowerOfTwo(g.height))&&gl.texParameteri(g.texture_type,gl.TEXTURE_MIN_FILTER,e.minFilter),e.magFilter&&gl.texParameteri(g.texture_type,gl.TEXTURE_MAG_FILTER,
e.magFilter),e.wrap&&(gl.texParameteri(g.texture_type,gl.TEXTURE_WRAP_S,e.wrap),gl.texParameteri(g.texture_type,gl.TEXTURE_WRAP_T,e.wrap)),null!=e.anisotropic&&gl.extensions.EXT_texture_filter_anisotropic&&gl.texParameteri(g.texture_type,gl.extensions.EXT_texture_filter_anisotropic.TEXTURE_MAX_ANISOTROPY_EXT,e.anisotropic))}}},fillSceneUniforms:function(a,b){var c=a._uniforms;c.u_time=a._time||0.001*getTime();c.u_ambient_light=a.info?a.info.ambient_color:vec3.create();this._samplers.length=0;this._global_textures.environment=
null;if(a.info)for(var e in a.info.textures)if(c=d.getTexture(a.info.textures[e])){var g=0;if("environment"==e){var g=d.Renderer.ENVIRONMENT_TEXTURE_SLOT,f=c.texture_type==gl.TEXTURE_2D?"_texture":"_cubemap";c.texture_type==gl.TEXTURE_2D&&(c.bind(0),c.setParameter(gl.TEXTURE_MIN_FILTER,gl.LINEAR));this._samplers[g]=c;a._uniforms[e+"_texture"]=g;a._uniforms[e+f]=g;"environment"==e&&(this._global_textures.environment=c)}}LEvent.trigger(a,q.FILL_SCENE_UNIFORMS,a._uniforms)},processVisibleData:function(a,
b,c,e,g){e=e||a._instances;this._current_scene=a;this.fillSceneUniforms(a,b);g||(0==this._frame%this._collect_frequency&&a.collectData(c),LEvent.trigger(a,q.AFTER_COLLECT_DATA,a));c=c&&c.length?c:a._cameras;if(0==c.length)console.error("no cameras found");else{g=this._visible_materials;for(var f=g.length=0,h=c.length;f<h;++f){var k=c[f];k._rendering_index=f;k.prepare();if(k.overwrite_material){var l=k.overwrite_material.constructor===String?d.ResourcesManager.resources[k.overwrite_material]:k.overwrite_material;
l&&(k._overwrite_material=l,g.push(l))}else k._overwrite_material=null}this._main_camera||(this._main_camera=c.length?c[0]:new d.Camera);a.findNearestReflectionProbe(this._main_camera.getEye());this.processRenderInstances(e,g,a,b);this._visible_instances=a._instances;this._active_lights=a._lights;this._visible_cameras=c;f=0;for(h=this._active_lights.length;f<h;++f)this._active_lights[f].prepare(b);LEvent.trigger(a,q.AFTER_COLLECT_DATA,a)}},processRenderInstances:function(a,b,c,e){b=b||this._visible_materials;
var d=c._frame;e=e||this._current_render_settings;for(var f=0,h=a.length;f<h;++f){var k=a[f];k&&(k.mesh?(k.material||(k.material=this.default_material),k.material._last_frame_update!=d&&(k.material._last_frame_update=d,b.push(k.material)),k._dist=0,k._nearest_reflection_probe=c._reflection_probes.length&&!this._ignore_reflection_probes?c.findNearestReflectionProbe(k.center):null,e.force_wireframe&&k.primitive!=gl.LINES&&(k.primitive=gl.LINES,k.mesh&&(k.mesh.indexBuffers.wireframe||k.mesh.computeWireframe(),
k.index_buffer=k.mesh.indexBuffers.wireframe)),k._camera_visibility=0,k.index=f):console.warn("RenderInstance must always have mesh"))}for(f=0;f<b.length;++f)a=b[f],a._index=f,a.prepare&&a.prepare(c);LEvent.trigger(c,q.PREPARE_MATERIALS)},renderInstancesToRT:function(a,b,c,e){function g(){d.Renderer.clearBuffer(a,c);d.Renderer.renderInstances(c,e)}c=c||this.default_render_settings;this._current_target=b;b._in_current_fbo=!0;b.texture_type==gl.TEXTURE_2D?(this.enableCamera(a,c),b.drawTo(g)):b.texture_type==
gl.TEXTURE_CUBE_MAP&&this.renderToCubemap(a.getEye(),b.width,b,c,a.near,a.far);this._current_target=null;b._in_current_fbo=!1},renderToCubemap:function(a,b,c,e,g,f,h,k){b=b||256;g=g||1;f=f||1E3;if(e&&e.constructor!==d.RenderSettings)throw"render_settings parameter must be ONE.RenderSettings.";c&&c.constructor==GL.Texture||(c=null);var l=this._current_scene;l||(l=this._current_scene=d.GlobalScene);var m=this._cubemap_camera;m||(m=this._cubemap_camera=new d.Camera);m.configure({fov:90,aspect:1,near:g,
far:f});this._current_target=c=c||new GL.Texture(b,b,{texture_type:gl.TEXTURE_CUBE_MAP,minFilter:gl.NEAREST});c._in_current_fbo=!0;c.drawTo(function(b,c){var f=d.Camera.cubemap_camera_parameters[c];b._is_shadowmap||!h?gl.clearColor(0,0,0,0):gl.clearColor(h[0],h[1],h[2],h[3]);gl.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT);m.configure({eye:a,center:[a[0]+f.dir[0],a[1]+f.dir[1],a[2]+f.dir[2]],up:f.up});d.Renderer.enableCamera(m,e,!0);d.Renderer.renderInstances(e,k,l)});this._current_target=null;c._in_current_fbo=
!1;return c},getCameraAtPosition:function(a,b,c){c=c||this._visible_cameras;if(!c||!c.length)return null;for(var e=c.length-1;0<=e;--e){var d=c[e];if(d.enabled&&!d.render_to_texture&&d.isPoint2DInCameraViewport(a,b))return d}return null},setRenderPass:function(a){a||(a=xb);this._current_pass=a},addImmediateRenderInstance:function(a){a.material&&(a.updateAABB(),a.material._last_frame_update!=this._frame&&(a.material._last_frame_update=this._frame,this._visible_materials.push(a.material),a.material.prepare&&
a.material.prepare(this._current_scene)),this.addInstanceToQueue(a),this._visible_instances.push(a))},enableFrameShaderBlock:function(a,b,c){if((a=a.constructor===d.ShaderBlock?a:d.Shaders.getShaderBlock(a))&&!(this._global_shader_blocks_flags&a.flag_mask)){this._global_shader_blocks.push(a);this._global_shader_blocks_flags|=a.flag_mask;if(b)for(var e in b)this._uniforms[e]=b[e];if(c)for(e=0;e<c.length;++e)c[e]&&(this._samplers[e]=c[e])}},disableFrameShaderBlock:function(a,b,c){(a=a.constructor===
d.ShaderBlock?a:d.Shaders.getShaderBlock(a))&&this._global_shader_blocks_flags&a.flag_mask&&(b=this._global_shader_blocks.indexOf(a),-1!=b&&this._global_shader_blocks.splice(b,1),this._global_shader_blocks_flags&=~a.flag_mask)},_current_query:null,startGPUQuery:function(a){if(gl.extensions.disjoint_timer_query&&this.timer_queries_enabled&&!this._waiting_queries){var b=gl.extensions.disjoint_timer_query,c=this._timer_queries[a];c||(c=this._timer_queries[a]=b.createQueryEXT());b.beginQueryEXT(b.TIME_ELAPSED_EXT,
c);this._current_query=c}},endGPUQuery:function(){if(gl.extensions.disjoint_timer_query&&this.timer_queries_enabled&&!this._waiting_queries){var a=gl.extensions.disjoint_timer_query;a.endQueryEXT(a.TIME_ELAPSED_EXT);this._current_query=null}},resolveQueries:function(){if(gl.extensions.disjoint_timer_query&&this.timer_queries_enabled){var a=gl.extensions.disjoint_timer_query,b=this._timer_queries.gui;if(b)if(a.getQueryObjectEXT(b,a.QUERY_RESULT_AVAILABLE_EXT)){if(!gl.getParameter(a.GPU_DISJOINT_EXT)){var b=
0,c;for(c in this._timer_queries){var e=1E-5*a.getQueryObjectEXT(this._timer_queries[c],a.QUERY_RESULT_EXT),b=b+e;this.gpu_times[c]=e}this.gpu_times.total=b}this._waiting_queries=!1}else this._waiting_queries=!0}},profiler_text:[],renderProfiler:function(){if(gl.canvas.canvas2DtoWebGL_enabled){var a=this.profiler_text,b=gl.extensions.disjoint_timer_query;0==this._frame%5&&(a.length=0,a.push((1E3/this._frame_time).toFixed(2)+" FPS"),a.push("CPU: "+this._frame_cpu_time.toFixed(2)+" ms"),a.push(" - Passes: "+
this._rendered_passes),a.push(" - RIs: "+this._rendered_instances),a.push(" - Draws: "+this._rendercalls),b?(a.push("GPU: "+this.gpu_times.total.toFixed(2)),a.push(" - PreRender: "+this.gpu_times.beforeRender.toFixed(2)),a.push(" - Shadows: "+this.gpu_times.shadows.toFixed(2)),a.push(" - Reflections: "+this.gpu_times.reflections.toFixed(2)),a.push(" - Scene: "+this.gpu_times.main.toFixed(2)),a.push(" - Postpo: "+this.gpu_times.postpo.toFixed(2)),a.push(" - GUI: "+this.gpu_times.gui.toFixed(2))):a.push("GPU: ???"));
b=gl;b.save();b.translate(gl.canvas.width-200,gl.canvas.height-280);b.globalAlpha=0.7;b.font="14px Tahoma";b.fillStyle="black";b.fillRect(0,0,200,280);b.fillStyle="white";b.fillText("Profiler",20,20);b.fillStyle="#AFA";for(var c=0;c<a.length;++c)b.fillText(a[c],20,50+20*c);b.restore()}},blit:function(a,b,c,e){if(!a||!b)throw"data missing in blit";if(a!=b)b.drawTo(function(){a.toViewport(c,e)});else{if(!c)throw"blitting texture to the same texture doesnt makes sense unless a shader is specified";b=
GL.Texture.getTemporary(a.width,a.height,a);a.copyTo(b);b.copyTo(a,c,e);GL.Texture.releaseTemporary(b)}}};d.Renderer=Lc;$a.prototype.enable=function(a){this._in_scene||(a=a||d.GlobalScene,LEvent.bind(a,"afterRenderInstances",this.onRender,this),this._in_scene=a)};$a.prototype.disable=function(a){this._in_scene&&(LEvent.unbind(this._in_scene,"afterRenderInstances",this.onRender,this),this._in_scene=null)};$a.prototype.onRender=function(a,b){this.render(d.Renderer._current_camera)};$a.prototype.render=
function(a,b,c){var e=this.settings;c=c||d.GlobalScene;gl.blendFunc(gl.SRC_ALPHA,gl.ONE_MINUS_SRC_ALPHA);gl.enable(gl.DEPTH_TEST);gl.disable(gl.BLEND);gl.disable(gl.CULL_FACE);gl.depthFunc(gl.LEQUAL);var g=null;e.render_grid&&0<e.grid_alpha&&this.renderGrid();e.render_origin&&(d.Draw.setColor([0.3,0.3,0.3,1]),d.Draw.push(),d.Draw.scale(0.01,0.01,0.01),d.Draw.rotate(-90,[1,0,0]),gl.blendFunc(gl.SRC_ALPHA,gl.ONE),d.Draw.renderText("Origin"),gl.blendFunc(gl.SRC_ALPHA,gl.ONE_MINUS_SRC_ALPHA),d.Draw.pop());
if(e.render_components)for(var f=0,h=c._nodes.length;f<h;++f){var k=c._nodes[f],l=k._is_selected,g=k;k.renderEditor&&k.renderEditor(l);for(var m=0,p=k._components.length;m<p;++m){var n=k._components[m],r=!1;b&&(r=b(n));n.renderEditor&&n.renderEditor(l,r)}}b=vec3.create();f=0;for(h=c._nodes.length;f<h;++f)k=c._nodes[f],!k._is_root&&k.flags.visible&&(l=k.transform?k.transform.getGlobalMatrixRef():mat4.create(),m=mat4.multiplyVec3(vec3.create(),l,b),e.render_null_nodes&&(k._is_selected?this.renderPoint(m,
!0,this.colors.selected):k._is_bone?this.renderPoint(m,!0,this.colors.bone):this.renderPoint(m,!1,this.colors.node)),e.render_names&&this.renderText(m,k.name,k._is_selected?[0.94,0.8,0.4,1]:[0.8,0.8,0.8,0.9]),k._parentNode&&k._parentNode.transform&&(e.render_tree||e.render_skeletons&&k._is_bone&&k._parentNode._is_bone)&&this.renderLine(m,k._parentNode.transform.getGlobalPosition(),this.colors.bone),e.render_axis&&(d.Draw.push(),d.Draw.multMatrix(l),d.Draw.setColor([1,1,1,1]),d.Draw.renderMesh(this.axis_mesh,
gl.LINES),d.Draw.pop()));e.render_colliders&&this.renderColliders(c);e.render_paths&&this.renderPaths(c);this._points.length&&(d.Draw.setPointSize(4),d.Draw.setColor([1,1,1,1]),d.Draw.renderPoints(this._points,this._points_color),this._points.length=0,this._points_color.length=0);this._points_nodepth.length&&(d.Draw.setPointSize(4),d.Draw.setColor([1,1,1,1]),gl.disable(gl.DEPTH_TEST),d.Draw.renderPoints(this._points_nodepth,this._points_color_nodepth),gl.enable(gl.DEPTH_TEST),this._points_nodepth.length=
0,this._points_color_nodepth.length=0);this._lines.length&&(gl.disable(gl.DEPTH_TEST),d.Draw.setColor([1,1,1,1]),d.Draw.renderLines(this._lines,this._lines_color),gl.enable(gl.DEPTH_TEST),this._lines.length=0,this._lines_color.length=0);this.debug_points.length&&(d.Draw.setPointSize(5),d.Draw.setColor([1,0,1,1]),d.Draw.renderPoints(this.debug_points));if(e.render_names&&gl.start2D){gl.disable(gl.DEPTH_TEST);f=this.camera2D;c=gl.getViewport();f.setOrthographic(0,c[2],0,c[3],-1,1);f.updateMatrices();
gl.start2D();gl.font="14px Arial";h=vec4.fromValues(0,0,0,0.5);for(f=0;f<this._names.length;++f)k=a.project(this._names[f][1]),0>k[2]||(k[2]=0,b=gl.measureText(this._names[f][0]),gl.fillColor=h,gl.fillRect(Math.floor(k[0]+10),c[3]-Math.floor(k[1]+8),b.width,b.height),gl.fillColor=this._names[f][2],gl.fillText(this._names[f][0],Math.floor(k[0]+10),c[3]-Math.floor(k[1]-4)));gl.finish2D();this._names.length=0}e.render_axis&&g&&g.transform&&(d.Draw.push(),a=g.transform.getGlobalRotation(),a=mat4.fromQuat(mat4.create(),
a),d.Draw.setMatrix(a),d.Draw.setColor([1,1,1,1]),d.Draw.scale(10,10,10),d.Draw.renderMesh(this.axis_mesh,gl.LINES),d.Draw.pop());gl.depthFunc(gl.LESS)};$a.prototype.renderPoint=function(a,b,c){c=c||[1,1,1,1];b?(this._points_nodepth.push(a[0],a[1],a[2]),this._points_color_nodepth.push(c[0],c[1],c[2],c[3])):(this._points.push(a[0],a[1],a[2]),this._points_color.push(c[0],c[1],c[2],c[3]))};$a.prototype.renderLine=function(a,b,c){c=c||[1,1,1,1];this._lines.push(a,b);this._lines_color.push(c,c)};$a.prototype.renderText=
function(a,b,c){c=c||[1,1,1,1];this._names.push([b,a,c])};$a.prototype.renderGrid=function(){var a=this.settings;this.grid_shader||(this.grid_shader=d.Draw.createSurfaceShader("vec2 f = vec2(1.0/64.0,-1.0/64.0); float brightness = texture2D(u_texture, pos.xz + f).x * 0.6 + texture2D(u_texture, pos.xz * 0.1 + f ).x * 0.3 + texture2D(u_texture, pos.xz * 0.01 + f ).x * 0.2; brightness /= max(1.0,0.001 * length(u_camera_position.xz - pos.xz));vec4 color = u_color * vec4(vec3(1.0),brightness); if( abs(pos.x) < 0.1 ) color = mix(vec4(0.4,0.4,1.0,0.5),color,abs(pos.x/0.1)); if( abs(pos.z) < 0.1 ) color = mix(vec4(1.0,0.4,0.4,0.5),color,abs(pos.z/0.1)); return color;"),
this.grid_shader_xy=d.Draw.createSurfaceShader("vec2 f = vec2(1.0/64.0,-1.0/64.0); float brightness = texture2D(u_texture, pos.xy + f).x * 0.6 + texture2D(u_texture, pos.xy * 0.1 + f ).x * 0.3 + texture2D(u_texture, pos.xy * 0.01 + f ).x * 0.2; brightness /= max(1.0,0.001 * length(u_camera_position.xy - pos.xy));vec4 color = u_color * vec4(vec3(1.0),brightness);  if( abs(pos.x) < 0.025 ) color *= vec4(0.4,1.0,0.4,1.0); if( abs(pos.y) < 0.025 ) color *= vec4(1.0,0.4,0.4,1.0); return color;"),this.grid_shader_yz=
d.Draw.createSurfaceShader("vec2 f = vec2(1.0/64.0,-1.0/64.0); float brightness = texture2D(u_texture, pos.yz + f).x * 0.6 + texture2D(u_texture, pos.yz * 0.1 + f ).x * 0.3 + texture2D(u_texture, pos.yz * 0.01 + f ).x * 0.2; brightness /= max(1.0,0.001 * length(u_camera_position.yz - pos.yz)); vec4 color = u_color * vec4(vec3(1.0),brightness);  if( abs(pos.y) < 0.025 ) color *= vec4(0.4, 0.4, 1.0, 1.0); if( abs(pos.z) < 0.025 ) color *= vec4(0.4,1.0,0.4,1.0); return color;"),this.grid_shader.uniforms({u_texture:0}),
this.grid_texture=this.grid_img&&this.grid_img.loaded?GL.Texture.fromImage(this.grid_img,{format:gl.RGB,wrap:gl.REPEAT,anisotropic:4,minFilter:gl.LINEAR_MIPMAP_LINEAR}):GL.Texture.fromURL(this.grid_texture_url,{format:gl.RGB,wrap:gl.REPEAT,anisotropic:4,minFilter:gl.LINEAR_MIPMAP_LINEAR}));d.Draw.push();"xy"==a.grid_plane?d.Draw.rotate(90,1,0,0):"yz"==a.grid_plane&&d.Draw.rotate(90,0,0,1);this.grid_texture&&!1!==this.grid_texture.ready?(gl.enable(gl.POLYGON_OFFSET_FILL),gl.depthFunc(gl.LEQUAL),gl.polygonOffset(1,
-100),gl.enable(gl.BLEND),this.grid_texture.bind(0),gl.depthMask(!1),d.Draw.setColor([1,1,1,this.settings.grid_alpha]),d.Draw.translate(d.Draw.camera_position[0],0,d.Draw.camera_position[2]),d.Draw.scale(1E4,1E4,1E4),d.Draw.renderMesh(this.plane_mesh,gl.TRIANGLES,"xy"==a.grid_plane?this.grid_shader_xy:"yz"==a.grid_plane?this.grid_shader_yz:this.grid_shader),gl.depthMask(!0),gl.depthFunc(gl.LESS),gl.disable(gl.POLYGON_OFFSET_FILL),gl.polygonOffset(0,0)):(d.Draw.setColor([0.2,0.2,0.2,0.75]),d.Draw.scale(1,
1,1),d.Draw.renderMesh(this.grid_mesh,gl.LINES),d.Draw.scale(10,10,10),d.Draw.renderMesh(this.grid_mesh,gl.LINES));d.Draw.pop()};$a.prototype.renderColliders=function(a){a=a||d.GlobalScene;if(a._colliders){d.Draw.setColor([0.33,0.71,0.71,0.5]);for(var b=0;b<a._colliders.length;++b){var c=a._colliders[b],e=c.oobb;if(this.settings.render_colliders_aabb){var g=c.aabb;d.Draw.push();var f=BBox.getCenter(g),g=BBox.getHalfsize(g);d.Draw.translate(f);d.Draw.renderWireBox(2*g[0],2*g[1],2*g[2]);d.Draw.pop()}d.Draw.push();
d.Draw.multMatrix(c.matrix);g=BBox.getHalfsize(e);c.type==d.PhysicsInstance.BOX?(d.Draw.translate(BBox.getCenter(e)),d.Draw.renderWireBox(2*g[0],2*g[1],2*g[2])):c.type==d.PhysicsInstance.PLANE?(d.Draw.translate(BBox.getCenter(e)),d.Draw.renderWireBox(2*g[0],1E-4,2*g[2])):c.type==d.PhysicsInstance.SPHERE?(d.Draw.translate(BBox.getCenter(e)),d.Draw.renderWireSphere(g[0],20)):c.type==d.PhysicsInstance.MESH&&(c=c.mesh)&&(c.indexBuffers.wireframe||c.computeWireframe(),d.Draw.renderMesh(c,gl.LINES,null,
"wireframe"));d.Draw.pop()}}};$a.prototype.renderPaths=function(a){a=a||d.GlobalScene;if(a._paths){d.Draw.setColor([0.7,0.6,0.3,0.5]);for(var b=0;b<a._paths.length;++b){var c=a._paths[b].samplePoints(0);d.Draw.renderLines(c,null,!0)}}};$a.prototype.createMeshes=function(){this.plane_mesh=GL.Mesh.plane({xz:!0,detail:10});for(var a=10,b=[],c=-10;10>=c;c++)b.push([c*a,0,10*a]),b.push([c*a,0,10*-a]),b.push([10*a,0,c*a]),b.push([10*-a,0,c*a]);this.grid_mesh=GL.Mesh.load({vertices:b});b=new Float32Array([-1,
1,1,-1,1,-1,1,1,-1,1,1,1,-1,-1,1,-1,-1,-1,1,-1,-1,1,-1,1]);c=new Uint16Array([0,1,0,4,0,3,1,2,1,5,2,3,2,6,3,7,4,5,4,7,6,7,5,6]);this.box_mesh=GL.Mesh.load({vertices:b,lines:c});this.circle_mesh=GL.Mesh.circle({size:1,slices:50});this.circle_empty_mesh=GL.Mesh.circle({size:1,slices:50,empty:1});this.sphere_mesh=GL.Mesh.icosahedron({size:1,subdivisions:3});b=[];b.push([0.5*-a,0,0],[0.5*+a,0,0]);b.push([0,0.5*-a,0],[0,0.5*+a,0]);b.push([0,0,0.5*-a],[0,0,0.5*+a]);this.dummy_mesh=GL.Mesh.load({vertices:b});
b=[];b.push([-1,1,1],[1,1,1],[-1,1,-1],[1,1,-1],[-1,-1,1],[1,-1,1],[-1,-1,-1],[1,-1,-1]);b.push([1,-1,1],[1,1,1],[1,-1,-1],[1,1,-1],[-1,-1,1],[-1,1,1],[-1,-1,-1],[-1,1,-1]);b.push([1,1,1],[1,1,-1],[1,-1,1],[1,-1,-1],[-1,1,1],[-1,1,-1],[-1,-1,1],[-1,-1,-1]);this.cube_mesh=GL.Mesh.load({vertices:b});for(c=1;0<=c;c-=0.02)a=2*(1-0.001/c)-1,b.push([-1,1,a],[1,1,a],[-1,-1,a],[1,-1,a]),b.push([1,-1,a],[1,1,a],[-1,-1,a],[-1,1,a]);this.frustum_mesh=GL.Mesh.load({vertices:b});this.cylinder_mesh=GL.Mesh.cylinder({radius:10,
height:2});b=[];c=[];a=2;b.push([0,0,0],[0.5*+a,0,0]);c.push([1,0,0,1],[1,0,0,1]);b.push([0,0,0],[0,0.5*+a,0]);c.push([0,1,0,1],[0,1,0,1]);b.push([0,0,0],[0,0,0.5*+a]);c.push([0,0,1,1],[0,0,1,1]);this.axis_mesh=GL.Mesh.load({vertices:b,colors:c});b=[];b.push([0,0,0],[0,0.5*+a,0]);b.push([0,0.5*+a,0],[0.1*a,0.4*+a,0]);b.push([0,0.5*+a,0],[-0.1*a,0.4*+a,0]);this.top_line_mesh=GL.Mesh.load({vertices:b});b=[];b.push([0,0,0],[0,0,0.5*+a]);b.push([0,0,0.5*+a],[0,0.1*a,0.4*+a]);b.push([0,0,0.5*+a],[0,-0.1*
a,0.4*+a]);this.front_line_mesh=GL.Mesh.load({vertices:b})};d.DebugRender=$a;var tb={ready:!1,images:{},image_last_id:1,onRequestFrame:null,reset_stack_on_reset:!0,_rendercalls:0,init:function(){if(!this.ready&&gl){this.color=new Float32Array(4);this.color[3]=1;this.mvp_matrix=mat4.create();this.temp_matrix=mat4.create();this.point_size=2;this.line_width=1;this.stack=new Float32Array(512);this.model_matrix=new Float32Array(this.stack.buffer,0,16);mat4.identity(this.model_matrix);this.camera=null;
this.camera_position=vec3.create();this.view_matrix=mat4.create();this.projection_matrix=mat4.create();this.viewprojection_matrix=mat4.create();this.camera_stack=[];this.uniforms={u_model:this.model_matrix,u_viewprojection:this.viewprojection_matrix,u_mvp:this.mvp_matrix,u_color:this.color,u_camera_position:this.camera_position,u_point_size:this.point_size,u_point_perspective:0,u_perspective:1,u_texture:0};this._temp=vec3.create();this.quad_mesh=GL.Mesh.load({vertices:[[-1,1,0],[1,1,0],[1,-1,0],[-1,
-1,0]],coords:[[0,1],[1,1],[1,0],[0,0]]});var a=tb.vertex_shader_code,b=tb.fragment_shader_code;this.shader=new Shader(a,b);this.shader_instancing=new Shader(a,b,{USE_INSTANCING:""});this.shader_color=new Shader(a,b,{USE_COLOR:""});this.shader_color_instancing=new Shader(a,b,{USE_COLOR:"",USE_INSTANCING:""});this.shader_texture=new Shader(a,b,{USE_TEXTURE:""});this.shader_texture_instancing=new Shader(a,b,{USE_TEXTURE:"",USE_INSTANCING:""});this.shader_points=new Shader(a,b,{USE_POINTS:""});this.shader_points_color=
new Shader(a,b,{USE_COLOR:"",USE_POINTS:""});this.shader_points_color_size=new Shader(a,b,{USE_COLOR:"",USE_SIZE:"",USE_POINTS:""});this.shader_image=new Shader("\t\t\tprecision mediump float;\n\t\t\tattribute vec3 a_vertex;\n\t\t\tuniform mat4 u_mvp;\n\t\t\tuniform float u_point_size;\n\t\t\tvoid main() {\n\t\t\t\tgl_PointSize = u_point_size;\n\t\t\t\tgl_Position = u_mvp * vec4(a_vertex,1.0);\n\t\t\t}\t\t\t","\t\t\tprecision mediump float;\n\t\t\tuniform vec4 u_color;\n\t\t\tuniform sampler2D u_texture;\n\t\t\tvoid main() {\n\t\t\t  vec4 tex = texture2D(u_texture, vec2(gl_PointCoord.x,1.0 - gl_PointCoord.y) );\n\t\t\t  if(tex.a < 0.01)\n\t\t\t\tdiscard;\n\t\t\t  gl_FragColor = u_color * tex;\n\t\t\t}\t\t");
this.shader_points_color_texture_size=new Shader("\t\t\tprecision mediump float;\n\t\t\tattribute vec3 a_vertex;\n\t\t\tattribute vec4 a_color;\n\t\t\tattribute float a_extra;\n\t\t\tuniform mat4 u_mvp;\n\t\t\tuniform float u_point_size;\n\t\t\tvarying vec4 v_color;\n\t\t\tvoid main() {\n\t\t\t\tv_color = a_color;\n\t\t\t\tgl_PointSize = u_point_size * a_extra;\n\t\t\t\tgl_Position = u_mvp * vec4(a_vertex,1.0);\n\t\t\t}\t\t\t","\t\t\tprecision mediump float;\n\t\t\tuniform vec4 u_color;\n\t\t\tvarying vec4 v_color;\n\t\t\tuniform sampler2D u_texture;\n\t\t\tvoid main() {\n\t\t\t  vec4 tex = texture2D(u_texture, vec2(gl_PointCoord.x,1.0 - gl_PointCoord.y) );\n\t\t\t  if(tex.a < 0.1)\n\t\t\t\tdiscard;\n\t\t\t  vec4 color = u_color * v_color * tex;\n\t\t\t  gl_FragColor = color;\n\t\t\t}\t\t");
this.shader_text2D=new Shader("\t\t\tprecision mediump float;\n\t\t\tattribute vec3 a_vertex;\n\t\t\tattribute vec4 a_extra4;\n\t\t\tuniform mat4 u_mvp;\n\t\t\tuniform float u_point_size;\n\t\t\tvoid main() {\n\t\t\t\tgl_PointSize = u_point_size;\n\t\t\t\tgl_Position = u_mvp * vec4(a_vertex,1.0);\n\t\t\t}\t\t\t","\t\t\tprecision mediump float;\n\t\t\tuniform vec4 u_color;\n\t\t\tuniform sampler2D u_texture;\n\t\t\tvoid main() {\n\t\t\t  vec4 tex = texture2D(u_texture, vec2(gl_PointCoord.x,1.0 - gl_PointCoord.y) );\n\t\t\t  if(tex.a < 0.1)\n\t\t\t\tdiscard;\n\t\t\t  vec4 color = u_color * tex;\n\t\t\t  gl_FragColor = color;\n\t\t\t}\t\t");
this.shader_phong=new Shader("\t\t\tprecision mediump float;\n\t\t\tattribute vec3 a_vertex;\n\t\t\tattribute vec3 a_normal;\n\t\t\tvarying vec3 v_pos;\n\t\t\tvarying vec3 v_normal;\n\t\t\t#ifdef USE_INSTANCING\n\t\t\t\tattribute mat4 u_model;\n\t\t\t#else\n\t\t\t\tuniform mat4 u_model;\n\t\t\t#endif\n\t\t\tuniform mat4 u_viewprojection;\n\t\t\tvoid main() {\n\t\t\t\tv_pos = ( u_model * vec4( a_vertex, 1.0 )).xyz;\n\t\t\t\tv_normal = (u_model * vec4(a_normal,0.0)).xyz;\n\t\t\t\tgl_Position = u_viewprojection * vec4( v_pos, 1.0 );\n\t\t\t}\n",
"\n\t\t\tprecision mediump float;\n\t\t\tuniform vec3 u_ambient_color;\n\t\t\tuniform vec3 u_light_color;\n\t\t\tuniform vec3 u_light_dir;\n\t\t\tuniform vec4 u_color;\n\t\t\tvarying vec3 v_pos;\n\t\t\tvarying vec3 v_normal;\n\t\t\tvoid main() {\n\t\t\t\tvec3 N = normalize(v_normal);\n\t\t\t\tfloat NdotL = max(0.0, dot(N,u_light_dir));\n\t\t\t\tgl_FragColor = u_color * vec4(u_ambient_color + u_light_color * NdotL, 1.0);\n\t\t\t}\n");this.shader_phong_instanced=new Shader("\t\t\tprecision mediump float;\n\t\t\tattribute vec3 a_vertex;\n\t\t\tattribute vec3 a_normal;\n\t\t\tvarying vec3 v_pos;\n\t\t\tvarying vec3 v_normal;\n\t\t\t#ifdef USE_INSTANCING\n\t\t\t\tattribute mat4 u_model;\n\t\t\t#else\n\t\t\t\tuniform mat4 u_model;\n\t\t\t#endif\n\t\t\tuniform mat4 u_viewprojection;\n\t\t\tvoid main() {\n\t\t\t\tv_pos = ( u_model * vec4( a_vertex, 1.0 )).xyz;\n\t\t\t\tv_normal = (u_model * vec4(a_normal,0.0)).xyz;\n\t\t\t\tgl_Position = u_viewprojection * vec4( v_pos, 1.0 );\n\t\t\t}\n",
"\n\t\t\tprecision mediump float;\n\t\t\tuniform vec3 u_ambient_color;\n\t\t\tuniform vec3 u_light_color;\n\t\t\tuniform vec3 u_light_dir;\n\t\t\tuniform vec4 u_color;\n\t\t\tvarying vec3 v_pos;\n\t\t\tvarying vec3 v_normal;\n\t\t\tvoid main() {\n\t\t\t\tvec3 N = normalize(v_normal);\n\t\t\t\tfloat NdotL = max(0.0, dot(N,u_light_dir));\n\t\t\t\tgl_FragColor = u_color * vec4(u_ambient_color + u_light_color * NdotL, 1.0);\n\t\t\t}\n",{USE_INSTANCING:""});a={u_ambient_color:[0.1,0.1,0.1],u_light_color:[0.8,
0.8,0.8],u_light_dir:[0,1,0]};this.shader_phong.uniforms(a);this.shader_phong_instanced.uniforms(a);this.shader_depth=new Shader("\t\t\tprecision mediump float;\n\t\t\tattribute vec3 a_vertex;\n\t\t\tvarying vec4 v_pos;\n\t\t\tuniform mat4 u_model;\n\t\t\tuniform mat4 u_mvp;\n\t\t\tvoid main() {\n\t\t\t\tv_pos = u_model * vec4(a_vertex,1.0);\n\t\t\t\tgl_Position = u_mvp * vec4(a_vertex,1.0);\n\t\t\t}\t\t\t","\t\t\tprecision mediump float;\n\t\t\tvarying vec4 v_pos;\n\t\t\t\n\t\t\tvec4 PackDepth32(float depth)\n\t\t\t{\n\t\t\t\tconst vec4 bitSh  = vec4(   256*256*256, 256*256,   256,         1);\n\t\t\t\tconst vec4 bitMsk = vec4(   0,      1.0/256.0,    1.0/256.0,    1.0/256.0);\n\t\t\t\tvec4 comp;\n\t\t\t\tcomp\t= depth * bitSh;\n\t\t\t\tcomp\t= fract(comp);\n\t\t\t\tcomp\t-= comp.xxyz * bitMsk;\n\t\t\t\treturn comp;\n\t\t\t}\n\t\t\tvoid main() {\n\t\t\t\tfloat depth = (v_pos.z / v_pos.w) * 0.5 + 0.5;\n\t\t\t\tgl_FragColor = PackDepth32(depth);\n\t\t\t}\t\t");
this.ready=!0}},createSurfaceShader:function(a,b,c){-1==a.indexOf("surface_function")&&(a="vec4 surface_function( vec3 pos, vec3 normal, vec2 coord ) { "+a+"\n } ");if(b)if(b.constructor===String)a=b+";\n"+a;else for(var e in b)a+="uniform "+b[e]+" "+e+";\n";return new GL.Shader("\t\t\tprecision mediump float;\n\t\t\tattribute vec3 a_vertex;\n\t\t\tattribute vec3 a_normal;\n\t\t\tattribute vec2 a_coord;\n\t\t\tvarying vec2 v_coord;\n\t\t\tvarying vec3 v_pos;\n\t\t\tvarying vec3 v_normal;\n\t\t\tuniform mat4 u_mvp;\n\t\t\tuniform mat4 u_model;\n\t\t\tvoid main() {\n\t\t\t\tv_coord = a_coord;\n\t\t\t\tv_pos = (u_model * vec4(a_vertex,1.0)).xyz;\n\t\t\t\tv_normal = (u_model * vec4(a_normal,0.0)).xyz;\n\t\t\t\tgl_Position = u_mvp * vec4(a_vertex,1.0);\n\t\t\t}\t\t\t",
"\t\t\tprecision mediump float;\n\t\t\tvarying vec2 v_coord;\n\t\t\tvarying vec3 v_pos;\n\t\t\tvarying vec3 v_normal;\n\t\t\tuniform vec4 u_color;\n\t\t\tuniform vec3 u_camera_position;\n\t\t\tuniform sampler2D u_texture;\n\t\t\t"+a+"\n\t\t\tvoid main() {\n\t\t\t\tgl_FragColor = surface_function(v_pos,v_normal,v_coord);\n\t\t\t}\t\t",c)},reset:function(a){this.ready?(this.color.set([1,1,1,1]),this.point_size=2,this.line_width=1):this.init();a&&(this.images={});this.reset_stack_on_reset&&(this.model_matrix=
new Float32Array(this.stack.buffer,0,16),this.uniforms.u_model=this.model_matrix,mat4.identity(this.model_matrix))},setColor:function(a){if(3<=arguments.length)this.color[0]=arguments[0],this.color[1]=arguments[1],this.color[2]=arguments[2],4==arguments.length&&(this.color[3]=arguments[3]);else for(var b=0;b<a.length;b++)this.color[b]=a[b]},setAlpha:function(a){this.color[3]=a},setPointSize:function(a,b){this.point_size=a;this.uniforms.u_point_size=a;this.uniforms.u_point_perspective=b?1:0},setLineWidth:function(a){gl.setLineWidth?
gl.setLineWidth(a):gl.lineWidth(a);this.line_width=a},setCamera:function(a){this.camera=a;a.updateMatrices();vec3.copy(this.camera_position,a.getEye());this.view_matrix.set(a._view_matrix);this.projection_matrix.set(a._projection_matrix);this.viewprojection_matrix.set(a._viewprojection_matrix);this.uniforms.u_perspective=gl.viewport_data[3]*this.projection_matrix[5]},setCameraPosition:function(a){vec3.copy(this.camera_position,a)},pushCamera:function(){this.camera_stack.push(mat4.create(this.viewprojection_matrix))},
popCamera:function(){if(0==this.camera_stack.length)throw"too many pops";this.viewprojection_matrix.set(this.camera_stack.pop())},setViewProjectionMatrix:function(a,b,c){mat4.copy(this.view_matrix,a);mat4.copy(this.projection_matrix,b);c?mat4.copy(this.viewprojection_matrix,c):mat4.multiply(this.viewprojection_matrix,a,c)},setMatrix:function(a){mat4.copy(this.model_matrix,a)},multMatrix:function(a){mat4.multiply(this.model_matrix,a,this.model_matrix)},renderLines:function(a,b,c,e){if(a&&a.length){var d=
null,d=a.constructor==Float32Array?a:this.linearize(a);b&&(b=b.constructor==Float32Array?b:this.linearize(b));b&&b.length/4!=d.length/3&&(b=null);a=gl.LINES;e?a=gl.LINE_LOOP:c&&(a=gl.LINE_STRIP);c=this.toGlobalMesh({vertices:d,colors:b});return this.renderMesh(c,a,b?this.shader_color:this.shader,void 0,0,d.length/3)}},renderPoints:function(a,b,c){if(a&&a.length){var e=null,e=a.constructor==Float32Array?a:a[0].length?this.linearize(a):new Float32Array(a);b&&b.constructor!=Float32Array&&(b=b.constructor===
Array&&b[0].constructor===Number?new Float32Array(b):this.linearize(b));a=this.toGlobalMesh({vertices:e,colors:b});c||(c=b?this.shader_color:this.shader);return this.renderMesh(a,gl.POINTS,c,void 0,0,e.length/3)}},renderRoundPoints:function(a,b,c){if(a&&a.length){var e=null,e=a.constructor==Float32Array?a:a[0].length?this.linearize(a):new Float32Array(a);b&&(b=b.constructor==Float32Array?b:this.linearize(b));a=this.toGlobalMesh({vertices:e,colors:b});c||(c=b?this.shader_points_color:this.shader_points);
return this.renderMesh(a,gl.POINTS,c,void 0,0,e.length/3)}},renderPointsWithSize:function(a,b,c,e,d){if(a&&a.length){var f=null,f=a.constructor==Float32Array?a:a[0].length?this.linearize(a):new Float32Array(a);if(!b)throw"colors required in Draw.renderPointsWithSize";b=b.constructor==Float32Array?b:this.linearize(b);if(!c)throw"sizes required in Draw.renderPointsWithSize";c=c.constructor==Float32Array?c:this.linearize(c);a=this.toGlobalMesh({vertices:f,colors:b,extra:c});d=d||(e?this.shader_points_color_texture_size:
this.shader_points_color_size);return this.renderMesh(a,gl.POINTS,d,void 0,0,f.length/3)}},createRectangleMesh:function(a,b,c,e){var d=new Float32Array(12);c?d.set([0.5*-a,0,0.5*b,0.5*a,0,0.5*b,0.5*a,0,0.5*-b,0.5*-a,0,0.5*-b]):d.set([0.5*-a,0.5*b,0,0.5*a,0.5*b,0,0.5*a,0.5*-b,0,0.5*-a,0.5*-b,0]);return e?this.toGlobalMesh({vertices:d}):GL.Mesh.load({vertices:d})},renderRectangle:function(a,b,c,e){a=this.createRectangleMesh(a,b,c,!0);return this.renderMesh(a,e?gl.TRIANGLE_FAN:gl.LINE_LOOP,void 0,void 0,
0,this._global_mesh_last_size)},createCircleMesh:function(a,b,c,e){b=b||32;quat.create();for(var d=this._temp,f=new Float32Array(3*b),h=2*Math.PI/b,k=0;k<b;k++)d[0]=Math.sin(h*k)*a,c?(d[1]=0,d[2]=Math.cos(h*k)*a):(d[2]=0,d[1]=Math.cos(h*k)*a),f.set(d,3*k);return e?this.toGlobalMesh({vertices:f}):GL.Mesh.load({vertices:f})},renderCircle:function(a,b,c,e){a=this.createCircleMesh(a,b,c,!0);return this.renderMesh(a,e?gl.TRIANGLE_FAN:gl.LINE_LOOP,void 0,void 0,0,this._global_mesh_last_size)},renderSolidCircle:function(a,
b,c){return this.renderCircle(a,b,c,!0)},createWireSphereMesh:function(a,b,c){b=b||100;quat.create();for(var e=this._temp,d=new Float32Array(18*b),f=1/b*Math.PI*2,h=0;h<b;h++)e.set([Math.sin(h*f)*a,Math.cos(h*f)*a,0]),d.set(e,18*h),e.set([Math.sin((h+1)*f)*a,Math.cos((h+1)*f)*a,0]),d.set(e,18*h+3),e.set([Math.sin(h*f)*a,0,Math.cos(h*f)*a]),d.set(e,18*h+6),e.set([Math.sin((h+1)*f)*a,0,Math.cos((h+1)*f)*a]),d.set(e,18*h+9),e.set([0,Math.sin(h*f)*a,Math.cos(h*f)*a]),d.set(e,18*h+12),e.set([0,Math.sin((h+
1)*f)*a,Math.cos((h+1)*f)*a]),d.set(e,18*h+15);return c?this.toGlobalMesh({vertices:d}):GL.Mesh.load({vertices:d})},renderWireSphere:function(a,b){var c=this.createWireSphereMesh(a,b,!0);return this.renderMesh(c,gl.LINES,void 0,void 0,0,this._global_mesh_last_size)},renderSolidSphere:function(a){var b=this._sphere_mesh;this._sphere_mesh||(b=this._sphere_mesh=GL.Mesh.sphere({size:1}));this.push();this.scale(a,a,a);this.renderMesh(b,gl.TRIANGLES);this.pop()},createWireBoxMesh:function(a,b,c,e){a*=0.5;
b*=0.5;c*=0.5;a=new Float32Array([-a,b,c,-a,b,-c,a,b,-c,a,b,c,-a,-b,c,-a,-b,-c,a,-b,-c,a,-b,c]);b=new Uint16Array([0,1,0,4,0,3,1,2,1,5,2,3,2,6,3,7,4,5,4,7,6,7,5,6]);return e?this.toGlobalMesh({vertices:a},b):GL.Mesh.load({vertices:a,lines:b})},renderWireBox:function(a,b,c){a=this.createWireBoxMesh(a,b,c,!0);return this.renderMesh(a,gl.LINES,void 0,"indices",0,this._global_mesh_last_size)},createSolidBoxMesh:function(a,b,c,e){a*=0.5;b*=0.5;c*=0.5;a=[-a,b,-c,-a,-b,+c,-a,b,c,-a,b,-c,-a,-b,-c,-a,-b,+c,
a,b,-c,a,b,c,a,-b,+c,a,b,-c,a,-b,+c,a,-b,-c,-a,b,c,a,-b,c,a,b,c,-a,b,c,-a,-b,c,a,-b,c,-a,b,-c,a,b,-c,a,-b,-c,-a,b,-c,a,-b,-c,-a,-b,-c,-a,b,-c,a,b,c,a,b,-c,-a,b,-c,-a,b,c,a,b,c,-a,-b,-c,a,-b,-c,a,-b,c,-a,-b,-c,a,-b,c,-a,-b,c];return e?this.toGlobalMesh({vertices:a}):GL.Mesh.load({vertices:a})},renderSolidBox:function(a,b,c){a=this.createSolidBoxMesh(a,b,c,!0);return this.renderMesh(a,gl.TRIANGLES,void 0,void 0,0,this._global_mesh_last_size)},renderWireCube:function(a){return this.renderWireBox(a,a,
a)},renderSolidCube:function(a){return this.renderSolidBox(a,a,a)},renderPlane:function(a,b,c,e){if(!a||!b)throw"ONE.Draw.renderPlane param missing";this.push();this.translate(a);this.scale(b[0],b[1],1);c&&c.bind(0);!e&&c&&(e=this.shader_texture);this.renderMesh(this.quad_mesh,gl.TRIANGLE_FAN,e);c&&c.unbind(0);this.pop()},createGridMesh:function(a,b){a=a||20;b=b||10;for(var c=new Float32Array(12*(2*b+1)),e=0,d=-b;d<=b;d++)c.set([d*a,0,a*b],e),c.set([d*a,0,-a*b],e+3),c.set([a*b,0,d*a],e+6),c.set([-a*
b,0,d*a],e+9),e+=12;return GL.Mesh.load({vertices:c})},renderGrid:function(a,b){var c=this.createGridMesh(a,b);return this.renderMesh(c,gl.LINES)},createConeMesh:function(a,b,c,e,d){var f=[0,1,0];c=c||100;var h=quat.create(),k=this._temp,l=new Float32Array(3*(c+2));l.set(e?[0,0,b]:[0,b,0],0);for(b=0;b<=c;b++)quat.setAxisAngle(h,f,b/c*Math.PI*2),vec3.transformQuat(k,[0,0,a],h),e&&vec3.set(k,k[0],k[2],k[1]),l.set(k,3*b+3);return d?this.toGlobalMesh({vertices:l}):GL.Mesh.load({vertices:l})},renderCone:function(a,
b,c,e){a=this.createConeMesh(a,b,c,e,!0);return this.renderMesh(a,gl.TRIANGLE_FAN,void 0,void 0,0,this._global_mesh_last_size)},createCylinderMesh:function(a,b,c,e,d){e=[0,1,0];c=c||100;for(var f=quat.create(),h=this._temp,k=new Float32Array(6*(c+1)),l=0;l<=c;l++)quat.setAxisAngle(f,e,l/c*Math.PI*2),vec3.transformQuat(h,[0,0,a],f),k.set(h,6*l+3),h[1]=b,k.set(h,6*l);return d?this.toGlobalMesh({vertices:k}):GL.Mesh.load({vertices:k})},renderCylinder:function(a,b,c,e){a=this.createCylinderMesh(a,b,c,
e,!0);return this.renderMesh(a,gl.TRIANGLE_STRIP,void 0,void 0,0,this._global_mesh_last_size)},renderImage:function(a,b,c,e){if(!a||!b)throw"ONE.Draw.renderImage param missing";c=c||10;var g=null;if("string"==typeof b){window.LS&&(g=d.ResourcesManager.textures[b]);g||(g=this.images[b]);if(null==g){tb.images[b]=1;a=new Image;a.src=b;a.onload=function(){var a=GL.Texture.fromImage(this);tb.images[b]=a;if(tb.onRequestFrame)tb.onRequestFrame()};return}if(1==g)return}else b.constructor==Image?(b.texture||
(b.texture=GL.Texture.fromImage(this)),g=b.texture):b.constructor==Texture&&(g=b);g&&(e?(this.setPointSize(c),g.bind(0),this.renderPoints(a,null,this.shader_image)):(this.push(),this.billboard(a),this.scale(c,c,c),g.bind(0),this.renderMesh(this.quad_mesh,gl.TRIANGLE_FAN,this.shader_texture),this.pop()))},renderMesh:function(a,b,c,e,d,f){if(!this.ready)throw"Draw.js not initialized, call Draw.init()";if(!a)throw"ONE.Draw.renderMesh mesh cannot be null";c||(c=a===this._global_mesh&&this._global_mesh_ignore_colors?
this.shader:a.vertexBuffers.colors?this.shader_color:this.shader);mat4.multiply(this.mvp_matrix,this.viewprojection_matrix,this.model_matrix);c.uniforms(this.uniforms);void 0===d?c.draw(a,void 0===b?gl.TRIANGLES:b,e):c.drawRange(a,void 0===b?gl.TRIANGLES:b,d,f,e);this._last_mesh=a;this._last_primitive=b;this._last_shader=c;this._last_indices=e;this._last_range_start=d;this._last_range_length=f;this._rendercalls+=1;return this.last_mesh=a},renderMeshesInstanced:function(){var a={u_model:null},b=mat4.create();
return function(c,e,d,f,h){if(!this.ready)throw"Draw.js not initialized, call Draw.init()";if(!c)throw"ONE.Draw.renderMeshesInstanced mesh cannot be null";if(1==gl.webgl_version&&!gl.extensions.ANGLE_instanced_arrays)return null;f||(f=c.vertexBuffers.colors?this.shader_color_instancing:this.shader_instancing);if(!f.attributes.u_model)throw"Shader does not support instancing, it must have a attribute u_model";a.u_model=e;b.set(this.viewprojection_matrix);mat4.multiply(this.viewprojection_matrix,this.viewprojection_matrix,
this.model_matrix);f.uniforms(this.uniforms);f.drawInstanced(c,void 0===d?gl.TRIANGLES:d,h,a);this.viewprojection_matrix.set(b);this._rendercalls+=1;return c}}(),repeatLastRender:function(){this.renderMesh(this._last_mesh,this._last_primitive,this._last_shader,this._last_indices,this._last_range_start,this._last_range_length)},renderText:function(a,b,c){b=b||d.ZEROS;c=c||1;var e=a.length;if(0!=e&&0!=c){tb.font_atlas||this.createFontAtlas();for(var g=this.font_atlas,f=g.atlas.char_size*c,h=g.atlas.spacing*
c,k=0,l=0;l<e;++l)null!=g.atlas[a.charCodeAt(l)]&&k++;c=new Float32Array(18*k);for(var k=new Float32Array(12*k),m=0,p=0,n=0,l=0;l<e;++l){var r=g.atlas[a.charCodeAt(l)];r?(c.set([p+b[0],n+b[1],b[2]],18*m),c.set([p+b[0],n+b[1]+f,b[2]],18*m+3),c.set([p+b[0]+f,n+b[1]+f,b[2]],18*m+6),c.set([p+b[0]+f,n+b[1],b[2]],18*m+9),c.set([p+b[0],n+b[1],b[2]],18*m+12),c.set([p+b[0]+f,n+b[1]+f,b[2]],18*m+15),k.set([r[0],r[1]],12*m),k.set([r[0],r[3]],12*m+2),k.set([r[2],r[3]],12*m+4),k.set([r[2],r[1]],12*m+6),k.set([r[0],
r[1]],12*m+8),k.set([r[2],r[3]],12*m+10),p+=h,++m):10==a.charCodeAt(l)?(p=0,n-=f):p+=f}a=this.toGlobalMesh({vertices:c,coords:k});g.bind(0);return this.renderMesh(a,gl.TRIANGLES,this.shader_texture,void 0,0,c.length/3)}},createFontAtlas:function(){var a=createCanvas(512,512),b=0.09*a.width|0,c=0.1*a.width|0,e=a.getContext("2d");e.fillStyle="white";e.font=b+"px Courier New";e.textAlign="center";for(var d=0,f=0,b=-0.3*b,h={char_size:c,offset:c/a.width,spacing:0.6*c},k=6;100>k;k++){var l=String.fromCharCode(k+
27);h[k+27]=[d/a.width,1-(f+c)/a.height,(d+c)/a.width,1-f/a.height];e.fillText(l,Math.floor(d+0.5*c),Math.floor(f+c+b),c);d+=c;d+c>a.width&&(d=0,f+=c)}this.font_atlas=GL.Texture.fromImage(a,{magFilter:gl.LINEAR,minFilter:gl.LINEAR_MIPMAP_LINEAR});gl.colorMask(!0,!0,!0,!1);this.font_atlas.fill([1,1,1,0]);gl.colorMask(!0,!0,!0,!0);this.font_atlas.atlas=h},linearize:function(a){if(!a.length)return[];if(a[0].constructor===Number)return a.constructor===Float32Array?a:new Float32Array(a);for(var b=a[0].length,
c=new Float32Array(a.length*b),e=a.length,d=0;d<e;++d)c.set(a[d],d*b);return c},push:function(){if(this.model_matrix.byteOffset>=this.stack.byteLength-64)throw"matrices stack overflow";var a=this.model_matrix;this.model_matrix=new Float32Array(this.stack.buffer,this.model_matrix.byteOffset+64,16);this.uniforms.u_model=this.model_matrix;mat4.copy(this.model_matrix,a)},pop:function(){if(0==this.model_matrix.byteOffset)throw"too many pops";this.model_matrix=new Float32Array(this.stack.buffer,this.model_matrix.byteOffset-
64,16);this.uniforms.u_model=this.model_matrix},identity:function(){mat4.identity(this.model_matrix)},scale:function(a,b,c){if(3==arguments.length){var e=this._temp;e[0]=a;e[1]=b;e[2]=c;mat4.scale(this.model_matrix,this.model_matrix,e)}else a.length?mat4.scale(this.model_matrix,this.model_matrix,a):(e=this._temp,e[0]=e[1]=e[2]=a,mat4.scale(this.model_matrix,this.model_matrix,e))},translate:function(a,b,c){if(3==arguments.length){var e=this._temp;e[0]=a;e[1]=b;e[2]=c;mat4.translate(this.model_matrix,
this.model_matrix,e)}else mat4.translate(this.model_matrix,this.model_matrix,a)},rotate:function(a,b,c,e){if(4==arguments.length){var d=this._temp;d[0]=b;d[1]=c;d[2]=e;mat4.rotate(this.model_matrix,this.model_matrix,a*DEG2RAD,[b,c,e])}else mat4.rotate(this.model_matrix,this.model_matrix,a*DEG2RAD,b)},lookAt:function(a,b,c){mat4.lookAt(this.model_matrix,a,b,c);mat4.invert(this.model_matrix,this.model_matrix)},billboard:function(a){mat4.invert(this.model_matrix,this.view_matrix);mat4.setTranslation(this.model_matrix,
a)},fromTranslationFrontTop:function(a,b,c){mat4.fromTranslationFrontTop(this.model_matrix,a,b,c)},project:function(a,b){b=b||vec3.create();return mat4.multiplyVec3(b,this.mvp_matrix,a)},getPhongShader:function(a,b,c,e){e=e?this.shader_phong_instanced:this.shader_phong;vec3.normalize(c,c);e.uniforms({u_ambient_color:a,u_light_color:b,u_light_dir:c});return e},getDepthShader:function(){return this.shader_depth},toGlobalMesh:function(a,b){this._global_mesh||(this._global_mesh_max_vertices=1024,this._global_mesh=
new GL.Mesh({vertices:new Float32Array(3*this._global_mesh_max_vertices),normals:new Float32Array(3*this._global_mesh_max_vertices),coords:new Float32Array(2*this._global_mesh_max_vertices),colors:new Float32Array(4*this._global_mesh_max_vertices),extra:new Float32Array(1*this._global_mesh_max_vertices)},{indices:new Uint16Array(3*this._global_mesh_max_vertices)},{stream_type:gl.DYNAMIC_STREAM}));for(var c in a){var e=this._global_mesh.getBuffer(c);if(e){var d=a[c];d&&(d.buffer||(d=new Float32Array(d)),
d.length>e.data.length&&(console.warn("Draw: data is too big, resizing"),this.resizeGlobalMesh(),e=this._global_mesh.getBuffer(c),d=d.subarray(0,e.data.length)),e.setData(d))}else console.warn("Draw: global mesh lacks one buffer: "+c)}this._global_mesh_ignore_colors=!a.colors;b?(e=this._global_mesh.getIndexBuffer("indices"),e.setData(b),this._global_mesh_last_size=b.length):this._global_mesh_last_size=a.vertices.length/3;return this._global_mesh},resizeGlobalMesh:function(){if(!this._global_mesh)throw"No global mesh to resize";
this._global_mesh_max_vertices*=2;this._global_mesh.deleteBuffers();this._global_mesh=new GL.Mesh({vertices:new Float32Array(3*this._global_mesh_max_vertices),normals:new Float32Array(3*this._global_mesh_max_vertices),coords:new Float32Array(2*this._global_mesh_max_vertices),colors:new Float32Array(4*this._global_mesh_max_vertices),extra:new Float32Array(1*this._global_mesh_max_vertices)},{indices:new Uint16Array(3*this._global_mesh_max_vertices)},{stream_type:gl.DYNAMIC_STREAM})},vertex_shader_code:"\tprecision mediump float;\n\tattribute vec3 a_vertex;\n\tvarying vec3 v_vertex;\n\tattribute vec3 a_normal;\n\tvarying vec3 v_normal;\n\t#ifdef USE_COLOR\n\t\tattribute vec4 a_color;\n\t\tvarying vec4 v_color;\n\t#endif\n\t#ifdef USE_TEXTURE\n\t\tattribute vec2 a_coord;\n\t\tvarying vec2 v_coord;\n\t#endif\n\t#ifdef USE_SIZE\n\t\tattribute float a_extra;\n\t#endif\n\t#ifdef USE_INSTANCING\n\t\tattribute mat4 u_model;\n\t#else\n\t\tuniform mat4 u_model;\n\t#endif\n\tuniform mat4 u_viewprojection;\n\tuniform float u_point_size;\n\tuniform float u_perspective;\n\tuniform float u_point_perspective;\n\tfloat computePointSize(float radius, float w)\n\t{\n\t\tif(radius < 0.0)\n\t\t\treturn -radius;\n\t\treturn u_perspective * radius / w;\n\t}\n\tvoid main() {\n\t\t#ifdef USE_TEXTURE\n\t\t\tv_coord = a_coord;\n\t\t#endif\n\t\t#ifdef USE_COLOR\n\t\t\tv_color = a_color;\n\t\t#endif\n\t\tv_vertex = ( u_model * vec4( a_vertex, 1.0 )).xyz;\n\t\tv_normal = ( u_model * vec4( a_normal, 0.0 )).xyz;\n\t\tgl_Position = u_viewprojection * vec4(v_vertex,1.0);\n\t\tgl_PointSize = u_point_size;\n\t\t#ifdef USE_SIZE\n\t\t\tgl_PointSize = a_extra;\n\t\t#endif\n\t\tif(u_point_perspective != 0.0)\n\t\t\tgl_PointSize = computePointSize( gl_PointSize, gl_Position.w );\n\t}",
fragment_shader_code:"\tprecision mediump float;\n\tuniform vec4 u_color;\n\t#ifdef USE_COLOR\n\t\tvarying vec4 v_color;\n\t#endif\n\t#ifdef USE_TEXTURE\n\t\tvarying vec2 v_coord;\n\t\tuniform sampler2D u_texture;\n\t#endif\n\tvoid main() {\n\t\tvec4 color = u_color;\n\t\t#ifdef USE_TEXTURE\n\t\t  color *= texture2D(u_texture, v_coord);\n\t\t  if(color.a < 0.1)\n\t\t\tdiscard;\n\t\t#endif\n\t\t#ifdef USE_POINTS\n\t\t\tfloat dist = length( gl_PointCoord.xy - vec2(0.5) );\n\t\t\tif( dist > 0.45 )\n\t\t\t\tdiscard;\n\t\t#endif\n\t\t#ifdef USE_COLOR\n\t\t\tcolor *= v_color;\n\t\t#endif\n\t\tgl_FragColor = color;\n\t}"};
"undefined"!=typeof Xa&&(d.Draw=tb);d.Shadowmap=ma;ma.use_shadowmap_depth_texture=!0;ma.prototype.getLocator=function(){return this._light.getLocator()+"/shadowmap"};ma.prototype.configure=function(a){for(var b in a)this[b]=a[b]};ma.prototype.getReadShaderBlock=function(){return this._texture.format!=GL.DEPTH_COMPONENT?ma.shader_block.flag_mask|ma.depth_in_color_block.flag_mask:ma.shader_block.flag_mask};ma.prototype.getWriteShaderBlock=function(){return 0};ma.prototype.precomputeStaticShadowmap=
function(){};ma.prototype.generate=function(a,b,c){c=this._light;if(!(1E-4>c.computeLightIntensity())){var e=this.resolution;0==e&&(e=b.default_shadowmap_resolution);var g=e;c.type==d.Light.OMNI&&(e*=6);var f=this.linear_filter?gl.LINEAR:gl.NEAREST,h=gl.TEXTURE_2D;if(null==this._texture||this._texture.width!=g||this._texture.height!=e||this._texture.texture_type!=h||this._texture.magFilter!=f){var k=gl.UNSIGNED_BYTE,l=gl.RGBA;ma.use_shadowmap_depth_texture&&gl.extensions.WEBGL_depth_texture&&(l=gl.DEPTH_COMPONENT,
k=gl.UNSIGNED_INT);this._texture=new GL.Texture(g,e,{type:k,texture_type:h,format:l,magFilter:f,minFilter:gl.NEAREST});this._texture.filename=":shadowmap_"+c.uid;d.ResourcesManager.textures[this._texture.filename]=this._texture;this._texture.texture_type==gl.TEXTURE_2D&&(this._fbo=l==gl.RGBA?new GL.FBO([this._texture]):new GL.FBO(null,this._texture))}g=d.Renderer._current_pass;d.Renderer.setRenderPass(kc);d.Renderer._current_light=c;e=b.layers;b.layers=this.layers;this._texture.unbind();d.Renderer._current_target=
this._texture;this._fbo.bind();f=1;h=this._texture.width;k=this._texture.height;c.type==d.Light.OMNI&&(f=6,k/=6);gl.clearColor(1,1,1,1);this._texture.type==gl.DEPTH_COMPONENT&&gl.colorMask(!1,!1,!1,!1);gl.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT);for(l=0;l<f;++l){var m=c.getLightCamera(l);this._texture.near_far_planes||(this._texture.near_far_planes=vec2.create());this._shadow_params[2]=this._texture.near_far_planes[0]=m.near;this._shadow_params[3]=this._texture.near_far_planes[1]=m.far;d.Renderer.enableCamera(m,
b,!0);m=0;c.type==d.Light.OMNI&&(m=l*k);gl.viewport(0,m,h,k);this.reverse_faces&&(d.Renderer._reverse_faces=!0);d.Renderer.renderInstances(b,a);d.Renderer._reverse_faces=!1}this._fbo.unbind();d.Renderer._current_target=null;gl.colorMask(!0,!0,!0,!0);b.layers=e;d.Renderer.setRenderPass(g);d.Renderer._current_light=null;if(this.onPostProcessShadowMap)this.onPostProcessShadowMap(this._texture)}};ma.prototype.prepare=function(a,b){this._texture?(this._light.computeFar(),a.u_shadow_params=this._shadow_params,
this._shadow_params[0]=1/this._texture.width,this._shadow_params[1]=this.bias,this._shadow_extra_params[0]=this.shadow_mode,a.u_shadow_extra=this._shadow_extra_params,a.shadowmap=d.Renderer.SHADOWMAP_TEXTURE_SLOT,b[d.Renderer.SHADOWMAP_TEXTURE_SLOT]=this._texture):console.warn("shadowmap without texture?")};ma.prototype.release=function(){this._texture=null};ma.prototype.toViewport=function(){this._texture&&this._texture.toViewport()};ma._enabled_vertex_code='\n\t#pragma snippet "light_structs"\n\tvarying vec4 v_light_coord;\n\tvoid applyLight( vec3 pos ) { \n\t\tif( u_light_info.x == 1.0 ) //Omni\n\t\t\tv_light_coord.xyz = pos - u_light_position;\n\t\telse\n\t\t\tv_light_coord = u_light_matrix * vec4(pos,1.0);\n\t}\n';
ma._disabled_vertex_code="\n\tvoid applyLight(vec3 pos) {}\n";ma._enabled_fragment_code='\n\t#ifndef TESTSHADOW\n\t\t#define TESTSHADOW\n\t#endif\n\t#pragma shaderblock "depth_in_color"\n\t#pragma snippet "PackDepth32"\n\t\n\tuniform sampler2D shadowmap;\n\tvarying vec4 v_light_coord;\n\tuniform vec4 u_shadow_params; //[ 1.0/(texture_size), bias, near, far ]\n\tuniform vec4 u_shadow_extra; //[hard, ...]\n\t\n\tfloat UnpackDepth(vec4 depth)\n\t{\n\t\t#ifdef BLOCK_DEPTH_IN_COLOR\n\t\t\tconst vec4 bitShift = vec4( 1.0 / (256.0 * 256.0 * 256.0), 1.0 / (256.0 * 256.0), 1.0 / 256.0, 1.0 );\n\t\t\treturn dot(depth, bitShift);\n\t\t#else\n\t\t\treturn depth.x;\n\t\t#endif\n\t}\n\tfloat VectorToDepthValue(vec3 Vec)\n\t{\n\t\tvec3 AbsVec = abs(Vec);\n\t\tfloat LocalZcomp = max(AbsVec.x, max(AbsVec.y, AbsVec.z));\n\t\tfloat n = u_shadow_params.z;\n\t\tfloat f = u_shadow_params.w;\n\t\tfloat NormZComp = (f+n) / (f-n) - (2.0*f*n)/(f-n)/LocalZcomp;\n\t\treturn (NormZComp + 1.0) * 0.5;\n\t}\n\t\n\tfloat texsize = 1.0 / u_shadow_params.x;\n\tfloat real_depth = 0.0;\n\t\n\tfloat pixelShadow( vec2 uv )\n\t{\n\t\tfloat sampleDepth = UnpackDepth( texture2D(shadowmap, uv) );\n\t\tfloat depth = (sampleDepth == 1.0) ? 1.0e9 : sampleDepth; //on empty data send it to far away\n\t\tif (depth > 0.0) \n\t\t\treturn real_depth > depth ? 0.0 : 1.0;\n\t\treturn 0.0;\n\t}\n\tfloat expFunc(float f)\n\t{\n\t\treturn f*f*f*(f*(f*6.0-15.0)+10.0);\n\t}\n\t\n\t#pragma snippet "vec3ToCubemap2D"\n\t\n\tfloat testShadow( Light LIGHT )\n\t{\n\t\tvec3 offset = vec3(0.0);\n\t\tfloat depth = 0.0;\n\t\tfloat bias = u_shadow_params.y;\n\t\t\n\t\tvec2 sample;\n\t\tif( LIGHT.Info.x == 1.0 ) //Omni\n\t\t{\n\t\t\tvec3 l_vector = (v_pos - u_light_position);\n\t\t\tfloat dist = length(l_vector);\n\t\t\tfloat pixel_z = VectorToDepthValue( l_vector );\n\t\t\tif(pixel_z >= 0.998)\n\t\t\t\treturn 1.0; //fixes a little bit the far edge bug\n\t\t\t//vec4 depth_color = textureCube( shadowmap, l_vector + offset * dist );\n\t\t\tsample = vec3ToCubemap2D( l_vector/dist );\n\t\t\tvec4 depth_color = texture2D( shadowmap, sample );\n\t\t\tfloat ShadowVec = UnpackDepth( depth_color );\n\t\t\tif ( ShadowVec > pixel_z - bias )\n\t\t\t\treturn 1.0; //no shadow\n\t\t\treturn 0.0; //full shadow\n\t\t}\n\t\tsample = (v_light_coord.xy / v_light_coord.w) * vec2(0.5) + vec2(0.5) + offset.xy;\n\t\t//is inside light frustum\n\t\tif (clamp(sample, 0.0, 1.0) != sample) \n\t\t\treturn LIGHT.Info.x == 3.0 ? 1.0 : 0.0; //directional: outside of shadowmap, no shadow\n\t\treal_depth = (v_light_coord.z - bias) / v_light_coord.w * 0.5 + 0.5;\n\t\t#ifdef BLOCK_DEPTH_IN_COLOR\n\t\t\t//real_depth = linearDepthNormalized( real_depth, u_shadow_params.z, u_shadow_params.w );\n\t\t#endif\n\t\tvec2 topleft_uv = sample * texsize;\n\t\tif(u_shadow_extra.x == 0.0) //hard \n\t\t\treturn pixelShadow( sample );\n\t\tvec2 offset_uv = fract( topleft_uv );\n\t\toffset_uv.x = expFunc(offset_uv.x);\n\t\toffset_uv.y = expFunc(offset_uv.y);\n\t\ttopleft_uv = floor(topleft_uv) * u_shadow_params.x;\n\t\tfloat topleft = pixelShadow( topleft_uv );\n\t\tfloat topright = pixelShadow( topleft_uv + vec2(u_shadow_params.x,0.0) );\n\t\tfloat bottomleft = pixelShadow( topleft_uv + vec2(0.0, u_shadow_params.x) );\n\t\tfloat bottomright = pixelShadow( topleft_uv + vec2(u_shadow_params.x, u_shadow_params.x) );\n\t\tfloat top = mix( topleft, topright, offset_uv.x );\n\t\tfloat bottom = mix( bottomleft, bottomright, offset_uv.x );\n\t\treturn mix( top, bottom, offset_uv.y );\n\t}\n';
ma._disabled_fragment_code="\nfloat testShadow( Light LIGHT ) { return 1.0; }\n";var Gc=new d.ShaderBlock("depth_in_color");Gc.register();ma.depth_in_color_block=Gc;var $b=new d.ShaderBlock("testShadow");$b.addCode(GL.VERTEX_SHADER,ma._enabled_vertex_code,ma._disabled_vertex_code);$b.addCode(GL.FRAGMENT_SHADER,ma._enabled_fragment_code,ma._disabled_fragment_code);$b.register();ma.shader_block=$b;var Mc={picking_color_offset:10,_picking_points:[],_picking_nodes:null,_pickingMap:null,_picking_color:new Uint8Array(4),
_picking_depth:0,_picking_next_color_id:0,_picking_render_settings:new Ua,_picking_position:vec3.create(),_use_scissor_test:!0,getNodeAtCanvasPosition:function(a,b,c,e,g){return(a=this.getInstanceAtCanvasPosition(a,b,c,e,g))?a.constructor==d.SceneNode?a:a._root&&a._root.constructor==d.SceneNode?a._root:a.node?a.node:null:null},getInstanceAtCanvasPosition:function(a,b,c,e,g){g=g||d.GlobalScene;c||(c=d.Renderer.getCameraAtPosition(a,b,g._cameras));if(!c)return null;this._picking_nodes={};this.getPickingColorFromBuffer(g,
c,a,b,e);this._picking_color[3]=0;a=(new Uint32Array(this._picking_color.buffer))[0];a=this._picking_nodes[a];this._picking_nodes={};return a},getNextPickingColor:function(a){this._picking_next_color_id+=this.picking_color_offset;var b=new Uint32Array(1);b[0]=this._picking_next_color_id;b=new Uint8Array(b.buffer);this._picking_nodes||(this._picking_nodes={});this._picking_nodes[this._picking_next_color_id]=a;return vec4.fromValues(b[0]/255,b[1]/255,b[2]/255,1)},getPickingColorFromBuffer:function(a,
b,c,e,g){if(null==this._pickingMap||this._pickingMap.width!=gl.canvas.width||this._pickingMap.height!=gl.canvas.height)this._pickingMap=new GL.Texture(gl.canvas.width,gl.canvas.height,{format:gl.RGBA,filter:gl.NEAREST}),this._pickingFBO=new GL.FBO([this._pickingMap]);var f=this._use_scissor_test;d.Renderer._current_target=this._pickingMap;this._pickingFBO.bind();f&&(gl.scissor(c-1,e-1,2,2),gl.enable(gl.SCISSOR_TEST));this.renderPickingBuffer(a,b,g,[c,e]);gl.readPixels(c,e,1,1,gl.RGBA,gl.UNSIGNED_BYTE,
this._picking_color);a=this._picking_color[3]/255;this._last_depth=b.near*(a+1)/(b.far+b.near-a*(b.far-b.near))*(b.far-b.near)+b.near;this._picking_position=b.unproject([c,e,a],null,this._picking_position);f&&gl.disable(gl.SCISSOR_TEST);this._pickingFBO.unbind();d.Renderer._current_target=null;return this._picking_color},renderPickingBuffer:function(a,b,c,e){void 0===c&&(c=65535);var g=this._picking_render_settings;d.Renderer.enableCamera(b,this._picking_render_settings);gl.clearColor(0,0,0,0);gl.clear(gl.COLOR_BUFFER_BIT|
gl.DEPTH_BUFFER_BIT);this._picking_next_color_id=0;d.Renderer.setRenderPass(rc);g.layers=c;c=null;if(e){if(b=b.getRay(e[0],e[1]),b=d.Physics.raycastRenderInstances(b.origin,b.direction,{add_instances_without_aabb:!0})){c=Array(b.length);for(var f=0;f<b.length;++f)c[f]=b[f].instance}}else c=a._instances;d.Renderer.renderInstances(g,c);LEvent.trigger(a,"renderPicking",e);LEvent.trigger(d.Renderer,"renderPicking",e);d.Renderer.setRenderPass(xb)},addPickingPoint:function(a,b,c){b=b||5;c=d.Picking.getNextPickingColor(c);
this._picking_points.push([a,c,b])},renderPickingPoints:function(){if(this._picking_points.length){for(var a=new Float32Array(3*this._picking_points.length),b=new Float32Array(4*this._picking_points.length),c=new Float32Array(this._picking_points.length),e=0;e<this._picking_points.length;e++)a.set(this._picking_points[e][0],3*e),b.set(this._picking_points[e][1],4*e),c[e]=this._picking_points[e][2];d.Draw.setPointSize(1);d.Draw.setColor([1,1,1,1]);gl.disable(gl.DEPTH_TEST);d.Draw.renderPointsWithSize(a,
b,c);gl.enable(gl.DEPTH_TEST);this._picking_points.length=0}},visualize:function(a){d.Renderer.setRenderPass(a?d.PICKING_PASS:d.COLOR_PASS);d.GlobalScene.requestFrame()}};d.Picking=Mc;hc.isCloser=function(a,b){return a.distance-b.distance};d.Collision=hc;Va.BOX=1;Va.SPHERE=2;Va.PLANE=3;Va.CAPSULE=4;Va.MESH=5;Va.FUNCTION=6;Va.prototype.updateAABB=function(){BBox.transformMat4(this.aabb,this.oobb,this.matrix)};Va.prototype.setMesh=function(a){this.mesh=a;this.type=Va.MESH;BBox.setCenterHalfsize(this.oobb,
BBox.getCenter(a.bounding),BBox.getHalfsize(a.bounding))};d.PhysicsInstance=Va;d.Physics={raycast:function(a,b,c){c=c||{};if(!a||!b)throw"Physics.raycast: origin or direction missing.";var e=c.layers;void 0===e&&(e=65535);var g=c.max_distance||Number.MAX_VALUE,f=c.scene||d.GlobalScene,h=c.first_collision,f=c.colliders||f._colliders,k=[];c=!!c.normal;if(!f)return null;for(var l=vec3.create(),m=vec3.create(),p=0;p<f.length;++p){var n=f[p];if(0!==(e&n.layers)){var r=vec3.create(),t=null;if(geo.testRayBBox(a,
b,n.aabb,null,r,g)){var x=n.matrix,u=null;if(n.type==Va.SPHERE){if(!geo.testRaySphere(a,b,n.center,n.oobb[3],r,g))continue;c&&(t=vec3.sub(vec3.create(),r,n.center))}else if(n.type==Va.PLANE){var L=vec3.fromValues(0,1,0);mat4.rotateVec3(L,x,L);if(!geo.testRayPlane(a,b,n.center,L,r,g))continue;c&&(t=L)}else{L=mat4.invert(mat4.create(),x);mat4.multiplyVec3(l,L,a);mat4.rotateVec3(m,L,b);if(!geo.testRayBBox(l,m,n.oobb,null,r,g))continue;if(n.type==Va.MESH){u=n.mesh.octree;u||(u=n.mesh.octree=new GL.Octree(n.mesh));
u=u.testRay(l,m,0,g);if(!u)continue;mat4.multiplyVec3(r,x,u.pos);c&&(t=mat4.rotateVec3(vec3.create(),x,u.normal))}else vec3.transformMat4(r,r,x)}x=vec3.distance(a,r);k.push(new d.Collision(n.node,n,r,x,t,u));if(h)return k}}}k.sort(hc.isCloser);return k},testSphere:function(a,b,c){c=c||{};var e=c.layers;void 0===e&&(e=65535);var g=c.scene||d.GlobalScene;c=c.colliders||g._colliders;g=vec3.create();if(!c)return null;for(var f=0;f<c.length;++f){var h=c[f];if(0!==(e&h.layers)&&geo.testSphereBBox(a,b,h.aabb)){var k=
h.matrix,k=mat4.invert(mat4.create(),k);mat4.multiplyVec3(g,k,a);if(h.type==d.PhysicsInstance.SPHERE){if(vec3.distance(a,g)>b+BBox.getRadius(h.oobb))continue}else{if(!geo.testSphereBBox(g,b,h.oobb))continue;if(h.type==d.PhysicsInstance.MESH&&(k=h.mesh.octree,k||(k=h.mesh.octree=new GL.Octree(h.mesh)),!k.testSphere(g,b)))continue}return h}}return null},testCollision:function(a,b){return geo.testBBoxBBox(a.aabb,b.aabb)?!0:!1},testAllCollisions:function(a,b,c){void 0===b&&(b=65535);c=c||d.GlobalScene;
c=c._colliders;for(var e=c.length,g=!1,f=0;f<e;++f){var h=c[f];if(0!==(b&h.layers))for(var k=f+1;k<e;++k){var l=c[k];0!==(b&l.layers)&&this.testCollision(h,l)&&(a&&a(h,l),g=!0)}}return g},raycastRenderInstances:function(a,b,c){c=c||{};var e=c.layers;void 0===e&&(e=65535);var g=c.max_distance||Number.MAX_VALUE,f=c.scene||d.GlobalScene,h=!!c.triangle_collision,k=!!c.first_collision,l=!!c.normal,m=!!c.ignore_transparent,f=c.instances||f._instances;if(!f||!f.length)return null;for(var p=[],n=vec3.create(),
r=vec3.create(),t=0,x=f.length;t<x;++t){var u=f[t];if(0!==(e&u.layers)&&!(u.material&&u.material.render_state.blend&&m))if(!u.use_bounding&&c.add_instances_without_aabb)p.push(new d.Collision(u.node,u,vec3.clone(a),0,vec3.clone(b),null));else{var L=vec3.create();if(geo.testRayBBox(a,b,u.aabb,null,L,g)){var ra=u.matrix,q=null,G=mat4.invert(mat4.create(),ra);mat4.multiplyVec3(n,G,a);mat4.rotateVec3(r,G,b);if(geo.testRayBBox(n,r,u.oobb,null,L,g)){G=null;if(h){var q=u.lod_mesh||u.mesh,s=q.octree;s||(s=
q.octree=new GL.Octree(q));q=s.testRay(n,r,0,g);if(!q)continue;mat4.multiplyVec3(L,ra,q.pos);l&&(G=mat4.rotateVec3(vec3.create(),ra,q.normal))}else vec3.transformMat4(L,L,ra);ra=vec3.distance(a,L);ra<g&&p.push(new d.Collision(u.node,u,L,ra,G,q));if(k)return p}}}}p.sort(d.Collision.isCloser);return p},raycastNode:function(a,b,c,e){e=e||{};e.instances=c._instances;return this.raycastRenderInstances(a,b,e)}};z.temp_matrix=mat4.create();z.icon="mini-icon-gizmo.png";z.ZERO=vec3.create();z.UP=vec3.fromValues(0,
1,0);z.RIGHT=vec3.fromValues(1,0,0);z.FRONT=vec3.fromValues(0,0,-1);z.TRANS10_IDENTITY=new Float32Array([0,0,0,0,0,0,1,1,1,1]);z["@rotation"]={type:"quat"};z["@data"]={type:"trans10"};z.properties={position:"vec3",scaling:"vec3",rotation:"quat"};z.prototype.onAddedToNode=function(a){a.transform||(a.transform=this)};z.prototype.onRemovedFromNode=function(a){a.transform==this&&delete a.transform};Object.defineProperty(z.prototype,"position",{get:function(){return this._position},set:function(a){a&&
a.length&&(this._position.set(a),this._must_update=!0)},enumerable:!0});Object.defineProperty(z.prototype,"x",{get:function(){return this._position[0]},set:function(a){this._position[0]=a;this._must_update=!0},enumerable:!1});Object.defineProperty(z.prototype,"y",{get:function(){return this._position[1]},set:function(a){this._position[1]=a;this._must_update=!0},enumerable:!1});Object.defineProperty(z.prototype,"z",{get:function(){return this._position[2]},set:function(a){this._position[2]=a;this._must_update=
!0},enumerable:!1});Object.defineProperty(z.prototype,"rotation",{get:function(){return this._rotation},set:function(a){this._rotation.set(a);this._must_update=!0},enumerable:!0});Object.defineProperty(z.prototype,"scaling",{get:function(){return this._scaling},set:function(a){a.constructor===Number?this._scaling[0]=this._scaling[1]=this._scaling[2]=a:this._scaling.set(a);this._must_update=!0},enumerable:!0});Object.defineProperty(z.prototype,"uniform_scaling",{get:function(){return this._scaling[0]},
set:function(a){this._scaling[0]=this._scaling[1]=this._scaling[2]=a;this._must_update=!0},enumerable:!0});Object.defineProperty(z.prototype,"matrix",{get:function(){this._must_update&&this.updateMatrix();return this._local_matrix},set:function(a){this.fromMatrix(a)},enumerable:!0});Object.defineProperty(z.prototype,"data",{get:function(){return this._data},set:function(a){this._data.set(a);this._must_update=!0},enumerable:!1});Object.defineProperty(z.prototype,"xrotation",{get:function(){return 0},
set:function(a){this.rotateX(a*DEG2RAD)},enumerable:!1});Object.defineProperty(z.prototype,"yrotation",{get:function(){return 0},set:function(a){this.rotateY(a*DEG2RAD)},enumerable:!1});Object.defineProperty(z.prototype,"zrotation",{get:function(){return 0},set:function(a){this.rotateZ(a*DEG2RAD)},enumerable:!1});Object.defineProperty(z.prototype,"globalPosition",{get:function(){return this.getGlobalPosition()},set:function(a){},enumerable:!0});Object.defineProperty(z.prototype,"globalMatrix",{get:function(){this.updateGlobalMatrix();
return this._global_matrix},set:function(a){throw"globalMatrix cannot be set, use fromMatrix(m,true)";},enumerable:!0});Object.defineProperty(z.prototype,"forward",{get:function(){this.updateGlobalMatrix();return mat4.rotateVec3(vec3.create(),this._global_matrix,d.FRONT)},set:function(a){throw"forward cannot be set";},enumerable:!1});Object.defineProperty(z.prototype,"mustUpdate",{get:function(){return this._must_update},set:function(a){this._must_update=!0},enumerable:!1});z.prototype.getPropertiesInfo=
function(a){return"output"==a?{position:"vec3",scaling:"vec3",rotation:"quat",matrix:"mat4",globalPosition:"vec3",globalMatrix:"mat4"}:{position:"vec3",scaling:"vec3",rotation:"quat",matrix:"mat4"}};z.prototype.copyFrom=function(a){this.configure(a.serialize())};z.prototype.configure=function(a){a.uid&&(this.uid=a.uid);a.position&&this._position.set(a.position);a.scaling&&this._scaling.set(a.scaling);a.rotation&&4==a.rotation.length&&this._rotation.set(a.rotation);if(a.rotation&&3==a.rotation.length){quat.identity(this._rotation);
var b=quat.setAngleAxis(quat.create(),[1,0,0],a.rotation[0]*DEG2RAD);quat.multiply(this._rotation,this._rotation,b);quat.setAngleAxis(b,[0,1,0],a.rotation[1]*DEG2RAD);quat.multiply(this._rotation,this._rotation,b);quat.setAngleAxis(b,[0,0,1],a.rotation[2]*DEG2RAD);quat.multiply(this._rotation,this._rotation,b)}this._must_update=!0;this.updateGlobalMatrix();this._on_change()};z.prototype.serialize=function(a){var b={object_class:"Transform",uid:this.uid,position:[this._position[0],this._position[1],
this._position[2]],rotation:[this._rotation[0],this._rotation[1],this._rotation[2],this._rotation[3]],scaling:[this._scaling[0],this._scaling[1],this._scaling[2]]};this.isIdentity()||a||(b.matrix=Array.apply([],this._local_matrix));return b};z.prototype.isIdentity=function(){for(var a=0;a<this._local_matrix.length;++a)if(0.001<Math.abs(this._local_matrix[a]-d.IDENTITY[a]))return!1;return!0};z.prototype.identity=function(){vec3.copy(this._position,d.ZEROS);quat.identity(this._rotation);vec3.copy(this._scaling,
d.ONES);mat4.identity(this._local_matrix);mat4.identity(this._global_matrix);this._version+=1;this._must_update=!1};z.prototype.reset=z.prototype.identity;z.prototype.resetRotation=function(){quat.identity(this._rotation);this._version+=1;this._must_update=!0;this._on_change()};z.prototype.resetPosition=function(){vec3.copy(this._position,d.ZEROS);this._version+=1;this._must_update=!0;this._on_change(!0)};z.prototype.resetScale=function(){vec3.copy(this._scaling,d.ONES);this._version+=1;this._must_update=
!0;this._on_change(!0)};z.prototype.getPosition=function(a){a=a||vec3.create();a.set(this._position);return a};z.prototype.getGlobalPosition=function(a){a=a||vec3.create();return this._parent?mat4.multiplyVec3(a,this.getGlobalMatrix(),z.ZERO):vec3.copy(a,this._position)};z.prototype.getRotation=function(a){a=a||quat.create();return vec3.copy(a,this._rotation)};z.prototype.getGlobalRotation=function(a){a=a||quat.create();if(!this._parent)return quat.copy(a,this._rotation),a;var b=this._parent;for(quat.copy(a,
this._rotation);b;)quat.multiply(a,b._rotation,a),b=b._parent;return a};z.prototype.getScale=function(a){a=a||vec3.create();return vec3.copy(a,this._scaling)};z.prototype.getGlobalScale=function(a){a=a||vec3.create();if(this._parent){var b=this;for(vec3.copy(a,this._scaling);b._parent;)vec3.multiply(a,a,b._scaling),b=b._parent;return a}return vec3.copy(a,this._scaling)};z.prototype.updateMatrix=function(){mat4.fromRotationTranslation(this._local_matrix,this._rotation,this._position);mat4.scale(this._local_matrix,
this._local_matrix,this._scaling);this._must_update=!1;this._version+=1;this.updateDescendants()};z.prototype.updateLocalMatrix=z.prototype.updateMatrix;z.prototype.updateGlobalMatrix=function(a){this._must_update&&this.updateMatrix();this._parent?mat4.multiply(this._global_matrix,a?this._parent._global_matrix:this._parent.getGlobalMatrix(this._parent._global_matrix),this._local_matrix):this._global_matrix.set(this._local_matrix)};z.prototype.getMatrix=function(a){a=a||mat4.create();this._must_update&&
this.updateMatrix();return mat4.copy(a,this._local_matrix)};z.prototype.getLocalMatrix=z.prototype.getMatrix;z.prototype.getLocalMatrixRef=function(){this._must_update&&this.updateMatrix();return this._local_matrix};z.prototype.getGlobalMatrix=function(a,b){this._must_update&&this.updateMatrix();a=a||mat4.create();this._parent?mat4.multiply(this._global_matrix,b?this._parent._global_matrix:this._parent.getGlobalMatrix(this._parent._global_matrix),this._local_matrix):mat4.copy(this._global_matrix,
this._local_matrix);return mat4.copy(a,this._global_matrix)};z.prototype.getGlobalMatrixRef=function(a){this.updateGlobalMatrix(a);return this._global_matrix};z.prototype.getAncestors=function(){for(var a=[this],b=this;b=b._parent;)a.unshift(b);return a};z.prototype.getGlobalTranslationMatrix=function(){var a=this.getGlobalPosition();return mat4.fromValues(1,0,0,0,0,1,0,0,0,0,1,0,a[0],a[1],a[2],1)};z.prototype.getGlobalRotationMatrix=function(a){a=a||mat4.create();if(!this._parent)return mat4.fromQuat(a,
this._rotation);for(var b=mat4.create(),c=this;c;)mat4.fromQuat(b,c._rotation),mat4.multiply(a,a,b),c=c._parent;return a};z.prototype.getGlobalTranslationRotationMatrix=function(){var a=this.getGlobalPosition();return mat4.fromRotationTranslation(mat4.create(),this.getGlobalRotation(),a)};z.prototype.getGlobalMatrixWithoutScale=z.prototype.getGlobalTranslationRotationMatrix;z.prototype.getNormalMatrix=function(a){this._must_update&&this.updateMatrix();a=a||mat4.create();this._parent?mat4.multiply(this._global_matrix,
this._parent.getGlobalMatrix(),this._local_matrix):a.set(this._local_matrix);return mat4.transpose(a,mat4.invert(a,a))};z.prototype.fromMatrix=function(){var a=mat4.create(),b=mat4.create(),c=mat3.create(),e=vec3.create();return function(g,f){if(f&&this._parent){mat4.copy(this._global_matrix,g);var h=this._parent.getGlobalMatrix(a);if(!mat4.invert(h,h))return;g=mat4.multiply(this._local_matrix,h,g)}b.set(g);mat4.multiplyVec3(this._position,b,d.ZEROS);this._scaling[0]=vec3.length(mat4.rotateVec3(e,
b,d.RIGHT));this._scaling[1]=vec3.length(mat4.rotateVec3(e,b,d.TOP));this._scaling[2]=vec3.length(mat4.rotateVec3(e,b,d.BACK));vec3.normalize(b.subarray(0,3),b.subarray(0,3));vec3.normalize(b.subarray(4,7),b.subarray(4,7));vec3.normalize(b.subarray(8,11),b.subarray(8,11));h=mat3.fromMat4(c,b);quat.fromMat3AndQuat(this._rotation,h);g!=this._local_matrix&&mat4.copy(this._local_matrix,g);this._must_update=!1;this._version+=1;this._on_change(!0)}}();z.prototype.fromGlobalMatrix=function(a){this.fromMatrix(a,
!0)};z.fromMatrix4ToTransformData=function(){mat4.create();var a=mat4.create(),b=mat3.create(),c=vec3.create();return function(e,g){var f=g||new Float32Array(10),h=f.subarray(0,3),k=f.subarray(3,7);quat.identity(k);var l=f.subarray(7,10);a.set(e);mat4.multiplyVec3(h,a,d.ZEROS);l[0]=vec3.length(mat4.rotateVec3(c,a,d.RIGHT));l[1]=vec3.length(mat4.rotateVec3(c,a,d.TOP));l[2]=vec3.length(mat4.rotateVec3(c,a,d.BACK));vec3.normalize(a.subarray(0,3),a.subarray(0,3));vec3.normalize(a.subarray(4,7),a.subarray(4,
7));vec3.normalize(a.subarray(8,11),a.subarray(8,11));h=mat3.fromMat4(b,a);mat3.transpose(h,h);quat.fromMat3(k,h);quat.normalize(k,k);return f}}();z.prototype.setRotationFromEuler=function(a){quat.fromEuler(this._rotation,a);this._must_update=!0;this._on_change()};z.prototype.setPosition=function(a,b,c){3==arguments.length?vec3.set(this._position,a,b,c):vec3.copy(this._position,a);this._must_update=!0;this._on_change(!0)};z.prototype.setRotation=function(a,b){b?quat.setAxisAngle(this._rotation,b,
a):quat.copy(this._rotation,a);this._must_update=!0;this._on_change(!0)};z.prototype.setScale=function(a,b,c){3==arguments.length?vec3.set(this._scaling,a,b,c):vec3.set(this._scaling,a,a,a);this._must_update=!0;this._on_change(!0)};z.prototype.translate=function(){var a=vec3.create(),b=vec3.create();return function(c,e,d){3==arguments.length?(b[0]=c,b[1]=e,b[2]=d,vec3.add(this._position,this._position,this.transformVector(b,a))):vec3.add(this._position,this._position,this.transformVector(c,a));this._must_update=
!0;this._on_change(!0)}}();z.prototype.translateGlobal=function(a,b,c){3==arguments.length?vec3.add(this._position,this._position,[a,b,c]):vec3.add(this._position,this._position,a);this._must_update=!0;this._on_change(!0)};z.prototype.rotate=function(){var a=quat.create(),b=quat.create();return function(c,e,d){d&&(e=this.globalVectorToLocal(e,b));quat.setAxisAngle(a,e,0.0174532925*c);quat.multiply(this._rotation,this._rotation,a);this._must_update=!0;this._on_change(!0)}}();z.prototype.rotateX=function(a){quat.rotateX(this._rotation,
this._rotation,a);this._must_update=!0;this._on_change(!0)};z.prototype.rotateY=function(a){quat.rotateY(this._rotation,this._rotation,a);this._must_update=!0;this._on_change()};z.prototype.rotateZ=function(a){quat.rotateZ(this._rotation,this._rotation,a);this._must_update=!0;this._on_change(!0)};z.prototype.rotateGlobal=function(a,b){var c=quat.setAxisAngle(quat.create(),b,0.0174532925*a);quat.multiply(this._rotation,c,this._rotation);this._must_update=!0;this._on_change(!0)};z.prototype.rotateQuat=
function(a){quat.multiply(this._rotation,this._rotation,a);this._must_update=!0;this._on_change(!0)};z.prototype.rotateQuatGlobal=function(a){quat.multiply(this._rotation,a,this._rotation);this._must_update=!0;this._on_change(!0)};z.prototype.scale=function(a,b,c){3==arguments.length?vec3.multiply(this._scaling,this._scaling,[a,b,c]):vec3.multiply(this._scaling,this._scaling,a);this._must_update=!0;this._on_change(!0)};z.interpolate=function(a,b,c,e){vec3.lerp(e._scaling,a._scaling,b._scaling,c);
vec3.lerp(e._position,a._position,b._position,c);quat.slerp(e._rotation,a._rotation,b._rotation,c);this._must_update=!0;this._on_change()};z.prototype.orbit=function(){var a=quat.create(),b=vec3.create();return function(c,e,d){if(!d)throw"Transform orbit requires a center";c=quat.setAxisAngle(a,e,0.0174532925*c);b.set(this._position);vec3.sub(b,b,d);vec3.transformQuat(b,b,c);vec3.add(b,b,d);this._position.set(b);this._must_update=!0}}();z.prototype.lookAt=function(){var a=mat4.create();return function(b,
c,e,d){mat4.lookAt(a,b,c,e);mat4.invert(a,a);this.fromMatrix(a,!0)}}();z.prototype.orientTo=function(){mat4.create();var a=mat3.create();mat4.create();var b=vec3.create();vec3.create();vec3.create();var c=vec3.create();return function(e,g,f,h){f=f||d.TOP;g?(this.getGlobalPosition(c),vec3.sub(b,e,c)):b.set(e);vec3.scale(b,b,-1);vec3.normalize(b,b);h?(mat3.setColumn(a,d.RIGHT,0),mat3.setColumn(a,f,1),mat3.setColumn(a,b,2),quat.fromMat3AndQuat(this._rotation,a)):quat.lookRotation(this._rotation,b,f);
quat.normalize(this._rotation,this._rotation);this._must_update=!0}}();z.prototype.orientAxis=function(){mat4.create();var a=mat3.create();return function(b,c){switch(c){case d.POSX:mat3.setColumn(a,b,0);mat3.setColumn(a,d.TOP,1);mat3.setColumn(a,d.FRONT,2);break;case d.POSY:mat3.setColumn(a,d.RIGHT,0);mat3.setColumn(a,b,1);mat3.setColumn(a,d.FRONT,2);break;case d.POSZ:mat3.setColumn(a,d.RIGHT,0);mat3.setColumn(a,d.TOP,1);mat3.setColumn(a,b,2);break;case d.NEGX:mat3.setColumn(a,b,0);mat3.setColumn(a,
d.BOTTOM,1);mat3.setColumn(a,d.BACK,2);break;case d.NEGY:mat3.setColumn(a,d.LEFT,0);mat3.setColumn(a,b,1);mat3.setColumn(a,d.BACK,2);break;case d.NEGZ:mat3.setColumn(a,d.LEFT,0);mat3.setColumn(a,d.BOTTOM,1);mat3.setColumn(a,b,2);break;default:return}quat.fromMat3(this._rotation,a);this._must_update=!0}}();z.prototype._on_change=function(a){a||(this._must_update=!0);LEvent.trigger(this,"changed",this);this._root&&LEvent.trigger(this._root,"transformChanged",this)};z.prototype.getFront=function(a){return vec3.transformQuat(a||
vec3.create(),z.FRONT,this.getGlobalRotation())};z.prototype.getTop=function(a){return vec3.transformQuat(a||vec3.create(),z.UP,this.getGlobalRotation())};z.prototype.getRight=function(a){return vec3.transformQuat(a||vec3.create(),z.RIGHT,this.getGlobalRotation())};z.prototype.transformPoint=function(a,b){b=b||vec3.create();this._must_update&&this.updateMatrix();return mat4.multiplyVec3(b,this._local_matrix,a)};z.prototype.localToGlobal=function(a,b){b=b||vec3.create();this._must_update&&this.updateMatrix();
return mat4.multiplyVec3(b,this.getGlobalMatrixRef(),a)};z.prototype.transformPointGlobal=z.prototype.localToGlobal;z.prototype.globalToLocal=function(){var a=mat4.create();return function(b,c){c=c||vec3.create();this._must_update&&this.updateMatrix();return mat4.invert(a,this.getGlobalMatrixRef())?mat4.multiplyVec3(c,a,b):c}}();z.prototype.transformVector=function(a,b){return vec3.transformQuat(b||vec3.create(),a,this._rotation)};z.prototype.localVectorToGlobal=function(a,b){return vec3.transformQuat(b||
vec3.create(),a,this.getGlobalRotation())};z.prototype.transformVectorGlobal=z.prototype.localVectorToGlobal;z.prototype.globalVectorToLocal=function(a,b){var c=this.getGlobalRotation();quat.invert(c,c);return vec3.transformQuat(b||vec3.create(),a,c)};z.prototype.applyTransform=function(a,b,c){vec3.add(this._position,this._position,a._position);quat.multiply(this._rotation,this._rotation,a._rotation);vec3.multiply(this._scaling,this._scaling,a._scaling);this._must_update=!0};z.prototype.applyTransformMatrix=
function(){var a=mat4.create(),b=vec3.create(),c=mat4.create();mat4.create();var e=mat4.create();return function(d,f,h){f&&(mat4.setTranslation(a,f),vec3.scale(b,f,-1),mat4.setTranslation(c,b),mat4.multiply(d,a,d),mat4.multiply(d,d,c));this._parent?(f=this.getGlobalMatrix(),h=this._parent._global_matrix,mat4.multiply(this._global_matrix,d,f),mat4.invert(e,h)&&(mat4.multiply(this._local_matrix,e,this._global_matrix),this.fromMatrix(this._local_matrix))):this.applyLocalTransformMatrix(d)}}();z.prototype.applyLocalTransformMatrix=
function(){var a=vec3.create(),b=mat3.create(),c=mat4.create(),e=quat.create();return function(d){vec3.transformMat4(this._position,this._position,d);mat4.rotateVec3(a,d,[1,0,0]);this._scaling[0]*=vec3.length(a);mat4.rotateVec3(a,d,[0,1,0]);this._scaling[1]*=vec3.length(a);mat4.rotateVec3(a,d,[0,0,1]);this._scaling[2]*=vec3.length(a);if(d=mat4.invert(c,d))mat4.transpose(d,d),d=mat3.fromMat4(b,d),d=quat.fromMat3(e,d),quat.normalize(d,d),quat.multiply(this._rotation,d,this._rotation),this._must_update=
!0,this._on_change()}}();z.prototype.updateDescendants=function(){if(this._root){var a=this._root._children;if(a)for(var b=0;b<a.length;++b){var c=a[b];c.transform&&(c.transform._must_update=!0,c.transform._version+=1,c._children&&c._children.length&&c.transform.updateDescendants())}}};d.registerComponent(z);d.Transform=z;w.icon="mini-icon-camera.png";w.main=null;w.current=null;w.PERSPECTIVE=1;w.ORTHOGRAPHIC=2;w.ORTHO2D=3;w.DEFAULT_EYE=[0,0,0];w.DEFAULT_CENTER=[0,0,-100];w.DEFAULT_UP=[0,1,0];w["@type"]=
{type:"enum",values:{perspective:w.PERSPECTIVE,orthographic:w.ORTHOGRAPHIC,ortho2D:w.ORTHO2D}};w["@eye"]={type:"vec3",widget:"position"};w["@center"]={type:"vec3",widget:"position"};w["@layers"]={type:"layers"};w.cubemap_camera_parameters=[{name:"posx",dir:vec3.fromValues(1,0,0),up:vec3.fromValues(0,-1,0),crossx:2,crossy:1},{name:"negx",dir:vec3.fromValues(-1,0,0),up:vec3.fromValues(0,-1,0),crossx:0,crossy:1},{name:"posy",dir:vec3.fromValues(0,1,0),up:vec3.fromValues(0,0,1),crossx:1,crossy:0},{name:"negy",
dir:vec3.fromValues(0,-1,0),up:vec3.fromValues(0,0,-1),crossx:1,crossy:2},{name:"posz",dir:vec3.fromValues(0,0,1),up:vec3.fromValues(0,-1,0),crossx:1,crossy:1},{name:"negz",dir:vec3.fromValues(0,0,-1),up:vec3.fromValues(0,-1,0),crossx:3,crossy:1}];w.prototype.onResourceRenamed=function(a,b){a==this.overwrite_material&&(this.overwrite_material=b)};w.prototype.getResources=function(a){this.overwrite_material&&this.overwrite_material.constructor===String&&(a[this.overwrite_material]=!0);return a};Object.defineProperty(w.prototype,
"type",{get:function(){return this._type},set:function(a){this._type!=a&&(this._must_update_projection_matrix=this._must_update_view_matrix=!0);this._type=a},enumerable:!0});Object.defineProperty(w.prototype,"eye",{get:function(){return this._eye},set:function(a){this._eye.set(a);this._must_update_view_matrix=!0},enumerable:!0});Object.defineProperty(w.prototype,"center",{get:function(){return this._center},set:function(a){this._center.set(a);this._must_update_view_matrix=!0},enumerable:!0});var Nb=
vec3.create();Object.defineProperty(w.prototype,"focalLength",{get:function(){return vec3.distance(this._eye,this._center)},set:function(a){a=Math.max(0.001,a);vec3.sub(Nb,this._center,this._eye);var b=vec3.length(Nb);1E-4>b?Nb.set([0,0,-1]):a/=b;vec3.scaleAndAdd(Nb,this._eye,Nb,a);this._center.set(Nb);this._must_update_view_matrix=!0},enumerable:!0});Object.defineProperty(w.prototype,"up",{get:function(){return this._up},set:function(a){this._up.set(a);this._must_update_view_matrix=!0},enumerable:!0});
Object.defineProperty(w.prototype,"near",{get:function(){return this._near},set:function(a){this._near!=a&&(this._must_update_projection_matrix=!0);this._near=a},enumerable:!0});Object.defineProperty(w.prototype,"far",{get:function(){return this._far},set:function(a){this._far!=a&&(this._must_update_projection_matrix=!0);this._far=a},enumerable:!0});Object.defineProperty(w.prototype,"aspect",{get:function(){return this._aspect},set:function(a){this._aspect!=a&&(this._must_update_projection_matrix=
!0);this._aspect=a},enumerable:!0});Object.defineProperty(w.prototype,"final_aspect",{get:function(){return this._final_aspect},set:function(a){this._final_aspect!=a&&(this._must_update_projection_matrix=!0);this._final_aspect=a},enumerable:!1});Object.defineProperty(w.prototype,"fov",{get:function(){return this._fov},set:function(a){this._fov!=a&&(this._must_update_projection_matrix=!0);this._fov=a},enumerable:!0});Object.defineProperty(w.prototype,"frustum_size",{get:function(){return this._frustum_size},
set:function(a){this._frustum_size!=a&&(this._must_update_projection_matrix=!0,this._frustum_size=a)},enumerable:!0});Object.defineProperty(w.prototype,"orthographic",{get:function(){return this._ortho},set:function(a){!a||4>a.length||(this._ortho.set(a),this._must_update_projection_matrix=!0)},enumerable:!0});Object.defineProperty(w.prototype,"view_matrix",{get:function(){return this._view_matrix},set:function(a){this.fromViewMatrix(a)},enumerable:!0});Object.defineProperty(w.prototype,"projection_matrix",
{get:function(){return this._projection_matrix},set:function(a){throw"projection matrix cannot be set manually, use setCustomProjectionMatrix instead.";},enumerable:!0});Object.defineProperty(w.prototype,"viewport",{get:function(){return this._viewport},set:function(a){this._viewport.set(a)},enumerable:!0});Object.defineProperty(w.prototype,"viewport_offset",{get:function(){return this._viewport.subarray(0,2)},set:function(a){this._viewport.set(a)},enumerable:!0});Object.defineProperty(w.prototype,
"viewport_size",{get:function(){return this._viewport.subarray(2,4)},set:function(a){this._viewport.set(a,2)},enumerable:!0});Object.defineProperty(w.prototype,"background_color",{get:function(){return this._background_color},set:function(a){this._background_color.set(a)},enumerable:!0});Object.defineProperty(w.prototype,"background_alpha",{get:function(){return this._background_color[3]},set:function(a){this._background_color[3]=a},enumerable:!0});Object.defineProperty(w.prototype,"render_to_texture",
{get:function(){return!!this._frame},set:function(a){a?this._frame||(this._frame=new d.RenderFrameContext):this._frame=null},enumerable:!0});Object.defineProperty(w.prototype,"frame",{set:function(a){throw"frame cannot be assigned manually, enable render_to_texture";},get:function(){return this._frame},enumerable:!0});Object.defineProperty(w.prototype,"frame_color_texture",{set:function(a){throw"frame_color_texture cannot be assigned manually, enable render_to_texture";},get:function(a){return this._frame?
this._frame.getColorTexture():null},enumerable:!0});Object.defineProperty(w.prototype,"frame_depth_texture",{set:function(a){throw"frame_depth_texture cannot be assigned manually, enable render_to_texture";},get:function(){return this._frame?this._frame.getDepthTexture():null},enumerable:!0});Object.defineProperty(w.prototype,"mustUpdate",{get:function(){return this._must_update_projection_matrix||this._must_update_view_matrix},set:function(a){this._must_update_projection_matrix=this._must_update_view_matrix=
a},enumerable:!0});w.prototype.onAddedToNode=function(a){a.camera||(a.camera=this);LEvent.bind(a,"transformChanged",this.onNodeMoved,this)};w.prototype.onRemovedFromNode=function(a){a.camera==this&&delete a.camera;LEvent.unbind(a,"transformChanged",this.onNodeMoved,this)};w.prototype.onAddedToScene=function(a){d.Camera.main||(d.Camera.main=this);LEvent.bind(a,"collectCameras",this.onCollectCameras,this)};w.prototype.onRemovedFromScene=function(a){if(d.Camera.main==this){var b=a.root.findComponents("Camera");
b&&b.length&&(d.Camera.main=b[0])}LEvent.unbind(a,"collectCameras",this.onCollectCameras,this);this._frame&&this._frame.clear();this._binded_render_frame&&(LEvent.unbind(this,"enableFrameContext",this.enableRenderFrameContext,this),LEvent.unbind(this,"showFrameContext",this.disableRenderFrameContext,this),this._binded_render_frame=!1)};w.prototype.onNodeMoved=function(){this._must_update_view_matrix=!0};w.prototype.isRenderedToTexture=function(){return this.enabled&&this.render_to_texture};w.prototype.onCollectCameras=
function(a,b){this.enabled&&(this.isRenderedToTexture()?b.unshift(this):b.push(this),this._frame?this._binded_render_frame||(LEvent.bind(this,"enableFrameContext",this.enableRenderFrameContext,this),LEvent.bind(this,"showFrameContext",this.disableRenderFrameContext,this),this._binded_render_frame=!0):this._binded_render_frame&&(LEvent.unbind(this,"enableFrameContext",this.enableRenderFrameContext,this),LEvent.unbind(this,"showFrameContext",this.disableRenderFrameContext,this),this._binded_render_frame=
!1))};w.prototype.lookAt=function(a,b,c){this._root&&this._root.transform?(this._root._parentNode&&this._root._parentNode.transform&&(a=this._root._parentNode.transform.globalToLocal(a,vec3.create()),b=this._root._parentNode.transform.globalToLocal(b,vec3.create()),c=this._root._parentNode.transform.globalVectorToLocal(c,vec3.create())),this._root.transform.lookAt(a,b,c),this._eye.set(d.ZEROS),this._up.set([0,1,0]),this.focalLength=vec3.distance(a,b)):(vec3.copy(this._eye,a),vec3.copy(this._center,
b),vec3.copy(this._up,c));this._must_update_view_matrix=!0};w.prototype.lookAtFromMatrix=function(a,b){if(this._root&&this._root.transform){if(!b){var c=mat4.create();a=mat4.invert(c,a)}this._root.transform.matrix=a;this._eye.set(d.ZEROS);this._up.set([0,1,0]);this._must_update_view_matrix=!0;this.focalLength=1}else{c=mat4.create();mat4.invert(c,a);var e=b?a:c;this._view_matrix.set(b?c:a);vec3.transformMat4(this._eye,d.ZEROS,e);vec3.transformMat4(this._center,d.FRONT,e);mat4.rotateVec3(this._up,e,
d.TOP)}};w.prototype.resetVectors=function(a){a=a||1;this._eye.set([0,0,0]);this._center.set([0,0,-a]);this._up.set([0,1,0]);this._must_update_view_matrix=!0};w.prototype.updateMatrices=function(a){this._must_update_view_matrix=this._must_update_view_matrix||this._root&&!this._root._is_root;if(this._must_update_projection_matrix||this._must_update_view_matrix||a){!this._must_update_projection_matrix&&!a||this._use_custom_projection_matrix||(this.type==w.ORTHOGRAPHIC?mat4.ortho(this._projection_matrix,
-this._frustum_size*this._final_aspect*0.5,this._frustum_size*this._final_aspect*0.5,0.5*-this._frustum_size,0.5*this._frustum_size,this._near,this._far):this.type==w.ORTHO2D?mat4.ortho(this._projection_matrix,this._ortho[0],this._ortho[1],this._ortho[2],this._ortho[3],this._near,this._far):mat4.perspective(this._projection_matrix,this._fov*DEG2RAD,this._final_aspect,this._near,this._far));if(this._must_update_view_matrix||a)this._root&&this._root._is_root?mat4.lookAt(this._view_matrix,this._eye,
this._center,this._up):mat4.lookAt(this._view_matrix,this.getEye(this._global_eye),this.getCenter(this._global_center),this.getUp(this._global_up)),mat4.invert(this._model_matrix,this._view_matrix);mat4.multiply(this._viewprojection_matrix,this._projection_matrix,this._view_matrix);this.updateFrustumPlanes();this._must_update_projection_matrix=this._must_update_view_matrix=!1}};w.prototype.updateFrustumPlanes=function(){this._frustum_planes||(this._frustum_planes=new Float32Array(24));geo.extractPlanes(this._viewprojection_matrix,
this._frustum_planes);return this._frustum_planes};w.prototype.getModelMatrix=function(a){a=a||mat4.create();this._must_update_view_matrix&&this.updateMatrices();return mat4.copy(a,this._model_matrix)};w.prototype.getViewMatrix=function(a){a=a||mat4.create();this._must_update_view_matrix&&this.updateMatrices();return mat4.copy(a,this._view_matrix)};w.prototype.getProjectionMatrix=function(a){a=a||mat4.create();this._must_update_projection_matrix&&this.updateMatrices();return mat4.copy(a,this._projection_matrix)};
w.prototype.getViewProjectionMatrix=function(a,b){a=a||mat4.create();(this._must_update_view_matrix||this._must_update_projection_matrix||b)&&this.updateMatrices();return mat4.copy(a,this._viewprojection_matrix)};w.prototype.getModelViewProjectionMatrix=function(a,b){b=b||mat4.create();(this._must_update_view_matrix||this._must_update_projection_matrix)&&this.updateMatrices();return mat4.multiply(b,this._viewprojection_matrix,a)};w.prototype.updateVectors=function(a){var b=vec3.subtract(vec3.create(),
this._center,this._eye),b=vec3.length(b);this._eye=mat4.multiplyVec3(vec3.create(),a,vec3.create());this._center=mat4.multiplyVec3(vec3.create(),a,vec3.fromValues(0,0,-b));this._up=mat4.rotateVec3(vec3.create(),a,vec3.fromValues(0,1,0));this.updateMatrices()};w.prototype.getLocalPoint=function(a,b){b=b||vec3.create();if(this._root&&this._root.transform)return mat4.multiplyVec3(b,this._root.transform.getGlobalMatrixRef(),a);this._must_update_view_matrix&&this.updateMatrices();return mat4.multiplyVec3(b,
this._model_matrix,a)};w.prototype.getLocalVector=function(a,b){b=b||vec3.create();if(this._root&&this._root.transform)return mat4.rotateVec3(b,this._root.transform.getGlobalMatrixRef(),a);this._must_update_view_matrix&&this.updateMatrices();return mat4.rotateVec3(b,this._model_matrix,a)};w.prototype.getEye=function(a){a=a||vec3.create();a[0]=this._eye[0];a[1]=this._eye[1];a[2]=this._eye[2];return this._root&&this._root.transform?this._root.transform.getGlobalPosition(a):a};w.prototype.getCenter=
function(a){a=a||vec3.create();if(this._root&&this._root.transform)return mat4.multiplyVec3(a,this._root.transform.getGlobalMatrixRef(),this._center);a[0]=this._center[0];a[1]=this._center[1];a[2]=this._center[2];return a};w.prototype.getFront=function(a){a=a||vec3.create();if(this._root&&this._root.transform)return a[0]=a[1]=0,a[2]=-1,mat4.rotateVec3(a,this._root.transform.getGlobalMatrixRef(),a);vec3.sub(a,this._center,this._eye);return vec3.normalize(a,a)};w.prototype.getUp=function(a){a=a||vec3.create();
a[0]=this._up[0];a[1]=this._up[1];a[2]=this._up[2];return this._root&&this._root.transform?mat4.rotateVec3(a,this._root.transform.getGlobalMatrixRef(),a):a};w.prototype.getTop=function(a){a=a||vec3.create();var b=vec3.sub(vec3.create(),this._center,this._eye),c=vec3.cross(vec3.create(),this._up,b);a=vec3.cross(a,b,c);vec3.normalize(a,a);return this._root&&this._root.transform&&this._root._parentNode?mat4.rotateVec3(a,this._root.transform.getGlobalMatrixRef(),a):a};w.prototype.getRight=function(a){a=
a||vec3.create();var b=vec3.sub(vec3.create(),this._center,this._eye);a=vec3.cross(a,this._up,b);vec3.normalize(a,a);return this._root&&this._root.transform&&this._root._parentNode?mat4.rotateVec3(a,this._root.transform.getGlobalMatrixRef(),a):a};w.prototype.setEye=function(a){this._eye.set(a);this._must_update_view_matrix=!0};w.prototype.setCenter=function(a){this._center.set(a);this._must_update_view_matrix=!0};w.prototype.setPerspective=function(a,b,c,e){this._fov=a;this._aspect=b;this._near=c;
this._far=e;this._type=w.PERSPECTIVE;this._must_update_projection_matrix=!0};w.prototype.setOrthographic=function(a,b,c,e,d,f){this._near=d;this._far=f;this._ortho.set([a,b,c,e]);this._type=w.ORTHO2D;this._must_update_projection_matrix=!0};w.prototype.move=function(a){this._root&&this._root.transform?this._root.transform.move(a):(vec3.add(this._center,this._center,a),vec3.add(this._eye,this._eye,a));this._must_update_view_matrix=!0};w.prototype.rotate=function(){var a=quat.create(),b=vec3.create();
return function(c,e,d){0!=c&&(this._root&&this._root.transform?this._root.transform.rotate(c,e,!d):(d?this.getLocalVector(e,b):b.set(e),c=quat.setAxisAngle(a,b,0.0174532925*c),e=vec3.subtract(b,this._center,this._eye),vec3.transformQuat(e,e,c),vec3.add(this._center,this._eye,e)),this._must_update_view_matrix=!0)}}();w.prototype.orbit=function(){var a=quat.create(),b=vec3.create();return function(c,e,d){c=c||0;if(0!=c){if(!e)throw"axis missing";this._root&&this._root.transform?this._root.transform.orbit(c,
e,d||this.getCenter()):(d=d||this._center,c=quat.setAxisAngle(a,e,0.0174532925*c),e=vec3.subtract(b,this._eye,d),vec3.transformQuat(e,e,c),vec3.add(this._eye,d,e));this._must_update_view_matrix=!0}}}();w.prototype.orbitDistanceFactor=function(a,b){b=b||this._center;var c=vec3.subtract(vec3.create(),this._eye,b);vec3.scale(c,c,a);vec3.add(this._eye,b,c);this._must_update_view_matrix=!0};w.prototype.panning=function(a,b){var c=vec3.create(),e=vec3.create(),g=vec3.create();return function(a,b,k){k=k||
1;this.getLocalVector(d.TOP,c);this.getLocalVector(d.RIGHT,e);vec3.scaleAndAdd(g,d.ZEROS,c,b*k);vec3.scaleAndAdd(g,g,e,a*k);this.move(g)}}();w.prototype.setDistanceToCenter=function(a,b){if(this._root)console.warn("cannot use setDistanceToCenter in a camera attached to a node");else{var c=vec3.sub(vec3.create(),this._center,this._eye),e=vec3.length(c);b?vec3.scaleAndAdd(this._eye,this._center,c,-a/e):vec3.scaleAndAdd(this._center,this._eye,c,a/e);this._must_update_view_matrix=!0}};w.prototype.setOrientation=
function(a,b){var c=this.getCenter(),e=this.getEye(),d=[0,1,0],c=vec3.sub(vec3.create(),c,e),c=vec3.length(c),f=null,f=vec3.fromValues(0,0,-c);b&&(vec3.rotateY(f,f,-0.5*Math.PI),vec3.rotateY(d,d,-0.5*Math.PI));vec3.transformQuat(f,f,a);vec3.transformQuat(d,d,a);b&&(vec3.rotateY(f,f,0.5*Math.PI),vec3.rotateY(d,d,0.5*Math.PI));this.center=vec3.add(vec3.create(),e,f);this.up=d;this._must_update_view_matrix=!0};w.prototype.setEulerAngles=function(a,b,c){var e=quat.create();quat.fromEuler(e,[a,b,c]);this.setOrientation(e)};
w.prototype.fromViewMatrix=function(a){this._root&&this._root.transform?(a=mat4.invert(mat4.create(),a),this._root.transform.fromMatrix(a,!0)):(a=mat4.invert(mat4.create(),a),this.eye=vec3.transformMat4(vec3.create(),d.ZEROS,a),this.center=vec3.transformMat4(vec3.create(),d.FRONT,a),this.up=mat4.rotateVec3(vec3.create(),a,d.TOP),this._must_update_view_matrix=!0)};w.prototype.setCustomProjectionMatrix=function(a){a?(this._use_custom_projection_matrix=!0,this._projection_matrix.set(a),this._must_update_projection_matrix=
!1,mat4.multiply(this._viewprojection_matrix,this._projection_matrix,this._view_matrix)):(this._use_custom_projection_matrix=!1,this._must_update_projection_matrix=!0)};w.prototype.setViewportInPixels=function(a,b,c,e){this._viewport[0]=a/gl.canvas.width;this._viewport[1]=b/gl.canvas.height;this._viewport[2]=c/gl.canvas.width;this._viewport[3]=e/gl.canvas.height};w.prototype.project=function(a,b,c,e){c=c||vec3.create();if(!a)throw"camera project parameter 'vec' cannot be null";b=this.getLocalViewport(b);
(this._must_update_view_matrix||this._must_update_projection_matrix)&&this.updateMatrices();vec3.project(c,a,this._viewprojection_matrix,b);e||(c[1]=b[3]-c[1]+2*b[1]);return c};w.prototype.projectNodeCenter=function(a,b,c,e){a=a.transform?a.transform.getGlobalPosition():d.ZEROS;return this.project(a,b,c,e)};w.prototype.unproject=function(a,b,c){b=this.getLocalViewport(b);(this._must_update_view_matrix||this._must_update_projection_matrix)&&this.updateMatrices();return vec3.unproject(c||vec3.create(),
a,this._viewprojection_matrix,b)};w.prototype.getLocalViewport=function(a,b){b=b||vec4.create();if(!a)return b[0]=gl.canvas.width*this._viewport[0],b[1]=gl.canvas.height*this._viewport[1],b[2]=gl.canvas.width*this._viewport[2],b[3]=gl.canvas.height*this._viewport[3],b;b[0]=Math.floor(a[2]*this._viewport[0]+a[0]);b[1]=Math.floor(a[3]*this._viewport[1]+a[1]);b[2]=Math.ceil(a[2]*this._viewport[2]);b[3]=Math.ceil(a[3]*this._viewport[3]);return b};w.prototype.mouseToViewport=function(a,b){b=b||vec2.create();
var c=this._last_viewport_in_pixels;b[0]=a[0]-c[0];b[1]=c[3]-(a[1]-c[1]);return b};w.prototype.getRay=function(){var a=vec3.create(),b=vec3.create();return function(c,e,g,f,h){g=f?gl.viewport_data:this.getLocalViewport(g,this._viewport_in_pixels);(this._must_update_view_matrix||this._must_update_projection_matrix)&&this.updateMatrices();a[0]=c;a[1]=e;a[2]=1;var k=vec3.unproject(a,a,this._viewprojection_matrix,g);if(!k)return null;f=null;this.type==w.ORTHOGRAPHIC?(b[0]=c,b[1]=e,b[2]=0,f=vec3.unproject(b,
b,this._viewprojection_matrix,g)):f=this.getEye(b);c=vec3.subtract(k,k,f);vec3.normalize(c,c);h=h||new d.Ray;h.origin.set(f);h.direction.set(c);return h}}();w.prototype.getRayInPixel=w.prototype.getRay;w.prototype.isPoint2DInCameraViewport=function(a,b,c){c=this.getLocalViewport(c,this._viewport_in_pixels);return a<c[0]||a>c[0]+c[2]||b<c[1]||b>c[1]+c[3]?!1:!0};w.prototype.testSphereInsideFrustum=function(a,b){return geo.frustumTestSphere(this._frustum_planes,a,b||0)!=CLIP_OUTSIDE};w.prototype.configure=
function(a){void 0!==a.uid&&(this.uid=a.uid);void 0!==a.layers&&(this.layers=a.layers);void 0!==a.enabled&&(this.enabled=a.enabled);void 0!==a.type&&(this._type=a.type);void 0!==a.eye&&this._eye.set(a.eye);void 0!==a.center&&this._center.set(a.center);void 0!==a.up&&this._up.set(a.up);void 0!==a.near&&(this._near=a.near);void 0!==a.far&&(this._far=a.far);void 0!==a.fov&&(this._fov=a.fov);void 0!==a.aspect&&(this._aspect=a.aspect);void 0!==a.final_aspect&&(this._final_aspect=a.final_aspect);void 0!==
a.frustum_size&&(this._frustum_size=a.frustum_size);void 0!==a.viewport&&this._viewport.set(a.viewport);void 0!==a.orthographic&&this._ortho.set(a.orthographic);void 0!==a.background_color&&this._background_color.set(a.background_color);void 0!==a.render_to_texture&&(this.render_to_texture=a.render_to_texture);a.frame&&this._frame&&this._frame.configure(a.frame);void 0!==a.show_frame&&(this.show_frame=a.show_frame);void 0!==a.clear_color&&(this.clear_color=!!a.clear_color);void 0!==a.clear_depth&&
(this.clear_depth=!!a.clear_depth);this.updateMatrices(!0)};w.prototype.serialize=function(){return{object_class:"Camera",uid:this.uid,layers:this.layers,enabled:this.enabled,type:this._type,eye:vec3.toArray(this._eye),center:vec3.toArray(this._center),up:vec3.toArray(this._up),near:this._near,far:this._far,fov:this._fov,aspect:this._aspect,orthographic:vec4.toArray(this._ortho),background_color:vec4.toArray(this._background_color),frustum_size:this._frustum_size,viewport:Array.apply([],this._viewport),
render_to_texture:this.render_to_texture,frame:this._frame?this._frame.serialize():null,show_frame:this.show_frame,clear_color:this.clear_color,clear_depth:this.clear_depth}};w.prototype.checkLayersVisibility=function(a){return 0!==(this.layers&a)};w.prototype.getLayers=function(){for(var a=[],b=0;32>b;++b)this.layers&1<<b&&a.push(this._root.scene.layer_names[b]||"layer"+b);return a};w.prototype.setLayer=function(a,b){var c=1<<a;this.layers&=~c;b&&(this.layers|=c)};w.prototype.isInLayer=function(a){return 0!==
(this.layers&1<<a)};w.prototype.getTransformMatrix=function(a){if(this._root&&this._root.transform)return null;var b=null,b="center"==a?this._center:this._eye;a=mat4.create();mat4.setTranslation(a,b);return a};w.prototype.applyTransformMatrix=function(a,b,c){if(this._root&&this._root.transform)return!1;b=null;b="center"==c?this._center:this._eye;mat4.multiplyVec3(b,a,b);return this._must_update_view_matrix=!0};w.prototype.enableRenderFrameContext=function(){this._frame&&this._frame.enable(null,null,
this)};w.prototype.disableRenderFrameContext=function(){this._frame&&(this._frame.disable(),this.show_frame&&d.Renderer.showRenderFrameContext(this._frame,this))};w.prototype.prepare=function(){this._previous_viewprojection_matrix.set(this._viewprojection_matrix);this.updateMatrices();this.fillShaderUniforms()};w.prototype.fillShaderUniforms=function(){var a=this._uniforms;a.u_camera_planes[0]=this.near;a.u_camera_planes[1]=this.far;this.type==d.Camera.PERSPECTIVE?a.u_camera_perspective.set([this.fov*
DEG2RAD,512/Math.tan(this.fov*DEG2RAD)]):a.u_camera_perspective.set([this._frustum_size,512/this._frustum_size]);a.u_camera_perspective[2]=this._projection_matrix[5];this.getEye(a.u_camera_eye);this.getFront(a.u_camera_front);return a};d.registerComponent(w);d.Camera=w;za.icon="mini-icon-fx.png";za["@camera_uid"]={type:"String"};Object.defineProperty(za.prototype,"use_antialiasing",{set:function(a){this.fx.apply_fxaa=a},get:function(){return this.fx.apply_fxaa},enumerable:!0});za.prototype.configure=
function(a){this.enabled=!!a.enabled;this.use_antialiasing=!!a.use_antialiasing;this.camera_uid=a.camera_uid;a.frame&&this.frame.configure(a.frame);a.fx&&this.fx.configure(a.fx)};za.prototype.serialize=function(){return{object_class:"CameraFX",enabled:this.enabled,use_antialiasing:this.use_antialiasing,frame:this.frame.serialize(),camera_uid:this.camera_uid,fx:this.fx.serialize()}};za.prototype.getResources=function(a){this.fx.getResources(a);this.shader_material&&(a[this.shader_material]=!0);return a};
za.prototype.onResourceRenamed=function(a,b,c){if(this.shader_material==a)this.shader_material=b;else this.fx.onResourceRenamed(a,b,c)};za.prototype.addFX=function(a){this.fx.addFX(a)};za.prototype.getFX=function(a){return this.fx.getFX(a)};za.prototype.moveFX=function(a,b){return this.fx.moveFX(a,b)};za.prototype.removeFX=function(a){return this.fx.removeFX(a)};za.prototype.onAddedToScene=function(a){LEvent.bind(a,"enableFrameContext",this.onBeforeRender,this);LEvent.bind(a,"showFrameContext",this.onAfterRender,
this)};za.prototype.onRemovedFromScene=function(a){LEvent.unbind(a,"enableFrameContext",this.onBeforeRender,this);LEvent.unbind(a,"showFrameContext",this.onAfterRender,this);this._binded_camera&&(LEvent.unbindAll(this._binded_camera,this),this._binded_camera=null)};za.prototype.onBeforeRender=function(a,b){if(this.enabled){var c=this._root.camera;this.camera_uid&&(c=this._binded_camera&&this._binded_camera.uid==this.camera_uid?this._root.scene.findComponentByUId(this.camera_uid):this._binded_camera);
c?(c&&c!=this._binded_camera&&(this._binded_camera&&LEvent.unbindAll(this._binded_camera,this),LEvent.bind(c,"enableFrameContext",this.enableCameraFBO,this),LEvent.bind(c,"showFrameContext",this.showCameraFBO,this)),this._binded_camera=c):this._binded_camera&&(LEvent.unbindAll(this._binded_camera,this),this._binded_camera=null)}else this._binded_camera&&(LEvent.unbindAll(this._binded_camera,this),this._binded_camera=null)};za.prototype.onAfterRender=function(a,b){};za.prototype.enableCameraFBO=function(a,
b){if(this.enabled){var c=this._viewport=this._binded_camera.getLocalViewport(null,this._viewport);this.frame.enable(b,c);b.ignore_viewports=!0}};za.prototype.showCameraFBO=function(a,b){this.enabled&&(b.ignore_viewports=!1,this.showFBO())};za.prototype.showFBO=function(){if(this.enabled)if(this.frame.disable(),LEvent.trigger(d.Renderer,"beforeShowFrameContext",this.frame),this.shader_material){var a=d.ResourcesManager.getResource(this.shader_material),b=!1;a&&a.constructor===d.ShaderMaterial&&(b=
a.applyToTexture(this.frame._color_texture));b||this.frame._color_texture.toViewport()}else this._viewport?(gl.setViewport(this._viewport),this.applyFX(),gl.setViewport(this.frame._fbo._old_viewport)):this.applyFX()};za.prototype.applyFX=function(){var a=this.frame._color_texture,b=this.frame._depth_texture;this.fx.apply_fxaa=this.use_antialiasing;this.fx.filter=this.frame.filter_texture;this.fx.applyFX(a,null,{depth_texture:b})};d.registerComponent(za);La.icon="mini-icon-fx.png";La.prototype.configure=
function(a){this.enabled=!!a.enabled;this.use_viewport_size=!!a.use_viewport_size;this.use_antialiasing=!!a.use_antialiasing;this.shader_material=a.shader_material;a.fx&&this.fx.configure(a.fx);a.frame&&this.frame.configure(a.frame)};La.prototype.serialize=function(){return{object_class:"FrameFX",enabled:this.enabled,uid:this.uid,frame:this.frame.serialize(),shader_material:this.shader_material,use_antialiasing:this.use_antialiasing,use_viewport_size:this.use_viewport_size,fx:this.fx.serialize()}};
La.prototype.getResources=function(a){this.fx.getResources(a);this.shader_material&&(a[this.shader_material]=!0);return a};La.prototype.onResourceRenamed=function(a,b,c){if(this.shader_material==a)this.shader_material=b;else this.fx.onResourceRenamed(a,b,c)};La.prototype.addFX=function(a){this.fx.addFX(a)};La.prototype.getFX=function(a){return this.fx.getFX(a)};La.prototype.moveFX=function(a,b){return this.fx.moveFX(a,b)};La.prototype.removeFX=function(a){return this.fx.removeFX(a)};La.prototype.onAddedToScene=
function(a){LEvent.bind(a,"enableFrameContext",this.onBeforeRender,this);LEvent.bind(a,"showFrameContext",this.onAfterRender,this)};La.prototype.onRemovedFromScene=function(a){LEvent.unbind(a,"enableFrameContext",this.onBeforeRender,this);LEvent.unbind(a,"showFrameContext",this.onAfterRender,this)};La.prototype.onBeforeRender=function(a,b){this.enabled&&this.enableFrameFBO(b)};La.prototype.onAfterRender=function(a,b){this.enabled&&this.showFBO()};La.prototype.enableFrameFBO=function(a){this.enabled&&
this.frame.enable(a)};La.prototype.showFBO=function(){if(this.enabled)if(this.frame.disable(),LEvent.trigger(d.Renderer,"beforeShowFrameContext",this.frame),this.shader_material){var a=d.ResourcesManager.getResource(this.shader_material),b=!1;a&&a.constructor===d.ShaderMaterial&&(b=a.applyToTexture(this.frame._color_texture));b||this.frame._color_texture.toViewport()}else this._viewport?(gl.setViewport(this._viewport),this.applyFX(),gl.setViewport(this.frame._fbo._old_viewport)):this.applyFX()};La.prototype.applyFX=
function(){var a=this.frame._color_texture,b=this.frame._depth_texture;this.fx.apply_fxaa=this.use_antialiasing;this.fx.filter=this.frame.filter_texture;this.fx.applyFX(a,null,{depth_texture:b})};d.registerComponent(La);v.NO_ATTENUATION=0;v.LINEAR_ATTENUATION=1;v.RANGE_ATTENUATION=2;v.AttenuationTypes={none:v.NO_ATTENUATION,linear:v.LINEAR_ATTENUATION,range:v.RANGE_ATTENUATION};v["@projective_texture"]={type:d.TYPES.TEXTURE};v["@extra_texture"]={type:d.TYPES.TEXTURE};v["@color"]={type:d.TYPES.COLOR};
v["@attenuation_type"]={type:"enum",values:v.AttenuationTypes};Object.defineProperty(v.prototype,"type",{get:function(){return this._type},set:function(a){this._type=this._uniforms.u_light_info[0]=a},enumerable:!0});Object.defineProperty(v.prototype,"position",{get:function(){return this._position},set:function(a){this._position.set(a)},enumerable:!0});Object.defineProperty(v.prototype,"target",{get:function(){return this._target},set:function(a){this._target.set(a)},enumerable:!0});Object.defineProperty(v.prototype,
"extra",{get:function(){return this._uniforms.u_light_extra},set:function(a){a&&this._uniforms.u_light_extra.set(a)},enumerable:!0});Object.defineProperty(v.prototype,"up",{get:function(){return this._up},set:function(a){this._up.set(a)},enumerable:!0});Object.defineProperty(v.prototype,"color",{get:function(){return this._color},set:function(a){this._color.set(a)},enumerable:!0});Object.defineProperty(v.prototype,"spot_cone",{get:function(){return this._spot_cone},set:function(a){this._spot_cone=
a;this._uniforms.u_light_info[1]=a?1:0},enumerable:!0});Object.defineProperty(v.prototype,"cast_shadows",{get:function(){return this._cast_shadows},set:function(a){this._cast_shadows=a;!this._shadowmap&&a&&(this._shadowmap=new d.Shadowmap(this))},enumerable:!0});Object.defineProperty(v.prototype,"shadows",{get:function(){return this._shadowmap},set:function(a){this._shadowmap||(this._shadowmap=new d.Shadowmap(this));this._shadowmap.configure(a)},enumerable:!1});v.OMNI=1;v.SPOT=2;v.DIRECTIONAL=3;v.DEFAULT_DIRECTIONAL_FRUSTUM_SIZE=
50;v.prototype.onAddedToNode=function(a){a.light||(a.light=this)};v.prototype.onRemovedFromNode=function(a){a.light==this&&delete a.light};v.prototype.onAddedToScene=function(a){LEvent.bind(a,"collectLights",this.onCollectLights,this);LEvent.bind(a,"renderShadows",this.onGenerateShadowmap,this)};v.prototype.onRemovedFromScene=function(a){LEvent.unbind(a,"collectLights",this.onCollectLights,this);LEvent.unbind(a,"renderShadows",this.onGenerateShadowmap,this);d.ResourcesManager.unregisterResource(":shadowmap_"+
this.uid)};v.prototype.onSerialize=function(a){this._shadowmap&&(a.shadows=d.cloneObject(this._shadowmap))};v.prototype.onConfigure=function(a){a.shadows&&(this._shadowmap||(this._shadowmap=new d.Shadowmap(this)),d.cloneObject(a.shadows,this._shadowmap))};v.prototype.onGenerateShadowmap=function(a){this._update_shadowmap_render_settings&&(this.generateShadowmap(this._update_shadowmap_render_settings,this._precompute_shadowmaps_on_startup),this._update_shadowmap_render_settings=null)};v.prototype.onCollectLights=
function(a,b){this.enabled&&b.push(this)};v.prototype.getLightCamera=function(a){this.updateLightCamera(a);return this._light_camera};v._temp_matrix=mat4.create();v._temp2_matrix=mat4.create();v._temp3_matrix=mat4.create();v._temp_position=vec3.create();v._temp_target=vec3.create();v._temp_up=vec3.create();v._temp_front=vec3.create();v.prototype.updateLightCamera=function(a){this._light_camera||(this._light_camera=new d.Components.Camera);var b=this._light_camera;b.type=this.type==v.DIRECTIONAL?d.Components.Camera.ORTHOGRAPHIC:
d.Components.Camera.PERSPECTIVE;b.eye=this.getPosition(v._temp_position);if(this.type==v.OMNI&&null!=a){a=d.Camera.cubemap_camera_parameters[a];var c=v._temp_target;vec3.add(c,v._temp_position,a.dir);b.center=c;b.fov=90;b.up=a.up}else b.center=this.getTarget(v._temp_target),a=this.getUp(v._temp_up),c=this.getFront(v._temp_front),0.999<Math.abs(vec3.dot(c,a))&&vec3.set(a,0,0,1),b.up=a,b.fov=this.angle_end||45;a=this.computeFar();b.frustum_size=this.frustum_size||v.DEFAULT_DIRECTIONAL_FRUSTUM_SIZE;
b.near=this.near;b.far=a;b.layers=this.illuminated_layers;b.updateMatrices();this._light_matrix.set(b._viewprojection_matrix);return b};v.prototype.computeFar=function(){var a=this.far;this.type==v.OMNI?this.attenuation_type==this.RANGE_ATTENUATION&&this.att_end*Math.SQRT2<a&&(a=this.att_end/Math.SQRT2):this.attenuation_type==this.RANGE_ATTENUATION&&this.att_end<a&&(a=this.att_end);return a};v.prototype.updateVectors=function(){var a=vec3.create();return function(){if(this._root&&this._root.transform){var b=
this._root.transform.getGlobalMatrixRef();mat4.getTranslation(this._position,b);this.use_target||mat4.multiplyVec3(this._target,b,d.FRONT);mat4.multiplyVec3(this._up,b,d.TOP);mat4.rotateVec3(this._front,b,d.FRONT);mat4.rotateVec3(this._right,b,d.RIGHT);vec3.copy(this._top,this.up)}else vec3.subtract(this._front,this._target,this._position),vec3.normalize(this._front,this._front),vec3.normalize(a,this._up),vec3.cross(this._right,this._front,a),vec3.cross(this._top,this._right,this._front)}}();v.prototype.getPosition=
function(a){a=a||vec3.create();if(this._root&&this._root.transform)return this._root.transform.getGlobalPosition(a);a.set(this._position);return a};v.prototype.getTarget=function(a){a=a||vec3.create();if(this._root&&this._root.transform&&!this.use_target)return this._root.transform.localToGlobal(d.FRONT,a);a.set(this._target);return a};v.prototype.getUp=function(a){a=a||vec3.create();if(this._root&&this._root.transform)return this._root.transform.transformVector(d.TOP,a);a.set(this._up);return a};
v.prototype.getFront=function(a){a=a||vec3.create();this.getPosition(a);vec3.subtract(a,a,this.getTarget(v._temp_position));vec3.normalize(a,a);return a};v.prototype.getResources=function(a){this.projective_texture&&(a[this.projective_texture]=GL.Texture);this.extra_texture&&(a[this.extra_texture]=GL.Texture);return a};v.prototype.onResourceRenamed=function(a,b,c){this.projective_texture==a&&(this.projective_texture=b);this.extra_texture==a&&(this.extra_texture=b)};v.prototype.checkLayersVisibility=
function(a){return 0!==(this.illuminated_layers&a)};v.prototype.isInLayer=function(a){return 0!==(this.illuminated_layers&1<<a)};v.prototype.prepare=function(a){var b=this._uniforms,c=this._samplers;this._update_shadowmap_render_settings=null;(this.projective_texture||this._cast_shadows||this.force_light_matrix)&&this.updateLightCamera();a.shadows_enabled&&this._cast_shadows||!this._shadowmap||(this._shadowmap.release(),delete d.ResourcesManager.textures[":shadowmap_"+this.uid]);this.updateVectors();
this.type==v.SPOT&&(b.u_light_angle[0]=this.angle*DEG2RAD,b.u_light_angle[1]=this.angle_end*DEG2RAD,b.u_light_angle[2]=Math.cos(this.angle*DEG2RAD*0.5),b.u_light_angle[3]=Math.cos(this.angle_end*DEG2RAD*0.5));vec3.scale(b.u_light_color,this.color,this.intensity);this._attenuation_info[0]=this.att_start;this._attenuation_info[1]=this.att_end;this._attenuation_info[2]=this.attenuation_type;b.u_light_offset=this.offset;this._samplers.length=0;if(this.projective_texture){var e=this.projective_texture.constructor===
String?d.ResourcesManager.textures[this.projective_texture]:this.projective_texture;e&&(e.texture_type==gl.TEXTURE_CUBE_MAP?b.light_cubemap=d.Renderer.LIGHTPROJECTOR_TEXTURE_SLOT:b.light_texture=d.Renderer.LIGHTPROJECTOR_TEXTURE_SLOT);c[d.Renderer.LIGHTPROJECTOR_TEXTURE_SLOT]=e}else delete b.light_texture,delete b.light_cubemap;if(this.extra_texture){if(e=this.extra_texture.constructor===String?d.ResourcesManager.textures[this.extra_texture]:this.extra_texture)e.texture_type==gl.TEXTURE_CUBE_MAP?
b.extra_light_cubemap=d.Renderer.LIGHTEXTRA_TEXTURE_SLOT:b.extra_light_texture=d.Renderer.LIGHTEXTRA_TEXTURE_SLOT;c[d.Renderer.LIGHTEXTRA_TEXTURE_SLOT]=e}else delete b.extra_light_texture,delete b.extra_light_cubemap;(a.update_shadowmaps||!this._shadowmap._texture&&!d.ResourcesManager.isLoading())&&a.shadows_enabled&&!a.lights_disabled&&!a.low_quality&&(c=!1,c=this.isInsideVisibleFrustum())&&(this._update_shadowmap_render_settings=a);this._shadowmap&&!this.cast_shadows&&this._shadowmap.release();
this.cast_shadows&&this._shadowmap&&null!=this._light_matrix&&!a.shadows_disabled&&this._shadowmap.prepare(b,this._samplers)};v.prototype.computeLightIntensity=function(){var a=Math.max(this.color[0],this.color[1],this.color[2]);return Math.max(0,a*this.intensity)};v.prototype.computeLightRadius=function(){return this.attenuation_type==v.NO_ATTENUATION||this.attenuation_type==v.LINEAR_ATTENUATION?-1:this.type==v.OMNI?this.att_end*Math.SQRT2:this.att_end};v.prototype.generateShadowmap=function(a,b){this.cast_shadows&&
(this._shadowmap||(this._shadowmap=new ma(this)),this._shadowmap.generate(null,a,b))};v.prototype.getGlobalMatrix=function(a){if(this._root&&this._root.transform)return this._root.transform.getGlobalMatrix(a);a=a||mat4.create();mat4.lookAt(a,this._position,this._target,d.TOP);return a};v.prototype.getTransformMatrix=function(a,b){if(this._root&&this._root.transform)return this._root.transform.getGlobalMatrix(b);var c=null;if("matrix"==a)return this.getGlobalMatrix(b);var c="target"==a?this.target:
this.position,e=b||mat4.create();mat4.setTranslation(e,c);return e};v.prototype.applyTransformMatrix=function(a,b,c){if(this._root&&this._root.transform)return!1;b=null;b="target"==c?this.target:this.position;mat4.multiplyVec3(b,a,b);return!0};v.prototype.applyShaderBlockFlags=function(a,b,c){if(!this.enabled)return a;a|=v.shader_block.flag_mask;this.attenuation_type&&(a|=v.attenuation_block.flag_mask);this.projective_texture&&(a|=v.light_texture_block.flag_mask);this.cast_shadows&&c.shadows_enabled&&
this._shadowmap&&(a|=this._shadowmap.getReadShaderBlock());return a};v.prototype.isInsideVisibleFrustum=function(){if(this.type!=v.OMNI)return!0;var a=d.Renderer._visible_cameras;if(!a)return!0;for(var b=this.computeFar(),c=this.position,e=0;e<a.length;e++)if(geo.frustumTestSphere(a[e]._frustum_planes,c,b)!=CLIP_OUTSIDE)return!0;return!1};d.registerComponent(v);d.Light=v;Object.defineProperty(X.prototype,"enabled",{get:function(){return this._enabled},set:function(a){this._enabled=!!a;this.checkRenderInstances()},
enumerable:!0});Object.defineProperty(X.prototype,"primitive",{get:function(){return this._primitive},set:function(a){a=void 0===a||null===a?-1:a|0;-1>a||10<a||(this._primitive=a)},enumerable:!0});Object.defineProperty(X.prototype,"material",{get:function(){return this._material},set:function(a){this._material=a},enumerable:!0});Object.defineProperty(X.prototype,"mesh",{get:function(){return this._mesh},set:function(a){this._mesh=a},enumerable:!0});Object.defineProperty(X.prototype,"lod_mesh",{get:function(){return this._lod_mesh},
set:function(a){this._lod_mesh=a},enumerable:!0});Object.defineProperty(X.prototype,"submesh_id",{get:function(){return this._submesh_id},set:function(a){this._submesh_id=a},enumerable:!0});Object.defineProperty(X.prototype,"render_instance",{get:function(){return this._RI},set:function(a){throw"cannot set a render_instance, must use the collectRenderInstances process.";},enumerable:!1});X.icon="mini-icon-teapot.png";X["@mesh"]={type:"mesh"};X["@lod_mesh"]={type:"mesh"};X["@material"]={type:"material"};
X["@primitive"]={type:"enum",values:{Default:-1,Points:0,Lines:1,LineLoop:2,LineStrip:3,Triangles:4,TriangleStrip:5,TriangleFan:6,Wireframe:10}};X["@submesh_id"]={type:"enum",values:function(){var a=this.instance.getMesh();if(!(a&&a&&a.info&&a.info.groups))return null;for(var b={all:null},c=0;c<a.info.groups.length;++c)b[a.info.groups[c].name]=c;return b}};X["@use_submaterials"]={type:d.TYPES.BOOLEAN,widget:null};X["@submaterials"]={widget:null};X.prototype.onAddedToScene=function(a){this.checkRenderInstances()};
X.prototype.onRemovedFromScene=function(a){this.checkRenderInstances()};X.prototype.onAddedToNode=function(a){LEvent.bind(a,"collectRenderInstances",this.onCollectInstances,this);this._RI.node=a};X.prototype.onRemovedFromNode=function(a){LEvent.unbind(a,"collectRenderInstances",this.onCollectInstances,this)};X.prototype.configure=function(a){a.uid&&(this.uid=a.uid);void 0!==a.enabled&&(this.enabled=a.enabled);this.mesh=a.mesh;this.lod_mesh=a.lod_mesh;void 0!==a.submesh_id&&(this.submesh_id=a.submesh_id);
this.primitive=a.primitive;this.material=a.material;this.use_submaterials=!!a.use_submaterials;a.submaterials&&(this.submaterials=a.submaterials);a.material&&a.material.constructor===String&&(this.material=a.material)};X.prototype.serialize=function(){var a={object_class:"MeshRenderer",enabled:this.enabled,uid:this.uid,mesh:this.mesh,lod_mesh:this.lod_mesh};this.material&&this.material.constructor===String&&(a.material=this.material);-1!=this.primitive&&(a.primitive=this.primitive);-1!=this.submesh_id&&
(a.submesh_id=this.submesh_id);a.material=this.material;this.use_submaterials&&(a.use_submaterials=this.use_submaterials);a.submaterials=this.submaterials;return a};X.prototype.getMesh=function(){return this.mesh?this.mesh.constructor===String?d.ResourcesManager.meshes[this.mesh]:this.mesh:null};X.prototype.getLODMesh=function(){return this.lod_mesh?this.lod_mesh.constructor===String?d.ResourcesManager.meshes[this.lod_mesh]:null:null};X.prototype.getAnyMesh=function(){return this.getMesh()||this.getLODMesh()};
X.prototype.getResources=function(a){this.mesh&&this.mesh.constructor===String&&(a[this.mesh]=GL.Mesh);this.lod_mesh&&this.lod_mesh.constructor===String&&(a[this.lod_mesh]=GL.Mesh);this.material&&this.material.constructor===String&&(a[this.material]=d.Material);if(this.use_submaterials)for(var b=0;b<this.submaterials.length;++b)this.submaterials[b]&&(a[this.submaterials[b]]=d.Material);return a};X.prototype.onResourceRenamed=function(a,b,c){this.mesh==a&&(this.mesh=b);this.lod_mesh==a&&(this.lod_mesh=
b);this.material==a&&(this.material=b);if(this.morph_targets)for(var e in this.morph_targets)this.morph_targets[e].mesh==a&&(this.morph_targets[e].mesh=b)};X.prototype.checkRenderInstances=function(){};X.prototype.onCollectInstances=function(a,b){if(this._enabled)if(this.use_submaterials)this.onCollectInstancesSubmaterials(b);else{var c=this.getAnyMesh();if(!c)return null;if(this._root){var e=this._RI,g=this._root.flags&&this._root.flags.is_static,f=this._root.transform;e.layers=this._root.layers;
e.fromNode(this._root);var h=null,h=this.material?d.ResourcesManager.getResource(this.material):this._root.getMaterial();e.setMaterial(h);e.setMesh(c,this.primitive);if(-1!=this.submesh_id&&null!=this.submesh_id&&c.info&&c.info.groups){if(h=c.info.groups[this.submesh_id])e.setRange(h.start,h.length),h.bounding&&e.setBoundingBox(h.bounding)}else e.setRange(0,-1);e.collision_mesh=c;g&&d.allow_static&&!this.isLoading()&&(this._must_update_static=!1,this._transform_version=f?f._version:0);b.push(e)}}};
X.prototype.onCollectInstancesSubmaterials=function(a){this._RIs||(this._RIs=[]);var b=this.getMesh();if(b){var c=b.info.groups;if(c){var e=this._root.transform._global_matrix,g=vec3.create();mat4.multiplyVec3(g,e,d.ZEROS);for(var e=null,f=0;f<this.submaterials.length;++f){var h=this.submaterials[f];if(h){var k=c[f];if(k&&(h=d.ResourcesManager.getResource(h))){var l=this._RIs[f];l||(l=this._RIs[f]=new d.RenderInstance(this._root,this));e?l.setMatrix(e.matrix,e.normal_matrix):l.setMatrix(this._root.transform._global_matrix);
l.center.set(g);l.setMaterial(h);l.setMesh(b,this.primitive);l.setRange(k.start,k.length);a.push(l);e||(e=l)}}}}}};X.prototype.isLoading=function(){return this.mesh&&d.ResourcesManager.isLoading(this.mesh)||this.lod_mesh&&d.ResourcesManager.isLoading(this.lod_mesh)||this.material&&d.ResourcesManager.isLoading(this.material)||this._root&&this._root.material&&this._root.material.constructor===String&&d.ResourcesManager.isLoading(this._root.material)?!0:!1};X.prototype.explodeSubmeshesToChildNodes=function(){var a=
this._root;if(a){var b=this.getMesh();if(b&&b.info&&b.info.groups){a.removeComponent(this);for(var c=0;c<b.info.groups.length;++c){var e=b.info.groups[c],g=new d.SceneNode;a.addChild(g);e=new d.Components.MeshRenderer({mesh:this.mesh,submesh_id:c,material:e.material});g.addComponent(e)}d.GlobalScene.refresh()}}};d.registerComponent(X);d.MeshRenderer=X;D.AUTOMATIC=0;D.CPU=1;D.STREAMS=2;D.TEXTURES=3;D.icon="mini-icon-teapot.png";D.force_GPU=!0;D["@mode"]={type:"enum",values:{automatic:D.AUTOMATIC,CPU:D.CPU,
streams:D.STREAMS,textures:D.TEXTURES}};D.prototype.onAddedToNode=function(a){LEvent.bind(a,"collectRenderInstances",this.onCollectInstances,this)};D.prototype.onConfigure=function(a){this.updateNamesIndex()};D.prototype.updateNamesIndex=function(){for(var a=0;a<this.morph_targets.length;++a){var b=this.morph_targets[a];b.name&&(this._morph_targets_by_name[b.name]=b)}};Object.defineProperty(D.prototype,"name_weights",{set:function(a){if(a)for(var b=0;b<this.morph_targets.length;++b){var c=this.morph_targets[b];
if(void 0!==a[c.name]){var e=Number(a[c.name]);isNaN(e)||(c.weight=e)}}},get:function(){for(var a={},b=0;b<this.morph_targets.length;++b){var c=this.morph_targets[b];c.name&&(a[c.name]=c.weight)}return a},enumeration:!1});Object.defineProperty(D.prototype,"mesh_weights",{set:function(a){if(a)for(var b=0;b<this.morph_targets.length;++b){var c=this.morph_targets[b];if(void 0!==a[c.mesh]){var e=Number(a[c.mesh]);isNaN(e)||(c.weight=e)}}},get:function(){for(var a={},b=0;b<this.morph_targets.length;++b){var c=
this.morph_targets[b];a[c.mesh]=c.weight}return a},enumeration:!1});Object.defineProperty(D.prototype,"weights",{set:function(a){if(a&&a.length)for(var b=0;b<a.length;++b)this.morph_targets[b]&&(this.morph_targets[b].weight=a[b]||0)},get:function(){for(var a=Array(this.morph_targets.length),b=0;b<this.morph_targets.length;++b)a[b]=this.morph_targets[b].weight;return a},enumeration:!1});D.prototype.onRemovedFromNode=function(a){LEvent.unbind(a,"collectRenderInstances",this.onCollectInstances,this);
this._last_RI&&this.disableMorphingGPU(this._last_RI);this._last_RI=null};D.prototype.getResources=function(a){for(var b=0;b<this.morph_targets.length;++b)this.morph_targets[b].mesh&&(a[this.morph_targets[b].mesh]=GL.Mesh)};D.prototype.onResourceRenamed=function(a,b,c){for(c=0;c<this.morph_targets.length;++c)this.morph_targets[c].mesh==a&&(this.morph_targets[c].mesh=b)};D.prototype.clearWeights=function(){for(var a=0;a<this.morph_targets.length;++a)this.morph_targets[a].weight=0};D.prototype.addMorph=
function(a,b){b=b||0;var c=this.getMorphIndex(a);-1==c?this.morph_targets.push({mesh:a,weight:b}):this.morph_targets[c]={mesh:a,weight:b}};D.prototype.onCollectInstances=function(a,b){if(b.length&&!(16>D.max_supported_vertex_attribs)){var c=this.enabled?b[b.length-1]:null;c!=this._last_RI&&this._last_RI&&this.disableMorphingGPU(this._last_RI);if((this._last_RI=c)&&c.mesh)if(this._last_base_mesh=c.mesh,this._valid_morphs=this.computeValidMorphs(this._valid_morphs,c.mesh),this.mode===D.AUTOMATIC){if(void 0===
this._morph_texture_supported&&(this._morph_texture_supported=void 0!==gl.extensions.OES_texture_float&&1<gl.getParameter(gl.MAX_VERTEX_TEXTURE_IMAGE_UNITS)),0!=this._valid_morphs.length||D.force_GPU)this._valid_morphs.length<=D.max_supported_morph_targets_using_streams?this.applyMorphTargetsByGPU(c,this._valid_morphs):this._morph_texture_supported?this.applyMorphUsingTextures(c,this._valid_morphs):this.applyMorphBySoftware(c,this._valid_morphs)}else switch(this.mode){case D.STREAMS:this.applyMorphTargetsByGPU(c,
this._valid_morphs);break;case D.TEXTURES:this.applyMorphUsingTextures(c,this._valid_morphs);break;default:this.applyMorphBySoftware(c,this._valid_morphs)}}};D.prototype.computeValidMorphs=function(a,b){a=a||[];a.length=0;if(!b)return a;var c=this.morph_targets.concat();c.sort(function(a,b){return Math.abs(b.weight)-Math.abs(a.weight)});for(var e=0;e<c.length;++e){var g=c[e];if(g.mesh&&!(0.001>Math.abs(g.weight))){var f=d.ResourcesManager.resources[g.mesh];f&&f.constructor===GL.Mesh&&(f.info||(f.info=
{}),f.info.morph_target_from=b.filename,a.push({name:g.mesh,weight:g.weight,mesh:f}))}}return a};D.prototype.applyMorphTargetsByGPU=function(a,b){for(var c=a.mesh,e=c.vertexBuffers.vertices,g={},f=[],h=0;h<b.length&&4>h;++h){var k=b[h],l=k.mesh,m=l.vertexBuffers.vertices;m&&m.data.length==e.data.length&&(l=l.vertexBuffers.normals)&&(m=m.clone(!0),l=l.clone(!0),m.attribute=null,l.attribute=null,g["a_vertex_morph"+h]=m,g["a_normal_morph"+h]=l,f.push(k.weight))}a.vertex_buffers={};for(h in c.vertexBuffers)a.vertex_buffers[h]=
c.vertexBuffers[h];for(h in g)a.vertex_buffers[h]=g[h];a.samplers[d.Renderer.MORPHS_TEXTURE_SLOT]&&(delete a.uniforms.u_morph_vertices_texture,delete a.uniforms.u_morph_normals_texture,a.samplers[d.Renderer.MORPHS_TEXTURE_SLOT]=null,a.samplers[d.Renderer.MORPHS_TEXTURE2_SLOT]=null);c=this._stream_weights;if(c.fill)c.fill(0);else for(h=0;h<c.length;++h)c[h]=0;c.set(f);a.uniforms.u_morph_weights=c;a.uniforms.u_morph_info=this.delta_meshes?1:0;a.addShaderBlock(D.shader_block);a.addShaderBlock(d.MorphDeformer.morphing_streams_block,
this._uniforms);a.removeShaderBlock(d.MorphDeformer.morphing_texture_block)};D.prototype.applyMorphUsingTextures=function(a,b){var c=a.mesh,e=c.vertexBuffers.vertices,g=c.vertexBuffers.normals;e._texture||(e._texture=this.createGeometryTexture(e));g._texture||(g._texture=this.createGeometryTexture(g));var f=[];this._morphtarget_vertices_texture&&this._morphtarget_vertices_texture.height==e._texture.height||(this._morphtarget_vertices_texture=new GL.Texture(e._texture.width,e._texture.height,{format:gl.RGB,
type:gl.FLOAT,filter:gl.NEAREST,wrap:gl.CLAMP_TO_EDGE,no_flip:!1}),this._morphtarget_normals_texture=new GL.Texture(g._texture.width,g._texture.height,{format:gl.RGB,type:gl.FLOAT,filter:gl.NEAREST,wrap:gl.CLAMP_TO_EDGE,no_flip:!1}),this._texture_size=vec4.fromValues(this._morphtarget_vertices_texture.width,this._morphtarget_vertices_texture.height,1/this._morphtarget_vertices_texture.width,1/this._morphtarget_vertices_texture.height));for(c=0;c<b.length;++c){var h=b[c],k=h.mesh,l=k.vertexBuffers.vertices;
l&&l.data.length==e.data.length&&(k=k.vertexBuffers.normals)&&(l._texture||(l._texture=this.createGeometryTexture(l)),k._texture||(k._texture=this.createGeometryTexture(k)),f.push({weight:h.weight,vertices:l._texture,normals:k._texture}))}var m=this.getMorphTextureShader();m.uniforms({u_base_texture:0,u_morph_texture:1});gl.disable(gl.DEPTH_TEST);gl.enable(gl.BLEND);gl.blendFunc(gl.ONE,gl.ONE);e._texture.bind(0);var p=GL.Mesh.getScreenQuad();this._morphtarget_vertices_texture.drawTo(function(){gl.clearColor(0,
0,0,0);gl.clear(gl.COLOR_BUFFER_BIT);for(var a=0;a<f.length;++a)f[a].vertices.bind(1),m.uniforms({u_weight:f[a].weight}),m.draw(p,gl.TRIANGLES)});g._texture.bind(0);this._morphtarget_normals_texture.drawTo(function(){gl.clearColor(0,0,0,0);gl.clear(gl.COLOR_BUFFER_BIT);for(var a=0;a<f.length;++a)f[a].normals.bind(1),m.uniforms({u_weight:f[a].weight}),m.draw(p,gl.TRIANGLES)});gl.disable(gl.BLEND);e=e.data.length/3;if(!this._ids_buffer||this._ids_buffer.data.length!=e){g=new Float32Array(e);for(c=0;c<
e;++c)g[c]=c;this._ids_buffer=new GL.Buffer(gl.ARRAY_BUFFER,g,1,gl.STATIC_DRAW);this._ids_buffer.attribute="a_morphing_ids"}a.uniforms.u_morph_vertices_texture=d.Renderer.MORPHS_TEXTURE_SLOT;a.samplers[d.Renderer.MORPHS_TEXTURE_SLOT]=this._morphtarget_vertices_texture;a.uniforms.u_morph_normals_texture=d.Renderer.MORPHS_TEXTURE2_SLOT;a.samplers[d.Renderer.MORPHS_TEXTURE2_SLOT]=this._morphtarget_normals_texture;a.uniforms.u_morph_texture_size=this._texture_size;a.vertex_buffers.a_morphing_ids=this._ids_buffer;
a.addShaderBlock(D.shader_block);a.addShaderBlock(d.MorphDeformer.morphing_texture_block,{u_morph_vertices_texture:d.Renderer.MORPHS_TEXTURE_SLOT,u_morph_normals_texture:d.Renderer.MORPHS_TEXTURE2_SLOT,u_morph_texture_size:this._texture_size});a.removeShaderBlock(d.MorphDeformer.morphing_streams_block)};D.prototype.disableMorphingGPU=function(a){a&&(a.samplers[d.Renderer.MORPHS_TEXTURE_SLOT]&&(a.samplers[d.Renderer.MORPHS_TEXTURE_SLOT]=null,a.samplers[d.Renderer.MORPHS_TEXTURE2_SLOT]=null,delete a.uniforms.u_morph_vertices_texture,
delete a.uniforms.u_morph_normals_texture),a.removeShaderBlock(d.MorphDeformer.shader_block),a.removeShaderBlock(d.MorphDeformer.morphing_streams_block),a.removeShaderBlock(d.MorphDeformer.morphing_texture_block))};D.prototype.applyMorphBySoftware=function(a,b){var c=a.mesh,e=c.vertexBuffers.vertices;this.disableMorphingGPU(a);for(var d="",e=0;e<b.length;++e)var f=b[e],d=d+(f.name+"|"+f.weight.toFixed(2)+"|");if(d==this._last_key)this._final_vertices_buffer&&(a.vertex_buffers.vertices=this._final_vertices_buffer),
this._final_normals_buffer&&(a.vertex_buffers.normals=this._final_normals_buffer);else{this._last_key=d;e=c.vertexBuffers.vertices;d=e.data;c=c.vertexBuffers.normals.data;this._final_vertices&&this._final_vertices.length==d.length||(this._final_vertices=new Float32Array(d.length),this._final_vertices_buffer=new GL.Buffer(gl.ARRAY_BUFFER,this._final_vertices,3,gl.STREAM_DRAW),this._final_vertices_buffer.attribute="a_vertex");this._final_normals&&this._final_normals.length==c.length||(this._final_normals=
new Float32Array(c.length),this._final_normals_buffer=new GL.Buffer(gl.ARRAY_BUFFER,this._final_normals,3,gl.STREAM_DRAW),this._final_normals_buffer.attribute="a_normal");var h=this._final_vertices,k=this._final_normals;h.set(d);k.set(c);for(var l=[],m=[],p=[],n=b.length,e=0;e<b.length;++e)f=b[e],l.push(f.mesh.vertexBuffers.vertices.data),m.push(f.mesh.vertexBuffers.normals.data),p.push(f.weight);if(this.delta_meshes)for(e=0,f=h.length;e<f;e+=3)for(var r=h.subarray(e,e+3),t=k.subarray(e,e+3),x=0;x<
n;++x){var u=l[x],L=m[x],q=p[x];r[0]+=u[e]*q;r[1]+=u[e+1]*q;r[2]+=u[e+2]*q;t[0]+=L[e]*q;t[1]+=L[e+1]*q;t[2]+=L[e+2]*q}else for(e=0,f=h.length;e<f;e+=3)for(r=h.subarray(e,e+3),t=k.subarray(e,e+3),x=0;x<n;++x)u=l[x],L=m[x],q=p[x],r[0]+=(u[e]-d[e])*q,r[1]+=(u[e+1]-d[e+1])*q,r[2]+=(u[e+2]-d[e+2])*q,t[0]+=(L[e]-c[e])*q,t[1]+=(L[e+1]-c[e+1])*q,t[2]+=(L[e+2]-c[e+2])*q;this._final_vertices_buffer.upload(gl.STREAM_DRAW);this._final_normals_buffer.upload(gl.STREAM_DRAW);a.vertex_buffers.vertices=this._final_vertices_buffer;
a.vertex_buffers.normals=this._final_normals_buffer}};D._blend_shader_fragment_code="\n\tprecision highp float;\n\tuniform sampler2D u_base_texture;\n\tuniform sampler2D u_morph_texture;\n\tuniform float u_weight;\n\tvarying vec2 v_coord;\n\tvoid main() {\n\t\tgl_FragColor = u_weight * ( texture2D(u_morph_texture, v_coord) - texture2D(u_base_texture, v_coord) );\n\t\tgl_FragColor.w = 1.0;\n\t}\n";D._delta_blend_shader_fragment_code="\n\tprecision highp float;\n\tuniform sampler2D u_morph_texture;\n\tuniform float u_weight;\n\tvarying vec2 v_coord;\n\tvoid main() {\n\t\tgl_FragColor = u_weight * texture2D(u_morph_texture, v_coord);\n\t\tgl_FragColor.w = 1.0;\n\t}\n";
D.prototype.getMorphTextureShader=function(){if(this.delta_meshes)return this._delta_blend_shader||(this._delta_blend_shader=new GL.Shader(Shader.SCREEN_VERTEX_SHADER,D._delta_blend_shader_fragment_code)),this._delta_blend_shader;this._blend_shader||(this._blend_shader=new GL.Shader(Shader.SCREEN_VERTEX_SHADER,D._blend_shader_fragment_code));return this._blend_shader};D.prototype.createGeometryTexture=function(a,b){var c=a.data,e=gl.getParameter(gl.MAX_TEXTURE_SIZE),d=c.length/3,e=Math.min(e,d),d=
Math.ceil(d/e),f=new Float32Array(e*d*3);f.set(c);b&&b.width==e&&b.height==d?b.uploadData(f):b=new GL.Texture(e,d,{format:gl.RGB,type:gl.FLOAT,filter:gl.NEAREST,wrap:gl.CLAMP_TO_EDGE,pixel_data:f,no_flip:!1});return b};D.prototype.recomputeGeometryTextures=function(){var a=this._last_RI;if(a){var b=a.mesh,a=b.vertexBuffers.vertices,b=b.vertexBuffers.normals;a._texture=this.createGeometryTexture(a,a._texture);b._texture=this.createGeometryTexture(b,b._texture);if(a=this._valid_morphs)for(b=0;b<a.length;++b){var c=
a[b].mesh,e=c.vertexBuffers.vertices;e&&e._texture&&this.createGeometryTexture(e,e._texture);(c=c.vertexBuffers.normals)&&c._texture&&this.createGeometryTexture(c,c._texture)}}};D.prototype.getMorphIndex=function(a){if(a=this._morph_targets_by_name[a])if(a=this.morph_targets.indexOf(a),-1!=a)return a;for(a=0;a<this.morph_targets.length;++a)if(this.morph_targets[a].mesh==mesh_name)return a;return-1};D.prototype.removeMorph=function(a){if(!(a>=this.morph_targets.length)){var b=this.morph_targets[a];
b&&(this.morph_targets.splice(a,1),b.name&&delete this._morph_targets_by_name[b.name])}};D.prototype.setMorphMesh=function(a,b){a>=this.morph_targets.length||(this.morph_targets[a].mesh=b)};D.prototype.setMorphWeight=function(a,b){a>=this.morph_targets.length||isNaN(b)||(this.morph_targets[a].weight=b)};D.prototype.setMorphName=function(a,b){if(!(a>=this.morph_targets.length)){var c=this.morph_targets[a];c&&c.name!=b&&(this._morph_targets_by_name[b]&&this._morph_targets_by_name[b]!=c&&console.warn("There is already a morph target with that name: ",
b),c.name=b,this._morph_targets_by_name[b]=c)}};D.prototype.getPrettyName=function(a,b,c){if("weight"==c[c.length-1]&&(b=this.morph_targets.map(function(a){return a.mesh}),b=D.removeSharedString(b),c=this.morph_targets.indexOf(a.target),-1!=c))return b=b[c].replace(/_/g," "),a.node.name+"::"+b};D.removeSharedString=function(a){var b=computeSharedInitialString(a);return a=a.map(function(a){a=a.substr(b);var e=a.lastIndexOf(".");return-1!=e?a.substr(0,e):a})};D.prototype.getPropertyInfoFromPath=function(a){if("morphs"==
a[0]){if(1==a.length)return{node:this._root,target:this.morph_targets,type:"object"};var b=parseInt(a[1]);if(!(b>=this.morph_targets.length)&&(a=a[2],"mesh"==a||"weight"==a))return{node:this._root,component:this,target:this.morph_targets[b],name:a,value:void 0!==this.morph_targets[b][a]?this.morph_targets[b][a]:null,type:"mesh"==a?"mesh":"number"}}};D.prototype.setPropertyValueFromPath=function(a,b,c){c=c||0;if(!(a.length<c+1||isNaN(b)||"morphs"!=a[c])){var e=parseInt(a[c+1]);e>=this.morph_targets.length||
(this.morph_targets[e][a[c+2]]=b)}};D.prototype.setProperty=function(a,b){if("enabled"==a)this.enabled=b;else if("morph"==a.substr(0,5)){a=a.substr(5);var c=a.split("_"),e=parseInt(c[0]);0<=e&&e<this.morph_targets.length&&("weight"==c[1]?isNaN(b)||(this.morph_targets[e].weight=b):"mesh"==c[1]&&(this.morph_targets[e].mesh=b))}else"weights"==a?this.weights=b:"name_weights"==a?this.name_weights=b:"mesh_weights"==a&&(this.mesh_weights=b)};D.prototype.getProperty=function(a){if("morph"==a.substr(0,5)&&
5<a.length){a=a.substr(5).split("_");var b=this.morph_targets[Number(a[0])];if(b)return"mesh"==a[1]?b.mesh:"weight"==a[1]?b.weight:b}};D.prototype.getPropertiesInfo=function(){for(var a={enabled:"boolean",weights:"array",name_weights:"object",mesh_weights:"object"},b=0;b<this.morph_targets.length;b++)a["morph"+b+"_weight"]="number";return a};D.prototype.getBaseMesh=function(){if(!this._root)return null;if(this._last_base_mesh)return this._last_base_mesh;var a=this._root.getComponent(d.Components.MeshRenderer);
return a?d.ResourcesManager.resources[a.mesh]:null};D.prototype.optimizeMorphTargets=function(){for(var a=this.getBaseMesh(),b=this.morph_targets.concat(),c=0;c<b.length;++c){var e=b[c],g=d.ResourcesManager.meshes[e.mesh];if(g)if(g.removeVertexBuffer("coords",!0),g.removeIndexBuffer("triangles",!0),g.removeIndexBuffer("wireframe",!0),a&&0.1>D.computeMeshDifference(a,g)){var f=g.fullpath||g.filename;console.log("morph target is too similar to base mesh, removing it: "+f);e=this.morph_targets.indexOf(e);
this.morph_targets.splice(e,1);d.ResourcesManager.unregisterResource(f);(g=g.from_pack||g.from_prefab)&&(g=d.ResourcesManager.resources[g])&&g.removeResource(f)}else d.ResourcesManager.resourceModified(g)}console.log("Morph targets optimized")};D.computeMeshDifference=function(a,b){if(!(a&&b&&a.vertexBuffers.vertices&&b.vertexBuffers.vertices))return 0;var c=a.vertexBuffers.vertices.data,e=b.vertexBuffers.vertices.data;if(!c||!e||c.length!=e.length)return 0;for(var d=0,f=0;f<c.length;f+=3)d+=vec3.distance(c.subarray(f,
f+3),e.subarray(f,f+3));return d};D.prototype.onInspectNode=function(a,b){var c=this;a.addButton(null,"Add weights' inputs",{callback:function(){for(var a=0;a<c.morph_targets.length;++a)-1==b.findInputSlot("morph_"+a+"_weight")&&b.addInput("morph_"+a+"_weight","number");b.setDirtyCanvas(!0)}})};d.registerComponent(D);d.MorphDeformer=D;D.morph_streams_enabled_shader_code="\n\t\n\t//max vertex attribs are 16 usually, so 10 are available after using 6 for V,N,UV,UV2,BW,BI\n\tattribute vec3 a_vertex_morph0;\n\tattribute vec3 a_normal_morph0;\n\tattribute vec3 a_vertex_morph1;\n\tattribute vec3 a_normal_morph1;\n\tattribute vec3 a_vertex_morph2;\n\tattribute vec3 a_normal_morph2;\n\tattribute vec3 a_vertex_morph3;\n\tattribute vec3 a_normal_morph3;\n\t\n\tuniform vec4 u_morph_weights;\n\tuniform float u_morph_info;\n\t\n\tvoid applyMorphing( inout vec4 position, inout vec3 normal )\n\t{\n\t\tvec3 original_vertex = vec3(0.0);\n\t\tvec3 original_normal = vec3(0.0);\n\t\tif( u_morph_info == 0.0 )\n\t\t{\n\t\t\toriginal_vertex = position.xyz;\n\t\t\toriginal_normal = normal.xyz;\n\t\t}\n\t\t\n\t\tif(u_morph_weights[0] != 0.0)\n\t\t{\n\t\t\tposition.xyz += (a_vertex_morph0 - original_vertex) * u_morph_weights[0]; normal.xyz += (a_normal_morph0 - original_normal) * u_morph_weights[0];\n\t\t}\n\t\tif(u_morph_weights[1] != 0.0)\n\t\t{\n\t\t\tposition.xyz += (a_vertex_morph1 - original_vertex) * u_morph_weights[1]; normal.xyz += (a_normal_morph1 - original_normal) * u_morph_weights[1];\n\t\t}\n\t\tif(u_morph_weights[2] != 0.0)\n\t\t{\n\t\t\tposition.xyz += (a_vertex_morph2 - original_vertex) * u_morph_weights[2]; normal.xyz += (a_normal_morph2 - original_normal) * u_morph_weights[2];\n\t\t}\n\t\tif(u_morph_weights[3] != 0.0)\n\t\t{\n\t\t\tposition.xyz += (a_vertex_morph3 - original_vertex) * u_morph_weights[3]; normal.xyz += (a_normal_morph3 - original_normal) * u_morph_weights[3];\n\t\t}\n\t}\n";
D.morph_texture_enabled_shader_code="\n\t\n\tattribute float a_morphing_ids;\n\t\n\tuniform sampler2D u_morph_vertices_texture;\n\tuniform sampler2D u_morph_normals_texture;\n\tuniform vec4 u_morph_texture_size;\n\t\n\tuniform vec4 u_morph_weights;\n\t\n\tvoid applyMorphing( inout vec4 position, inout vec3 normal )\n\t{\n\t\tvec2 coord;\n\t\tcoord.x = ( mod( a_morphing_ids, u_morph_texture_size.x ) + 0.5 ) / u_morph_texture_size.x;\n\t\tcoord.y = 1.0 - ( floor( a_morphing_ids / u_morph_texture_size.x ) + 0.5 ) / u_morph_texture_size.y;\n\t\tposition.xyz += texture2D( u_morph_vertices_texture, coord ).xyz;\n\t\tnormal.xyz += texture2D( u_morph_normals_texture, coord ).xyz;\n\t}\n";
D.morph_enabled_shader_code="\n\t\n\t#pragma shaderblock morphing_mode\n";D.morph_disabled_shader_code="\nvoid applyMorphing( inout vec4 position, inout vec3 normal ) {}\n";var sc=new d.ShaderBlock("morphing");sc.addCode(GL.VERTEX_SHADER,D.morph_enabled_shader_code,D.morph_disabled_shader_code);sc.register();D.shader_block=sc;var ac=new d.ShaderBlock("morphing_streams");ac.defineContextMacros({morphing_mode:"morphing_streams"});ac.addCode(GL.VERTEX_SHADER,D.morph_streams_enabled_shader_code,D.morph_disabled_shader_code);
ac.register();D.morphing_streams_block=ac;var bc=new d.ShaderBlock("morphing_texture");bc.defineContextMacros({morphing_mode:"morphing_texture"});bc.addCode(GL.VERTEX_SHADER,D.morph_texture_enabled_shader_code,D.morph_disabled_shader_code);bc.register();D.morphing_texture_block=bc;K.icon="mini-icon-stickman.png";K.MAX_UNIFORM_BONES=64;K.MAX_TEXTURE_BONES=256;K.gpu_skinning_supported=!0;K.icon="mini-icon-stickman.png";K.apply_to_normals_by_software=!1;K["@skeleton_root_node"]={type:d.TYPES.SCENENODE};
K.prototype.onAddedToNode=function(a){LEvent.bind(a,"collectRenderInstances",this.onCollectInstances,this)};K.prototype.onRemovedFromNode=function(a){LEvent.unbind(a,"collectRenderInstances",this.onCollectInstances,this)};K.prototype.getBoneNode=function(a){var b=this._root,c=b.scene;if(!c)return null;if(this.skeleton_root_node){if(b=c.getNode(this.skeleton_root_node))return b.findNodeByName(a)}else return this.search_bones_in_parent?b.parentNode.findNode(a):c.getNode(a);return null};K.prototype.getBoneMatrix=
function(a){if(this._skeleton)return this._skeleton.getBoneMatrix(a);a=this.getBoneNode(a);if(!a)return null;a._is_bone=!0;return a.transform.getGlobalMatrixRef()};K.prototype.getBoneMatrices=function(a){var b=this._last_bones;if(!this._last_bones||this._last_bones.length!=a.bones.length)for(var b=this._last_bones=[],c=0;c<a.bones.length;++c)b[c]=mat4.create();if(this._skeleton)return c=this._root.transform?this._root.transform.getGlobalMatrixRef():null,this._skeleton.computeFinalBoneMatricesAsArray(b,
a,c),b;for(c=0;c<a.bones.length;++c){var e=b[c],d=a.bones[c],f=this.getBoneMatrix(d[0]);f?(mat4.multiply(e,f,d[1]),a.bind_matrix&&mat4.multiply(e,e,a.bind_matrix)):mat4.identity(e)}return b};K.prototype.onCollectInstances=function(a,b){if(b.length&&this.root){var c,e=this.root.getIndexOfComponent(this);if(e=this.root.getComponentByIndex(e-1))c=e._RI;c&&(this._ris_skinned.length=0,this.enabled?this.applySkinning(c):this.disableSkinning(c))}};K.prototype.applySkinning=function(a){var b=a.mesh;this._mesh=
b;this._ris_skinned.push(a);if(b&&b.getBuffer("vertices")&&b.getBuffer("bone_indices")){var c=null,e=this._u_bones;if(K.gpu_skinning_supported&&!this.cpu_skinning){c=this.getBoneMatrices(b);b=12*c.length;if(!b){console.warn("SkinDeformer.prototype.applySkinning: Bones not found");return}e&&e.length==b||(this._u_bones=e=new Float32Array(b));for(var g=0;g<c.length;g++)mat4.transpose(c[g],c[g]),e.set(c[g].subarray(0,12),12*g,12*(g+1));K.num_supported_uniforms>=b&&c.length<K.MAX_UNIFORM_BONES?(a.uniforms.u_bones=
e,a.samplers[d.Renderer.BONES_TEXTURE_SLOT]=null,a.addShaderBlock(d.SkinDeformer.skinning_uniforms_block,{u_bones:e})):0<K.num_supported_textures?(g=this._bones_texture,g||(g=this._bones_texture=new GL.Texture(1,3*K.MAX_TEXTURE_BONES,{format:gl.RGBA,type:gl.FLOAT,filter:gl.NEAREST}),g._data=new Float32Array(g.width*g.height*4)),g._data.set(e),g.uploadData(g._data,{no_flip:!0}),d.RM.textures[":bones_"+this.uid]=g,a.uniforms.u_bones=d.Renderer.BONES_TEXTURE_SLOT,a.samplers[d.Renderer.BONES_TEXTURE_SLOT]=
g,a.addShaderBlock(d.SkinDeformer.skinning_texture_block,{u_bones:d.Renderer.BONES_TEXTURE_SLOT})):console.error("impossible to get here");a.addShaderBlock(d.SkinDeformer.skinning_block)}else{if(!this._skinned_mesh||this._skinned_mesh._reference!=b){this._skinned_mesh=new GL.Mesh;this._skinned_mesh._reference=b;var f=b.getBuffer("vertices"),h=b.getBuffer("normals");for(g in b.vertexBuffers)this._skinned_mesh.vertexBuffers[g]=b.vertexBuffers[g];for(g in b.indexBuffers)this._skinned_mesh.indexBuffers[g]=
b.indexBuffers[g];this._skinned_mesh.createVertexBuffer("vertices","a_vertex",3,new Float32Array(f.data),gl.STREAM_DRAW);h&&this._skinned_mesh.createVertexBuffer("normals","a_normal",3,new Float32Array(h.data),gl.STREAM_DRAW)}this.applySoftwareSkinning(b,this._skinned_mesh);a.setMesh(this._skinned_mesh,this.primitive);this.disableSkinning(a)}this.ignore_transform?(mat4.identity(a.matrix),a.normal_matrix.set(a.matrix)):this._root.transform.getGlobalMatrix(a.matrix);if(c&&c.length){a.center.set(d.ZEROS);
for(g=0;g<c.length;++g)a.center[0]+=c[g][3],a.center[1]+=c[g][7],a.center[2]+=c[g][11];a.center[0]/=c.length;a.center[1]/=c.length;a.center[2]/=c.length}else e&&(a.center[0]=e[9],a.center[1]=e[10],a.center[2]=e[11]);mat4.getTranslation(a.position,a.matrix);a.use_bounding=!1}};K.prototype.disableSkinning=function(a){this._mesh=null;a.samplers.u_bones&&delete a.samplers.u_bones;a.removeShaderBlock(d.SkinDeformer.skinning_block);a.removeShaderBlock(d.SkinDeformer.skinning_uniforms_block);a.removeShaderBlock(d.SkinDeformer.skinning_texture_block)};
K.prototype.getMesh=function(){return this._mesh};K.prototype.applySoftwareSkinning=function(a,b){var c=a.getBuffer("vertices").data,e=null;a.getBuffer("normals")&&(e=a.getBuffer("normals").data);var d=a.getBuffer("weights").data,f=a.getBuffer("bone_indices").data,h=b.getBuffer("vertices"),k=h.data,l=null,m=null;K.zero_matrix||(K.zero_matrix=new Float32Array(16));var p=K.zero_matrix;e&&(l=b.getBuffer("normals"),m=l.data);var n=this.getBoneMatrices(a);if(0==n.length)return null;for(var r=vec3.create(),
t=vec3.create(),x=mat4.create(),u=0,L=k.length/3;u<L;++u){c.subarray(3*u,3*u+3);var q=f.subarray(4*u,4*u+4),s=d.subarray(4*u,4*u+4),G=k.subarray(3*u,3*u+3),q=[n[q[0]],n[q[1]],n[q[2]],n[q[3]]];x.set(p);mat4.scaleAndAdd(x,x,q[0],s[0]);0<s[1]&&mat4.scaleAndAdd(x,x,q[1],s[1]);0<s[2]&&mat4.scaleAndAdd(x,x,q[2],s[2]);0<s[3]&&mat4.scaleAndAdd(x,x,q[3],s[3]);mat4.multiplyVec3(G,x,c.subarray(3*u,3*u+3));if(m){var v=m.subarray(3*u,3*u+3);mat4.rotateVec3(v,x,e.subarray(3*u,3*u+3))}if(K.apply_to_normals_by_software)for(G[0]=
G[1]=G[2]=0,mat4.multiplyVec3(G,q[0],t),vec3.scale(G,G,s[0]),v=1;4>v;++v)0<s[v]&&(mat4.multiplyVec3(r,q[v],t),vec3.scaleAndAdd(G,G,r,s[v]))}h.upload(gl.STREAM_DRAW);l&&l.upload(gl.STREAM_DRAW)};K.prototype.extractSkeleton=function(){};K.prototype.applyBindPose=function(){var a=this._mesh;if(a&&a.bones){mat4.create();for(var a=this.getBones(),b=0;b<a.length;++b){var c=a[b];c._level=c.getHierarchyLevel()}}};K.prototype.getBones=function(){var a=this._mesh;if(!a&&!a.bones)return null;var b=[],c;for(c in a.bones){var e=
this.getBoneNode(a.bones[c][0]);e&&b.push(e)}return b};d.registerComponent(K);d.SkinDeformer=K;K.skinning_shader_code="\n\t//Skinning ******************* \n\t#ifndef MAX_BONES\n\t\t#define MAX_BONES "+K.MAX_UNIFORM_BONES+"\n\t#endif\n\t#ifdef USE_SKINNING_TEXTURE\n\t\tuniform sampler2D u_bones;\n\t#else\n\t\tuniform vec4 u_bones[ MAX_BONES * 3];\n\t#endif\n\tattribute vec4 a_weights;\n\tattribute vec4 a_bone_indices;\n\t\n\tvoid getMat(int id, inout mat4 m) {\n\t\n\t\t#ifdef USE_SKINNING_TEXTURE\n\t\t\tfloat i_max_texture_bones_offset = 1.0 / ("+
K.MAX_TEXTURE_BONES+".0 * 3.0);\n\t\t\tm[0] = texture2D( u_bones, vec2( 0.0, (float(id*3)+0.5) * i_max_texture_bones_offset ) ); \n\t\t\tm[1] = texture2D( u_bones, vec2( 0.0, (float(id*3+1)+0.5) * i_max_texture_bones_offset ) );\n\t\t\tm[2] = texture2D( u_bones, vec2( 0.0, (float(id*3+2)+0.5) * i_max_texture_bones_offset ) );\n\t\t#else\n\t\t\tm[0] = u_bones[ id * 3];\n\t\t\tm[1] = u_bones[ id * 3 + 1];\n\t\t\tm[2] = u_bones[ id * 3 + 2];\n\t\t#endif\n\t}\n\t\n\tmat3 mat3_emu(mat4 m4) {\n\t  return mat3(\n\t\t  m4[0][0], m4[0][1], m4[0][2],\n\t\t  m4[1][0], m4[1][1], m4[1][2],\n\t\t  m4[2][0], m4[2][1], m4[2][2]);\n\t}\n\t\n\tvoid applySkinning(inout vec4 position, inout vec3 normal)\n\t{\n\t\t//toji version seems faster\n\t\tmat4 bone_matrix = mat4(0.0,0.0,0.0,0.0, 0.0,0.0,0.0,0.0, 0.0,0.0,0.0,0.0, 0.0,0.0,0.0,1.0);\n\t\t\n\t\tgetMat( int(a_bone_indices.x), bone_matrix );\n\t\tmat4 result = a_weights.x * bone_matrix;\n\t\tgetMat( int(a_bone_indices.y), bone_matrix);\n\t\tresult = result + a_weights.y * bone_matrix;\n\t\tgetMat( int(a_bone_indices.z), bone_matrix);\n\t\tresult = result + a_weights.z * bone_matrix;\n\t\tgetMat( int(a_bone_indices.w), bone_matrix);\n\t\tresult = result + a_weights.w * bone_matrix;\n\t\t\n\t\tposition.xyz = (position * result).xyz;\n\t\tnormal = normal * mat3_emu(result);\n\t}\n";
K.skinning_enabled_shader_code="\n#pragma shaderblock skinning_mode\n#define USING_SKINNING\n";K.skinning_disabled_shader_code="\nvoid applySkinning( inout vec4 position, inout vec3 normal) {}\n";var tc=new d.ShaderBlock("skinning");tc.addCode(GL.VERTEX_SHADER,K.skinning_enabled_shader_code,K.skinning_disabled_shader_code);tc.register();K.skinning_block=tc;var cc=new d.ShaderBlock("skinning_uniforms");cc.defineContextMacros({skinning_mode:"skinning_uniforms"});cc.addCode(GL.VERTEX_SHADER,K.skinning_shader_code,
K.skinning_disabled_shader_code);cc.register();K.skinning_uniforms_block=cc;var dc=new d.ShaderBlock("skinning_texture");dc.defineContextMacros({skinning_mode:"skinning_texture"});dc.addCode(GL.VERTEX_SHADER,"\n#define USE_SKINNING_TEXTURE\n"+K.skinning_shader_code,K.skinning_disabled_shader_code);dc.register();K.skinning_texture_block=dc;ab.icon="mini-icon-teapot.png";ab["@svg"]={type:"resource"};ab.prototype.onAddedToScene=function(a){};ab.prototype.onRemovedFromScene=function(a){};ab.prototype.onAddedToNode=
function(a){LEvent.bind(a,"collectRenderInstances",this.onCollectInstances,this);this._RI.node=a};ab.prototype.onRemovedFromNode=function(a){LEvent.unbind(a,"collectRenderInstances",this.onCollectInstances,this)};ab.prototype.getMesh=function(){if(!this.svg)return null;var a=d.ResourcesManager.getResource(this.svg),b=null;this._svg_data===a&&(b=this._mesh);b||(b=this._mesh=GL.Mesh.cube());return b};ab.prototype.onCollectInstances=function(a,b){if(this._enabled){var c=this.getMesh();if(!c)return null;
if(this._root){var e=this._RI;e.setMatrix(this._root.transform._global_matrix);mat4.multiplyVec3(e.center,e.matrix,d.ZEROS);var g=this._root.getMaterial();e.setMaterial(g);e.setMesh(c,GL.TRIANGLES);e.setRange(0,-1);e.collision_mesh=c;b.push(e)}}};ab.prototype.configure=function(a){void 0!==a.enabled&&(this.enabled=a.enabled);this.svg=a.svg};ab.prototype.serialize=function(){return{enabled:this.enabled,svg:this.svg}};ab.prototype.getResources=function(a){"string"==typeof this.svg&&(a[this.svg]=d.Resource);
return a};ab.prototype.onResourceRenamed=function(a,b,c){this.svg==a&&(this.svg=b)};Ea.icon="mini-icon-dome.png";Ea["@material"]={type:d.TYPES.MATERIAL};Ea["@texture"]={type:d.TYPES.TEXTURE};Ea.prototype.onAddedToNode=function(a){LEvent.bind(a,"collectRenderInstances",this.onCollectInstances,this)};Ea.prototype.onRemovedFromNode=function(a){LEvent.unbind(a,"collectRenderInstances",this.onCollectInstances,this)};Ea.prototype.onAddedToScene=function(a){LEvent.bind(a,"start",this.onStart,this)};Ea.prototype.onRemovedFromScene=
function(a){LEvent.unbind(a,"start",this.onStart,this)};Object.defineProperty(Ea.prototype,"intensity",{set:function(a){this._intensity=a;this._material&&this._material._color.set([a,a,a,1])},get:function(){return this._intensity},enumerable:!0});Object.defineProperty(Ea.prototype,"bake_to_cubemap",{set:function(a){(this._bake_to_cubemap=a)&&this.bakeToCubemap()},get:function(){return this._bake_to_cubemap},enumerable:!0});Ea.prototype.getResources=function(a){this.texture&&this.texture.constructor===
String&&(a[this.texture]=GL.Texture);this.material&&this.material.constructor===String&&(a[this.material]=d.Material);return a};Ea.prototype.onResourceRenamed=function(a,b,c){this.texture==a&&(this.texture=b)};Ea.prototype.onCollectInstances=function(a,b){if(this._root&&this.enabled){var c=this._mesh;c||(c=this._mesh=GL.Mesh.cube({size:10}));var e=this._render_instance;e||(this._render_instance=e=new d.RenderInstance(this._root,this),e.priority=100,e.onPreRender=function(a){a=d.Renderer._current_camera.getEye();
mat4.identity(this.matrix);mat4.setTranslation(this.matrix,a);if(this.node.transform){var b=this.node.transform.getGlobalRotationMatrix();mat4.multiply(this.matrix,this.matrix,b)}vec3.copy(this.center,a)});var g=null;if(this.material)g=d.ResourcesManager.getResource(this.material);else{var f=null,f=this.use_environment&&d.Renderer._current_scene.info?d.Renderer._current_scene.info.textures.environment:this.texture;if(!f)return;var h=d.ResourcesManager.textures[f];if(!h)return;(g=this._material)?g.color.set([this.intensity,
this.intensity,this.intensity]):(g=this._material=new d.ShaderMaterial({flags:{two_sided:!0,cast_shadows:!1,receive_shadows:!1,ignore_frustum:!0,ignore_lights:!0,depth_test:!1},use_scene_ambient:!1,color:[this.intensity,this.intensity,this.intensity]}),g.shader_code=new d.ShaderCode(Ea.shader_code));if(h=d.RM.textures[f])h.texture_type==GL.TEXTURE_2D?(g._uniforms.u_tex_type=0,g.setProperty("texture2D",f)):(g._uniforms.u_tex_type=1,g.setProperty("textureCube",f))}e.setMesh(c);e.setMaterial(g);b.push(e);
this.material&&g&&this._bake_to_cubemap&&(this._prev_mat!=g||this._mat_version!=g.version)&&(this._prev_mat=g,this._mat_version=g.version,this.bakeToCubemap())}};Ea.prototype.onStart=function(a){this._bake_to_cubemap&&this.bakeToCubemap()};Ea.prototype.bakeToCubemap=function(a,b){var c=this;a=a||512;b=b||new d.RenderSettings;if(this.root&&this.root.scene){var e=this.root.scene;if(this._render_instance&&this._render_instance.material){var g=[];this.onCollectInstances(null,g);d.Renderer.processVisibleData(e,
b,null,g,!0);b.render_helpers=!1;this._baked_texture=d.Renderer.renderToCubemap(vec3.create(),a,this._baked_texture,b,0.001,100,vec4.create(),g);d.ResourcesManager.registerResource(":baked_skybox",this._baked_texture);this.root.scene.info&&(this.root.scene.info.textures.environment=":baked_skybox")}else setTimeout(function(){c.bakeToCubemap.bind(c)},500)}};Ea.shader_code='\n\\js\n\tthis.createSampler("texture2D","u_color_texture", { magFilter: GL.LINEAR, missing: "white"} );\n\tthis.createSampler("textureCube","u_color_cubemap", { magFilter: GL.LINEAR, missing: "white"} );\n\tthis.queue = ONE.RenderQueue.BACKGROUND;\n\tthis.render_state.cull_face = false;\n\tthis.render_state.front_face = GL.CW;\n\tthis.render_state.depth_test = false;\n\tthis.flags.ignore_frustum = true;\n\tthis.flags.ignore_lights = true;\n\tthis.flags.cast_shadows = false;\n\tthis.flags.receive_shadows = false;\n\n\\default.vs\n\tprecision mediump float;\n\tattribute vec3 a_vertex;\n\tvarying vec3 v_world_position;\n\tuniform mat4 u_model;\n\tuniform mat4 u_viewprojection;\n\tvoid main() {\n\t\tvec4 vertex4 = u_model * vec4(a_vertex,1.0);\n\t\tv_world_position = vertex4.xyz;\n\t\tgl_Position = u_viewprojection * vertex4;\n\t}\n\\default.fs\n\tprecision mediump float;\n\tvarying vec3 v_world_position;\n\tuniform vec4 u_material_color;\n\tuniform vec3 u_camera_eye;\n\tuniform int u_tex_type;\n\tuniform samplerCube u_color_cubemap;\n\tuniform sampler2D u_color_texture;\n\tvec2 polarToCartesian(in vec3 V)\n\t{\n\t\treturn vec2( 0.5 - (atan(V.z, V.x) / -6.28318531), asin(V.y) / 1.57079633 * 0.5 + 0.5);\n\t}\n\tvoid main() {\n\t\tvec3 E = normalize( v_world_position - u_camera_eye);\n\t\tvec4 color;\n\t\tif( u_tex_type == 0 )\n\t\t\tcolor = texture2D( u_color_texture, polarToCartesian(E) );\n\t\telse\n\t\t\tcolor = textureCube( u_color_cubemap, E );\n\t\tgl_FragColor = u_material_color * color;\n\t}\n';
d.registerComponent(Ea);d.Skybox=Ea;db.icon="mini-icon-bg.png";db["@texture"]={type:"texture"};db["@material_name"]={type:"material"};db["@blend_mode"]={type:"enum",values:d.Blend};db["@opacity"]={type:"number",step:0.01};db.prototype.onAddedToNode=function(a){LEvent.bind(a,"collectRenderInstances",this.onCollectInstances,this)};db.prototype.onRemovedFromNode=function(a){LEvent.unbind(a,"collectRenderInstances",this.onCollectInstances,this)};db.prototype.getResources=function(a){"string"==typeof this.texture&&
(a[this.texture]=GL.Texture);return a};db.prototype.onResourceRenamed=function(a,b,c){this.texture==a&&(this.texture=b)};db.prototype.onCollectInstances=function(a,b){if(this.enabled){var c=null;this.material_name&&(c=d.ResourcesManager.materials[this.material_name]);if(!c){var e=this.texture;if(!e)return;e.constructor===String&&(e=d.ResourcesManager.textures[e]);c=this._material?this._material:this._material=new d.StandardMaterial({shader:"lowglobal",queue:d.RenderQueue.BACKGROUND,flags:{cast_shadows:!1,
ignore_lights:!0,two_sided:!0,depth_test:!1,ignore_frustum:!0},use_scene_ambient:!1});c.setTexture("color",e);c.color.set(this.color);c.opacity=this.opacity;c.blend_mode=this.blend_mode}e=this._mesh;e||(e=this._mesh=GL.Mesh.plane({size:2}));var g=this._render_instance;g||(this._render_instance=g=new d.RenderInstance(this._root,this));g.setMesh(e);g.setMaterial(c);b.push(g)}};Aa.icon="mini-icon-collider.png";Aa.PLANE=d.PhysicsInstance.PLANE;Aa.BOX=d.PhysicsInstance.BOX;Aa.SPHERE=d.PhysicsInstance.SPHERE;
Aa.MESH=d.PhysicsInstance.MESH;Aa["@size"]={type:"vec3",step:0.01};Aa["@center"]={type:"vec3",step:0.01};Aa["@mesh"]={type:"mesh"};Aa["@shape"]={type:"enum",values:{Plane:Aa.PLANE,Box:Aa.BOX,Sphere:Aa.SPHERE,Mesh:Aa.MESH}};Aa.prototype.onAddedToScene=function(a){LEvent.bind(a,"collectPhysicInstances",this.onGetColliders,this)};Aa.prototype.onRemovedFromScene=function(a){LEvent.unbind(a,"collectPhysicInstances",this.onGetColliders,this)};Aa.prototype.getMesh=function(){return"string"===typeof this.mesh?
d.ResourcesManager.meshes[this.mesh]:this.mesh};Aa.prototype.getResources=function(a){if(this.mesh)return"string"==typeof this.mesh&&(a[this.mesh]=Mesh),a};Aa.prototype.onResourceRenamed=function(a,b,c){this.mesh==a&&(this.mesh=b)};Aa.prototype.onGetColliders=function(a,b){if(this.enabled){var c=this._PI;c||(this._PI=c=new d.PhysicsInstance(this._root,this));this._root.transform&&c.matrix.set(this._root.transform._global_matrix);c.type=this.shape;c.layers=this._root.layers;var e=null;if(c.type===
d.PhysicsInstance.MESH||this.use_mesh_bounding)e=this.getMesh();c.type===d.PhysicsInstance.SPHERE?e?BBox.copy(c.oobb,e.bounding):BBox.setCenterHalfsize(c.oobb,this.center,[this.size[0],this.size[0],this.size[0]]):c.type===d.PhysicsInstance.BOX?e?BBox.copy(c.oobb,e.bounding):BBox.setCenterHalfsize(c.oobb,this.center,this.size):c.type===d.PhysicsInstance.PLANE&&(this.size[1]=1E-4,BBox.setCenterHalfsize(c.oobb,this.center,this.size));e?vec3.copy(c.center,BBox.getCenter(e.bounding)):vec3.copy(c.center,
this.center);vec3.transformMat4(c.center,c.center,c.matrix);if(c.type===d.PhysicsInstance.MESH){if(!e)return;c.setMesh(e)}b.push(c)}};d.registerComponent(Aa);Object.defineProperty(Ta.prototype,"properties",{set:function(a){if(a&&a.constructor===Array){this._properties.length=a.length;this._properties_by_name={};for(var b=0;b<a.length;++b){var c=a[b];this._properties[b]=c;this._properties_by_name[c.name]=c}}},get:function(){return this._properties},enumerable:!0});Ta.icon="mini-icon-bg.png";Ta.prototype.onAddedToNode=
function(a){a.custom||(a.custom=this)};Ta.prototype.onRemovedFromNode=function(a){a.custom==this&&delete a.custom};Ta.prototype.getResources=function(a){return a};Ta.prototype.addProperty=function(a){this._properties.push(a);this._properties_by_name[a.name]&&console.warn("CustomData: there is a property with the same name");this._properties_by_name[a.name]=a};Ta.prototype.getProperty=function(a){return this._properties_by_name[a]};Ta.prototype.getPropertiesInfo=function(){return this._properties};
Ta.prototype.updateProperty=function(a){this._properties_by_name[a.name]=a};Ta.prototype.getPropertyInfoFromPath=function(a){return(a=this._properties_by_name[a[0]])?{node:this._root,target:a,name:"value",value:a.value,type:a.type}:null};Ta.prototype.setPropertyValueFromPath=function(a,b,c){if(a=this._properties_by_name[a[c||0]])a.value&&a.value.set?a.value.set(b):a.value=b};Ta.prototype.get=function(a){if(a=this._properties_by_name[a])return a.value};Ta.prototype.onResourceRenamed=function(a,b,c){};
d.registerComponent(Ta);d.CustomData=Ta;var Ob=vec3.create();Qa.icon="mini-icon-teapot.png";Qa["@texture"]={type:"texture"};Qa["@blend_mode"]={type:"enum",values:d.Blend};Qa["@atlas"]={type:"component",filter:"SpriteAtlas"};Qa["@area"]={type:"vec4",step:0.001};Object.defineProperty(Qa.prototype,"size",{set:function(a){this._size.set(a)},get:function(){return this._size},enumerable:!0});Object.defineProperty(Qa.prototype,"area",{set:function(a){this._area.set(a)},get:function(){return this._area},
enumerable:!0});Object.defineProperty(Qa.prototype,"atlas",{set:function(a){var b=null;a&&a.constructor===String?(this._atlas=a,(b=(this._root.scene||d.GlobalScene).findComponentByUId(a))&&b.constructor!=d.Components.SpriteAtlas&&(console.warn("Atlas must be of type SpriteAtlas"),b=null)):(this._atlas=a?a.uid:null,b=a);this._atlas_component&&this._atlas_component!=b&&this._atlas_component.removeSprite(this);(this._atlas_component=b)&&this._atlas_component.addSprite(this)},get:function(){return this._atlas},
enumerable:!0});Qa.prototype.onAddedToNode=function(a){LEvent.bind(a,"collectRenderInstances",this.onCollectInstances,this);this._atlas_component&&this._atlas_component.addSprite(this)};Qa.prototype.onRemovedFromNode=function(a){LEvent.unbind(a,"collectRenderInstances",this.onCollectInstances,this);this._atlas_component&&this._atlas_component.removeSprite(this)};Qa.prototype.onAddedToScene=function(a){this._atlas_component&&this._atlas_component.addSprite(this)};Qa.prototype.onRemovedFromScene=function(a){this._atlas_component&&
this._atlas_component.removeSprite(this)};Qa.prototype.onCollectInstances=function(a,b){if(this.enabled&&!this._atlas&&this._root){var c=d.Components.Sprite._mesh;c||(c=d.Components.Sprite._mesh=GL.Mesh.plane());var e=this._render_instance;e||(this._render_instance=e=new d.RenderInstance(this._root,this),e.setMesh(c,gl.TRIANGLES));this._material||(this._material=new d.StandardMaterial({shader_name:"lowglobal",flags:{two_sided:!0}}));this._material.setTexture("color",this.texture,{uvs:d.Material.COORDS_UV_TRANSFORMED,
magFilter:this.filtering?gl.LINEAR:gl.NEAREST});this._material.blend_mode=this.blend_mode;e.setMaterial(this._material);this._root.transform&&e.setMatrix(this._root.transform._global_matrix);mat4.getTranslation(e.center,this._root.transform._global_matrix);Ob[0]=this._size[0]*(this.flip_x?-1:1);Ob[1]=this._size[1];Ob[2]=1;mat4.scale(e.matrix,e.matrix,Ob);mat3.identity(this._material.uvs_matrix);mat3.translate(this._material.uvs_matrix,this._material.uvs_matrix,this._area.subarray(0,2));mat3.scale(this._material.uvs_matrix,
this._material.uvs_matrix,this._area.subarray(2,4));b.push(e)}};Qa.prototype.getResources=function(a){"string"==typeof this.texture&&(a[this.texture]=GL.Texture);return a};Qa.prototype.onResourceRenamed=function(a,b,c){this.texture==a&&(this.texture=b)};d.registerComponent(Qa);Fa.icon="mini-icon-teapot.png";Fa["@texture"]={type:"texture"};Fa["@areas"]={type:"texture_areas"};Fa.plane_vertices=[vec3.fromValues(-0.5,0.5,0),vec3.fromValues(0.5,-0.5,0),vec3.fromValues(0.5,0.5,0),vec3.fromValues(-0.5,-0.5,
0)];Fa.plane_normal=vec3.fromValues(0,0,1);Fa.prototype.onAddedToNode=function(a){LEvent.bind(a,"collectRenderInstances",this.onCollectInstances,this)};Fa.prototype.onRemovedFromNode=function(a){LEvent.unbind(a,"collectRenderInstances",this.onCollectInstances,this)};Fa.prototype.createMesh=function(){if(this._mesh_maxsprites!=this._max_sprites){for(var a=new Float32Array(12*this._max_sprites),b=new Float32Array(12*this._max_sprites),c=new Float32Array(8*this._max_sprites),e=new Float32Array(16*this._max_sprites),
d=new Uint16Array(6*this._max_sprites),f=new Float32Array([0,0,1,1,1,0,0,1]),h=new Float32Array([1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]),k=0,l=this._max_sprites;k<l;++k)c.set(f,8*k),e.set(h,16*k),d[6*k]=4*k,d[6*k+1]=4*k+1,d[6*k+2]=4*k+2,d[6*k+3]=4*k,d[6*k+4]=4*k+3,d[6*k+5]=4*k+1;this._mesh=new GL.Mesh;this._mesh.addBuffers({vertices:a,normals:b,coords:c,colors:e},{triangles:d},gl.STREAM_DRAW);this._mesh_maxsprites=this._max_sprites}};Fa.prototype.updateMesh=function(){this._mesh||this.createMesh();for(var a=
this._mesh,b=Fa.plane_vertices,c=Fa.plane_normal,e=a.getBuffer("vertices"),d=a.getBuffer("normals"),a=a.getBuffer("coords"),f=e.data,h=d.data,k=a.data,l=0,m=0,p=Math.min(this._sprites.length,this._max_sprites);m<p;++m){var n=this._sprites[m];if(n.enabled){var r=null;if(n.matrix)r=n.matrix;else if(n._root&&n._root.transform)r=n._root.transform._global_matrix;else continue;mat4.rotateVec3(Ob,r,c);for(var t=0;4>t;++t){var x=12*l+3*t,u=f.subarray(x,x+3);u.set(b[t]);u[0]*=n._size[0];u[1]*=n._size[1];vec3.transformMat4(u,
u,r);h.set(Ob,x)}x=n._area;n=x[0];r=x[1];t=x[2];x=x[3];k.set([n,r,n+t,r+x,n+t,r,n,r+x],8*l);l+=1}}l&&(e.upload(),d.upload(),a.upload());this._last_index=6*l};Fa.prototype.onCollectInstances=function(a,b){if(this.enabled&&this._root&&this._sprites.length){this.updateMesh();var c=this._mesh;if(this._last_index){var e=this._render_instance;e||(this._render_instance=e=new d.RenderInstance(this._root,this),e.setMesh(c,gl.TRIANGLES));this._material||(this._material=new d.StandardMaterial({shader_name:"lowglobal",
flags:{two_sided:!0}}));this._material.setTexture("COLOR",this.texture);e.setMaterial(this._material);e.setRange(0,this._last_index);b.push(e)}}};Fa.prototype.addSprite=function(a){-1==this._sprites.indexOf(a)&&this._sprites.push(a)};Fa.prototype.removeSprite=function(a){a=this._sprites.indexOf(a);-1!=a&&this._sprites.splice(a,1)};Fa.prototype.getResources=function(a){"string"==typeof this.texture&&(a[this.texture]=GL.Texture);return a};Fa.prototype.onResourceRenamed=function(a,b,c){this.texture==
a&&(this.texture=b)};d.registerComponent(Fa);Fa.Area=function(){this._start=vec2.create();this._size=vec2.create()};H.max_recursive_level=32;H.recursive_level=0;H.propagable_events="finish beforeRenderMainPass beforeRenderInstances afterRenderInstances readyToRender renderGUI renderHelpers".split(" ");H.fx_propagable_events=["enableFrameContext","showFrameContext"];Object.defineProperty(H.prototype,"scene_path",{set:function(a){this._scene_path!=a&&(this._scene_path=a,this._root.scene&&this.reloadScene())},
get:function(){return this._scene_path},enumerable:!0});Object.defineProperty(H.prototype,"frame_fx",{set:function(a){this._frame_fx!=a&&(this._frame_fx=a,this.updateBindings())},get:function(){return this._frame_fx},enumerable:!0});H["@scene_path"]={type:d.TYPES.SCENE,widget:"resource"};H.icon="mini-icon-teapot.png";H.prototype.onAddedToScene=function(a){LEvent.bind(a,"collectData",this.onCollectData,this);LEvent.bind(a,"start",this.onStart,this);LEvent.bind(a,"update",this.onUpdate,this);LEvent.bind(a,
"fillSceneUniforms",this.fillSceneUniforms,this);for(var b in H.propagable_events)LEvent.bind(a,H.propagable_events[b],this.onEvent,this);this.updateBindings();this._scene_path&&this.reloadScene()};H.prototype.onRemovedFromScene=function(a){LEvent.unbind(a,"collectData",this.onCollectData,this);LEvent.unbind(a,"start",this.onStart,this);LEvent.unbind(a,"update",this.onUpdate,this);LEvent.unbind(a,"fillSceneUniforms",this.fillSceneUniforms,this);var b=H.propagable_events.concat(H.fx_propagable_events),
c;for(c in b)LEvent.unbind(a,b[c],this.onEvent,this)};H.prototype.fillSceneUniforms=function(a){LEvent.trigger(this._scene,"fillSceneUniforms")};H.prototype.onStart=function(){H.recursive_level+=1;this._scene_is_ready&&H.recursive_level<H.max_recursive_level&&this._scene.start();H.recursive_level-=1};H.prototype.onUpdate=function(a,b){H.recursive_level+=1;this.send_events&&H.recursive_level<H.max_recursive_level&&this._scene.update(b);H.recursive_level-=1};H.prototype.onEvent=function(a,b){this.enabled&&
this.send_events&&this._scene_path&&(H.recursive_level+=1,H.recursive_level<H.max_recursive_level&&LEvent.trigger(this._scene,a,b),H.recursive_level-=1)};H.prototype.updateBindings=function(){var a=this._root.scene;if(a){if(this._frame_fx&&!this._frame_fx_binded){for(var b in H.fx_propagable_events)LEvent.bind(a,H.fx_propagable_events[b],this.onEvent,this);this._frame_fx_binded=!0}if(!this._frame_fx&&this._frame_fx_binded){for(b in H.fx_propagable_events)LEvent.unbind(a,H.fx_propagable_events[b],
this.onEvent,this);this._frame_fx_binded=!1}}};H.prototype.onCollectData=function(){if(this.enabled&&this._scene_path&&this._scene_is_ready){var a=this._root.scene,b=this._scene;H.recursive_level+=1;H.recursive_level<H.max_recursive_level&&b.collectData();H.recursive_level-=1;var c=null;this._root.transform&&(c=this._root.transform.getGlobalMatrix());if(this.include_instances&&(a._instances.push.apply(a._instances,b._instances),a._colliders.push.apply(a._colliders,b._colliders),c))for(var e=0;e<b._instances.length;++e)b._instances[e].applyTransform(c);
this.include_lights&&a._lights.push.apply(a._lights,b._lights);this.include_cameras&&a._cameras.push.apply(a._cameras,b._cameras)}};H.prototype.load=function(){this.reloadScene()};H.prototype.unload=function(){this._scene_is_ready=!1;this._scene.clear()};H.prototype.reloadScene=function(){function a(){console.log("SceneInclude: scene loaded");this._scene_is_ready=!0;this._root.scene._state==d.PLAYING&&this._scene.start()}function b(){d.Renderer.regenerateShadowmaps();for(var a=0;a<e._reflection_probes.length;++a)-1==
c._reflection_probes.indexOf(e._reflection_probes[a])&&c._reflection_probes.push(e._reflection_probes[a]);d.Components.ReflectionProbe.updateAll()}this._scene_is_ready=!1;var c=d.GlobalScene,e=this._scene;H.recursive_level+=1;H.recursive_level<H.max_recursive_level&&this._scene.loadFromResources(this._scene_path,a.bind(this),null,null,b);H.recursive_level-=1};H.prototype.getPropertyInfoFromPath=function(a){if(!a.length||"custom"!=a[0])return null;var b=this._scene.root.custom;return b?(a=b._properties_by_name[a[1]])?
{node:this._root,target:a,name:"value",value:a.value,type:a.type}:null:null};H.prototype.setPropertyValueFromPath=function(a,b,c){c=c||0;if(!a.length||"custom"!=a[c])return null;var e=this._scene.root.custom;if(!e)return null;e.setPropertyValueFromPath(a,b,c+1)};H.prototype.getEvents=function(){return{loaded:"event",unloaded:"event"}};H.prototype.getActions=function(){return{load:"function",unload:"function"}};H.prototype.getResources=function(a){this._scene_path&&(a[this._scene_path]=d.Scene);return a};
H.prototype.onResourceRenamed=function(a,b,c){a==this._scene_path&&(this._scene_path=b)};d.registerComponent(H);Ra["@color"]={type:"vec4",step:0.01};Ra.CIRCLE=1;Ra.SQUARE=2;Ra["@subdivisions"]={type:"number",step:1,min:1,max:100,precision:0};Ra["@type"]={type:"enum",values:{circle:Ra.CIRCLE,square:Ra.SQUARE}};Ra.prototype.onAddedToScene=function(a){LEvent.bind(d.Renderer,"renderHelpers",this.onRender,this)};Ra.prototype.onRemovedFromScene=function(a){LEvent.unbind(d.Renderer,"renderHelpers",this.onRender,
this)};Ra.prototype.onRender=function(a,b){if(this.enabled&&(d.Renderer._in_player&&this.in_player||!d.Renderer._in_player&&this.in_editor)&&b.checkLayersVisibility(this._root.layers)){this._is_visible=!0;var c=this._root;c&&c.visible&&c.transform&&(c=c.transform.getGlobalMatrixRef(),gl.enable(gl.BLEND),gl.blendFunc(gl.SRC_ALPHA,gl.ONE_MINUS_SRC_ALPHA),this.renderHelper(c,this.color,this.fill),gl.disable(gl.BLEND))}else this._is_visible=!1};Ra.prototype.renderHelper=function(a,b,c){this.always_on_top&&
gl.disable(gl.DEPTH_TEST);gl.disable(gl.CULL_FACE);d.Draw.push();d.Draw.setMatrix(a);d.Draw.setColor(b);this.type==Ra.CIRCLE?d.Draw.renderCircle(this.size,32,!this.vertical,c):this.type==Ra.SQUARE&&(c?d.Draw.renderRectangle(this.size,this.size,!this.vertical,!0):d.Draw.renderRectangle(this.size,this.size,!this.vertical));d.Draw.pop();gl.enable(gl.CULL_FACE);gl.enable(gl.DEPTH_TEST)};Ra.prototype.renderPicking=function(a){if(this._is_visible){a=this._root.transform.getGlobalMatrixRef(!0);var b=d.Picking.getNextPickingColor({instance:this});
this.renderHelper(a,b,!0)}};d.registerComponent(Ra);Ma.editor_color=[0.33,0.874,0.56,0.9];Ma.onShowMainAnnotation=function(a){"undefined"!=typeof AnnotationModule&&AnnotationModule.editAnnotation(a)};Ma.onShowPointAnnotation=function(a,b){function c(a){this.text=a}var e=a.getComponent(Ma);e&&"undefined"!=typeof AnnotationModule&&AnnotationModule.showDialog(b.text,{item:b,on_close:c.bind(b),on_delete:function(a){e.removeAnnotation(a.item);this._root.scene.requestFrame()},on_focus:function(a){AnnotationModule.focusInAnnotation(a.item);
e._selected=a.item}})};Ma.prototype.addAnnotation=function(a){this._selected=null;this.notes.push(a)};Ma.prototype.getAnnotation=function(a){return this.nodes[a]};Ma.prototype.removeAnnotation=function(a){this._selected=null;a=this.notes.indexOf(a);-1!=a&&this.notes.splice(a,1)};Ma.prototype.setStartTransform=function(){this.start_position=this.getObjectCenter()};Ma.prototype.getObjectCenter=function(){var a=vec3.create(),b=this._root.getMesh();b&&b.bounding&&vec3.copy(a,BBox.getCenter(b.bounding));
return this._root.transform.localToGlobal(a)};Ma.prototype.serialize=function(){for(var a={object_class:"AnnotationComponent",text:this.text,notes:[],start_position:this.start_position},b=0;b<this.notes.length;++b){var c=this.notes[b],e;for(e in c)c[e].constructor==Float32Array&&Array.prototype.slice.call(c[e]);a.notes.push(c)}return a};Ma.prototype.onAddedToScene=function(a){LEvent.bind(a,"mousedown",this.onMouse,this)};Ma.prototype.onRemovedFromScene=function(a){LEvent.bind(a,"mousedown",this.onMouse,
this)};Ma.prototype.onMouse=function(a,b){if("mousedown"==b.eventType){this._screen_pos[2]=0;var c=vec3.dist(this._screen_pos,[b.canvasx,gl.canvas.height-b.canvasy,0]);if(30>c)Ma.onShowMainAnnotation(this._root);for(var e=0;e<this.notes.length;++e){var d=this.notes[e],c=vec2.dist(d._end_screen,[b.mousex,gl.canvas.height-b.mousey]);if(30>c)return this._selected=d,Ma.onShowPointAnnotation(this._root,d),!0}}};Ma.prototype.renderEditor=function(a){if(this.text||this.notes.length){a=vec3.create();var b=
this._root.getMesh();b&&vec3.copy(a,BBox.getCenter(b.bounding));a=d.Renderer._current_camera;var c=this._root.transform.getGlobalPosition(),b=this.getObjectCenter(),e=a.getEye(),g=a.getLocalVector([1,0,0]),f=a.getLocalVector([0,1,0]);a.getLocalVector([0,0,1]);var h=Math.tan(a.fov*DEG2RAD)*vec3.dist(c,e),f=vec3.scale(vec3.create(),f,0.2*h),g=vec3.scale(vec3.create(),g,0.2*h),k=vec3.add(vec3.create(),c,f);vec3.add(k,g,k);a.project(k,null,this._screen_pos);gl.enable(gl.BLEND);gl.enable(gl.DEPTH_TEST);
d.Draw.setColor([1,1,1,1]);var g=[],f=[],e=[],l=[];this.text&&(g.push(c,k),f.push([1,1,1,0],[1,1,1,1]),window.EditorModule&&d.Draw.renderImage(k,EditorModule.icons_path+"/mini-icon-script.png",0.03*h));for(var m=this._root.transform.getGlobalMatrix(),c=0;c<this.notes.length;++c){var k=this.notes[c],h=mat4.multiplyVec3(vec3.create(),m,k.start),p=mat4.multiplyVec3(vec3.create(),m,k.end);k.end_world=p;e.push(p);g.push(h,p);this._selected==k?(l.push([1,1,1,1]),f.push([1,1,1,0.2],[1,1,0.8,1])):(l.push(d.Components.AnnotationComponent.editor_color),
f.push([0,0,0,0.2],d.Components.AnnotationComponent.editor_color));k._end_screen=a.project(p)}if((h=this.start_position)&&1<vec3.dist(h,b))for(k=vec3.dist(h,b)/20,b=vec3.subtract(vec3.create(),b,h),vec3.normalize(b,b),c=0;20>c;c+=2)m=vec3.scale(vec3.create(),b,c*k),vec3.add(m,m,h),g.push(m),m=vec3.scale(vec3.create(),b,(c+1)*k),vec3.add(m,m,h),g.push(m),f.push([0,1,0,0.2],[0,1,0,1]);d.Draw.setPointSize(12);d.Draw.renderPoints(e,l);d.Draw.setColor([0,0,0,0.5]);d.Draw.setPointSize(10);d.Draw.renderPoints(e,
l);d.Draw.setColor([1,1,1,1]);d.Draw.renderLines(g,f);gl.depthFunc(gl.GREATER);d.Draw.setAlpha(0.1);d.Draw.renderPoints(e,l);d.Draw.renderLines(g,f);gl.depthFunc(gl.LESS);if(gl.start2D)for(d.Draw.setColor(d.Components.AnnotationComponent.editor_color),b=vec3.create(),gl.start2D(),gl.fillColor=d.Components.AnnotationComponent.editor_color,gl.font="20px Arial",c=0;c<this.notes.length;++c)k=this.notes[c],a.project(k.end_world,null,b,!0),g=k.text.split("\n")[0],gl.fillText(g,b[0]+10,b[1]+8);gl.disable(gl.BLEND)}};
d.registerComponent(Ma);Qb.icon="mini-icon-rotator.png";Qb.prototype.onAddedToScene=function(a){LEvent.bind(a,"update",this.onUpdate,this)};Qb.prototype.onRemovedFromScene=function(a){LEvent.unbind(a,"update",this.onUpdate,this)};Qb.prototype.onUpdate=function(a,b){if(this._root&&this.enabled){var c=this._root.scene;this._default||(this._default=this._root.transform.getRotation());vec3.normalize(this.axis,this.axis);if(this.swing){var e=quat.setAxisAngle(quat.create(),this.axis,Math.sin(this.speed*
c._global_time*2*Math.PI)*this.swing_amplitude*DEG2RAD);quat.multiply(this._root.transform._rotation,e,this._default);this._root.transform._must_update=!0}else this.local_space?this._root.transform.rotate(this.speed*b,this.axis):this._root.transform.rotateGlobal(this.speed*b,this.axis);c&&c.requestFrame()}};d.registerComponent(Qb);C.NONE=0;C.ORBIT=1;C.ORBIT_HORIZONTAL=2;C.ROTATE=5;C.ROTATE_HORIZONTAL=6;C.PAN=10;C.PAN_XZ=11;C.CHANGE_DISTANCE=15;C.WALK=16;C.ELEVATE=17;C.FOV=18;C.icon="mini-icon-cameracontroller.png";
C.mode_values={None:C.NONE,Orbit:C.ORBIT,"Orbit Horizontal":C.ORBIT_HORIZONTAL,Rotate:C.ROTATE,"Rotate Horizontal":C.ROTATE_HORIZONTAL,Pan:C.PAN,"Pan XZ":C.PAN_XZ,"Change Distance":C.CHANGE_DISTANCE,Walk:C.WALK,Elevate:C.ELEVATE};C.wheel_values={None:C.NONE,"Change Distance":C.CHANGE_DISTANCE,FOV:C.FOV,Walk:C.WALK,Elevate:C.ELEVATE};C["@no_button_action"]={type:"enum",values:C.mode_values};C["@left_button_action"]={type:"enum",values:C.mode_values};C["@middle_button_action"]={type:"enum",values:C.mode_values};
C["@right_button_action"]={type:"enum",values:C.mode_values};C["@mouse_wheel_action"]={type:"enum",values:C.wheel_values};C.prototype.onAddedToScene=function(a){LEvent.bind(a,d.EVENT.START,this.onStart,this);LEvent.bind(a,d.EVENT.FINISH,this.onFinish,this);LEvent.bind(a,d.EVENT.MOUSEDOWN,this.onMouse,this);LEvent.bind(a,d.EVENT.MOUSEMOVE,this.onMouse,this);LEvent.bind(a,d.EVENT.MOUSEWHEEL,this.onMouse,this);LEvent.bind(a,d.EVENT.TOUCHSTART,this.onTouch,this);LEvent.bind(a,d.EVENT.TOUCHMOVE,this.onTouch,
this);LEvent.bind(a,d.EVENT.TOUCHEND,this.onTouch,this);LEvent.bind(a,d.EVENT.KEYDOWN,this.onKey,this);LEvent.bind(a,d.EVENT.KEYUP,this.onKey,this);LEvent.bind(a,d.EVENT.UPDATE,this.onUpdate,this);LEvent.bind(a,d.EVENT.RENDERGUI,this.onRenderGUI,this)};C.prototype.onRemovedFromScene=function(a){LEvent.unbindAll(a,this)};C.prototype.onStart=function(a){this.lock_mouse&&d.Input.lockMouse(!0)};C.prototype.onFinish=function(a){this.lock_mouse&&d.Input.lockMouse(!1)};C.prototype.onUpdate=function(a){if(this._root&&
this.enabled&&(a=this._root.camera)&&a.enabled){if(0!=this._moving[0]||0!=this._moving[1]||0!=this._moving[2]){var b=a.getLocalVector(this._moving);this.keyboard_walk_plane&&(b[1]=0);vec3.length(b)&&(vec3.normalize(b,b),vec3.scale(b,b,this.walk_speed*(this._fast?10:1)),this._root.transform?this._root.transform.translateGlobal(b):a.move(b),a.updateMatrices())}this.smooth&&this._root.scene.requestFrame()}};C.prototype.processMouseButtonDownEvent=function(a,b,c){var e=this._camera=this._root.camera;
if(e&&e.enabled)return a==C.PAN?this.testPerpendicularPlane(b.canvasx,gl.canvas.height-b.canvasy,e.getCenter(),c):a==C.PAN_XZ&&this.testOriginPlane(b.canvasx,gl.canvas.height-b.canvasy,c),!1};C.prototype.processMouseButtonMoveEvent=function(a,b,c){var e=this._root,g=this._camera=e.camera;if(g&&g.enabled){var f=e._is_root,h=!1;if(a==C.NONE)return!1;if(a==C.ORBIT){var k=b.deltax*this.rot_speed;b=-b.deltay*this.rot_speed;var l=g.getEye();a=g.getCenter();var m=g.getFront();c=g.getRight();var p=g.getUp();
1E-4<Math.abs(k)&&(f?(g.orbit(-k,[0,1,0]),g.updateMatrices()):(h=vec3.create(),vec3.sub(h,l,a),vec3.rotateY(h,h,k*DEG2RAD),vec3.scale(m,h,-1),vec3.normalize(m,m),vec3.add(l,h,a)),h=!0);k=vec3.dot(p,m);0.99<k&&0<b||-0.99>k&&0>b||(f?g.orbit(-b,c,this.orbit_center):(h=vec3.create(),vec3.sub(h,l,a),k=quat.create(),quat.setAxisAngle(k,c,-b*DEG2RAD),vec3.transformQuat(h,h,k),vec3.add(l,h,a)),h=!0);h&&(f||e.transform.lookAt(l,a,[0,1,0],!0),g.updateMatrices())}else a==C.ORBIT_HORIZONTAL?(k=b.deltax*this.rot_speed,
1E-4<Math.abs(k)&&(f?g.orbit(-k,[0,1,0]):(a=g.getCenter(),e.transform.globalToLocal(a,a),e.transform.orbit(-k,[0,1,0],a)),g.updateMatrices(),h=!0)):a==C.ROTATE||a==C.ROTATE_HORIZONTAL?(g.rotate(-b.deltax*this.rot_speed*0.2,d.TOP),g.updateMatrices(),a==C.ROTATE&&(c=g.getLocalVector(d.RIGHT),f?g.rotate(-b.deltay*this.rot_speed*0.2,c):e.transform.rotate(-b.deltay*this.rot_speed*0.2,d.RIGHT),g.updateMatrices()),h=!0):a==C.PAN?(h=vec3.create(),a=vec3.create(),l=vec3.create(),g.getCenter(a),this.testPerpendicularPlane(b.canvasx,
gl.canvas.height-b.canvasy,a,h),vec3.sub(l,c,h),f?g.move(l):e.transform.translateGlobal(l),g.updateMatrices(),h=!0):a==C.PAN_XZ?(h=vec3.create(),l=vec3.create(),this.testOriginPlane(b.canvasx,gl.canvas.height-b.canvasy,h),vec3.sub(l,c,h),f?g.move(l):e.transform.translateGlobal(l),g.updateMatrices(),h=!0):a==C.CHANGE_DISTANCE?(g.orbitDistanceFactor(1+b.deltay*this.wheel_speed*-0.05),g.updateMatrices(),h=!0):a==C.WALK?(l=g.getLocalVector([0,0,b.deltay*this.walk_speed]),g.move(l),g.updateMatrices(),
h=!0):a==C.ELEVATE&&(g.move([0,b.deltay*this.walk_speed,0]),g.updateMatrices(),h=!0);return h}};C.prototype.onMouse=function(a,b){if(this._root&&this.enabled){var c=this._root,e=c.scene,g=c.camera;if(g&&g.enabled)if(b||(b=a),"mousewheel"==b.eventType){e=0<b.wheel?1:-1;switch(this.mouse_wheel_action){case C.CHANGE_DISTANCE:g.orbitDistanceFactor(1+-0.05*e*this.wheel_speed);g.updateMatrices();break;case C.FOV:g.fov-=e,g.updateMatrices()}c.scene.requestFrame()}else c=!1,"mousedown"==b.eventType&&(this.lock_mouse&&
!document.pointerLockElement&&e._state==d.PLAYING&&d.Input.lockMouse(!0),d.Input.Mouse.isButtonPressed(GL.LEFT_MOUSE_BUTTON)&&(c|=this.processMouseButtonDownEvent(this.left_button_action,b,this._collision_left)),d.Input.Mouse.isButtonPressed(GL.MIDDLE_MOUSE_BUTTON)&&(c|=this.processMouseButtonDownEvent(this.middle_button_action,b,this._collision_middle)),d.Input.Mouse.isButtonPressed(GL.RIGHT_MOUSE_BUTTON)&&(c|=this.processMouseButtonDownEvent(this.right_button_action,b,this._collision_right)),this._dragging=
!0),b.dragging||(this._dragging=!1),"mousemove"!=b.eventType&&"touchmove"!=b.eventType||!this.lock_mouse||!document.pointerLockElement&&!b.is_touch||(c|=this.processMouseButtonMoveEvent(this.no_button_action,b,this._collision_none)),"mousemove"==b.eventType&&b.dragging&&this._dragging&&(d.Input.Mouse.isButtonPressed(GL.LEFT_MOUSE_BUTTON)&&(c|=this.processMouseButtonMoveEvent(this.left_button_action,b,this._collision_left)),d.Input.Mouse.isButtonPressed(GL.MIDDLE_MOUSE_BUTTON)&&(c|=this.processMouseButtonMoveEvent(this.middle_button_action,
b,this._collision_middle)),d.Input.Mouse.isButtonPressed(GL.RIGHT_MOUSE_BUTTON)&&(c|=this.processMouseButtonMoveEvent(this.right_button_action,b,this._collision_right))),c&&this._root.scene.requestFrame()}};C.prototype.onTouch=function(a,b){if(this._root&&this.enabled){var c=this._root.camera;if(c&&c.enabled){b||(b=a);if("touchstart"==b.type&&2==b.touches.length){var e=b.touches[0].clientX-b.touches[1].clientX,d=b.touches[0].clientY-b.touches[1].clientY;this._touch_distance=Math.sqrt(e*e+d*d);this._touch_center=
[0.5*(b.touches[0].clientX+b.touches[1].clientX),0.5*(b.touches[0].clientY+b.touches[1].clientY)];b.preventDefault();return!1}if("touchmove"==b.type&&2==b.touches.length)return e=b.touches[0].clientX-b.touches[1].clientX,d=b.touches[0].clientY-b.touches[1].clientY,e=Math.sqrt(e*e+d*d),0.1>e&&(e=0.1),d=this._touch_distance/e,this._touch_distance=e,c.orbitDistanceFactor(d),c.updateMatrices(),c.panning(-(0.5*(b.touches[0].clientX+b.touches[1].clientX)-this._touch_center[0]),0.5*(b.touches[0].clientY+
b.touches[1].clientY)-this._touch_center[1],c.focalLength/gl.canvas.width),this._touch_center[0]=0.5*(b.touches[0].clientX+b.touches[1].clientX),this._touch_center[1]=0.5*(b.touches[0].clientY+b.touches[1].clientY),c.updateMatrices(),this._root.scene.requestFrame(),b.preventDefault(),!1}}};C.prototype.testOriginPlane=function(a,b,c){a=this._root.camera.getRay(a,gl.canvas.height-b);c=c||vec3.create();return geo.testRayPlane(a.origin,a.direction,d.ZEROS,d.TOP,c)?!0:!1};C.prototype.testPerpendicularPlane=
function(a,b,c,e){var d=this._root.camera;a=d.getRay(a,gl.canvas.height-b);b=d.getFront();c=c||d.getCenter();e=e||vec3.create();return geo.testRayPlane(a.origin,a.direction,c,b,e)?!0:!1};C.prototype.onKey=function(a,b){this._root&&this.enabled&&this.keyboard_walk&&(87==b.keyCode?this._moving[2]="keydown"==b.type?-1:0:83==b.keyCode?this._moving[2]="keydown"==b.type?1:0:65==b.keyCode?this._moving[0]="keydown"==b.type?-1:0:68==b.keyCode?this._moving[0]="keydown"==b.type?1:0:16==b.keyCode&&("keydown"==
b.type?this._fast=!0:"keyup"==b.type&&(this._fast=!1)))};C.prototype.onRenderGUI=function(){if(this.render_crosshair&&this.enabled&&this._camera&&this._camera.enabled&&d.Input.isMouseLocked()){var a=gl;gl.start2D();a.fillStyle="rgba(0,0,0,0.5)";a.fillRect(0.5*gl.viewport_data[2]-1,0.5*gl.viewport_data[3]-1,4,4);a.fillStyle="rgba(255,255,255,1)";a.fillRect(0.5*gl.viewport_data[2],0.5*gl.viewport_data[3],2,2);gl.finish2D()}};d.registerComponent(C);gb.icon="mini-icon-rotator.png";gb.prototype.onAddedToScene=
function(a){LEvent.bind(a,"mousemove",this.onSceneMouse,this)};gb.prototype.onRemovedFromScene=function(a){LEvent.unbind(a,"mousemove",this.onSceneMouse,this)};gb.prototype.onAddedToNode=function(a){LEvent.bind(a,"mousemove",this.onNodeMouse,this)};gb.prototype.onRemovedFromNode=function(a){LEvent.unbind(a,"mousemove",this.onNodeMouse,this)};gb.prototype.onNodeMouse=function(a,b){if(this.on_node_clicked&&this.enabled)return this.onMouse(a,b)};gb.prototype.onSceneMouse=function(a,b){if(!this.on_node_clicked&&
this.enabled)return this.onMouse(a,b)};gb.prototype.onMouse=function(a,b){if(this._root&&this._root.transform&&b.dragging){var c=this._root.scene,e=c.getCamera(),g=this.use_global_up_for_yaw?d.Components.Transform.UP:e.getLocalVector(d.Components.Transform.UP);this._root.transform.rotateGlobal(b.deltax*this.rot_speed[0],g);e=e.getLocalVector(d.Components.Transform.RIGHT);this._root.transform.rotateGlobal(b.deltay*this.rot_speed[1],e);c.requestFrame()}};d.registerComponent(gb);S.icon="mini-icon-billboard.png";
S.POSX=1;S.NEGX=2;S.POSY=3;S.NEGY=4;S.POSZ=5;S.NEGZ=6;S["@node_id"]={type:"node_id"};S["@front"]={type:"enum",values:{"-Z":S.NEGZ,"+Z":S.POSZ,"-Y":S.NEGY,"+Y":S.POSY,"-X":S.NEGX,"+X":S.POSX}};S["@up"]={type:"enum",values:{"-Z":S.NEGZ,"+Z":S.POSZ,"-Y":S.NEGY,"+Y":S.POSY,"-X":S.NEGX,"+X":S.POSX}};S.prototype.onAddedToScene=function(a){LEvent.bind(a,d.EVENT.BEFORE_RENDER,this.onBeforeRender,this)};S.prototype.onRemovedFromScene=function(a){LEvent.unbind(a,d.EVENT.BEFORE_RENDER,this.onBeforeRender,this)};
S.prototype.onBeforeRender=function(a){this.enabled&&this.updateOrientation()};S.temp_mat3=mat3.create();S.temp_mat=mat4.create();S.prototype.updateOrientation=function(){if(this._root&&this._root.transform){var a=this._root.scene,b=this._root.transform,c=null,e=null,g=b.getGlobalPosition(this._global_position);switch(this.up){case S.NEGX:e=vec3.fromValues(-1,0,0);break;case S.POSX:e=vec3.fromValues(1,0,0);break;case S.NEGZ:e=vec3.fromValues(0,0,-1);break;case S.POSZ:e=vec3.fromValues(0,0,1);break;
case S.NEGY:e=vec3.fromValues(0,-1,0);break;default:e=vec3.fromValues(0,1,0)}if(this.node_id){a=a.getNode(this.node_id);if(!a||a==this._root||!a.transform)return;c=a.transform.getGlobalPosition(this._target_position)}else if(this.face_camera){a=d.Renderer._current_camera||d.Renderer._main_camera;if(!a)return;c=a.getEye()}else return;this.cylindrical&&(c[1]=g[1]);b.orientTo(c,!0,e,this.use_iterative_method);switch(this.front){case S.POSY:quat.rotateX(b._rotation,b._rotation,-0.5*Math.PI);break;case S.NEGY:quat.rotateX(b._rotation,
b._rotation,0.5*Math.PI);break;case S.POSX:quat.rotateY(b._rotation,b._rotation,0.5*Math.PI);break;case S.NEGX:quat.rotateY(b._rotation,b._rotation,-0.5*Math.PI);break;case S.POSZ:quat.rotateY(b._rotation,b._rotation,Math.PI)}this.roll&&quat.rotateZ(b._rotation,b._rotation,this.roll*DEG2RAD);b._on_change()}};d.registerComponent(S);Sa.icon="mini-icon-fog.png";Sa.LINEAR=1;Sa.EXP=2;Sa.EXP2=3;Sa["@color"]={type:"color"};Sa["@density"]={type:"number",min:0,max:1,step:1E-4,precision:4};Sa["@type"]={type:"enum",
values:{linear:Sa.LINEAR,exponential:Sa.EXP,"exponential 2":Sa.EXP2}};Sa.prototype.onAddedToScene=function(a){LEvent.bind(a,"fillSceneUniforms",this.fillSceneUniforms,this)};Sa.prototype.onRemovedFromScene=function(a){LEvent.unbind(a,"fillSceneUniforms",this.fillSceneUniforms,this)};Sa.prototype.fillSceneUniforms=function(a,b){this.enabled&&(this._uniforms.u_fog_info[0]=this.start,this._uniforms.u_fog_info[1]=this.end,this._uniforms.u_fog_info[2]=this.density,this._uniforms.u_fog_color=this.color,
d.Renderer.enableFrameShaderBlock("fog",this._uniforms))};d.registerComponent(Sa);var ec=new d.ShaderBlock("fog");ec.bindEvent("fs_functions","\tuniform vec3 u_fog_info;\n\tuniform vec3 u_fog_color;\n");ec.bindEvent("fs_final_pass","\tif(u_light_info.z == 0.0) { float cam_dist = length(u_camera_eye - v_pos);\n\tfloat fog = 1. - 1.0 / exp(max(0.0,cam_dist - u_fog_info.x) * u_fog_info.z);\n\tfinal_color.xyz = mix(final_color.xyz, u_fog_color, fog);\n}\n\n");ec.register();Sa.block=ec;Hb.icon="mini-icon-follow.png";
Hb["@node_id"]={type:d.TYPES.SCENENODE_ID};Hb.prototype.onAddedToScene=function(a){LEvent.bind(a,"beforeRender",this.updatePosition,this)};Hb.prototype.onRemovedFromScene=function(a){LEvent.unbind(a,"beforeRender",this.updatePosition,this)};Hb.prototype.updatePosition=function(a,b){if(this._root&&this._root.transform&&this.enabled){var c=null,c=this._root.scene;if(this.follow_camera){c=d.Renderer._main_camera;if(!c)return;c=c.getEye()}else{var e=c.getNode(this.node_id);if(!e||!e.transform)return;
c=e.transform.getGlobalPosition();this.align&&(this._root.transform.rotation=e.transform.getGlobalRotation())}this.fixed_y&&(c[1]=this._root.transform._position[1]);this._root.transform.position=c}};d.registerComponent(Hb);Object.defineProperty(F.prototype,"geometry",{get:function(){return this._geometry},set:function(a){this._geometry!=a&&(a=void 0===a||null===a?-1:a|0,F.VALID[a]&&(this._geometry=a,this._version++))},enumerable:!0});Object.defineProperty(F.prototype,"size",{get:function(){return this._size},
set:function(a){this._size!=a&&(this._size=a,this._version++)},enumerable:!0});Object.defineProperty(F.prototype,"subdivisions",{get:function(){return this._subdivisions},set:function(a){this._subdivisions!=a&&(this._subdivisions=a,this._version++)},enumerable:!0});Object.defineProperty(F.prototype,"primitive",{get:function(){return this._primitive},set:function(a){a=void 0===a||null===a?-1:a|0;if(-1==a||0==a||1==a||4==a||10==a)this._primitive=a},enumerable:!0});Object.defineProperty(F.prototype,
"point_size",{get:function(){return this._point_size},set:function(a){this._point_size!=a&&(this._point_size=a)},enumerable:!0});Object.defineProperty(F.prototype,"mesh",{get:function(){return this._custom_mesh||this._mesh},set:function(a){if(a&&a.constructor!==GL.Mesh)throw"mesh must be a GL.Mesh";if(this._custom_mesh=a)this._geometry=F.CUSTOM},enumerable:!1});F.CUBE=1;F.PLANE=2;F.CYLINDER=3;F.SPHERE=4;F.CIRCLE=5;F.HEMISPHERE=6;F.ICOSAHEDRON=7;F.CONE=8;F.QUAD=9;F.CUSTOM=100;F.VALID={1:"CUBE",2:"PLANE",
3:"CYLINDER",4:"SPHERE",5:"CIRCLE",6:"HEMISPHERE",7:"ICOSAHEDRON",8:"CONE",9:"QUAD",100:"CUSTOM"};F.icon="mini-icon-cube.png";F["@geometry"]={type:"enum",values:{Cube:F.CUBE,Plane:F.PLANE,Cylinder:F.CYLINDER,Sphere:F.SPHERE,Cone:F.CONE,Icosahedron:F.ICOSAHEDRON,Circle:F.CIRCLE,Hemisphere:F.HEMISPHERE,Quad:F.QUAD,Custom:F.CUSTOM}};F["@primitive"]={widget:"enum",values:{Default:-1,Points:0,Lines:1,Triangles:4,Wireframe:10}};F["@subdivisions"]={type:"number",step:1,min:1,precision:0};F["@point_size"]=
{type:"number",step:0.001};F.prototype.onAddedToNode=function(a){LEvent.bind(a,"collectRenderInstances",this.onCollectInstances,this)};F.prototype.onRemovedFromNode=function(a){LEvent.unbind(a,"collectRenderInstances",this.onCollectInstances,this)};F.prototype.serialize=function(){var a=d.BaseComponent.prototype.serialize.call(this);this._geometry==F.CUSTOM&&this._custom_mesh&&(a.custom_mesh=this._custom_mesh.toJSON());return a};F.prototype.configure=function(a){d.BaseComponent.prototype.configure.call(this,
a);this._geometry==F.PLANE&&!1===a.align_z&&(this._geometry=F.QUAD);a.geometry==F.CUSTOM&&a.custom_mesh&&(this._custom_mesh||(this._custom_mesh=new GL.Mesh),this._custom_mesh.fromJSON(a.custom_mesh));this._version++};F.prototype.updateMesh=function(){var a=Math.max(0,this.subdivisions|0);switch(this._geometry){case F.CUBE:this._mesh=GL.Mesh.cube({size:this.size,normals:!0,coords:!0,wireframe:!0});break;case F.PLANE:this._mesh=GL.Mesh.plane({size:this.size,xz:!0,detail:a,normals:!0,coords:!0});break;
case F.CYLINDER:this._mesh=GL.Mesh.cylinder({size:this.size,subdivisions:a,normals:!0,coords:!0});break;case F.SPHERE:this._mesh=GL.Mesh.sphere({size:this.size,"long":a,lat:a,normals:!0,coords:!0});break;case F.CIRCLE:this._mesh=GL.Mesh.circle({size:this.size,slices:a,normals:!0,coords:!0});break;case F.HEMISPHERE:this._mesh=GL.Mesh.sphere({size:this.size,"long":a,lat:a,normals:!0,coords:!0,hemi:!0});break;case F.ICOSAHEDRON:this._mesh=GL.Mesh.icosahedron({size:this.size,subdivisions:a});break;case F.CONE:this._mesh=
GL.Mesh.cone({radius:this.size,height:this.size,subdivisions:a});break;case F.QUAD:this._mesh=GL.Mesh.plane({size:this.size,xz:!1,detail:a,normals:!0,coords:!0});break;case F.CUSTOM:this._mesh=this._custom_mesh}this._mesh_version=this._version};F.prototype.setCustomMesh=function(a){this._geometry=F.CUSTOM;this._mesh=this._custom_mesh=a};F.prototype.onCollectInstances=function(a,b){if(this.enabled&&this._root){var c=this._render_instance;c||(this._render_instance=c=new d.RenderInstance(this._root,
this));this._mesh&&this._version==this._mesh_version||this.updateMesh();this._mesh&&(c.fromNode(this._root),c.setMesh(this._mesh,this._primitive),this._root.mesh=this._mesh,c.setMaterial(this.material||this._root.getMaterial()),this.primitive==gl.POINTS&&(c.uniforms.u_point_size=this.point_size),b.push(c))}};d.registerComponent(F);Object.defineProperty(Ga.prototype,"textures",{set:function(a){if("object"==typeof a)for(var b in a)if(null===a[b]||a[b].constructor===String||a[b]===GL.Texture)this._textures[b]=
a[b]},get:function(){return this._textures},enumerable:!0});Object.defineProperty(Ga.prototype,"render_settings",{set:function(a){a?"object"==typeof a&&(this._render_settings||(this._render_settings=new d.RenderSettings),a.constructor===Array&&"RenderSettings"==a[3]?this._render_settings.configure(a[2]):this._render_settings.configure(a)):this._render_settings=null},get:function(){return this._render_settings},enumerable:!0});Ga.prototype.computeIrradiance=function(a,b,c,e){if(!d.Components.IrradianceCache)throw"cannot compute, no ONE.Components.IrradianceCache component found";
a=a||vec3.create();var g=d.Components.IrradianceCache.capture_cubemap_size,f={type:gl.FLOAT,texture_type:gl.TEXTURE_CUBE_MAP,format:gl.RGB},h=new GL.Texture(d.Components.IrradianceCache.final_cubemap_size,d.Components.IrradianceCache.final_cubemap_size,f),g=new GL.Texture(g,g,f);d.Components.IrradianceCache.captureIrradiance(a,h,render_settings,b||0.1,c||1E3,e||[0,0,0,1],!0,g);this.irradiance=d.Components.IrradianceCache.computeSH(h);console.log("IR factor",this.irradiance)};Ga.prototype.clearIrradiance=
function(){this.irradiance=null};Ga.icon="mini-icon-bg.png";Ga.DEFAULT_AMBIENT_COLOR=vec3.fromValues(0.2,0.2,0.2);Ga.prototype.onAddedToScene=function(a){a.info=this;LEvent.bind(a,"fillSceneUniforms",this.fillSceneUniforms,this)};Ga.prototype.onRemovedFromScene=function(a){LEvent.unbind(a,"fillSceneUniforms",this.fillSceneUniforms,this)};Ga.prototype.fillSceneUniforms=function(){if(this.irradiance){this._irradiance_final||(this._irradiance_final=new Float32Array(this.irradiance.length));for(var a=
0;a<this._irradiance_final.length;++a)this._irradiance_final[a]=this.irradiance[a]*this._irradiance_color[a%3];this._uniforms.u_sh_coeffs=this._irradiance_final;d.Renderer.enableFrameShaderBlock("applyIrradiance",this._uniforms)}};Ga.prototype.getResources=function(a){for(var b in this._textures)"string"==typeof this._textures[b]&&(a[this._textures[b]]=GL.Texture);return a};Ga.prototype.getPropertiesInfo=function(){return{ambient_color:"color","textures/environment":"texture",render_settings:"RenderSettings"}};
Ga.prototype.setProperty=function(a,b){if("textures/"==a.substr(0,9)&&(!b||b.constructor===String||b.constructor===GL.Texture))return this._textures[a.substr(9)]=b,!0};Ga.prototype.getPropertyInfoFromPath=function(a){if("textures"==a[0]){if(1==a.length)return{node:this._root,target:this._textures,type:"object"};a=a[1];return{node:this._root,target:this._textures,name:a,value:this._textures[a]||null,type:"texture"}}};Ga.prototype.setPropertyValueFromPath=function(a,b,c){c=c||0;a.length<c+1||"textures"==
a[c]&&(this._textures[a[c+1]]=b)};Ga.prototype.onResourceRenamed=function(a,b,c){for(var e in this._textures)this._textures[e]==a&&(this._textures[e]=b)};d.registerComponent(Ga);d.GlobalInfo=Ga;"undefined"!=typeof LiteGraph?("undefined"!=typeof LGraphTexture&&(LGraphTexture.getTexturesContainer=function(){return d.ResourcesManager.textures},LGraphTexture.storeTexture=function(a,b){return d.ResourcesManager.registerResource(a,b)},LGraphTexture.loadTexture=d.ResourcesManager.load.bind(d.ResourcesManager),
LiteGraph.allow_scripts=d.allow_scripts),"undefined"!=typeof LiteGraph.LGraphRender&&(LiteGraph.LGraphRender.onRequestCameraMatrices=function(a,b,c){var e=d.Renderer.getCurrentCamera();e&&(a.set(e._view_matrix),b.set(e._projection_matrix),c.set(e._viewprojection_matrix))}),"undefined"!=typeof LGAudio&&(LGAudio.onProcessAudioURL=function(a){return d.RM.getFullURL(a)}),"undefined"!=typeof LiteGraph&&(LiteGraph.onNodeTypeReplaced=function(a,b,c){a=d.GlobalScene.findNodeComponents(d.Components.GraphComponent);
a=a.concat(d.GlobalScene.findNodeComponents(d.Components.FXGraphComponent));for(b=0;b<a.length;++b)a[b].graph.checkNodeTypes()})):console.warn("Litegraph.js not present, graph nodes would not be available.");ca["@on_event"]={type:"enum",values:"start render beforeRenderScene afterRenderScene update trigger".split(" ")};ca["@filename"]={type:"resource",data_type:"graph"};Object.defineProperty(ca.prototype,"graph",{enumerable:!1,get:function(){return this._graph},set:function(a){console.error("graph cannot be set manually")}});
Object.defineProperty(ca.prototype,"filename",{enumerable:!1,get:function(){return this._filename},set:function(a){this._filename!=a&&(a&&(a=d.ResourcesManager.cleanFullpath(a)),this.from_file=!0,this._filename=a,this._loading=!1,this._graphcode=null,this.processGraph())}});Object.defineProperty(ca.prototype,"graphcode",{enumerable:!1,get:function(){return this._graphcode},set:function(a){this._loading=!1;this._graphcode=a;this.from_file=!0;this._filename=this._graphcode?this._graphcode.fullpath||
this._graphcode.filename:null;this._graph_properties=this.serializeProperties();this.processGraph()}});ca.icon="mini-icon-graph.png";ca.prototype.configure=function(a){this._graph_version=-1;a.uid&&(this.uid=a.uid);null!=a.enabled&&(this.enabled=!!a.enabled);a.title&&(this.title=String(a.title));if(a.from_file)this.from_file=!0,this.filename=a.filename,a.graph_properties&&(this._loading?this._graph_properties=a.graph_properties:this.configureProperties(a.graph_properties));else if(a.graph_data)if(this.from_file=
!1,d.catch_exceptions)try{var b=JSON.parse(a.graph_data);!0==this._graph.configure(b)&&(d.GlobalScene.has_errors=!0)}catch(c){console.error("Error configuring Graph data: "+c)}else b=JSON.parse(a.graph_data),!0==this._graph.configure(b)&&(d.GlobalScene.has_errors=!0);a.on_event&&(this.on_event=a.on_event);null!=a.force_redraw&&(this.force_redraw=a.force_redraw)};ca.prototype.serialize=function(){return{object_class:"GraphComponent",uid:this.uid,title:this.title,enabled:this.enabled,from_file:this.from_file,
force_redraw:this.force_redraw,filename:this._filename,graph_properties:this.from_file?this.serializeProperties():null,graph_data:this.from_file?null:JSON.stringify(this._graph.serialize()),on_event:this.on_event}};ca.prototype.getResources=function(a){this._filename&&(a[this._filename]=!0);this._graph.sendEventToAllNodes("getResources",a);return a};ca.prototype.onAddedToNode=function(a){this._graph._scenenode=a};ca.prototype.onRemovedFromNode=function(a){this._graph._scenenode=null};ca.prototype.onAddedToScene=
function(a){this._graph._scene=a;LEvent.bind(a,d.EVENT.INIT,this.onSceneEvent,this);LEvent.bind(a,d.EVENT.START,this.onSceneEvent,this);LEvent.bind(a,d.EVENT.PAUSE,this.onSceneEvent,this);LEvent.bind(a,d.EVENT.UNPAUSE,this.onSceneEvent,this);LEvent.bind(a,d.EVENT.FINISH,this.onSceneEvent,this);LEvent.bind(a,d.EVENT.BEFORE_RENDER_MAIN_PASS,this.onSceneEvent,this);LEvent.bind(a,d.EVENT.BEFORE_RENDER_SCENE,this.onSceneEvent,this);LEvent.bind(a,d.EVENT.AFTER_RENDER_SCENE,this.onSceneEvent,this);LEvent.bind(a,
d.EVENT.UPDATE,this.onSceneEvent,this);LEvent.bind(a,d.EVENT.RENDER_GUI,this.onRenderGUI,this);LEvent.bind(a,d.EVENT.MOUSEDOWN,this.onMouse,this);LEvent.bind(a,d.EVENT.MOUSEMOVE,this.onMouse,this);LEvent.bind(a,d.EVENT.MOUSEUP,this.onMouse,this)};ca.prototype.onRemovedFromScene=function(a){this._graph._scene=null;LEvent.unbind(a,d.EVENT.INIT,this.onSceneEvent,this);LEvent.unbind(a,d.EVENT.START,this.onSceneEvent,this);LEvent.unbind(a,d.EVENT.PAUSE,this.onSceneEvent,this);LEvent.unbind(a,d.EVENT.UNPAUSE,
this.onSceneEvent,this);LEvent.unbind(a,d.EVENT.FINISH,this.onSceneEvent,this);LEvent.unbind(a,d.EVENT.BEFORE_RENDER_MAIN_PASS,this.onSceneEvent,this);LEvent.unbind(a,d.EVENT.BEFORE_RENDER_SCENE,this.onSceneEvent,this);LEvent.unbind(a,d.EVENT.AFTER_RENDER_SCENE,this.onSceneEvent,this);LEvent.unbind(a,d.EVENT.UPDATE,this.onSceneEvent,this);LEvent.unbind(a,d.EVENT.RENDER_GUI,this.onRenderGUI,this);LEvent.unbind(a,d.EVENT.MOUSEDOWN,this.onMouse,this);LEvent.unbind(a,d.EVENT.MOUSEMOVE,this.onMouse,this);
LEvent.unbind(a,d.EVENT.MOUSEUP,this.onMouse,this)};ca.prototype.onResourceRenamed=function(a,b,c){a==this._filename&&(this._filename=b);this._graph.sendEventToAllNodes("onResourceRenamed",[a,b,c])};ca.prototype.onRenderGUI=function(a,b){this.enabled&&this._root.visible&&this._graph.sendEventToAllNodes("onRenderGUI",b)};ca.prototype.onMouse=function(a,b){this.enabled&&this._root.visible&&this._graph.sendEventToAllNodes("onMouse",b)};ca.prototype.onSceneEvent=function(a,b){"beforeRenderMainPass"==
a&&(a="render");"init"==a?this._graph.sendEventToAllNodes("onInit"):"start"==a?(this._graph.sendEventToAllNodes("onStart"),this._graph.status=LGraph.STATUS_RUNNING):"pause"==a?(this._graph.sendEventToAllNodes("onPause"),this._graph.status=LGraph.STATUS_RUNNING):"unpause"==a?(this._graph.sendEventToAllNodes("onUnpause"),this._graph.status=LGraph.STATUS_RUNNING):"finish"==a&&(this._graph.sendEventToAllNodes("onStop"),this._graph.status=LGraph.STATUS_STOPPED);this.on_event==a&&this._root._in_tree&&this.enabled&&
this.runGraph()};ca.prototype.trigger=function(a){"trigger"==this.on_event&&this.runGraph()};ca.prototype.runGraph=function(){if(!this.from_file||this._graphcode)this._graph.runStep(1,d.catch_exceptions),this.force_redraw&&this._root.scene.requestFrame()};ca.prototype.processGraph=function(a,b){if(this.from_file){var c=this;(this._graphcode=d.ResourcesManager.getResource(this._filename))||this._loading?(this._graph.configure(this._graphcode.data),this._graph_properties&&(this.configureProperties(this._graph_properties),
this._graph_properties=null),this._graph_version=this._graphcode._version):(this._loading=!0,d.ResourcesManager.load(this._filename,null,function(e,d){this._loading=!1;d==c.filename&&(c.processGraph(a),b&&b(c))}))}};ca.prototype.getResources=function(a){a[this._filename]=!0;this._graph.sendEventToAllNodes("getResources",a);return a};ca.prototype.serializeProperties=function(){var a={},b=this._graph.findNodesByType("scene/global");if(!b.length)return a;for(var c=0;c<b.length;++c){var e=b[c];a[e.id]=
e.properties.value}return a};ca.prototype.configureProperties=function(a){var b=this._graph.findNodesByType("scene/global");if(!b.length)return a;for(var c=0;c<b.length;++c){var e=b[c];void 0!==a[e.id]&&(e.properties.value=a[e.id])}};ca.prototype.getPropertyValue=function(a){var b=this._graph.findNodesByType("scene/global");if(!b.length)return null;for(var c=0;c<b.length;++c){var e=b[c];if(e.properties.name==a)return e.properties.value}};ca.prototype.setPropertyValue=function(a,b){var c=this._graph.findNodesByType("scene/global");
if(c.length)for(var e=0;e<c.length;++e){var d=c[e];if(d.properties.name==a)return d.properties.value&&d.properties.value.set?d.properties.value.set(b):d.properties.value=b,!0}};ca.prototype.getActions=function(a){a=a||{};a.runGraph="function";return a};ca.prototype.getComponentTitle=function(){return this.title};d.registerComponent(ca);ea.icon="mini-icon-graph.png";ea.buffer_size=[1024,512];Object.defineProperty(ea.prototype,"graph",{enumerable:!1,get:function(){return this._graph},set:function(a){console.error("graph cannot be set manually")}});
Object.defineProperty(ea.prototype,"render_node",{enumerable:!1,get:function(){return this._graph_frame_node},set:function(a){console.error("render_node cannot be set manually")}});Object.defineProperty(ea.prototype,"viewport_node",{enumerable:!1,get:function(){return this._graph_viewport_node},set:function(a){console.error("viewport_node cannot be set manually")}});ea.prototype.configure=function(a){if(this._graph&&a.graph_data&&(this.uid=a.uid,this.enabled=!!a.enabled,a.title&&(this.title=a.title),
this.use_antialiasing=!!a.use_antialiasing,this.use_node_camera=!!a.use_node_camera,a.frame&&this.frame.configure(a.frame),a=JSON.parse(a.graph_data),!0==this._graph.configure(a)&&(d.GlobalScene.has_error=!0),this._graph_frame_node=this._graph.findNodesByTitle("Rendered Frame")[0],this._graph_viewport_node=this._graph.findNodesByType("texture/toviewport")[0],!this._graph_frame_node)){console.log("CONVERTING LEGACY DATA TO NEW FORMAT");this._graph_frame_node=LiteGraph.createNode("scene/frame","Rendered Frame");
this._graph_frame_node.ignore_remove=!0;this._graph_frame_node.ignore_rename=!0;this._graph.add(this._graph_frame_node);a=["Color Buffer","Depth Buffer","Extra Buffer"];for(var b=0;b<a.length;++b){var c=this._graph.findNodesByTitle(a[b])[0];if(c){var e=c.getOutputInfo(0);if(e.links){var e=e.links.concat(),g;for(g in e){var f=this._graph.links[e[g]];f&&this._graph_frame_node.connect(b,f.target_id,f.target_slot)}this._graph.remove(c)}}}}};ea.prototype.serialize=function(){return{object_class:"FXGraphComponent",
uid:this.uid,enabled:this.enabled,title:this.title,use_antialiasing:this.use_antialiasing,frame:this.frame.serialize(),use_node_camera:this.use_node_camera,graph_data:this._graph?JSON.stringify(this._graph.serialize()):null}};ea.prototype.getResources=function(a){if(this._graph)return this._graph.sendEventToAllNodes("getResources",a),a};ea.prototype.getPropertyValue=function(a){var b=this._graph.findNodesByType("scene/global");if(b.length)for(var c=0;c<b.length;++c){var e=b[c];if(e.properties.name==
a)return e.properties.value}};ea.prototype.setPropertyValue=function(a,b){var c=this._graph.findNodesByType("scene/global");if(c.length)for(var e=0;e<c.length;++e){var d=c[e];if(d.properties.name==a)return d.properties.value&&d.properties.value.set?d.properties.value.set(b):d.properties.value=b,!0}};ea.prototype.onRenderGUI=ca.prototype.onRenderGUI;ea.prototype.onResourceRenamed=function(a,b,c){this._graph&&this._graph.sendEventToAllNodes("onResourceRenamed",[a,b,c])};ea.prototype.onAddedToNode=function(a){this._graph&&
(this._graph._scenenode=a)};ea.prototype.onRemovedFromNode=function(a){this._graph&&(this._graph._scenenode=null)};ea.prototype.onAddedToScene=function(a){this._graph&&(this._graph._scene=a,LEvent.bind(a,d.EVENT.BEFORE_RENDER,this.onBeforeRender,this),LEvent.bind(a,d.EVENT.ENABLE_FRAME_CONTEXT,this.onEnableContext,this),LEvent.bind(a,d.EVENT.SHOW_FRAME_CONTEXT,this.onAfterRender,this),LEvent.bind(a,d.EVENT.RENDER_GUI,this.onRenderGUI,this))};ea.prototype.onRemovedFromScene=function(a){this._graph&&
(this._graph._scene=null,LEvent.unbind(a,d.EVENT.BEFORE_RENDER,this.onBeforeRender,this),LEvent.unbind(a,d.EVENT.ENABLE_FRAME_CONTEXT,this.onEnableContext,this),LEvent.unbind(a,d.EVENT.SHOW_FRAME_CONTEXT,this.onAfterRender,this),LEvent.unbind(a,d.EVENT.RENDER_GUI,this.onRenderGUI,this),d.ResourcesManager.unregisterResource(":color_"+this.uid),d.ResourcesManager.unregisterResource(":depth_"+this.uid),d.ResourcesManager.unregisterResource(":extra_"+this.uid))};ea.prototype.onBeforeRender=function(a,
b){this.enabled&&this._graph&&this._root.visible&&this._graph.sendEventToAllNodes("onPreRenderExecute")};ea.prototype.onEnableContext=function(a,b){this._last_camera=d.Renderer._main_camera;if(this.enabled&&this._root.visible)if(this.use_node_camera){var c=this._root.camera;c&&c!=this._binded_camera&&(this._binded_camera&&LEvent.unbindAll(this._binded_camera,this),LEvent.bind(c,"enableFrameContext",this.enableCameraFBO,this),LEvent.bind(c,"showFrameContext",this.showCameraFBO,this));this._binded_camera=
c}else this._binded_camera&&(LEvent.unbindAll(this._binded_camera,this),this._binded_camera=null),this.enableGlobalFBO(b);else this._binded_camera&&(LEvent.unbindAll(this._binded_camera,this),this._binded_camera=null)};ea.prototype.onAfterRender=function(a,b){this.enabled&&this._root.visible&&(this.use_node_camera||this.showFBO())};ea.prototype.enableCameraFBO=function(a,b){if(this.enabled&&this._root.visible){var c=this._viewport=this._binded_camera.getLocalViewport(null,this._viewport);this.frame.enable(b,
c);b.ignore_viewports=!0}};ea.prototype.showCameraFBO=function(a,b){this.enabled&&this._root.visible&&(b.ignore_viewports=!1,this.showFBO())};ea.prototype.enableGlobalFBO=function(a){this.enabled&&this._root.visible&&(this.frame.enable(a,null,d.Renderer._main_camera),this._graph&&this._graph.sendEventToAllNodes("onPreRenderExecute"))};ea.prototype.showFBO=function(){this.enabled&&this._root.visible&&(this.frame.disable(),this.applyGraphToRenderFrameContext(this.frame))};ea.prototype.applyGraphToRenderFrameContext=
function(a){d.ResourcesManager.textures[":color_"+this.uid]=a._color_texture;d.ResourcesManager.textures[":depth_"+this.uid]=a._depth_texture;if(a.num_extra_textures)for(var b=0;b<a.num_extra_textures;++b)d.ResourcesManager.textures[":extra"+b+"_"+this.uid]=a._textures[b+1];this.use_node_camera&&this._viewport?(gl.setViewport(this._viewport),this.executeGraph(a.filter_texture),gl.setViewport(a._fbo._old_viewport)):this.executeGraph(a.filter_texture)};ea.prototype.executeGraph=function(a){this._graph&&
(void 0===a&&(a=!0),this._graph_frame_node||(this._graph_frame_node=this._graph.findNodesByTitle("Rendered Frame")[0]),this._graph_frame_node._color_texture=":color_"+this.uid,this._graph_frame_node._depth_texture=":depth_"+this.uid,this._graph_frame_node._extra_texture=":extra0_"+this.uid,this._graph_frame_node._camera=this._last_camera,this._graph_frame_node._extra_texture=":extra0_"+this.uid,this._graph_frame_node.isOutputConnected(1)&&(this.frame.use_depth_texture=!0),this._graph_viewport_node&&
(this._graph_viewport_node.properties.filter=a,this._graph_viewport_node.properties.antialiasing=this.use_antialiasing),this._graph.runStep(1,d.catch_exceptions))};ea.prototype.getComponentTitle=ca.prototype.getComponentTitle;d.registerComponent(ea);(function(){function a(a){this.enabled=!0;this.value=0;this.delta=0.01;this.min_value=this.steps=0;this.max_value=1;this.min_angle=-120;this.max_angle=120;this.axis=vec3.fromValues(0,0,1);this._dragging=!1;a&&this.configure(a)}a.icon="mini-icon-knob.png";
a.prototype.onAddedToScene=function(a){LEvent.bind(a,"mousedown",this.onMouse,this);LEvent.bind(a,"mouseup",this.onMouse,this);LEvent.bind(a,"mousemove",this.onMouse,this);this.updateKnob()};a.prototype.onRemovedFromScene=function(a){LEvent.unbindAll(a,this)};a.prototype.updateKnob=function(){this._root&&this.enabled&&(quat.setAxisAngle(this._root.transform._rotation,this.axis,(this.min_angle+this.value/(this.max_value-this.min_value)*(this.max_angle-this.min_angle))*DEG2RAD),this._root.transform.mustUpdate=
!0)};a.prototype.onMouse=function(a,c){if(this.enabled)if("mousedown"==a){if(this._root&&this._root._instances&&this._root._instances.length){var e=this._root._instances[0],g=d.Renderer.getCameraAtPosition(c.canvasx,c.canvasy);g&&(g=g.getRay(c.canvasx,c.canvasy))&&(this._dragging=geo.testRayBBox(g.origin,g.direction,e.aabb))}}else if("mouseup"==a)this._dragging=!1;else if(c.dragging&&this._dragging)return this.value-=c.deltay*this.delta,this.value>this.max_value?this.value=this.max_value:this.value<
this.min_value&&(this.value=this.min_value),this.updateKnob(),LEvent.trigger(this,"change",this.value),this._root&&LEvent.trigger(this._root,"knobChange",this.value),!1};d.registerComponent(a)})();Object.defineProperty(Sb.prototype,"pos",{get:function(){return this._pos},set:function(a){this._pos.set(a)},enumerable:!0});Object.defineProperty(Sb.prototype,"vel",{get:function(){return this._vel},set:function(a){this._vel.set(a)},enumerable:!0});T.BOX_EMISSOR=1;T.SPHERE_EMISSOR=2;T.MESH_EMISSOR=3;T.NODE_EMISSOR=
4;T.CUSTOM_EMISSOR=10;T["@emissor_type"]={type:"enum",values:{Box:T.BOX_EMISSOR,Sphere:T.SPHERE_EMISSOR,Mesh:T.MESH_EMISSOR,Node:T.NODE_EMISSOR,Custom:T.CUSTOM_EMISSOR}};T.icon="mini-icon-particles.png";Object.defineProperty(T.prototype,"particle_start_color",{get:function(){return this._particle_start_color},set:function(a){a&&this._particle_start_color.set(a)},enumerable:!0});Object.defineProperty(T.prototype,"particle_end_color",{get:function(){return this._particle_end_color},set:function(a){a&&
this._particle_end_color.set(a)},enumerable:!0});T.prototype.onAddedToScene=function(a){LEvent.bind(a,"update",this.onUpdate,this);LEvent.bind(a,"start",this.onStart,this);LEvent.bind(a,"collectRenderInstances",this.onCollectInstances,this);LEvent.bind(a,"afterCameraEnabled",this.onAfterCamera,this)};T.prototype.onRemovedFromScene=function(a){LEvent.unbindAll(a,this)};T.prototype.getResources=function(a){this.emissor_mesh&&(a[this.emissor_mesh]=Mesh);this.texture&&(a[this.texture]=Texture)};T.prototype.onResourceRenamed=
function(a,b,c){this.emissor_mesh==a&&(this.emissor_mesh=b);this.texture==a&&(this.texture=b)};T.prototype.onAfterCamera=function(a,b){this.enabled&&this.align_always&&this.updateMesh(b)};T.prototype.createParticle=function(a){a=a||new Sb;switch(this.emissor_type){case T.BOX_EMISSOR:a._pos.set([this.emissor_size[0]*(Math.random()-0.5),this.emissor_size[1]*(Math.random()-0.5),this.emissor_size[2]*(Math.random()-0.5)]);break;case T.SPHERE_EMISSOR:var b=2*Math.PI*Math.random(),c=Math.acos(2*Math.random()-
1);a._pos.set([Math.sin(c)*Math.cos(b),Math.sin(c)*Math.sin(b),Math.cos(c)]);vec3.multiply(a.pos,a.pos,this.emissor_size);break;case T.MESH_EMISSOR:(c=this.emissor_mesh)&&c.constructor===String&&(c=d.ResourcesManager.getMesh(this.emissor_mesh));if(c&&c.getBuffer("vertices")){var c=c.getBuffer("vertices").data,e=3*Math.floor(Math.random()*c.length/3);a._pos.set([c[e]+0.001*Math.random(),c[e+1]+0.001*Math.random(),c[e+2]+0.001*Math.random()])}else a._pos.set([0,0,0]);break;case T.NODE_EMISSOR:(b=this.emissor_node)&&
b.constructor===String&&(b=d.GlobalScene.getNode(b));if(b&&(c=b.getMesh())&&c.getBuffer("vertices")){c=c.getBuffer("vertices").data;e=3*Math.floor(Math.random()*c.length/3);a._pos.set([c[e]+0.001*Math.random(),c[e+1]+0.001*Math.random(),c[e+2]+0.001*Math.random()]);b.transform&&b.transform.localToGlobal(a._pos,a._pos);break}a._pos.set([0,0,0])}a._vel.set([Math.random()-0.5,Math.random()-0.5,Math.random()-0.5]);a.life=this.particle_life;a.id=this._last_id;a.angle=0;a.size=1;a.rot=this.particle_rotation+
0.25*this.particle_rotation*Math.random();this._last_id+=1;this.independent_color&&(a.c=vec3.clone(this.particle_start_color));vec3.scale(a._vel,a._vel,this.particle_speed);if(this.emissor_type==T.CUSTOM_EMISSOR&&this.onCreateParticle)this.onCreateParticle(a,this);this.follow_emitter||vec3.add(a._pos,a._pos,this._emissor_pos);return a};T.prototype.onStart=function(a){if(this.enabled&&!(0>=this.warm_up_time)){a=1/30;for(var b=0;b<this.warm_up_time;b+=a)this.onUpdate(null,a,!0)}};T.prototype.onUpdate=
function(a,b,c){if(this.enabled){if(!this._root.scene)throw"update without scene? impossible";this._root.transform&&this._root.transform.getGlobalPosition(this._emissor_pos);0>this.emissor_rate&&(this.emissor_rate=0);if(!this.stop_update){var e=vec3.clone(this.physics_gravity),g=this.physics_friction;a=[];for(var f=vec3.create(),h=0,k=this._particles.length;h<k;++h){var l=this._particles[h];vec3.copy(f,l._vel);vec3.add(f,e,f);vec3.scale(f,f,b);g&&(f[0]-=f[0]*g,f[1]-=f[1]*g,f[2]-=f[2]*g);vec3.add(l._pos,
f,l._pos);l.angle+=l.rot*b;l.life-=b;if(this.onUpdateParticle)this.onUpdateParticle(l,b,this);0<l.life&&a.push(l)}if(0!=this.emissor_rate)for(b=(b+this._remining_dt)*this.emissor_rate,this._remining_dt=b%1/this.emissor_rate,b<<=0,b>this.max_particles&&(b=this.max_particles),h=0;h<b;h++)l=this.createParticle(),a.length<this.max_particles&&a.push(l);this._particles=a}this.align_always||c||(this.updateMesh(d.Renderer._current_camera),this._root.scene.requestFrame());LEvent.trigger(this._root.scene,"change")}};
T.prototype.createMesh=function(){if(this._mesh_maxparticles!=this.max_particles){this._vertices=new Float32Array(18*this.max_particles);this._coords=new Float32Array(12*this.max_particles);this._colors=new Float32Array(24*this.max_particles);this._extra2=new Float32Array(2*this.max_particles);for(var a=[1,1,0,1,1,0,0,1,0,0,1,0],b=[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],c=0;c<this.max_particles;c++)this._coords.set(a,12*c),this._colors.set(b,24*c),this._extra2[2*c]=1,this._extra2[2*c+1]=
c;this._computed_grid_size=1;this._mesh=new GL.Mesh;this._mesh.addBuffers({vertices:this._vertices,coords:this._coords,colors:this._colors,extra2:this._extra2},null,gl.STREAM_DRAW);this._mesh_maxparticles=this.max_particles}};T._tmp_quat=quat.create();T.prototype.updateMesh=function(a){if(a){this._mesh_maxparticles!=this.max_particles&&this.createMesh();var b=a.getEye(),c=this._min_particle_size,e=a.getLocalVector([0,0,1]),g=a.getLocalVector([1,0,0]),f=a.getLocalVector([0,1,0]);a=vec3.create();var h=
vec3.fromValues(-1,0,-1),k=vec3.fromValues(1,0,-1),l=vec3.fromValues(-1,0,1),m=vec3.fromValues(1,0,1);this.align_with_camera&&(vec3.subtract(h,f,g),vec3.add(k,f,g),vec3.scale(l,k,-1),vec3.scale(m,h,-1));var g=vec3.create(),f=vec3.create(),p=vec3.create(),n=vec3.create(),r=this._particles;if(this.sort_in_z){for(var r=this._particles.concat(),t=geo.createPlane(b,e),x=1/Math.sqrt(t[0]*t[0]+t[1]*t[1]+t[2]*t[2]),b=0;b<r.length;++b)r[b]._dist=Math.abs(vec3.dot(r[b]._pos,t)+t[3])*x;r.sort(function(a,b){return a._dist<
b._dist?1:a._dist>b._dist?-1:0});this._particles=r}0==this.particle_life&&(this.particle_life=1E-4);var t=new Float32Array([1,1,1,1]),x=this._particle_start_color,u=this._particle_end_color,L=!1;if(this._computed_grid_size!=this.texture_grid_size||1<this.texture_grid_size||this.point_particles)L=!0,this._computed_grid_size=this.texture_grid_size;for(var q=1/this.texture_grid_size,s=0,G=0,v=this.texture_grid_size<<2,w=this.animated_texture,z=this.loop_animation,B=this._root.scene.getTime()*this.animation_fps,
D=new Float32Array(60*this.particle_life<<0),A=new Float32Array(60*this.particle_life<<0),y=this.particle_size,C=1/(60*this.particle_life),b=0;b<D.length;b+=1)D[b]=d.getCurveValueAt(this.particle_opacity_curve,0,1,0,b*C),A[b]=d.getCurveValueAt(this.particle_size_curve,0,1,0,b*C);for(var C=this.point_particles,H=this._vertices.length,E=this._vertices,F=this._colors,I=this._extra2,K=this._coords,M=T._tmp_quat,N=s=b=0,O=r.length;N<O;++N)if(G=r[N],!(0>=G.life)){var s=1-G.life/this.particle_life,J=D[s*
D.length<<0];this.independent_color&&G.c?vec3.clone(t,G.c):vec3.lerp(t,x,u,s);this.premultiplied_alpha?(vec3.scale(t,t,J),t[3]=1):t[3]=J;if(!(0.001>J||(J=G.size*A[s*A.length<<0],Math.abs(J*y)<c)))if(C){if(E.set(G._pos,3*b),F.set(t,4*b),L&&(s=(w?(z?B:s)*v<<0:G.id)%v,s*=q,G=1-(s<<0)*q-q,s%=1,K[2*b]=s,K[2*b+1]=G),I[2*b]=J,I[2*b+1]=b,++b,3*b>=H)break}else if(J*=y,vec3.scale(p,l,J),vec3.scale(f,k,J),vec3.scale(g,h,J),vec3.scale(n,m,J),0!=G.angle&&(quat.setAxisAngle(M,e,G.angle*DEG2RAD),vec3.transformQuat(p,
p,M),vec3.transformQuat(f,f,M),vec3.transformQuat(g,g,M),vec3.transformQuat(n,n,M)),vec3.add(a,G._pos,f),E.set(a,18*b),vec3.add(a,G._pos,g),E.set(a,18*b+3),vec3.add(a,G._pos,n),E.set(a,18*b+6),vec3.add(a,G._pos,g),E.set(a,18*b+9),vec3.add(a,G._pos,p),E.set(a,18*b+12),vec3.add(a,G._pos,n),E.set(a,18*b+15),F.set(t,24*b),F.set(t,24*b+4),F.set(t,24*b+8),F.set(t,24*b+12),F.set(t,24*b+16),F.set(t,24*b+20),L&&(s=(w?(z?B:s)*v<<0:G.id)%v,s*=q,G=1-(s<<0)*q-q,s%=1,K.set([s+q,G+q,s,G+q,s+q,G,s,G+q,s,G,s+q,G],
12*b)),++b,18*b>=H)break}this._visible_particles=b;this._mesh.vertexBuffers.vertices.data=this._vertices;this._mesh.vertexBuffers.vertices.upload(gl.STREAM_DRAW);this._mesh.vertexBuffers.colors.data=this._colors;this._mesh.vertexBuffers.colors.upload(gl.STREAM_DRAW);this._mesh.vertexBuffers.extra2.data=this._extra2;this._mesh.vertexBuffers.extra2.upload(gl.STREAM_DRAW);L&&(this._mesh.vertexBuffers.coords.data=this._coords,this._mesh.vertexBuffers.coords.upload(gl.STREAM_DRAW))}};T._identity=mat4.create();
T.prototype.onCollectInstances=function(a,b,c){if(this._root&&this.enabled){this._material||(this._material=new d.StandardMaterial);this._material.opacity=this.opacity-0.01;this._material.setTexture("color",this.texture);this._material.blend_mode=this.additive_blending?d.Blend.ADD:d.Blend.ALPHA;this._material.constant_diffuse=!0;this._material.uvs_matrix[0]=this._material.uvs_matrix[4]=1/this.texture_grid_size;this._material.flags.depth_write=!1;this._material.flags.ignore_lights=this.ignore_lights;
if(!this._mesh)return null;a=this._render_instance;a||(this._render_instance=a=new d.RenderInstance(this._root,this));this.point_particles?(a.addShaderBlock(d.Shaders.extra2_block),a.addShaderBlock(Ib)):(a.removeShaderBlock(d.Shaders.extra2_block),a.removeShaderBlock(Ib));this.follow_emitter?mat4.translate(a.matrix,T._identity,this._root.transform._position):(mat4.copy(a.matrix,T._identity),this._root.transform&&this._root.transform.getGlobalPosition(a.center));c=this._root.material&&this.use_node_material?
this._root.getMaterial():this._material;mat4.multiplyVec3(a.center,a.matrix,vec3.create());a.setMaterial(c);this.point_particles?(a.setMesh(this._mesh,gl.POINTS),a.uniforms.u_point_size=this.particle_size,a.setRange(0,this._visible_particles)):(a.setMesh(this._mesh,gl.TRIANGLES),a.setRange(0,6*this._visible_particles),delete a.uniforms.u_point_size);a.use_bounding=!1;b.push(a)}};d.Particle=Sb;d.registerComponent(T);lb.icon="mini-icon-text.png";lb.CSS_classname="LS3D_label";lb.prototype.onAddedToScene=
function(a){LEvent.bind(a,"renderGUI",this.render,this)};lb.prototype.onRemovedFromScene=function(a){LEvent.unbind(a,"renderGUI",this.render,this);this.removeHTML()};lb.prototype.createHTML=function(){var a=document.createElement("div");a.innerHTML=this.text;var b=a.style;b.className=this.constructor.CSS_classname;b.position="absolute";b.top=0;b.left=0;b.fontSize="20px";b.padding="10px";b.color="white";b.minWidth="100px";b.pointerEvents="none";b.backgroundColor="rgba(0,0,0,0.5)";b.borderRadius="2px";
d.getGUIElement().appendChild(a);this._element=a};lb.prototype.removeHTML=function(){this._element&&(this._element.parentNode&&this._element.parentNode.removeChild(this._element),this._element=null)};lb.prototype.render=function(a,b){var c=this._root,e=d.Renderer._main_camera;if(e)if(c.transform.getGlobalPosition(this._world_pos),e.project(this._world_pos,null,this._screen_pos),this.use_html)this._element||this.createHTML(),this._element.innerHTML!=this.text&&(this._element.innerHTML=this.text),this._element.style.display=
!1===c.flags.visible?"none":"block",this.text?(c=this.constructor.CSS_classname+" "+this.className,this._element.className!=c&&(this._element.className=c),this._element.style.left=this._screen_pos[0].toFixed(0)+"px",this._element.style.top=gl.canvas.height-(this._screen_pos[1]|0)-10+"px"):this._element.style.display="none";else if(this._element&&this.removeHTML(),gl.start2D){c=this._screen_pos[0]+5;e=gl.canvas.height-this._screen_pos[1]+10;gl.start2D();gl.font="20px Arial";var g=gl.measureText(this.text);
gl.fillStyle="black";gl.globalAlpha=0.5;gl.fillRect(c-5,e-20,g.width+10,26);gl.globalAlpha=1;gl.fillStyle="white";gl.fillText(this.text,c,e);gl.finish2D()}};d.registerComponent(lb);fa.icon="mini-icon-points.png";fa["@texture"]={widget:"texture"};fa["@color"]={widget:"color"};fa["@num_points"]={widget:"info"};fa["@size"]={type:"number",step:0.001,precision:3};fa.default_color=vec4.fromValues(1,1,1,1);Object.defineProperty(fa.prototype,"num_points",{set:function(a){},get:function(){return this._points.length},
enumerable:!0});Object.defineProperty(fa.prototype,"mustUpdate",{set:function(a){this._mustUpdate=a},get:function(){return this._mustUpdate},enumerable:!1});fa.prototype.addPoint=function(a,b,c,e){var d=new Float32Array(10);d.set(a,0);b?d.set(b,3):d.set(fa.default_color,3);d[7]=void 0!==c?c:1;d[8]=void 0!=e?e:0;this._points.push(d);this._must_update=!0;return this._points.length-1};fa.prototype.clear=function(){this._points.length=0};fa.prototype.reset=fa.prototype.clear;fa.prototype.setPoint=function(a,
b,c,e,d){var f=this._points[a];f&&(b&&f.set(b,0),c&&f.set(c,3),void 0!==e&&(f[7]=e),f[8]=void 0!==d?d:a,this._must_update=!0)};fa.prototype.getPoint=function(a){return this._points[a]};fa.prototype.removePoint=function(a){this._points.splice(a,1);this._must_update=!0};fa.prototype.onAddedToNode=function(a){LEvent.bind(a,"collectRenderInstances",this.onCollectInstances,this)};fa.prototype.onRemovedFromNode=function(a){LEvent.unbind(a,"collectRenderInstances",this.onCollectInstances,this)};fa.prototype.getResources=
function(a){this.mesh&&(a[this.emissor_mesh]=Mesh);this.texture&&(a[this.texture]=Texture)};fa.prototype.onResourceRenamed=function(a,b,c){this.mesh==a&&(this.mesh=b);this.texture==a&&(this.texture=b)};fa.prototype.createMesh=function(){var a=this.max_points|0;if(this._mesh_max_points!=a){this._vertices=new Float32Array(3*a);this._colors=new Float32Array(4*a);this._extra2=new Float32Array(2*a);for(var b=0;b<a;b++)this._colors.set(fa.default_color,4*b),this._extra2[2*b]=1;this._mesh&&this._mesh.deleteBuffers();
this._mesh=new GL.Mesh;this._mesh.addBuffers({vertices:this._vertices,colors:this._colors,extra2:this._extra2},null,gl.STREAM_DRAW);this._mesh_max_points=a}};fa.prototype.updateMesh=function(a){if(this._points.length){this._mesh_max_points!=(this.max_points|0)&&this.createMesh();var b=this._points;if(this.sort_in_z&&a){var c=a.getEye();a=a.getFront();b=this._points.concat();c=geo.createPlane(c,a);a=Math.sqrt(c[0]*c[0]+c[1]*c[1]+c[2]*c[2]);for(var e=0;e<b.length;++e)b[e][9]=Math.abs(vec3.dot(b[e].subarray(0,
3),c)+c[3])/a;b.sort(function(a,b){return a[9]<b[9]?1:a[9]>b[9]?-1:0})}c=this._min;a=this._max;var e=0,e=this._vertices,d=this._colors,f=this._extra2;c[0]=a[0]=b[0][0];c[1]=a[1]=b[0][1];c[2]=a[2]=b[0][2];for(var h=0;h<b.length&&!(3*h>=e.length);++h){var k=b[h];e[3*h]=k[0];e[3*h+1]=k[1];e[3*h+2]=k[2];k[0]<c[0]&&(c[0]=k[0]);k[1]<c[1]&&(c[1]=k[1]);k[2]<c[2]&&(c[2]=k[2]);k[0]>a[0]&&(a[0]=k[0]);k[1]>a[1]&&(a[1]=k[1]);k[2]>a[2]&&(a[2]=k[2]);k.subarray(3,7);d[4*h]=k[3];d[4*h+1]=k[4];d[4*h+2]=k[5];d[4*h+
3]=k[6];f[2*h]=k[7];f[2*h+1]=k[8]}this._mesh.vertexBuffers.vertices.data=e;this._mesh.vertexBuffers.vertices.upload();this._mesh.vertexBuffers.colors.data=d;this._mesh.vertexBuffers.colors.upload();this._mesh.vertexBuffers.extra2.data=f;this._mesh.vertexBuffers.extra2.upload()}};fa._identity=mat4.create();fa.prototype.onCollectInstances=function(a,b,c){if(this._root&&0!=this._points.length&&this.enabled){a=d.Renderer._current_camera;this._must_update&&this.updateMesh(a);this._material||(this._material=
new d.StandardMaterial);c=this._material;c.color.set(this.color);c.opacity=this.global_opacity;c.setTexture(d.Material.COLOR,this.texture,{uvs:B.COORDS_UV_POINTCOORD});c.blend_mode=this.additive_blending?d.Blend.ADD:d.Blend.ALPHA;c.flags.depth_write=!this.additive_blending;c.translucency=1;c.flags.ignore_lights=!1;if(!this._mesh)return null;a=this._render_instance;a.fromNode(this._root);this.in_world_coordinates&&this._root.transform?a.matrix.set(this._root.transform._global_matrix):mat4.copy(a.matrix,
fa._identity);c=this._root.material&&this.use_node_material?this._root.getMaterial():this._material;mat4.multiplyVec3(a.center,a.matrix,vec3.create());a.uniforms.u_point_size=this.size;this.use_perspective?(a.addShaderBlock(d.Shaders.extra2_block),a.addShaderBlock(Ib)):(a.removeShaderBlock(d.Shaders.extra2_block),a.removeShaderBlock(Ib));a.setMaterial(c);a.setMesh(this._mesh,gl.POINTS);c=this._points.length;c>this._vertices.length/3&&(c=this._vertices.length/3);BBox.setMinMax(this._render_instance.oobb,
this._min,this._max);a.setRange(0,c);b.push(a)}};fa.prototype.serialize=function(){var a=d.cloneObject(this);a.object_class="PointCloud";this.uid&&(a.uid=this.uid);if(this.serialize_points){for(var b=Array(this._points.length),c=0;c<this._points.length;c++)b[c]=typedArrayToArray(this._points[c]);a.points=b}return a};fa.prototype.configure=function(a){if(a){a.uid&&(this.uid=a.uid);if(a.points&&a.serialize_points){this._points=Array(a.points.length);for(var b=0;b<a.points.length;b++)this._points[b]=
new Float32Array(a.points[b]);a.points=null}d.cloneObject(a,this)}};d.registerComponent(fa);Ha.icon="mini-icon-lines.png";Ha["@color"]={widget:"color"};Ha["@lines"]={widget:"null"};Object.defineProperty(Ha.prototype,"lines",{set:function(a){this._lines=a},get:function(){return this._lines},enumerable:!0});Object.defineProperty(Ha.prototype,"num_lines",{set:function(a){},get:function(){return this._lines.length},enumerable:!0});Ha.prototype.clear=function(){this._lines.length=0};Ha.prototype.reset=
Ha.prototype.clear;Ha.prototype.addPoint=function(a,b){var c=null,e=null;this._lines.length?(e=this._lines[this._lines.length-1],c=new Float32Array(e.subarray(3,6)),e=new Float32Array(e.subarray(10,14))):(c=a,e=b);this.addLine(c,a,e,b)};Ha.prototype.addLine=function(a,b,c,e){var d=new Float32Array(14);d.set(a,0);d.set(b,3);c?d.set(c,6):d.set([1,1,1,1],6);e?d.set(e,10):c?d.set(c,10):d.set([1,1,1,1],10);this._lines.push(d);this._must_update=!0;return this._lines.length-1};Ha.prototype.setLine=function(a,
b,c,e,d){a=this._lines[a];b&&a.set(b,0);c&&a.set(c,3);e&&a.set(e,6);d&&a.set(d,10);this._must_update=!0};Ha.prototype.removeLine=function(a){this._lines.splice(a,1);this._must_update=!0};Ha.prototype.onAddedToScene=function(a){LEvent.bind(a,"afterRenderScene",this.onAfterRender,this)};Ha.prototype.onRemovedFromScene=function(a){LEvent.unbind(a,"afterRenderScene",this.onAfterRender,this)};Ha.prototype.createMesh=function(){this._mesh_max_lines!=this.max_lines&&(this._vertices=new Float32Array(6*this.max_lines),
this._colors=new Float32Array(8*this.max_lines),this._mesh=new GL.Mesh,this._mesh.addBuffers({vertices:this._vertices,colors:this._colors},null,gl.STREAM_DRAW),this._mesh_max_lines=this.max_lines)};Ha.prototype.updateMesh=function(){this._mesh_max_lines!=this.max_lines&&this.createMesh();for(var a=0,b=this._vertices,c=this._colors,e=this._lines,d=this._lines.length,f=b.length,a=0;a<d&&!(6*a>=f);++a){var h=e[a];b.set(h.subarray(0,6),6*a);c.set(h.subarray(6,14),8*a)}this._mesh.vertexBuffers.vertices.data=
b;this._mesh.vertexBuffers.vertices.upload();this._mesh.vertexBuffers.colors.data=c;this._mesh.vertexBuffers.colors.upload()};Ha.prototype.onAfterRender=function(a){this._root&&0!=this._lines.length&&this.enabled&&(this._must_update&&this.updateMesh(),d.Draw.renderMesh(this._mesh,GL.LINES,null,null,0,2*this._lines.length))};d.registerComponent(Ha);O.LOOP=1;O.PINGPONG=2;O.ONCE=3;O.PAUSED=4;O.MODES={loop:O.LOOP,pingpong:O.PINGPONG,once:O.ONCE,paused:O.PAUSED};O.properties_order=["animation","take"];
O["@animation"]={widget:"animation"};O["@root_node"]={type:"node_id"};O["@mode"]={type:"enum",values:O.MODES};O["@current_time"]={type:d.TYPES.NUMBER,min:0,units:"s"};O["@blend_time"]={type:d.TYPES.NUMBER,min:0,units:"s"};O["@take"]={type:"enum",values:function(){var a=this.instance.getAnimation();if(!a)return["default"];var a=a.takes,b=[],c;for(c in a)b.push(c);return b}};Object.defineProperty(O.prototype,"animation",{set:function(a){a!=this._animation&&(this._blend_animation=this._animation,this._animation=
a,this.blend_time&&this._root&&this._root.scene&&(this._use_blend_animation=!0,this._root.scene.frame!=this._blend_updated_frame&&(this._blend_current_time=this.current_time,this._blend_remaining_time=this.blend_time,this._blend_updated_frame=this._root.scene.frame)))},get:function(){return this._animation},enumerable:!0});Object.defineProperty(O.prototype,"take",{set:function(a){a!=this._take&&(this._blend_take=this._take,this._take=a,this.blend_time&&this._root&&this._root.scene&&(this._use_blend_animation=
!0,this._root.scene.frame!=this._blend_updated_frame&&(this._blend_current_time=this.current_time,this._blend_remaining_time=this.blend_time,this._blend_updated_frame=this._root.scene.frame)))},get:function(){return this._take},enumerable:!0});O.prototype.configure=function(a){a.play&&delete a.play;void 0!==a.enabled&&(this.enabled=!!a.enabled);a.range&&(this.range=a.range.concat());void 0!==a.mode&&(this.mode=a.mode);a.animation&&(this._animation=a.animation);a.take&&(this._take=a.take);null!=a.playback_speed&&
(this.playback_speed=parseFloat(a.playback_speed));void 0!==a.root_node&&(this.root_node=a.root_node);void 0!==a.playing&&(this.playing=a.playing);void 0!==a.blend_time&&(this.blend_time=a.blend_time)};O.icon="mini-icon-clock.png";O.prototype.onAddedToScene=function(a){LEvent.bind(a,"update",this.onUpdate,this)};O.prototype.onRemovedFromScene=function(a){LEvent.unbind(a,"update",this.onUpdate,this)};O.prototype.onUpdate=function(a,b){if(this.enabled&&this.playing&&(this.mode!=O.PAUSED&&(this.current_time+=
b*this.playback_speed),this.onUpdateAnimation(b),this._use_blend_animation))this.onUpdateBlendAnimation(b)};O.prototype.onUpdateAnimation=function(a){if(a=this.getAnimation())if(a=a.takes[this.take]){var b=this.current_time,c=0,e=a.duration,d=e;this.range&&(c=this.range[0],d=this.range[1],e=d-c);if(b>d)switch(this.mode){case O.ONCE:b=d;LEvent.trigger(this,"end_animation");this.playing=!1;break;case O.PINGPONG:b=0==(b/e|0)%2?this.current_time%e:e-this.current_time%e;break;case O.PINGPONG:b=d;break;
default:b=(this.current_time-c)%e+c,LEvent.trigger(this,"animation_loop")}else b<c&&(b=c);this.applyAnimation(a,b,this._last_time);LEvent.trigger(this._root,"after_animation");if(this.onAfterAnimation)this.onAfterAnimation(a,b);this._last_time=b;(a=this._root.scene)&&a.requestFrame()}};O.prototype.onUpdateBlendAnimation=function(a){var b=this.getAnimation(this._blend_animation||this._animation||"");if(b&&(b=b.takes[this._blend_take||this._take||"default"])){this._blend_current_time+=a;this._blend_remaining_time-=
a;0>=this._blend_remaining_time&&(this._use_blend_animation=!1);a=this._blend_current_time*this.playback_speed;var c=0,e=b.duration,d=e;this.range&&(c=this.range[0],d=this.range[1],e=d-c);if(a>d)switch(this.mode){case O.ONCE:a=d;this._use_blend_animation=!1;break;case O.PINGPONG:a=0==(a/e|0)%2?this._blend_current_time%e:e-this._blend_current_time%e;break;case O.PINGPONG:a=d;break;default:a=(this._blend_current_time-c)%e+c}else a<c&&(a=c);this.applyAnimation(b,a,null,this._blend_remaining_time/this.blend_time);
(b=this._root.scene)&&b.requestFrame()}};O.prototype.getAnimation=function(a,b){a=void 0===a?this.animation:a;var c=this._root&&this._root.scene?this._root.scene:d.GlobalScene;if(!a||"@"==a[0])return c.animation;c=d.ResourcesManager.getResource(a);!c&&b&&d.ResourcesManager.load(a);return c&&c.constructor===d.Animation?c:null};O.prototype.getTake=function(a){var b=this.getAnimation();if(!b)return null;a=a||this.take;return(a=b.takes[a])?a:null};O.prototype.getDuration=function(){var a=this.getTake();
return a?a.duration:-1};O.prototype.play=function(){this._root&&this._root.scene||console.error("cannot play an animation if the component doesnt belong to a node in a scene");this.playing=!0;this.getAnimation(null,this.autoload);this.current_time=0;this.range&&(this.current_time=this.range[0]);this._last_time=this.current_time;LEvent.trigger(this,"start_animation")};O.prototype.pause=function(){this.playing=!1};O.prototype.stop=function(){this.playing=!1;this.current_time=0;this.range&&(this.current_time=
this.range[0]);this._last_time=this.current_time};O.prototype.playRange=function(a,b){this.playing=!0;this._last_time=this.current_time=a;this.range=[a,b]};O.prototype.applyAnimation=function(a,b,c,e){void 0===c&&(c=b);if(this._root){var d=null;this.root_node&&this._root.scene&&(d="@"==this.root_node?this._root:this._root.scene.getNode(this.root_node));a.applyTracks(b,c,void 0,d,this._root.scene,e,this.onPreApply,this.onApplySample)}};O.prototype._processSample=function(a,b,c,e){if(e=this._root.scene)if(a=
e.getNode(a)){e=a.transform;switch(b){case "translate.X":e&&(e.position[0]=c);break;case "translate.Y":e&&(e.position[1]=c);break;case "translate.Z":e&&(e.position[2]=c);break;case "matrix":e&&e.fromMatrix(c)}a.transform&&a.transform.updateMatrix()}};O.prototype.getResources=function(a){this.animation&&(a[this.animation]=d.Animation)};O.prototype.onResourceRenamed=function(a,b,c){this.animation==a&&(this.animation=b)};O.prototype.getEvents=function(){return{start_animation:"event",end_animation:"event"}};
O.prototype.getActions=function(a){a=a||{};a.play="function";a.pause="function";a.stop="function";return a};d.registerComponent(O);U.LOOP=1;U.PINGPONG=2;U.ONCE=3;U.PAUSED=4;U.MODES={loop:U.LOOP,pingpong:U.PINGPONG,once:U.ONCE,paused:U.PAUSED};U["@animation"]={widget:"resource",resource_classname:"SkeletalAnimation"};U["@mode"]={type:"enum",values:U.MODES};U["@current_time"]={type:d.TYPES.NUMBER,min:0,units:"s"};U.prototype.configure=function(a){void 0!==a.enabled&&(this.enabled=!!a.enabled);a.range&&
(this.range=a.range.concat());void 0!==a.mode&&(this.mode=a.mode);a.animation&&(this.animation=a.animation);null!=a.playback_speed&&(this.playback_speed=parseFloat(a.playback_speed));null!=a.current_time&&(this.current_time=parseFloat(a.current_time));void 0!==a.playing&&(this.playing=a.playing)};U.icon="mini-icon-clock.png";U.prototype.onAddedToScene=function(a){LEvent.bind(a,"update",this.onUpdate,this)};U.prototype.onRemovedFromScene=function(a){LEvent.unbind(a,"update",this.onUpdate,this)};U.prototype.onUpdate=
function(a,b){this.enabled&&this.playing&&(this.mode!=U.PAUSED&&(this.current_time+=b*this.playback_speed),this.onUpdateAnimation(b))};U.prototype.onUpdateAnimation=function(a){var b=this.getAnimation();if(b&&b.constructor==d.SkeletalAnimation){a=this.current_time;var c=0,e=b=b.duration;this.range&&(c=this.range[0],e=this.range[1],b=e-c);if(a>e)switch(this.mode){case U.ONCE:a=e;LEvent.trigger(this,"end_animation");this.playing=!1;break;case U.PINGPONG:a=0==(a/b|0)%2?this.current_time%b:b-this.current_time%
b;break;case U.PINGPONG:a=e;break;default:a=(this.current_time-c)%b+c,LEvent.trigger(this,"animation_loop")}else a<c&&(a=c);this.applyAnimation(a);(a=this._root.scene)&&a.requestFrame()}};U.prototype.getAnimation=function(a){a=void 0===a?this.animation:a;return(a=d.ResourcesManager.getResource(a))&&a.constructor===d.SkeletalAnimation?a:null};U.prototype.getDuration=function(){var a=this.getAnimation();return a?a.duration:-1};U.prototype.play=function(){this._root&&this._root.scene||console.error("cannot play an animation if the component doesnt belong to a node in a scene");
this.playing=!0;this.current_time=0;this.range&&(this.current_time=this.range[0]);LEvent.trigger(this,"start_animation")};U.prototype.pause=function(){this.playing=!1};U.prototype.stop=function(){this.playing=!1;this.current_time=0;this.range&&(this.current_time=this.range[0])};U.prototype.playRange=function(a,b){this.playing=!0;this.current_time=a;this.range=[a,b]};U.prototype.applyAnimation=function(a){if(this._root){var b=this.getAnimation();b&&(b.assignTime(a,!0,this.interpolate),this._skeleton.copyFrom(b.skeleton),
a=this._root.getComponent(d.Components.SkinDeformer))&&(a._skeleton=this._skeleton)}};U.prototype.getResources=function(a){this.animation&&(a[this.animation]=d.SkeletalAnimation)};U.prototype.onResourceRenamed=function(a,b,c){this.animation==a&&(this.animation=b)};U.prototype.getEvents=function(){return{start_animation:"event",end_animation:"event"}};U.prototype.getActions=function(a){a=a||{};a.play="function";a.pause="function";a.stop="function";return a};U.prototype.getPropertiesInfo=function(){return{enabled:"boolean",
current_time:"number",mode:"number",playing:"boolean",playback_speed:"number",skeleton:"skeleton"}};d.registerComponent(U);mb.icon="mini-icon-reflector.png";mb["@texture_size"]={type:"enum",values:["viewport",64,128,256,512,1024,2048]};mb["@layers"]={type:"layers"};mb.prototype.onAddedToScene=function(a){LEvent.bind(a,d.EVENT.RENDER_REFLECTIONS,this.onRenderReflection,this);LEvent.bind(a,d.EVENT.AFTER_CAMERA_ENABLED,this.onCameraEnabled,this)};mb.prototype.onRemovedFromScene=function(a){LEvent.unbindAll(a,
this);for(var b in this._textures)d.ResourcesManager.unregisterResource(":reflection_"+b);this._textures={}};mb.prototype.onRenderReflection=function(a,b){if(this.enabled&&this._root&&this._root.visible){var c=this._root.scene;if(c&&(this.refresh_rate<<=0,0!=c._frame&&0==c._frame%this.refresh_rate||!this._rt)){var e=c=parseInt(this.texture_size),g=c,f=this._root.flags.visible;this._root.visible=!this.ignore_this_mesh;var h=b.layers;b.layers=this.layers;var k=d.Renderer._visible_cameras;d.Renderer.clearSamplers();
for(var l=0;l<k.length;l++){var m=k[l];if(this.skip_if_node_not_visible){if(!this._root._instances.length)continue;for(var p=!1,n=0;n<this._root._instances.length;++n)if(geo.frustumTestBox(m._frustum_planes,this._root._instances[l].aabb)!=CLIP_OUTSIDE){p=!0;break}if(!p)continue}isNaN(c)&&"viewport"==this.texture_size&&(g=m.getLocalViewport(null,m._viewport_in_pixels),e=g[2],g=g[3]);var n=gl.TEXTURE_2D,r=this.high_precision?gl.HIGH_PRECISION_FORMAT:gl.UNSIGNED_BYTE,p=this._textures[m.uid];p&&p.width==
e&&p.height==g&&p.type==r&&p.texture_type==n&&p.minFilter==(this.generate_mipmaps?gl.LINEAR_MIPMAP_LINEAR:gl.LINEAR)||(p=new GL.Texture(e,g,{type:r,texture_type:n,minFilter:this.generate_mipmaps?gl.LINEAR_MIPMAP_LINEAR:gl.LINEAR}),p.has_mipmaps=this.generate_mipmaps,this._textures[m.uid]=p);p._locked=!0;var n=this._root.transform.getGlobalPosition(),r=this._root.transform.getTop(),t=m.getEye(),x=m.getCenter(),u=m.getUp();if(this.use_mesh_info){var q=this._root.getMesh();q&&(n=this._root.transform.globalToLocal(BBox.getCenter(q.bounding)),
r=this._root.transform.globalVectorToLocal(d.TOP))}vec3.add(n,n,this.offset);this._reflected_camera=q=this._reflected_camera||new d.Camera;q.configure(m.serialize());q.fov=m.fov;q.aspect=m.aspect;t=geo.reflectPointInPlane(t,n,r);x=geo.reflectPointInPlane(x,n,r);u=geo.reflectPointInPlane(u,[0,0,0],r);q.lookAt(t,x,u);vec3.add(n,n,vec3.scale(vec3.create(),r,-this.clip_offset));this._clipping_plane.set(r);this._clipping_plane[3]=vec3.dot(n,r);d.Renderer._uniforms.u_clipping_plane.set(this._clipping_plane);
d.Renderer.renderInstancesToRT(q,p,b);d.Renderer._uniforms.u_clipping_plane.set([0,0,0,0]);this.blur&&((n=this._textures["blur_"+m.uid])&&(Texture.compareFormats(p,n)||n.minFilter!=p.minFilter)&&(n=null),p.applyBlur(this.blur,this.blur,1,null,n));this.generate_mipmaps&&isPowerOfTwo(e)&&isPowerOfTwo(g)&&(p.setParameter(gl.TEXTURE_MIN_FILTER,gl.LINEAR_MIPMAP_LINEAR),gl.generateMipmap(p.texture_type),p.unbind());p._locked=!1;p._is_planar=!0;this.texture_name&&d.ResourcesManager.registerResource(this.texture_name,
p);d.ResourcesManager.registerResource(":reflection_"+m.uid,p);if(!this.all_cameras)break}b.layers=h;delete b.brightness_factor;delete b.colorclip_factor;this._root.flags.visible=f}}};mb.prototype.onCameraEnabled=function(a,b){if(this.enabled&&this._root&&this._root.material&&this._textures[b.uid]){var c=this._root.getMaterial();c&&(c.setTexture(B.ENVIRONMENT_TEXTURE,":reflection_"+b.uid).uvs=B.COORDS_FLIPPED_SCREEN)}};d.registerComponent(mb);aa.last_id=0;aa.icon="mini-icon-reflector.png";aa["@texture_size"]=
{type:"enum",values:["viewport",64,128,256,512,1024,2048]};aa["@layers"]={type:"layers"};aa["@background_color"]={type:"color"};Object.defineProperty(aa.prototype,"texture",{get:function(){return this._texture},set:function(){throw"probe cubemap cannot be set";},enumerable:!1});Object.defineProperty(aa.prototype,"enabled",{set:function(a){a!=this._enabled&&(this._enabled=a,a=this._root?this._root.scene:null,this._enabled?(this._registered||this.register(a),this.onRenderReflection(),d.GlobalScene.requestFrame()):
this._registered&&this.unregister(a))},get:function(){return this._enabled},enumerable:!0});aa.prototype.onAddedToScene=function(a){LEvent.bind(a,"start",this.onRenderReflection,this);LEvent.bind(a,"renderReflections",this.onRenderReflection,this);this.register(a)};aa.prototype.getExtraProperties=function(a){a.push(["texture","texture"])};aa.prototype.onRemovedFromScene=function(a){LEvent.unbindAll(a,this);this._texture&&d.ResourcesManager.unregisterResource(this._tex_id);this._texture=null;this.unregister(a)};
aa.prototype.onSerialize=function(a){a.irradiance_shs=typedArrayToArray(this._irradiance_shs)};aa.prototype.onConfigure=function(a){a.irradiance_shs&&this._irradiance_shs.set(a.irradiance_shs)};aa.prototype.onRenderReflection=function(a){if(this._enabled&&this._root&&this._root.scene){if(!this._must_update){if(d.ResourcesManager.isLoading())return;this.refresh_rate|=0;if(1>this.refresh_rate&&this._texture||this._texture&&0!=this._root.scene._frame%this.refresh_rate)return}this._must_update=!1;this.recompute()}};
aa.prototype.recompute=function(a,b){if(this._root&&this._root.scene&&(this._root.transform.getGlobalPosition(this._current),this.updateCubemap(this._current,a,!0),b)){var c=aa._temp_cubemap,e=E.capture_cubemap_size,d={type:gl.FLOAT,texture_type:gl.TEXTURE_CUBE_MAP,format:gl.RGB};c&&c.width==e&&c.height==e||(aa._temp_cubemap=c=new GL.Texture(e,e,d));this._texture.copyTo(c);this._irradiance_shs=E.computeSH(c)}};aa.use_float_for_high_precision=!1;aa.prototype.updateCubemap=function(a,b){b=b||d.Renderer.default_render_settings;
var c=this._root.scene;if(c){var e=parseInt(this.texture_size),g=b.layers;b.layers=this.layers;d.Renderer.clearSamplers();var f=gl.TEXTURE_CUBE_MAP,h=this.high_precision?aa.use_float_for_high_precision?gl.FLOAT:gl.HIGH_PRECISION_FORMAT:gl.UNSIGNED_BYTE,k=this._texture;k&&k.width==e&&k.height==e&&k.type==h&&k.texture_type==f&&k.minFilter==(this.generate_mipmaps?gl.LINEAR_MIPMAP_LINEAR:gl.LINEAR)||(k=new GL.Texture(e,e,{type:h,format:gl.RGB,texture_type:f,minFilter:this.generate_mipmaps?gl.LINEAR_MIPMAP_LINEAR:
gl.LINEAR}),k.has_mipmaps=this.generate_mipmaps,this._texture=k);a?this._position.set(a):a=this._root.transform.getGlobalPosition(this._position);k._in_current_fbo=!0;d.Renderer._visible_instances||(d.Renderer.processVisibleData(c,b),d.Renderer.regenerateShadowmaps(c,b));for(c=0;c<d.Renderer._visible_instances.length;++c)d.Renderer._visible_instances[c]._nearest_reflection_probe==this&&(d.Renderer._visible_instances[c]._nearest_reflection_probe=null);d.Renderer.renderToCubemap(a,0,k,b,this.near,this.far,
this.background_color);k._in_current_fbo=!1;this.generate_mipmaps&&isPowerOfTwo(e)&&(k.setParameter(gl.TEXTURE_MIN_FILTER,gl.LINEAR_MIPMAP_LINEAR),gl.generateMipmap(k.texture_type),k.unbind());for(c=0;c<d.Renderer._visible_instances.length;++c)null==d.Renderer._visible_instances[c]._nearest_reflection_probe&&(d.Renderer._visible_instances[c]._nearest_reflection_probe=this);this.texture_name&&d.ResourcesManager.registerResource(this.texture_name,k);d.ResourcesManager.registerResource(this._tex_id,
k);b.layers=g}};aa.prototype.assignCubemaps=function(a){this._texture&&d.ResourcesManager.registerResource(this._tex_id,this._texture)};aa.prototype.register=function(a){-1!=a._reflection_probes.indexOf(this)?console.warn("this reflection probe is already registered"):(a._reflection_probes.push(this),this._registered=!0)};aa.prototype.unregister=function(a){var b=a._reflection_probes.indexOf(this);-1==b?console.warn("this reflection probe is not registered"):(a._reflection_probes.splice(b,1),this._registered=
!1)};aa.prototype.renderProbe=function(a,b){if(this._texture&&this._enabled){d.Draw.push();d.Draw.translate(this._position);d.Draw.scale(aa.helper_size);if(b)d.Draw.setColor(b),d.Draw.renderMesh(d.Renderer._sphere_mesh,GL.TRIANGLES);else{var c=GL.Shader.getCubemapShowShader();a?this._irradiance_texture?this._irradiance_texture.bind(0):this._irradiance_shs&&(c=d.Components.ReflectionProbe.sh_shader,c||(c=d.Components.ReflectionProbe.sh_shader=new GL.Shader(GL.Shader.DEFAULT_VERTEX_SHADER,d.Components.IrradianceCache.fs_shader_code)),
c.uniforms({u_sh_coeffs:this._irradiance_shs})):this._texture.bind(0);d.Draw.renderMesh(d.Renderer._sphere_mesh,GL.TRIANGLES,c);d.Draw.setColor(d.WHITE);d.Draw.scale(1.1);gl.enable(gl.CULL_FACE);gl.frontFace(gl.CW);d.Draw.renderMesh(d.Renderer._sphere_mesh,GL.TRIANGLES);gl.frontFace(gl.CCW)}d.Draw.pop()}};aa.updateAll=function(a,b){a=a||d.GlobalScene;for(var c=0;c<a._reflection_probes.length;++c)a._reflection_probes[c].recompute(b,!0)};aa.visualize_helpers=!0;aa.visualize_irradiance=!1;aa.helper_size=
1;d.registerComponent(aa);E.show_probes=!1;E.show_cubemaps=!1;E.probes_size=1;E.capture_cubemap_size=64;E.final_cubemap_size=16;E.OBJECT_MODE=1;E.VERTEX_MODE=2;E.PIXEL_MODE=3;E["@mode"]={type:"enum",values:{object:E.OBJECT_MODE,vertex:E.VERTEX_MODE,pixel:E.PIXEL_MODE}};E["@size"]={type:"vec3",min:0.1,step:0.1,precision:3};E["@subdivisions"]={type:"vec3",min:1,max:256,step:1,precision:0};E["@layers"]={widget:"layers"};E["@background_color"]={type:"color"};E["@intensity_color"]={type:"color"};E.default_coeffs=
new Float32Array([0,0,0,0.5,0.75,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]);E.use_sh_low=!1;E.getExtraProperties=function(a){a.push(["recompute",LiteGraph.ACTION])};E.prototype.onAddedToScene=function(a){LEvent.bind(a,"fillSceneUniforms",this.fillSceneUniforms,this)};E.prototype.onRemovedFromScene=function(a){LEvent.unbind(a,"fillSceneUniforms",this.fillSceneUniforms,this)};E.prototype.onConfigure=function(a){if(this.cache_filename){var b=this;d.ResourcesManager.load(this.cache_filename,function(a){a&&
(b._cache_resource=a,!b._sh_texture&&a._sh_texture&&(b._sh_texture=a._sh_texture),b.fromData(a.data),b.encodeCacheInTexture(),a._sh_texture=b._sh_texture,d.GlobalScene.requestFrame())})}};E.prototype.getResources=function(a){this.cache_filename&&this._cache_resource&&(a[this.cache_filename]=d.Resource)};E.prototype.onResourceRenamed=function(a,b){a==this.cache_filename&&(this.cache_filename=b)};E.prototype.fillSceneUniforms=function(){this.enabled&&this._sh_texture&&(this._samplers[d.Renderer.IRRADIANCE_TEXTURE_SLOT]=
this._sh_texture,this._uniforms.u_irradiance_distance=this.sampling_distance,d.Renderer.enableFrameShaderBlock("applyIrradiance",this._uniforms,this._samplers))};E.prototype.recompute=function(a){var b=this.subdivisions,c=this.size;1>b[0]&&(b[0]=1);1>b[1]&&(b[1]=1);1>b[2]&&(b[2]=1);var e=getTime();console.log("Capturing irradiance...");var g=vec3.fromValues(c[0]/b[0],c[1]/b[1],c[2]/b[2]),f=gl.FLOAT,h=d.Renderer.default_render_settings,k=h.layers;h.layers=this.layers;d.GlobalScene.info.textures.irradiance=
null;var l=E.final_cubemap_size,m=E.capture_cubemap_size,f={type:f,texture_type:gl.TEXTURE_CUBE_MAP,format:gl.RGB},p=E._temp_cubemap;p&&p.width==m&&p.height==m&&p.type==f.type||(E._temp_cubemap=new GL.Texture(m,m,f));if(this.onRecomputingIrradiance)this.onRecomputingIrradiance(c);if(!d.Renderer._visible_instances){c=this._root.scene;if(!c)throw"cannot compute irradiance without scene";d.Renderer.processVisibleData(c,h);d.Renderer.regenerateShadowmaps(c,h)}c=this.subdivisions[0]*this.subdivisions[1]*
this.subdivisions[2];this._irradiance_cubemaps.length=c;this._irradiance_shs.length=c;this._irradiance_subdivisions.set(this.subdivisions);c=vec3.create();m=this._irradiance_matrix;mat4.identity(m);this._root.transform&&this._root.transform.getGlobalMatrix(m);mat4.scale(m,m,g);for(var n=g=p=0;n<b[1];++n)for(var r=0;r<b[2];++r)for(var t=0;t<b[0];++t)if(c[0]=t+0.5,c[1]=n+0.5,c[2]=r+0.5,m&&mat4.multiplyVec3(c,m,c),a&&!a.testSphereInsideFrustum(c))p+=1;else{var x=this._irradiance_cubemaps[p];x&&x.type==
f.type&&x.width==l||(this._irradiance_cubemaps[p]=x=new GL.Texture(l,l,f));E.captureIrradiance(c,x,h,this.near,this.far,this.background_color,!0,E._temp_cubemap);this._irradiance_shs[p]=this.computeCubemapSH(x,c,p);p+=1;g+=1}a=getTime();console.log("Capturing light time: "+(a-e).toFixed(1)+"ms. Num. probes updated: "+g);this.encodeCacheInTexture();b=getTime();console.log("Packing in texture time: "+(b-a).toFixed(1)+"ms");console.log("Irradiance Total: "+(getTime()-e).toFixed(1)+"ms");if(this.onRecomputingFinished)this.onRecomputingFinished();
this.cache_filename||(this.cache_filename="IR_cache_"+this.uid.substr(1)+".bin");var u=this._cache_resource=d.ResourcesManager.getResource(u);u||(this._cache_resource=u=new d.Resource,d.ResourcesManager.registerResource(this.cache_filename,u));u.data=this.toData();d.RM.resourceModified(u);h.layers=k};E.captureIrradiance=function(a,b,c,e,g,f,h,k){d.Renderer.clearSamplers();d.Renderer.disableFrameShaderBlock("applyIrradiance");h&&(c.force_two_sided=!0);d.Renderer.renderToCubemap(a,0,k,c,e,g,f);h&&(c.force_two_sided=
!1);k.copyTo(b)};E.prototype.computeCubemapSH=function(a,b,c){for(var e=[],d=0;6>d;++d)e.push(a.getPixels(d));if(this.onPreprocessCubemap)this.onPreprocessCubemap(e,b,a,c);a=xc(e,a.width,4);if(this.onComputedSphericalHarmonics)this.onComputedSphericalHarmonics(a,b);return a};E.computeSH=function(a){for(var b=[],c=0;6>c;++c)b.push(a.getPixels(c));return xc(b,a.width,4)};E.prototype.encodeCacheInTexture=function(){if(this._irradiance_shs.length){var a=gl.FLOAT,b=gl.HIGH_PRECISION_FORMAT;GL.FBO.testSupport(b,
gl.RGB)||(b=gl.FLOAT);this._sh_texture&&this._sh_texture.height==this._irradiance_shs.length&&this._sh_texture.type==b||(this._sh_texture=new GL.Texture(9,this._irradiance_shs.length,{format:gl.RGB,type:b,magFilter:gl.NEAREST,minFilter:gl.NEAREST,wrap:gl.CLAMP_TO_EDGE}),d.ResourcesManager.registerResource(":IR_SHs",this._sh_texture));for(var c=new Float32Array(27*this._irradiance_shs.length),e=0;e<this._irradiance_shs.length;++e){var g=this._irradiance_shs[e];g&&c.set(g,27*e)}b==a?this._sh_texture.uploadData(c,
{no_flip:!0},!0):(this._sh_temp_texture&&this._sh_temp_texture.height==this._sh_temp_texture.length&&this._sh_temp_texture.type==a||(this._sh_temp_texture=new GL.Texture(9,this._irradiance_shs.length,{format:gl.RGB,type:a,magFilter:gl.NEAREST,minFilter:gl.NEAREST,wrap:gl.CLAMP_TO_EDGE})),this._sh_temp_texture.uploadData(c,{no_flip:!0},!0),this._sh_temp_texture.copyTo(this._sh_texture));a=this._uniforms.u_irradiance_imatrix;a.set(this._irradiance_matrix);mat4.invert(a,a)}};E.prototype.getSizeInBytes=
function(){return 108*this._irradiance_shs.length};E.prototype.showStats=function(){new Float32Array(9);new Float32Array(9);new Float32Array(9);for(var a=0;a<this._irradiance_shs.length;++a);};E.prototype.fromData=function(a){if(a){var b=new Uint8Array(a);if("IR_C"!=d.typedArrayToString(b.subarray(0,4)))return console.error("Irradiance data do not match"),!1;var b=new DataView(a),c=this._irradiance_subdivisions;c[0]=b.getUint8(4);c[1]=b.getUint8(5);c[2]=b.getUint8(6);b=c[0]*c[1]*c[2];a=new Float32Array(a,
16);this._irradiance_matrix.set(a.subarray(0,16));c=this._irradiance_shs;c.length=b;for(b=0;b<c.length;++b)c[b]=a.subarray(16+27*b,16+27*(b+1));return!0}};E.prototype.toData=function(){var a=this._irradiance_subdivisions,b=new ArrayBuffer(80+a[0]*a[1]*a[2]*108);(new Uint8Array(b)).set(d.stringToTypedArray("IR_C"),0);var c=new DataView(b);c.setUint8(4,a[0]);c.setUint8(5,a[1]);c.setUint8(6,a[2]);a=new Float32Array(b,16);a.set(this._irradiance_matrix);for(var c=this._irradiance_shs,e=0;e<c.length;++e){var g=
c[e];g&&a.set(g,16+27*e)}return b};E.prototype.renderEditor=function(a){if(this.enabled&&E.show_probes){a=GL.Shader.getCubemapShowShader();var b=E.sh_shader;b||(E.sh_shader=b=new GL.Shader(d.Draw.vertex_shader_code,E.fs_shader_code));var c=d.Renderer._sphere_mesh,e=this.subdivisions,c=this.size,g=vec3.fromValues(c[0]/e[0],c[1]/e[1],c[2]/e[2]),c=d.Renderer._sphere_mesh,f=E.default_cubemap;f||(f=E.default_cubemap=new GL.Texture(1,1,{texture_type:GL.TEXTURE_CUBE_MAP,format:GL.RGB,pixel_data:[255,255,
255]}));var h=vec3.create(),k=this._irradiance_matrix;mat4.identity(k);this._root.transform&&this._root.transform.getGlobalMatrix(k);mat4.scale(k,k,g);mat4.multiplyVec3(vec3.create(),k,[0,0,0]);mat4.multiplyVec3(vec3.create(),k,e);for(var g=d.Renderer._current_camera,l=0,m=0;m<e[1];++m)for(var p=0;p<e[2];++p)for(var n=0;n<e[0];++n)h[0]=n+0.5,h[1]=m+0.5,h[2]=p+0.5,mat4.multiplyVec3(h,k,h),g&&!g.testSphereInsideFrustum(h,E.probes_size)?l+=1:(d.Draw.push(),d.Draw.translate(h),d.Draw.scale(E.probes_size),
E.show_cubemaps?((this._irradiance_cubemaps[l]||f).bind(0),d.Draw.renderMesh(c,GL.TRIANGLES,a)):(b.uniforms({u_sh_coeffs:this._irradiance_shs[l]||E.default_coeffs}),d.Draw.renderMesh(c,GL.TRIANGLES,b)),d.Draw.pop(),l++)}};d.registerComponent(E);E.include_code="\nconst float Pi = 3.141592654;\nconst float CosineA0 = Pi;\nconst float CosineA1 = (2.0 * Pi) / 3.0;\nconst float CosineA2 = Pi * 0.25;\n\nstruct SH9\n{\n    float c[9];\n};\n\nstruct SH9Color\n{\n    vec3 c[9];\n};\n\nvoid SHCosineLobe(in vec3 dir, out SH9 sh)\n{\n\t\n    // Band 0\n    sh.c[0] = 0.282095 * CosineA0;\n\t\n    // Band 1\n    sh.c[1] = 0.488603 * dir.y * CosineA1;\n    sh.c[2] = 0.488603 * dir.z * CosineA1;\n    sh.c[3] = 0.488603 * dir.x * CosineA1;\n\t\n    // Band 2\n\t#ifndef SH_LOW\n\t\n    sh.c[4] = 1.092548 * dir.x * dir.y * CosineA2;\n    sh.c[5] = 1.092548 * dir.y * dir.z * CosineA2;\n    sh.c[6] = 0.315392 * (3.0 * dir.z * dir.z - 1.0) * CosineA2;\n    sh.c[7] = 1.092548 * dir.x * dir.z * CosineA2;\n    sh.c[8] = 0.546274 * (dir.x * dir.x - dir.y * dir.y) * CosineA2;\n\t#endif\n\t\n}\n\nvec3 ComputeSHIrradiance(in vec3 normal, in SH9Color radiance)\n{\n    // Compute the cosine lobe in SH, oriented about the normal direction\n    SH9 shCosine;\n\tSHCosineLobe(normal, shCosine);\n\t\n    // Compute the SH dot product to get irradiance\n    vec3 irradiance = vec3(0.0);\n\t#ifndef SH_LOW\n\tconst int num = 9;\n\t#else\n\tconst int num = 4;\n\t#endif\n    for(int i = 0; i < num; ++i)\n        irradiance += radiance.c[i] * shCosine.c[i];\n\t\n    return irradiance;\n}\n\nvec3 ComputeSHDiffuse(in vec3 normal, in SH9Color radiance)\n{\n    // Diffuse BRDF is albedo / Pi\n    return ComputeSHIrradiance( normal, radiance ) * (1.0 / Pi);\n}\n";
E.fs_shader_code="\nprecision mediump float;\n"+E.include_code+"\nvarying vec3 v_normal;\nuniform vec3 u_sh_coeffs[9];\nvoid main()\n{\n\tvec3 normal = normalize( v_normal );\n\tSH9Color coeffs;\n\tcoeffs.c[0] = u_sh_coeffs[0];\n\tcoeffs.c[1] = u_sh_coeffs[1];\n\tcoeffs.c[2] = u_sh_coeffs[2];\n\tcoeffs.c[3] = u_sh_coeffs[3];\n\tcoeffs.c[4] = u_sh_coeffs[4];\n\tcoeffs.c[5] = u_sh_coeffs[5];\n\tcoeffs.c[6] = u_sh_coeffs[6];\n\tcoeffs.c[7] = u_sh_coeffs[7];\n\tcoeffs.c[8] = u_sh_coeffs[8];\n\tgl_FragColor = vec4( max( vec3(0.001), ComputeSHDiffuse( normal, coeffs ) ), 1.0 );\n}\n";
var ic=[[[0,0,-1],[0,-1,0],[1,0,0]],[[0,0,1],[0,-1,0],[-1,0,0]],[[1,0,0],[0,0,1],[0,1,0]],[[1,0,0],[0,0,-1],[0,-1,0]],[[1,0,0],[0,-1,0],[0,0,1]],[[-1,0,0],[0,-1,0],[0,0,-1]]],Nc="\n\tuniform sampler2D irradiance_texture;\n\tuniform vec3 u_irradiance_subdivisions;\n\tuniform vec3 u_irradiance_color;\n\tuniform mat4 u_irradiance_imatrix;\n\t//uniform float u_irradiance_debug;\n\tuniform float u_irradiance_distance;\n\t"+(E.use_sh_low?"#define SH_LOW":"")+"\n\t\n\t"+E.include_code+"\n\tvec3 computeSHRadianceAtLocalPos( in vec3 local_pos, in vec3 normal )\n\t{\n\t\tfloat floor_probes = u_irradiance_subdivisions.x * u_irradiance_subdivisions.z;\n\t\tfloat total_probes = floor_probes * u_irradiance_subdivisions.y;\n\t\tfloat i = floor(local_pos.x) + floor(local_pos.z) * u_irradiance_subdivisions.x + floor(local_pos.y) * floor_probes;\n\t\ti = (i+0.5) / (total_probes);\n\t\tSH9Color coeffs;\n\t\tcoeffs.c[0] = texture2D( irradiance_texture, vec2(0.5/9.0, i)).xyz;\n\t\tcoeffs.c[1] = texture2D( irradiance_texture, vec2(1.5/9.0, i)).xyz;\n\t\tcoeffs.c[2] = texture2D( irradiance_texture, vec2(2.5/9.0, i)).xyz;\n\t\tcoeffs.c[3] = texture2D( irradiance_texture, vec2(3.5/9.0, i)).xyz;\n\t\t#ifndef SH_LOW\n\t\tcoeffs.c[4] = texture2D( irradiance_texture, vec2(4.5/9.0, i)).xyz;\n\t\tcoeffs.c[5] = texture2D( irradiance_texture, vec2(5.5/9.0, i)).xyz;\n\t\tcoeffs.c[6] = texture2D( irradiance_texture, vec2(6.5/9.0, i)).xyz;\n\t\tcoeffs.c[7] = texture2D( irradiance_texture, vec2(7.5/9.0, i)).xyz;\n\t\tcoeffs.c[8] = texture2D( irradiance_texture, vec2(8.5/9.0, i)).xyz;\n\t\t#endif\n\t\treturn max( vec3(0.001), ComputeSHDiffuse( normal, coeffs ) );\n\t}\n\tfloat irr_expFunc(float f)\n\t{\n\t\t//f = f*f*f*(f*(f*6.0-15.0)+10.0);\n\t\t//if( f < 0.0 || f > 1.0 ) return 0.0;\n\t\treturn f;\n\t}\n\tvec3 computeSHRadianceAtPositionSmooth( in vec3 pos, in vec3 normal )\n\t{\n\t\tvec3 local_pos = (u_irradiance_imatrix * vec4(pos + u_irradiance_distance * normal, 1.0)).xyz - vec3(0.5);\n\t\tlocal_pos = clamp( local_pos, vec3(0.0), u_irradiance_subdivisions - vec3(1.0));\n\t\tfloat fx = fract(local_pos.x);\n\t\tfloat fy = 1.0 - fract(local_pos.y);\n\t\tfloat fz = 1.0 - fract(local_pos.z);\n\t\tfx = irr_expFunc(fx);\n\t\tfy = irr_expFunc(fy);\n\t\tfz = irr_expFunc(fz);\n\t\tvec3 LTF = computeSHRadianceAtLocalPos( vec3( floor(local_pos.x), ceil(local_pos.y), ceil(local_pos.z)), normal );\n\t\tvec3 LTB = computeSHRadianceAtLocalPos( vec3( floor(local_pos.x), ceil(local_pos.y), floor(local_pos.z)), normal );\n\t\tvec3 RTF = computeSHRadianceAtLocalPos( vec3( ceil(local_pos.x), ceil(local_pos.y), ceil(local_pos.z)), normal );\n\t\tvec3 RTB = computeSHRadianceAtLocalPos( vec3( ceil(local_pos.x), ceil(local_pos.y), floor(local_pos.z)), normal );\n\t\tvec3 LBF = computeSHRadianceAtLocalPos( vec3( floor(local_pos.x), floor(local_pos.y), ceil(local_pos.z)) , normal);\n\t\tvec3 LBB = computeSHRadianceAtLocalPos( vec3( floor(local_pos.x), floor(local_pos.y), floor(local_pos.z)), normal);\n\t\tvec3 RBF = computeSHRadianceAtLocalPos( vec3( ceil(local_pos.x), floor(local_pos.y), ceil(local_pos.z)), normal );\n\t\tvec3 RBB = computeSHRadianceAtLocalPos( vec3( ceil(local_pos.x), floor(local_pos.y), floor(local_pos.z)), normal);\n\t\tvec3 LT = mix(LTF,LTB,fz);\n\t\tvec3 LB = mix(LBF,LBB,fz);\n\t\tvec3 L = mix(LT,LB,fy);\n\t\tvec3 RT = mix(RTF,RTB,fz);\n\t\tvec3 RB = mix(RBF,RBB,fz);\n\t\tvec3 R = mix(RT,RB,fy);\n\t\treturn mix(L,R,fx);\n\t\t\n\t}\n\tvec3 computeSHRadianceAtPosition( in vec3 pos, in vec3 normal )\n\t{\n\t\tvec3 local_pos = (u_irradiance_imatrix * vec4(pos + u_irradiance_distance * normal, 1.0)).xyz - vec3(0.5);\n\t\tlocal_pos = clamp( local_pos + vec3(0.5), vec3(0.0), u_irradiance_subdivisions - vec3(1.0));\n\t\treturn computeSHRadianceAtLocalPos( local_pos, normal );\n\t\t\n\t}\n\t\n\tvoid applyIrradiance( in Input IN, in SurfaceOutput o, inout FinalLight FINALLIGHT )\n\t{\n\t\tFINALLIGHT.Ambient = o.Ambient * u_irradiance_color * computeSHRadianceAtPositionSmooth( IN.worldPos, o.Normal );\n\t}\n",
Rb="\n\tvoid applyIrradiance( in Input IN, in SurfaceOutput o, inout FinalLight FINALLIGHT )\n\t{\n\t}\n",Eb=new d.ShaderBlock("applyIrradiance");M.irradiance_block=Eb;Eb.addCode(GL.FRAGMENT_SHADER,Nc,Rb);Eb.register(!0);var Oc="\n\tuniform vec3 u_sh_coeffs[9];\n\t"+E.include_code+"\n\tvoid applyIrradiance( in Input IN, in SurfaceOutput o, inout FinalLight FINALLIGHT )\n\t{\n\t\tSH9Color coeffs;\n\t\tcoeffs.c[0] = u_sh_coeffs[0];\n\t\tcoeffs.c[1] = u_sh_coeffs[1];\n\t\tcoeffs.c[2] = u_sh_coeffs[2];\n\t\tcoeffs.c[3] = u_sh_coeffs[3];\n\t\tcoeffs.c[4] = u_sh_coeffs[4];\n\t\tcoeffs.c[5] = u_sh_coeffs[5];\n\t\tcoeffs.c[6] = u_sh_coeffs[6];\n\t\tcoeffs.c[7] = u_sh_coeffs[7];\n\t\tcoeffs.c[8] = u_sh_coeffs[8];\n\t\tvec3 irr_color = ComputeSHDiffuse( o.Normal, coeffs );\n\t\tFINALLIGHT.Ambient = o.Ambient * irr_color;\n\t}\n",
uc=new d.ShaderBlock("applyIrradianceSingle");M.irradiance_single_block=uc;uc.addCode(GL.FRAGMENT_SHADER,Oc,Rb);uc.register(!0);s.secure_module=!1;s.block_execution=!1;s.catch_important_exceptions=!0;s.icon="mini-icon-script.png";s.templates={script:"//@unnamed\n//defined: component, node, scene, transform, globals\nthis.onStart = function()\n{\n}\n\nthis.onUpdate = function(dt)\n{\n\t//node.scene.refresh();\n}"};s["@code"]={type:"script"};s.BIND_TO_COMPONENT=1;s.BIND_TO_NODE=2;s.BIND_TO_SCENE=3;
s.BIND_TO_RENDERER=4;s.API_functions={};s.API_events_to_function={};s.defineAPIFunction=function(a,b,c,e){if(!c)throw"Script function requires event";b=b||s.BIND_TO_SCENE;b={name:a,target:b,event:c,info:e};s.API_functions[a]=b;s.API_events_to_function[c]=b};s.defineAPIFunction("onStart",s.BIND_TO_SCENE,d.EVENT.START);s.defineAPIFunction("onAwake",s.BIND_TO_SCENE,d.EVENT.AWAKE);s.defineAPIFunction("onFinish",s.BIND_TO_SCENE,d.EVENT.FINISH);s.defineAPIFunction("onPrefabReady",s.BIND_TO_NODE,"prefabReady");
s.defineAPIFunction("onUpdate",s.BIND_TO_SCENE,d.EVENT.UPDATE);s.defineAPIFunction("onFixedUpdate",s.BIND_TO_SCENE,d.EVENT.FIXED_UPDATE);s.defineAPIFunction("onNodeClicked",s.BIND_TO_NODE,"node_clicked");s.defineAPIFunction("onClicked",s.BIND_TO_NODE,"clicked");s.defineAPIFunction("onSceneRender",s.BIND_TO_SCENE,d.EVENT.BEFORE_RENDER);s.defineAPIFunction("onCollectRenderInstances",s.BIND_TO_NODE,d.EVENT.COLLECT_RENDER_INSTANCES);s.defineAPIFunction("onRender",s.BIND_TO_SCENE,d.EVENT.BEFORE_RENDER_INSTANCES);
s.defineAPIFunction("onAfterRender",s.BIND_TO_SCENE,d.EVENT.AFTER_RENDER_INSTANCES);s.defineAPIFunction("onAfterSceneRender",s.BIND_TO_SCENE,d.EVENT.AFTER_RENDER);s.defineAPIFunction("onRenderHelpers",s.BIND_TO_SCENE,d.EVENT.RENDER_HELPERS);s.defineAPIFunction("onRenderGUI",s.BIND_TO_SCENE,d.EVENT.RENDER_GUI);s.defineAPIFunction("onEnableFrameContext",s.BIND_TO_SCENE,d.EVENT.ENABLE_FRAME_CONTEXT);s.defineAPIFunction("onShowFrameContext",s.BIND_TO_SCENE,d.EVENT.SHOW_FRAME_CONTEXT);s.defineAPIFunction("onMouseDown",
s.BIND_TO_SCENE,"mousedown");s.defineAPIFunction("onMouseMove",s.BIND_TO_SCENE,"mousemove");s.defineAPIFunction("onMouseUp",s.BIND_TO_SCENE,"mouseup");s.defineAPIFunction("onMouseWheel",s.BIND_TO_SCENE,"mousewheel");s.defineAPIFunction("onKeyDown",s.BIND_TO_SCENE,"keydown");s.defineAPIFunction("onKeyUp",s.BIND_TO_SCENE,"keyup");s.defineAPIFunction("onGamepadConnected",s.BIND_TO_SCENE,"gamepadconnected");s.defineAPIFunction("onGamepadDisconnected",s.BIND_TO_SCENE,"gamepaddisconnected");s.defineAPIFunction("onButtonDown",
s.BIND_TO_SCENE,"buttondown");s.defineAPIFunction("onButtonUp",s.BIND_TO_SCENE,"buttonup");s.defineAPIFunction("onDragStart",s.BIND_TO_SCENE,"dragstart");s.defineAPIFunction("onFileDrop",s.BIND_TO_SCENE,"fileDrop");s.defineAPIFunction("onEditorEvent",s.BIND_TO_SCENE,"editorEvent");s.defineAPIFunction("onEditorRender",s.BIND_TO_SCENE,"renderEditor");s.defineAPIFunction("onEditorRenderGUI",s.BIND_TO_SCENE,"renderEditorGUI");s.coding_help="For a complete guide check: <a href='https://github.com/jagenjo/litescene.js/blob/master/guides/scripting.md' target='blank'>Scripting Guide</a>";
s.active_scripts={};Object.defineProperty(s.prototype,"context",{set:function(a){console.error("Script: context cannot be assigned")},get:function(){return this._script?this._script._context:null},enumerable:!1});Object.defineProperty(s.prototype,"name",{set:function(a){console.error("Script: name cannot be assigned, add to the first line //@name")},get:function(){return this._name},enumerable:!1});s.prototype.configure=function(a){a.uid&&(this.uid=a.uid);void 0!==a.enabled&&(this.enabled=a.enabled);
void 0!==a.code&&(this.code=a.code);this._root&&this._root.scene&&this.processCode();a.properties&&this.setContextProperties(a.properties)};s.prototype.serialize=function(){return{object_class:"Script",uid:this.uid,enabled:this.enabled,code:this.code,properties:d.cloneObject(this.getContextProperties())}};s.prototype.getContext=function(){return this._script?this._script._context:null};s.prototype.getCode=function(){return this.code};s.prototype.setCode=function(a,b,c){this.code=a;this._blocked_functions.clear();
this.processCode(b,c)};s.prototype.reload=function(){this.processCode()};s.prototype.setBreakpoint=function(a,b){if(this._breakpoints||b)this._breakpoints||(this._breakpoints={}),b?this._breakpoints[a]=!0:(delete this._breakpoints[a],0==Object.keys(this._breakpoints).length&&(this._breakpoints=null))};s.prototype.hasBreakpoint=function(a){return this._breakpoints?this._breakpoints[a]:!1};s.prototype.processCode=function(a,b){this._blocked_functions.clear();this._script.code=this.code;this._name="";
if(this.code){var c=this.code.substr(0,128);if(0==c.indexOf("//@")){var e=c.indexOf("\n");-1==e&&(e=void 0);this._name=c.substr(3,e-3).trim()}}if(!this._root||d.Script.block_execution||!d.allow_scripts)return!0;this._script&&this._script._context&&this._script._context.unbindAll();c=this._stored_properties||this.getContextProperties();e=this._script.compile({component:this,node:this._root,scene:this._root.scene,transform:this._root.transform,globals:d.Globals});a||this.hookEvents();b||this.setContextProperties(c);
this._stored_properties=null;if(this._script._context&&!this._script._context._initialized){if(this._root&&this._script._context.onAddedToNode)this._script._context.onAddedToNode(this._root);if(this._root&&this._root.scene){if(this._script._context.onAddedToScene)this._script._context.onAddedToScene(this._root.scene);if(this._script._context.onBind)this._script._context.onBind(this._root.scene);this._root.scene._state===d.PLAYING&&this._script._context.start&&this._script._context.start()}this._script._context._initialized=
!0}this._name&&this._root&&this._root.scene&&(d.Script.active_scripts[this._name]=this);console.log(" + Script: "+this._name+" CTX: ",this._script._context);return e};s.prototype.getContextProperties=function(){var a=this.getContext();if(a)return this.onSerialize?this.onSerialize():d.cloneObject(a,null,!1,!1,!0)};s.prototype.setContextProperties=function(a){if(a){var b=this.getContext();if(b){if(d.cloneObject(a,b,!1,!0,!0),b.onConfigure)b.onConfigure(a)}else this._stored_properties=a}};s.prototype.setProperty=
function(a,b){var c=this.getContext();if(c&&void 0!==c[a])if(c[a].set)c[a](b);else c[a]=b;else this[a]&&(this[a]=b)};s.prototype.getPropertiesInfo=function(){var a=this.getContext();if(!a)return{enabled:"boolean"};a=d.getObjectProperties(a);a.enabled="boolean";return a};s.prototype.onAction=function(a,b){var c=this.getContext();if(c.onAction)return c.onAction(a,b)};s.prototype.getActions=function(a){var b=this.getContext();if(!b||!b.getActions)return a;if(b=b.getActions())for(var c in b)a[c]=b[c];
return a};s.prototype.getEvents=function(){var a=this.getContext();return a&&a.getEvents?a.getEvents():null};s.prototype.getPropertyInfoFromPath=function(a){if("context"==a[0]){var b=this.getContext();if(1==a.length)return{name:"context",node:this._root,target:b,type:"object",value:b};a=a[1];if(b&&void 0!==b[a]){var c=b[a],e=b["@"+a];e||(e=b.constructor["@"+a]);var d="";e&&(d=e.type);d||null===c||void 0===c||(c.constructor===String?d="string":c.constructor===Boolean?d="boolean":c.length?d="vec"+c.length:
c.constructor===Number?d="number":c.constructor===Function&&(d="function"));"function"==d&&(c=a);return{node:this._root,target:b,name:a,value:c,type:d}}}};s.prototype.setPropertyValueFromPath=function(a,b,c){c=c||0;if(!(a.length<c+1)&&"context"==a[c]){var e=this.getContext();a=a[c+1];if(e&&void 0!==e[a]&&void 0!==e[a]&&(!e[a]||e[a].constructor!=Function))return e[a]&&e[a].set?e[a].set(b):e[a]=b,!0}};s.prototype.hookEvents=function(){var a=this._root;if(!a)throw"hooking events of a Script without a node";
var b=a.scene||d.GlobalScene,c=this.getContext();if(c)for(var e in d.Script.API_functions){var g=e,f=d.Script.API_functions[g],h=null;switch(f.target){case s.BIND_TO_COMPONENT:h=this;break;case s.BIND_TO_NODE:h=a;break;case s.BIND_TO_SCENE:h=b;break;case s.BIND_TO_RENDERER:h=d.Renderer}if(!h)throw"Script event without target?";c[g]&&c[g].constructor===Function?LEvent.isBind(h,f.event,this.onScriptEvent,this)||LEvent.bind(h,f.event,this.onScriptEvent,this):LEvent.unbind(h,f.event,this.onScriptEvent,
this)}};s.prototype.onScriptEvent=function(a,b){if(this.enabled){if(!a)throw"Event without type";var c=d.Script.API_events_to_function[a];if(c)return this.callMethod(c.name,b)}};s.prototype.callMethod=function(a,b,c){var e=!1;this._breakpoints&&this._breakpoints[a]&&(e=!0,this.setBreakpoint(a,!1));if(this._blocked_functions.has(a))console.warn("Script: blocked function trying to be executed, skipping: "+a);else{if(e)debugger;return this._script.callMethod(a,b,c,this)}};s.prototype.onAddedToNode=function(a){a.script||
(a.script=this)};s.prototype.onRemovedFromNode=function(a){if(this._script._context&&this._script._context.onDestroy)this._script._context.onDestroy();a.script==this&&delete a.script};s.prototype.onAddedToScene=function(a){this._name&&(d.Script.active_scripts[this._name]=this);if(this._script&&this._script._context&&this._script._context._initialized){if(this.hookEvents(),this._script._context.onBind)this._script._context.onBind()}else if(this.constructor.catch_important_exceptions)try{this.processCode()}catch(b){console.error(b)}else this.processCode()};
s.prototype.onRemovedFromScene=function(a){this._name&&d.Script.active_scripts[this._name]==this&&delete d.Script.active_scripts[this._name];LEvent.unbindAll(a,this);if(this._context){LEvent.unbindAll(a,this._context,this);if(this._script._context.onUnbind)this._script._context.onUnbind(a);if(this._script._context.onRemovedFromScene)this._context.onRemovedFromScene(a)}};s.prototype.getComponentTitle=function(){return this.name};s.prototype.toInfoString=function(){return this._root?d.getObjectClassName(this)+
" in node "+this._root.name:d.getObjectClassName(this)};s.prototype.onError=function(a){var b=this._root.scene;b&&(a.script=this,a.node=this._root,console.warn("Script: blocking function on script due to error: "+a.method_name),this._blocked_functions.add(a.method_name),LEvent.trigger(this,"code_error",a),LEvent.trigger(b,"code_error",a),LEvent.trigger(Xa,"code_error",a),console.log("app finishing due to error in script, scene state is keep as it was during the error."),b.finish())};s.prototype.onCodeChange=
function(a){this.processCode()};s.prototype.getResources=function(a){var b=this.getContext(),c;for(c in b){var e=b[c],g=b.constructor["@"+c];if(e&&g&&(d.RESOURCE_TYPES[g.type]&&(a[e]=!0),g.type==d.TYPES.ARRAY&&e.length&&g.data_type&&g.data_type.constructor===String&&d.RESOURCE_TYPES[g.data_type.toLowerCase()]))for(g=0;g<e.length;++g)a[e[g]]=!0}if(b&&b.onGetResources)b.onGetResources(a)};s.prototype.onResourceRenamed=function(a,b,c){var e=this.getContext();if(e&&e.onResourceRenamed)e.onResourceRenamed(a,
b,c)};d.registerComponent(s);d.Script=s;wa.coding_help=s.coding_help;Object.defineProperty(wa.prototype,"filename",{set:function(a){a&&(a=d.ResourcesManager.cleanFullpath(a));this._filename=a;this.processCode()},get:function(){return this._filename},enumerable:!0});Object.defineProperty(wa.prototype,"context",{set:function(a){console.error("ScriptFromFile: context cannot be assigned")},get:function(){return this._script?this._script._context:null},enumerable:!1});Object.defineProperty(wa.prototype,
"name",{set:function(a){console.error("Script: name cannot be assigned, set the first line with //@name")},get:function(){return this._name},enumerable:!1});wa.prototype.onAddedToScene=function(a){if(this._script&&this._script._context&&this._script._context._initialized){if(this._script._context.onBind)this._script._context.onBind(a);if(this._script._context.onAddedToScene)this._script._context.onAddedToScene(a)}else if(this.constructor.catch_important_exceptions)try{this.processCode()}catch(b){console.error(b)}else this.processCode()};
wa.prototype.reload=function(a){if(this.filename){var b=this;d.ResourcesManager.load(this.filename,null,function(c,e){e==b.filename&&(b.processCode(),a&&a(b))},!0)}};wa.prototype.processCode=function(a,b,c){var e=this;if(this.filename){var g=d.ResourcesManager.getResource(this.filename);if(g)if(g=g.data,void 0===g)this._name="";else{if(this._script.code!=g){this._name="";if(g){var f=g.substr(0,128);if(0==f.indexOf("//@")){var h=f.indexOf("\n");-1==h&&(h=void 0);this._name=f.substr(3,h-3).trim()}}if(!this._root||
d.Script.block_execution)return!0;this._script.code=g;this._script&&this._script._context&&this._script._context.unbindAll();g=this._stored_properties||this.getContextProperties();f=this._script.compile({component:this,node:this._root,scene:this._root.scene,transform:this._root.transform,globals:d.Globals});a||this.hookEvents();c||this.setContextProperties(g);this._stored_properties=null;if(this._script._context&&!this._script._context._initialized){if(this._root&&this._script._context.onAddedToNode)this._script._context.onAddedToNode(this._root);
if(this._root&&this._root.scene){if(this._script._context.onAddedToScene)this._script._context.onAddedToScene(this._root.scene);if(this._script._context.onBind)this._script._context.onBind(this._root.scene);this._root.scene._state===d.PLAYING&&this._script._context.start&&this._script._context.start()}this._script._context._initialized=!0}this._name&&this._root&&this._root.scene&&(d.Script.active_scripts[this._name]=this);b&&b(this);console.log(" + Script: "+this._name+" CTX: ",this._script._context);
return f}}else d.ResourcesManager.load(this.filename,null,function(c,d){d==e.filename&&(e.processCode(a),b&&b(e))})}};wa.prototype.configure=function(a){a.uid&&(this.uid=a.uid);void 0!==a.enabled&&(this.enabled=a.enabled);void 0!==a.filename&&(this.filename=a.filename);a.properties&&this.setContextProperties(a.properties);this._root&&this._root.scene&&this.processCode()};wa.prototype.serialize=function(){return{object_class:"ScriptFromFile",uid:this.uid,enabled:this.enabled,filename:this.filename,
properties:d.cloneObject(this.getContextProperties())}};wa.prototype.onAction=function(a,b){var c=this.getContext();if(c&&c.onAction)return c.onAction(a,b)};wa.prototype.getActions=s.prototype.getActions();wa.prototype.getEvents=s.prototype.getEvents();wa.prototype.getResources=function(a){this.filename&&(a[this.filename]=d.Resource);var b=this.getContext();b&&b.getResources&&b.getResources(a)};wa.prototype.onResourceRenamed=function(a,b,c){this.filename==a&&(this.filename=b)};wa.prototype.getCodeResource=
function(){return d.ResourcesManager.getResource(this.filename)};wa.prototype.getCode=function(){var a=d.ResourcesManager.getResource(this.filename);return a?a.data:""};wa.prototype.setCode=function(a,b,c){var e=d.ResourcesManager.getResource(this.filename);if(!e)return"";e.data=a;this.processCode(b,null,c)};wa.updateComponents=function(a,b){if(a)for(var c=a.fullpath||a.filename,e=d.GlobalScene.findNodeComponents(d.ScriptFromFile),g=0;g<e.length;++g){var f=e[g];f.filename==c&&f.processCode(b)}};d.extendClass(wa,
s);d.registerComponent(wa);d.ScriptFromFile=wa;ga.GRID_MODE=1;ga.RADIAL_MODE=2;ga.MESH_MODE=3;ga.CHILDREN_MODE=4;ga.CUSTOM_MODE=5;ga.icon="mini-icon-cloner.png";ga["@mesh"]={type:"mesh"};ga["@lod_mesh"]={type:"mesh"};ga["@mode"]={type:"enum",values:{Grid:ga.GRID_MODE,Radial:ga.RADIAL_MODE,Children:ga.CHILDREN_MODE,Custom:ga.CUSTOM_MODE}};ga["@count"]={type:"vec3",min:1,step:1,precision:0};ga.prototype.onAddedToScene=function(a){LEvent.bind(a,"collectRenderInstances",this.onCollectInstances,this)};
ga.prototype.onRemovedFromScene=function(a){LEvent.unbind(a,"collectRenderInstances",this.onCollectInstances,this)};ga.prototype.getMesh=function(){return this.mesh&&this.mesh.constructor===String?d.ResourcesManager.meshes[this.mesh]:this.mesh};ga.prototype.getLODMesh=function(){return this.lod_mesh&&this.lod_mesh.constructor===String?d.ResourcesManager.meshes[this.lod_mesh]:this.lod_mesh};ga.prototype.getAnyMesh=function(){return this.getMesh()||this.getLODMesh()};ga.prototype.getResources=function(a){this.mesh&&
this.mesh.constructor===String&&(a[this.mesh]=Mesh);this.lod_mesh&&this.lod_mesh.constructor===String&&(a[this.lod_mesh]=Mesh);return a};ga.prototype.onResourceRenamed=function(a,b,c){this.mesh==a&&(this.mesh=b);this.lod_mesh==a&&(this.lod_mesh=b)};ga.prototype.onCollectInstances=function(a,b){if(this.enabled){var c=this.getAnyMesh();if(!c)return null;var e=this._root;if(this._root){var g=this._RI;g.layers=e.layers;g.fromNode(this._root,!0);g.setMatrix(d.IDENTITY,d.IDENTITY);e=null;e=this.material?
d.ResourcesManager.getResource(this.material):this._root.getMaterial();g.setMaterial(e);g.setMesh(c,this.primitive);g.use_bounding=!1;if(-1!=this.submesh_id&&null!=this.submesh_id&&c.info&&c.info.groups){if(e=c.info.groups[this.submesh_id])g.setRange(e.start,e.length),e.bounding&&g.setBoundingBox(e.bounding)}else g.setRange(0,-1);g.collision_mesh=c;this.computeInstancesMatrix(g);0!=this._instances_matrix.length&&b.push(g)}}};ga.prototype.computeInstancesMatrix=function(a){var b=this._root.transform.getGlobalMatrixRef();
a.instanced_models=this._instances_matrix;var c=this._count[0]|0,e=this._count[1]|0,d=this._count[2]|0,f=vec3.create(),h=vec3.create(),k=vec3.create();vec3.create();a.picking_node=null;if(this.mode==ga.GRID_MODE){var l=c*e*d;this._instances_matrix.length=l;if(0!=l)for(vec3.scale(f,this.size,0.5),1<c?h[0]=this.size[0]/(c-1):f[0]=0,1<e?h[1]=this.size[1]/(e-1):f[1]=0,1<d?h[2]=this.size[2]/(d-1):f[2]=0,l=a=0;l<c;++l)for(var m=0;m<e;++m)for(var p=0;p<d;++p){var n=this._instances_matrix[a];n||(n=this._instances_matrix[a]=
mat4.create());k[0]=l*h[0]-f[0];k[1]=m*h[1]-f[1];k[2]=p*h[2]-f[2];mat4.translate(n,b,k);++a}}else if(this.mode==ga.RADIAL_MODE){if(l=c,this._instances_matrix.length=l,0!=l)for(h=2*Math.PI/l,a=0;a<l;++a)(n=this._instances_matrix[a])||(n=this._instances_matrix[a]=mat4.create()),k[0]=Math.sin(h*a)*this.size[0],k[1]=0,k[2]=Math.cos(h*a)*this.size[0],n.set(b),mat4.translate(n,n,k),mat4.rotateY(n,n,h*a)}else if(this.mode==ga.CHILDREN_MODE)if(this._root&&this._root._children){if(l=this._root._children.length,
this._instances_matrix.length=l,0!=l)for(a=0;a<l;++a)(n=this._instances_matrix[a])||(n=this._instances_matrix[a]=mat4.create()),(b=this._root._children[a])&&b.transform&&b.transform.getGlobalMatrix(n)}else this._instances_matrix.length=0};ga.prototype.setInstancesMatrices=function(a){this._instances_matrix=a};d.registerComponent(ga);sa.icon="mini-icon-clock.png";Object.defineProperty(sa.prototype,"weights",{set:function(a){if(a&&a.length)for(var b=0;b<a.length;++b)this.poses[b]&&(this.poses[b].weight=
a[b]||0)},get:function(){for(var a=Array(this.poses.length),b=0;b<this.poses.length;++b)a[b]=this.poses[b].weight;return a},enumeration:!1});Object.defineProperty(sa.prototype,"name_weights",{set:function(a){if(a)for(var b in a){var c=this._poses_by_name[b];c&&(c.weight=Number(a[b]))}},get:function(){for(var a={},b=0;b<this.poses.length;++b){var c=this.poses[b];a[c.name]=c.weight}return a},enumeration:!1});sa.prototype.onAddedToScene=function(a){LEvent.bind(a,"update",this.onUpdate,this)};sa.prototype.onRemovedFromScene=
function(a){LEvent.unbind(a,"update",this.onUpdate,this)};sa.prototype.onUpdate=function(a,b){if(this.enabled&&this._root){this.applyPoseFromWeights();var c=this._root.scene;c&&c.requestFrame()}};sa.prototype.addBaseNode=function(a){for(var b=null,c=a.uid,e=0;e<this.base_nodes.length;++e){var d=this.base_nodes[e];if(d.node_uid==c){b=d;break}}b||(b={node_uid:c,position:[0,0,0],rotation:[0,0,0,1],scaling:[1,1,1]},this.base_nodes.push(b));a.transform&&(vec3.copy(b.position,a.transform._position),quat.copy(b.rotation,
a.transform._rotation),vec3.copy(b.scaling,a.transform._scaling))};sa.prototype.removeBaseNode=function(a){if(a)if(a.constructor===String&&(a=this._root.scene.getNode(a)),a)for(var b=0;b<this.base_nodes.length;++b){if(this.base_nodes[b].node_uid==a.uid){this.base_nodes.splice(b,1);this.purgePoses();break}}else console.warn("Node not found")};sa.prototype.setChildrenAsBaseNodes=function(a){this.base_nodes.length=0;a&&this.addBaseNode(this._root);a=this._root.getDescendants();for(var b=0;b<a.length;++b)this.addBaseNode(a[b])};
sa.prototype.addPose=function(a){var b={name:a,weight:0,nodes:[]};this.poses.push(b);this._poses_by_name[a]=b;this.updatePose(a)};sa.prototype.removePose=function(a){var b=this._poses_by_name[a];b&&(b=this.poses.indexOf(b),-1!=b&&this.poses.splice(b,1),delete this._poses_by_name[a])};sa.prototype.setPoseWeight=function(a,b){var c=this._poses_by_name[a];c&&(c.weight=b)};sa.prototype.updatePose=function(a){if(this._root&&this._root.scene){a=this._poses_by_name[a];if(!a)return null;var b=this._root.scene;
a.nodes.length=0;for(var c=vec3.create(),e=quat.create(),g=vec3.create(),f=0;f<this.base_nodes.length;++f){var h=this.base_nodes[f],k=b.getNode(h.node_uid);k?(vec3.sub(c,k.transform._position,h.position),quat.invert(e,k.transform._rotation),quat.mul(e,h.rotation,e),quat.invert(e,e),vec3.div(g,k.transform._scaling,h.scaling),h={node_uid:k.uid},1E-5<vec3.length(c)&&(h.delta_pos=Array.apply([],c)),1E-4<vec4.dist(e,d.QUAT_IDENTITY)&&(h.delta_rot=Array.apply([],e)),1E-5<Math.abs(vec3.length(g)-1)&&(h.delta_scale=
Array.apply([],g)),a.nodes.push(h)):console.warn("addPose error, node not found in scene")}return a}};sa.prototype.applyBasePose=function(){if(this._root&&this._root.scene){var a=this._root.scene;if(a)for(var b=0;b<this.base_nodes.length;++b){var c=this.base_nodes[b],e=a.getNode(c.node_uid);e&&e.transform&&(e.transform.position=c.position,e.transform.rotation=c.rotation,e.transform.scaling=c.scaling)}}};sa.prototype.applyPose=function(a,b){if(this._root&&this._root.scene){var c=this._root.scene;if(c){var e=
this._poses_by_name[a];if(e)for(var d=0;d<this.base_nodes.length;++d){var f=this.base_nodes[d],h=c.getNode(f.node_uid);if(h&&h.transform){var k=e.nodes[d];k?(k.delta_pos?vec3.add(h.transform._position,b?h.transform._position:f.position,k.delta_pos):b||(h.transform.position=f.position),k.delta_rot?quat.mul(h.transform._rotation,k.delta_rot,b?h.transform._rotation:f.rotation):b||(h.transform.rotation=f.rotation),h.transform._must_update=!0):b||(h.transform.position=f.position,h.transform.rotation=f.rotation,
h.transform.scaling=f.scaling)}}}}};sa.temp_quat=quat.create();sa.prototype.applyPoseFromWeights=function(){var a=this._root.scene;if(a){var b=this.base_nodes.length,c=this._positions_array,e=this._rotations_array,g=this._scalings_array;c&&c.length==3*b||(c=this._positions_array=new Float32Array(3*b),e=this._rotations_array=new Float32Array(4*b),g=this._scalings_array=new Float32Array(3*b));for(var f=sa.temp_quat,h=0;h<b;++h)c.set(d.ZEROS,3*h),e.set(d.QUAT_IDENTITY,4*h),g.set(d.ONES,3*h);for(var k=
0;k<this.poses.length;++k){var l=this.poses[k];if(l.weight)for(h=0;h<l.nodes.length;++h){var m=l.nodes[h];m.delta_pos&&(b=c.subarray(3*h,3*h+3),vec3.scaleAndAdd(b,b,m.delta_pos,l.weight));if(m.delta_rot){var p=e.subarray(4*h,4*h+4);quat.slerp(f,d.QUAT_IDENTITY,m.delta_rot,l.weight);quat.mul(p,p,f)}}}for(h=0;h<this.base_nodes.length;++h)f=this.base_nodes[h],(k=a.getNode(f.node_uid))&&k.transform&&(b=c.subarray(3*h,3*h+3),p=e.subarray(4*h,4*h+4),g.subarray(3*h,3*h+3),quat.normalize(p,p),f.position&&
vec3.add(k.transform._position,b,f.position),f.rotation&&quat.mul(k.transform._rotation,p,f.rotation),k.transform._must_update=!0)}};sa.prototype.purgePoses=function(){var a={},b=this._root.scene;if(b){for(var c=0;c<this.base_nodes.length;++c){var e=b.getNode(this.base_nodes[c].node_uid);e&&(a[e.uid]=!0)}for(c=0;c<this.poses.length;++c)for(b=this.poses[c].nodes,e=0;e<b.length;++e)a[b[e].node_uid]||(b.splice(e,1),e--)}};sa.prototype.setProperty=function(a,b){if("enabled"==a)this.enabled=b;else if("pose_"==
a.substr(0,5)){a=a.substr(5);var c=a.split("_"),e=this.poses[Number(c[0])];e&&"weight"==c[1]&&(e.weight=b)}else"weights"==a?this.weights=b:"name_weights"==a&&(this.name_weights=b)};sa.prototype.getProperty=function(a){if("pose_"==a.substr(0,5)&&5<a.length){a=a.substr(5).split("_");var b=this.poses[Number(a[0])];if(b&&"weight"==a[1])return b.weight}};sa.prototype.getPropertiesInfo=function(){for(var a={enabled:"boolean",weights:"array",name_weights:"object"},b=0;b<this.poses.length;++b)a["pose_"+b+
"_weight"]="number";return a};sa.prototype.configure=function(a){d.BaseComponent.prototype.configure.call(this,a);for(a=0;a<this.poses.length;++a)this._poses_by_name[this.poses[a].name]=this.poses[a]};d.registerComponent(sa);ta["@subdivisions"]={type:"number",step:1,min:1,max:100,precision:0};ta["@type"]={type:"enum",values:{line:d.LINEAR,bezier:d.BEZIER,hermite:d.HERMITE}};ta.prototype.serialize=function(){return{enabled:this.enabled,render:this._render_in_viewport,path:this.path.serialize(),subs:this._subdivisions,
tangents:this.preserve_tangents}};ta.prototype.configure=function(a){this._must_update=!0;this.enabled=a.enabled;this.render_in_viewport=a.render;this.path.configure(a.path);this.preserve_tangents=a.tangents;this._subdivisions=a.subs||1};Object.defineProperty(ta.prototype,"render_in_viewport",{get:function(){return this._render_in_viewport},set:function(a){this._render_in_viewport!=a&&(this._render_in_viewport=a,this._root&&(a?LEvent.bind(this._root,"collectRenderInstances",this.onCollectInstances,
this):LEvent.unbind(this._root,"collectRenderInstances",this.onCollectInstances,this)))},enumerable:!0});Object.defineProperty(ta.prototype,"subdivisions",{get:function(){return this._subdivisions},set:function(a){this._subdivisions=a|0;this._must_update=!0},enumerable:!0});Object.defineProperty(ta.prototype,"closed",{get:function(){return this.path.closed},set:function(a){this.path.closed=a;this._must_update=!0},enumerable:!0});Object.defineProperty(ta.prototype,"type",{get:function(){return this.path.type},
set:function(a){this.path.type=a;this._must_update=!0},enumerable:!0});Object.defineProperty(ta.prototype,"numberOfPoints",{get:function(){return this.path.points.length},set:function(a){throw"number of points cannot be set, use addPoint";},enumerable:!1});Object.defineProperty(ta.prototype,"points",{get:function(){return this.path.points},set:function(a){throw"points cannot be set, use addPoint";},enumerable:!1});ta.prototype.onAddedToNode=function(a){this._render_in_viewport&&LEvent.bind(a,"collectRenderInstances",
this.onCollectInstances,this)};ta.prototype.onRemovedFromNode=function(a){this._render_in_viewport&&LEvent.unbind(a,"collectRenderInstances",this.onCollectInstances,this)};ta.prototype.onCollectInstances=function(a,b){if(this.enabled&&this._root&&0!=this.path.getSegments()){this._mesh&&!this._must_update||this.updateMesh();var c=this._render_instance;c||(this._render_instance=c=new d.RenderInstance(this._root,this));c.fromNode(this._root);c.setMesh(this._mesh,gl.LINE_STRIP);c.setRange(0,this._range);
c.setMaterial(this._root.getMaterial());b.push(c)}};ta.prototype.updateMesh=function(){this._mesh||(this._mesh=GL.Mesh.load({vertices:new Float32Array(3*this._max_points)}));var a=this._mesh.getVertexBuffer("vertices"),b=a.data,c=0,c=this.path.type==d.LINEAR?this.path.getSegments()+1:this.path.getSegments()*this._subdivisions;c>this._max_points&&(c=this._max_points);this.path.samplePointsTyped(c,b);a.uploadRange(0,12*c);this._range=c;this._must_update=!1};ta.prototype.clear=function(){this._must_update=
!0;this.path.clear()};ta.prototype.getPoint=function(a,b){b=b||vec3.create();this.path.closed&&(a%=1,0>a&&(a=1+a));this.path.computePoint(a,b);if(this._root.transform){var c=this._root.transform.getGlobalMatrix();mat4.multiplyVec3(b,c,b)}return b};ta.prototype.getPointRef=function(a){return a<this.path.points.length?this.path.points[a]:null};ta.prototype.addPoint=function(a){if(this._root.transform){var b=this._root.transform.getGlobalMatrix();mat4.invert(b,b);a=mat4.multiplyVec3(vec3.create(),b,
a)}this.path.addPoint(a);this._must_update=!0};ta.prototype.addPointLocal=function(a){this.path.addPoint(a);this._must_update=!0};ta.prototype.renderEditor=function(a){var b=this.path;2>b.points.length||(gl.disable(gl.DEPTH_TEST),d.Draw.push(),this._root.transform&&d.Draw.setMatrix(this._root.transform.getGlobalMatrixRef(!0)),a&&(d.Draw.setColor(0.9,0.5,0.9,1),d.Draw.setPointSize(9),d.Draw.renderRoundPoints(b.points)),this._render_in_viewport?(d.Draw.pop(),gl.enable(gl.DEPTH_TEST)):(window.SelectionModule&&
SelectionModule.selection&&SelectionModule.selection.instance==this&&void 0!=SelectionModule.selection.info&&(b=this.points[SelectionModule.selection.info],d.Draw.setColor(1,1,0.4,1),d.Draw.setPointSize(14),d.Draw.renderRoundPoints(b)),this._mesh&&!this._must_update||this.updateMesh(),a?d.Draw.setColor(0.6,0.6,0.6,0.8):d.Draw.setColor(0.6,0.5,0.4,0.5),d.Draw.renderMesh(this._mesh,GL.LINE_STRIP,null,null,0,this._range),gl.enable(gl.DEPTH_TEST),d.Draw.pop()))};ta.prototype.renderPicking=function(a){a=
this._root.transform.getGlobalMatrixRef(!0);for(var b=this.path,c=0;c<b.points.length;++c){var e=b.points[c];this._root.transform&&(e=mat4.multiplyVec3(vec3.create(),a,e));d.Picking.addPickingPoint(e,9,{instance:this,info:c})}};ta.prototype.applyTransformMatrix=function(a,b,c){b=this.path.points[c];if(!b)return!1;this._must_update=!0;a=mat4.multiplyVec3(vec3.create(),a,b);this.path.movePoint(c,a,this.preserve_tangents);return!0};ta.prototype.getTransformMatrix=function(a){a=this.path.points[a];if(!a)return null;
var b=this._root.transform.getGlobalMatrix();mat4.translate(b,b,a);return b};d.registerComponent(ta);nb["@spline"]={type:d.TYPES.COMPONENT_ID};nb["@factor"]={type:"number",step:0.001,precision:3};nb.prototype.serialize=function(){return{enabled:this.enabled,spline:this.spline,factor:this.factor}};nb.prototype.configure=function(a){this.enabled=a.enabled;this.spline=a.spline;this.factor=a.factor};nb.prototype.onAddedToScene=function(a){LEvent.bind(a,"update",this.onUpdate,this)};nb.prototype.onRemovedFromScene=
function(a){LEvent.unbind(a,"update",this.onUpdate,this)};nb.prototype.onUpdate=function(a,b){var c=this._root;if(c&&c.transform){var e=d.GlobalScene.findComponentByUId(this.spline);if(e){var g=this._last_position,f=this._last_position_inc;e.getPoint(this.factor,g);e.getPoint(this.factor+0.001,f);c._parentNode&&c._parentNode.transform&&(e=c._parentNode.transform.getGlobalMatrix(),mat4.invert(e,e),mat4.multiplyVec3(g,e,g),mat4.multiplyVec3(f,e,f));1E-5>vec3.distance(g,f)?c.transform.setPosition(g):
c.transform.lookAt(g,f,d.TOP)}}};d.registerComponent(nb);Y.icon="mini-icon-brush.png";Y.MODE_CANVAS2D=1;Y.MODE_WEBGL=2;Y.MODE_IMMEDIATE=3;Y["@mode"]={type:"enum",values:{Canvas2D:Y.MODE_CANVAS2D,WebGL:Y.MODE_WEBGL,Immediate:Y.MODE_IMMEDIATE}};Y["@width"]={type:"number",step:1,precision:0};Y["@height"]={type:"number",step:1,precision:0};Y["@texture_name"]={type:"string"};Object.defineProperty(Y.prototype,"texture",{set:function(){throw"Canvas3D texture cannot be set manually";},get:function(){return this._texture},
enumerable:!1});Y.prototype.onAddedToScene=function(a){LEvent.bind(a,d.EVENT.READY_TO_RENDER,this.onRender,this);LEvent.bind(a,d.EVENT.AFTER_RENDER_INSTANCES,this.onRender,this)};Y.prototype.onRemovedFromScene=function(a){LEvent.unbind(a,d.EVENT.READY_TO_RENDER,this.onRender,this);LEvent.unbind(a,d.EVENT.AFTER_RENDER_INSTANCES,this.onRender,this)};Y.prototype.onAddedToNode=function(a){this.texture_name||(this.texture_name=":canvas3D");LEvent.bind(a,d.EVENT.COLLECT_RENDER_INSTANCES,this.onCollectInstances,
this)};Y.prototype.onRemovedFromNode=function(a){LEvent.unbind(a,d.EVENT.COLLECT_RENDER_INSTANCES,this.onCollectInstances,this)};Y.prototype.onRender=function(a){var b=d.Renderer._current_camera;this.enabled&&b&&b.checkLayersVisibility(this._root.layers)&&(a==d.EVENT.READY_TO_RENDER&&(this.mode==Y.MODE_CANVAS2D||this.mode==Y.MODE_WEBGL)||a==d.EVENT.AFTER_RENDER_INSTANCES&&this.mode==Y.MODE_IMMEDIATE)&&this.drawCanvas()};Y.prototype.drawCanvas=function(){var a=this.width|0,b=this.height|0;this.mode==
Y.MODE_CANVAS2D&&(this._canvas||(this._canvas=document.createElement("canvas")),this._canvas.width!=a&&(this._canvas.width=a),this._canvas.height!=b&&(this._canvas.height=b));var c=this.high_precision?gl.HIGH_PRECISION_FORMAT:gl.UNSIGNED_BYTE;this.mode==Y.MODE_IMMEDIATE||this._texture&&this._texture.width==a&&this._texture.height==b&&this._texture.type==c||(this._texture=new GL.Texture(a,b,{type:c,format:GL.RGBA,filter:GL.LINEAR,wrap:GL.CLAMP_TO_EDGE}));this.visible&&this.projectMouse();if(this.mode==
Y.MODE_CANVAS2D)c=this._canvas.getContext("2d"),this._clear_buffer&&c.clearRect(0,0,this._canvas.width,this._canvas.height),d.GUI._ctx=c,this._root.processActionInComponents("onRenderCanvas",[c,this._canvas,this._mouse,this]),d.GUI._ctx=gl,this._texture.uploadImage(this._canvas);else if(this.mode==Y.MODE_WEBGL)c=gl,this._fbo||(this._fbo=new GL.FBO),this._fbo.setTextures([this._texture]),this._fbo.bind(),gl.start2D(),this._clear_buffer&&(gl.clearColor(0,0,0,0),gl.clear(GL.COLOR_BUFFER_BIT)),d.GUI._ctx=
gl,this._root.processActionInComponents("onRenderCanvas",[c,this._texture,this._mouse,this]),gl.finish2D(),this._fbo.unbind();else if(this.mode==Y.MODE_IMMEDIATE){c=gl;gl.start2D();d.GUI._ctx=gl;a=this._mvp;a||(a=this._mvp=mat4.create());mat4.identity(a);this._root.transform&&mat4.multiply(a,a,this._root.transform.getGlobalMatrixRef());mat4.scale(a,a,[1/this.width,-1/this.height,1]);mat4.translate(a,a,[-0.5*this.width,-0.5*this.height,0]);mat4.multiply(a,d.Renderer._current_camera._viewprojection_matrix,
a);gl.WebGLCanvas.set3DMatrix(a);this._canvas_info||(this._canvas_info={width:0,height:0});this._canvas_info.width=this.width;this._canvas_info.height=this.height;gl.disable(gl.CULL_FACE);gl.enable(gl.DEPTH_TEST);gl.depthFunc(gl.LEQUAL);gl.globalAlpha=this.opacity;this._root.processActionInComponents("onRenderCanvas",[c,this._canvas_info,this._mouse,this]);gl.globalAlpha=1;gl.finish2D();gl.depthFunc(gl.LESS);gl.WebGLCanvas.set3DMatrix(null);return}this._texture&&(this.generate_mipmaps&&isPowerOfTwo(a)&&
isPowerOfTwo(b)?(this._texture.setParameter(GL.TEXTURE_MIN_FILTER,GL.LINEAR_MIPMAP_LINEAR),gl.generateMipmap(gl.TEXTURE_2D)):this._texture.setParameter(GL.TEXTURE_MIN_FILTER,GL.LINEAR),d.RM.registerResource(this.texture_name||":canvas3D",this._texture));this._prev_mouse&&(d.Input.Mouse=this._prev_mouse,this._prev_mouse=null);d.Input.current_click&&this._prev_click_mouse&&(d.Input.current_click=this._prev_click_mouse,this._prev_click_mouse=null)};Y.prototype.onCollectInstances=function(a,b){if(this.enabled&&
this.visible&&this._texture&&this.mode!=Y.MODE_IMMEDIATE){this._RI||(this._RI=new d.RenderInstance);var c=this._RI,e=null;this.use_node_material&&(e=this._root.getMaterial());e||(e=this._standard_material);e||(e=this._standard_material=new d.MaterialClasses.StandardMaterial({flags:{ignore_lights:!0,cast_shadows:!1},blend_mode:d.Blend.ALPHA}));this.use_node_material||(e.opacity=this.opacity,e.blend_mode=1>e.opacity?d.Blend.ALPHA:d.Blend.NORMAL);e.setTexture("color",this.texture_name||":canvas3D");
c.fromNode(this._root);c.setMaterial(e);this._mesh||(this._mesh=GL.Mesh.plane());c.setMesh(this._mesh);b.push(c);return b}};Y.prototype.clear=function(a){this.mode==Y.MODE_CANVAS2D?this._canvas.getContext("2d").clearRect(0,0,this._canvas.width,this._canvas.height):this.mode==Y.MODE_WEBGL&&this._texture&&this._texture.fill([0,0,0,0]);if(a)this.onRender()};Y.prototype.projectMouse=function(){var a=d.Renderer._main_camera;if(a)if(this.root.transform){var b=0,b=vec3.distance(a.getEye(),this.root.transform.getGlobalPosition()),
c=b>this.max_interactive_distance;this._is_mouse_inside=!1;var e=d.Input.Mouse.canvasx,g=d.Input.Mouse.canvasy,f=this.width|0,h=this.height|0;if(!this.input_active||c)this._mouse[0]=-1,this._mouse[1]=-1,this._mouse[2]=-1;else{this._mouse[0]=-1;this._mouse[1]=-1;this._mouse[2]=b;a=a.getRay(e,g);if(!a)return;b=vec3.create();c=this.root.transform.localVectorToGlobal(d.FRONT,b);if(!this._skip_backside||0<vec3.dot(a.direction,c))b=this.root.transform.globalToLocal(a.origin,b),a=this.root.transform.globalVectorToLocal(a.direction),
geo.testRayPlane(b,a,d.ZEROS,d.FRONT,this._mouse)&&(this._mouse[0]=(this._mouse[0]+0.5)*f,this._mouse[1]=(this._mouse[1]+0.5)*h,this._mouse[1]=h-this._mouse[1])}0<=this._mouse[0]&&this._mouse[0]<f&&0<=this._mouse[1]&&this._mouse[1]<h&&(this._is_mouse_inside=!0);this._local_mouse.mousex=this._local_mouse.x=this._mouse[0];this._local_mouse.mousey=this._local_mouse.y=this._mouse[1];this._prev_mouse=d.Input.Mouse;d.Input.Mouse=this._local_mouse;d.Input.current_click&&(this._local_mouse_click.mousex=this._local_mouse.x=
this._mouse[0],this._local_mouse_click.mousey=this._local_mouse.y=this._mouse[1],this._prev_click_mouse=d.Input.current_click,d.Input.current_click=this._local_mouse_click)}else this._mouse[0]=d.Input.Mouse.canvasx,this._mouse[1]=d.Input.Mouse.canvasy,this._mouse[2]=0,this._is_mouse_inside=!0};d.registerComponent(Y);J.icon="mini-icon-video.png";J["@volume"]={widget:"slider"};Object.defineProperty(J.prototype,"enabled",{set:function(a){(this._enabled=a)?(a=this._root?this._root.scene:null)&&a.state===
d.RUNNING&&this._media.autoplay&&(this._media.currentTime>=this._media.duration&&(this._media.currentTime=0),this._media.play()):this._media.pause()},get:function(){return this._enabled},enumerable:!0});Object.defineProperty(J.prototype,"ignore_proxy",{set:function(a){a!=this._ignore_proxy&&(this._ignore_proxy=a,this.load(this.src))},get:function(){return this._ignore_proxy},enumerable:!0});Object.defineProperty(J.prototype,"src",{set:function(a){a!=this._src&&(this._src=a,this.load(this._src))},
get:function(){return this._src},enumerable:!0});Object.defineProperty(J.prototype,"time",{set:function(a){this._media.currentTime=a},get:function(){return this._media.currentTime},enumerable:!0});Object.defineProperty(J.prototype,"texture",{set:function(a){throw"MediaPlayer texture cannot be set";},get:function(){return this._texture},enumerable:!1});Object.defineProperty(J.prototype,"autoplay",{set:function(a){this._autoplay=a},get:function(){return this._autoplay},enumerable:!0});Object.defineProperty(J.prototype,
"muted",{set:function(a){this._media.muted=a},get:function(){return this._media.muted},enumerable:!0});Object.defineProperty(J.prototype,"volume",{set:function(a){this._media.volume=Math.clamp(a,0,1)},get:function(){return this._media.volume},enumerable:!0});Object.defineProperty(J.prototype,"duration",{set:function(a){},get:function(){return this._media.duration},enumerable:!0});Object.defineProperty(J.prototype,"playback_rate",{set:function(a){0>a||(this._playback_rate=a,this._media.playbackRate=
a)},get:function(){return this._playback_rate},enumerable:!0});Object.defineProperty(J.prototype,"media",{set:function(a){if(!a||a.constructor!==HTMLVideoElement)throw"Video must a HTMLVideoElement";a!=this._media&&(this._media=a,this._media.muted=!1,this._media.autoplay=!1,this._media.playbackRate=this._playback_rate,this.bindVideoEvents(this._media))},get:function(){return this._media},enumerable:!1});J.NONE=0;J.PLANE=1;J.TO_MATERIAL=2;J.BACKGROUND=5;J.BACKGROUND_STRETCH=6;J["@src"]={type:"resource"};
J["@render_mode"]={type:"enum",values:{NONE:J.NONE,PLANE:J.PLANE,TO_MATERIAL:J.TO_MATERIAL,BACKGROUND_STRETCH:J.BACKGROUND_STRETCH}};J.prototype.onAddedToScene=function(a){LEvent.bind(a,"start",this.onStart,this);LEvent.bind(a,"pause",this.onPause,this);LEvent.bind(a,"unpause",this.onUnpause,this);LEvent.bind(a,"beforeRender",this.onBeforeRender,this);LEvent.bind(a,"beforeRenderScene",this.onBeforeRenderScene,this);LEvent.bind(a,"collectRenderInstances",this.onCollectInstances,this);LEvent.bind(a,
"finish",this.onFinish,this)};J.prototype.onRemovedFromScene=function(a){LEvent.unbindAll(a,this)};J.prototype.onStart=function(){this.autoplay&&this.play()};J.prototype.onPause=function(){this.pause()};J.prototype.onUnpause=function(){this.autoplay&&this.play()};J.prototype.onFinish=function(){this.stop()};J.prototype.load=function(a,b){if(a){var c=d.RM.getFullURL(a,{ignore_proxy:this.ignore_proxy});if(this._url_loading!=c||b)this._url_loading=a,this._media.crossOrigin="anonymous",this._media.src=
c}};J.prototype.bindVideoEvents=function(a){var b=this;a._component=this;a.has_litescene_events||(a.has_litescene_events=!0,this._media.addEventListener("loadedmetadata",function(a){console.log("Duration: "+this.duration+" seconds");console.log("Size: "+this.videoWidth+","+this.videoHeight);this.width=this.videoWidth;this.height=this.videoHeight;this._component&&(LEvent.trigger(this._component,"loaded"),(a=this._component._root?this._component._root.scene:null)&&a.state===d.RUNNING&&this._component._autoplay&&
this._component.play())}),this._media.addEventListener("error",function(a){console.error("Error loading video: "+this.src);if(this.error)switch(this.error.code){case this.error.MEDIA_ERR_ABORTED:console.error("You stopped the video.");break;case this.error.MEDIA_ERR_NETWORK:console.error("Network error - please try again later.");break;case this.error.MEDIA_ERR_DECODE:console.error("Video is broken..");break;case this.error.MEDIA_ERR_SRC_NOT_SUPPORTED:console.error("Sorry, your browser can't play this video.")}}),
this._media.addEventListener("ended",function(a){this._component&&(console.log("Media Ended"),LEvent.trigger(b,"end"),(a=this._component._root?this._component._root.scene:null)&&a.state===d.RUNNING&&this._component._autoplay&&(this.currentTime=0,this._component.play()))}))};J.prototype.play=function(){this._media.duration&&(LEvent.trigger(this,"play"),this._media.play())};J.prototype.playPause=function(){this._media.paused?this.play():this.pause()};J.prototype.stop=function(){this._media.pause();
this._media.currentTime=0};J.prototype.pause=function(){this._media.pause()};J.prototype.onBeforeRender=function(a){if(this.enabled&&this._media.videoWidth){a=this._media;var b=this.generate_mipmaps;GL.isPowerOfTwo(a.videoWidth)&&GL.isPowerOfTwo(a.videoHeight)||(b=!1);this._texture&&this._texture.width==a.videoWidth&&this._texture.has_mipmaps==b||(this._texture=new GL.Texture(a.videoWidth,a.videoHeight,{format:GL.RGB,minFilter:b?gl.LINEAR_MIPMAP_LINEAR:gl.LINEAR,magFilter:gl.LINEAR}),this._texture.has_mipmaps=
b);this._texture._video_time!=a.currentTime&&(this._texture.uploadImage(a),b&&(this._texture.bind(0),gl.generateMipmap(this._texture.texture_type),this._texture.unbind(0)),this._texture._video_time=a.currentTime);this.texture_name&&d.RM.registerResource(this.texture_name,this._texture);this.render_mode==J.TO_MATERIAL&&(a=this._root.getMaterial())&&a.setTexture("color",this.texture_name)}};J.prototype.onBeforeRenderScene=function(a){this.enabled&&(this.render_mode==J.BACKGROUND||this.render_mode==
J.BACKGROUND_STRETCH)&&this._texture&&(gl.disable(gl.BLEND),gl.disable(gl.CULL_FACE),gl.disable(gl.DEPTH_TEST),this._texture.toViewport())};J.prototype.onCollectInstances=function(a,b){if(this.enabled&&this.render_mode==J.PLANE){this._material||(this._material=new d.StandardMaterial({flags:{ignore_lights:!0,two_sided:!0}}));if(!this._plane_ri){var c=this._plane_ri=new d.RenderInstance,e=GL.Mesh.plane();c.setMesh(e);c.setMaterial(this._material)}this._plane_ri.fromNode(this._root);this._material.setTexture("color",
this._texture);b.push(this._plane_ri)}};J.prototype.getEvents=function(){return{loaded:"event",play:"event",end:"event"}};d.registerComponent(J);Ba.icon="mini-icon-cursor.png";Ba.PICKING=1;Ba.BOUNDING=2;Ba.COLLIDERS=3;Ba.RENDER_INSTANCES=4;Ba["@mode"]={type:"enum",values:{Picking:Ba.PICKING,Bounding:Ba.BOUNDING,Colliders:Ba.COLLIDERS}};Ba["@layers"]={type:"layers"};Ba.prototype.onAddedToScene=function(a){LEvent.bind(a,"mousedown",this._onMouse,this);LEvent.bind(a,"mousemove",this._onMouse,this);LEvent.bind(a,
"mouseup",this._onMouse,this)};Ba.prototype.onRemovedFromScene=function(a){LEvent.unbindAll(a,this)};Ba.prototype.getNodeUnderMouse=function(a){var b=this.layers;if(this.mode==Ba.PICKING)return d.Picking.getNodeAtCanvasPosition(a.canvasx,a.canvasy,null,b);var c=d.Renderer.getCameraAtPosition(a.canvasx,a.canvasy);if(!c)return null;a=c.getRay(a.canvasx,a.canvasy);if(this.mode==Ba.BOUNDING){b=d.Physics.raycastRenderInstances(a.origin,a.direction,{layers:b});if(!b||!b.length)return null;this._last_collision=
b[0];return b[0].node}if(this.mode==Ba.RENDER_INSTANCES){b=d.Physics.raycastRenderInstances(a.origin,a.direction,{layers:b,triangle_collision:!0});if(!b||!b.length)return null;this._last_collision=b[0];return b[0].node}if(this.mode==Ba.COLLIDERS){b=d.Physics.raycast(a.origin,a.direction,{layers:b});if(!b||!b.length)return null;this._last_collision=b[0];return b[0].node}return null};Ba.prototype._onMouse=function(a,b){if(this.enabled){if(("mousedown"==b.eventType||"mousewheel"==b.eventType)&&(this._clicked_node=
this.getNodeUnderMouse(b))&&"mousedown"==b.eventType&&0==b.button&&(console.log("Node clicked: "+this._clicked_node.name),LEvent.trigger(this._clicked_node,"clicked",this._clicked_node),LEvent.trigger(this._root,"node_clicked",this._clicked_node),LEvent.trigger(this._root.scene,"node_clicked",this._clicked_node),this.onNodeClicked))this.onNodeClicked(this._clicked_node);this._clicked_node&&(b.scene_node=this._clicked_node,LEvent.trigger(this._clicked_node,b.eventType,b));"mouseup"==b.eventType&&(this._clicked_node=
null);if(this._clicked_node)return!0}};d.registerComponent(Ba);d.Shaders.registerSnippet("surface","\n\t//used to store surface shading properties\n\tstruct SurfaceOutput {\n\t\tvec3 Albedo;\n\t\tvec3 Normal; //separated in case there is a normal map\n\t\tvec3 Emission;\n\t\tvec3 Ambient;\n\t\tfloat Specular;\n\t\tfloat Gloss;\n\t\tfloat Alpha;\n\t\tfloat Reflectivity;\n\t\tvec4 Extra; //for special purposes\n\t};\n\t\n\tSurfaceOutput getSurfaceOutput()\n\t{\n\t\tSurfaceOutput o;\n\t\to.Albedo = u_material_color.xyz;\n\t\to.Alpha = u_material_color.a;\n\t\to.Normal = normalize( v_normal );\n\t\to.Specular = 0.5;\n\t\to.Gloss = 10.0;\n\t\to.Ambient = vec3(1.0);\n\t\to.Emission = vec3(0.0);\n\t\to.Reflectivity = 0.0;\n\t\to.Extra = vec4(0.0);\n\t\treturn o;\n\t}\n");
d.Shaders.registerSnippet("light_structs","\n\t#ifndef SB_LIGHT_STRUCTS\n\t#define SB_LIGHT_STRUCTS\n\tuniform lowp vec4 u_light_info;\n\tuniform vec3 u_light_position;\n\tuniform vec3 u_light_front;\n\tuniform vec3 u_light_color;\n\tuniform vec4 u_light_angle; //cone start,end,phi,theta \n\tuniform vec4 u_light_att; //start,end \n\tuniform float u_light_offset; //ndotl offset\n\tuniform vec4 u_light_extra; //user data\n\tuniform mat4 u_light_matrix; //projection to light screen space\n\tuniform vec3 u_ambient_light;\n\tstruct Light {\n\t\tlowp vec4 Info; //type of light (1:OMNI, 2: SPOT, 3: DIRECTIONAL), falloff type, pass index, num passes \n\t\tvec3 Color;\n\t\tvec3 Ambient;\n\t\tvec3 Position;\n\t\tvec3 Front;\n\t\tvec4 ConeInfo; //for spotlights\n\t\tvec4 Attenuation; //start,end,type,extra\n\t\tfloat Offset; //phong_offset\n\t\tvec4 Extra; //users can use this\n\t\tmat4 Matrix; //converts to light space\n\t\tfloat Distance;\n\t};\n\t//Returns the info about the light\n\tLight getLight()\n\t{\n\t\tLight LIGHT;\n\t\tLIGHT.Info = u_light_info;\n\t\tLIGHT.Color = u_light_color;\n\t\tif(u_light_info.z == 0.0)\n\t\t\tLIGHT.Ambient = u_ambient_light;\n\t\telse\n\t\t\tLIGHT.Ambient = vec3(0.0);\n\t\tLIGHT.Position = u_light_position;\n\t\tLIGHT.Front = u_light_front;\n\t\tLIGHT.ConeInfo = u_light_angle; //for spotlights\n\t\tLIGHT.Attenuation = u_light_att; //start and end\n\t\tLIGHT.Offset = u_light_offset;\n\t\tLIGHT.Distance = length( u_light_position - v_pos );\n\t\tLIGHT.Extra = u_light_extra;\n\t\tLIGHT.Matrix = u_light_matrix; //converts to light space\n\t\treturn LIGHT;\n\t}\n\t//used to store light contribution\n\tstruct FinalLight {\n\t\tvec3 Color;\n\t\tvec3 Ambient;\n\t\tfloat Diffuse; //NdotL\n\t\tfloat Specular; //RdotL\n\t\tvec3 Emission;\n\t\tvec3 Reflection;\n\t\tfloat Attenuation;\n\t\tvec3 Vector; //light vector\n\t\tfloat Shadow; //1.0 means fully lit\n\t};\n\t#endif\n");
v._vs_shaderblock_code='\n\t#pragma shaderblock "testShadow"\n';v._enabled_fs_shaderblock_code='\n\t#pragma snippet "surface"\n\t#pragma snippet "light_structs"\n\t#pragma snippet "spotFalloff"\n\t#pragma shaderblock "firstPass"\n\t#pragma shaderblock "lastPass"\n\t#pragma shaderblock "applyIrradiance"\n\t#pragma shaderblock "attenuation"\n\t#pragma shaderblock "testShadow"\n\t\n\t//Light is separated in two functions, computeLight (how much light receives the object) and applyLight (compute resulting final color)\n\t// FINAL LIGHT EQUATION, takes all the info from FinalLight and computes the final color \n\t\n\t// HERE we fill FinalLight structure with all the info (colors,NdotL,diffuse,specular,etc) \n\tFinalLight computeLight(in SurfaceOutput o, in Input IN, in Light LIGHT )\n\t{\n\t\tFinalLight FINALLIGHT;\n\t\t// INIT\n\t\tFINALLIGHT.Color = LIGHT.Color;\n\t\t\n\t\t// COMPUTE VECTORS\n\t\tvec3 N = o.Normal; //use the final normal (should be the same as IN.worldNormal)\n\t\tvec3 E = (u_camera_eye - v_pos);\n\t\tfloat cam_dist = length(E);\n\t\tE /= cam_dist;\n\t\t\n\t\tvec3 L = (LIGHT.Position - v_pos) / LIGHT.Distance;\n\t\t\n\t\tif( LIGHT.Info.x == 3.0 )\n\t\t\tL = -LIGHT.Front;\n\t\t\n\t\tFINALLIGHT.Vector = L;\n\t\tvec3 R = reflect(E,N);\n\t\t\n\t\t// IRRADIANCE\n\t\t#ifdef BLOCK_FIRSTPASS\n\t\t\tFINALLIGHT.Ambient = LIGHT.Ambient;\n\t\t\tapplyIrradiance( IN, o, FINALLIGHT );\n\t\t#endif\n\t\t// PHONG FORMULA\n\t\tfloat NdotL = 1.0;\n\t\tNdotL = dot(N,L);\n\t\tfloat EdotN = dot(E,N); //clamp(dot(E,N),0.0,1.0);\n\t\tNdotL = NdotL + LIGHT.Offset;\n\t\tNdotL = max( 0.0, NdotL );\n\t\tFINALLIGHT.Diffuse = abs(NdotL);\n\t\tFINALLIGHT.Specular = o.Specular * pow( clamp(dot(R,-L),0.001,1.0), o.Gloss );\n\t\t\n\t\t// ATTENUATION\n\t\tFINALLIGHT.Attenuation = 1.0;\n\t\t\n\t\t#ifdef BLOCK_ATTENUATION\n\t\t\tFINALLIGHT.Attenuation = computeAttenuation( LIGHT );\n\t\t#endif\n\t\tif( LIGHT.Info.x == 2.0 && LIGHT.Info.y == 1.0 )\n\t\t\tFINALLIGHT.Attenuation *= spotFalloff( LIGHT.Front, normalize( LIGHT.Position - v_pos ), LIGHT.ConeInfo.z, LIGHT.ConeInfo.w );\n\t\t\n\t\t// SHADOWS\n\t\tFINALLIGHT.Shadow = 1.0;\n\t\t#ifdef BLOCK_TESTSHADOW\n\t\t\tFINALLIGHT.Shadow = testShadow( LIGHT );\n\t\t#endif\n\t\t\n\t\t// LIGHT MODIFIERS\n\t\t#ifdef LIGHT_MODIFIER\n\t\t#endif\n\t\t// FINAL LIGHT FORMULA ************************* \n\t\treturn FINALLIGHT;\n\t}\n\t//here we apply the FINALLIGHT to the SurfaceOutput\n\tvec3 applyLight( in SurfaceOutput o, in FinalLight FINALLIGHT )\n\t{\n\t\tvec3 total_light = FINALLIGHT.Ambient * o.Ambient + FINALLIGHT.Color * FINALLIGHT.Diffuse * FINALLIGHT.Attenuation * FINALLIGHT.Shadow;\n\t\tvec3 final_color = o.Albedo * total_light;\n\t\t#ifdef BLOCK_FIRSTPASS\n\t\tfinal_color += o.Emission;\n\t\t#endif\n\t\tfinal_color\t+= o.Albedo * (FINALLIGHT.Color * FINALLIGHT.Specular * FINALLIGHT.Attenuation * FINALLIGHT.Shadow);\n\t\treturn max( final_color, vec3(0.0) );\n\t}\n\t\n\t//all done in one single step\n\tvec3 processLight(in SurfaceOutput o, in Input IN, in Light LIGHT)\n\t{\n\t\tFinalLight FINALLIGHT = computeLight( o, IN,LIGHT );\n\t\treturn applyLight(o,FINALLIGHT);\n\t}\n\t\n';
v._disabled_shaderblock_code='\n\t#pragma shaderblock "firstPass"\n\t#pragma shaderblock "lastPass"\n\t#pragma snippet "input"\n\t#pragma snippet "surface"\n\t#pragma snippet "light_structs"\n\t#pragma shaderblock "applyIrradiance"\n\tFinalLight computeLight( in SurfaceOutput o, in Input IN, in Light LIGHT )\n\t{\n\t\tFinalLight FINALLIGHT;\n\t\tFINALLIGHT.Ambient = LIGHT.Ambient;\n\t\tFINALLIGHT.Diffuse = 0.0;\n\t\tFINALLIGHT.Specular = 0.0;\n\t\tFINALLIGHT.Attenuation = 0.0;\n\t\tFINALLIGHT.Shadow = 0.0;\n\t\tapplyIrradiance( IN, o, FINALLIGHT );\n\t\treturn FINALLIGHT;\n\t}\n\tvec3 applyLight( in SurfaceOutput o, in FinalLight FINALLIGHT )\n\t{\n\t\tvec3 final_color = o.Albedo * o.Ambient * FINALLIGHT.Ambient;\n\t\t#ifdef BLOCK_FIRSTPASS\n\t\tfinal_color += o.Emission;\n\t\t#endif\n\t\treturn final_color;\n\t}\n\t\n\t//all done in one single step\n\tvec3 processLight(in SurfaceOutput o, in Input IN, in Light LIGHT)\n\t{\n\t\tFinalLight FINALLIGHT = computeLight( o, IN,LIGHT );\n\t\treturn applyLight(o,FINALLIGHT);\n\t}\n\t\n';
var fc=new d.ShaderBlock("light");fc.addCode(GL.VERTEX_SHADER,v._vs_shaderblock_code,v._vs_shaderblock_code);fc.addCode(GL.FRAGMENT_SHADER,v._enabled_fs_shaderblock_code,v._disabled_shaderblock_code);fc.register();v.shader_block=fc;v._attenuation_enabled_fragment_code="\n\tconst float LINEAR_ATTENUATION = 1.0;\n\tconst float RANGE_ATTENUATION = 2.0;\n\tfloat computeAttenuation( in Light LIGHT )\n\t{\n\t\t//no attenuation\n\t\tif(LIGHT.Attenuation.z == 0.0)\n\t\t\treturn 1.0;\n\t\t//directional light\n\t\tif( LIGHT.Info.x == 3.0 )\n\t\t\treturn 1.0;\n\t\tif( LIGHT.Attenuation.z == LINEAR_ATTENUATION )\n\t\t\treturn 10.0 / LIGHT.Distance;\n\t\tif( LIGHT.Attenuation.z == RANGE_ATTENUATION )\n\t\t{\n\t\t\tif(LIGHT.Distance >= LIGHT.Attenuation.y)\n\t\t\t\treturn 0.0;\n\t\t\tif(LIGHT.Distance >= LIGHT.Attenuation.x)\n\t\t\t\treturn 1.0 - (LIGHT.Distance - LIGHT.Attenuation.x) / (LIGHT.Attenuation.y - LIGHT.Attenuation.x);\n\t\t}\n\t\treturn 1.0;\n\t}\n";
v._attenuation_disabled_fragment_code="";var Hc=v.attenuation_block=new d.ShaderBlock("attenuation");Hc.addCode(GL.FRAGMENT_SHADER,v._attenuation_enabled_fragment_code,v._attenuation_disabled_fragment_code);Hc.register();v._light_texture_fragment_enabled_code="\nuniform sampler2D light_texture;\nvoid applyLightTexture( in Input IN, inout Light LIGHT )\n{\n\tvec2 uv;\n\tif(LIGHT.Info.x == 1.0) //omni\n\t{\n\t\tvec3 V = normalize(IN.worldPos - LIGHT.Position);\n\t\tuv = vec2( 0.5 - (atan(V.z, V.x) / -6.28318531), asin(V.y) / 1.57079633 * 0.5 + 0.5);\n\t}\n\telse\n\t{\n\t\tvec4 v = LIGHT.Matrix * vec4( IN.worldPos,1.0 );\n\t\tuv = v.xy / v.w * 0.5 + vec2(0.5);\n\t}\n\tLIGHT.Color *= texture2D( light_texture, uv ).xyz;\n}\n";
v._light_texture_fragment_disabled_code="\nvoid applyLightTexture( in Input IN, inout Light LIGHT )\n{\n}\n";var Ic=v.light_texture_block=new d.ShaderBlock("light_texture");Ic.addCode(GL.FRAGMENT_SHADER,v._light_texture_fragment_enabled_code,v._light_texture_fragment_disabled_code);Ic.register();var Xb=new d.ShaderBlock("environment_cubemap");Xb.addCode(GL.FRAGMENT_SHADER,"\n\t#ifdef ENVIRONMENT_TEXTURE\n\t\tuniform sampler2D environment_texture;\n\t#endif\n\t#ifdef ENVIRONMENT_PLANAR\n\t\tuniform sampler2D environment_texture;\n\t#endif\n\t#ifdef ENVIRONMENT_CUBEMAP\n\t\tuniform samplerCube environment_texture;\n\t#endif\n\tvec2 polarToCartesian(in vec3 V)\n\t{\n\t\treturn vec2( 0.5 - (atan(V.z, V.x) / -6.28318531), asin(V.y) / 1.57079633 * 0.5 + 0.5);\n\t}\n\t\n\tvec3 getEnvironmentColor( vec3 V, float area )\n\t{\n\t\t#ifdef ENVIRONMENT_TEXTURE\n\t\t\tvec2 uvs = polarToCartesian(V);\n\t\t\treturn texture2D( environment_texture, uvs ).xyz;\n\t\t#endif\n\t\t#ifdef ENVIRONMENT_CUBEMAP\n\t\t\treturn textureCube( environment_texture, -V ).xyz;\n\t\t#endif\n\t\treturn u_background_color.xyz;\n\t}\n",
"\n\tvec3 getEnvironmentColor( vec3 V, float area )\n\t{\n\t\treturn u_background_color.xyz;\n\t}\n",{ENVIRONMENT_CUBEMAP:""});Xb.defineContextMacros({ENVIRONMENTBLOCK:"environment_cubemap"});Xb.register();var Wb=new d.ShaderBlock("environment_2D");Wb.defineContextMacros({ENVIRONMENTBLOCK:"environment_2D"});Wb.addCode(GL.FRAGMENT_SHADER,"\n\t#ifdef ENVIRONMENT_TEXTURE\n\t\tuniform sampler2D environment_texture;\n\t#endif\n\t#ifdef ENVIRONMENT_PLANAR\n\t\tuniform sampler2D environment_texture;\n\t#endif\n\t#ifdef ENVIRONMENT_CUBEMAP\n\t\tuniform samplerCube environment_texture;\n\t#endif\n\tvec2 polarToCartesian(in vec3 V)\n\t{\n\t\treturn vec2( 0.5 - (atan(V.z, V.x) / -6.28318531), asin(V.y) / 1.57079633 * 0.5 + 0.5);\n\t}\n\t\n\tvec3 getEnvironmentColor( vec3 V, float area )\n\t{\n\t\t#ifdef ENVIRONMENT_TEXTURE\n\t\t\tvec2 uvs = polarToCartesian(V);\n\t\t\treturn texture2D( environment_texture, uvs ).xyz;\n\t\t#endif\n\t\t#ifdef ENVIRONMENT_CUBEMAP\n\t\t\treturn textureCube( environment_texture, -V ).xyz;\n\t\t#endif\n\t\treturn u_background_color.xyz;\n\t}\n",
"\n\tvec3 getEnvironmentColor( vec3 V, float area )\n\t{\n\t\treturn u_background_color.xyz;\n\t}\n",{ENVIRONMENT_TEXTURE:""});Wb.register();var Vb=new d.ShaderBlock("environment_planar");Vb.defineContextMacros({ENVIRONMENTBLOCK:"environment_planar"});Vb.addCode(GL.FRAGMENT_SHADER,"\n\t#ifdef ENVIRONMENT_TEXTURE\n\t\tuniform sampler2D environment_texture;\n\t#endif\n\t#ifdef ENVIRONMENT_PLANAR\n\t\tuniform sampler2D environment_texture;\n\t#endif\n\t#ifdef ENVIRONMENT_CUBEMAP\n\t\tuniform samplerCube environment_texture;\n\t#endif\n\tvec2 polarToCartesian(in vec3 V)\n\t{\n\t\treturn vec2( 0.5 - (atan(V.z, V.x) / -6.28318531), asin(V.y) / 1.57079633 * 0.5 + 0.5);\n\t}\n\t\n\tvec3 getEnvironmentColor( vec3 V, float area )\n\t{\n\t\t#ifdef ENVIRONMENT_TEXTURE\n\t\t\tvec2 uvs = polarToCartesian(V);\n\t\t\treturn texture2D( environment_texture, uvs ).xyz;\n\t\t#endif\n\t\t#ifdef ENVIRONMENT_CUBEMAP\n\t\t\treturn textureCube( environment_texture, -V ).xyz;\n\t\t#endif\n\t\treturn u_background_color.xyz;\n\t}\n",
"\n\tvec3 getEnvironmentColor( vec3 V, float area )\n\t{\n\t\treturn u_background_color.xyz;\n\t}\n",{ENVIRONMENT_PLANAR:""});Vb.register();var Jc=new d.ShaderBlock("environment");Jc.addCode(GL.FRAGMENT_SHADER,"\n\t#ifdef ENVIRONMENT_TEXTURE\n\t\tuniform sampler2D environment_texture;\n\t#endif\n\t#ifdef ENVIRONMENT_PLANAR\n\t\tuniform sampler2D environment_texture;\n\t#endif\n\t#ifdef ENVIRONMENT_CUBEMAP\n\t\tuniform samplerCube environment_texture;\n\t#endif\n\tvec2 polarToCartesian(in vec3 V)\n\t{\n\t\treturn vec2( 0.5 - (atan(V.z, V.x) / -6.28318531), asin(V.y) / 1.57079633 * 0.5 + 0.5);\n\t}\n\t\n\tvec3 getEnvironmentColor( vec3 V, float area )\n\t{\n\t\t#ifdef ENVIRONMENT_TEXTURE\n\t\t\tvec2 uvs = polarToCartesian(V);\n\t\t\treturn texture2D( environment_texture, uvs ).xyz;\n\t\t#endif\n\t\t#ifdef ENVIRONMENT_CUBEMAP\n\t\t\treturn textureCube( environment_texture, -V ).xyz;\n\t\t#endif\n\t\treturn u_background_color.xyz;\n\t}\n",
"\n\tvec3 getEnvironmentColor( vec3 V, float area )\n\t{\n\t\treturn u_background_color.xyz;\n\t}\n");Jc.register();var vc=new d.ShaderBlock("applyReflection");M.reflection_block=vc;vc.addCode(GL.FRAGMENT_SHADER,'\n\t#pragma shaderblock ENVIRONMENTBLOCK "environment"\n\t\n\tvec4 applyReflection( Input IN, SurfaceOutput o, vec4 final_color )\n\t{\n\t\tvec3 R = reflect( IN.viewDir, o.Normal );\n\t\tvec3 bg = vec3(0.0);\n\t\t//is last pass for this object?\n\t\t#ifdef BLOCK_LASTPASS\n\t\t\t#ifdef ENVIRONMENT_PLANAR\n\t\t\t\tvec2 screen_uv = gl_FragCoord.xy / u_viewport.zw;\n\t\t\t\tscreen_uv.x = 1.0 - screen_uv.x;\n\t\t\t\tscreen_uv.xy += (u_view * vec4(o.Normal - IN.worldNormal, 0.0)).xy * 0.1;\n\t\t\t\tbg = texture2D( environment_texture, screen_uv ).xyz;\n\t\t\t#else\n\t\t\t\tbg = getEnvironmentColor( R, 0.0 );\n\t\t\t#endif\n\t\t#endif\n\t\tfinal_color.xyz = mix( final_color.xyz, bg, clamp( o.Reflectivity, 0.0, 1.0) );\n\t\treturn final_color;\n\t}\n',
"\n\tvec4 applyReflection( Input IN, SurfaceOutput o, vec4 final_color )\n\t{\n\t\treturn final_color;\n\t}\n");vc.register();Rb="\n\tvoid applyIrradiance( in Input IN, in SurfaceOutput o, inout FinalLight FINALLIGHT )\n\t{\n\t}\n";d.Shaders.getShaderBlock("applyIrradiance")||(Eb=new d.ShaderBlock("applyIrradiance"),M.irradiance_block=Eb,Eb.addCode(GL.FRAGMENT_SHADER,Rb,Rb),Eb.register());q.RENDER_LOADING="render_loading";q.FILEDROP="fileDrop";Object.defineProperty(na.prototype,"file_drop_enabled",
{set:function(a){this.setFileDrop(a)},get:function(){return this._file_drop_enabled},enumerable:!0});na.prototype.loadConfig=function(a,b,c){var e=this;d.Network.requestJSON(a,function(a){e.configure(a,c);b&&b(a)})};na.prototype.configure=function(a,b){this.skip_play_button=void 0!==a.skip_play_button?a.skip_play_button:!1;this.autoplay=void 0!==a.autoplay?a.autoplay:!0;a.debug?this.enableDebug():this.enableDebug(!1);void 0!==a.resources&&d.ResourcesManager.setPath(a.resources);a.proxy&&d.ResourcesManager.setProxy(a.proxy);
if(a.filesystems)for(var c in a.filesystems)d.ResourcesManager.registerFileSystem(c,a.filesystems[c]);a.allow_base_files&&(d.ResourcesManager.allow_base_files=a.allow_base_files);a.autoresize&&!this._resize_callback&&(this._resize_callback=function(){this.canvas.width=this.canvas.parentNode.offsetWidth;this.canvas.height=this.canvas.parentNode.offsetHeight}.bind(this),window.addEventListener("resize",this._resize_callback));a.loadingbar?this.loading||this.enableLoadingBar():!1===a.loadingbar&&(this.loading=
null);this.force_redraw=a.redraw||!1;a.debug_render&&this.setDebugRender(!0);a.scene_url&&this.loadScene(a.scene_url,b)};na.STOPPED=0;na.PLAYING=1;na.PAUSED=2;na.prototype.loadScene=function(a,b,c){var e=this,d=this.scene;this.loading&&(this.loading.visible=!0);d.load(a,null,null,function(a){if(null!=e.loading){var b=0;a.total&&(b=a.loaded/a.total);e.loading.scene_loaded=b;c&&c(b)}},function(){e.autoplay?e.play():e.skip_play_button||e.showPlayDialog();e.loading&&(e.loading.visible=!1);e._ondraw(!0);
setTimeout(function(){e._ondraw(!0)},1E3);if(window.onSceneReady)window.onSceneReady();window.postMessage("ready","*");window.top&&window.top.postMessage("ready","*");b&&b()})};na.prototype.setScene=function(a,b,c){function e(){h.configure(a);h.loadResources(g)}function g(){f.loading.visible=!1;c&&c(h);f.autoplay&&f.play();h._must_redraw=!0;console.log("Scene playing");b&&b(h)}var f=this,h=this.scene;this.state==d.Player.PLAYING&&this.stop();h.clear();a&&a.constructor===String&&(a=JSON.parse(a));
var k=d.Scene.getScriptsList(a);k&&k.length?(h.clear(),h.loadScripts(k,e)):e()};na.prototype.pause=function(){this.state=d.Player.PAUSED};na.prototype.play=function(){this.state!=d.Player.PLAYING&&(this.debug&&console.log("Start"),this.state=d.Player.PLAYING,d.Input&&d.Input.reset(),d.GUI&&d.GUI.reset(),this.scene.start(),window.postMessage("start","*"),window.top&&window.top.postMessage("start","*"))};na.prototype.stop=function(){this.state=d.Player.STOPPED;this.scene.finish();d.GUI&&d.GUI.reset();
window.postMessage("stop","*");window.top&&window.top.postMessage("stop","*")};na.prototype.clear=function(){d.Input&&d.Input.reset();d.GUI&&d.GUI.reset();this.scene.clear()};na.prototype.setFileDrop=function(a){function b(a){a.stopPropagation();a.preventDefault()}function c(a){d.addEventListener("dragexit",this._onDragStop);d.addEventListener("dragover",this._onDragStop);d.addEventListener("drop",this._onDrop);a.stopPropagation();a.preventDefault()}function e(a){a.stopPropagation();a.preventDefault();
d.removeEventListener("dragexit",this._onDragStop);d.removeEventListener("dragover",this._onDragStop);d.removeEventListener("drop",this._onDrop);if(a.dataTransfer.files.length)for(var b=0;b<a.dataTransfer.files.length;++b)!1===this._onfiledrop(a.dataTransfer.files[b],a)&&(a.stopPropagation(),a.stopImmediatePropagation())}if(this._file_drop_enabled!=a){var d=this.canvas;a?(this._file_drop_enabled=a,this._onDrag=c.bind(this),this._onDrop=e.bind(this),this._onDragStop=b.bind(this),d.addEventListener("dragenter",
this._onDrag)):d.removeEventListener("dragenter",this._onDrag)}};na.prototype.enableLoadingBar=function(){this.loading={visible:!0,scene_loaded:0,resources_loaded:0};LEvent.bind(d.ResourcesManager,"start_loading_resources",function(a,b){this.loading&&(this.loading.resources_loaded=0)}.bind(this));LEvent.bind(d.ResourcesManager,"loading_resources_progress",function(a,b){this.loading&&this.loading.resources_loaded<b&&(this.loading.resources_loaded=b)}.bind(this));LEvent.bind(d.ResourcesManager,"end_loading_resources",
function(a,b){this.loading&&(this._total_loading=void 0,this.loading.resources_loaded=1,this.loading.visible=!1)}.bind(this))};na.prototype._onfiledrop=function(a,b){return LEvent.trigger(d.GlobalScene,d.EVENT.FILEDROP,{file:a,event:b})};na.prototype.showPlayDialog=function(){var a=document.createElement("div");a.style.width="128px";a.style.position="absolute";a.style.top=(0.5*this.canvas.offsetHeight-64|0)+"px";a.style.left=(0.5*this.canvas.offsetWidth-64|0)+"px";a.style.cursor="pointer";a.style.borderRadius=
"10px";a.style.backgroundColor="rgba(0,0,0,0.5)";a.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="128" height="128"><circle fill="#3bd0bc" cx="64" cy="64" r="50"/><polygon id="play-button-triangle" name="play-button-triangle" fill="#FFFFFF" points="42,32 100,64, 42,96"/></svg>';this.canvas.parentNode.appendChild(a);var b=this;a.addEventListener("click",function(){console.log("play!");this.parentNode.removeChild(this);b.play()})};na.prototype._ondraw=function(a){var b=this.scene;if(this.state==
d.Player.PLAYING||a){if(this.onPreDraw)this.onPreDraw();if(b._must_redraw||this.force_redraw)this.renderer._in_player=!0,this.renderer.render(b,b.info&&b.info.render_settings?b.info.render_settings:this.render_settings);if(this.onDraw)this.onDraw()}if(this.loading&&this.loading.visible&&(this.renderLoadingBar(this.loading),LEvent.trigger(this.scene,d.EVENT.RENDER_LOADING),this.onDrawLoading))this.onDrawLoading()};na.prototype._onupdate=function(a){if(this.state==d.Player.PLAYING){d.Tween&&d.Tween.update(a);
d.Input&&d.Input.update(a);if(this.onPreUpdate)this.onPreUpdate(a);this.scene.update(a);if(this.onUpdate)this.onUpdate(a)}};na.prototype._onmouse=function(a){if((!d.Input||!0!=d.Input.onMouse(a))&&this.state==d.Player.PLAYING&&(LEvent.trigger(this.scene,a.eventType||a.type,a,!0),this.onMouse))this.onMouse(a)};na.prototype._ontouch=function(a){if(this.state==d.Player.PLAYING){if(!0===LEvent.trigger(this.scene,a.eventType||a.type,a,!0))return!1;if(this.onTouch)this.onTouch(a)}};na.prototype._onkey=
function(a){if(d.Input)d.Input.onKey(a);this.state!=d.Player.PLAYING||this.onKey&&this.onKey(a)||LEvent.trigger(this.scene,a.eventType||a.type,a)};na.prototype._ongamepad=function(a){this.state!=d.Player.PLAYING||this.onGamepad&&this.onGamepad(a)||LEvent.trigger(this.scene,a.eventType||a.type,a)};na.prototype.renderLoadingBar=function(a){a&&ba.enableWebGLCanvas&&(gl.canvas.canvas2DtoWebGL_enabled||enableWebGLCanvas(gl.canvas),gl.start2D(),gl.fillColor=[0,0,0,1],gl.fillRect(0,0,gl.drawingBufferWidth,
8),gl.fillColor=a.bar_color||[0.5,0.9,1,1],gl.fillRect(0,0,gl.drawingBufferWidth*a.scene_loaded,4),gl.fillColor=a.bar_color||[0.9,0.5,1,1],gl.fillRect(0,4,gl.drawingBufferWidth*a.resources_loaded,4),gl.finish2D())};na.prototype.enableDebug=function(a){this.debug=!!a;d.Script.catch_important_exceptions=!a;d.catch_exceptions=!a};na.prototype.setDebugRender=function(a){if(!this.debug_render){if(!a)return;this.debug_render=d.getDebugRender()}a?this.debug_render.enable():this.debug_render.disable()};d.Player=
na;d.Formats.addSupportedFormat("dds",{extension:"dds",type:"image",dataType:"arraybuffer",resource:"Texture",format:"binary",parse:function(a,b){if(!a||a.constructor!==ArrayBuffer)throw"ParserDDS: data must be ArrayBuffer";var c=gl.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc"),e=new GL.Texture(0,0,b);if(!window.DDS)throw"dds.js script must be included, not found";DDS.loadDDSTextureFromMemoryEx(gl,c,a,e,!0);return e}});d.Formats.addSupportedFormat("obj",{extension:"obj",type:"mesh",resource:"Mesh",
format:"text",dataType:"text",flipAxis:!1,parse:function(a,b){function c(a){var b,c,e,d=!1;if(-1==a.indexOf("-")){var g=u.get(a);if(void 0!==g)return g}else d=!0;e||(e=a.split("/"));if(1==e.length)e=c=b=parseInt(e[0]);else if(2==e.length)b=parseInt(e[0]),c=parseInt(e[1]),e=b;else if(3==e.length)b=parseInt(e[0]),c=parseInt(e[1]),e=parseInt(e[2]);else return console.log("Problem parsing: unknown number of values per face"),-1;0>b&&(b=f.length/3+b+1);0>e&&(e=h.length/2+e+1);0>c&&(c=k.length/2+c+1);if(d&&
(a=b+"/"+c+"/"+e,g=u.get(a),void 0!==g))return g;b-=1;c-=1;e-=1;l.push(f[3*b+0],f[3*b+1],f[3*b+2]);k.length&&p.push(k[2*c+0],k[2*c+1]);h.length&&m.push(h[3*e+0],h[3*e+1],h[3*e+2]);g=q;u.set(a,g);++q;return g}function e(a){a={name:a||"",material:"",start:-1,length:-1,indices:[]};n.push(a);return a}function d(a){if(!x.material)return x.material=a+".json",r[a]=x;var b=r[a];b||(b=e(t+"_"+a),b.material=a+".json",r[a]=b);return x=b}for(var f=[],h=[],k=[],l=[],m=[],p=[],n=[],r={},t=null,x=e(),u=new Map,
q=0,s={v:1,vt:2,vn:3,f:4,g:5,o:6,usemtl:7,mtllib:8},v,G,w,z=a.split("\n"),B=z.length,D=0;D<B;++D){var A=z[D],A=A.replace(/[ \t]+/g," ").replace(/\s\s*$/,"");if("\\"==A[A.length-1])var D=D+1,C=z[D].replace(/[ \t]+/g," ").replace(/\s\s*$/,""),A=(A.substr(0,A.length-1)+C).replace(/[ \t]+/g," ").replace(/\s\s*$/,"");if("#"!=A[0]&&""!=A)switch(C=A.split(" "),A=s[C[0]],3>=A&&(v=parseFloat(C[1]),G=parseFloat(C[2]),2!=A&&(w=parseFloat(C[3]))),A){case 1:f.push(v,G,w);break;case 2:k.push(v,G);break;case 3:h.push(v,
G,w);break;case 4:if(4>C.length)continue;for(var y=[],A=1;A<C.length;++A)y.push(c(C[A]));x.indices.push(y[0],y[1],y[2]);for(A=2;A<y.length-1;++A)x.indices.push(y[0],y[A],y[A+1]);break;case 5:case 6:t=A=C[1];x.name?(r={},x=e(A)):x.name=A;break;case 7:d(C[1])}}s=[];v=0;G=[];for(A=0;A<n.length;++A)x=n[A],x.indices&&(x.start=v,x.length=x.indices.length,s=s.concat(x.indices),delete x.indices,v+=x.length,G.push(x));n=G;G={};if(!f.length)return console.error("mesh without vertices"),null;G.vertices=new Float32Array(l);
m.length&&(G.normals=new Float32Array(m));p.length&&(G.coords=new Float32Array(p));s&&0<s.length&&(G.triangles=new (65536<v?Uint32Array:Uint16Array)(s));G.bounding=GL.Mesh.computeBoundingBox(G.vertices);s={};1<n.length&&(s.groups=n);G.info=s;if(!G.bounding)return console.log("empty mesh"),null;(0==G.bounding.radius||isNaN(G.bounding.radius))&&console.log("no radius found in mesh");return G}});d.Formats.addSupportedFormat("mtl",{extension:"mtl",type:"material",resource:"StandardMaterial",format:"text",
dataType:"text",parse:function(a,b){function c(a){return[parseFloat(a[1]),parseFloat(a[2]),parseFloat(a[3])]}for(var e=a.split("\n"),g=e.length,f={},h=null,k=0;k<g;++k){var l=e[k].replace(/[ \t]+/g," ").replace(/\s\s*$/,""),l=l.trim();if("#"!=l[0]&&""!=l){var l=l.split(" "),m=l[0];switch(m){case "newmtl":l=l[1]+".json";h={filename:l,textures:{}};f[l]=h;break;case "Ka":h.ambient=c(l);break;case "Kd":h.color=c(l);break;case "Ks":h.specular_factor=parseFloat(l[1]);break;case "Ke":h.emissive=c(l);break;
case "Ns":h.specular_gloss=parseFloat(l[1]);break;case "Tr":h.reflection=parseFloat(l[1]);break;case "map_Kd":h.textures.color=this.clearPath(l[1]);h.color=[1,1,1];break;case "map_Ka":h.textures.ambient=this.clearPath(l[1]);h.ambient=[1,1,1];break;case "map_Ks":h.textures.specular=this.clearPath(l[1]);h.specular_factor=1;break;case "map_d":h.textures.opacity=this.clearPath(l[1]);h.blend_mode=d.Blend.ALPHA;break;case "bump":case "map_bump":h.textures.bump=this.clearPath(l[1]);break;case "d":h.opacity=
parseFloat(l[1]);break;case "Tr":h.opacity=parseFloat(l[1]);break;case "illum":case "Tf":case "Ni":break;default:console.log("Unknown MTL info: ",m)}}}for(var p in f)e=f[p],e.ambient=[1,1,1],g=new d.StandardMaterial(e),d.RM.registerResource(e.filename,g);return null},clearPath:function(a){var b=a.lastIndexOf("\\");-1!=b&&(a=a.substr(b+1));a=d.RM.getFilename(a);d.RM.resources_renamed_recently[a]&&(a=d.RM.resources_renamed_recently[a]);return a.toLowerCase()}});d.Formats.addSupportedFormat("stl",{extension:"stl",
type:"mesh",format:"binary",dataType:"arraybuffer",parse:function(a,b){var c=[],e=[],g=[],f=new DataView(a,80),h=f.getUint32(0,!0);console.log("number of triangles: "+h);for(var k=4,l=vec3.create(),m=vec3.create(),p=vec3.create(),n=vec3.create(),r=0;r<h;r++){for(var t=f.getFloat32(k,!0),x=f.getFloat32(k+4,!0),u=f.getFloat32(k+8,!0),k=k+12,q=0;3>q;q++){var s=f.getFloat32(k,!0),v=f.getFloat32(k+4,!0),G=f.getFloat32(k+8,!0);c.push(s,G,-v);k+=12}0==t&&0==x&&0==u&&(t=c.length,l.set(c.slice(t-9,t-6)),m.set(c.slice(t-
6,t-3)),p.set(c.slice(t-3,t)),vec3.sub(m,m,l),vec3.sub(p,p,l),vec3.cross(n,p,m),t=n[0],x=n[1],u=n[2]);e.push(t,u,-x,t,u,-x,t,u,-x);k+=2}f={info:{}};f.vertices=new Float32Array(c);0<e.length&&(f.normals=new Float32Array(e));g&&0<g.length&&(f.triangles=new Uint16Array(g));f.bounding=d.Formats.computeMeshBounding(f.vertices);return f}});d.Formats.addSupportedFormat("tga",{extension:"tga",type:"image",dataType:"arraybuffer",format:"binary",skip_conversion:!0,parse:function(a,b){if(!a||a.constructor!==
ArrayBuffer)throw"ParserTGA: data must be ArrayBuffer";a=new Uint8Array(a);for(var c=new Uint8Array([0,0,2,0,0,0,0,0,0,0,0,0]),e=a.subarray(0,12),d=0;d<e.length;d++)if(c[d]!=e[d])return console.error("TGA header is not valid"),null;d=a.subarray(12,18);c={};c.width=256*d[1]+d[0];c.height=256*d[3]+d[2];c.bpp=d[4];c.bytesPerPixel=c.bpp/8;c.imageSize=c.width*c.height*c.bytesPerPixel;c.pixels=a.subarray(18,18+c.imageSize);c.pixels=new Uint8Array(c.pixels);for(var e=c.pixels,d=0,f=c.imageSize,h=c.bytesPerPixel;d<
f;d+=h){var k=e[d];e[d]=e[d+2];e[d+2]=k}c.format=32==c.bpp?"RGBA":"RGB";c.flipY=!0;return c}});(function(a){function b(a,b){var c=new XMLHttpRequest;c.onload=function(){200==this.status&&b&&b(this.response)};-1==a.indexOf("://")&&d.dataPath&&(a=d.dataPath+a);c.open("get",a,!0);c.send()}var c="undefined"==typeof window&&"undefined"==typeof exports,e=2*Math.PI/360;c&&(a.console={log:function(a){var b=Array.prototype.slice.call(arguments,0);self.postMessage({action:"log",params:b})},warn:function(a){var b=
Array.prototype.slice.call(arguments,0);self.postMessage({action:"warn",params:b})},error:function(a){var b=Array.prototype.slice.call(arguments,0);self.postMessage({action:"error",params:b})}},a.alert=console.error);a.Collada={libsPath:"./",workerPath:"./",no_flip:!0,use_transferables:!0,onerror:null,verbose:!1,config:{forceParser:!1},init:function(a){a=a||{};for(var b in a)this[b]=a[b];this.config=a;if(c)try{importScripts(this.libsPath+"gl-matrix-min.js",this.libsPath+"tinyxml.js")}catch(e){d.throwException(d.LIBMISSING_ERROR)}mat4.create();
vec3.create();vec3.create();vec3.create();quat.create();c&&console.log("Collada worker ready")},load:function(a,c){b(a,function(b){b?c(d.parse(b),a):c(null)})},_xmlroot:null,_nodes_by_id:null,_nodes_by_sid:null,_transferables:null,_controllers_found:null,_geometries_found:null,safeString:function(a){return a?this.convertID?this.convertID(a):a.replace(/ /g,"_"):""},LIBMISSING_ERROR:"Libraries loading error, when using workers remember to pass the URL to the tinyxml.js in the options.libsPath",NOXMLPARSER_ERROR:"TinyXML not found, when using workers remember to pass the URL to the tinyxml.js in the options.libsPath (Workers do not allow to access the native XML DOMParser)",
throwException:function(a){if(c)self.postMessage({action:"exception",msg:a});else if(d.onerror)d.onerror(a);throw a;},getFilename:function(a){var b=a.lastIndexOf("\\");-1!=b&&(a=a.substr(b+1));b=a.lastIndexOf("/");-1!=b&&(a=a.substr(b+1));return a},last_name:0,generateName:function(a){a=(a||"name_")+this.last_name;this.last_name++;return a},parse:function(b,c,e){e=e||"_dae_"+Date.now()+".dae";var l=null;c=null;this._transferables=[];this.verbose&&console.log(" - XML parsing...");if(a.DOMParser&&!this.config.forceParser)l=
new DOMParser,c=l.parseFromString(b,"text/xml"),this.verbose&&console.log(" - XML parsed");else{if(!a.DOMImplementation)return d.throwException(d.NOXMLPARSER_ERROR);try{l=new DOMImplementation}catch(m){return d.throwException(d.NOXMLPARSER_ERROR)}c=l.loadXML(b);this.verbose&&console.log(" - XML parsed");b=c._nodes_by_id={};for(var l=0,p=c.all.length;l<p;++l){var n=c.all[l];b[n.id]=n;n.getAttribute("sid")&&(b[n.getAttribute("sid")]=n)}this.extra_functions||(this.extra_functions=!0,DOMDocument.prototype.querySelector=
DOMElement.prototype.querySelector=function(a){a=a.split(" ");for(var b=this;a.length;){var c=a.shift().split("#"),e=c[0],c=c[1],e=e?b.getElementsByTagName(e):b.childNodes;if(c)for(var d=0;d<e.length;d++){if(e.item(d).getAttribute("id")==c){if(0==a.length)return e.item(d);b=e.item(d);break}}else{if(0==a.length)return e.item(0);b=e.item(0)}}return null},DOMDocument.prototype.querySelectorAll=DOMElement.prototype.querySelectorAll=function(a){function b(a,c){if(c){var d=c.shift(),d=a.getElementsByTagName(d);
if(0==c.length)for(var f=0;f<d.length;f++)e.push(d.item(f));else for(f=0;f<d.length;f++)b(d.item(f),c.concat())}}var c=a.split(" ");if(1==c.length)return this.getElementsByTagName(a);var e=[];b(this,c);a=new DOMNodeList(this.documentElement);a._nodes=e;a.length=e.length;return a},Object.defineProperty(DOMElement.prototype,"textContent",{get:function(){return this.getChildNodes().item(0).toString()},set:function(){}}))}this._xmlroot=c;if(b=c.querySelector("COLLADA"))this._current_DAE_version=b.getAttribute("version"),
console.log("DAE Version:"+this._current_DAE_version);l=c.getElementsByTagName("visual_scene").item(0);if(!l)throw"visual_scene XML node not found in DAE";this._nodes_by_id={};this._nodes_by_sid={};this._controllers_found={};this._geometries_found={};b={object_class:"Scene",light:null,materials:{},meshes:{},resources:{},root:{children:[]},external_files:{}};if(n=c.getElementsByTagName("asset")[0])b.metadata=this.readAsset(n);p=l.childNodes;for(l=0;l<p.length;l++){var r=p.item(l);1==r.nodeType&&(n=
null,"node"==r.localName?n=this.readNodeTree(r,b,0,!1):console.warn("DAE contains unknown node type: "+r.localName),n&&b.root.children.push(n))}for(l=0;l<p.length;l++)"node"==p.item(l).localName&&this.readNodeInfo(p.item(l),b,0,!1);this.readLibraryControllers(b);if(l=this.readAnimations(c,b))e="animations_"+e.substr(0,e.indexOf(".")),b.resources[e]=l,b.root.animation=e;b.images=this.readImages(c);this._nodes_by_id={};this._nodes_by_sid={};this._controllers_found={};this._geometries_found={};this._xmlroot=
null;return b},readAsset:function(a){for(var b={},c=0;c<a.childNodes.length;c++){var e=a.childNodes.item(c);if(1==e.nodeType)switch(e.localName){case "contributor":if(e=e.querySelector("authoring_tool"))b.authoring_tool=e.textContext;break;case "unit":b.unit=e.getAttribute("name");break;default:b[e.localName]=e.textContent}}return b},readNodeTree:function(a,b,c,e){var d=this.safeString(a.getAttribute("id")),g=this.safeString(a.getAttribute("sid")),n=this.safeString(a.getAttribute("name")),r=d||g||
n;if(!r)return console.warn("Collada: node without name or id, skipping it"),null;var n={name:n,id:r,sid:g,children:[],_depth:c},t=a.getAttribute("type");t&&(n.type=t);this._nodes_by_id[r]=n;d&&(this._nodes_by_id[d]=n);g&&(this._nodes_by_sid[g]=n,this._nodes_by_id[g]=n);n.model=this.readTransform(a,c,e);for(d=0;d<a.childNodes.length;d++)if(r=a.childNodes.item(d),1==r.nodeType)"node"==r.localName?(g=this.readNodeTree(r,b,c+1,e))&&n.children.push(g):"instance_node"==r.localName&&(g=this._xmlroot.querySelector("library_nodes"))&&
(r=r.getAttribute("url"),r=r.replace(/\./gi,"\\."),(g=g.querySelector(r))?(g=this.readNodeTree(g,b,c+1,e))&&n.children.push(g):console.warn("instanced node not found:"+r));return n},readNodeInfo:function(a,b,c,e,d){var g=this.safeString(a.getAttribute("id")),n=this.safeString(a.getAttribute("sid")),r=this.safeString(a.getAttribute("name"));if(r=g||n||r)d=this._nodes_by_id[r];else if(d)d=this._nodes_by_id[d.id||d.sid||d.name];else return console.warn("Collada: node without name or id, skipping it"),
null;d||(d=this._nodes_by_sid[n]);if(!d)return console.warn("Collada: Node not found by id: "+(g||n)),null;for(g=0;g<a.childNodes.length;g++){var t=a.childNodes.item(g);if(1==t.nodeType)if("node"==t.localName)this.readNodeInfo(t,b,c+1,e,a);else if("instance_node"==t.localName)this.readInstancedNodeInfo(t,b,c+1,e,a);else if("instance_geometry"==t.localName){var n=t.getAttribute("url"),x=n.toString().substr(1);d.mesh?(d.meshes||(d.meshes=[d.mesh]),d.meshes.push(x)):d.mesh=x;if(b.meshes[n])console.warn("DAE node references mesh but not found: "+
n);else if(r=this.readGeometry(n,e))r.name=x,b.meshes[x]=r;if(n=t.querySelectorAll("instance_material"))for(t=0;t<n.length;++t)if(r=n.item(t)){x=r.getAttribute("target").toString().substr(1);if(!b.materials[x]){var u=this.readMaterial(x);u&&(u.id=x,b.materials[u.id]=u)}0==t?d.material=x:(d.materials||(d.materials=[]),d.materials.push(x))}else console.warn("instance_material not found: "+g)}else if("instance_controller"==t.localName)if(n=t.getAttribute("url"),r=n.replace(/\./gi,"\\."),(r=this._xmlroot.querySelector("controller"+
r))||(r=this.searchManuallyById("library_controllers",n.substr(1))),r){r=this.readController(r,e,b);if(t=t.querySelector("bind_material"))for(var q=t.querySelectorAll("technique_common"),s=0;s<q.length;s++)for(var v=q.item(s).querySelectorAll("instance_material"),t=0;t<v.length;t++)(x=v.item(t))?(x=x.getAttribute("target").toString().substr(1),!b.materials[x]&&(u=this.readMaterial(x))&&(u.id=x,b.materials[u.id]=u),0==t?d.material=x:(d.materials||(d.materials=[]),d.materials.push(x))):console.warn("instance_material for controller not found: "+
x);r&&(t=r,"morph"==r.type&&(t=r.mesh,d.morph_targets=r.morph_targets),t.name=n.toString(),d.mesh=n.toString(),b.meshes[n]=t)}else console.warn("DAE, node controller not found: "+n);else"instance_light"==t.localName?(n=t.getAttribute("url"),this.readLight(d,n)):"instance_camera"==t.localName&&(n=t.getAttribute("url"),this.readCamera(d,n))}},readInstancedNodeInfo:function(a,b,c,e,d){d=this._xmlroot.querySelector("library_nodes");if(!d)return!1;a=a.getAttribute("url");a=a.replace(/\./gi,"\\.");d=d.querySelector(a);
if(!d)return console.warn("instanced node not found:"+a),!1;this.readNodeInfo(d,b,c+1,e);return!0},searchManuallyById:function(a,b){var c=this._xmlroot.querySelector(a);if(!c)return null;for(var d=0;d<c.childNodes.length;++d){var e=c.childNodes[d];if(e.id==b)return e}return null},material_translate_table:{},light_translate_table:{point:"omni",directional:"directional",spot:"spot"},camera_translate_table:{xfov:"fov",aspect_ratio:"aspect",znear:"near",zfar:"far"},querySelectorAndId:function(a,b,c){a=
a.querySelectorAll(b);for(b=0;b<a.length;b++){var d=a.item(b).getAttribute("id");if(d&&(d=d.toString(),d==c))return a.item(b)}return null},getFirstChildElement:function(a,b){for(var c=a.childNodes,d=0;d<c.length;++d){var e=c.item(d);if(e.localName&&!b||b&&b==e.localName)return e}return null},readMaterial:function(a){a=this.querySelectorAndId(this._xmlroot,"library_materials material",a);if(!a)return null;a=a.querySelector("instance_effect");if(!a)return null;a=a.getAttribute("url").substr(1);a=this.querySelectorAndId(this._xmlroot,
"library_effects effect",a);if(!a)return null;var b=a.querySelector("technique");if(!b)return null;var c=a.querySelectorAll("newparam");a={};for(var d=0;d<c.length;d++){var e=c[d].querySelector("init_from"),g;if(!e&&(e=c[d].querySelector("source"),!g)){console.warn("no source found for material for newparam");continue}g=e.innerHTML;a[c[d].getAttribute("sid")]={parent:g}}g={};c=this.readImages(this._xmlroot);(e=b.querySelector("phong"))||(e=b.querySelector("blinn"));e||(e=b.querySelector("lambert"));
if(!e)return null;g.type=e.localName;for(d=0;d<e.childNodes.length;++d){var n=e.childNodes.item(d);if(n.localName){b=n.localName.toString();this.material_translate_table[b]&&(b=this.material_translate_table[b]);var r=this.getFirstChildElement(n);if(r)if("color"==r.localName.toString()){r=this.readContentAsFloats(r);if(n=n.getAttribute("opaque"))g.opaque_info=n;g[b]="RGB_ZERO"==n?r.subarray(0,4):r.subarray(0,3)}else"float"==r.localName.toString()?g[b]=this.readContentAsFloats(r)[0]:"texture"==r.localName.toString()&&
(g.textures||(g.textures={}),n=r.getAttribute("texture"))&&(-1===n.indexOf(".")&&(n=this.getParentParam(a,n),c[n]&&(n=c[n].path)),n={map_id:n},r=r.getAttribute("texcoord"),n.uvs=r,g.textures[b]=n)}}g.object_class="Material";return g},getParentParam:function(a,b){return a[b]?a[b].parent?this.getParentParam(a,a[b].parent):b:b},readLight:function(a,b){function c(a,b){for(var e=0;e<b.childNodes.length;e++){var f=b.childNodes.item(e);if(f&&1==f.nodeType)switch(f.localName){case "color":a.color=d.readContentAsFloats(f);
break;case "falloff_angle":a.angle_end=d.readContentAsFloats(f)[0],a.angle=a.angle_end-10}}}var e={},m=null;if(1<b.length)m=this._xmlroot.querySelector("library_lights "+b);else var p=this._xmlroot.querySelector("library_lights"),m=this.getFirstChildElement(p,"light");if(!m)return null;var p=[],n=m.querySelector("technique_common");if(n)for(var r=0;r<n.childNodes.length;r++)1==n.childNodes.item(r).nodeType&&p.push(n.childNodes.item(r));m=m.querySelectorAll("technique");for(r=0;r<m.length;r++)for(var n=
m.item(r),t=0;t<n.childNodes.length;t++)1==n.childNodes.item(t).nodeType&&p.push(n.childNodes.item(t));for(r=0;r<p.length;r++)switch(n=p[r],n.localName){case "point":e.type=this.light_translate_table[n.localName];c(e,n);break;case "directional":e.type=this.light_translate_table[n.localName];c(e,n);break;case "spot":e.type=this.light_translate_table[n.localName];c(e,n);break;case "intensity":e.intensity=this.readContentAsFloats(n)[0]}a.model?(e.position=[a.model[12],a.model[13],a.model[14]],p=[-a.model[8],
-a.model[9],-a.model[10]],e.target=[e.position[0]+p[0],e.position[1]+p[1],e.position[2]+p[2]]):(console.warn("Could not read light position for light: "+a.name+". Setting defaults."),e.position=[0,0,0],e.target=[0,-1,0]);a.light=e},readCamera:function(a,b){var c={},e=this._xmlroot.querySelector("library_cameras "+b);if(!e)return null;var m=[],p=e.querySelector("technique_common");if(p)for(e=0;e<p.childNodes.length;e++)1==p.childNodes.item(e).nodeType&&m.push(p.childNodes.item(e));for(e=0;e<m.length;e++)for(var p=
c,n=m[e],r=0;r<n.childNodes.length;r++){var t=n.childNodes.item(r);t&&1==t.nodeType&&(p[d.camera_translate_table[t.localName]||t.localName]=parseFloat(t.textContent))}c.yfov&&!c.fov&&(c.aspect?c.fov=c.yfov*c.aspect:console.warn("Could not convert camera yfov to xfov because aspect ratio not set"));a.camera=c},readTransform:function(a,b,c){for(var d=mat4.create(),g=mat4.create(),p=quat.create(),n=0;n<a.childNodes.length;n++){var r=a.childNodes.item(n);if(r&&1==r.nodeType){if("matrix"==r.localName){d=
this.readContentAsFloats(r);this.transformMatrix(d,0==b);break}if("translate"==r.localName){var t=this.readContentAsFloats(r);c&&0<b&&(r=t[1],t[1]=t[2],t[2]=-r);mat4.translate(d,d,t)}else"rotate"==r.localName?(t=this.readContentAsFloats(r),4==t.length&&("jointOrientX"==r.getAttribute("sid")&&(t[3]+=90),c&&(r=t[1],t[1]=t[2],t[2]=-r),0!=t[3]&&(quat.setAxisAngle(p,t.subarray(0,3),t[3]*e),mat4.fromQuat(g,p),mat4.multiply(d,d,g)))):"scale"==r.localName&&(t=this.readContentAsFloats(r),c&&(r=t[1],t[1]=t[2],
t[2]=-r),mat4.scale(d,d,t))}}return d},readTransform2:function(a,b,c){for(var d=mat4.create(),g=quat.create(),p=mat4.create(),n=quat.create(),r=vec3.create(),t=vec3.fromValues(1,1,1),x=0;x<a.childNodes.length;x++){var u=a.childNodes.item(x);if("matrix"==u.localName)return d=this.readContentAsFloats(u),this.transformMatrix(d,0==b),d;if("translate"==u.localName){var q=this.readContentAsFloats(u);r.set(q)}else"rotate"==u.localName?(q=this.readContentAsFloats(u),4==q.length&&("jointOrientX"==u.getAttribute("sid")&&
(q[3]+=90),c&&(u=q[1],q[1]=q[2],q[2]=-u),0!=q[3]&&(quat.setAxisAngle(n,q.subarray(0,3),q[3]*e),quat.multiply(g,g,n)))):"scale"==u.localName&&(q=this.readContentAsFloats(u),c&&(u=q[1],q[1]=q[2],q[2]=-u),t.set(q))}c&&0<b&&(u=r[1],r[1]=r[2],r[2]=-u);mat4.translate(d,d,r);mat4.fromQuat(p,g);mat4.multiply(d,d,p);mat4.scale(d,d,t);return d},readGeometry:function(a,b,e){if(void 0!==this._geometries_found[a])return this._geometries_found[a];var d=this._xmlroot.getElementById(a.substr(1));if(!d)return console.warn("readGeometry: geometry not found: "+
a),this._geometries_found[a]=null;if("controller"==d.localName)return d=this.readController(d,b,e),this._geometries_found[a]=d;if("geometry"!=d.localName)return console.warn("readGeometry: tag should be geometry, instead it was found: "+d.localName),this._geometries_found[a]=null;e=d.querySelector("mesh");if(!e)return console.warn("readGeometry: mesh not found in geometry: "+a),this._geometries_found[a]=null;for(var g=d.sources={},p=e.querySelectorAll("source"),d=0;d<p.length;d++){var n=p.item(d);
if(n.querySelector){var r=n.querySelector("float_array");if(r){var r=this.readContentAsFloats(r),t=n.querySelector("accessor"),x=parseInt(t.getAttribute("stride")),t=t.querySelector("param");g[n.getAttribute("id")]={stride:x,data:r,params:t.length}}}}p=e.querySelector("vertices input");p=g[p.getAttribute("source").substr(1)];g[e.querySelector("vertices").getAttribute("id")]=p;p=null;(n=e.querySelector("polygons"))&&(p=this.readPolygons(n,g));p||(n=e.querySelectorAll("triangles"))&&n.length&&(p=this.readTriangles(n,
g));p||(n=e.querySelectorAll("polylist"))&&n.length&&(p=this.readPolylistArray(n,g));p||(e=e.querySelector("linestrips"))&&(p=this.readLineStrip(g,e));if(!p)return console.log("no polygons or triangles in mesh: "+a),this._geometries_found[a]=null;if(b&&!this.no_flip){b=0;e=p.vertices;d=0;for(g=e.length;d<g;d+=3)b=e[d+1],e[d+1]=e[d+2],e[d+2]=-b;e=p.normals;d=0;for(g=e.length;d<g;d+=3)b=e[d+1],e[d+1]=e[d+2],e[d+2]=-b}if(c&&this.use_transferables)for(d in p)(b=p[d])&&b.buffer&&100<b.length&&this._transferables.push(b.buffer);
p.filename=a;p.object_class="Mesh";return this._geometries_found[a]=p},readPolygons:function(a,b){for(var c=[],d=0,e={},g=[],n=[],r=a.getAttribute("material"),t=[],x=[],u=0;u<a.childNodes.length;u++){var q=a.childNodes.item(u);if("input"==q.localName){var s=this.readInput(q,b);s&&t.push(s)}else"p"==q.localName?x.push(q):q.localName&&console.warn("unknown xml tag in <polygons>: "+q.localName)}for(var q=1,v=t.length,u=0;u<v;++u)q=Math.max(q,t[u][4]+1);for(u=0;u<x.length;u++){var w=x[u];if(!w||!w.textContent)break;
for(var w=w.textContent.trim().split(" "),z=-1,B=s=-1,A=0,D=w.length;A<D;A+=q){var C=w.slice(A,A+q).join(" "),B=s;if(e.hasOwnProperty(C))s=e[C];else{for(var y=0;y<v;++y){var s=t[y],E=s[1],H=s[3],F=parseInt(w[A+s[4]]);0==y&&(g[E.length/s[2]]=F);for(var F=F*s[2],I=0;I<s[2];++I)E.push(H[F+I])}s=d;d+=1;e[C]=s}0==A&&(z=s);2<A/q&&(n.push(z),n.push(B));n.push(s)}}c.push({name:"group",start:0,length:n.length-0,material:r||""});if(!t.length)return console.warn("collada: <polygon> without buffers"),null;c=
{vertices:new Float32Array(t[0][1]),info:{groups:c},_remap:new Uint32Array(g)};this.transformMeshInfo(c,t,n);return c},readTriangles:function(a,b){for(var c=[],d=[],e=0,g={},n=[],r=[],t=0,x="",q=0;q<a.length;q++){var s=a.item(q),x=s.getAttribute("material");parseFloat(s.getAttribute("count"));0==q&&(d=this.readShapeInputs(s,b));for(var s=s.querySelectorAll("p"),v=1,w=d.length,z=0;z<w;++z)v=Math.max(v,d[z][4]+1);for(z=0;z<s.length;z++){var A=s.item(z);if(!A||!A.textContent)break;for(var A=A.textContent.trim().split(" "),
B=-1,D=0,C=A.length;D<C;D+=v){var y=A.slice(D,D+v).join(" ");if(g.hasOwnProperty(y))B=g[y];else{for(B=0;B<w;++B){var E=d[B],F=E[1],H=E[3],I=parseInt(A[D+E[4]]);0==B&&(n[F.length/E[2]]=I);for(var I=I*E[2],J=0;J<E[2];++J)F.push(H[I+J])}B=e;e+=1;g[y]=B}r.push(B)}}x={name:"group"+q,start:t,length:r.length-t,material:x||""};t=r.length;c.push(x)}if(!d.length)return null;c={vertices:new Float32Array(d[0][1]),info:{groups:c},_remap:new Uint32Array(n)};this.transformMeshInfo(c,d,r);return c},readPolylistArray:function(a,
b){for(var c=[],d=0;d<a.length;++d){var e=this.readPolylist(a[d],b);e&&c.push(e)}return 2>c.length?c[0]:e=this.mergeMeshes(c)},readPolylist:function(a,b){for(var c=[],d=0,e={},g=[],n=[],r="",r=a.getAttribute("material")||"",c=this.readShapeInputs(a,b),t=a.querySelector("vcount"),t=this.readContentAsUInt32(t),x=a.querySelector("p"),x=this.readContentAsUInt32(x),q=0,s=1,v=c.length,w=0;w<v;++w)s=Math.max(s,c[w][4]+1);for(var w=0,z=t.length;w<z;++w){var B=t[w],A=-1,D=-1,C=-1;if(q>=x.length){console.warn("DAE has wrong number of polygons in polylist");
break}for(var y=0;y<B;++y){var E=x.slice(q,q+s).join(" "),C=D;if(e.hasOwnProperty(E))D=e[E];else{for(D=0;D<v;++D){var F=c[D],H=F[1],I=F[3],J=parseInt(x[q+F[4]]);0==D&&(g[H.length/F[2]]=J);for(var J=J*F[2],K=0;K<F[2];++K)H.push(I[J+K])}D=d;d+=1;e[E]=D}3<B&&(0==y&&(A=D),2<y&&(n.push(A),n.push(C)));n.push(D);q+=s}}d={vertices:new Float32Array(c[0][1]),info:{material:r},_remap:new Uint32Array(g)};this.transformMeshInfo(d,c,n);return d},readShapeInputs:function(a,b){for(var c=[],d=a.querySelectorAll("input"),
e=0;e<d.length;e++){var g=d.item(e);g.getAttribute&&((g=this.readInput(g,b))?c.push(g):console.warn("no buffer in collada"))}return c},readInput:function(a,b){if(!a.getAttribute)return null;var c=a.getAttribute("source").substr(1),d=null;if(-1!=c.indexOf("/")){var e=c.split("/"),g=this._xmlroot.getElementById(e[0]);g&&g.sources&&(d=g.sources[e[1]])}else d=b[c];if(!d)return console.warn("<input> source not found: "+c),null;c=a.getAttribute("semantic").toUpperCase();e=parseInt(a.getAttribute("offset"));
g=0;a.getAttribute("set")&&(g=parseInt(a.getAttribute("set")));return[c,[],d.stride,d.data,e,g]},transformMeshInfo:function(a,b,c){for(var d={normal:"normals",texcoord:"coords"},e=1;e<b.length;++e){var g=b[e][0].toLowerCase(),n=b[e][1];n.length&&(d[g]&&(g=d[g]),a[g]&&(g+=b[e][5]),a[g]=new Float32Array(n))}c&&c.length&&(a.triangles=65536<a.vertices.length?new Uint32Array(c):new Uint16Array(c));return a},readLineStrip:function(a,b){for(var c=[],d=0,e={},g=[],n=b.querySelectorAll("input"),r=0;r<n.length;r++){var t=
n.item(r);if(t.getAttribute){var q=t.getAttribute("semantic").toUpperCase(),u=a[t.getAttribute("source").substr(1)],s=parseInt(t.getAttribute("offset")),v=0;t.getAttribute("set")&&(v=parseInt(t.getAttribute("set")));c.push([q,[],u.stride,u.data,s,v])}}n=b.querySelectorAll("p");t=c.length;for(r=0;r<n.length;r++){q=n.item(r);if(!q||!q.textContent)break;for(var q=q.textContent.trim().split(" "),w=-1,u=0,s=q.length;u<s;u+=t){v=q.slice(u,u+t).join(" ");if(e.hasOwnProperty(v))w=e[v];else{for(w=0;w<c.length;++w)for(var z=
c[w],B=parseInt(q[u+w]),A=z[1],D=z[3],B=B*z[2],y=0;y<z[2];++y)A.push(D[B+y]);w=d;d+=1;e[v]=w}g.push(w)}}d={primitive:"line_strip",vertices:new Float32Array(c[0][1]),info:{}};return this.transformMeshInfo(d,c,g)},findXMLNodeById:function(a,b,c){if(this._xmlroot._nodes_by_id){var d=this._xmlroot._nodes_by_id[c];if(d&&d.localName==b)return d}else if(d=this._xmlroot.getElementById(c))return d;a=a.childNodes;for(d=0;d<a.length;++d){var e=a.item(d);if(1==e.nodeType&&e.localName==b&&e.getAttribute("id")==
c)return e}return null},readImages:function(a){var b=a.querySelector("library_images");if(!b)return null;a={};for(var b=b.childNodes,c=0;c<b.length;++c){var d=b.item(c);if(1==d.nodeType){var e=d.querySelector("init_from");if(e&&e.textContent){var g=this.getFilename(e.textContent),n=d.getAttribute("id");a[n]={filename:g,map:n,name:d.getAttribute("name"),path:e.textContent}}}}return a},readAnimations:function(a,b){var c=a.querySelector("library_animations");if(!c)return null;for(var d=c.childNodes,
c={object_class:"Animation",takes:{}},e={tracks:[]},g=e.tracks,n=0;n<d.length;++n){var r=d.item(n);if(1==r.nodeType&&"animation"==r.localName)if(r.getAttribute("id"))this.readAnimation(r,g);else{var t=r.querySelectorAll("animation");if(t.length)for(r=0;r<t.length;++r){var q=t.item(r);this.readAnimation(q,g)}else this.readAnimation(r,g)}}if(!g.length)return null;for(n=d=0;n<g.length;++n)d<g[n].duration&&(d=g[n].duration);e.name="default";e.duration=d;c.takes[e.name]=e;return c},readAnimation:function(a,
b){if("animation"!=a.localName)return null;a.getAttribute("id");var c=a.querySelectorAll("channel");if(!c.length)return null;for(var d=b||[],e=0;e<c.length;++e){var g=this.readChannel(c.item(e),a);g&&d.push(g)}return d},readChannel:function(a,b){if("channel"!=a.localName||"animation"!=b.localName)return null;var d=a.getAttribute("source"),e=a.getAttribute("target"),g=this.findXMLNodeById(b,"sampler",d.substr(1));if(!g)return console.error("Error DAE: Sampler not found in "+d),null;for(var d={},p=
{},n={},r=g.querySelectorAll("input"),g=null,t=0;t<r.length;t++){var q=r.item(t),u=q.getAttribute("source"),s=q.getAttribute("semantic"),v=this.findXMLNodeById(b,"source",u.substr(1));if(v){var w=v.querySelector("param");if(w){q=w.getAttribute("type");d[s]={source:u,type:q};var z=null;if("float"==q||"float4x4"==q)z=v.querySelector("float_array"),z=this.readContentAsFloats(z),n[u]=z,u=w.getAttribute("name"),"TIME"==u&&(g=z),"OUTPUT"==s&&(u=s),u?p[u]=q:console.warn("Collada: <param> without name attribute in <animation>")}}}if(!g)return console.error("Error DAE: no TIME info found in <channel>: "+
a.getAttribute("source")),null;t=e.split("/");e={};q=this.safeString(t[0]);r=this._nodes_by_id[q];if(!r)return console.warn("Node target '"+q+"' not found reading animation channel"),null;q=r.id+"/"+t[1];e.name=t[1];e.property=q;q="number";u=1;p=p.OUTPUT;switch(p){case "float":u=1;break;case "float3x3":u=9;q="mat3";break;case "float4x4":u=16,q="mat4"}e.type=q;e.value_size=u;e.duration=g[g.length-1];d=n[d.OUTPUT.source];if(!d)return null;n=u+1;q=new Float32Array(g.length*n);for(t=0;t<g.length;++t)q[t*
n]=g[t],s=d.subarray(t*u,(t+1)*u),"float4x4"==p&&this.transformMatrix(s,r?0==r._depth:0),q.set(s,t*n+1);c&&this.use_transferables&&q&&q.buffer&&100<q.length&&this._transferables.push(q.buffer);e.data=q;return e},findNode:function(a,b){if(a.id==b)return a;if(a.children)for(var c in a.children){var d=this.findNode(a.children[c],b);if(d)return d}return null},readLibraryControllers:function(a){var b=this._xmlroot.querySelector("library_controllers");if(!b)return null;for(var b=b.childNodes,c=0;c<b.length;++c){var d=
b.item(c);if(1==d.nodeType&&"controller"==d.localName){var e=d.getAttribute("id");this._controllers_found[e]||this.readController(d,null,a)}}},readController:function(a,b,c){if("controller"==!a.localName)return console.warn("readController: not a controller: "+a.localName),null;var d=a.getAttribute("id");if(this._controllers_found[d])return this._controllers_found[d];var e=null,g=a.querySelector("skin");g&&(e=this.readSkinController(g,b,c));(a=a.querySelector("morph"))&&(e=this.readMorphController(a,
b,c,e));return this._controllers_found[d]=e},readSkinController:function(a,b,c){var d=a.getAttribute("source");c=this.readGeometry(d,b,c);if(!c)return null;var e=this.readSources(a,b);if(!e)return null;b=null;(b=a.querySelector("bind_shape_matrix"))?(b=this.readContentAsFloats(b),this.transformMatrix(b,!0,!0)):b=mat4.create();var d=[],g=a.querySelector("joints");if(g){for(var n=null,r=null,q=g.querySelectorAll("input"),g=0;g<q.length;g++){var x=q[g],u=x.getAttribute("semantic").toUpperCase(),x=x.getAttribute("source"),
x=e[x.substr(1)];"JOINT"==u?n=x:"INV_BIND_MATRIX"==u&&(r=x)}if(!r||!n)return console.error("Error DAE: no joints or inv_bind sources found"),null;for(g=0;g<n.length;++g)q=r.subarray(16*g,16*g+16),u=n[g],(x=this._nodes_by_id[u])?(this.transformMatrix(q,0==x._depth,!0),d.push([u,q])):console.warn("Node "+u+" not found")}var x=0,s=[];if(a=a.querySelector("vertex_weights")){for(var v=null,q=a.querySelectorAll("input"),g=0;g<q.length;g++)"WEIGHT"==q[g].getAttribute("semantic").toUpperCase()&&(v=e[q.item(g).getAttribute("source").substr(1)]);
if(!v)throw"no weights found";var g=a.querySelector("vcount"),w=this.readContentAsUInt32(g),g=a.querySelector("v"),z=this.readContentAsUInt32(g);a=c.vertices.length/3;var e=new Float32Array(4*a),n=new Uint8Array(4*a),B=0,r=c._remap;if(!r)throw"no remap info found in mesh";for(var g=q=0,A=w.length;g<A;++g){var D=w[g],u=B;s.length=D;for(var y=0;y<D;++y)s[y]=[v[z[u+2*y+1]],z[u+2*y]];s.sort(this._bones_sort_func);4<s.length&&(s.length=4,x+=1);for(var C=n.subarray(4*g,4*g+4),u=e.subarray(4*g,4*g+4),E=
0,y=0;y<s.length;++y)C[y]=s[y][1],C[y]>q&&(q=C[y]),u[y]=s[y][0],E+=u[y];if(1>E)for(C=1/E,y=0;4>y;++y)u[y]*=C;B+=2*D}x&&console.warn("This mesh has "+x+" vertices with more than 4 bones, skipping extra bones. This could cause errors in the skinning.");x=new Float32Array(4*a);s=new Uint8Array(4*a);v=[];for(g=0;g<a;++g){y=4*r[g];u=e.subarray(y,y+4);C=n.subarray(y,y+4);for(w=0;3>w;++w){z=w;B=u[w];for(y=w+1;4>y;++y)u[y]<=B||(z=y,B=u[y]);z!=w&&(y=u[w],u[w]=u[z],u[z]=y,y=C[w],C[w]=C[z],C[z]=y)}x.set(u,4*
g);s.set(C,4*g);u[0]&&(v[C[0]]=!0);u[1]&&(v[C[1]]=!0);u[2]&&(v[C[2]]=!0);u[3]&&(v[C[3]]=!0)}q>=d.length&&console.warn("Mesh uses higher bone index than bones found");a=[];e={};for(g=0;g<v.length;++g)v[g]&&(e[g]=a.length,a.push(d[g]));if(a.length<d.length){for(g=0;g<s.length;g++)s[g]=e[s[g]];d=a}for(g=0;g<d.length;++g)a=d[g],(e=this._nodes_by_id[a[0]]||this._nodes_by_sid[a[0]])?a[0]=e.id||e.name:console.warn("Bone not found");c.weights=x;c.bone_indices=s;c.bones=d;c.bind_matrix=b}return c},_bones_sort_func:function(a,
b){return b[0]-a[0]},readMorphController:function(a,b,c,d){d=a.getAttribute("source");d=this.readGeometry(d,b,c);if(!d)return null;var e=this.readSources(a,b),g=[];a=a.querySelector("targets");if(!a)return null;for(var n=a.querySelectorAll("input"),r=a=null,q=0;q<n.length;q++){var s=n.item(q),u=s.getAttribute("semantic").toUpperCase(),s=e[s.getAttribute("source").substr(1)];"MORPH_TARGET"==u?a=s:"MORPH_WEIGHT"==u&&(r=s)}if(!a||!r)return console.warn("Morph controller without targets or weights. Skipping it."),
null;for(q in a)e="#"+a[q],n=this.readGeometry(e,b,c),c.meshes[e]=n,g.push({mesh:e,weight:r[q]});d.morph_targets=g;return d},readBindMaterials:function(a,b){for(var c=[],d=a.querySelectorAll("technique_common"),e=0;e<d.length;e++)for(var g=d.item(e).querySelectorAll("instance_material"),n=0;n<g.length;n++){var r=g.item(n);r&&c.push(r.getAttribute("symbol"))}return c},readSources:function(a,b){for(var c={},d=a.querySelectorAll("source"),e=0;e<d.length;e++){var g=d.item(e);if(g.querySelector)if(g.querySelector("float_array")){var n=
this.readContentAsFloats(g);c[g.getAttribute("id")]=n}else(n=g.querySelector("Name_array"))?(n=this.readContentAsStringsArray(n))&&(c[g.getAttribute("id")]=n):(n=g.querySelector("IDREF_array"))&&(n=this.readContentAsStringsArray(n))&&(c[g.getAttribute("id")]=n)}return c},readContentAsUInt32:function(a){if(!a)return null;a=a.textContent;a=a.replace(/\n/gi," ");a=a.replace(/\s\s+/gi," ");a=a.trim();if(0==a.length)return null;a=a.split(" ");for(var b=new Uint32Array(a.length),c=0;c<a.length;c++)b[c]=
parseInt(a[c]);return b},readContentAsFloats:function(a){if(!a)return null;var b=a.textContent,b=b.replace(/\n/gi," "),b=b.replace(/\s\s+/gi," "),b=b.replace(/\t/gi,""),b=b.trim(),b=b.split(" ");a.getAttribute("count");a=new Float32Array(b.length);for(var c=0;c<b.length;c++)a[c]=parseFloat(b[c]);return a},readContentAsStringsArray:function(a){if(!a)return null;for(var b=a.textContent,b=b.replace(/\n/gi," "),b=b.replace(/\s\s/gi," "),b=b.trim(),b=b.split(" "),c=0;c<b.length;c++)b[c]=b[c].trim();if(a.getAttribute("count")&&
parseInt(a.getAttribute("count"))!=b.length){var c=[],d="",e;for(e in b)d=d?d+(" "+b[e]):b[e],this._nodes_by_id[this.safeString(d)]&&(c.push(this.safeString(d)),d="");a=parseInt(a.getAttribute("count"));if(c.length==a)return c;console.error("Error: bone names have spaces, avoid using spaces in names");return null}return b},max3d_matrix_0:new Float32Array([0,-1,0,0,0,0,-1,0,1,0,0,-0,0,0,0,1]),transformMatrix:function(a,b,c){mat4.transpose(a,a);if(this.no_flip)return a;b?(b=new Float32Array(a.subarray(4,
8)),a.set(a.subarray(8,12),4),a.set(b,8),b=a.subarray(8,12),vec4.scale(b,b,-1)):(b=mat4.create(),b.set([a[0],a[2],-a[1]],0),b.set([a[8],a[10],-a[9]],4),b.set([-a[4],-a[6],a[5]],8),b.set([a[12],a[14],-a[13]],12),a.set(b));return a},mergeMeshes:function(a,b){b=b||{};for(var c={},d={},e={},g=[],n=0,r=[],q={triangles:!0,wireframe:!0},s=null,u=0,v=0;v<a.length;++v){var w=a[v],z=n;g.push(z);var B=w.vertices.length/3,n=n+B,y;for(y in w){var A=w[y];"info"!=y&&"_remap"!=y&&(q[y]?d[y]=d[y]?d[y]+A.length:A.length:
c[y]=c[y]?c[y]+A.length:A.length)}r.push({name:"mesh_"+(w.info.material||v),start:z,length:B,material:w.info.material||""})}for(y in c)v=b[y],null===v?delete c[y]:(v||(v=Float32Array),c[y]=new v(c[y]),e[y]=0);for(y in d)d[y]=new Uint32Array(d[y]),e[y]=0;for(v=0;v<a.length;++v){w=a[v];A=w.vertices;if(!A)return console.error("mesh without vertices");B=A.length/3;for(y in w)if(A=w[y],"info"!=y){if("_remap"==y){if(u)for(var n=A,z=u,D=0+A.length,C=0;C<D;++C)n[C]+=z;s?(n=new Uint32Array(s.length+A.length),
n.set(s),n.set(A,s.length),s=n):(s=new Uint32Array(A.length),s.set(A));u+=B}if(q[y]){d[y].set(A,e[y]);n=d[y];C=e[y];z=g[v];for(D=C+A.length;C<D;++C)n[C]+=z;e[y]+=A.length}else c[y]&&(c[y].set(A,e[y]),e[y]+=A.length)}}e={info:{groups:r}};for(v in c)e[v]=c[v];for(v in d)e[v]=d[v];s&&(e._remap=s);return e}};var d=a.Collada;c?(d.loadInWorker=function(a,b){d.load(b,a)},d.parseInWorker=function(a,b){a(d.parse(b))}):(d.launchWorker=function(){var a=this.worker=new Worker(d.workerPath+"collada.js");a.callback_ids=
{};a.addEventListener("error",function(a){if(d.onerror)d.onerror(err)});a.addEventListener("message",function(a){if(a.data)switch(a=a.data,a.action){case "log":console.log.apply(console,a.params);break;case "warn":console.warn.apply(console,a.params);break;case "exception":console.error.apply(console,a.params);if(d.onerror)d.onerror(a.msg);break;case "error":console.error.apply(console,a.params);break;case "result":var b=this.callback_ids[a.callback_id];if(!b)throw"callback not found";b(a.result);
break;default:console.warn("Unknown action:",a.action)}});this.callback_ids={};this.last_callback_id=1;this.toWorker("init",[this.config])},d.toWorker=function(a,b,c){this.worker||this.launchWorker();var d=this.last_callback_id++;this.worker.callback_ids[d]=c;this.worker.postMessage({func:a,params:b,callback_id:d})},d.loadInWorker=function(a,b){this.toWorker("loadInWorker",[a],b)},d.parseInWorker=function(a,b){this.toWorker("parseInWorker",[a],b)});c&&self.addEventListener("message",function(a){if("init"==
a.data.func)return d.init.apply(d,a.data.params);var b=a.data.func,c=a.data.params,e=a.data.callback_id;a=function(a){self.postMessage({action:"result",callback_id:e,result:a},d._transferables);d._transferables=null};var m=d[b];if(void 0===m)console.error("function not found:",b),a(null);else try{m.apply(d,c?[a].concat(c):[a])}catch(p){console.error("Error inside worker function call to "+b+" :: "+p),a(null)}},!1)})("undefined"!=typeof window?window:"undefined"!=typeof exports?exports:self);d.Formats.addSupportedFormat("dae",
{extension:"dae",type:"scene",resource:"SceneNode",format:"text",dataType:"text",convert_filenames_to_lowercase:!0,parse:function(a,b,c){function e(a){"root"==a.id&&(console.warn("DAE contains a node named root, renamed to _root"),a.id="_root",g.root=a.id);a.id&&!b.skip_renaming&&(a.uid="@"+f+"::"+a.id,g[a.id]=a.uid);a.type&&(a.node_type=a.type,delete a.type);if(a.material){var c=a.material.replace(/[^a-z0-9\.\-]/gi,"_")+".json";g[a.material]=c;a.material=c}if(a.materials)for(var d in a.materials)c=
a.materials[d].replace(/[^a-z0-9\.\-]/gi,"_")+".json",g[a.material]=c,a.materials[d]=c;if(a.meshes)for(d=0;d<a.meshes.length;d++)a.meshes[d]&&g[a.meshes[d]]&&(a.meshes[d]=g[a.meshes[d]]);a.mesh&&g[a.mesh]&&(a.mesh=g[a.mesh]);if(a.children)for(d in a.children)e(a.children[d])}if(!a||a.constructor!==String)return console.error("DAE parser requires string"),null;Collada.material_translate_table={reflectivity:"reflection_factor",specular:"specular_factor",shininess:"specular_gloss",emission:"emissive",
diffuse:"color"};c=d.RM.getFilename(c);a=Collada.parse(a,b,c);console.log(a);a.root.name=c;a.metadata&&"Z_UP"==a.metadata.up_axis&&(a.root.model=mat4.rotateX(mat4.create(),mat4.create(),-90*0.0174532925));var g={},f=c.substr(0,c.indexOf("."));c={};for(var h in a.meshes){var k=f+"__"+h+".wbin",k=k.replace(/[^a-z0-9\.\-]/gi,"_");g[h]=k;c[k]=a.meshes[h]}a.meshes=c;for(h in a.meshes)c=a.meshes[h],this.processMesh(c,g);e(a.root);for(h in a.meshes)if(c=a.meshes[h],c.bones)for(var l in c.bones)(k=g[c.bones[l][0]])&&
(c.bones[l][0]=k);a.root.animation&&(a.root.animation=this.renameResource(a.root.animation,a.root.animation+".wbin",a.resources));l={};for(h in a.materials)c=a.materials[h],this.processMaterial(c),l[c.id]=c;a.materials=l;for(h in a.resources)l=a.resources[h],d.ResourcesManager.getBasename(h)||console.warn("DAE contains resources without extension: "+h,l.constructor),"Animation"==l.object_class&&this.processAnimation(l,g);return a},renameResource:function(a,b,c){var d=c[a];if(!d)return c[b]||console.warn("Resource not found: "+
a),b;delete c[a];c[b]=d;return d.filename=b},processMesh:function(a,b){if(a.vertices){var c=a.vertices.length/3,d=a.coords?a.coords.length/2:0;if(d&&d!=c){var g=a.coords,f=new Float32Array(2*c);if(d>c)for(d=0;d<c;++d)f[2*d]=g[3*d],f[2*d+1]=g[3*d+1];a.coords=f}if(a.morph_targets)for(c=0;c<a.morph_targets.length;++c)g=a.morph_targets[c],g.mesh&&b[g.mesh]&&(g.mesh=b[g.mesh])}},processAnimation:function(a,b){for(var c in a.takes){for(var d=a.takes[c],g=0;g<d.tracks.length;++g){var f=d.tracks[g],h=f.property.indexOf("/");
if(h){var k=f.property.substr(0,h),l=f.property.substr(h);"/transform"==l&&(l="/matrix");b[k]&&(k=b[k],f.property=k+l)}}l={};for(g=0;g<d.tracks.length;++g)if(f=d.tracks[g],f.packed_data=!0,"rotateX.ANGLE"==f.name||"rotateY.ANGLE"==f.name||"rotateZ.ANGLE"==f.name)k=f.property.split("/")[0],l[k]||(l[k]={tracks:[]}),l[k].tracks.push(f);for(g in l){for(var k=l[g],h={data:[],type:"quat",value_size:4,property:g+"/Transform/rotation",name:"rotation"},m=[],p=0;p<k.tracks.length;++p)for(var f=k.tracks[p],
f=f.data,n=0;n<f.length;n+=2)m.push(f[n]);m.sort();f=-1;n=[];for(p=0;p<m.length;++p)m[p]!=f&&(n.push(m[p]),f=m[p]);m=n;h.data.length=m.length;for(p=0;p<h.data.length;++p){var r=m[p],q=quat.create();h.data[p]=[r,q];for(n=0;n<k.tracks.length;++n){var f=k.tracks[n],s;a:{s=f.data;for(var u=s.length,v=0;v<u;v+=2){if(s[v]==r){s=s[v+1];break a}if(s[v]>r){s=null;break a}}s=null}if(s)switch(s*=0.0174532925,f.name){case "rotateX.ANGLE":quat.rotateX(q,q,-s);break;case "rotateY.ANGLE":quat.rotateY(q,q,s);break;
case "rotateZ.ANGLE":quat.rotateZ(q,q,s)}}}d.tracks.push(h);for(n=0;n<k.tracks.length;++n)f=k.tracks[n],h=d.tracks.indexOf(f),-1!=h&&d.tracks.splice(h,1)}}},processMaterial:function(a){var b={specular_factor:"specular",transparent:"opacity"};a.object_class="StandardMaterial";a.id&&(a.id=a.id.replace(/[^a-z0-9\.\-]/gi,"_")+".json");void 0!==a.transparency&&(a.opacity=1);a.specular_factor&&a.specular_factor.length&&(a.specular_factor=a.specular_factor[0]);if(a.textures){var c={},e;for(e in a.textures){var g=
a.textures[e],f=e;b[f]&&(f=b[f]);var h=g.map_id;this.convert_filenames_to_lowercase&&(h=h.toLowerCase());var k=d.Material.COORDS_UV0;"TEX1"==g.uvs&&(k=d.Material.COORDS_UV1);g={texture:h,uvs:k};c[f]=g}a.textures=c}}});d.Formats.addSupportedFormat("bvh",{extension:"bvh",type:"scene",resource:"Scene",format:"text",dataType:"text",parse:function(a,b,c){var e=0,g=b=null,f=null,h=[],k=[],l=-1,m=-1,p=-1,n=0,r=[],q={Xposition:"x",Yposition:"y",Zposition:"z",Xrotation:"xrotation",Yrotation:"yrotation",Zrotation:"zrotation"},
s=!1;a=a.split("\n");for(var u=a.length,v=0;v<u;++v){var w=a[v].trim();if("#"!=w[0]&&""!=w)if(w=w.split(/[\s]+/),g=w[0],!e)switch(g){case "HIERARCHY":e=1}else if(1==e)switch(g){case "ROOT":f=w[1];f=f.replace(/[^a-z0-9\.\-]/gi,"_");b=f={name:f,node_type:"JOINT"};break;case "JOINT":g=f;h.push(g);f=w[1];f=f.replace(/[^a-z0-9\.\-]/gi,"_");f={name:f,node_type:"JOINT"};g.children||(g.children=[]);g.children.push(f);break;case "End":g=f;h.push(g);f={name:g.name+"_end",node_type:"JOINT"};g.children||(g.children=
[]);g.children.push(f);break;case "}":s?s=!1:(f=h.pop())||(f=b);break;case "CHANNELS":for(g=2;g<w.length;++g){var y=w[g].toLowerCase();q[y]&&(y=q[y]);var z={node:f,property:y,data:[]};k.push(z);f._channels||(f._channels={});f._channels_order||(f._channels_order=[]);f._channels[y]=z;f._channels_order.push(y)}break;case "OFFSET":g=f;w=w.slice(1).map(parseFloat);g.transform={position:w};break;case "MOTION":e=2}else if(2==e)"Frames:"==w[0]?l=parseInt(w[1]):"Frame"==w[0]&&"Time:"==w[1]&&(m=parseFloat(w[2])),
-1!=l&&-1!=m&&(p=l*m,e=3);else if(3==e){r.push(n*m);for(g=0;g<k.length;++g)k[g].data.push(parseFloat(w[g]));++n}}e=[];this.processMotion(b,e,r);r={root:b,object_class:"SceneNode",resources:{}};for(h=0;h<e.length;++h)e[h].duration=p;c={name:d.ResourcesManager.getBasename(c)+"_animation.wbin",object_class:"Animation",takes:{"default":{name:"default",duration:p,tracks:e}}};b.animation=c.name;r.resources[c.name]=c;console.log(r);return r},processMotion:function(a,b,c){var d=a._channels;if(d){var g=null,
f=null,h=vec3.fromValues(1,0,0),k=vec3.fromValues(0,1,0),l=vec3.fromValues(0,0,1);if(d.xposition||d.yposition||d.zposition)g={name:a.name+"/Transform/position",property:a.name+"/Transform/position",type:"vec3",value_size:3,data:[],packed_data:!0};if(d.xrotation||d.yrotation||d.zrotation)f={name:a.name+"/Transform/rotation",property:a.name+"/Transform/rotation",type:"quat",value_size:4,data:[],packed_data:!0};for(var m=0;m<c.length;++m){for(var p=c[m],n=vec3.create(),r=quat.create(),q=quat.create(),
s=0;s<a._channels_order.length;++s)switch(a._channels_order[s]){case "xposition":n[0]=d.xposition.data[m]+a.transform.position[0];break;case "yposition":n[1]=d.yposition.data[m]+a.transform.position[1];break;case "zposition":n[2]=d.zposition.data[m]+a.transform.position[2];break;case "xrotation":quat.setAxisAngle(q,h,d.xrotation.data[m]*DEG2RAD);quat.mul(r,r,q);break;case "yrotation":quat.setAxisAngle(q,k,d.yrotation.data[m]*DEG2RAD);quat.mul(r,r,q);break;case "zrotation":quat.setAxisAngle(q,l,d.zrotation.data[m]*
DEG2RAD),quat.mul(r,r,q)}g&&g.data.push(p,n[0],n[1],n[2]);f&&f.data.push(p,r[0],r[1],r[2],r[3])}g&&b.push(g);f&&b.push(f)}if(a.children)for(s=0;s<a.children.length;++s)this.processMotion(a.children[s],b,c)}});d.Formats.addSupportedFormat("ase",{extension:"ase",type:"mesh",resource:"Mesh",format:"text",dataType:"text",parse:function(a,b,c){b=b||{};var e=[],g=[];c=[];var f=null,h=[],k=[],l=null,l=null,m=0,p=-1,n=null,q=[],s=this.flipAxis;null!=b.flipAxis&&(s=b.flipAxis);b=s||b.flipNormals;a=a.split("\n");
for(var v=0;v<a.length;++v)if(l=a[v].replace(/[ \t]+/g," ").replace(/\s\s*$/,"")," "==l[0]&&(l=l.substr(1,l.length)),""!=l)if(l=l.split(" "),"*MESH"==l[0]){if(m+=1,h=[],1<m)break}else if("*NODE_NAME"==l[0])l[1].substr(1,l[1].length-2);else if("*MESH_VERTEX"==l[0])s?h.push([-1*parseFloat(l[2]),parseFloat(l[4]),parseFloat(l[3])]):h.push([parseFloat(l[2]),parseFloat(l[3]),parseFloat(l[4])]);else if("*MESH_FACE"==l[0]){var u=parseInt(l[17]);p!=u&&(p=u,null!=n&&(n.length=e.length/3-n.start,0<n.length&&
q.push(n)),n={name:"mat_"+u,start:e.length/3,length:-1,material:""});u=h[parseInt(l[3])];e.push(u[0],u[1],u[2]);u=h[parseInt(l[5])];e.push(u[0],u[1],u[2]);u=h[parseInt(l[7])];e.push(u[0],u[1],u[2])}else"*MESH_TVERTLIST"==l[0]?k=[]:"*MESH_TVERT"==l[0]?k.push([parseFloat(l[2]),parseFloat(l[3])]):"*MESH_TFACELIST"==l[0]?(f&&f.length&&c.push(f),f=[]):"*MESH_TFACE"==l[0]?(u=k[parseInt(l[2])],f.push(u[0],u[1]),u=k[parseInt(l[3])],f.push(u[0],u[1]),u=k[parseInt(l[4])],f.push(u[0],u[1])):"*MESH_MAPPINGCHANNEL"==
l[0]?(f&&c.push(f),f=[]):"*MESH_VERTEXNORMAL"==l[0]&&(b?g.push(-1*parseFloat(l[2]),parseFloat(l[4]),parseFloat(l[3])):g.push(parseFloat(l[2]),parseFloat(l[3]),parseFloat(l[4])));f&&c.push(f);f=e.length/3-n.start;n&&1<f&&(n.length=f,q.push(n));n={info:{}};n.vertices=new Float32Array(e);0<g.length&&(n.normals=new Float32Array(g));for(e=0;e<c.length;++e)g="",0<e&&(g=e+1),n["coords"+g]=new Float32Array(c[e]);n.bounding=d.Formats.computeMeshBounding(n.vertices);1<q.length&&(n.info.groups=q);return n}});
d.Formats.addSupportedFormat("jsmesh",{extension:"jsmesh",type:"mesh",format:"text",dataType:"string",parse:function(a,b){var c=null;"object"==typeof a?c=a:"string"==typeof a&&(c=JSON.parse(a));c.vertices.constructor==Array&&(c.vertices="number"==typeof c.vertices[0]?c.vertices:linearizeArray(c.vertices),c.normals&&(c.normals="number"==typeof c.normals[0]?c.normals:linearizeArray(c.normals)),c.coords&&(c.coords="number"==typeof c.coords[0]?c.coords:linearizeArray(c.coords)),c.triangles&&(c.triangles=
"number"==typeof c.triangles[0]?c.triangles:linearizeArray(c.triangles)),c.vertices=new Float32Array(c.vertices),c.normals&&(c.normals=new Float32Array(c.normals)),c.coords&&(c.coords=new Float32Array(c.coords)),c.triangles&&(c.triangles=new Uint16Array(c.triangles)));c.bounding||(c.bounding=d.Formats.computeMeshBounding(c.vertices));return c}});var Ia={extension:"gltf",type:"scene",resource:"SceneNode",format:"text",dataType:"text",convert_filenames_to_lowercase:!0,BYTE:5120,UNSIGNED_BYTE:5121,SHORT:5122,
UNSIGNED_SHORT:5123,UNSIGNED_INT:5125,FLOAT:5126,JSON_CHUNK:1313821514,BINARY_CHUNK:5130562,buffer_names:{POSITION:"vertices",NORMAL:"normals",COLOR_0:"colors",TEXCOORD_0:"coords",TEXCOORD_1:"coords1",WEIGHTS_0:"weights",JOINTS_0:"bones"},numComponents:{SCALAR:1,NUMBER:1,VEC2:2,VEC3:3,VEC4:4,QUAT:4,MAT3:9,TRANS10:10,MAT4:16},rename_animation_properties:{translation:"position",scale:"scaling"},flip_uv:!0,overwrite_materials:!0,rename_assets:!1,prefabs:{},texture_options:{format:GL.RGBA,magFilter:GL.LINEAR,
minFilter:GL.LINEAR_MIPMAP_LINEAR,wrap:GL.REPEAT},parse:function(a,b,c){function e(a){for(var b=new ArrayBuffer(2*a.length),c=new Uint8Array(b),d=0,e=a.length;d<e;d++)c[d]=a.charCodeAt(d);return b}if(!a||a.constructor!==String)return console.error("DAE parser requires string"),null;d.RM.getFilename(c);b={};if("glb"==d.ResourcesManager.getExtension(c)){if(b=Ia.parseGLB(e(a)),!b)return}else{b=JSON.parse(a);for(var g=0;g<b.buffers.length;++g){var f=b.buffers[g];a=null;"data:"==f.uri.substr(0,5)?f.data=
yc(f.uri.substr(37)):(a=d.RM.getResource(f.uri),f.data=a.data);f.dataview=new Uint8Array(f.data)}}b.filename=c;return Ia.parseGLTF(b)},renameResource:function(a,b,c){var d=c[a];if(!d)return c[b]||console.warn("Resource not found: "+a),b;delete c[a];c[b]=d;return d.filename=b},parseGLB:function(a){var b=new Uint8Array(a),c=new DataView(a);c.getUint32(0,!0);var d=c.getUint32(4,!0);console.log("GLTF Version: "+d);c.getUint32(8,!0);for(var d=12,g=null,f=0;d<b.length;){var h=c.getUint32(d,!0),k=c.getUint32(d+
4,!0),l=a.slice(d+8,d+8+h),d=d+(8+h);if(k==Ia.JSON_CHUNK){if(!("TextDecoder"in window))throw"Sorry, this browser does not support TextDecoder...";g=(new TextDecoder("utf-8")).decode(l);g=JSON.parse(g)}else k==Ia.BINARY_CHUNK?(h=g.buffers[f],h.data=l,h.dataview=new Uint8Array(l),a.byteLength!=h.byteLength&&console.warn("gltf binary doesnt match json size hint"),f++):console.warn("gltf unknown chunk type: ","0x"+k.toString(16))}return g},parseGLTF:function(a,b){console.log(a);a.url||(a.url=b||"scene.glb");
var c=d.RM.getFilename(a.filename),e={object_class:"Scene",light:null,materials:{},meshes:{},resources:{},root:{children:[]},external_files:{}},g={};1<a.scenes.length&&console.warn("gltf importer only supports one scene per file, skipping the rest");var f=a.scenes[a.scene].nodes;this.gltf_materials={};this.gltf_meshes={};if(a.skins)for(var h=0;h<a.skins.length;++h)for(var k=a.skins[h],l=0;l<k.joints.length;++l){var m=a.nodes[k.joints[l]];a.nodes[k.joints[l]]._is_joint=!0}a.metadata&&"Z_UP"==a.metadata.up_axis&&
(e.root.model=mat4.rotateX(mat4.create(),mat4.create(),-90*0.0174532925));for(h in a.meshes)if(a.meshes[h].extras&&a.meshes[h].extras.targetNames){var m=a.meshes[h].extras.targetNames,k=a.meshes[h].weights,l=a.meshes[h].primitives,p=[],n;for(n in m){var q="#"+a.meshes[h].name+"__"+m[n];p.push({mesh:a.meshes.length,weight:k[n]});a.meshes.push({name:q,primitives:[{indices:l[0].indices,attributes:l[0].targets[n]}]})}a.meshes[h].morph_targets=p}n={};c=c.substr(0,c.indexOf("."));m={};for(h in a.meshes)k=
c+"__"+a.meshes[h].name+".wbin",k=k.replace(/[^a-z0-9\.\-]/gi,"_"),n[h]=k,m[k]=a.meshes[h];a.meshes=m;e.root.animation&&(e.root.animation=this.renameResource(e.root.animation,e.root.animation+".wbin",e.resources));for(h in e.resources)c=e.resources[h],d.ResourcesManager.getBasename(h)||console.warn("DAE contains resources without extension: "+h,c.constructor),"Animation"==c.object_class&&this.processAnimation(c,n);for(h=0;h<f.length;++h)m=c=f[h],null!=c.node&&(m=c.node),m=Ia.parseNode({},m,a,n),1<
f.length&&e.root.children.push(m),m.id=a.url.replace(/\//gi,"_")+"::node_"+h,g[m.id]=g[h]=m;if(a.animations&&a.animations.length)if(d.Animation)for(h=0;h<a.animations.length;++h){if(f=this.parseAnimation(h,a,g))f.uid=f.id=a.filename.substr(0,a.filename.indexOf("."))+"::"+f.name,c="animations_"+a.filename.substr(0,a.filename.indexOf(".")),e.resources[c]=f,e.root.animation=c,d.RM.registerResource(c,f)}else console.error("you must include rendeer-animation.js to allow animations");e.materials=this.gltf_materials;
e.meshes=this.gltf_meshes;console.log(e);return e},parseNode:function(a,b,c,e,g){var f=c.nodes[b];if(void 0==f.skin){var h=new d.Transform;f.translation&&h.setPosition(f.translation);a.rotation&&h.setRotation(f.rotation);f.scale&&h.setScale(f.scale[0],f.scale[1],f.scale[2])}a=a||new d.SceneNode;for(var k in f){var l=f[k];switch(k){case "name":a.name=l;break;case "translation":a.position=l;break;case "rotation":a.rotation=l;break;case "scale":a.scaling=l;h=0;0>a.scaling[0]&&h++;0>a.scaling[1]&&h++;
0>a.scaling[2]&&h++;1==h%2&&(a.flags.frontFace=GL.CW);break;case "matrix":a.fromMatrix(l);0>mat4.determinant(l)&&(a.flags.frontFace=GL.CW);break;case "mesh":if(null!=e||void 0!=e)l=e[l];void 0!=f.skin&&(c.meshes[l].skin=f.skin);if(void 0!=g||null!=g)c.meshes[l].bind_matrix=g;if(h=Ia.parseMesh(l,c)){a.mesh=h.name;a.primitives=[];for(var m=0;m<h.info.groups.length;++m){var l=h.info.groups[m],p=null;null!=l.material&&(p=this.parseMaterial(l.material,c));a.primitives.push({index:m,material:p?p.name:null,
mode:l.mode});p&&(a.material=p.name,this.gltf_materials[p.name]=p)}this.gltf_meshes[h.name]=h;if(h.morph_targets)for(m=0;m<h.morph_targets.length;++m){l=h.morph_targets[m].mesh;if(null!=e||void 0!=e)l=e[l];l=Ia.parseMesh(l,c,h.name);this.gltf_meshes[l.name]=l;h.morph_targets[m].mesh=l.name}}break;case "skin":a.skin=this.parseSkin(l,c);break;case "children":if(l.length)for(a.children=[],m=0;m<l.length;++m)h=Ia.parseNode({},l[m],c,e,f.bind_matrix),a.children.push(h);break;case "extras":break;case "_is_joint":a.node_type=
"JOINT";break;case "camera":h=c.cameras[l];a.camera={};h.perspective?(a.camera.type=d.Camera.PERSPECTIVE,a.camera.fov=h.perspective.yfov,a.camera.far=h.perspective.zfar,a.camera.near=h.perspective.znear):a.camera.type=d.Camera.ORTHOGRAPHIC;break;default:"_"!=k[0]&&console.log("gltf node info ignored:",k,f[k])}}f.name||(f.name=a.name="node_"+b);f._is_joint&&(a.is_joint=!0);return a},parseMesh:function(a,b,c){c=b.meshes[a];for(var e=gl.meshes,g=[],f=[],h=0,k=0;k<c.primitives.length;++k){var l=this.parsePrimitive(c,
k,b);if(l){l.start=h;h+=l.length;f.push(l);var m={vertexBuffers:{},indexBuffers:{}},p;for(p in l.buffers)"indices"==p||"triangles"==p?m.indexBuffers[p]={data:l.buffers[p]}:"bones"==p?m.vertexBuffers.bone_indices={data:l.buffers[p]}:m.vertexBuffers[p]={data:l.buffers[p]};g.push({mesh:m})}}p=null;1<g.length?p=GL.Mesh.mergeMeshes(g):1==g.length&&(k=g[0].mesh,p=new GL.Mesh(k.vertexBuffers,k.indexBuffers),p.info&&k.info&&(p.info=k.info));if(!p)return null;for(k=0;k<c.primitives.length;++k)(g=p.info.groups[k])||
(p.info.groups[k]=g={}),l=c.primitives[k],g.material=l.material,g.mode=null!=l.mode?l.mode:4,g.start=f[k].start,g.length=f[k].length;p.name=c.name;if(p.name||this.rename_assets)p.name=b.filename.substr(0,b.filename.indexOf("."))+"::mesh_"+(c.name||a);p.updateBoundingBox();p.computeGroupsBoundingBoxes();c.morph_targets&&(p.morph_targets=c.morph_targets);p.object_class="Mesh";void 0!=c.skin&&(a=c.bones,c.bones||(a=this.parseSkin(c.skin,b).bones),p.bones=a,p.search_bones_in_parent=!0);c.bind_matrix&&
(p.bind_matrix=c.bind_matrix);e[p.name]=p;return d.RM.meshes[p.name]=p},parsePrimitive:function(a,b,c){var d={buffers:{}},g=d.buffers;a=a.primitives[b];if(a.extensions)if(a.extensions.KHR_draco_mesh_compression){if("undefined"==typeof DracoDecoderModule)throw"mesh data is compressed using Draco, draco_decoder.js not installed.";g=d.buffers=this.decompressDraco(a,c)}else throw"mesh data is compressed, this importer does not support it yet";else{null==!a.attributes.POSITION&&console.warn("gltf mesh without positions");
for(var f in this.buffer_names){b=this.buffer_names[f];var h="coords"==b||"coords1"==b,k=a.attributes[f];null!=k&&(h=this.parseAccessor(k,c,h))&&(g[b]=h)}null!=a.indices&&(g.triangles=this.parseAccessor(a.indices,c))}if(!g.vertices)return console.error("primitive without vertices"),null;d.mode=a.mode;d.material=a.material;d.start=0;d.length=g.triangles?g.triangles.length:g.vertices.length/3;return d},installDracoModule:function(a){var b=this.draco_data_types={},c=this;this.decoderModule?a&&a(this.decoderModule):
"undefined"!=typeof DracoDecoderModule?DracoDecoderModule({}).then(function(d){var g=c.decoderModule=d;b[g.DT_INT8]=Int8Array;b[g.DT_UINT8]=Uint8Array;b[g.DT_INT16]=Int16Array;b[g.DT_UINT16]=Uint16Array;b[g.DT_INT32]=Int32Array;b[g.DT_UINT32]=Uint32Array;b[g.DT_FLOAT32]=Float32Array;a&&a(d)}):console.error("Draco3D not installed")},decompressDraco:function(a,b){this.draco_decoder||(this.draco_decoder=new this.decoderModule.Decoder);return this.decodePrimitive(this.draco_decoder,a,b)},decodePrimitive:function(a,
b,c){console.log(b);var d={};b=c.buffers[c.bufferViews[b.extensions.KHR_draco_mesh_compression.bufferView].buffer];var g=b.dataview.buffer;c=this.decoderModule;b=new c.DecoderBuffer;b.Init(new Int8Array(g),g.byteLength);if(a.GetEncodedGeometryType(b)==c.TRIANGULAR_MESH){var f=new c.Mesh,g=a.DecodeBufferToMesh(b,f);if(!g.ok()||0===f.ptr)throw Error("GLTF Draco: Decoding failed: "+g.error_msg());f.num_points();for(var h in this.buffer_names){var g=this.buffer_names[h],k=h;"COLOR_0"==k?k="COLOR":"TEXCOORD_0"==
k&&(k="TEX_COORD");if(k=this.decodeBuffer(f,c[k],"coords"==g||"coords1"==g,a))d[g]=k.data}h=3*f.num_faces();g=4*h;k=c._malloc(g);a.GetTrianglesUInt32Array(f,g,k);d.triangles=(new Uint32Array(c.HEAPF32.buffer,k,h)).slice();c._free(k)}c.destroy(b);c.destroy(f);return d},decodeBuffer:function(a,b,c,d){if(null==b)return null;var g=this.decoderModule;b=d.GetAttributeId(a,b);if(-1==b)return null;var f=d.GetAttribute(a,b);b=f.data_type();var h=f.num_components(),k=a.num_points();f.size();var l=k*h,m=this.draco_data_types[b],
g=new g.DracoFloat32Array;d.GetAttributeFloatForAllPoints(a,f,g);a=new m(l);for(d=0;d<a.length;++d)a[d]=g.GetValue(d);if(c)for(d=1;d<a.length;d+=h)a[d]=1-a[d];return{num_points:k,num_comps:h,data_type:b,data:a}},parseAccessor:function(a,b,c,d,g){var f=b.accessors[a];if(!f)return console.warn("gltf accessor not found"),null;a=this.numComponents[f.type];if(!a)return console.warn("gltf accessor of unknown type:",f.type),null;g=null;g=f.count*a;switch(f.componentType){case Ia.FLOAT:g=new Float32Array(g);
break;case Ia.UNSIGNED_INT:g=new Uint32Array(g);break;case Ia.SHORT:g=new Int16Array(g);break;case Ia.UNSIGNED_SHORT:g=new Uint16Array(g);break;case Ia.BYTE:g=new Int8Array(g);break;case Ia.UNSIGNED_BYTE:g=new Uint8Array(g);break;default:console.warn("gltf accessor of unsupported type: ",f.componentType),g=new Float32Array(g)}null==d&&(d=b.bufferViews[f.bufferView]);if(!d)return console.warn("gltf bufferView not found"),null;var h=b.buffers[d.buffer];if(!h||!h.data)return console.warn("gltf buffer not found or data not loaded"),
null;if(d.byteStride&&d.byteStride!=a*g.BYTES_PER_ELEMENT)return console.warn("gltf buffer data is not tightly packed, not supported"),null;b=new Uint8Array(g.buffer);null==d.byteOffset&&(d.byteOffset=0);d=d.byteOffset+(f.byteOffset||0);d=h.dataview.subarray(d,d+b.length);b.set(d);if(c)for(c=1;c<g.length;c+=a)g[c]=1-g[c];return g},parseMaterial:function(a,b){var c=b.materials[a];if(!c)return console.warn("gltf material not found"),null;var e=c.name,e=!e||this.rename_assets?b.filename.substr(0,b.filename.indexOf("."))+
"::mat_"+(c.name||a):b.filename.substr(0,b.filename.indexOf("."))+"_"+e.replace(/[^a-z0-9\.\-]/gi,"_")+".json",g=d.RM.getMaterial(e);if(g&&(!this.overwrite_materials||g.from_filename==b.filename.substr(0,b.filename.indexOf("."))))return g;g=new d.StandardMaterial;g.name=e;g.from_filename=b.filename.substr(0,b.filename.indexOf("."));null!=c.alphaMode&&(g.alphaMode=c.alphaMode);g.alphaCutoff=null!=c.alphaCutoff?c.alphaCutoff:0.5;null!=c.doubleSided&&(g.flags.two_sided=c.doubleSided);g.normalmapFactor=
1;c.pbrMetallicRoughness&&(g.model="pbrMetallicRoughness",g.color.set([1,1,1]),g.opacity=1,g.metallicFactor=1,g.roughnessFactor=1,null!=c.pbrMetallicRoughness.baseColorFactor&&(g.color=c.pbrMetallicRoughness.baseColorFactor),c.pbrMetallicRoughness.baseColorTexture&&(g.textures.color=this.parseTexture(c.pbrMetallicRoughness.baseColorTexture,b),"MASK"==g.alphaMode&&gl.extensions.EXT_texture_filter_anisotropic&&(e=gl.textures[g.textures.color.texture]))&&(e.bind(0),gl.texParameteri(gl.TEXTURE_2D,gl.extensions.EXT_texture_filter_anisotropic.TEXTURE_MAX_ANISOTROPY_EXT,
8)),null!=c.pbrMetallicRoughness.metallicFactor&&(g.metallicFactor=c.pbrMetallicRoughness.metallicFactor),null!=c.pbrMetallicRoughness.roughnessFactor&&(g.roughnessFactor=c.pbrMetallicRoughness.roughnessFactor),c.pbrMetallicRoughness.metallicRoughnessTexture&&(g.textures.metallicRoughness=this.parseTexture(c.pbrMetallicRoughness.metallicRoughnessTexture,b)));c.occlusionTexture&&(g.textures.occlusion=this.parseTexture(c.occlusionTexture,b));c.normalTexture&&(g.textures.normal=this.parseTexture(c.normalTexture,
b));c.emissiveTexture&&(g.textures.emissive=this.parseTexture(c.emissiveTexture,b));c.emissiveFactor&&(g.emissive=c.emissiveFactor);d.RM.materials[g.name]=g;return this.gltf_materials[g.name]=g},parseTexture:function(a,b){var c=b.textures[a.index];if(!c)return console.warn("gltf texture not found"),null;var d=b.images[c.source],g="",f=null;d.uri?(f=d.uri,f.split(".").pop()):(f=d.name?d.name:b.url.replace(/[\/\.\:]/gi,"_")+"_image_"+a.index,g=d.mimeType?d.mimeType.split("/").pop():"png",f+="."+g);
var h={};if(!gl.textures[f])if(d.uri){var k=d.uri;if("data:"==k.substr(0,5)){var l=d.uri.indexOf(","),m=d.uri.substr(5,l),g=m.split("/").pop().toLowerCase(),f=b.folder+"/"+k+"image_"+a.index+"."+g,g=yc(d.uri.substr(l+1)),d=URL.createObjectURL(new Blob([g],{type:m})),d=GL.Texture.fromURL(d,this.texture_options);d.name=f;gl.textures[f]=d}else"blob:"==k.substr(0,5)?h.texture=k:h.texture=b.folder+"/"+k}else null!=d.bufferView&&(m=b.bufferViews[d.bufferView],null==m.byteOffset&&(m.byteOffset=0),g=b.buffers[m.buffer].data.slice(m.byteOffset,
m.byteOffset+m.byteLength),d=URL.createObjectURL(new Blob([g],{type:d.mimeType})),d=GL.Texture.fromURL(d,this.texture_options),d.name=f,gl.textures[f]=d);h.texture||(h.texture=f);null!=c.sampler&&(c=b.samplers[c.sampler],null!=c.magFilter&&(h.magFilter=c.magFilter),null!=c.minFilter&&(h.minFilter=c.minFilter));a.texCoord&&(h.uv_channel=a.texCoord);return h},parseSkin:function(a,b){var c=b.skins[a],d={},g=[];null!=c.skeleton&&(d.skeleton_root=b.nodes[c.skeleton].name);d.bindMatrices=this.splitBuffer(this.parseAccessor(c.inverseBindMatrices,
b),16);d.joints=[];for(var f=0;f<c.joints.length;++f){var h=b.nodes[c.joints[f]];d.joints.push(h.name);g.push([h.name,d.bindMatrices[f]])}d.bones=g;return d},splitBuffer:function(a,b){for(var c=a.length,d=[],g=0;g<c;g+=b)d.push(new a.constructor(a.subarray(g,g+b)));return d},parseAnimation:function(a,b,c){c=b.animations[a];var e=new d.Animation;e.name=c.name||"anim_"+a;for(var g=a=0;g<c.channels.length;++g){var f=new d.Animation.Track,h=c.channels[g],k=c.samplers[h.sampler];f.target_node=b.nodes[h.target.node].name;
f.target_property=h.target.path.toLowerCase();var l=this.rename_animation_properties[f.target_property];l&&(f.target_property=l);f._property_path=[f.target_node,h.target.path];f._property=f.target_node+"/"+h.target.path;var h=this.parseAccessor(k.input,b),l=this.parseAccessor(k.output,b),m=b.accessors[k.output].type,k=d.TYPES[m];k==d.TYPES.VEC4&&"rotation"==f.target_property&&(k=d.TYPES.QUAT);f.type=k;if(k=this.numComponents[m]){for(var m=l.length/k,p=new Float32Array((1+k)*m),n=0;n<m;++n){p[n*(1+
k)]=h[n];var q=l.subarray(n*k,n*k+k);p.set(q,n*(1+k)+1)}f.data=p;f.packed_data=!0;f.value_size=k;a=Math.max(a,h[h.length-1]);e.addTrackToTake("default",f)}else console.warn("gltf unknown type:",m)}e.duration=a;return e},loadFromFiles:function(a,b){function c(a){var c=a.target.result,k=this.extension;if("gltf"==k)c=JSON.parse(c),d.main=this.filename;else if("glb"==k)d.main=this.filename;else if("bin"==k)h.push(this.filename);else if("jpeg"==k||"jpg"==k||"png"==k)a=URL.createObjectURL(new Blob([c],
{type:a.target.mimeType})),k=GL.Texture.fromURL(a,{wrap:gl.REPEAT,extension:k}),k.name=this.filename,gl.textures[k.name]=k;d[this.filename]={filename:this.filename,data:c,extension:this.extension};g--;0==g&&(d.binaries=h,f.load(d,function(a){b&&b(a)}))}for(var d={},g=a.length,f=this,h=[],k=0;k<a.length;++k){var l=a[k],m=new FileReader,p=l.name.split("."),p=p[p.length-1].toLowerCase();m.onload=c;m.filename=l.name;m.extension=p;"gltf"==p?m.readAsText(l):m.readAsArrayBuffer(l)}},removeRootPathFromTextures:function(a,
b){if(b)for(var c in a){var d=a[c],g;for(g in d.textures){var f=d.textures[g];f&&(f.constructor===String&&0==f.indexOf(ROOM.root_path)&&-1!=f.texture.indexOf("/")?f.substr(ROOM.root_path.length):f.texture&&0==f.texture.indexOf(ROOM.root_path)&&-1!=f.texture.indexOf("/")&&(f.texture=f.texture.substr(ROOM.root_path.length)))}}}};"undefined"!=typeof DracoDecoderModule&&Ia.installDracoModule(Ia.onReady);d.Formats.addSupportedFormat("gltf",Ia);d.Formats.addSupportedFormat("glb",Ia);d.SceneNode.prototype.setPropertyValueFromPath=
function(a,b,c){c=c||0;if(!this.flags||!this.flags.locked){var d=null,g=a[c];if(a.length>c+1){if("@"==a[c][0]?(g=a[c+1],d=this.getComponentByUId(a[c])):"material"==a[c]?(d=this.getMaterial(),g=a[c+1]):"flags"==a[c]?(d=this.flags,g=a[c+1]):"visible"==a[c]?(d=this,g=a[c]):(d=this.getComponent(a[c]),g=a[c+1]),!d)return null}else switch(a[c]){case "matrix":d=this.transform;break;case "position":d=this.transform;g=a[c];break;case "rotation":d=this.transform;g=a[c];break;case "x":case "y":case "z":case "xrotation":case "yrotation":case "zrotation":d=
this.transform;g=a[c];break;case "translate.X":d=this.transform;g="x";break;case "translate.Y":d=this.transform;g="y";break;case "translate.Z":d=this.transform;g="z";break;case "rotateX.ANGLE":d=this.transform;g="pitch";break;case "rotateY.ANGLE":d=this.transform;g="yaw";break;case "rotateZ.ANGLE":d=this.transform;g="roll";break;default:d=this}if(!d)return null;if(d.setPropertyValueFromPath&&d!=this&&!0===d.setPropertyValueFromPath(a,b,c+1)||d.setPropertyValue&&d!=this&&!0===d.setPropertyValue(g,
b))return d;if(void 0!==d[g]){if(2<a.length&&d[g]&&d[g].setPropertyValueFromPath)return d[g].setPropertyValueFromPath(a,b,c+2);d[g]=b;return d}}};d.getCurveValueAt=function(a,b,c,d,g){if(g<b||g>c)return d;b=[b,d];for(var f=0,f=0;f<a.length;f+=1){var h=a[f];if(g==h[0])return h[1];if(g<h[0])return f=(g-b[0])/(h[0]-b[0]),b[1]*(1-f)+h[1]*f;b=h}h=[c,d];f=(g-b[0])/(h[0]-b[0]);return b[1]*(1-f)+h[1]*f};d.resampleCurve=function(a,b,c,e,g){var f=[];f.length=g;for(var h=(c-b)/g,k=0;k<g;k++)f[k]=d.getCurveValueAt(a,
b,c,e,b+h*k);return f};Object.prototype.hasOwnProperty("defineAttribute")||(Object.defineProperty(Object.prototype,"defineAttribute",{value:function(a,b,c){c&&"string"==typeof c&&(c={type:c});var d=this;"function"!=typeof this&&(this[a]=b,d=this.constructor);Object.defineProperty(d,"@"+a,{value:c||{},enumerable:!1})},enumerable:!1,writable:!0}),Object.defineProperty(Object.prototype,"getAttribute",{value:function(a){a="@"+a;return this.hasOwnProperty(a)?this[a]:this.constructor&&this.constructor.hasOwnProperty(a)?
this.constructor[a]:null},enumerable:!1,writable:!0}));String.prototype.hasOwnProperty("hashCode")||Object.defineProperty(String.prototype,"hashCode",{value:function(){var a=0,b,c,d;if(0==this.length)return a;b=0;for(d=this.length;b<d;++b)c=this.charCodeAt(b),a=(a<<5)-a+c,a|=0;return a},enumerable:!1});Object.equals=function(a,b){if(a===b)return!0;if(!(a instanceof Object&&b instanceof Object)||a.constructor!==b.constructor)return!1;for(var c in a)if(a.hasOwnProperty(c)&&(!b.hasOwnProperty(c)||a[c]!==
b[c]&&("object"!==typeof a[c]||!Object.equals(a[c],b[c]))))return!1;for(c in b)if(b.hasOwnProperty(c)&&!a.hasOwnProperty(c))return!1;return!0};Array.prototype.hasOwnProperty("equal")||Object.defineProperty(Array.prototype,"equal",{value:function(a){for(var b=0;b<this.length;++b)if(this[b]!=a[b])return!1;return!0},enumerable:!1});Float32Array.prototype.hasOwnProperty("equal")||Object.defineProperty(Float32Array.prototype,"equal",{value:function(a){for(var b=0;b<this.length;++b)if(this[b]!=a[b])return!1;
return!0},enumerable:!1});d.stringToTypedArray=function(a,b){for(var c=new Uint8Array(b?b:a.length),d=0;d<a.length;d++)c[d]=a.charCodeAt(d);return c};d.typedArrayToString=function(a,b){for(var c="",d=0;d<a.length;d++)if(0!=a[d]||b)c+=String.fromCharCode(a[d]);else break;return c};y=d.GlobalScene=new d.Scene;d.newMeshNode=function(a,b){var c=new d.SceneNode(a);c.addComponent(new d.Components.MeshRenderer);c.setMesh(b);return c};d.newLightNode=function(a){a=new d.SceneNode(a);a.addComponent(new d.Components.Light);
return a};d.newCameraNode=function(a){a=new d.SceneNode(a);a.addComponent(new d.Components.Camera);return a};ba.ONE=d;ba.LS=d})("undefined"!=typeof window?window:self);
